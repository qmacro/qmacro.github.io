<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated email-to-task mechanism with Google Apps Script</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/blog/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Home</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/tags/">Tags</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Automated email-to-task mechanism with Google Apps Script</h1>

<time datetime="2011-10-04">04 Oct 2011</time><a href="/blog/tags/apis/" class="post-tag">apis</a><a href="/blog/tags/appsscript/" class="post-tag">appsscript</a><a href="/blog/tags/google/" class="post-tag">google</a><a href="/blog/tags/gtug/" class="post-tag">gtug</a><a href="/blog/tags/mangtug/" class="post-tag">mangtug</a><a href="/blog/tags/tasks/" class="post-tag">tasks</a>

<p><a href="http://madlab.org.uk/content/manchester-google-technology-user-group-13/">Last night at the Manchester Google Technology User Group (GTUG) meetup</a> we looked in detail at an <a href="https://plus.google.com/110526626182299357893/posts/CetQyVtLKy8">example script</a> that used various Google Apps Script services. More on that another time.</p>
<p>At the end of the meetup, I suggested an example of something that would be really easy to put together using Google Apps Script, and very useful: a mechanism to convert incoming emails automatically into tasks.</p>
<p>You can of course convert an email into a task <em>manually</em> using the Gmail UI like this:<br>
<img src="/blog/img/2017/05/AddToTasks1.jpg" alt="Manually adding a task from an email"></p>
<p>But rather than have to open Gmail, find the task email, select it and then choose More Actions -&gt; Add to Tasks, I wanted a hands-off facility where I could, say from my work email, fire off a quick one-liner task that would be added to my list of tasks automatically, silently and without fuss.</p>
<p>With effective use of Gmail’s filter facility, labels and a little bit of Apps Script using the Gmail Services, I was able to create a mechanism in the time it took to enjoy my morning coffee.</p>
<p></p>
<p><strong>Building the Automated Email-to-Task Mechanism</strong></p>
<p>Here’s how I saw it working:</p>
<ol>
<li>create a couple of new labels: ‘newtask’ and ‘newtaskdone’</li>
<li>specify a Gmail filter to assign the label ‘newtask’ to emails coming from my work email address, and with the recipient being ‘qmacro+task@gmail.com’</li>
<li>write a script to process messages in threads assigned to the ‘newtask’ label by parsing the subject out, creating a new task, and inserting that task into my tasklist</li>
<li>schedule this script to run hourly</li>
</ol>
<p>Then I could fire off an email to <a href="mailto:qmacro+task@gmail.com">qmacro+task@gmail.com</a> from work, with the task 1-liner in the Subject, and have that task automatically show up on my task list. Ideal!</p>
<p></p>
<p><strong>The Filter</strong></p>
<p>Once you have the labels, create the filter. This is what the action part of my filter looks like:</p>
<p><img src="/blog/img/2017/05/CreateAFilter.jpg" alt="Specifying the filter actions"></p>
<p>I’m specifying that the email be assigned to the label ‘newtask’, that it should marked as read immediately, and not appear in the inbox. That way, I don’t get distracted by the noise of task emails in my inbox. If you’re wondering about the ‘newtaskdone’ label, we’ll get to that in a minute.</p>
<p></p>
<p><strong>The Script Context</strong></p>
<p>Now we’re all set up – we can write the script to process the relevant emails, i.e. all those assigned the label ‘newtask’.</p>
<p>Start by creating a new Spreadsheet  – the script can live attached to that. Add the text ‘Processed tasks’ to cell A1. We’ll use this to show how many tasks the script has processed. Use the menu option Tools -&gt; Script editor to get to the Google Apps Script editor.</p>
<p><img src="/blog/img/2017/05/MailManagementSheet.jpg" alt="Mail Management sheet"></p>
<p>You can call your project ‘Mail Management’, or whatever you want:</p>
<p><img src="/blog/img/2017/05/MailManagementScript-1.jpg" alt="Mail Management script"></p>
<p><strong>The Script Code</strong></p>
<p>Ok, let’s run through the script step by step.</p>
<p>We start with a few constants: the name of the tasklist into which we want our new tasks inserted, and the two labels.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token constant">TASKLIST</span> <span class="token operator">=</span> <span class="token string">"DJ's list"</span><span class="token punctuation">;</span><br><span class="token constant">LABEL_PENDING</span> <span class="token operator">=</span> <span class="token string">"newtask"</span><span class="token punctuation">;</span><br><span class="token constant">LABEL_DONE</span> <span class="token operator">=</span> <span class="token string">"newtaskdone"</span><span class="token punctuation">;</span></code></pre>
<p>Next we have a helper function <code>getTasklistId_</code> which uses the Tasks Services from the new <a href="http://code.google.com/googleapps/appsscript/googleapisservices.html">Google APIs Services</a> in Apps Script. You’ll need to explicitly state you want to use the Google APIs Services from the File menu, which will lead you to a popup where you can switch on the Tasks API and use the <a href="http://code.google.com/apis/console-help/">Google API Console</a> to create a project and generate an API key which you’ll need. All of this is described in ample detail in a great article “<a href="http://code.google.com/googleapps/appsscript/articles/google_apis_reading_list.html">Integrating with Google APIs – Creating a simple reading list</a>“.</p>
<p>This <code>getTasklistId_</code> function returns a tasklist ID for a given tasklist name — in this case we’ll be asking for the ID of the tasklist called “DJ’s list”. It’s early days for the Tasks API and there are a few oddities: In theory we should be able to use the simple API call :</p>
<pre class="language-javascript"><code class="language-javascript">Tasks<span class="token punctuation">.</span>Tasklists<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tasklistName<span class="token punctuation">)</span></code></pre>
<p>but this is currently resulting in an error. So instead we’ll grab a list of all the tasklists, and iterate over them looking for our tasklist name. I’ve suffixed the name of this function, and others in this script, with an underscore; this prevents them from showing up in the dropdown list of runnable functions at the top of the editor.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getTasklistId_</span><span class="token punctuation">(</span><span class="token parameter">tasklistName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> tasklistsList <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasklists<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> taskLists <span class="token operator">=</span> tasklistsList<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span>tl <span class="token keyword">in</span> taskLists<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> title <span class="token operator">=</span> taskLists<span class="token punctuation">[</span>tl<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>title <span class="token operator">==</span> tasklistName<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> taskLists<span class="token punctuation">[</span>tl<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Next we have another helper function <code>addTask_</code> which will create a new task, given a string, and add that new task to a tasklist, given a tasklist ID. Note the separation of concerns – a task is created independently of a tasklist, then inserted into that tasklist.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">addTask_</span><span class="token punctuation">(</span><span class="token parameter">title<span class="token punctuation">,</span> tasklistId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> newTask <span class="token operator">=</span> Tasks<span class="token punctuation">.</span><span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Tasks<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newTask<span class="token punctuation">,</span> <span class="token function">getTasklistId_</span><span class="token punctuation">(</span>tasklistId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>We then come to the definition of <code>processPending_</code>, which does the bulk of the mechanism’s work. This function gets a handle on each of the two labels we mentioned earlier (labels in the <a href="http://code.google.com/googleapps/appsscript/service_gmail.html">Gmail Services</a> are one of three main classes, along with threads and messages). The idea is that we will process ‘pending’ emails assigned to the ‘newtask’ label, and then switch the thread to the ‘newtaskdone’ label so it won’t get processed a second time. With a call to the getThreads() method of the pending label object, we get a list of threads. We’re assuming that there’s only one email in each thread (task emails are separate and different each time), and so we grab the subject from the first message in each thread to use as the 1-liner task title, and use the addTask_ helper function to insert a new task into the tasklist.</p>
<p>Once this is done we remove the ‘newtask’ label and assign the ‘newtaskdone’ label to the thread.</p>
<p>Finally, we increment the ‘Processed tasks’ counter in the sheet, for a quick indication of how many email-to-task conversions have taken place.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">processPending_</span><span class="token punctuation">(</span><span class="token parameter">sheet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token keyword">var</span> label_pending <span class="token operator">=</span> GmailApp<span class="token punctuation">.</span><span class="token function">getUserLabelByName</span><span class="token punctuation">(</span><span class="token constant">LABEL_PENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> label_done <span class="token operator">=</span> GmailApp<span class="token punctuation">.</span><span class="token function">getUserLabelByName</span><span class="token punctuation">(</span><span class="token constant">LABEL_DONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// The threads currently assigned to the 'pending' label</span><br>  <span class="token keyword">var</span> threads <span class="token operator">=</span> label_pending<span class="token punctuation">.</span><span class="token function">getThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Process each one in turn, assuming there's only a single</span><br>  <span class="token comment">// message in each thread</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token keyword">in</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> thread <span class="token operator">=</span> threads<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Grab the task data</span><br>    <span class="token keyword">var</span> taskTitle <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getFirstMessageSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Insert the task</span><br>    <span class="token function">addTask_</span><span class="token punctuation">(</span>taskTitle<span class="token punctuation">,</span> <span class="token constant">TASKLIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Set to 'done' by exchanging labels</span><br>    thread<span class="token punctuation">.</span><span class="token function">removeLabel</span><span class="token punctuation">(</span>label_pending<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    thread<span class="token punctuation">.</span><span class="token function">addLabel</span><span class="token punctuation">(</span>label_done<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Increment the processed tasks count</span><br>  <span class="token keyword">var</span> processedRange <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token string">"B1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  processedRange<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>processedRange<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>This last function, <code>main_taskconverter</code>, is more a matter of personal style rather than necessity – it’s the main function that we will start the whole mechanism off with, and the function that we’ll specify in the trigger so this script will run on a regular basis. We get a reference to the active spreadsheet, set the first sheet to be the active one (it usually is anyway) and call the <code>processPending_</code> function.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">main_taskconverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Get the active spreadsheet and make sure the first</span><br>  <span class="token comment">// sheet is the active one</span><br>  <span class="token keyword">var</span> ss <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">setActiveSheet</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">getSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Process the pending task emails</span><br>  <span class="token function">processPending_</span><span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>And that’s all there is to it!</p>
<p></p>
<p><strong>Scheduling Regular Execution</strong></p>
<p>We want this mechanism to run regularly in the background, so that it converts all incoming task emails to tasks without our intervention. So we’ll use a trigger – we can set up a <a href="http://code.google.com/googleapps/appsscript/guide_events.html">time-driven event trigger</a> so that the script – via the main_taskconverter function, runs every hour.</p>
<p><img src="/blog/img/2017/05/CurrentProjectsTriggers.jpg" alt="Current Project's Triggers"></p>
<p>With a coffee (and biscuit) down, I now have a very slick way of remembering things I have to do. Nice!</p>
<p>Here’s the script in its entirety, with comments.</p>
<script src="https://gist.github.com/qmacro/821cdbd498fe772447165ad95a4cc470.js"></script>

<hr>
<ul><li>Next: <a href="/blog/2011/8/10/reading-list-mark-2-part-1/">Reading List Mark 2 - Part 1</a></li><li>Previous: <a href="/blog/2011/19/9/ad-hoc-data-workflows-with-google-apps-script/">Ad-hoc Data Workflows with Google Apps Script</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2011/4/10/automated-email-to-task-mechanism-with-google-apps-script/ -->
  </body>
</html>
