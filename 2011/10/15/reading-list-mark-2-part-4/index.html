<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading List Mark 2 - Part 4</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/about/">About</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/tags/">Tags</a></li>
        <li class="nav-item"><a href="/feed.xml">Feed</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Reading List Mark 2 - Part 4</h1>

<time datetime="2011-10-15">15 Oct 2011</time><a href="/tags/appsscript/" class="post-tag">appsscript</a><a href="/tags/google/" class="post-tag">google</a><a href="/tags/gtug/" class="post-tag">gtug</a><a href="/tags/madlab/" class="post-tag">madlab</a><a href="/tags/mangtug/" class="post-tag">mangtug</a><a href="/tags/tasks/" class="post-tag">tasks</a><a href="/tags/ui/" class="post-tag">ui</a><a href="/tags/urlfetch/" class="post-tag">urlfetch</a>

<p>This is Part 4 in a series about an example app that I put together to demonstrate and describe the use of various Google Apps Script features. SeeÂ <a href="/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> for an introduction. This part is â€œ<strong>Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</strong>â€œ.</p>
<p><strong>Parts Overview</strong></p>
<ol>
<li><a href="/2011/10/08/reading-list-mark-2-part-1/">Introduction to the app, and a short screencast showing the features</a></li>
<li><a href="/2011/10/10/reading-list-mark-2-part-2/">Using the Tasks API to retrieve and insert tasklists, and the Ui Services to build the tasklist chooser component</a></li>
<li><a href="/2011/10/14/reading-list-mark-2-part-3/">Using the UrlFetch Services to interact with the Google+ API and grab info on articles pointed to by users in their activity stream</a></li>
<li><a href="/2011/10/15/reading-list-mark-2-part-4/">Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</a><strong>&lt;â€“ You Are Here</strong></li>
<li><a href="/2011/10/16/reading-list-mark-2-part-5/">Putting it all together and using the OnOpen event to insert a new 2-item menu entry on the spreadsheetâ€™s page</a></li>
</ol>
<p><strong>Putting this into context: the Update request</strong></p>
<p>Weâ€™ve covered a lot of ground in the previous three parts in this series. Now weâ€™re at the stage where we have the functions for</p>
<ul>
<li>creating a Ui for choosing an existing / creating a new tasklist</li>
<li>handling the button event on the Ui</li>
<li>getting a list of tasklists</li>
<li>retrieving URLs from a Google+ activity stream</li>
</ul>
<p>So the one main piece of work outstanding is synchronising the retrieved URLs as tasks on the chosen tasklist.</p>
<p>If you watch the <a href="http://www.youtube.com/watch?v=F08qS8ZmlZ0">screencast</a> shown inÂ <a href="/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> youâ€™ll see that the synchronisation is part of a more general â€˜updateâ€™ request, that includes the fetching of new URLs from Google+ and synchronising them with the tasklist. So letâ€™s have a look at the function that binds those two things together.</p>
<p>Hereâ€™s the update() function, which weâ€™ll allow the user to call from a menu item (weâ€™ll cover this in the next instalment).</p>
<p>READINGLISTCELL = 'D1'; function update() { // First, check that we have a tasklist id already; it's stored in // the comment section of the 'readinglistcell' var sh = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(); var taskListId = sh.getRange(READINGLISTCELL).getComment(); // If we don't have an id, tell the user to choose a tasklist if(taskListId === '') { SpreadsheetApp.getActiveSpreadsheet().toast( &quot;Use Articles -&gt; Select Task List to choose a task list&quot;, &quot;No Task List&quot;, 5 ); // Otherwise, we know which task list to synchronise with, so // go and update the reading list with URLs from the Google+ activity // list, and then sync that with the task list items } else { retrieveActivityUrls_(); synchronise_(taskListId); } }</p>
<p>This function grabs a reference to the active sheet, and pulls the comment from the cell that weâ€™ve designated as where the reading list tasklist info is stored: READINGLISTCELL. The name is stored in the cell, and the ID is stored in the cellâ€™s comment. If there isnâ€™t an ID, then weâ€™ll ask the user to choose a tasklist using the Ui we built in <a href="/2011/10/10/reading-list-mark-2-part-2/">Part 2</a>. The <a href="http://code.google.com/googleapps/appsscript/class_browser.html">Browser</a> class in Google Apps Scriptâ€™s <a href="http://code.google.com/googleapps/appsscript/service_base.html">Base Services</a> gives us a nice dialog box that looks like this:</p>
<div class="wp-caption alignnone" id="attachment_1198" style="width: 316px">![image](/img/2011/10/notamessage1.png)Message Box
</div>But thereâ€™s also a nice visual message feature thatâ€™s available in the [Spreadsheet Services](http://code.google.com/googleapps/appsscript/service_spreadsheet.html), specific to a spreadsheet: [toast()](http://code.google.com/googleapps/appsscript/class_spreadsheet.html#toast). Calling this causes a popup to appear in the lower right of the screen, which stays visible for a short while. This is what it looks like:
<div class="wp-caption alignnone" id="attachment_1177" style="width: 269px">![image](/img/2011/10/notasklist.png)Toast message
</div>Because the â€˜toastâ€™ name is so evocative, weâ€™ll use it in our function to prompt the user to choose a tasklist.
<p>If thereâ€™s already a tasklist chosen, then we go straight into retrieving the URLs (see <a href="/2011/10/14/reading-list-mark-2-part-3/">Part 3</a>) and then call the synchronise_() function, passing the ID of the tasklist.</p>
<p><strong>Synchronising URLs and Tasks</strong></p>
<p>Ok, so what do we need to do to synchronise the URLs? Itâ€™s similar to the technique described in the great article â€œ<a href="http://code.google.com/googleapps/appsscript/articles/google_apis_reading_list.html">Integrating with Google APIs â€“ Creating a simple reading list</a>â€œ. There are a couple of differences: Iâ€™m not going to use the <a href="http://code.google.com/googleapps/appsscript/service_urlshortener.html">UrlShortener Services</a>, and Iâ€™m going to try and reduce the number of API calls by bulk-grabbing the cell data.</p>
<p>First, we get a range reference on the active sheet, which equates to the list of URLs already there. We get all of the URLs (urlRange.getValues()) and all of the corresponding comments (urlRange.getComments()).</p>
<p>function synchronise_(taskListId) { // Grab list of all URLs, and associated comments var sh = SpreadsheetApp.getActiveSheet(); var urlRange = sh.getRange(2, 1, sh.getLastRow() - 1, 1); var urls = urlRange.getValues(); var comments = urlRange.getComments();</p>
<p>We go through each of the URLs, and create a new task in the tasklist if there isnâ€™t already something in the comment for that URL:</p>
<ul>
<li>instantiate a new task object: Tasks.newTask()</li>
<li>add the title: task.setTitle()</li>
<li>add the task to the tasklist: Tasks.Tasks.insert()</li>
<li>insert the new taskâ€™s ID into the comment for the URL: setComment()</li>
</ul>
<p>Otherwise weâ€™ve already created a task for the URL, so we grab the task to get the status, and if itâ€™s marked as completed, we format the URL and corresponding description (in the next column) to set strike-through text.</p>
<p>// For each URL, check the status of the associated task. // If there isn't an associated task, create one. for (var i = 0, j = urls.length; i &lt; j; i++) { if (comments[i] == &quot;&quot;) { Logger.log(&quot;New task&quot;); var task = Tasks.newTask(); task.setTitle(urls[i]); var newTask = Tasks.Tasks.insert(task, taskListId); sh.getRange(i + 2, 1).setComment(newTask.getId()); } else { Logger.log(&quot;Existing task&quot;); var existingTask = Tasks.Tasks.get(taskListId, comments[i][0]); if (existingTask.getStatus() === &quot;completed&quot;) { sh.getRange(i + 2, 1, 1, 2).setFontLine('line-through'); } } } }</p>
<p>Thatâ€™s it. Stop by next time for the last part in this series, where we put everything together and insert a 2-item menu entry to tie it all together. Thanks for reading!</p>
<p></p>

<hr>
<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" label="ðŸ’¬" crossorigin="anonymous" async></script>

<hr>
<ul><li>Next: <a href="/2011/10/16/reading-list-mark-2-part-5/">Reading List Mark 2 - Part 5</a></li><li>Previous: <a href="/2011/10/14/reading-list-mark-2-part-3/">Reading List Mark 2 - Part 3</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /2011/10/15/reading-list-mark-2-part-4/ -->
  </body>
</html>
