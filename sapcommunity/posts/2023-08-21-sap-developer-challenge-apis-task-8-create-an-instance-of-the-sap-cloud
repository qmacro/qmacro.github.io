2023-08-21-sap-developer-challenge-apis-task-8-create-an-instance-of-the-sap-cloud
SAP Developer Challenge - APIs - Task 8 - Create an instance of the SAP Cloud Management Service
application-developmentforum-board
2023-08-21
https://community.sap.com/t5/application-development-discussions/sap-developer-challenge-apis-task-8-create-an-instance-of-the-sap-cloud/td-p/280681
<P>(Check out the <A href="https://blogs.sap.com/2023/08/01/sap-developer-challenge-apis/" target="_blank" rel="noopener noreferrer">SAP Developer Challenge - APIs</A> blog post for everything you need to know about the challenge to which this task relates!)</P><P>In this task, you're going to create an instance of the SAP Cloud Management Service, with a specific plan. To find out why, read on.</P><H2 id="toc-hId-1651975333">Background</H2><P>This task follows on from and is in a group with the previous task (<A href="https://groups.community.sap.com/t5/application-development/sap-developer-challenge-apis-task-7-create-a-new-directory-in-an/td-p/280341" target="_blank" rel="noopener noreferrer">Task 7 - Create a new directory in an SAP BTP account</A>). Having created a directory in your SAP Business Technology Platform (SAP BTP) account, you're going to eventually retrieve that directory's details programmatically, through an API endpoint.</P><P>In making such a call to the appropriate endpoint, you need to supply authentication details in the HTTP header.</P><P>What do the authentication details look like, and how do you obtain them? Well, in this and subsequent tasks, you'll find out, by reading, and by doing!</P><H3 id="toc-hId--1096695133">The details of the API endpoint</H3><P>On the reading part, you should start out by jumping back to the <A href="https://api.sap.com/package/SAPCloudPlatformCoreServices/rest" target="_blank" rel="noopener noreferrer">Core Services for SAP BTP</A> API package landing page on the <A href="https://api.sap.com" target="_blank" rel="noopener noreferrer">SAP Business Accelerator Hub</A> that you viewed in the previous task. You'll see a range of APIs, like this:</P><P><IMG src="https://community.sap.com/assets/core-services-apis.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="core-services-apis.png" style="width: 999px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42353iC5C5558877416E73/image-size/large?v=v2&amp;px=999" role="button" title="core-services-apis.png" alt="core-services-apis.png" /></span></P><P>The Accounts Service API is described thus: "Manage the directories and subaccounts in your global account's structure". This is the API containing the endpoint that you'll eventually use to look at the details of the directory you created in the previous task.</P><P>Selecting this API, and navigating to its API Reference section, specifically to the <A href="https://api.sap.com/api/APIAccountsService/resource/Directory_Operations" target="_blank" rel="noopener noreferrer">Directory Operations</A> group, you'll see quite a list of endpoints, some of which you can see in this screenshot:</P><P><IMG src="https://community.sap.com/assets/directory-operations-endpoints.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="directory-operations-endpoints.png" style="width: 999px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42354i8DDFA3A9998CFC54/image-size/large?v=v2&amp;px=999" role="button" title="directory-operations-endpoints.png" alt="directory-operations-endpoints.png" /></span></P><P>One of them is the one you'll eventually be calling:</P><P><IMG src="https://community.sap.com/assets/get-directory-endpoint.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="get-directory-endpoint.png" style="width: 999px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42355i566316864124C9B0/image-size/large?v=v2&amp;px=999" role="button" title="get-directory-endpoint.png" alt="get-directory-endpoint.png" /></span></P><P>Note that the final part of the endpoint's path, {directoryGUID}, is what we need to specify when making a call to this endpoint. Remind you of anything? Yes, it's the GUID value of your newly created directory that you determined in the previous task.</P><P>While you're <A href="https://qmacro.org/blog/posts/2017/02/19/the-beauty-of-recursion-and-list-machinery/#initialrecognition" target="_blank" rel="noopener nofollow noreferrer">staring at</A> the details of this endpoint, make a mental note of this part:</P><BLOCKQUOTE><P>Required scope: $XSAPPNAME.global-account.account-directory.read</P></BLOCKQUOTE><P>This will become relevant shortly.</P><H3 id="toc-hId-646115202">The documentation on this API</H3><P>While you're still in reading mode, jump back to the <A href="https://api.sap.com/api/APIAccountsService/overview" target="_blank" rel="noopener noreferrer">Accounts Service API Overview</A> and follow the link to the SAP Help Portal documentation <A href="https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/17b6a171552544a6804f12ea83112a3f.html" target="_blank" rel="noopener noreferrer">Account Administration Using APIs of the SAP Cloud Management Service</A>. It's here that you'll find information on setting up for calls to this API and its endpoints. Take some time to read through the linked section and the subsections within.</P><P>Here's a very brief summary of what it says, so you have something concise to which you can refer in this and subsequent tasks in this group.</P><P>In order to make calls to API endpoints in this API (and indeed the other APIs in the package), you'll need to follow these steps:</P><OL><LI>create an instance of the SAP Cloud Management Service, with a plan that contains the appropriate scope(s) that you need</LI><LI>create a service key based on that instance</LI><LI>use the details in the service key to request an access token</LI><LI>use the access token thus obtained to authenticate a call to the API endpoint</LI></OL><P>The documentation mentions different environments in which you might create an instance of the service; for the purposes of this Developer Challenge as a whole, please use a Cloud Foundry environment. This is for a couple of reasons:</P><UL><LI>everyone can get a Cloud Foundry environment on SAP BTP; for example, if you're using a trial account you will most likely have a Cloud Foundry environment automatically set up for you in your subaccount, and if you don't have one, you can create one</LI><LI>it makes running this task and the related tasks simpler and we can all take part in the same collective and shared conversation about what we're doing</LI></UL><P>OK, let's look at precisely what your task is. That list of steps above looks quite a lot of work ... but don't worry. Your task today relates only to step 1 in the list.</P><H2 id="toc-hId--1709528254">Your task</H2><P>There are two parts to your task here. In both parts, you should use the cf command line tool for Cloud Foundry (also known as the "cf CLI").</P><BLOCKQUOTE><P>There are different ways you could go about creating a service instance on Cloud Foundry, but here the cf CLI is prescribed because it can be used for not only creating the instance, but also for retrieving detailed information afterwards. And of course, also because <A href="https://twitter.com/search?q=%23TheFutureIsTerminal" target="_blank" rel="noopener nofollow noreferrer">#TheFutureIsTerminal</A> <span class="lia-unicode-emoji" title=":slightly_smiling_face:">ðŸ™‚</span></P></BLOCKQUOTE><P>For <STRONG>part one</STRONG>, you must complete step 1 in the list above, i.e. create an instance of the SAP Cloud Management Service (short name: cis). Do this in your SAP BTP account that you used in the previous task. Make sure you choose the appropriate plan when doing this, and create the instance in your Cloud Foundry environment.</P><P>Information on where to find the service plan details, and tips on how to create the instance itself, are detailed in the "Hints and tips" section.</P><P>For <STRONG>part two</STRONG>, you must use the <A href="https://apidocs.cloudfoundry.org/226/" target="_blank" rel="noopener nofollow noreferrer">Cloud Foundry API</A> to retrieve information about your newly created service instance. Specifically, you should use the <A href="https://apidocs.cloudfoundry.org/226/service_instances/list_all_service_instances.html" target="_blank" rel="noopener nofollow noreferrer">List all Service Instances</A> endpoint (GET /v2/service_instances). And as you'll have already been using the cf CLI for part one of this task, you are strongly encouraged to use it for this part as well. Did you know that you can use the cf CLI to make calls to the CF API as well? Find out more in the "Hints and tips section below".</P><P>From the information you retrieve via the GET /v2/service_instances endpoint, you should identify the appropriate object in the resources property in the JSON returned, and pick out the value of the entity type.</P><P>Here's an example (with some properties removed for brevity):</P><DIV class=""><PRE><SPAN><SPAN class="">{</SPAN></SPAN>
<SPAN>  <SPAN class="">"total_results"</SPAN><SPAN class="">:</SPAN> <SPAN class="">1</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>  <SPAN class="">"resources"</SPAN><SPAN class="">:</SPAN> <SPAN class="">[</SPAN></SPAN>
<SPAN>    <SPAN class="">{</SPAN></SPAN>
<SPAN>      <SPAN class="">"metadata"</SPAN><SPAN class="">:</SPAN> <SPAN class="">{</SPAN></SPAN>
<SPAN>        <SPAN class="">"guid"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"58314563-ab6d-48db-b40c-ae4abf0e0355"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"url"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"/v2/service_instances/58314563-ab6d-48db-b40c-ae4abf0e0355"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"created_at"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"2023-08-15T10:31:13Z"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"updated_at"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"2023-08-15T10:31:15Z"</SPAN></SPAN>
<SPAN>      <SPAN class="">},</SPAN></SPAN>
<SPAN>      <SPAN class="">"entity"</SPAN><SPAN class="">:</SPAN> <SPAN class="">{</SPAN></SPAN>
<SPAN>        <SPAN class="">"name"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"cis-central"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"credentials"</SPAN><SPAN class="">:</SPAN> <SPAN class="">{},</SPAN></SPAN>
<SPAN>        <SPAN class="">"service_plan_guid"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"7cc70093-3c5f-47f2-acf6-8de4185ba63c"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"space_guid"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"52311e40-efaa-4176-bef1-505f3a9889bd"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"gateway_data"</SPAN><SPAN class="">:</SPAN> <SPAN class="">null</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"dashboard_url"</SPAN><SPAN class="">:</SPAN> <SPAN class="">null</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"type"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"&lt;instance-type&gt;"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"last_operation"</SPAN><SPAN class="">:</SPAN> <SPAN class="">{</SPAN></SPAN>
<SPAN>          <SPAN class="">"type"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"create"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>          <SPAN class="">"state"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"succeeded"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>          <SPAN class="">"updated_at"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"2023-08-15T10:31:15Z"</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>          <SPAN class="">"created_at"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"2023-08-15T10:31:15Z"</SPAN></SPAN>
<SPAN>        <SPAN class="">},</SPAN></SPAN>
<SPAN>        <SPAN class="">"tags"</SPAN><SPAN class="">:</SPAN> <SPAN class="">[]</SPAN><SPAN class="">,</SPAN></SPAN>
<SPAN>        <SPAN class="">"maintenance_info"</SPAN><SPAN class="">:</SPAN> <SPAN class="">{},</SPAN></SPAN>
<SPAN>        <SPAN class="">"service_guid"</SPAN><SPAN class="">:</SPAN> <SPAN class="">"4eacd0ef-9a9d-4cb3-8fb1-60fb685d8f82"</SPAN></SPAN>
<SPAN>      <SPAN class="">}</SPAN></SPAN>
<SPAN>    <SPAN class="">}</SPAN></SPAN>
<SPAN>  <SPAN class="">]</SPAN></SPAN>
<SPAN><SPAN class="">}</SPAN></SPAN></PRE></DIV><P>As you can see in this example, there's only one service instance in the Cloud Foundry environment org / space used to set up this example. This is reflected in the fact that there's only a single object contained in the resources array. That object represents and contains the details of that service instance.</P><P>The type of the service instance is given in the entity.type property within the object. In the example above, the value is deliberately hidden, and has been replaced by the string &lt;instance-type&gt;.</P><BLOCKQUOTE><P>For those of you who are curious and have also tried to use cf service to list details of the service, note that the entity type shown in the output to cf service is not quite the same, and not what is required here. You have been warned!</P></BLOCKQUOTE><P>It's the actual value of this entity.type property that you must determine and send to be hashed and shared in a reply to this discussion thread as described in <A href="https://groups.community.sap.com/t5/application-development/sap-developer-challenge-apis-task-0-learn-to-share-your-task/m-p/276058" target="_blank" rel="noopener noreferrer">Task 0</A>. So whatever that value is, in the JSON that's returned, that's what you need to send to be hashed (don't include the double quotes, because they're just part of the JSON syntax of course).</P><H2 id="toc-hId-33282081">Hints and tips</H2><P>Here are some pointers to help you with this task.</P><H3 id="toc-hId-1579578911">Creation of the service instance</H3><P>If you read through the <A href="https://help.sap.com/docs/btp/sap-business-technology-platform/account-administration-using-apis-of-sap-cloud-management-service" target="_blank" rel="noopener noreferrer">Account Administration Using APIs of the SAP Cloud Management Service</A> documentation, you will have come across the <A href="https://help.sap.com/docs/btp/sap-business-technology-platform/sap-cloud-management-service-service-plans" target="_blank" rel="noopener noreferrer">SAP Cloud Management Service - Service Plans</A> section. In this section, the details of each service plan offered are available, including a list of scopes provided by each.</P><P><IMG src="https://community.sap.com/assets/service-plan-details.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="service-plan-details.png" style="width: 980px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42356i1FBEB77A4A71E706/image-size/large?v=v2&amp;px=999" role="button" title="service-plan-details.png" alt="service-plan-details.png" /></span></P><P>When creating the service instance, make sure you specify the appropriate plan, the plan that contains the scope that you need to make a GET request to the /accounts/v1/directories/{directoryGUID} API endpoint.</P><H3 id="toc-hId--972578050">Using the cf CLI</H3><P>You are required to use the cf CLI for both parts of this task. Some of you may already have the cf CLI installed. Others may not.</P><P>For those of you who have it installed, or are willing and able to install it in their own system, we recommend you use the latest major version, i.e. version 8. The reason for this is twofold:</P><UL><LI>the major version of the cf CLI available in all Dev Spaces in the SAP Business Application Studio is 8 (specifically, at the time of writing, version 8.5.0+73aa161.2022-09-12)</LI><LI>there are some breaking changes introduced between major versions 7 and 8, including in the area of the output of service binding details, so it's best that we're all on the same version and we also recommend you move to 8 now anyway</LI></UL><BLOCKQUOTE><P>See <A href="https://docs.cloudfoundry.org/cf-cli/v8.html" target="_blank" rel="noopener nofollow noreferrer">Upgrading to cf CLI v8</A> for details of what's new and different with version 8.</P></BLOCKQUOTE><P>For those who don't already have the cf CLI installed, and don't want to install it right now, we recommend you make use of a Dev Space in the SAP Business Application Studio. Just like the Cloud Foundry environment itself, a subscription to the SAP Business Application Studio is available to anyone and everyone, not least within a trial SAP BTP account context. You can follow the tutorial <A href="https://developers.sap.com/tutorials/appstudio-onboarding.html" target="_blank" rel="noopener noreferrer">Set Up SAP Business Application Studio for Development</A> if you need some guidance on getting access.</P><P>Once you have a subscription to the SAP Business Application Studio, create yourself a Dev Space. It doesn't have to be anything special - even a Basic Dev Space contains the cf CLI, as you can see:</P><P><IMG src="https://community.sap.com/assets/basic-dev-space-with-cf-cli.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="basic-dev-space-with-cf-cli.png" style="width: 999px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42357i070F58837321244E/image-size/large?v=v2&amp;px=999" role="button" title="basic-dev-space-with-cf-cli.png" alt="basic-dev-space-with-cf-cli.png" /></span></P><P>Once you have a Dev Space up and running, and you have of course opened up a terminal session therein (use menu path "Terminal -&gt; New Terminal"), you have the cf CLI at your disposal.</P><P>At this point you should log in, and specify the API endpoint that relates to your specific Cloud Foundry environment instance.</P><P>There are different ways to find out what the API endpoint is (including programmatically, see <A href="https://github.com/SAP-samples/cloud-btp-cli-api-codejam/blob/main/exercises/05-core-services-api-prep/README.md#determining-your-cf-api-endpoint" target="_blank" rel="noopener nofollow noreferrer">Determining your CF API endpoint</A>), but a simple way for the purposes of this task is to head over to the SAP BTP Cockpit and check in the subaccount overview:</P><P><IMG src="https://community.sap.com/assets/cf-api-endpoint-cockpit.png" border="0" alt="" /><span class="lia-inline-image-display-wrapper lia-image-align-inline" image-alt="cf-api-endpoint-cockpit.png" style="width: 999px;"><img src="https://community.sap.com/t5/image/serverpage/image-id/42358i20F32D3A676D9256/image-size/large?v=v2&amp;px=999" role="button" title="cf-api-endpoint-cockpit.png" alt="cf-api-endpoint-cockpit.png" /></span></P><P>Once you've logged in, you'll need to familiarize yourself with the cf CLI commands related to this task.</P><P>For the first part of the task, look into the "Services integration" commands (get to this list using the command cf help):</P><PRE>Services integration:
  marketplace,m        create-user-provided-service,cups
  services,s           update-user-provided-service,uups
  create-service,cs    create-service-key,csk
  update-service       delete-service-key,dsk
  delete-service,ds    service-keys,sk
  service              service-key
  bind-service,bs      bind-route-service,brs
  unbind-service,us    unbind-route-service,urs</PRE><P>In particular:</P><UL><LI>cf marketplace will give you a list of service offerings; specifying a particular service offering with the -e option is also worth looking into</LI><LI>cf create-service will allow you to create a new service instance, specifying the plan as well as the service</LI><LI>cf services will allow you to list services instances that already exist, allowing you to check that your service instance creation was successful</LI></UL><BLOCKQUOTE><P>When using cf marketplace, note that the service offerings will be listed using their technical name. The technical name for the SAP Cloud Management Service is cis, as noted in the <A href="https://help.sap.com/docs/btp/sap-business-technology-platform/account-administration-using-apis-of-sap-cloud-management-service" target="_blank" rel="noopener noreferrer">Account Administration Using APIs of the SAP Cloud Management Service</A> section on the SAP Help Portal.</P></BLOCKQUOTE><P>For the second part of the task, you'll want to look at:</P><UL><LI>cf curl</LI></UL><P>Interestingly, if you want to find this command in the list of possible commands in the cf CLI, you must use:</P><PRE>cf help -a</PRE><P>(i.e. include the -a option) otherwise it's not shown.</P><P>Good luck and have fun!</P><H2 id="toc-hId-966745790">For discussion</H2><P>How else might one create an instance of a service? Is this your first encounter with the cf CLI? How did you find it? What is your favorite place to run command line tools?</P>
