<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2025/08/04/excluding-specific-diagnostics-in-neovim/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.7884d8f8e9dd86c3b137.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Excluding specific diagnostics in Neovim | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Excluding specific diagnostics in Neovim"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2025/08/04/excluding-specific-diagnostics-in-neovim/"><meta name="description" content="Excluding specific diagnostics in Neovim 04 Aug 2025 | 5 min read Here&#39;s what I did to be able to filter out certain diagnostic messages in..."><meta property="og:description" content="Excluding specific diagnostics in Neovim 04 Aug 2025 | 5 min read Here&#39;s what I did to be able to filter out certain diagnostic messages in..."><meta name="description" content="Excluding specific diagnostics in Neovim 04 Aug 2025 | 5 min read Here&#39;s what I did to be able to filter out certain diagnostic messages in..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Excluding specific diagnostics in Neovim</h1><div class="post__details"><time datetime="2025-08-04">04 Aug 2025 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p><em>Here's what I did to be able to filter out certain diagnostic messages in Neovim.</em></p><p>Note: I'm still learning (a) Lua, (b) the API surface of Neovim and (c) how the different core components interact and work together, so this may not be the best solution, but it works for me and I've learned a lot digging in and putting it together.</p><p>I recently revisited my Neovim config, with a view to updating and simplifying it with the advent of release 0.11. I covered some of this in my last Neovim related post <a href="/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node.js-configuration-and-diagnostics/">A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics</a>. In that context, when editing Node.js (JavaScript) files, everything worked nicely with regards to the Language Server and how the diagnostics were surfaced.</p><h2>A desire to filter out a specific diagnostic</h2><p>That is, everything worked nicely ... with one annoyance - the hint level diagnostic &quot;File is a CommonJS module&quot; shown here on line 1:</p><pre class="language-text"><code class="language-text">H   1 const cds = require('@sap/cds')     ■ File is a CommonJS module; it may be converted to an ES module.<br>    2 module.exports = cds.service.impl(function() {<br>    3   this.after('each', 'Books', book => {<br>    4     console.log(book<br>E   5   })     ■ ',' expected.<br>    6 })</code></pre><blockquote><p>For this sample display I'd temporarily changed my preferred config so that all diagnostics are shown, as virtual text, rather than virtual lines, like this:</p><pre class="language-text"><code class="language-text">:lua vim.diagnostic.config({virtual_lines = false, virtual_text = true})</code></pre></blockquote><p>So I wanted the language server to still publish diagnostics, but for me to be able to filter them.</p><h2>Digging into the Neovim docu</h2><p>In order to achieve this, I spent a pleasant morning today looking through the documentation and getting a better understanding of the API with respect to these features of Neovim (the links are to the documentation sections that are important here):</p><ul><li><a href="https://neovim.io/doc/user/diagnostic.html">Diagnostic framework</a></li><li><a href="https://neovim.io/doc/user/lsp.html">LSP client / framework</a></li><li><a href="https://neovim.io/doc/user/lua.html">Lua engine</a> (including the <code>vim</code> table-related functions)</li></ul><h2>The general idea</h2><p>Neovim has mechanisms for firing up language servers, connecting to them and making their features and functionality available in buffers. It also has facilities for managing diagnostics and surfacing them in different ways.</p><p>With regards to diagnostics, a simplified flow between Neovim and a language server looks generally like this:</p><ul><li>Neovim attaches to a language server, sending the contents of the buffer to it for analysis</li><li>The language server publishes hint, information, warning and error level diagnostics (via <a href="https://code.visualstudio.com/api/language-extensions/programmatic-language-features#provide-diagnostics">textDocument/publishDiagnostics</a>)</li><li>These diagnostics are stored in Neovim via a call to <code>vim.diagnostic.set</code></li><li>Depending on the configuration, the diagnostics are displayed appropriately in the buffer</li></ul><p>While I first went down the path of trying to add a filter in the last part (diagnostic display), I found that this was ultimately the wrong way to go about it, not least because I would have found myself having to override all the various diagnostic display affordances such as signs, virtual text, and so on.</p><p>The key was to interrupt the <em>setting</em> of the diagnostics so that I could filter some out before they were actually stored, which meant overriding <code>vim.diagnostic.set</code>.</p><h2>Examining the anatomy of a diagnostic</h2><p>Understanding what a diagnostic looked like helped me enormously. In the JavaScript sample above, these two diagnostics are displayed:</p><ul><li>(H)INT 80001: File is a CommonJS module; it may be converted to an ES module.</li><li>(E)RROR 1005: ',' expected</li></ul><p>We can look at what these are via <code>vim.diagnostic.get</code>. Invoking this:</p><pre class="language-text"><code class="language-text">:lua print(vim.diagnostic.get())</code></pre><p>will just emit a table reference, something like this:</p><pre class="language-text"><code class="language-text">table: 0x68251cb7dca8</code></pre><p>But we can use the <code>vim.print</code> function instead:</p><pre class="language-text"><code class="language-text">:lua vim.print(vim.diagnostic.get())</code></pre><p>or even simply the <code>=</code> mechanism:</p><pre class="language-text"><code class="language-text">:lua =vim.diagnostic.get()</code></pre><p>and this will cause a formatted display of the table contents:</p><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span> <span class="token punctuation">{</span><br>    bufnr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><br>    code <span class="token operator">=</span> <span class="token number">1005</span><span class="token punctuation">,</span><br>    col <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><br>    end_col <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><br>    end_lnum <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><br>    lnum <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><br>    message <span class="token operator">=</span> <span class="token string">"',' expected."</span><span class="token punctuation">,</span><br>    namespace <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span><br>    severity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><br>    source <span class="token operator">=</span> <span class="token string">"typescript"</span><span class="token punctuation">,</span><br>    user_data <span class="token operator">=</span> <span class="token punctuation">{</span><br>      lsp <span class="token operator">=</span> <span class="token punctuation">{</span><br>        code <span class="token operator">=</span> <span class="token number">1005</span><span class="token punctuation">,</span><br>        message <span class="token operator">=</span> <span class="token string">"',' expected."</span><span class="token punctuation">,</span><br>        range <span class="token operator">=</span> <span class="token punctuation">{</span><br>          <span class="token punctuation">[</span><span class="token string">"end"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>            character <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><br>            line <span class="token operator">=</span> <span class="token number">4</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          start <span class="token operator">=</span> <span class="token punctuation">{</span><br>            character <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><br>            line <span class="token operator">=</span> <span class="token number">4</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        severity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><br>        source <span class="token operator">=</span> <span class="token string">"typescript"</span><span class="token punctuation">,</span><br>        tags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    bufnr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><br>    code <span class="token operator">=</span> <span class="token number">80001</span><span class="token punctuation">,</span><br>    col <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span><br>    end_col <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">,</span><br>    end_lnum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    lnum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    message <span class="token operator">=</span> <span class="token string">"File is a CommonJS module; it may be converted to an ES module."</span><span class="token punctuation">,</span><br>    namespace <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span><br>    severity <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><br>    source <span class="token operator">=</span> <span class="token string">"typescript"</span><span class="token punctuation">,</span><br>    user_data <span class="token operator">=</span> <span class="token punctuation">{</span><br>      lsp <span class="token operator">=</span> <span class="token punctuation">{</span><br>        code <span class="token operator">=</span> <span class="token number">80001</span><span class="token punctuation">,</span><br>        message <span class="token operator">=</span> <span class="token string">"File is a CommonJS module; it may be converted to an ES module."</span><span class="token punctuation">,</span><br>        range <span class="token operator">=</span> <span class="token punctuation">{</span><br>          <span class="token punctuation">[</span><span class="token string">"end"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>            character <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">,</span><br>            line <span class="token operator">=</span> <span class="token number">0</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          start <span class="token operator">=</span> <span class="token punctuation">{</span><br>            character <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span><br>            line <span class="token operator">=</span> <span class="token number">0</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        severity <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><br>        source <span class="token operator">=</span> <span class="token string">"typescript"</span><span class="token punctuation">,</span><br>        tags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre><p>I decided that I would want to filter on <code>code</code> and <code>source</code>; the <code>source</code> for both diagnostics here is <code>typescript</code>, and the <code>code</code> values are actually shown in the virtual text display already (<code>80001</code> and <code>1005</code>).</p><h2>How diagnostics are set</h2><p>Diagnostics find their way from the language server back into Neovim via <code>vim.diagnostic.set</code> which <a href="https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.set()">has this signature</a>:</p><pre class="language-text"><code class="language-text">set({namespace}, {bufnr}, {diagnostics}, {opts})</code></pre><blockquote><p>I was curious as to what the namespace was; the value is shown as <code>7</code> for both diagnostic records above; looking at the namespaces with <code>:lua =vim.api.nvim_get_namespaces()</code> shows this:</p><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span><br>  lazy <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.hlyank"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.lsp.references"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.lsp.semantic_tokens"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.lsp.semantic_tokens:1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.lsp.signature_help"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.terminal.prompt"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.treesitter.highlighter"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.vim.lsp.javascript.1.diagnostic.signs"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.vim.lsp.javascript.1.diagnostic.underline"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"nvim.vim.lsp.javascript.1.diagnostic.virtual_lines"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"vim.lsp.javascript.1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span><br><span class="token punctuation">}</span></code></pre><p>which confirms that they're coming from the language server for TypeScript/JavaScript.</p></blockquote><h3>Injecting a filter into vim.diagnostic.set</h3><p>Once I understood this, I was able to create a simple module (it's my first real foray into custom modules, so I may be doing this suboptimally), in <code>~/.config/nvim/lua/qmacro/diagnostic.lua</code>:</p><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> M <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">local</span> original_vim_diagnostic_set <span class="token operator">=</span> vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span>set<br><br><span class="token keyword">local</span> filterbuilder <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><br>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>diagnostic<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> _<span class="token punctuation">,</span> e <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span> <span class="token keyword">do</span><br>      <span class="token keyword">if</span> e<span class="token punctuation">.</span>code <span class="token operator">==</span> diagnostic<span class="token punctuation">.</span>code <span class="token keyword">and</span> e<span class="token punctuation">.</span>source <span class="token operator">==</span> diagnostic<span class="token punctuation">.</span>source <span class="token keyword">then</span><br>        <span class="token comment">-- if e.reason then</span><br>        <span class="token comment">--   print('Filtering out', diagnostic.source, '/', diagnostic.code, 'diagnostic -', e.reason)</span><br>        <span class="token comment">-- end</span><br>        <span class="token keyword">return</span> <span class="token keyword">false</span><br>      <span class="token keyword">end</span><br>    <span class="token keyword">end</span><br>    <span class="token keyword">return</span> <span class="token keyword">true</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span><br><br>M<span class="token punctuation">.</span>exclude <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><br>  vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span>set <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> bufnr<span class="token punctuation">,</span> diagnostics<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><br>    <span class="token keyword">local</span> filtered_diagnostics <span class="token operator">=</span> vim<span class="token punctuation">.</span><span class="token function">tbl_filter</span><span class="token punctuation">(</span><span class="token function">filterbuilder</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">,</span> diagnostics<span class="token punctuation">)</span><br>    <span class="token function">original_vim_diagnostic_set</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> bufnr<span class="token punctuation">,</span> filtered_diagnostics<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><br>  <span class="token keyword">end</span><br><span class="token keyword">end</span><br><br><span class="token keyword">return</span> M</code></pre><h3>Using the module</h3><p>Before walking through this, I thought it would help to show how I want to call this, from within my <code>~/.config/nvim/init.lua</code>:</p><pre class="language-lua"><code class="language-lua"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qmacro.diagnostic'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">80001</span><span class="token punctuation">,</span> source <span class="token operator">=</span> <span class="token string">'typescript'</span><span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token string">'yes I know already!'</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>In calling the <code>exclude</code> function in this module, I can pass a table of exclude filters, each of which has a <code>code</code> and <code>source</code> field, and an optional <code>reason</code> field.</p><h3>A walkthrough of the module</h3><p>Now here's a brief breakdown of the module:</p><ul><li>I save the original <code>vim.diagnostic.set</code> function in <code>original_vim_diagnostic_set</code> so I can call it later</li><li>The <code>filterbuilder</code> function takes a table of filters and produces a function (yes, I like higher order functions), specifically a predicate function, that can be then used with <a href="https://neovim.io/doc/user/lua.html#vim.tbl_filter()">vim.tbl_filter</a></li><li>The predicate function produced also has some commented-out logging (that uses the optional <code>reason</code> field from the filter entry) that I'll make good once I figure out the best way to log stuff cleanly and in accordance with standard levels</li></ul><p>With all that preparation, all that I then have to do is:</p><ul><li>Override the standard <code>vim.diagnostic.set</code> function with one that injects a call to <code>vim.tbl_filter</code> to remove any diagnostics that are caught by the exclude filters, before passing through the modified table and the rest of the original arguments to the original <code>vim.diagnostic.set</code></li></ul><p>And that's pretty much it.</p><h2>Wrapping up</h2><p>This works for me so far, and getting to this stage has also taught me some more about Neovim's Lua API and various components.</p><p>I added this setup to my Neovim configuration with <a href="https://github.com/qmacro/dotfiles/commit/fb3272c121a5acd7610dc21aceb3a7bb53190257">this commit to my dotfiles</a>.</p><p>Along with the Neovim documentation itself, the following resources helped clarify things in my mind:</p><ul><li><a href="https://influentcoder.com/posts/nvim-diagnostics/">Understanding Diagnostics in Neovim</a> by Guillaume Humbert</li><li><a href="https://blob42.xyz/blog/neovim-diagnostic-filtering/">Filtering Neovim Diagnostics</a> by Chakib Benziane</li><li><a href="https://www.youtube.com/playlist?list=PLep05UYkc6wTyBe7kPjQFWVXTlhKeQejM">Advent of Neovim</a> by TJ DeVries</li></ul><p>Thanks!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/neovim/">#neovim</a> <a href="/tags/lsp/">#lsp</a> <a href="/tags/lua/">#lua</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/"><span>A reCAP intro to the cds REPL</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>