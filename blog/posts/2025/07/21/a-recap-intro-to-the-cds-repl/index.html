<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>A reCAP intro to the cds REPL</title>
		<meta name="description" content="Here&#39;s a summary of my talk on the cds REPL at this year&#39;s reCAP event.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="A reCAP intro to the cds REPL">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Here&#39;s a summary of my talk on the cds REPL at this year&#39;s reCAP event.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="a-recap-intro-to-the-cds-repl">A reCAP intro to the cds REPL</h1>

<ul class="post-metadata">
	<li><time datetime="2025-07-21">21 July 2025</time></li>
	<li><a href="/tags/talk/" class="post-tag">talk</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/repl/" class="post-tag">repl</a>, </li>
	<li><a href="/tags/recap/" class="post-tag">recap</a>, </li>
	<li><a href="/tags/codeconnect/" class="post-tag">codeconnect</a></li>
</ul>

<p class="post-description-main">Here's a summary of my talk on the cds REPL at this year's reCAP event.</p>

<p>At <a href="https://recap-conf.dev/">reCAP</a>, part of <a href="https://code-connect.dev/">Code Connect 2025</a>, I gave a talk on the cds REPL: &quot;Gain a superpower by learning how to harness the cds REPL&quot;. You can watch the recording on the <a href="https://broadcast.sap.com/replay/250709_recap#">replay site</a>; this post is a sort of summary and accompaniment, and an extension to <a href="/blog/posts/2025/03/21/level-up-your-cap-skills-by-learning-how-to-use-the-cds-repl/">my previous post on the topic</a>. Read this post while watching the replay.</p>
<p><img src="/images/2025/07/audimax-shot.png" alt="A selfie with the audience"></p>
<h2 id="setting-up">Setting up</h2>
<p>Using my <a href="https://github.com/qmacro/cap-con-img/">cap-con-img</a> repo I built an image with the (at the time) latest CAP Node.js release which was 9.1.0 and launched a throwaway (<code>--rm</code>) container from it (I actually used <code>./buildver latest</code> which will also work but today will give you a newer version of course):</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token punctuation">;</span> gh repo clone https://github.com/qmacro/cap-con-img <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cap-con-img <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> ./buildbase <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> ./buildver <span class="token number">9.1</span>.0 <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> cap-9.1.0 <span class="token function">bash</span>
<span class="token function">node</span> ➜ ~
$</code></pre>
<blockquote>
<p>For orientation, my local shell prompt is <code>;</code>, the shell prompt inside the container is <code>$</code> and the cds REPL prompt will be <code>&gt;</code>.</p>
</blockquote>
<p>Once at the container shell prompt I initialised a new CAP project based on the <code>tiny-sample</code> facet, installing <code>@sap-cloud-sdk/http-client</code> too, as I'll need that towards the end of the talk:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash">$ cds init <span class="token parameter variable">--add</span> tiny-sample tiny-sample <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> tiny-sample <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> <span class="token function">add</span> @sap-cloud-sdk/http-client</code></pre>
<p>Here's what the entire project structure (minus the <code>node_modules/</code> content) looks like:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash">$ tree <span class="token parameter variable">-AI</span> node*
<span class="token builtin class-name">.</span>
├── README.md
├── app
├── db
│   ├── data
│   │   └── my.bookshop-Books.csv
│   └── schema.cds
├── eslint.config.mjs
├── package-lock.json
├── package.json
└── srv
    └── cat-service.cds</code></pre>
<p>Then I started the cds REPL:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds repl
Welcome to cds repl <span class="token function">v</span> <span class="token number">9.1</span>.0
<span class="token operator">></span></code></pre>
<p>It's also worth looking at the entire CDS model in source form, as it will provide the background for what I explore.</p>
<p>At the &quot;db&quot; layer there is <code>db/schema.cds</code>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">namespace</span> my.bookshop;

<span class="token keyword">entity</span> Books {
  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
  title  : <span class="token type builtin">String</span>;
  stock  : <span class="token type builtin">Integer</span>;
}</code></pre>
<p>At the &quot;service&quot; layer there is <code>srv/cat-service.cds</code>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token using keyword">using</span> my.bookshop <span class="token cqlkeywords keyword">as</span> my <span class="token from keyword">from</span> '../db/schema';

<span class="token keyword">service</span> CatalogService {
    <span class="token annotation important">@readonly</span> <span class="token keyword">entity</span> Books <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Books;
}</code></pre>
<h2 id="getting-help">Getting help</h2>
<p>The cds REPL is based on the Node.js REPL and asking for help shows the regular Node.js REPL commands plus <code>.run</code> and <code>.inspect</code> which are specific to the cds REPL:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .help
.break     Sometimes you get stuck, this gets you out
.clear     Alias <span class="token keyword">for</span> .break
.editor    Enter editor mode
.exit      Exit the REPL
.help      Print this <span class="token builtin class-name">help</span> message
.inspect   Sets options <span class="token keyword">for</span> util.inspect, e.g. <span class="token variable"><span class="token variable">`</span>.inspect .depth<span class="token operator">=</span><span class="token number">1</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span>
.load      Load JS from a <span class="token function">file</span> into the REPL session
.run       Runs a cds server from a given CAP project folder, or module name like @capire/bookshop.
.save      Save all evaluated commands <span class="token keyword">in</span> this REPL session to a <span class="token function">file</span>

Press Ctrl+C to abort current expression, Ctrl+D to <span class="token builtin class-name">exit</span> the REPL</code></pre>
<h2 id="exploring-the-cds-facade-with-inspect">Exploring the cds facade with .inspect</h2>
<p>The <a href="https://cap.cloud.sap/docs/node.js/cds-facade">cds facade</a> is a good place to start exploring. It contains a lot of detail, so I used the <code>.inspect</code> feature to keep things to a minimum:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">0</span> cds

cds: cds_facade <span class="token punctuation">{</span>
  _events: <span class="token punctuation">[</span>Object: null prototype<span class="token punctuation">]</span>,
  _eventsCount: <span class="token number">2</span>,
  _maxListeners: undefined,
  model: undefined,
  db: undefined,
  cli: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  root: <span class="token string">'/home/node/tiny-sample'</span>,
  services: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  extend: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>,
  version: <span class="token string">'9.1.0'</span>,
  builtin: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  service: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,
  log: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,
  parse: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,
  home: <span class="token string">'/home/node/tiny-sample/node_modules/@sap/cds'</span>,
  env: <span class="token punctuation">[</span>Config<span class="token punctuation">]</span>,
  requires: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>shapeMode<span class="token punctuation">)</span><span class="token punctuation">]</span>: false,
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>kCapture<span class="token punctuation">)</span><span class="token punctuation">]</span>: <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p>Running <code>.inspect .depth=N</code> on its own will fix the detail level for subsequent inspections to N.</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">0</span>

updated node:util.inspect.defaultOptions with: <span class="token punctuation">{</span> depth: <span class="token number">0</span> <span class="token punctuation">}</span></code></pre>
<p>At this point there are no values for <code>db</code>, <code>services</code> or <code>model</code> in the facade, because I've not yet started any CAP server.</p>
<h2 id="starting-a-server-with-run">Starting a server with .run</h2>
<p>With <code>.run</code> I started a CAP server based on the project in the current (<code>.</code>) directory:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .run <span class="token builtin class-name">.</span>
<span class="token punctuation">..</span>. <span class="token punctuation">(</span>usual CAP server output<span class="token punctuation">)</span>
Following variables are made available <span class="token keyword">in</span> your repl's global context:

from cds.entities: <span class="token punctuation">{</span>
  Books,
<span class="token punctuation">}</span>

from cds.services: <span class="token punctuation">{</span>
  db,
  CatalogService,
<span class="token punctuation">}</span>

Simply <span class="token builtin class-name">type</span> e.g. CatalogService <span class="token keyword">in</span> the prompt to use the respective objects.</code></pre>
<blockquote>
<p>This can be done on launching the REPL too like this: <code>cds repl --run .</code>, or <code>cds r -r .</code> if you like short invocations.</p>
</blockquote>
<p>Everything is a service, including the database facility (<code>db</code>) as well as the <code>CatalogService</code> defined in <code>srv/cat-service.cds</code>.</p>
<p>And there's also the <code>Books</code> entity from <code>db/schema.cds</code> (at this point I've increased the <code>.inspect</code> depth from 0 to 4):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> Books
entity <span class="token punctuation">{</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'entity'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">elements</span><span class="token operator">:</span> LinkedDefinitions <span class="token punctuation">{</span>
    <span class="token constant">ID</span><span class="token operator">:</span> Integer <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> String <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.String'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stock</span><span class="token operator">:</span> Integer <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>I then took a peek at some of the detail in the <code>CatalogService</code>, specifically the <code>handlers</code>, to show <a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/#1-the-code-is-in-the-framework-not-outside-of-it">the built-in mechanisms</a> - all those features one can read about in <a href="https://cap.cloud.sap/docs/">Capire</a> such as auth checks, autoexposure, input validation, paging, sorting, and so on, plus the complete support for CRUD operations, is there:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> CatalogService<span class="token punctuation">.</span>handlers
EventHandlers <span class="token punctuation">{</span>
  <span class="token literal-property property">_initial</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_service_level_restrictions<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_auth_privileges<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_readonly<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_insertonly<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_odata_constraints<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> check_autoexposed<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> enforce_auth<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> restrict_expand<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'CREATE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handle_paging<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handle_sorting<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'CREATE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'UPSERT'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">after</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">_error</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="understanding-entities-at-different-levels">Understanding entities at different levels</h2>
<p>With the <a href="#cds-model">CDS model</a> in mind, I stopped for a moment to look at the difference between what the injected variable <code>Books</code> represents (shown just above), and what the expanded &quot;service-equivalent&quot; looks like, in <code>CatalogService.entities</code>, which I first extracted using a destructuring assignment:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token literal-property property">Books</span><span class="token operator">:</span> mybooks <span class="token punctuation">}</span> <span class="token operator">=</span> CatalogService<span class="token punctuation">.</span>entities
<span class="token punctuation">[</span>object Function<span class="token punctuation">]</span></code></pre>
<p>and then inspected:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> mybooks
entity <span class="token punctuation">{</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'entity'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'@readonly'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">projection</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'my.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">elements</span><span class="token operator">:</span> LinkedDefinitions <span class="token punctuation">{</span>
    <span class="token constant">ID</span><span class="token operator">:</span> Integer <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> String <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.String'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stock</span><span class="token operator">:</span> Integer <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">'@Capabilities.DeleteRestrictions.Deletable'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">'@Capabilities.InsertRestrictions.Insertable'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">'@Capabilities.UpdateRestrictions.Updatable'</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p>What's different is that this &quot;version&quot; is a projection on the <code>Books</code> entity (in the <code>my.bookshop</code> namespace), defined by a query object construct, there's a <code>@readonly</code> annotation defined upon it, which in turn <a href="https://cap.cloud.sap/docs/guides/security/authorization#restricting-events">expand into</a> the <code>@Capabilities</code> based restrictions seen here.</p>
<h2 id="building-and-executing-query-objects">Building and executing query objects</h2>
<p>In CAP query objects are first class citizens and essential to our understanding of the fundamentals. They're constructed at a core level with <a href="https://cap.cloud.sap/docs/node.js/cds-ql">cds.ql</a> but there are also higher level APIs such as the <a href="https://cap.cloud.sap/docs/node.js/core-services#crud-style-api">CRUD-style API</a> which I used here, assigning the object directly to a variable:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> thebooks <span class="token operator">=</span> CatalogService<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>mybooks<span class="token punctuation">)</span>
cds<span class="token punctuation">.</span>ql <span class="token punctuation">{</span>
  <span class="token constant">SELECT</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>To <a href="https://cap.cloud.sap/docs/node.js/cds-ql#executing-queries">execute the query</a> I used <code>await</code>, which by default passes the query to <code>cds.db.run()</code>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> thebooks
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> <span class="token literal-property property">stock</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> <span class="token literal-property property">stock</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>In other words, this is the same as:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>thebooks<span class="token punctuation">)</span></code></pre>
<p>because I still have the <code>db</code> variable that was automatically made available in the REPL session's global context.</p>
<p>Queries can be extended, which I did at this point:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> thebooks<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">'stock'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">'>'</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> <span class="token literal-property property">stock</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre>
<blockquote>
<p>Beware, this will modify the query object:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> thebooks
cds<span class="token punctuation">.</span>ql <span class="token punctuation">{</span>
  <span class="token constant">SELECT</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'stock'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</blockquote>
<h2 id="creating-a-service-from-scratch">Creating a service from scratch</h2>
<p>As well as defining a service (such as <code>CatalogService</code>) in the CDS model, it's possible to create a service from the ground up, which I illustrated next:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> srv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">cds<span class="token punctuation">.</span>Service</span>
Service <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Service'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">handlers</span><span class="token operator">:</span> EventHandlers <span class="token punctuation">{</span>
    <span class="token literal-property property">_initial</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">after</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_error</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">definition</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span></code></pre>
<p>This is like an &quot;empty&quot; version of the service I looked at before - for example, there are no handlers defined.</p>
<p>That doesn't prevent the sending of messages; it's just that nothing will happen, as I then demonstrated:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> srv<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'recap'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">></span></code></pre>
<p>At this point I defined a super simple handler for the <code>recap</code> event (remember, a handler definition is essentially a function, so <code>console.log</code> will do just fine here):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> srv<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'recap'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span></code></pre>
<p>This time, because of the definition of the <code>on</code> phase handler for this event named <code>recap</code>, the data is passed to the handler function, which outputs it:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> srv<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'recap'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
Request <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'recap'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token string">'awesome'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> next<span class="token punctuation">]</span></code></pre>
<p>This is what was shown in the output:</p>
<ul>
<li>what is being passed is an object of type <code>Request</code></li>
<li>the content of the <code>Request</code>, an object containing the request <code>method</code>, and the payload (in <code>data</code>)</li>
<li>a <code>next</code> function that can be called by the handler</li>
</ul>
<p>In other words, this is effectively a request/response concept, close to the synchronous ideas in HTTP, for example.</p>
<p>Then, to contrast this with an event message concept, close to the asynchronous ideas with event emitters and receivers, I swapped out the <code>srv.send</code> and used <code>srv.emit</code> instead:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> srv<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'recap'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
EventMessage <span class="token punctuation">{</span> <span class="token literal-property property">event</span><span class="token operator">:</span> <span class="token string">'recap'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token string">'awesome'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> _dummy<span class="token punctuation">]</span></code></pre>
<p>This time the <code>console.log</code> handler showed that:</p>
<ul>
<li>what is being passed is an object of type <code>EventMessage</code> (as opposed to <code>Request</code>)</li>
<li>the <code>recap</code> name is the same, but is now treated as an <code>event</code> rather than a <code>method</code></li>
<li>there is no <code>next</code> function (just a <code>_dummy</code>)</li>
</ul>
<p>This <code>next</code> vs <code>_dummy</code> function is at the heart of one of the key differences between events and requests in CAP. In both contexts one can define multiple handlers that are called in sequence for a given message.</p>
<p>The handling of <em>requests</em> is done in the context of a classic <a href="https://cap.cloud.sap/docs/node.js/core-services#interceptor-stack-with-next">interceptor stack</a>, where any given handler can break the chain and effectively declare that the message has been handled (by not calling <code>next</code> to pass the processing to the next handler in the stack). But there is no interceptor stack in the handling of <em>events</em> - every registered handler is called, regardless (and therefore there's no need for the <code>next</code> function).</p>
<h2 id="sending-queries-to-a-remote-service">Sending queries to a remote service</h2>
<p>Constructing and sending queries to services is fundamental in CAP. Earlier I constructed a query and sent it to the <code>db</code> service. In this last part of the talk I showed how one can construct a query and send it to a remote service (my <a href="https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze">Northbreeze OData service</a>), without having to think too much at all about the fact that it is even remote.</p>
<p>In CAP services are either &quot;required&quot; or &quot;provided&quot;. A remote service is one that is &quot;required&quot;, commonly with the details in <code>package.json#cds.requires</code>, and <a href="https://cap.cloud.sap/docs/node.js/cds-connect">cds.connect</a> is used to make a connection to such a remote service.</p>
<p>I don't have anything in <code>package.json#cds.requires</code> so this is what I got when I tried something simple like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string">'northbreeze'</span><span class="token punctuation">)</span>
Promise <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>rejected<span class="token operator">></span> Error<span class="token operator">:</span> Didn<span class="token string">'t find a configuration for '</span>cds<span class="token punctuation">.</span>requires<span class="token punctuation">.</span>northbreeze' <span class="token keyword">in</span> <span class="token operator">/</span>home<span class="token operator">/</span>node<span class="token operator">/</span>tiny<span class="token operator">-</span>sample</code></pre>
<p>There's a second parameter to <code>cds.connect.to</code> which expects an options object, wherein one can provide a service binding (essentially a destination object) in a <code>credentials</code> property:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> nb <span class="token operator">=</span> <span class="token keyword">await</span> cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string">'northbreeze'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
RemoteService <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'northbreeze'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">impl</span><span class="token operator">:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">handlers</span><span class="token operator">:</span> EventHandlers <span class="token punctuation">{</span>
    <span class="token literal-property property">_initial</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> clearKeysFromData<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> on_handler<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">after</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_error</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">definition</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token string">'/home/node/tiny-sample/node_modules/@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">datasource</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">destinationOptions</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">requestTimeout</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
  <span class="token literal-property property">csrf</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">csrfInBatch</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">middlewares</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">Function</span> <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">csrf</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entities</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Doing this, and assigning the result to a variable, gives a <code>RemoteService</code> object, which is on a similar level to the <code>db</code> and <code>CatalogService</code> objects I had after starting the CAP server:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token punctuation">[</span>db<span class="token punctuation">,</span> CatalogService<span class="token punctuation">,</span> nb<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token punctuation">.</span>kind<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token literal-property property">db</span><span class="token operator">:</span> <span class="token function">SQLiteService</span> <span class="token punctuation">(</span>sqlite<span class="token punctuation">)</span>
<span class="token literal-property property">CatalogService</span><span class="token operator">:</span> <span class="token function">ApplicationService</span> <span class="token punctuation">(</span>app<span class="token operator">-</span>service<span class="token punctuation">)</span>
<span class="token literal-property property">northbreeze</span><span class="token operator">:</span> <span class="token function">RemoteService</span> <span class="token punctuation">(</span>odata<span class="token punctuation">)</span></code></pre>
<p>At this point I constructed a new query object, enjoying how the approach (which uses tagged templates) allows me to express my query in almost-English:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> cats <span class="token operator">=</span> <span class="token constant">SELECT</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">CategoryName</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">.</span>from <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Categories</span><span class="token template-punctuation string">`</span></span>
cds<span class="token punctuation">.</span>ql <span class="token punctuation">{</span>
  <span class="token constant">SELECT</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'Categories'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">columns</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'CategoryName'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The context here in the post has diverged slightly from the context of the talk, because (as I'd exited the cds REPL back to the shell to show the output of <code>npm ls</code>) the cds REPL session at this point was a fresh one in the talk, one where I hadn't re-invoked the CAP server (with <code>.run .</code>), and therefore there was no <code>db</code> variable injected into the global REPL context like before.</p>
<p>So when I ran this during the talk, this happened:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> cats
Uncaught Error<span class="token operator">:</span> Can't execute query <span class="token keyword">as</span> no primary database is connected<span class="token punctuation">.</span></code></pre>
<p>But here, while we <em>do</em> have a primary database in the form of <code>db</code>, we get a different and equally illustrative error, which nicely illustrated the default use of <code>db.run</code> when <code>await</code>-ing a query - it sent the query to be executed in the context of that local database:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> cats
Uncaught SqliteError<span class="token operator">:</span> no such table<span class="token operator">:</span> Categories <span class="token keyword">in</span><span class="token operator">:</span>
<span class="token constant">SELECT</span> CategoryName <span class="token constant">FROM</span> Categories</code></pre>
<p>Of course, I wanted to have this query sent to the remote service, which I achieved with the same method but called on the <code>RemoteService</code> object (in <code>nb</code>), rather than the <code>SQLiteService</code> object (in <code>db</code>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">await</span> nb<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>cats<span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Beverages'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Condiments'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Confections'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Dairy Products'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Grains/Cereals'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Meat/Poultry'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Produce'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">CategoryName</span><span class="token operator">:</span> <span class="token string">'Seafood'</span><span class="token punctuation">,</span> <span class="token literal-property property">CategoryID</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>The query object is serialised and sent to the remote service, and the results returned, without me having to do anything! If you're curious, information on the built-in implementation that facilitates this is also available:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token operator">></span> nb<span class="token punctuation">.</span>options
<span class="token punctuation">{</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">impl</span><span class="token operator">:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Excellent!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>With that, I wrapped up the talk (it was only a 20 minute slot) and so I'll wrap up this post too.</p>
<p>Let me know in the comments how you get on with the cds REPL, and share what you discover!</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node-js-configuration-and-diagnostics/">A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/08/04/excluding-specific-diagnostics-in-neovim/">Excluding specific diagnostics in Neovim</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/` was built on 2026-01-19T11:30:31.549Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
