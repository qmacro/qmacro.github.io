<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.7884d8f8e9dd86c3b137.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>A reCAP intro to the cds REPL | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="A reCAP intro to the cds REPL"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/"><meta name="description" content="A reCAP intro to the cds REPL 21 Jul 2025 | 8 min read At reCAP, part of Code Connect 2025, I gave a talk on the cds REPL: &amp;quot;Gain a..."><meta property="og:description" content="A reCAP intro to the cds REPL 21 Jul 2025 | 8 min read At reCAP, part of Code Connect 2025, I gave a talk on the cds REPL: &amp;quot;Gain a..."><meta name="description" content="A reCAP intro to the cds REPL 21 Jul 2025 | 8 min read At reCAP, part of Code Connect 2025, I gave a talk on the cds REPL: &amp;quot;Gain a..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>A reCAP intro to the cds REPL</h1><div class="post__details"><time datetime="2025-07-21">21 Jul 2025 </time><span>| </span><span>8 min read</span></div></header><main class="post__content"><p>At <a href="https://recap-conf.dev/">reCAP</a>, part of <a href="https://code-connect.dev/">Code Connect 2025</a>, I gave a talk on the cds REPL: &quot;Gain a superpower by learning how to harness the cds REPL&quot;. You can watch the recording on the <a href="https://broadcast.sap.com/replay/250709_recap#">replay site</a>; this post is a sort of summary and accompaniment, and an extension to <a href="/blog/posts/2025/03/21/level-up-your-cap-skills-by-learning-how-to-use-the-cds-repl/">my previous post on the topic</a>. Read this post while watching the replay.</p><p><img src="/images/2025/07/audimax-shot.png" alt="A selfie with the audience"></p><p><a name="setting-up"></a></p><h2>Setting up</h2><p>Using my <a href="https://github.com/qmacro/cap-con-img/">cap-con-img</a> repo I built an image with the (at the time) latest CAP Node.js release which was 9.1.0 and launched a throwaway (<code>--rm</code>) container from it (I actually used <code>./buildver latest</code> which will also work but today will give you a newer version of course):</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">;</span> gh repo clone https://github.com/qmacro/cap-con-img <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cap-con-img <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> ./buildbase <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> ./buildver <span class="token number">9.1</span>.0 <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> cap-9.1.0 <span class="token function">bash</span><br><span class="token function">node</span> ➜ ~<br>$</code></pre><blockquote><p>For orientation, my local shell prompt is <code>;</code>, the shell prompt inside the container is <code>$</code> and the cds REPL prompt will be <code>&gt;</code>.</p></blockquote><p>Once at the container shell prompt I initialised a new CAP project based on the <code>tiny-sample</code> facet, installing <code>@sap-cloud-sdk/http-client</code> too, as I'll need that towards the end of the talk:</p><pre class="language-bash"><code class="language-bash">$ cds init <span class="token parameter variable">--add</span> tiny-sample tiny-sample <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> tiny-sample <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> <span class="token function">add</span> @sap-cloud-sdk/http-client</code></pre><p>Here's what the entire project structure (minus the <code>node_modules/</code> content) looks like:</p><pre class="language-bash"><code class="language-bash">$ tree <span class="token parameter variable">-AI</span> node*<br><span class="token builtin class-name">.</span><br>├── README.md<br>├── app<br>├── db<br>│   ├── data<br>│   │   └── my.bookshop-Books.csv<br>│   └── schema.cds<br>├── eslint.config.mjs<br>├── package-lock.json<br>├── package.json<br>└── srv<br>    └── cat-service.cds</code></pre><p>Then I started the cds REPL:</p><pre class="language-shell"><code class="language-shell">$ cds repl<br>Welcome to cds repl <span class="token function">v</span> <span class="token number">9.1</span>.0<br><span class="token operator">></span></code></pre><p><a name="cds-model"></a> It's also worth looking at the entire CDS model in source form, as it will provide the background for what I explore.</p><p>At the &quot;db&quot; layer there is <code>db/schema.cds</code>:</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">namespace</span> my.bookshop;<br><br><span class="token keyword">entity</span> Books {<br>  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;<br>  title  : <span class="token type builtin">String</span>;<br>  stock  : <span class="token type builtin">Integer</span>;<br>}</code></pre><p>At the &quot;service&quot; layer there is <code>srv/cat-service.cds</code>:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> my.bookshop <span class="token cqlkeywords keyword">as</span> my <span class="token from keyword">from</span> '../db/schema';<br><br><span class="token keyword">service</span> CatalogService {<br>    <span class="token annotation important">@readonly</span> <span class="token keyword">entity</span> Books <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Books;<br>}</code></pre><p><a name="getting-help"></a></p><h2>Getting help</h2><p>The cds REPL is based on the Node.js REPL and asking for help shows the regular Node.js REPL commands plus <code>.run</code> and <code>.inspect</code> which are specific to the cds REPL:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> .help<br>.break     Sometimes you get stuck, this gets you out<br>.clear     Alias <span class="token keyword">for</span> .break<br>.editor    Enter editor mode<br>.exit      Exit the REPL<br>.help      Print this <span class="token builtin class-name">help</span> message<br>.inspect   Sets options <span class="token keyword">for</span> util.inspect, e.g. <span class="token variable"><span class="token variable">`</span>.inspect .depth<span class="token operator">=</span><span class="token number">1</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span><br>.load      Load JS from a <span class="token function">file</span> into the REPL session<br>.run       Runs a cds server from a given CAP project folder, or module name like @capire/bookshop.<br>.save      Save all evaluated commands <span class="token keyword">in</span> this REPL session to a <span class="token function">file</span><br><br>Press Ctrl+C to abort current expression, Ctrl+D to <span class="token builtin class-name">exit</span> the REPL</code></pre><p><a name="exploring-the-cds-facade-with-inspect"></a></p><h2>Exploring the cds facade with .inspect</h2><p>The <a href="https://cap.cloud.sap/docs/node.js/cds-facade">cds facade</a> is a good place to start exploring. It contains a lot of detail, so I used the <code>.inspect</code> feature to keep things to a minimum:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">0</span> cds<br><br>cds: cds_facade <span class="token punctuation">{</span><br>  _events: <span class="token punctuation">[</span>Object: null prototype<span class="token punctuation">]</span>,<br>  _eventsCount: <span class="token number">2</span>,<br>  _maxListeners: undefined,<br>  model: undefined,<br>  db: undefined,<br>  cli: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,<br>  root: <span class="token string">'/home/node/tiny-sample'</span>,<br>  services: <span class="token punctuation">{</span><span class="token punctuation">}</span>,<br>  extend: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>,<br>  version: <span class="token string">'9.1.0'</span>,<br>  builtin: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,<br>  service: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,<br>  log: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,<br>  parse: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span>,<br>  home: <span class="token string">'/home/node/tiny-sample/node_modules/@sap/cds'</span>,<br>  env: <span class="token punctuation">[</span>Config<span class="token punctuation">]</span>,<br>  requires: <span class="token punctuation">{</span><span class="token punctuation">}</span>,<br>  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>shapeMode<span class="token punctuation">)</span><span class="token punctuation">]</span>: false,<br>  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>kCapture<span class="token punctuation">)</span><span class="token punctuation">]</span>: <span class="token boolean">false</span><br><span class="token punctuation">}</span></code></pre><p>Running <code>.inspect .depth=N</code> on its own will fix the detail level for subsequent inspections to N.</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">0</span><br><br>updated node:util.inspect.defaultOptions with: <span class="token punctuation">{</span> depth: <span class="token number">0</span> <span class="token punctuation">}</span></code></pre><p>At this point there are no values for <code>db</code>, <code>services</code> or <code>model</code> in the facade, because I've not yet started any CAP server.</p><p><a name="starting-a-server-with-run"></a></p><h2>Starting a server with .run</h2><p>With <code>.run</code> I started a CAP server based on the project in the current (<code>.</code>) directory:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> .run <span class="token builtin class-name">.</span><br><span class="token punctuation">..</span>. <span class="token punctuation">(</span>usual CAP server output<span class="token punctuation">)</span><br>Following variables are made available <span class="token keyword">in</span> your repl's global context:<br><br>from cds.entities: <span class="token punctuation">{</span><br>  Books,<br><span class="token punctuation">}</span><br><br>from cds.services: <span class="token punctuation">{</span><br>  db,<br>  CatalogService,<br><span class="token punctuation">}</span><br><br>Simply <span class="token builtin class-name">type</span> e.g. CatalogService <span class="token keyword">in</span> the prompt to use the respective objects.</code></pre><blockquote><p>This can be done on launching the REPL too like this: <code>cds repl --run .</code>, or <code>cds r -r .</code> if you like short invocations.</p></blockquote><p>Everything is a service, including the database facility (<code>db</code>) as well as the <code>CatalogService</code> defined in <code>srv/cat-service.cds</code>.</p><p>And there's also the <code>Books</code> entity from <code>db/schema.cds</code> (at this point I've increased the <code>.inspect</code> depth from 0 to 4):</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> Books<br>entity <span class="token punctuation">{</span><br>  kind: <span class="token string">'entity'</span>,<br>  elements: LinkedDefinitions <span class="token punctuation">{</span><br>    ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,<br>    title: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>    stock: Integer <span class="token punctuation">{</span> type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>I then took a peek at some of the detail in the <code>CatalogService</code>, specifically the <code>handlers</code>, to show <a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/#1-the-code-is-in-the-framework-not-outside-of-it">the built-in mechanisms</a> - all those features one can read about in <a href="https://cap.cloud.sap/docs/">Capire</a> such as auth checks, autoexposure, input validation, paging, sorting, and so on, plus the complete support for CRUD operations, is there:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> CatalogService.handlers<br>EventHandlers <span class="token punctuation">{</span><br>  _initial: <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      before: <span class="token string">'*'</span>,<br>      handler: <span class="token punctuation">[</span>Function: check_service_level_restrictions<span class="token punctuation">]</span><br>    <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: check_auth_privileges<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: check_readonly<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: check_insertonly<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: check_odata_constraints<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: check_autoexposed<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: enforce_auth<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: restrict_expand<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'CREATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'NEW'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: validate_input<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: handle_paging<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: handle_sorting<span class="token punctuation">]</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span>,<br>  before: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>  on: <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span> on: <span class="token string">'CREATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> on: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> on: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> on: <span class="token string">'DELETE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    <span class="token punctuation">{</span> on: <span class="token string">'UPSERT'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: handle_crud_requests<span class="token punctuation">]</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span>,<br>  after: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>  _error: <span class="token punctuation">[</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre><p><a name="understanding-entities-at-different-levels"></a></p><h2>Understanding entities at different levels</h2><p>With the <a href="#cds-model">CDS model</a> in mind, I stopped for a moment to look at the difference between what the injected variable <code>Books</code> represents (shown just above), and what the expanded &quot;service-equivalent&quot; looks like, in <code>CatalogService.entities</code>, which I first extracted using a destructuring assignment:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> <span class="token punctuation">{</span> Books: mybooks <span class="token punctuation">}</span> <span class="token operator">=</span> CatalogService.entities<br><span class="token punctuation">[</span>object Function<span class="token punctuation">]</span></code></pre><p>and then inspected:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> mybooks<br>entity <span class="token punctuation">{</span><br>  kind: <span class="token string">'entity'</span>,<br>  <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,<br>  projection: <span class="token punctuation">{</span> from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'my.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,<br>  elements: LinkedDefinitions <span class="token punctuation">{</span><br>    ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,<br>    title: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>    stock: Integer <span class="token punctuation">{</span> type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span>,<br>  <span class="token string">'@Capabilities.DeleteRestrictions.Deletable'</span><span class="token builtin class-name">:</span> false,<br>  <span class="token string">'@Capabilities.InsertRestrictions.Insertable'</span><span class="token builtin class-name">:</span> false,<br>  <span class="token string">'@Capabilities.UpdateRestrictions.Updatable'</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span><br><span class="token punctuation">}</span></code></pre><p>What's different is that this &quot;version&quot; is a projection on the <code>Books</code> entity (in the <code>my.bookshop</code> namespace), defined by a query object construct, there's a <code>@readonly</code> annotation defined upon it, which in turn <a href="https://cap.cloud.sap/docs/guides/security/authorization#restricting-events">expand into</a> the <code>@Capabilities</code> based restrictions seen here.</p><p><a name="building-and-executing-query-objects"></a></p><h2>Building and executing query objects</h2><p>In CAP query objects are first class citizens and essential to our understanding of the fundamentals. They're constructed at a core level with <a href="https://cap.cloud.sap/docs/node.js/cds-ql">cds.ql</a> but there are also higher level APIs such as the <a href="https://cap.cloud.sap/docs/node.js/core-services#crud-style-api">CRUD-style API</a> which I used here, assigning the object directly to a variable:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> thebooks <span class="token operator">=</span> CatalogService.read<span class="token punctuation">(</span>mybooks<span class="token punctuation">)</span><br>cds.ql <span class="token punctuation">{</span><br>  SELECT: <span class="token punctuation">{</span> from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>To <a href="https://cap.cloud.sap/docs/node.js/cds-ql#executing-queries">execute the query</a> I used <code>await</code>, which by default passes the query to <code>cds.db.run()</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await thebooks<br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> ID: <span class="token number">1</span>, title: <span class="token string">'Wuthering Heights'</span>, stock: <span class="token number">100</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> ID: <span class="token number">2</span>, title: <span class="token string">'Jane Eyre'</span>, stock: <span class="token number">500</span> <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>In other words, this is the same as:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await db.run<span class="token punctuation">(</span>thebooks<span class="token punctuation">)</span></code></pre><p>because I still have the <code>db</code> variable that was automatically made available in the REPL session's global context.</p><p>Queries can be extended, which I did at this point:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await thebooks.where<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'stock'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">'>'</span><span class="token builtin class-name">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">2</span>, title: <span class="token string">'Jane Eyre'</span>, stock: <span class="token number">500</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre><blockquote><p>Beware, this will modify the query object:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> thebooks<br>cds.ql <span class="token punctuation">{</span><br>  SELECT: <span class="token punctuation">{</span><br>    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    where: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'stock'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token string">'>'</span>, <span class="token punctuation">{</span> val: <span class="token number">100</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></blockquote><p><a name="creating-a-service-from-scratch"></a></p><h2>Creating a service from scratch</h2><p>As well as defining a service (such as <code>CatalogService</code>) in the CDS model, it's possible to create a service from the ground up, which I illustrated next:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> srv <span class="token operator">=</span> new cds.Service<br>Service <span class="token punctuation">{</span><br>  name: <span class="token string">'Service'</span>,<br>  options: <span class="token punctuation">{</span><span class="token punctuation">}</span>,<br>  handlers: EventHandlers <span class="token punctuation">{</span><br>    _initial: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    before: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    on: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    after: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    _error: <span class="token punctuation">[</span><span class="token punctuation">]</span><br>  <span class="token punctuation">}</span>,<br>  definition: undefined<br><span class="token punctuation">}</span></code></pre><p>This is like an &quot;empty&quot; version of the service I looked at before - for example, there are no handlers defined.</p><p>That doesn't prevent the sending of messages; it's just that nothing will happen, as I then demonstrated:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await srv.send<span class="token punctuation">(</span><span class="token string">'recap'</span>, <span class="token punctuation">{</span> is: <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token operator">></span></code></pre><p>At this point I defined a super simple handler for the <code>recap</code> event (remember, a handler definition is essentially a function, so <code>console.log</code> will do just fine here):</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> srv.on<span class="token punctuation">(</span><span class="token string">'recap'</span>, console.log<span class="token punctuation">)</span></code></pre><p>This time, because of the definition of the <code>on</code> phase handler for this event named <code>recap</code>, the data is passed to the handler function, which outputs it:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await srv.send<span class="token punctuation">(</span><span class="token string">'recap'</span>, <span class="token punctuation">{</span> is: <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>Request <span class="token punctuation">{</span> method: <span class="token string">'recap'</span>, data: <span class="token punctuation">{</span> is: <span class="token string">'awesome'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span>AsyncFunction: next<span class="token punctuation">]</span></code></pre><p>This is what was shown in the output:</p><ul><li>what is being passed is an object of type <code>Request</code></li><li>the content of the <code>Request</code>, an object containing the request <code>method</code>, and the payload (in <code>data</code>)</li><li>a <code>next</code> function that can be called by the handler</li></ul><p>In other words, this is effectively a request/response concept, close to the synchronous ideas in HTTP, for example.</p><p>Then, to contrast this with an event message concept, close to the ideas in the asynchronous ideas in event emitters and receivers, I swapped out the <code>srv.send</code> and used <code>srv.emit</code> instead:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await srv.emit<span class="token punctuation">(</span><span class="token string">'recap'</span>, <span class="token punctuation">{</span> is: <span class="token string">"awesome"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>EventMessage <span class="token punctuation">{</span> event: <span class="token string">'recap'</span>, data: <span class="token punctuation">{</span> is: <span class="token string">'awesome'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span>Function: _dummy<span class="token punctuation">]</span></code></pre><p>This time the <code>console.log</code> handler showed that:</p><ul><li>what is being passed is an object of type <code>EventMessage</code> (as opposed to <code>Request</code>)</li><li>the <code>recap</code> name is the same, but is now treated as an <code>event</code> rather than a <code>method</code></li><li>there is no <code>next</code> function (just a <code>_dummy</code>)</li></ul><p>This <code>next</code> vs <code>_dummy</code> function is at the heart of one of the key differences between events and requests in CAP. In both contexts one can define multiple handlers that are called in sequence for a given message.</p><p>The handling of <em>requests</em> is done in the context of a classic <a href="https://cap.cloud.sap/docs/node.js/core-services#interceptor-stack-with-next">interceptor stack</a>, where any given handler break the chain and effectively declare that the message has been handled (by not calling <code>next</code> to pass the processing to the next handler in the stack). But there is no interceptor stack in the handling of <em>events</em> - every registered handler is called, regardless (and therefore there's no need for the <code>next</code> function).</p><p><a name="sending-queries-to-a-remote-service"></a></p><h2>Sending queries to a remote service</h2><p>Constructing and sending queries to services is fundamental in CAP. Earlier I constructed a query and sent it to the <code>db</code> service. In this last part of the talk I showed how one can construct a query and send it to a remote service (my <a href="https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze">Northbreeze OData service</a>), without having to think too much at all about the fact that it is even remote.</p><p>In CAP services are either &quot;required&quot; or &quot;provided&quot;. A remote service is one that is &quot;required&quot;, commonly with the details in <code>package.json#cds.requires</code>, and <a href="https://cap.cloud.sap/docs/node.js/cds-connect">cds.connect</a> is used to make a connection to such a remote service.</p><p>I don't have anything in <code>package.json#cds.requires</code> so this is what I got when I tried something simple like this:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> cds.connect.to<span class="token punctuation">(</span><span class="token string">'northbreeze'</span><span class="token punctuation">)</span><br>Promise <span class="token punctuation">{</span><br>  <span class="token operator">&lt;</span>rejected<span class="token operator">></span> Error: Didn<span class="token string">'t find a configuration for '</span>cds.requires.northbreeze' <span class="token keyword">in</span> /home/node/tiny-sample</code></pre><p>There's a second parameter to <code>cds.connect.to</code> which expects an options object, wherein one can provide a service binding (essentially a destination object) in a <code>credentials</code> property:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> nb <span class="token operator">=</span> await cds.connect.to<span class="token punctuation">(</span><span class="token string">'northbreeze'</span>, <span class="token punctuation">{</span>kind: <span class="token string">'odata'</span>, credentials: <span class="token punctuation">{</span> url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>RemoteService <span class="token punctuation">{</span><br>  name: <span class="token string">'northbreeze'</span>,<br>  options: <span class="token punctuation">{</span><br>    kind: <span class="token string">'odata'</span>,<br>    impl: <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span>,<br>    external: true,<br>    credentials: <span class="token punctuation">{</span><br>      url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span>,<br>  kind: <span class="token string">'odata'</span>,<br>  handlers: EventHandlers <span class="token punctuation">{</span><br>    _initial: <span class="token punctuation">[</span> <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>Function: clearKeysFromData<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,<br>    before: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    on: <span class="token punctuation">[</span> <span class="token punctuation">{</span> on: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: on_handler<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,<br>    after: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>    _error: <span class="token punctuation">[</span><span class="token punctuation">]</span><br>  <span class="token punctuation">}</span>,<br>  definition: undefined,<br>  _source: <span class="token string">'/home/node/tiny-sample/node_modules/@sap/cds/libx/_runtime/remote/Service.js'</span>,<br>  datasource: undefined,<br>  destinationOptions: undefined,<br>  destination: <span class="token punctuation">{</span><br>    name: undefined,<br>    url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span><br>  <span class="token punctuation">}</span>,<br>  path: undefined,<br>  requestTimeout: <span class="token number">60000</span>,<br>  csrf: undefined,<br>  csrfInBatch: undefined,<br>  middlewares: <span class="token punctuation">{</span> timeout: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>, csrf: undefined <span class="token punctuation">}</span>,<br>  entities: <span class="token punctuation">[</span><span class="token punctuation">]</span>,<br>  actions: <span class="token punctuation">[</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre><p>Doing this, and assigning the result to a variable, gives a <code>RemoteService</code> object, which is on a similar level to the <code>db</code> and <code>CatalogService</code> objects I had after starting the CAP server:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> <span class="token punctuation">[</span>db, CatalogService, nb<span class="token punctuation">]</span>.forEach<span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> console.log<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>$<span class="token punctuation">{</span>x.name<span class="token punctuation">}</span>: $<span class="token punctuation">{</span>x.constructor.name<span class="token punctuation">}</span> <span class="token punctuation">(</span>$<span class="token punctuation">{</span>x.kind<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token variable">`</span></span><span class="token punctuation">))</span><br>db: SQLiteService <span class="token punctuation">(</span>sqlite<span class="token punctuation">)</span><br>CatalogService: ApplicationService <span class="token punctuation">(</span>app-service<span class="token punctuation">)</span><br>northbreeze: RemoteService <span class="token punctuation">(</span>odata<span class="token punctuation">)</span></code></pre><p>At this point I constructed a new query object, enjoying how the approach (which uses tagged templates) allows me to express my query in almost-English:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> cats <span class="token operator">=</span> SELECT <span class="token variable"><span class="token variable">`</span>CategoryName<span class="token variable">`</span></span> .from <span class="token variable"><span class="token variable">`</span>Categories<span class="token variable">`</span></span><br>cds.ql <span class="token punctuation">{</span><br>  SELECT: <span class="token punctuation">{</span><br>    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'Categories'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,<br>    columns: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CategoryName'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>The context here in the post has diverged slightly from the context of the talk, because (as I'd exited the cds REPL back to the shell to show the output of <code>npm ls</code>) the cds REPL session at this point was a fresh one in the talk, one where I hadn't re-invoked the CAP server (with <code>.run .</code>), and therefore there was no <code>db</code> variable injected into the global REPL context like before.</p><p>So when I ran this during the talk, this happened, which nicely illustrated the default use of <code>db.run</code> when <code>await</code>-ing a query:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> await cats<br>Uncaught Error: Can't execute query as no primary database is connected.</code></pre><p>But here, while we <em>do</em> have a primary database in the form of <code>db</code>, we get a different and equally illustrative error:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> await cats<br>Uncaught SqliteError: no such table: Categories in:<br>SELECT CategoryName FROM Categories</code></pre><p>Of course, I wanted to have this query sent to the remote service, which I achieved with the same method but called on the <code>RemoteService</code> object (in <code>nb</code>), rather than the <code>SQLiteService</code> object (in <code>db</code>):</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> await nb.run<span class="token punctuation">(</span>cats<span class="token punctuation">)</span><br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Beverages'</span>, CategoryID: <span class="token number">1</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Condiments'</span>, CategoryID: <span class="token number">2</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Confections'</span>, CategoryID: <span class="token number">3</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Dairy Products'</span>, CategoryID: <span class="token number">4</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Grains/Cereals'</span>, CategoryID: <span class="token number">5</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Meat/Poultry'</span>, CategoryID: <span class="token number">6</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Produce'</span>, CategoryID: <span class="token number">7</span> <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Seafood'</span>, CategoryID: <span class="token number">8</span> <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>The query object is serialised and sent to the remote service, and the results returned, without me having to do anything! If you're curious, information on the built-in implementation that facilitates this is also available:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> nb.options<br><span class="token punctuation">{</span><br>  kind: <span class="token string">'odata'</span>,<br>  impl: <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span>,<br>  external: true,<br>  credentials: <span class="token punctuation">{</span><br>    url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Excellent!</p><h2>Wrapping up</h2><p>With that, I wrapped up the talk (it was only a 20 minute slot) and so I'll wrap up this post too.</p><p>Let me know in the comments how you get on with the cds REPL, and share what you discover!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/talk/">#talk</a> <a href="/tags/cap/">#cap</a> <a href="/tags/cds/">#cds</a> <a href="/tags/repl/">#repl</a> <a href="/tags/recap/">#recap</a> <a href="/tags/codeconnect/">#codeconnect</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2025/08/04/excluding-specific-diagnostics-in-neovim/"><span>←</span> <span>Excluding specific diagnostics in Neovim</span> </a><a href="/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node.js-configuration-and-diagnostics/"><span>A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>