<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Level up your CAP skills by learning how to use the cds REPL</title>
		<meta name="description" content="These are notes I wrote for my talk at SAP Inside Track Madrid on 20 March 2025. I wrote them partly to think about what I wanted to say, and partly to share the info in written form too. Note that the idea is to introduce the concepts and show some basic examples for cds REPL &quot;initiates&quot;. Nothing too exotic.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="Level up your CAP skills by learning how to use the cds REPL">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="These are notes I wrote for my talk at SAP Inside Track Madrid on 20 March 2025. I wrote them partly to think about what I wanted to say, and partly to share the info in written form too. Note that the idea is to introduce the concepts and show some basic examples for cds REPL &quot;initiates&quot;. Nothing too exotic.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/03/21/level-up-your-cap-skills-by-learning-how-to-use-the-cds-repl/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="level-up-your-cap-skills-by-learning-how-to-use-the-cds-repl">Level up your CAP skills by learning how to use the cds REPL</h1>

<ul class="post-metadata">
	<li><time datetime="2025-03-21">21 March 2025</time></li>
	<li><a href="/tags/talk/" class="post-tag">talk</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/repl/" class="post-tag">repl</a></li>
</ul>

<p class="post-description-main">These are notes I wrote for my talk at SAP Inside Track Madrid on 20 March 2025. I wrote them partly to think about what I wanted to say, and partly to share the info in written form too. Note that the idea is to introduce the concepts and show some basic examples for cds REPL "initiates". Nothing too exotic.</p>

<p><em>Update July 2025: I've made a few updates to this post to reflect some changes in the cds REPL that were brought in to tighten up query resolution and execution.</em></p>
<p>Here's the talk abstract: &quot;The cds repl (REPL stands for Read Evaluate Print Loop) is an extremely powerful and versatile tool for every CAP Node.js developer. In this session, you'll become acquainted with it, get a feel for what it's like, how to wield its powers, and more. No experience required, this will be a live session with no slides.&quot;</p>
<p>After some introductory material, there are four main parts to this post:</p>
<ul>
<li><a href="#part-1-starting-up">Part 1 - starting up</a></li>
<li><a href="#part-2-inspecting">Part 2 - inspecting</a></li>
<li><a href="#part-3-querying">Part 3 - querying</a></li>
<li><a href="#part-4-digging-deeper">Part 4 - digging deeper</a></li>
</ul>
<h2 id="what-a-repl-is">What a REPL is</h2>
<p>While in Capire the REPL is written as the &quot;cds repl&quot; I prefer to write REPL in upper case as it's an acronym, standing for <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">Read Evaluate Print Loop</a>, which describes exactly what it does:</p>
<ul>
<li>reads your input</li>
<li>evaluates it</li>
<li>prints the result</li>
<li>loops back to the start</li>
</ul>
<p>The history of REPLs goes back to the early Lisp days. A REPL is also very similar in nature to a command line shell which is why I like Bash so much, because the language which I use in the shell - and therefore how I think when constructing expressions - is exactly the same language that I use to write scripts.</p>
<p>A REPL is the perfect environment for interactive explorations and experimentation, which is why it's so great to have a REPL in CAP - specifically right now for CAP Node.js.</p>
<h2 id="follow-along">Follow along</h2>
<p>You can follow along with all the examples here in a container, so you don't have to install anything locally or clean up afterwards. The <a href="https://github.com/qmacro/cap-con-img">qmacro/cap-con-img</a> repo contains definitions for a base image and CAP Node.js version specific images. Assuming you have Docker Desktop (or equivalent runtime) installed, along with <code>git</code> and a standard shell (<code>bash</code>), and can run the <code>docker</code> client CLI, you can do what I did to set things up for this talk and set of notes, which is:</p>
<ul>
<li><code>git clone https://github.com/qmacro/cap-con-img &amp;&amp; cd cap-con-img</code></li>
<li><code>./buildbase &amp;&amp; ./buildver 8.8.1</code></li>
<li><code>docker run -it --name cds-repl-talk cap-8.8.1 bash</code></li>
</ul>
<blockquote>
<p>You can also specify <code>latest</code> instead of a specific CAP version.</p>
</blockquote>
<p>and then within the container (where you should have a prompt like this <code>node ➜ ~</code>) you can clone the CAP samples repo (actually this next part is <a href="https://github.com/qmacro/cap-con-img/commit/fc8baa3c39563b55b58b3b5c99d62f1c0056b622">now automatically performed in the <code>buildver</code> part</a>):</p>
<ul>
<li><code>git clone https://github.com/SAP-samples/cloud-cap-samples samples</code></li>
<li><code>cd samples &amp;&amp; npm ci</code></li>
</ul>
<blockquote>
<p><code>ci</code> is a &quot;clean&quot; version of install, see <a href="https://stackoverflow.com/a/53325242/384366">this SO answer</a> for more details.</p>
</blockquote>
<p>then you're ready to start up the cds REPL within the container:</p>
<ul>
<li><code>cds repl</code></li>
</ul>
<p>(If you want a further example of trying things out in a container context, see the <a href="https://qmacro.org/blog/posts/2024/12/10/tasc-notes-part-4/#appendix1">appendix on setting up a test environment</a> in the notes to The Art and Science of CAP part 4.)</p>
<p>Unless otherwise stated, all the following cds REPL session examples (identified by the <code>&gt;</code> prompt, as opposed to the <code>$</code> shell prompt) are based on this scenario setup.</p>
<h2 id="an-introduction">An introduction</h2>
<p>The CAP Node.js REPL is essentially an extension of the <a href="https://nodejs.org/api/repl.html">standard Node.js REPL</a>.</p>
<p>Compare:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">node</span>
Welcome to Node.js v22.12.0.
Type <span class="token string">".help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information.
<span class="token operator">></span> .help
.break   Sometimes you get stuck, this gets you out
.clear   Alias <span class="token keyword">for</span> .break
.exit    Exit the REPL
.help    Print this <span class="token builtin class-name">help</span> message
.load    Load JS from a <span class="token function">file</span> into the REPL session
.save    Save all evaluated commands <span class="token keyword">in</span> this REPL session to a <span class="token function">file</span></code></pre>
<p>with:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds repl
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.8</span>.1
<span class="token operator">></span> .help
.break     Sometimes you get stuck, this gets you out
.clear     Alias <span class="token keyword">for</span> .break
.editor    Enter editor mode
.exit      Exit the REPL
.help      Print this <span class="token builtin class-name">help</span> message
.inspect   Sets options <span class="token keyword">for</span> util.inspect, e.g. <span class="token variable"><span class="token variable">`</span>.inspect .depth<span class="token operator">=</span><span class="token number">1</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span>
.load      Load JS from a <span class="token function">file</span> into the REPL session
.run       Runs a cds server from a given CAP project folder, or module name like @capire/bookshop.
.save      Save all evaluated commands <span class="token keyword">in</span> this REPL session to a <span class="token function">file</span></code></pre>
<p>In addition to the <a href="https://nodejs.org/docs/latest/api/repl.html#commands-and-special-keys">standard Node.js REPL commands</a><a href="#footnote-1"><sup>1</sup></a>, the cds REPL adds these two:</p>
<ul>
<li><code>.inspect</code>: comfortably view structured objects at varying depths</li>
<li><code>.run</code>: start a CAP server based on the definitions given in the location specified</li>
</ul>
<p>In fact, the facility provided by the <code>.run</code> command is also available at invocation time via the <code>--run</code> option, as we can see from the help:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds repl <span class="token parameter variable">--help</span>
SYNOPSIS

    cds repl <span class="token punctuation">[</span> <span class="token operator">&lt;</span>options<span class="token operator">></span> <span class="token punctuation">]</span>

    Launches into a read-eval-print-loop, an interactive playground to
    experiment with cds<span class="token string">' JavaScript APIs. See documentation of Node.js'</span>
    REPL <span class="token keyword">for</span> details at http://nodejs.org/api/repl.html

OPTIONS

    <span class="token parameter variable">-r</span> <span class="token operator">|</span> <span class="token parameter variable">--run</span> <span class="token operator">&lt;</span>project<span class="token operator">></span>

      Runs a cds server from a given CAP project folder, or module name.
      You can <span class="token keyword">then</span> access the entities and services of the running server.
      It<span class="token string">'s the same as using the repl'</span>s <span class="token builtin class-name">builtin</span> .run command.

    <span class="token parameter variable">-u</span> <span class="token operator">|</span> <span class="token parameter variable">--use</span> <span class="token operator">&lt;</span>cds feature<span class="token operator">></span>

      Loads the given cds feature into the repl<span class="token string">'s global context. For example,
      if you specify xl it makes the cds.xl module'</span>s methods available.
      It's the same as doing <span class="token punctuation">{</span>ref,val,xpr,<span class="token punctuation">..</span>.<span class="token punctuation">}</span> <span class="token operator">=</span> cds.xl within the repl.

EXAMPLES

    cds repl <span class="token parameter variable">--run</span> bookshop
    cds repl <span class="token parameter variable">--run</span> <span class="token builtin class-name">.</span>
    cds repl <span class="token parameter variable">--use</span> cds.ql

SEE ALSO

    cds <span class="token builtin class-name">eval</span>  to evaluate and execute JavaScript.</code></pre>
<blockquote>
<p>Due to lack of time, we won't be looking at the <code>--use</code> option in this talk. Maybe next time!</p>
</blockquote>
<h2 id="part-1-starting-up">Part 1 - starting up</h2>
<p>The biggest benefit of a cds REPL is being able to explore the entire API as well as start up &amp; interact with a live, running CAP server. And remember that being a Node.js REPL at heart, you can use any and every JavaScript expression and construct, as well as some special CAP specific features.</p>
<h3 id="using-cds-test">Using cds.test()</h3>
<p>Before the advent of the <code>--run</code> option, we could use the <a href="https://cap.cloud.sap/docs/node.js/cds-test#cds-test">cds.test()</a> method:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> cds.test<span class="token punctuation">(</span><span class="token string">'bookshop'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>ref *<span class="token operator"><span class="token file-descriptor important">1</span>></span> Test <span class="token punctuation">{</span> test: <span class="token punctuation">[</span>Circular *1<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token operator">></span> <span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">5</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:

  bookshop/srv/user-service.cds
  bookshop/srv/cat-service.cds
  bookshop/srv/admin-service.cds
  bookshop/db/schema.cds
  node_modules/@sap/cds/common.cds

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - connect to db <span class="token operator">></span> sqlite <span class="token punctuation">{</span> url: <span class="token string">':memory:'</span> <span class="token punctuation">}</span>
  <span class="token operator">></span> init from bookshop/db/init.js
  <span class="token operator">></span> init from bookshop/db/data/sap.capire.bookshop-Genres.csv
  <span class="token operator">></span> init from bookshop/db/data/sap.capire.bookshop-Books.texts.csv
  <span class="token operator">></span> init from bookshop/db/data/sap.capire.bookshop-Books.csv
  <span class="token operator">></span> init from bookshop/db/data/sap.capire.bookshop-Authors.csv
/<span class="token operator">></span> successfully deployed to in-memory database.

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - using auth strategy <span class="token punctuation">{</span>
  kind: <span class="token string">'mocked'</span>,
  impl: <span class="token string">'node_modules/@sap/cds/lib/srv/middlewares/auth/basic-auth'</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - using new OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving AdminService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/admin-service.js'</span>, path: <span class="token string">'/admin'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving CatalogService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/cat-service.js'</span>, path: <span class="token string">'/browse'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving UserService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/user-service.js'</span>, path: <span class="token string">'/user'</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - server listening on <span class="token punctuation">{</span> url: <span class="token string">'http://localhost:34851'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - server launched in: <span class="token number">2</span>.778s
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - <span class="token punctuation">[</span> terminate with ^C <span class="token punctuation">]</span></code></pre>
<p>As you can see, this starts a CAP server based on the definitions in the <code>bookshop</code> directory. Note that the port is not 4004 as one might normally expect; this is partly because we're in &quot;test&quot; mode and want to avoid clashing with any regular CAP server already running on the same host. This is true for CAP servers started up in the cds REPL in general.</p>
<h3 id="using-the-run-command">Using the .run command</h3>
<p>It was in the lifetime and growth of the CAP Node.js 8 release that the two extra cds REPL commands <code>.inspect</code> &amp; <code>.run</code> and the command line options <code>--run</code> &amp; <code>--use</code> <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#new-cds-repl-options">were introduced</a>, proudly during the course of the <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">The Art and Science of CAP</a> series.</p>
<p>In particular, the equivalent of <code>cds.test('bookshop')</code> became:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .run bookshop</code></pre>
<p>which not only was less cryptic but did the same thing as far as start up a CAP server (with output as shown already) but also made various variables available in the cds REPL that are useful to us in that context; here's the extra output from <code>.run bookshop</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token separator comment">------------------------------------------------------------------------</span>
Following variables are made available in your repl's global context<span class="token operator">:</span>

<span class="token property">from cds.entities:</span> <span class="token operator">{</span>
  Books<span class="token punctuation">,</span>
  Authors<span class="token punctuation">,</span>
  Genres<span class="token punctuation">,</span>
<span class="token operator">}</span>

<span class="token property">from cds.services:</span> <span class="token operator">{</span>
  db<span class="token punctuation">,</span>
  AdminService<span class="token punctuation">,</span>
  CatalogService<span class="token punctuation">,</span>
  UserService<span class="token punctuation">,</span>
<span class="token operator">}</span>

Simply type e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> UserService in the prompt to use the respective objects<span class="token punctuation">.</span></code></pre>
<p>The entities and services defined in the specified directory are identified and exposed to us. Note that along with <code>AdminService</code>, <code>CatalogService</code> and <code>UserService</code>, all defined <a href="https://github.com/SAP-samples/cloud-cap-samples/tree/main/bookshop/srv">as services in the bookshop project</a>, there's also <code>db</code>. Yes, that's a service too, and one we can examine, modify and influence as readily as our own services, should we so desire. In CAP, <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#everything-is-a-service">everything is a service</a>. (The <code>db</code> service is a <code>SQLiteService</code> as we'll see <a href="#entities-and-services">later</a>.</p>
<h3 id="using-the-run-option">Using the --run option</h3>
<p>As the help text for <code>cds repl</code> already has shown us, there's also:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds repl <span class="token parameter variable">--run</span> bookshop</code></pre>
<p>which does the same thing as using <code>.run bookshop</code> at the cds REPL prompt.</p>
<p>The <code>.run</code> command and the <code>--run</code> option use <code>cds.test()</code> behind the scenes, and both are <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#the-run-command">cap-monorepo-aware</a>.</p>
<h2 id="part-2-inspecting">Part 2 - inspecting</h2>
<p>At this point, as well as the automatically exposed entity and service variables, we also have access to certain key objects, such as <code>cds</code>, known as the main <a href="https://cap.cloud.sap/docs/node.js/cds-facade">façade object</a> and which provides access to all CAP Node.js APIs. Just what we need!</p>
<h3 id="the-cds-facade-object">The cds façade object</h3>
<p>The <code>cds</code> object is mostly <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#lazy-loading-of-the-cds-facades-many-features">lazily loaded</a>. You can see this by immediately looking at it once you've started the cds REPL (without any <code>--run</code> option), like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds repl
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.8</span>.1
<span class="token operator">></span> cds
cds <span class="token punctuation">{</span>
  _events: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  _eventsCount: <span class="token number">0</span>,
  _maxListeners: undefined,
  model: undefined,
  db: undefined,
  cli: <span class="token punctuation">{</span> command: <span class="token string">'repl'</span>, argv: <span class="token punctuation">[</span><span class="token punctuation">]</span>, options: <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>,
  root: <span class="token string">'/home/node/samples'</span>,
  services: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  extend: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>,
  version: <span class="token string">'8.8.1'</span>,
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>shapeMode<span class="token punctuation">)</span><span class="token punctuation">]</span>: false,
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>kCapture<span class="token punctuation">)</span><span class="token punctuation">]</span>: <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p>As you can see, the <code>cds</code> object is always automatically available in the cds REPL. But owing to the lazy loading technique, it starts out small and lean, and only grows when required and appropriate.</p>
<p>For example, the runtime environment represented by <code>cds.env</code> has not yet appeared. But we can ask to see it by entering <code>cds.env</code> at the cds REPL prompt, causing it to be reified there and then, showing a gigantic sub-object from which only this last bit is shown here:</p>
<pre class="language-text" tabindex="0"><code class="language-text">{
  ...,
  sql: { names: 'plain', dialect: 'sqlite' },
  hana: { 'deploy-format': 'hdbtable', journal: { 'change-mode': 'alter' } },
  build: { target: 'gen' },
  mtx: {
    api: { model: true, provisioning: true, metadata: true, diagnose: true },
    domain: '__default__'
  },
  cdsc: { moduleLookupDirectories: [ 'node_modules/' ] },
  query: { limit: { max: 1000 } },
  plugins: {
    '@sap/cds-fiori': {
      impl: '/home/node/samples/node_modules/@sap/cds-fiori/cds-plugin.js',
      packageJson: '/home/node/samples/node_modules/@sap/cds-fiori/package.json'
    },
    '@cap-js/sqlite': {
      impl: '/home/node/samples/node_modules/@cap-js/sqlite/cds-plugin.js',
      packageJson: '/home/node/samples/node_modules/@cap-js/sqlite/package.json'
    }
  },
  config: { log: { format: 'plain' } }
}</code></pre>
<p>That's a lot of information. Far more than we can comfortably and conveniently deal with directly. And not only is <code>cds.env</code> large, but that has now made the façade object large too.</p>
<p>We can of course use standard JavaScript techniques to examine things further, for example:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> Object.keys<span class="token punctuation">(</span>cds.env<span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token string">'_context'</span>,       <span class="token string">'_home'</span>,
  <span class="token string">'_sources'</span>,       <span class="token string">'_profiles'</span>,
  <span class="token string">'_better_sqlite'</span>, <span class="token string">'production'</span>,
  <span class="token string">'requires'</span>,       <span class="token string">'server'</span>,
  <span class="token string">'protocols'</span>,      <span class="token string">'features'</span>,
  <span class="token string">'fiori'</span>,          <span class="token string">'ql'</span>,
  <span class="token string">'log'</span>,            <span class="token string">'folders'</span>,
  <span class="token string">'i18n'</span>,           <span class="token string">'odata'</span>,
  <span class="token string">'sql'</span>,            <span class="token string">'hana'</span>,
  <span class="token string">'build'</span>,          <span class="token string">'mtx'</span>,
  <span class="token string">'cdsc'</span>,           <span class="token string">'query'</span>,
  <span class="token string">'plugins'</span>,        <span class="token string">'config'</span>
<span class="token punctuation">]</span></code></pre>
<p>Further, we can access different elements of the individual areas by the dotted notation simply like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> cds.env.plugins
<span class="token punctuation">{</span>
  <span class="token string">'@sap/cds-fiori'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    impl: <span class="token string">'/home/node/samples/node_modules/@sap/cds-fiori/cds-plugin.js'</span>,
    packageJson: <span class="token string">'/home/node/samples/node_modules/@sap/cds-fiori/package.json'</span>
  <span class="token punctuation">}</span>,
  <span class="token string">'@cap-js/sqlite'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    impl: <span class="token string">'/home/node/samples/node_modules/@cap-js/sqlite/cds-plugin.js'</span>,
    packageJson: <span class="token string">'/home/node/samples/node_modules/@cap-js/sqlite/package.json'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>If you're interested to know why entries already exist even at this early stage, you might want to take a look at <a href="/blog/posts/2024/12/30/cap-node.js-plugins/">CAP Node.js Plugins</a>.</p>
</blockquote>
<p>That said, we also have the other cds REPL specific command <code>.inspect</code>. Using this command directly will show us everything, as above. But we can add the <code>.depth</code> option like this to reduce the volume of output:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect cds.env .depth<span class="token operator">=</span><span class="token number">0</span>

cds.env: Config <span class="token punctuation">{</span>
  _context: <span class="token string">'cds'</span>,
  _home: <span class="token string">'/home/node/samples'</span>,
  _sources: <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  _profiles: <span class="token punctuation">[</span>Set<span class="token punctuation">]</span>,
  _better_sqlite: <span class="token punctuation">[</span>Getter<span class="token punctuation">]</span>,
  production: false,
  requires: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  server: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  protocols: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  features: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  fiori: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  ql: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  log: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  folders: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  i18n: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  odata: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  sql: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  hana: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  build: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  mtx: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  cdsc: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  query: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  plugins: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  config: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p><code>0</code> represents the lowest amount of information, whereas <code>11</code> represents the highest, and is the default. I'd like to think that this was a nod to <a href="https://www.youtube.com/watch?v=4xgx4k83zzc">Spinal Tap</a> but I suspect it's just another <a href="https://www.google.com/search?q=site%3Aqmacro.org+%23tasc+schnapszahlen">Schnapszahl</a>.</p>
</blockquote>
<h3 id="entities-and-services">Entities and services</h3>
<p>But what about those entities and services? Well, let's have a look. As we can discern from the output of <code>.inspect cds.env .depth=0</code> above, there's no top-level <code>cds.entities</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> cds.entities
<span class="token operator">></span></code></pre>
<p>That's because we haven't yet started the CAP server, at least in this current cds REPL session. So let's do that now:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .run bookshop
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">5</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:

<span class="token punctuation">..</span>.

from cds.entities: <span class="token punctuation">{</span>
  Books,
  Authors,
  Genres,
<span class="token punctuation">}</span>

from cds.services: <span class="token punctuation">{</span>
  db,
  AdminService,
  CatalogService,
  UserService,
<span class="token punctuation">}</span>

<span class="token punctuation">..</span>.</code></pre>
<p>And the <a href="#the-cds-facade-object">cds façade object</a> has now grown, sporting new top level keys:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> Object.keys<span class="token punctuation">(</span>cds<span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token string">'_events'</span>,            <span class="token string">'_eventsCount'</span>, <span class="token string">'_maxListeners'</span>,
  <span class="token string">'model'</span>,              <span class="token string">'db'</span>,           <span class="token string">'cli'</span>,
  <span class="token string">'root'</span>,               <span class="token string">'services'</span>,     <span class="token string">'extend'</span>,
  <span class="token string">'version'</span>,            <span class="token string">'parse'</span>,        <span class="token string">'home'</span>,
  <span class="token string">'env'</span>,                <span class="token string">'server'</span>,       <span class="token string">'ql'</span>,
  <span class="token string">'test'</span>,               <span class="token string">'utils'</span>,        <span class="token string">'exec'</span>,
  <span class="token string">'options'</span>,            <span class="token string">'requires'</span>,     <span class="token string">'log'</span>,
  <span class="token string">'debug'</span>,              <span class="token string">'plugins'</span>,      <span class="token string">'app'</span>,
  <span class="token string">'load'</span>,               <span class="token string">'resolve'</span>,      <span class="token string">'get'</span>,
  <span class="token string">'compile'</span>,            <span class="token string">'edmxs'</span>,        <span class="token string">'minify'</span>,
  <span class="token string">'builtin'</span>,            <span class="token string">'type'</span>,         <span class="token string">'linked'</span>,
  <span class="token string">'entity'</span>,             <span class="token string">'connect'</span>,      <span class="token string">'service'</span>,
  <span class="token string">'Event'</span>,              <span class="token string">'Request'</span>,      <span class="token string">'error'</span>,
  <span class="token string">'Service'</span>,            <span class="token string">'compiler'</span>,     <span class="token string">'deploy'</span>,
  <span class="token string">'_context'</span>,           <span class="token string">'infer'</span>,        <span class="token string">'serve'</span>,
  <span class="token string">'ApplicationService'</span>, <span class="token string">'i18n'</span>,         <span class="token string">'EventContext'</span>,
  <span class="token string">'User'</span>,               <span class="token string">'middlewares'</span>,  <span class="token string">'shutdown'</span>
<span class="token punctuation">]</span></code></pre>
<p>This list includes both <code>entities</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect cds.entities .depth<span class="token operator">=</span><span class="token number">0</span>

cds.entities: <span class="token punctuation">[</span>Function: children<span class="token punctuation">]</span> LinkedDefinitions <span class="token punctuation">{</span>
  Books: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  Authors: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  Genres: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  <span class="token string">'Books.texts'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  <span class="token string">'Genres.texts'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>and <code>services</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect cds.services .depth<span class="token operator">=</span><span class="token number">0</span>

cds.services: <span class="token punctuation">{</span>
  db: <span class="token punctuation">[</span>SQLiteService<span class="token punctuation">]</span>,
  AdminService: <span class="token punctuation">[</span>AdminService<span class="token punctuation">]</span>,
  CatalogService: <span class="token punctuation">[</span>CatalogService<span class="token punctuation">]</span>,
  UserService: <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Notice how these lists tie up directly with what is emitted in the output from <code>.run</code> earlier.</p>
<p>Instead of having to specify a depth each time we use <code>.inspect</code>, we can set it for subsequent invocations in this cds REPL session, like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">0</span>

 updated node:util.inspect.defaultOptions with: <span class="token punctuation">{</span> depth: <span class="token number">0</span> <span class="token punctuation">}</span></code></pre>
<p>Exploring <code>cds.entities</code> is a good example of where <code>.inspect</code> gives us a nicer experience than plain JavaScript techniques.</p>
<p>We can get hold of an entity, say, <code>Books</code>, either directly if we know what it is<a href="#footnote-2"><sup>2</sup></a> (as <code>cds.entities.Books</code>) or by more generally working with <code>cds.entities</code> which is a <a href="https://cap.cloud.sap/docs/node.js/cds-reflect#iterable">LinkedDefinitions</a> class.</p>
<p>This is an <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols#the_iterable_protocol">iterable</a>, which means that simply asking for everything will produce something a little underwhelming:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> cds.entities
<span class="token punctuation">[</span>object Function<span class="token punctuation">]</span></code></pre>
<p>Contrast this with:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect cds.entities .depth<span class="token operator">=</span><span class="token number">0</span>

cds.entities: <span class="token punctuation">[</span>Function: children<span class="token punctuation">]</span> LinkedDefinitions <span class="token punctuation">{</span>
  Books: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  Authors: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  Genres: <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  <span class="token string">'Books.texts'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>,
  <span class="token string">'Genres.texts'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>entity<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>But even with plain JavaScript access is possible in different ways. There's destructuring:</p>
<ul>
<li><code>{ Books } = cds.entities</code></li>
<li><code>{ Books: mybooks } = cds.entities</code> (with new variable name assignment)</li>
</ul>
<p>There's also the pair of statements that can be used to operate on iterables:</p>
<p><code>for ... in</code> iterates through the keys:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> <span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token keyword">in</span> cds.entities<span class="token punctuation">)</span> <span class="token punctuation">{</span> console.log<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span>
Books
Authors
Genres
Books.texts
Genres.texts</code></pre>
<p>whereas <code>for ... of</code> gives access to the values:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> <span class="token keyword">for</span> <span class="token punctuation">(</span>e of cds.entities<span class="token punctuation">)</span> <span class="token punctuation">{</span> console.log<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span>
entity <span class="token punctuation">{</span>
  kind: <span class="token string">'entity'</span>,
  includes: <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  elements: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span>,
  <span class="token string">'$localized'</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
entity <span class="token punctuation">{</span>
  kind: <span class="token string">'entity'</span>,
  includes: <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  elements: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
entity <span class="token punctuation">{</span>
  kind: <span class="token string">'entity'</span>,
  <span class="token string">'@cds.autoexpose'</span><span class="token builtin class-name">:</span> true,
  <span class="token string">'@cds.persistence.skip'</span><span class="token builtin class-name">:</span> <span class="token string">'if-unused'</span>,
  <span class="token string">'@UI.Identification'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  <span class="token string">'@cds.odata.valuelist'</span><span class="token builtin class-name">:</span> true,
  includes: <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  elements: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span>,
  <span class="token string">'$localized'</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token punctuation">..</span>.</code></pre>
<p>But often it's just easiest to use the convenience variables exposed by the &quot;run&quot; affordance, such as <code>Books</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> Books
entity <span class="token punctuation">{</span>
  kind: <span class="token string">'entity'</span>,
  includes: <span class="token punctuation">[</span> <span class="token string">'managed'</span> <span class="token punctuation">]</span>,
  elements: LinkedDefinitions <span class="token punctuation">{</span>
    createdAt: Timestamp <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$now'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Core.Immutable'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedAt}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      type: <span class="token string">'cds.Timestamp'</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedAt}'</span>
    <span class="token punctuation">}</span>,
    createdBy: String <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$user'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Core.Immutable'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedBy}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>,
      type: <span class="token string">'cds.String'</span>,
      length: <span class="token number">255</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedBy}'</span>,
      <span class="token string">'@Core.Description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">..</span>.
<span class="token punctuation">}</span></code></pre>
<p>And what of the services - what can we see there? Well, for a start, how about:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect CatalogService

CatalogService: CatalogService <span class="token punctuation">{</span>
  name: <span class="token string">'CatalogService'</span>,
  options: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  model: <span class="token punctuation">[</span>LinkedCSN<span class="token punctuation">]</span>,
  handlers: <span class="token punctuation">[</span>EventHandlers<span class="token punctuation">]</span>,
  definition: <span class="token punctuation">[</span>service<span class="token punctuation">]</span>,
  namespace: <span class="token string">'CatalogService'</span>,
  actions: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span>,
  submitOrder: <span class="token punctuation">[</span>Function: CatalogService.submitOrder<span class="token punctuation">]</span>,
  entities: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span>,
  _source: <span class="token string">'/home/node/samples/bookshop/srv/cat-service.js'</span>,
  endpoints: <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>,
  _adapters: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
  path: <span class="token string">'/browse'</span>,
  <span class="token string">'$linkProviders'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>We can dig into those properties too. The <code>handlers</code> are of particular interest, and thanks to <a href="/blog/posts/2024/12/20/tasc-notes-part-6/#improved-display-of-service-handlers">a recent improvement on the display of those handlers</a> we have a convenient way of neatly visualising what's set up:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect CatalogService.handlers .depth<span class="token operator">=</span><span class="token number">2</span>

CatalogService.handlers: EventHandlers <span class="token punctuation">{</span>
  _initial: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: noah_handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: check_roles<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'CREATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: commonGenericInput<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: commonGenericInput<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      before: <span class="token string">'submitOrder'</span>,
      handler: <span class="token punctuation">[</span>Function: _actionFunctionHandler<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>Function: commonGenericPut<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>Function: commonGenericTemporal<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: commonGenericPaging<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>Function: commonGenericSorting<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'NEW'</span>, handler: <span class="token punctuation">[</span>Function: fn<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  before: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> before: <span class="token string">'PATCH'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: addContentType<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: addContentType<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  on: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> on: <span class="token string">'submitOrder'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'NEW'</span>, handler: <span class="token punctuation">[</span>Function: fn<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'EDIT'</span>, handler: <span class="token punctuation">[</span>Function: fn<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'CANCEL'</span>, handler: <span class="token punctuation">[</span>Function: fn<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'draftPrepare'</span>, handler: <span class="token punctuation">[</span>Function: fn<span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'CREATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'DELETE'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> on: <span class="token string">'UPSERT'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  after: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      after: <span class="token string">'READ'</span>,
      path: <span class="token string">'CatalogService.ListOfBooks'</span>,
      handler: <span class="token punctuation">[</span>Function: handler<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> after: <span class="token string">'submitOrder'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> after: <span class="token string">'READ'</span>, handler: <span class="token punctuation">[</span>AsyncFunction <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  _error: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>There's plenty to explore; here are just a couple of observations:</p>
<ul>
<li>there's an entry in the <code>on</code> phase for <code>submitOrder</code>, <a href="https://github.com/SAP-samples/cloud-cap-samples/blob/main/bookshop/srv/cat-service.js">defined as an event</a> for an OData action</li>
<li>there are built-in handlers for all the standard OData operations such as CREATE, READ, UPDATE, DELETE and so on</li>
</ul>
<h2 id="part-3-querying">Part 3 - querying</h2>
<p>These basic artifacts are interesting on their own but can already be combined in useful ways.</p>
<p>For example, we can use the <a href="https://cap.cloud.sap/docs/node.js/core-services#crud-style-api">CRUD-style API</a> with the services available to us directly, referring to the entities that are also available to us:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> CatalogService.read<span class="token punctuation">(</span>Books<span class="token punctuation">)</span>
cds.ql <span class="token punctuation">{</span> SELECT: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span></code></pre>
<p>OK, so what's emitted here is not that exciting. Partly because our inspection depth is currently set to <code>0</code>, and partly because API operations like this are asynchronous (promises) and we need to <code>await</code> them to see the results.</p>
<p>Let's deal with these one at a time, mostly because even seeing the pre-executed query in more detail is worthwhile:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">3</span>

 updated node:util.inspect.defaultOptions with: <span class="token punctuation">{</span> depth: <span class="token number">3</span> <span class="token punctuation">}</span>

<span class="token operator">></span> CatalogService.read<span class="token punctuation">(</span>Books<span class="token punctuation">)</span>
cds.ql <span class="token punctuation">{</span>
  SELECT: <span class="token punctuation">{</span> from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'sap.capire.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>At this point we're probably keen to move from the metadata to the data, so let's just dive in for a bit of relief.</p>
<p>Just before we do, though, let's consider what <code>Books</code> represents here - the &quot;base layer&quot; definition (in <a href="https://github.com/SAP-samples/cloud-cap-samples/blob/1ff53edf858f13320d4653e91f61f0991f1bae17/bookshop/db/schema.cds#L2-L14"><code>cloud-cap-samples/bookshop/db/schema.cds</code></a>):</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">namespace</span> sap.capire.bookshop;

<span class="token keyword">entity</span> Books : managed {
  <span class="token single-line-comment comment">// ...</span>
}</code></pre>
<p>We can see this representation reflected in the &quot;from: ref:&quot; value <code>sap.capire.bookshop.Books</code> in the query.</p>
<p>So when we want to resolve the query, we should use the base <code>db</code> service, rather than go through the <code>CatalogService</code> service - which we've merely used here as a way to avail ourselves of the CRUD-style API calls.</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await db.run<span class="token punctuation">(</span>CatalogService.read<span class="token punctuation">(</span>Books<span class="token punctuation">))</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    createdAt: <span class="token string">'2025-03-18T05:38:55.530Z'</span>,
    createdBy: <span class="token string">'anonymous'</span>,
    modifiedAt: <span class="token string">'2025-03-18T05:38:55.530Z'</span>,
    modifiedBy: <span class="token string">'anonymous'</span>,
    ID: <span class="token number">201</span>,
    title: <span class="token string">'Wuthering Heights'</span>,
    descr: <span class="token variable"><span class="token variable">`</span>Wuthering Heights, Emily Brontë's only novel, was published <span class="token punctuation">..</span>.<span class="token variable">`</span></span>,
    author_ID: <span class="token number">101</span>,
    genre_ID: <span class="token number">11</span>,
    stock: <span class="token number">12</span>,
    price: <span class="token number">11.11</span>,
    currency_code: <span class="token string">'GBP'</span>
  <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span>
    createdAt: <span class="token string">'2025-03-18T05:38:55.530Z'</span>,
    createdBy: <span class="token string">'anonymous'</span>,
    modifiedAt: <span class="token string">'2025-03-18T05:38:55.530Z'</span>,
    modifiedBy: <span class="token string">'anonymous'</span>,
    ID: <span class="token number">207</span>,
    title: <span class="token string">'Jane Eyre'</span>,
    descr: <span class="token variable"><span class="token variable">`</span>Jane Eyre /ɛər/ <span class="token punctuation">(</span>originally published as Jane Eyre: An Autobiography<span class="token punctuation">)</span> is <span class="token punctuation">..</span>.<span class="token variable">`</span></span>,
    author_ID: <span class="token number">107</span>,
    genre_ID: <span class="token number">11</span>,
    stock: <span class="token number">11</span>,
    price: <span class="token number">12.34</span>,
    currency_code: <span class="token string">'GBP'</span>
  <span class="token punctuation">}</span>,
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span></code></pre>
<p>We can of course qualify that query, and to explore the different ways we can construct query objects, we'll use the fluent API style this time that <code>cds.ql</code> makes available for us.</p>
<p>For example let's check who the authors are, supplying a <a href="https://cap.cloud.sap/docs/cds/cql">CQL</a> expression in a template string:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT ID, name FROM Authors<span class="token variable">`</span></span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID: <span class="token number">101</span>, name: <span class="token string">'Emily Brontë'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">107</span>, name: <span class="token string">'Charlotte Brontë'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">150</span>, name: <span class="token string">'Edgar Allen Poe'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">170</span>, name: <span class="token string">'Richard Carpenter'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Here's another example:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT title, stock FROM Books<span class="token variable">`</span></span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> title: <span class="token string">'Wuthering Heights'</span>, stock: <span class="token number">12</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Jane Eyre'</span>, stock: <span class="token number">11</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'The Raven'</span>, stock: <span class="token number">333</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Eleonora'</span>, stock: <span class="token number">555</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Catweazle'</span>, stock: <span class="token number">22</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Now we see that there's a large variance in book stock, we can start to build a query to explore that. But first, let's increment the inspection depth as the query that we'll be constructing (or, more precisely, having the API construct for us) will be a little deeper, specifically when it comes to showing <code>columns</code> information:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect .depth<span class="token operator">=</span><span class="token number">4</span>

 updated node:util.inspect.defaultOptions with: <span class="token punctuation">{</span> depth: <span class="token number">4</span> <span class="token punctuation">}</span></code></pre>
<p>Let's go back to the CRUD-style API, and this time use the context of the <code>CatalogService</code> service directly; but for this, we first must get a handle on that service's &quot;view&quot; of the <code>Books</code> entity. We'll do that with a bit of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring#binding_and_assignment">destructuring with the assignment pattern</a>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> <span class="token punctuation">{</span> Books: catbooks <span class="token punctuation">}</span> <span class="token operator">=</span> CatalogService.entities</code></pre>
<p>OK, here goes. Let's define a basic &quot;book titles&quot; query, treating it as what it is - a first class citizen, assignable to a variable (and able to be passed around to and from functions as well):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> booktitles <span class="token operator">=</span> CatalogService.read<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span>.from<span class="token punctuation">(</span>catbooks<span class="token punctuation">)</span>
cds.ql <span class="token punctuation">{</span>
  SELECT: <span class="token punctuation">{</span>
    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    columns: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'title'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>Take note of the different value for the &quot;from: ref:&quot; - this time it's <code>CatalogService.Books</code> rather than <code>sap.capire.bookshop.Books</code>.</p>
</blockquote>
<p>No trip to the persistence layer has been made yet, we have just defined a query object and stored it in the variable <code>booktitles</code>. Now that we have it in a variable, we can even extend it (note that this will mutate the original <code>booktitles</code> query too):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> overstocked <span class="token operator">=</span> booktitles.where<span class="token punctuation">(</span><span class="token punctuation">{</span>stock:<span class="token punctuation">{</span><span class="token string">'>'</span>:250<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
cds.ql <span class="token punctuation">{</span>
  SELECT: <span class="token punctuation">{</span>
    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    columns: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'title'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,
    where: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'stock'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token string">'>'</span>, <span class="token punctuation">{</span> val: <span class="token number">250</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>and of course then &quot;resolve&quot; the query:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await overstocked
<span class="token punctuation">[</span> <span class="token punctuation">{</span> title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> title: <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre>
<p>And of course, based on the philosophy that anything expressed in a query language is a &quot;query&quot;, we can perform write operations which would be OK to show in this &quot;querying&quot; section of the blog post :-)</p>
<p>Let's first try this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await CatalogService.update<span class="token punctuation">(</span>catbooks<span class="token punctuation">)</span>.set<span class="token punctuation">(</span><span class="token punctuation">{</span>price:4711<span class="token punctuation">}</span><span class="token punctuation">)</span>.where<span class="token punctuation">(</span><span class="token punctuation">{</span>title:<span class="token string">'Eleonora'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
Uncaught Error: ENTITY_IS_READ_ONLY
    at CatalogService.check_readonly <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/libx/_runtime/common/generic/auth/readOnly.js:10:61<span class="token punctuation">)</span>
    at CatalogService.handle <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/srv/srv-dispatch.js:44:53<span class="token punctuation">)</span>
    at process.processTicksAndRejections <span class="token punctuation">(</span>node:internal/process/task_queues:105:5<span class="token punctuation">)</span>
    at async REPL390:1:33 <span class="token punctuation">{</span>
  code: <span class="token number">405</span>,
  args: <span class="token punctuation">[</span> <span class="token string">'CatalogService.Books'</span> <span class="token punctuation">]</span>,
  numericSeverity: <span class="token number">4</span>
<span class="token punctuation">}</span></code></pre>
<p>Oops! But of course, we're going via the <code>CatalogService</code> service, which has <a href="https://github.com/SAP-samples/cloud-cap-samples/blob/1ff53edf858f13320d4653e91f61f0991f1bae17/bookshop/srv/cat-service.cds#L9">a <code>@readonly</code> annotation on the projection on <code>Books</code></a>. So in fact this error is a good thing, and the HTTP response code <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Status/405">405</a> that is available for when such an error is bubbled up to a consumer, is also spot on.</p>
<p>Let's avoid the <code>@readonly</code> restriction by going directly to the schema, i.e. the lower layer entity definition (because we can, here in the cds REPL; remember that consumers of your CAP app must go via the services that you expose):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await db.run<span class="token punctuation">(</span>CatalogService.update<span class="token punctuation">(</span>Books<span class="token punctuation">)</span>.set<span class="token punctuation">(</span><span class="token punctuation">{</span>price:4711<span class="token punctuation">}</span><span class="token punctuation">)</span>.where<span class="token punctuation">(</span><span class="token punctuation">{</span>title:<span class="token string">'Eleonora'</span><span class="token punctuation">}</span><span class="token punctuation">))</span>
<span class="token number">1</span></code></pre>
<blockquote>
<p>In case you're wondering, the <code>1</code> represents the number of rows affected by the query.</p>
</blockquote>
<p>This was a success, as we can see:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT title, price from Books<span class="token variable">`</span></span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> title: <span class="token string">'Wuthering Heights'</span>, price: <span class="token number">11.11</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Jane Eyre'</span>, price: <span class="token number">12.34</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'The Raven'</span>, price: <span class="token number">13.13</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Eleonora'</span>, price: <span class="token number">4711</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> title: <span class="token string">'Catweazle'</span>, price: <span class="token number">150</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<h2 id="part-4-digging-deeper">Part 4 - digging deeper</h2>
<p>Really, the cds REPL gives us a golden key to the &quot;staff entrance&quot; of the CAP machine, and we can effectively explore, extend and create however we wish.</p>
<p>Here are a couple of examples that give some indication of what's possible in the cds REPL, where, as we are starting to find out, we have all the building blocks at our disposal, and that <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#the-magic-is-that-there-is-no-magic">there is no magic</a>.</p>
<h3 id="dynamic-service-creation-and-use">Dynamic service creation and use</h3>
<p>Here we create a new service on the fly, define a handler for an <code>on</code> phase event, and then send a request that will trigger that:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> <span class="token punctuation">(</span>srv <span class="token operator">=</span> new cds.Service<span class="token punctuation">)</span>.on<span class="token punctuation">(</span><span class="token string">'hola-madrid'</span>, <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console.log<span class="token punctuation">(</span>arguments<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
ServiceProvider <span class="token punctuation">{</span>
  name: <span class="token string">'ServiceProvider'</span>,
  options: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  handlers: EventHandlers <span class="token punctuation">{</span>
    _initial: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    before: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    on: <span class="token punctuation">[</span> <span class="token punctuation">{</span> on: <span class="token string">'hola-madrid'</span>, handler: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,
    after: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    _error: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  definition: undefined
<span class="token punctuation">}</span>
<span class="token operator">></span> await srv.send<span class="token punctuation">(</span><span class="token string">'hola-madrid'</span>, <span class="token punctuation">{</span> hashtag: <span class="token string">'#TheFutureIsTerminal'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>Arguments<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token string">'0'</span><span class="token builtin class-name">:</span> Request <span class="token punctuation">{</span>
    method: <span class="token string">'hola-madrid'</span>,
    data: <span class="token punctuation">{</span> hashtag: <span class="token string">'#TheFutureIsTerminal'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">'1'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>AsyncFunction: next<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="remote-service-connection">Remote service connection</h3>
<p>As another example of what else is possible (pretty much anything), let's construct a connection definition to connect to a remote service and have queries sent to it too.</p>
<p>The service we'll connect to is a cut down version of the classic Northwind service, called (appropriately enough) <a href="https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze">Northbreeze</a>, with mainly product, category and supplier data<a href="#footnote-3"><sup>3</sup></a>.</p>
<p>Before we embark upon this, we need to do two things.</p>
<p>First, we need to add the Cloud SDK because CAP Node.js delegates the heavy lifting of remote connection management and use to that library.</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">node</span> ➜ ~/samples <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
$ <span class="token function">npm</span> <span class="token function">add</span> --no-fund @sap-cloud-sdk/http-client

added <span class="token number">53</span> packages, and audited <span class="token number">332</span> packages <span class="token keyword">in</span> 13s

found <span class="token number">0</span> vulnerabilities</code></pre>
<p>Next, we also need to make a temporary quick fix to the Winston logger that's used by the CAP Node.js runtime, as currently it can issue a rather extreme 'uncaughtException' which is allowed to filter up and cause problems<a href="#footnote-4"><sup>4</sup></a>.</p>
<p>With a light tap with a very precise stick, we can neutralise this issue by commenting out the offending line:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">sed</span> <span class="token punctuation">\</span>
  --regexp-extended <span class="token punctuation">\</span>
  --in-place <span class="token punctuation">\</span>
  <span class="token string">"s/(process.on\('uncaughtException'.+$)/\/\/ <span class="token entity" title="\1">\1</span> TEMP/"</span> <span class="token punctuation">\</span>
  node_modules/winston/lib/winston/exception-handler.js</code></pre>
<p>Now we can launch the cds REPL:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">node</span> ➜ ~/samples <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
$ cds repl
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.8</span>.1
<span class="token operator">></span></code></pre>
<p>With the <a href="https://cap.cloud.sap/docs/node.js/cds-connect#cds-connect-to">cds.connect.to</a> method we can connect to required services (remember the yin and yang of &quot;provided&quot; and &quot;required&quot; services), normally those that are defined in <code>package.json#cds.requires</code>.</p>
<p>But ... while we do have a required service defined, it's implicit to the design-time context we're in: the <code>db</code> service, using SQLite for persistence:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> .inspect cds.env.requires .depth<span class="token operator">=</span><span class="token number">1</span>

cds.env.requires: <span class="token punctuation">{</span>
  middlewares: true,
  auth: <span class="token punctuation">{</span>
    restrict_all_services: false,
    kind: <span class="token string">'mocked'</span>,
    users: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>,
    tenants: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  db: <span class="token punctuation">{</span> impl: <span class="token string">'@cap-js/sqlite'</span>, credentials: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>, kind: <span class="token string">'sqlite'</span> <span class="token punctuation">}</span>,
  depth: <span class="token number">2</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>This <code>db</code> requirement doesn't exist in a fresh cds REPL - it's here because we've started a CAP server with <code>.run bookshop</code>.</p>
</blockquote>
<p>Because of how <code>cds.connect.to</code> has been defined, we can define a service on the fly, <a href="/blog/posts/2024/12/20/tasc-notes-part-6/#providing-configuration-programmatically">programmatically</a>, supplying the requisite details.</p>
<p>Let's do that now, in a fresh cds REPL:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds repl
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.8</span>.1
<span class="token operator">></span> northbreeze <span class="token operator">=</span> await cds.connect.to<span class="token punctuation">(</span><span class="token string">'northbreeze'</span>, <span class="token punctuation">{</span>kind:<span class="token string">'odata'</span>,credentials:<span class="token punctuation">{</span>url:<span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
RemoteService <span class="token punctuation">{</span>
  name: <span class="token string">'northbreeze'</span>,
  options: <span class="token punctuation">{</span>
    kind: <span class="token string">'odata'</span>,
    impl: <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span>,
    external: true,
    credentials: <span class="token punctuation">{</span>
      url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  kind: <span class="token string">'odata'</span>,
  handlers: EventHandlers <span class="token punctuation">{</span>
    _initial: <span class="token punctuation">[</span> <span class="token punctuation">{</span> before: <span class="token string">'UPDATE'</span>, handler: <span class="token punctuation">[</span>Function: clearKeysFromData<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,
    before: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    on: <span class="token punctuation">[</span> <span class="token punctuation">{</span> on: <span class="token string">'*'</span>, handler: <span class="token punctuation">[</span>AsyncFunction: on_handler<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,
    after: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    _error: <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  definition: undefined,
  _source: <span class="token string">'/home/node/samples/node_modules/@sap/cds/libx/_runtime/remote/Service.js'</span>,
  datasource: undefined,
  destinationOptions: <span class="token punctuation">{</span> useCache: <span class="token boolean">true</span> <span class="token punctuation">}</span>,
  destination: <span class="token punctuation">{</span>
    name: undefined,
    url: <span class="token string">'https://developer-challenge.cfapps.eu10.hana.ondemand.com/odata/v4/northbreeze'</span>
  <span class="token punctuation">}</span>,
  path: undefined,
  requestTimeout: <span class="token number">60000</span>,
  csrf: undefined,
  csrfInBatch: undefined,
  middlewares: <span class="token punctuation">{</span> timeout: <span class="token punctuation">[</span>Function <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>, csrf: undefined <span class="token punctuation">}</span>,
  entities: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  actions: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>In the <code>credentials</code> part of the options we just need to specify the URL, the service is open and doesn't require authentication.</p>
<p>OK, now we're ready to send a query to that remote service. Let's first define and store a simple query using the <a href="https://cap.cloud.sap/docs/node.js/cds-ql#select">SELECT</a> class:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> categories <span class="token operator">=</span> SELECT <span class="token variable"><span class="token variable">`</span>CategoryName<span class="token variable">`</span></span> .from <span class="token variable"><span class="token variable">`</span>Categories<span class="token variable">`</span></span>
cds.ql <span class="token punctuation">{</span>
  SELECT: <span class="token punctuation">{</span>
    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'Categories'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    columns: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'CategoryName'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>How about executing that query, like we did before?</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await categories
Uncaught Error: Can't execute query as no primary database is connected.
    at get <span class="token keyword">then</span> <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/ql/cds.ql-Query.js:66:50<span class="token punctuation">)</span>
    at REPL40:1:39</code></pre>
<p>Of course! This is not some query we can (or even want to) send to a local service; there isn't even a database connected<a href="#footnote-5"><sup>5</sup></a>!</p>
<p>We want to send it to the remote <code>northbreeze</code> service. So let's do that:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await northbreeze.run<span class="token punctuation">(</span>categories<span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Beverages'</span>, CategoryID: <span class="token number">1</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Condiments'</span>, CategoryID: <span class="token number">2</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Confections'</span>, CategoryID: <span class="token number">3</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Dairy Products'</span>, CategoryID: <span class="token number">4</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Grains/Cereals'</span>, CategoryID: <span class="token number">5</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Meat/Poultry'</span>, CategoryID: <span class="token number">6</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Produce'</span>, CategoryID: <span class="token number">7</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> CategoryName: <span class="token string">'Seafood'</span>, CategoryID: <span class="token number">8</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Excellent!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>I hope you got a useful impression of both how easy it is to get started with the cds REPL and also how powerful it is. We've only just scratched the surface of its utility and power. Let me know in the comments if you'd like to learn more.</p>
<p>Until next time - happy exploring!</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<ol>
<li>
<p>The standard Node.js REPL also has the <code>.editor</code> command which is not shown in the <code>.help</code> output here for some reason.</p>
</li>
<li>
<p>Which we can of course discover like this, for example:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> Object.keys<span class="token punctuation">(</span>cds.entities<span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token string">'Books'</span>, <span class="token string">'Authors'</span>, <span class="token string">'Genres'</span>, <span class="token string">'Books.texts'</span>, <span class="token string">'Genres.texts'</span> <span class="token punctuation">]</span></code></pre>
<p>But doing that gets a little tiresome after a while.</p>
</li>
<li>
<p>This service was created originally for the <a href="https://community.sap.com/t5/technology-blogs-by-sap/sap-developer-challenge-apis/ba-p/13573168">Developer Challenge on APIs</a> in August 2023 and <a href="https://developer-challenge.cfapps.eu10.hana.ondemand.com/">is still running</a>.</p>
</li>
<li>
<p>This is known by Daniel and the team and they are working on the best way to address this. Before that's done, we can use this hack for the purposes we have in the cds REPL here.</p>
</li>
<li>
<p>If you're like me, you'll be asking at this point &quot;what would this error look like if we had started a CAP server for the <code>bookshop</code> service like before (instead of just launching an &quot;empty&quot; cds REPL), with <code>.run bookshop</code>?&quot;</p>
<p>Well, if we did have a running CAP server from the <code>bookshop</code> service, we'd see a different error:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await categories
Uncaught SqliteError: no such table: Categories in:
SELECT CategoryName FROM Categories
    at Database.prepare <span class="token punctuation">(</span>/home/node/samples/node_modules/better-sqlite3/lib/methods/wrappers.js:5:21<span class="token punctuation">)</span>
    at SQLiteService.prepare <span class="token punctuation">(</span>/home/node/samples/node_modules/@cap-js/sqlite/lib/SQLiteService.js:72:29<span class="token punctuation">)</span>
    at SQLiteService.onSELECT <span class="token punctuation">(</span>/home/node/samples/node_modules/@cap-js/db-service/lib/SQLService.js:135:25<span class="token punctuation">)</span>
    at next <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/srv/srv-dispatch.js:64:36<span class="token punctuation">)</span>
    at SQLiteService.handle <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/srv/srv-dispatch.js:68:6<span class="token punctuation">)</span>
    at SQLiteService.dispatch <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/srv/srv-dispatch.js:30:15<span class="token punctuation">)</span>
    at SQLiteService._begin <span class="token punctuation">[</span>as dispatch<span class="token punctuation">]</span> <span class="token punctuation">(</span>/home/node/samples/node_modules/@sap/cds/lib/srv/srv-tx.js:204:15<span class="token punctuation">)</span>
    at process.processTicksAndRejections <span class="token punctuation">(</span>node:internal/process/task_queues:105:5<span class="token punctuation">)</span>
    at async REPL3:1:33 <span class="token punctuation">{</span>
  code: <span class="token string">'SQLITE_ERROR'</span>,
  query: <span class="token string">'SELECT CategoryName FROM Categories'</span>
<span class="token punctuation">}</span></code></pre>
<p>Makes sense, right?</p>
</li>
</ol>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/03/10/migrating-github-issue-based-url-bookmarks-to-wallabag/">Migrating GitHub issue based URL bookmarks to wallabag</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/03/23/how-i-run-executables-in-containers/">How I run executables in containers</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/03/21/level-up-your-cap-skills-by-learning-how-to-use-the-cds-repl/` was built on 2025-12-08T20:26:34.749Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
