<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics</title>
		<meta name="description" content="In this post I describe my re-worked basic setup for working with CAP Node.js in Neovim, focusing on the configuration and digging into the LSP based diagnostic facilities.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="In this post I describe my re-worked basic setup for working with CAP Node.js in Neovim, focusing on the configuration and digging into the LSP based diagnostic facilities.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node-js-configuration-and-diagnostics/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="a-modern-and-clean-neovim-setup-for-cap-node-js-configuration-and-diagnostics">A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics</h1>

<ul class="post-metadata">
	<li><time datetime="2025-06-10">10 June 2025</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/nodejs/" class="post-tag">nodejs</a>, </li>
	<li><a href="/tags/neovim/" class="post-tag">neovim</a>, </li>
	<li><a href="/tags/lsp/" class="post-tag">lsp</a>, </li>
	<li><a href="/tags/treesitter/" class="post-tag">treesitter</a>, </li>
	<li><a href="/tags/lua/" class="post-tag">lua</a></li>
</ul>

<p class="post-description-main">In this post I describe my re-worked basic setup for working with CAP Node.js in Neovim, focusing on the configuration and digging into the LSP based diagnostic facilities.</p>

<h2 id="introduction">Introduction</h2>
<p>The advent of the latest release of Neovim (<a href="https://neovim.io/doc/user/news-0.11.html" title="The official release news item">0.11</a>) brought some changes and improvements in the area of LSP and diagnostics support, covered nicely in the post <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/" title="A very readable post by Gregory Anders">What's new in Neovim 0.11</a> from Gregory Anders, and also in David Kunz's video <a href="https://www.youtube.com/watch?v=ZiH59zg59kg" title="An 8 min overview video by David Kunz (aka DevOnDuty)">Neovim 0.11: What's New?</a>.</p>
<p>I have tried to embrace the new simplified LSP features and have created a clean configuration for CAP Node.js development, predominantly the editing of CDS and JavaScript files.</p>
<blockquote>
<p>For those outside the SAP ecosphere, <a href="https://cap.cloud.sap/docs/" title="The main CAP documentation">CAP</a> is the SAP Cloud Application Programming Model and <a href="https://cap.cloud.sap/docs/cds/">CDS</a> is the backbone of CAP, a collection of domain specific languages (DSLs) that include the Conceptual Definition Language (<a href="https://cap.cloud.sap/docs/cds/cdl">CDL</a>), a declarative language for defining models; files containing CDL source are usually found with the extension <code>.cds</code> which reflects the overall model.</p>
</blockquote>
<p>Both JavaScript and CDS sources are supported by language servers and also by Tree-sitter. The setup of Neovim to use such facilities with a minimum of configuration and a maximum use of default keybindings and operations is my aim here.</p>
<p>In the following sections I'll describe the configuration and how I am using the facilities that the configuration describes, specifically the diagnostic facilities.</p>
<h2 id="configuration">Configuration</h2>
<p>The overall configuration follows what I think is a fairly standard approach, coupled with <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/#simpler-lsp-setup-and-configuration">the simpler LSP setup and configuration</a> approach in 0.11.</p>
<p>For the purposes of isolating and working on this configuration, I use the <a href="https://neovim.io/doc/user/starting.html#_nvim_appname">NVIM_APPNAME</a> feature which lets me split out and manage separate clusters of Neovim configuration. I have a cluster named &quot;clean&quot;, which I put together for this exercise, and for which I set <code>NVIM_APPNAME=clean</code> for this purpose, via a custom shell function <a href="https://github.com/qmacro/dotfiles/blob/73e27bb3e76067e9bf21be873ad7c131a0ddf40b/bashrc.d/70-functions.sh#L95-L115">nvc</a>.</p>
<h3 id="the-file-and-directory-structure">The file and directory structure</h3>
<p>In the root of the &quot;clean&quot; configuration, here's what <code>tree</code> shows:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token comment"># /home/dj/.config/nvim-configs/clean</span>
<span class="token punctuation">;</span> tree
<span class="token builtin class-name">.</span>
├── init.lua
├── lazy-lock.json
├── lsp
│   ├── cds.lua
│   ├── javascript.lua
│   └── lua.lua
├── lua
│   ├── config
│   │   └── lazy.lua
│   └── plugins
│       ├── mini.lua
│       └── treesitter.lua
└── queries
    └── cds
        ├── folds.scm
        ├── highlights.scm
        ├── indents.scm
        ├── injections.scm
        └── locals.scm

<span class="token number">7</span> directories, <span class="token number">16</span> files</code></pre>
<p>Briefly:</p>
<ul>
<li>The main configuration is in <code>init.lua</code>, supported by a fairly standard configuration file <code>lua/config/lazy.lua</code> for the <a href="https://github.com/folke/lazy.nvim">lazy.nvim</a> plugin manager.</li>
<li>I'm managing language server configuration in separate files within the <code>lsp/</code> directory (as described in the &quot;simpler LSP setup and configuration&quot; section of Gregory's blog post referenced earlier).</li>
<li>I have kept the plugins (in <code>lua/plugins/</code>) to a minimum; a status line from the <code>mini</code> family of plugins that shows LSP info (see <a href="#diagnostic-summary-in-the-statusline">later</a> for an example of what this looks like) and configuration for Tree-sitter.</li>
<li>In the <code>queries/cds/</code> directory are various query definitions to go along with the custom Tree-sitter support in <a href="https://github.com/cap-js-community/tree-sitter-cds">tree-sitter-cds</a>; while Tree-sitter will be able to parse and recognise symbols in the CDS sources, Neovim won't be able to assign colours to the different parts of the generated syntax tree without those queries, and no syntax highlighting will appear. The setup of <code>tree-sitter-cds</code>, which includes the addition of these <code>*.scm</code> files, is described in the <a href="https://github.com/cap-js-community/tree-sitter-cds/blob/main/docs/neovim-support.md">Neovim support</a> section of the repo.</li>
</ul>
<p>It's perhaps worth pointing out what's <em>not</em> there - in particular, the <a href="https://github.com/neovim/nvim-lspconfig">nvim-lspconfig</a> plugin, which I don't need to use now.</p>
<p>The entire configuration cluster (all the files above) is <a href="https://github.com/qmacro/dotfiles/tree/5c5b83acf6c0e2931a6b662e8602e2d97ea6f02a/config/nvim-configs/clean">available to browse in my dotfiles repo</a>.</p>
<h3 id="init-lua">init.lua</h3>
<p>Here's the full content of the <code>init.lua</code> file:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"><span class="token comment">-- PLUGIN MANAGER</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"config.lazy"</span><span class="token punctuation">)</span>

<span class="token comment">-- LANGUAGE SERVER PROTOCOL</span>

<span class="token comment">-- LSP-based completion support</span>
vim<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">nvim_create_autocmd</span><span class="token punctuation">(</span><span class="token string">'LspAttach'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
    <span class="token keyword">local</span> client <span class="token operator">=</span> vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span><span class="token function">get_client_by_id</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>client_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> client<span class="token punctuation">:</span><span class="token function">supports_method</span><span class="token punctuation">(</span><span class="token string">'textDocument/completion'</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
      vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span>completion<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>id<span class="token punctuation">,</span> ev<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token punctuation">{</span> autotrigger <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">-- Control LSP support by filetype</span>
vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'javascript'</span><span class="token punctuation">,</span>
  <span class="token string">'cds'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 'lua',</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">-- LSP logging</span>
vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span><span class="token function">set_log_level</span><span class="token punctuation">(</span><span class="token string">"WARN"</span><span class="token punctuation">)</span>

<span class="token comment">-- DIAGNOSTICS</span>

<span class="token comment">-- How diagnostics are displayed</span>
vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> virtual_lines <span class="token operator">=</span> <span class="token punctuation">{</span> current_line <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">-- GENERAL OPTIONS</span>

vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token keyword">true</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>expandtab <span class="token operator">=</span> <span class="token keyword">true</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>shiftwidth <span class="token operator">=</span> <span class="token number">2</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>signcolumn <span class="token operator">=</span> <span class="token string">"yes:1"</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>cursorline <span class="token operator">=</span> <span class="token keyword">true</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>splitright <span class="token operator">=</span> <span class="token keyword">true</span>
vim<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>winborder <span class="token operator">=</span> <span class="token string">"rounded"</span>

<span class="token comment">-- FILETYPES</span>

vim<span class="token punctuation">.</span>filetype<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extension <span class="token operator">=</span> <span class="token punctuation">{</span> cds <span class="token operator">=</span> <span class="token string">'cds'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>I'll take this section by section.</p>
<h4 id="plugin-manager">Plugin manager</h4>
<p>In the &quot;plugin manager&quot; section I require the <a href="https://github.com/folke/lazy.nvim">lazy.nvim</a> plugin manager configuration which is in <a href="https://github.com/qmacro/dotfiles/blob/1a8f26fc6b80b9ab1043a9b4e197019c66295306/config/nvim-configs/clean/lua/config/lazy.lua">lua/config/lazy.lua</a>. This is very close to the standard configuration example in the <a href="https://lazy.folke.io/installation">lazy installation guide</a>, I have not consciously added or changed anything there.</p>
<h4 id="language-server-protocol">Language server protocol</h4>
<p>The &quot;language server protocol&quot; section uses the new 0.11 features, specifically creating an <code>LspAttach</code> callback to check for and enable completion if the language server supports it, and enabling the configuration on a filetype by filetype basis.</p>
<p>The language server specific configuration itself can be found in individual files in the <code>lsp/</code> directory. I have configuration files for CDS, JavaScript and Lua, and am enabling language server usage for the first two.</p>
<blockquote>
<p>This is partly because I want to focus on just those two but also, with respect to Lua, I need to figure out how to &quot;put back&quot; that configuration that prevents warnings about <code>vim</code> being an &quot;undefined global&quot;:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"> <span class="token comment">-- LSP-based completion support</span>
W vim<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">nvim_create_autocmd</span><span class="token punctuation">(</span><span class="token string">'LspAttach'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
 └──── undefined<span class="token operator">-</span>global<span class="token punctuation">:</span> Undefined global `vim`<span class="token punctuation">.</span>
   callback <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
   <span class="token punctuation">...</span>
   <span class="token keyword">end</span></code></pre>
<p>Until I do, I've disabled the LSP connection for Lua.</p>
<p>Update: I found out how to do this in 0.11 - see the <a href="#prevent-the-lua-undefined-global-diagnostic-message">Prevent the Lua &quot;undefined global&quot; diagnostic message</a> section in the Appendix.</p>
</blockquote>
<p>Here is what <code>lsp/javascript.lua</code> contains:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"><span class="token keyword">return</span> <span class="token punctuation">{</span>
  cmd <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'typescript-language-server'</span><span class="token punctuation">,</span> <span class="token string">'--stdio'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  root_markers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'package.json'</span><span class="token punctuation">,</span> <span class="token string">'.git'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  filetypes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'javascript'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>That's it! All that's needed here is information on how to invoke the actual language server executable, hints on how to find where the project (&quot;workspace&quot;) root is, and what Neovim filetypes this configuration is for. The contents of <a href="https://github.com/qmacro/dotfiles/blob/1a8f26fc6b80b9ab1043a9b4e197019c66295306/config/nvim-configs/clean/lsp/cds.lua">lsp/cds.lua</a> is similar.</p>
<p>Where are these language server executables? Well, one might use <a href="https://github.com/mason-org/mason.nvim">mason.nvim</a> to install and manage language servers and other similar executables, but to keep things simple from a Neovim configuration perspective, I just installed them manually; for JavaScript I use <a href="https://www.npmjs.com/package/typescript-language-server">typescript-language-server</a> and <a href="https://github.com/qmacro/dotfiles/blob/1a8f26fc6b80b9ab1043a9b4e197019c66295306/config/nvim-configs/clean/lsp/cds.lua#L2">for CDS</a> I use <a href="https://www.npmjs.com/package/@sap/cds-lsp">@sap/cds-lsp</a>, both of which are available via NPM:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> typescript-language-server @sap/cds-lsp</code></pre>
<blockquote>
<p>In my dev container based Personal Development Environment (PDE) setup I have the global NPM directory set to <code>$HOME/.npm-packages</code> (with <code>npm config set prefix &quot;$HOME/.npm-packages</code>), and <code>$HOME/.npm-packages/bin/</code> is in my <code>$PATH</code>, meaning that once installed, the executables from these two packages are reachable both by me and by Neovim:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token comment"># /home/dj</span>
<span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token environment constant">$PATH</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">':'</span> <span class="token string">'\n'</span> <span class="token operator">|</span> <span class="token function">grep</span> npm-packages
/home/dj/.npm-packages/bin
<span class="token comment"># /home/dj</span>
<span class="token punctuation">;</span> <span class="token function">which</span> cds-lsp typescript-language-server
/home/dj/.npm-packages/bin/cds-lsp
/home/dj/.npm-packages/bin/typescript-language-server</code></pre>
</blockquote>
<p>I have a line in <code>init.lua</code> relating to <a href="https://neovim.io/doc/user/lsp.html#vim.lsp.set_log_level()">LSP logging output</a>:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span><span class="token function">set_log_level</span><span class="token punctuation">(</span><span class="token string">"WARN"</span><span class="token punctuation">)</span></code></pre>
<p>This &quot;WARN&quot; level is actually the default, but I like to leave this line in and have the option to increase the level to &quot;INFO&quot; or even &quot;DEBUG&quot; to see what's going on. The log records are written to a file called <code>lsp.log</code> in the <code>$HOME/.local/state/</code> directory for the active Neovim configuration cluster, so in my case it's:</p>
<pre class="language-text" tabindex="0"><code class="language-text">~/.local/state/nvim-configs/clean/lsp.log</code></pre>
<p>While I'm learning more about the protocol and what each server offers, I find it useful sometimes to keep an eye on what's going on between Neovim and the language server.</p>
<h4 id="diagnostics">Diagnostics</h4>
<p>In the &quot;diagnostics&quot; section I've included some configuration that is also from the <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/#diagnostics">Diagnostics</a> part of the &quot;What's new in Neovim 0.11&quot; blog post.</p>
<p>The configuration as shown above, using <code>virtual_lines</code>, results in a nice display of the diagnostic messages on a separate line, with a pointer to the exact position to which the diagnostic relates. See later for a comparison of different diagnostic displays.</p>
<h4 id="general-options">General options</h4>
<p>There's only a couple of things perhaps worth pointing out in my general options.</p>
<p>First, there's the <a href="https://neovim.io/doc/user/options.html#'signcolumn'">signcolumn</a> value. I don't like the entire buffer content switching left and right by a character when there's a sign (such as <code>H</code>, <code>W</code>, <code>I</code> or <code>E</code> for hint, warning, info and error respectively) to be displayed, so I use <code>yes:1</code> to have a permanent single character column for sign eventualities.</p>
<p>Then there's <a href="https://neovim.io/doc/user/options.html#'winborder'">winborder</a> which is new and mentioned in the <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/#improved-hover-documentation">Improved hover documentation</a> section of the &quot;What's new with Neovim 0.11&quot; blog post. See later for what effect this has.</p>
<h4 id="filetypes">Filetypes</h4>
<p>Lastly I have added an explicit line to set the filetype to <code>cds</code> for files ending in <code>.cds</code>. Without this, Neovim won't recognise and set this custom filetype for the CDS content I want to edit, and as a consequence, none of the filetype based configuration (such as for the language servers) will kick in.</p>
<h2 id="usage">Usage</h2>
<p>With all that out of the way, here are a few notes on how I can use this configuration, specifically regarding diagnostics.</p>
<h3 id="diagnostic-display">Diagnostic display</h3>
<p>There are different ways I can have Neovim share diagnostic information with me.</p>
<blockquote>
<p>In all the following samples, the symbol for which the diagnostic has been raised is actually underlined by default in Neovim, for example <code>book</code> (in <code>book.stock</code>) on the line with the <code>E</code> in the sign column would be underlined in the first example here; I just can't get it to render as underlined in this code block rendered from Markdown.</p>
<p>Incidentally, this underline feature belongs to the &quot;family&quot; of diagnostic display options, along with virtual text, virtual lines and signs. If you really want to, you can turn underlining off in this context by including <code>underline = false</code> in the table of options passed to <code>vim.diagnostic.config()</code>.</p>
</blockquote>
<h4 id="floating-window">Floating window</h4>
<p>Without any explicit call to <code>vim.dianostic.config()</code> in my configuration, diagnostic signs are shown in the sign column, the relevant part of the line is underlined, but no diagnostic detail is displayed at all by default, even if my cursor is on that line:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> ListOfBooks<span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token constant">E</span>     <span class="token keyword">if</span> book<span class="token punctuation">.</span>stock <span class="token operator">></span> <span class="token number">111</span><span class="token punctuation">)</span> book<span class="token punctuation">.</span>title <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> -- 11% discount!</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Reduce stock of ordered books if available stock suffices</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'submitOrder'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code></pre>
<blockquote>
<p>Prior to 0.11 diagnostic detail would be displayed for every line, all at once, as virtual text (see below), which was a little too much; now, the default is not to do that.</p>
</blockquote>
<p>To summon the diagnostic detail when I'm on that line I can use the default keymap binding <code>C-w d</code> to &quot;show diagnostic under cursor&quot;, which then appears like this (with the rounded border decoration thanks to the <code>winborder</code> configuration shown earlier):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> ListOfBooks<span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token constant">E</span>     <span class="token keyword">if</span> book<span class="token punctuation">.</span>stock <span class="token operator">></span> <span class="token number">111</span><span class="token punctuation">)</span> book<span class="token punctuation">.</span>title <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> -- 11% discount!</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>   ╭───────────────────────╮
         <span class="token literal-property property">│Diagnostics</span><span class="token operator">:</span>           │
    <span class="token comment">// Re│1. '(' expected. [1005]│ks if available stock suffices</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token parameter">╰───────────────────────╯eq</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">book</span><span class="token operator">:</span>id<span class="token punctuation">,</span> quantity <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>data</code></pre>
<blockquote>
<p>See later in this section, where I look at some CDS sources, for an example of how to invoke this floating window manually.</p>
</blockquote>
<h4 id="virtual-text">Virtual text</h4>
<p>Virtual text is the vivid text displayed to the right of the source lines, and with:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> virtual_text <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>the diagnostic detail is shown for any and all lines, all the time (which is how diagnostic detail was displayed by default prior to 0.11):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> ListOfBooks<span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token constant">E</span>     <span class="token keyword">if</span> book<span class="token punctuation">.</span>stock <span class="token operator">></span> <span class="token number">111</span><span class="token punctuation">)</span> book<span class="token punctuation">.</span>title <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> -- 11% discount!</span><span class="token template-punctuation string">`</span></span>     ■ <span class="token string">'('</span> expected<span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Reduce stock of ordered books if available stock suffices</span>
<span class="token constant">E</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">;</span>submitOrder'<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span>     ■■■ Unterminated string literal<span class="token punctuation">.</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">book</span><span class="token operator">:</span>id<span class="token punctuation">,</span> quantity <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>data</code></pre>
<p>While there are just two errors shown in this example, with more it can get a little too &quot;busy&quot; so this is not a configuration option I use.</p>
<p>Replacing the scalar <code>true</code> value with <code>{ current_line = true }</code> like this:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> virtual_text <span class="token operator">=</span> <span class="token punctuation">{</span> current_line <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>causes any diagnostic detail to be displayed as virtual text but only for the line you're on; in this following example, the same two errors exist as before, but the cursor is on the <code>this.on( ... )</code> line:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> ListOfBooks<span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token constant">E</span>     <span class="token keyword">if</span> book<span class="token punctuation">.</span>stock <span class="token operator">></span> <span class="token number">111</span><span class="token punctuation">)</span> book<span class="token punctuation">.</span>title <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> -- 11% discount!</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Reduce stock of ordered books if available stock suffices</span>
<span class="token constant">E</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">;</span>submitOrder'<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span>     ■■■ Unterminated string literal<span class="token punctuation">.</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">book</span><span class="token operator">:</span>id<span class="token punctuation">,</span> quantity <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>data</code></pre>
<p>Note, as shown here, that by default the signs will always be displayed in the sign column for all relevant lines.</p>
<h4 id="virtual-lines">Virtual lines</h4>
<p>Changing the configuration property from <code>virtual_text</code> to <code>virtual_lines</code> causes the diagnostic detail to be displayed on a separate line, with a thin pointer to the specific problematic position; here's an example based on the actual configuration I have in <code>init.lua</code>, i.e. using virtual lines but only displaying the diagnostic detail for the line I'm currently on (which here is the one with <code>this.on( ... )</code> again):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> ListOfBooks<span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token constant">E</span>     <span class="token keyword">if</span> book<span class="token punctuation">.</span>stock <span class="token operator">></span> <span class="token number">111</span><span class="token punctuation">)</span> book<span class="token punctuation">.</span>title <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> -- 11% discount!</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Reduce stock of ordered books if available stock suffices</span>
<span class="token constant">E</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>"submitOrder'<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                                         └──── <span class="token number">1002</span><span class="token operator">:</span> Unterminated string literal<span class="token punctuation">.</span>
<span class="token constant">E</span>     <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">book</span><span class="token operator">:</span>id<span class="token punctuation">,</span> quantity <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>data
<span class="token constant">E</span>     <span class="token keyword">let</span> book <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">SELECT</span><span class="token punctuation">.</span>one<span class="token punctuation">.</span><span class="token function">from</span> <span class="token punctuation">(</span>Books<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token parameter">b</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>stock<span class="token punctuation">)</span></code></pre>
<p>Note that while diagnostic detail is indeed only displayed for the line I'm on (e.g. it's not displayed for the first error where there's a missing opening bracket for the <code>if</code> condition), there could be multiple virtual lines displayed for a single line of course, depending on the knock-on effects of the actual issue.</p>
<p>There's an example of multiple virtual lines later in the <a href="#diagnostic-severity-order">Diagnostic severity order</a> section, and both Gregory and David cover virtual lines nicely in their post and video respectively too.</p>
<p>Here's how I see the pros and cons of each of these diagnostic detail display approaches:</p>
<table>
<thead>
<tr>
<th>Detail display</th>
<th>For</th>
<th>Against</th>
</tr>
</thead>
<tbody>
<tr>
<td>Floating window</td>
<td>Neat, and can usually see all the detail</td>
<td>Have to use an explicit keybinding to invoke</td>
</tr>
<tr>
<td>Virtual text</td>
<td>Source code remains stable</td>
<td>Sometimes the detail displayed is off the right hand edge of the buffer</td>
</tr>
<tr>
<td>Virtual lines</td>
<td>More of the detail is available to read, and there's a nice pointer to the relevant position</td>
<td>Causes the source code to jump up and down</td>
</tr>
</tbody>
</table>
<p>Note that the option to have diagnostic detail displayed just on the current line (vs all lines all the time) is available for both virtual text and virtual lines.</p>
<p>For now I'm going with virtual lines, with diagnostic detail displayed on the current line only; that's what the configuration shown in my <code>init.lua</code> above declares, too.</p>
<p>By the way, all the examples above have been based on JavaScript sources. Here's an example of a CDS source, where there are three diagnostics - one warning and two error. The cursor is on the <code>entity Books : managed {</code> line:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds">W <span class="token using keyword">using</span> { Currency, sap, Language } <span class="token from keyword">from</span> '@sap/cds/common';
  <span class="token keyword">namespace</span> sap.capire.bookshop;

E <span class="token keyword">entity</span> Books : managed {
                 └──── ref-undefined-art: No artifact has been found with <span class="token cdl-keyword keyword">name</span> “managed”
E   <span class="token cqlkeywords keyword">key</span> ID  <span class="token type builtin">Integer</span>;
    <span class="token annotation important">@mandatory</span> title  : localized <span class="token type builtin">String(111)</span>;
    descr  : localized <span class="token type builtin">String(1111)</span>;</code></pre>
<p>(The warning is an <code>unused-artifact-import</code> diagnostic for the imported <code>Language</code> type and the other error is a <code>syntax-unexpected-token</code> caused by a missing colon between <code>ID</code> and <code>Integer</code>).</p>
<p>While we're in this file, let's look at how to invoke the floating window with the diagnostic detail, which would normally be done with <code>C-w d</code>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds">W ╭────────────────────────────────────────────────────────────────────────────────────────────╮
  │Diagnostics:                                                                                │
  │1. Mismatched ‹Identifier›, expecting ‘:’, ‘;’, ‘{’, ‘}’, ‘<span class="token annotation important">@’,</span> ‘=’ [syntax-unexpected-token]│
E ╰────────────────────────────────────────────────────────────────────────────────────────────╯
E   <span class="token cqlkeywords keyword">key</span> ID  <span class="token type builtin">Integer</span>;
            └──── syntax-unexpected-token: Mismatched ‹Identifier›, expecting ‘:’, ‘;’, ‘{’, ‘}’, ‘<span class="token annotation important">@’,</span> ‘=’
    <span class="token annotation important">@mandatory</span> title  : localized <span class="token type builtin">String(111)</span>;
    descr  : localized <span class="token type builtin">String(1111)</span>;
    <span class="token annotation important">@mandatory</span> author : <span class="token association-composition keyword">Association to Authors</span>;
 N  Diag E4 W1 LSP +  cap/db/schema.cds[+]                                                                cds  29|55│ 1|18
:lua vim.diagnostic.open_float()</code></pre>
<p>You can see in the command line that the floating window (independent of the virtual lines already displayed) is opened with <a href="https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.open_float()">vim.diagnostic.open_float()</a> .</p>
<h4 id="diagnostic-summary-in-the-statusline">Diagnostic summary in the statusline</h4>
<p>The <a href="https://github.com/qmacro/dotfiles/blob/5c5b83acf6c0e2931a6b662e8602e2d97ea6f02a/config/nvim-configs/clean/lua/plugins/mini.lua">statusline configuration</a> in <code>lua/plugins/mini.lua</code> is simple but the effect is very useful; here's what it looks like with icons enabled:</p>
<p><img src="/images/2025/06/mini-statusline-with-icons.png" alt="mini statusline showing LSP info, with icons enabled"></p>
<p>and with them disabled:</p>
<p><img src="/images/2025/06/mini-statusline-no-icons.png" alt="mini statusline showing LSP info, with icons disabled"></p>
<p>From left to right this status line shows that I'm currently in &quot;Normal&quot; mode, there are two &quot;error&quot; level diagnostics and one &quot;hint&quot; level diagnostics in the current buffer, and that there is one <a href="https://github.com/echasnovski/mini.statusline/blob/e331175f10d9f400b42523b3890841aba202ce16/lua/mini/statusline.lua#L351-L369">LSP server attached</a>.</p>
<p>See also the <a href="#lsp-health-check">LSP health check</a> section in the Appendix.</p>
<h4 id="diagnostic-severity-order">Diagnostic severity order</h4>
<p>There's only space for a single diagnostic severity indicator (<code>W</code>, <code>E</code> etc) in the sign column on each line. But if there are multiple problems on a single line, this is what could appear (my cursor is on the <code>entity Books</code> line):</p>
<pre class="language-cds" tabindex="0"><code class="language-cds">W <span class="token using keyword">using</span> { Currency, sap, Languages } <span class="token from keyword">from</span> '@sap/cds/common';
  <span class="token keyword">namespace</span> sap.capire.bookshop;

E <span class="token keyword">entity</span> Books : managed {
                 └──── ref-undefined-art: No artifact has been found with <span class="token cdl-keyword keyword">name</span> “managed”
E   <span class="token cqlkeywords keyword">key</span> ID  <span class="token type builtin">Integer</span>;
    <span class="token annotation important">@mandatory</span> title  : localized <span class="token type builtin">String(111)</span>;</code></pre>
<p>Because I use the sign column to get an at-a-glance summary of what's going on with my code, I would think that the highest <a href="https://neovim.io/doc/user/diagnostic.html#diagnostic-severity">diagnostic severity</a> on the first line was a &quot;warning&quot;.</p>
<p>But in fact there's an &quot;error&quot; level diagnostic too, which is revealed along with the &quot;warning&quot; level diagnostic when I move my cursor to the first line to cause the virtual lines to be displayed:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">W <span class="token function">using</span> <span class="token punctuation">{</span> Currency<span class="token punctuation">,</span> sap<span class="token punctuation">,</span> Languages <span class="token punctuation">}</span> from <span class="token string">'@sap/cds/common'</span><span class="token punctuation">;</span>
                         ├──── unused<span class="token operator">-</span>artefact<span class="token operator">-</span>import<span class="token punctuation">:</span> Imported artefact <span class="token string">'Languages'</span> is <span class="token keyword">not</span> used <span class="token keyword">in</span> this source file
                         └──── ref<span class="token operator">-</span>undefined<span class="token operator">-</span>def<span class="token punctuation">:</span> Artifact “Languages” has <span class="token keyword">not</span> been found
  namespace sap<span class="token punctuation">.</span>capire<span class="token punctuation">.</span>bookshop<span class="token punctuation">;</span>

E entity Books <span class="token punctuation">:</span> <span class="token function">managed</span> <span class="token punctuation">{</span>
E   key ID  Integer<span class="token punctuation">;</span>
    @mandatory title  <span class="token punctuation">:</span> localized <span class="token function">String</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The <code>unused-artefact-import</code> is the &quot;warning&quot; level diagnostic, and the <code>ref-undefined-def</code> is the &quot;error&quot; level diagnostic.</p>
<blockquote>
<p>These diagnostic detail lines are actually coloured differently in Neovim itself (warnings in yellow and errors in red) but that colour is not conveyed in these Markdown code block based text representations here (I'm trying to avoid too many non-searchable screenshots).</p>
</blockquote>
<p>I can address this problem with the <code>severity_sort</code> diagnostic option; if I <a href="https://github.com/qmacro/dotfiles/commit/4199e8d1fa5a7bd44611702108a6868f82a388e9">extend my diagnostic configuration</a> in <code>init.lua</code> to look like this:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">  vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    virtual_lines <span class="token operator">=</span> <span class="token punctuation">{</span> current_line <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    severity_sort <span class="token operator">=</span> <span class="token keyword">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>then the sign for the first line is shown as <code>E</code> rather than <code>W</code>, and the virtual lines are re-ordered too:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds">E <span class="token using keyword">using</span> { Currency, sap, Languages } <span class="token from keyword">from</span> '@sap/cds/common';
                         ├──── ref-undefined-def: Artifact “Languages” has not been found
                         └──── unused-artefact-import: Imported artefact 'Languages' is not used in this source file
  <span class="token keyword">namespace</span> sap.capire.bookshop;

E <span class="token keyword">entity</span> Books : managed {
E   <span class="token cqlkeywords keyword">key</span> ID  <span class="token type builtin">Integer</span>;
    <span class="token annotation important">@mandatory</span> title  : localized <span class="token type builtin">String(111)</span>;</code></pre>
<h3 id="diagnostic-navigation">Diagnostic navigation</h3>
<p>There are different ways that you can look at and get to the diagnostics in your code.</p>
<h4 id="jumping-between-diagnostics">Jumping between diagnostics</h4>
<p>Version 0.11 introduced more <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/#more-default-mappings">default key mappings</a>; many of them are square-bracket based and related to navigation and inspired by Tim Pope's <a href="https://github.com/tpope/vim-unimpaired">vim-unimpaired</a> plugin. There are a couple of pairs for moving between diagnostics in a buffer:</p>
<table>
<thead>
<tr>
<th>Key mapping</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[d</code>, <code>]d</code></td>
<td>Jump to prev, next diagnostic</td>
</tr>
<tr>
<td><code>[D</code>, <code>]D</code></td>
<td>Jump to first, last diagnostic</td>
</tr>
</tbody>
</table>
<h4 id="using-the-quickfix-list">Using the quickfix list</h4>
<p>There isn't a default key mapping for this, but with <a href="https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.setqflist()">vim.diagnostic.setqflist()</a> you can ask for all the diagnostics to be put in the quickfix list, which is great for an overall display and to jump between them using standard quickfix actions; what's more, some of the new <a href="https://gpanders.com/blog/whats-new-in-neovim-0-11/#more-default-mappings">default key mappings</a> make this even more comfortable:</p>
<ul>
<li><code>[q</code>, <code>]q</code>, <code>[Q</code>, <code>]Q</code>, <code>[CTRL-Q</code>, <code>]CTRL-Q</code> navigate through the quickfix list</li>
</ul>
<p>Here's what the quickfix list looks like for the diagnostics in that CDS file; at this point I've just invoked <code>:lua vim.diagnostic.setqflist()</code> and I'm on the first line in the quickfix list which is the &quot;warning&quot; level item:</p>
<p><img src="/images/2025/06/diagnostics-in-quickfix-list.png" alt="diagnostics in quickfix list"></p>
<p>This could easily be configured as a key mapping for e.g. <code>&lt;leader&gt;dq</code> (for &quot;diagnostics into quickfix list&quot;) like this:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">vim<span class="token punctuation">.</span>keymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'&lt;leader>dq'</span><span class="token punctuation">,</span> vim<span class="token punctuation">.</span>diagnostic<span class="token punctuation">.</span>setqflist<span class="token punctuation">)</span></code></pre>
<blockquote>
<p>If you're a user of <a href="https://github.com/nvim-telescope/telescope.nvim">Telescope</a> you may know there's a similar facility to show a nice navigable list of the diagnostics, with <code>builtin.diagnostics</code>.</p>
</blockquote>
<h2 id="wrapping-up">Wrapping up</h2>
<p>I've come to a point where it makes sense to finish this post. There's plenty more to learn about with respect to diagnostics, and the <a href="https://neovim.io/doc/user/diagnostic.html">standard Diagnostic documentation</a> is great, I'd recommend you have a coffee-time browse through at some point.</p>
<p>If you want to try out this exact setup without messing up your current config, or are just curious to see how it feels, I've set up a repo on GitHub called <a href="https://github.com/qmacro/neovim-modern-clean-cap-nodejs">neovim-modern-clean-cap-nodejs</a> that has a dev container definition so you can create a codespace from it, ssh to it, and run Neovim with this config. All the instructions are in the repo's README.</p>
<p>Until next time, happy editing!</p>
<h2 id="see-also">See also</h2>
<ul>
<li><a href="/blog/posts/2025/08/04/excluding-specific-diagnostics-in-neovim/">Excluding specific diagnostics in Neovim</a></li>
<li><a href="/blog/posts/2025/08/06/neovim-configuration-for-file-and-module-navigation-in-cds-models/">Neovim configuration for file and module navigation in CDS models</a></li>
</ul>
<h2 id="appendix">Appendix</h2>
<h3 id="lsp-health-check">LSP health check</h3>
<p>While my statusline does a good job of summarising the LSP facilities in play for the current buffer, I can get more info with the <a href="https://neovim.io/doc/user/health.html#_checkhealth">checkhealth</a> command, for which there's a specific option to check the health of the LSP submodule in Neovim: <code>checkhealth vim.lsp</code>. Here's what that shows when I invoke it from a buffer that I've loaded a CDS source file into, and where there's the CDS language server attached:</p>
<pre class="language-text" tabindex="0"><code class="language-text">
  ==============================================================================
  vim.lsp:                                                                    ✅

  - LSP log level : WARN
  - Log path: /home/dj/.local/state/nvim-configs/clean/lsp.log
  - Log size: 123 KB

  vim.lsp: Active Clients
  - cds (id: 1)
    - Version: 9.0.1
    - Root directory: /work/scratch/clean/cap
    - Command: { "cds-lsp", "--stdio" }
    - Settings: {}
    - Attached buffers: 1

  vim.lsp: Enabled Configurations
  - cds:
    - cmd: { "cds-lsp", "--stdio" }
    - filetypes: cds
    - root_markers: package.json, .git

  - javascript:
    - cmd: { "typescript-language-server", "--stdio" }
    - filetypes: javascript
    - root_markers: package.json, .git


  vim.lsp: File Watcher
  - file watching "(workspace/didChangeWatchedFiles)" disabled on all clients

  vim.lsp: Position Encodings
  - No buffers contain mixed position encodings

~
 Normal  health://[-]                                                                                                     checkhealth  1|34│ 1|0</code></pre>
<p>This is very useful to keep an eye on what's going on in the language server mechanisms of Neovim.</p>
<h3 id="prevent-the-lua-undefined-global-diagnostic-message">Prevent the Lua &quot;undefined global&quot; diagnostic message</h3>
<p>Here's how to prevent the &quot;undefined global&quot; diagnostic message for &quot;vim&quot; appearing when editing Lua files:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua">vim<span class="token punctuation">.</span>lsp<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  settings <span class="token operator">=</span> <span class="token punctuation">{</span>
    Lua <span class="token operator">=</span> <span class="token punctuation">{</span>
      diagnostics <span class="token operator">=</span> <span class="token punctuation">{</span>
        globals <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"vim"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Having just read the example <code>vim.lsp.config</code> code in the <a href="https://neovim.io/doc/user/lsp.html#lsp-quickstart">lsp-quickstart</a> section of the Neovim documentation, I see it's also possible (<a href="https://github.com/qmacro/dotfiles/commit/a240b0c6b604e6d188e1dea23fdce7b1f753347b">and preferable, I think</a>) to add this directly to the table of settings for the language server itself, i.e.:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"><span class="token keyword">return</span> <span class="token punctuation">{</span>
  cmd <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'lua-language-server'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  root_markers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'package.json'</span><span class="token punctuation">,</span> <span class="token string">'.git'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  filetypes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'lua'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  settings <span class="token operator">=</span> <span class="token punctuation">{</span>
    Lua <span class="token operator">=</span> <span class="token punctuation">{</span>
      diagnostics <span class="token operator">=</span> <span class="token punctuation">{</span>
        globals <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"vim"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/06/03/editing-markdown-in-a-neovim-environment/">Editing Markdown in a Neovim environment</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/">A reCAP intro to the cds REPL</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node-js-configuration-and-diagnostics/` was built on 2026-02-03T10:03:34.345Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
