<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>TASC Notes - Part 9</title>
		<meta name="description" content="These are the notes summarising what was covered in The Art and Science of CAP part 9, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="TASC Notes - Part 9">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="These are the notes summarising what was covered in The Art and Science of CAP part 9, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/02/21/tasc-notes-part-9/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="tasc-notes-part-9">TASC Notes - Part 9</h1>

<ul class="post-metadata">
	<li><time datetime="2025-02-21">21 February 2025</time></li>
	<li><a href="/tags/tasc/" class="post-tag">tasc</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/handsonsapdev/" class="post-tag">handsonsapdev</a></li>
</ul>

<p class="post-description-main">These are the notes summarising what was covered in The Art and Science of CAP part 9, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.</p>

<p>For all resources related to this series, see the post <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">The Art and Science of CAP</a>.</p>
<p>At the start of <a href="https://www.youtube.com/watch?v=Tz7TTM1pOIk">this episode</a> I take a little longer than usual to go through the <a href="/blog/posts/2025/02/14/tasc-notes-part-8/">notes to the previous part 8</a> as there was so much that Daniel covered and it was worth spending time making sure we're all on the same page.</p>
<h2 id="whats-in-a-name">What's in a name?</h2>
<p>At <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=1606">26:46</a> I finally give Daniel a chance to continue, picking up more or less where we left off last time, and that was with some query action.</p>
<p>Starting with another variation on the queries from last time, Daniel goes for this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID, title, author.name as author from Books</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>which produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights'<span class="token punctuation">,</span> author<span class="token operator">:</span> 'Emily Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre'<span class="token punctuation">,</span> author<span class="token operator">:</span> 'Charlotte Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven'<span class="token punctuation">,</span> author<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora'<span class="token punctuation">,</span> author<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle'<span class="token punctuation">,</span> author<span class="token operator">:</span> 'Richard Carpenter' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>While Mr Big might have said &quot;<a href="https://youtu.be/7pMWa33uVVE">names is for tombstones baby</a>&quot; (a phrase which Daniel recalls, from a colleague, in <a href="/blog/posts/2025/02/07/tasc-notes-part-7/">part 7</a>), names do a lot of lifting and abstracting. Let's dig in, with <code>author.name</code> in this prefix projection clause here.</p>
<p>We've thought about this already in terms of one of the two main ways that CQL extends SQL, i.e. as a <em>path expression</em>. Another term to use which Daniel introduces us to now is a &quot;flattening&quot; which makes a lot of sense, in that we can think of and treat the items in this projection (alternatively the <em>attributes</em> in this <em>tuple</em> shape construction) as flat, as along the same(attribute/tuple) plane. This is of course despite whatever SQL is required to actually realise this query expression - in particular a JOIN (the <code>.</code> in the name gives us a clue to this respect).</p>
<p>Talking of JOINs, we must note that, being a path expression, <code>author.name</code> benefits from the concept of a &quot;forward declared join&quot; (<code>author</code> represents the association). There's a brief mention of this concept in Capire for <a href="https://cap.cloud.sap/docs/cds/cdl#associations">associations in CDL</a>:</p>
<blockquote>
<p>&quot;Associations capture relationships between entities. They are like forward-declared joins added to a table definition in SQL.&quot;</p>
</blockquote>
<p>There's also a longer explanation in the dropdown box within the <a href="https://cap.cloud.sap/docs/about/best-practices#associations">Associations</a> section of the Best Practices topic in Capire.</p>
<p>Like the concept of a &quot;relvar&quot;, this is something I initially struggled to grok. But having previously asked around internally and got some great help from lovely colleagues (thanks Patrice, Sebastian and Adrian)<a href="#footnotes"><sup>1</sup></a>, I think of forward declared joins as a sort of more abstract &quot;preamble&quot; description of a relationship, that might likely be realised by a JOIN at the SQL level. Think of it as an expression of join opportunities with additional info on relationship qualification, i.e. ON conditions, which here are pulled from the managed associations used in the CDS model.</p>
<p>So here <code>author.name</code> becomes a JOIN and we are implicitly using the name <code>author</code> as a table alias, referring to the <code>Authors</code> table that has been joined; Daniel then switches to compile-to-SQL mode and &quot;emits&quot;:</p>
<pre class="language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">SELECT</span>
  ID<span class="token punctuation">,</span>
  title<span class="token punctuation">,</span>
  author<span class="token punctuation">.</span>name <span class="token keyword">as</span> author
<span class="token keyword">FROM</span> Books
<span class="token keyword">JOIN</span> Authors <span class="token keyword">as</span> author <span class="token keyword">ON</span> author<span class="token punctuation">.</span>ID <span class="token operator">=</span> Books<span class="token punctuation">.</span>author_ID</code></pre>
<h2 id="from-to-one-to-to-many-associations">From to-one to to-many associations</h2>
<pre class="language-text" tabindex="0"><code class="language-text">+---------+                 +---------+
|  Books  | N [---------] 1 | Authors |
+---------+                 +---------+</code></pre>
<p>The association from <code>Books</code> to <code>Authors</code> is a to-one association, and the bi-directional partner is the to-many association from <code>Authors</code> to <code>Books</code> (head back to <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#relations-attributes-and-values">Relations, attributes and values</a> in the notes to part 8 for a reminder):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID, name, books.title as book from Authors</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>At this point (around <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=1870">31:10</a>) Daniel explains that the path expressions we've seen, simply expressed based on associations as forward declared joins, played an important role in weaning folks off <a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping">Object Relational Mapping</a>, getting them to embrace query languages (SQL / CQL), by making it easy to express relationships like this ... without having to wrangle JOINs directly<a href="#footnotes"><sup>2</sup></a>.</p>
<p>This new query which also has a path expression, this time based on the to-many association (forward declared join) going from <code>Authors</code> to <code>Books</code>, produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Emily Brontë'<span class="token punctuation">,</span> book<span class="token operator">:</span> 'Wuhering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Charlotte Brontë<span class="token punctuation">,</span> book<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> book<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> book<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span> book<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Observe how this <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#ad-hoc-relation">ad hoc relation</a> is <a href="https://en.wikipedia.org/wiki/Denormalization">denormalised</a> - there is redundancy in the tuples owing to the 2 (many) &quot;to-many&quot;<a href="#footnotes"><sup>3</sup></a> association between Edgar Allen Poe and two of his books in the bookshop.</p>
<p>This is the basis of how Daniel shows that CQL is a valid extension to SQL in terms of the Relational Model, remembering also the enhancement to allow non-scalar values in a result set, which we covered at the end of the previous part - see <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#the-universe-of-discourse-and-correlated-subqueries">The universe of discourse and correlated subqueries</a>.</p>
<h3 id="nesting-not-flattening">Nesting not flattening</h3>
<p>In the previous part we also learned about the <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#postfix-projections-and-set-theory">postfix projection</a> approach for queries, enabling us to express the desired tuple shape in a <code>{ ... }</code> block that arguably better represents the concept we're aiming for. Here, that would be (in pseudocode<a href="#footnotes"><sup>4</sup></a>):</p>
<pre class="language-text" tabindex="0"><code class="language-text">Authors -> { ID, name, books.title as book }</code></pre>
<p>But now it's also much easier to think in terms of nesting, &quot;un-flattening&quot; <code>books.title</code> thus:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from Authors { ID, name, books { title as book } }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>What's returned is the same, from a nominal data perspective. But from a shape perspective what's returned is what we might refer to as &quot;deep&quot; and - as far it can refer to object structures - normalised (observe how there's now only one entry for Edgar Allen Poe, but with both books contained):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Emily Brontë'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Charlotte Brontë'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>As a bonus side effect of all this hard work (abstraction, extension and dedicated conformance to the constraints of the Relational Model) CAP's support for relational and non-relational (object) persistence mechanisms is impressive.</p>
<h2 id="its-lookup-tables-all-the-way-down">It's lookup tables all the way down</h2>
<p>At around <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=2112">35:12</a> Daniel take the opportunity to both double down on concepts and insights we've covered before, and to drive them home. While still in the cds REPL, he <a href="https://en.wiktionary.org/wiki/change_tack">changes tack</a> slightly and takes another look at the SQLite schema table, the same one that we looked at last week - see <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#exploring-in-sqlite">Exploring in SQLite</a>.</p>
<p>This time, to add colour, he remains in the cds REPL (rather than switches to the SQLite REPL) and just uses CQL, because &quot;why not?&quot;. He also uses a slightly different form of <a href="https://cap.cloud.sap/docs/node.js/cds-ql#constructing-queries">query construction</a> - the fluent API style:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> <span class="token constant">SELECT</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'sqlite.schema'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fluent <span class="token constant">API</span> style<span class="token punctuation">)</span></code></pre>
<p>rather than the tagged template literal approach:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from sqlite.schema</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>(<em>Accessing the SQLite schema table here feels like finding a secret door to the private rooms in a posh hotel, a door that's been hiding in plain sight but I've just not noticed it.</em>)</p>
<p>Being in the context of the cds REPL previously started with <code>cds r -r @capire/bookshop</code>, with the CDS model compiled and deployed to the persistence layer (a SQLite in-memory database in this case), we see considerably more output than <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#exploring-in-sqlite">our previous look</a>. Thirty five entries in the schema, in the lookup table:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from sqlite.schema</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> x<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// -> 35</span></code></pre>
<p>One of these that Daniel highlights at random is:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  type<span class="token operator">:</span> 'view'<span class="token punctuation">,</span>
  name<span class="token operator">:</span> 'localized_CatalogService_Currencies'<span class="token punctuation">,</span>
  tbl_name<span class="token operator">:</span> 'localized_CatalogService_Currencies'<span class="token punctuation">,</span>
  rootpage<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  sql<span class="token operator">:</span> 'CREATE VIEW localized_CatalogService_Currencies AS SELECT\n' +
    '  Currencies_0.name<span class="token punctuation">,</span>\n' +
    '  Currencies_0.descr<span class="token punctuation">,</span>\n' +
    '  Currencies_0.code<span class="token punctuation">,</span>\n' +
    '  Currencies_0.symbol<span class="token punctuation">,</span>\n' +
    '  Currencies_0.minorUnit\n' +
    'FROM localized_sap_common_Currencies AS Currencies_0'
<span class="token punctuation">}</span></code></pre>
<p>The point is that in the &quot;universe of discourse&quot; here, this entry in the lookup table is exactly what we've been talking about - a relvar (<code>localized_CatalogService_Currencies</code>, from the <code>name</code> property) pointing to, being related to, a relation definition in the <code>sql</code> property (<code>CREATE VIEW ...</code>) to contain data.</p>
<p>In other words, this database schema is a lookup table of relvars pointing to definitions, and queries relating to those definitions (of relations) have data returned as the &quot;extent&quot;.</p>
<h2 id="universes-and-variables">Universes and variables</h2>
<p>In the universe of discourse that encapsulates queries, <code>Authors</code> is a relvar (as it refer to a relation).</p>
<p>But in another universe of discourse, that of CAP's <a href="https://cap.cloud.sap/docs/node.js/cds-reflect#iterable">LinkedDefinitions</a>, <code>Authors</code> is a variable but not a relvar; rather than refer to a relation (that can be queried), it refers to the definition at the CDS model level.</p>
<p>Let's have a look, with the help of a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destructuring assignment</a> (to a different variable name <code>Authors</code> than the original property name <code>sap.capire.bookshop.Authors</code>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">{</span> <span class="token string-property property">'sap.capire.bookshop.Authors'</span><span class="token operator">:</span> Authors <span class="token punctuation">}</span> <span class="token operator">=</span> cds<span class="token punctuation">.</span>model<span class="token punctuation">.</span>definitions</code></pre>
<p>Here, <code>Authors</code> is now a variable, but not a relvar (as there's no relation, no queryable data, on the right hand side of the imaginary arrow):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> Authors
entity <span class="token punctuation">{</span>
  kind: <span class="token string">'entity'</span>,
  includes: <span class="token punctuation">[</span> <span class="token string">'managed'</span> <span class="token punctuation">]</span>,
  elements: LinkedDefinitions <span class="token punctuation">{</span>
    createdAt: Timestamp <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$now'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Core.Immutable'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedAt}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      type: <span class="token string">'cds.Timestamp'</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedAt}'</span>
    <span class="token punctuation">}</span>,
    createdBy: String <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$user'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Core.Immutable'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedBy}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>,
      type: <span class="token string">'cds.String'</span>,
      length: <span class="token number">255</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>CreatedBy}'</span>,
      <span class="token string">'@Core.Description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>
    <span class="token punctuation">}</span>,
    modifiedAt: Timestamp <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$now'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@cds.on.update'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$now'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>ChangedAt}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      type: <span class="token string">'cds.Timestamp'</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>ChangedAt}'</span>
    <span class="token punctuation">}</span>,
    modifiedBy: String <span class="token punctuation">{</span>
      <span class="token string">'@cds.on.insert'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$user'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@cds.on.update'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'='</span><span class="token builtin class-name">:</span> <span class="token string">'$user'</span> <span class="token punctuation">}</span>,
      <span class="token string">'@UI.HiddenFilter'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@UI.ExcludeFromNavigationContext'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@title'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>ChangedBy}'</span>,
      <span class="token string">'@readonly'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>,
      type: <span class="token string">'cds.String'</span>,
      length: <span class="token number">255</span>,
      <span class="token string">'@Core.Computed'</span><span class="token builtin class-name">:</span> true,
      <span class="token string">'@Common.Label'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>ChangedBy}'</span>,
      <span class="token string">'@Core.Description'</span><span class="token builtin class-name">:</span> <span class="token string">'{i18n>UserID.Description}'</span>
    <span class="token punctuation">}</span>,
    ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,
    name: String <span class="token punctuation">{</span>
      <span class="token string">'@mandatory'</span><span class="token builtin class-name">:</span> true,
      type: <span class="token string">'cds.String'</span>,
      length: <span class="token number">111</span>,
      <span class="token string">'@Common.FieldControl'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">'#'</span><span class="token builtin class-name">:</span> <span class="token string">'Mandatory'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    dateOfBirth: Date <span class="token punctuation">{</span> type: <span class="token string">'cds.Date'</span> <span class="token punctuation">}</span>,
    dateOfDeath: Date <span class="token punctuation">{</span> type: <span class="token string">'cds.Date'</span> <span class="token punctuation">}</span>,
    placeOfBirth: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,
    placeOfDeath: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,
    books: Association <span class="token punctuation">{</span>
      type: <span class="token string">'cds.Association'</span>,
      cardinality: <span class="token punctuation">{</span> max: <span class="token string">'*'</span> <span class="token punctuation">}</span>,
      target: <span class="token string">'sap.capire.bookshop.Books'</span>,
      on: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'books'</span>, <span class="token string">'author'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token string">'='</span>, <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'$self'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="relvars-and-queries-that-declare-relations-revisited">Relvars and queries that declare relations (revisited)</h2>
<p><img src="/images/2025/02/spiderman-authors.png" alt="Two Spiderman characters looking at each other, with the word &quot;Authors&quot; below them"></p>
<p><em>Screenshot from <a href="https://www.imdb.com/title/tt0824188/">Double Identity</a> (1967)</em></p>
<p>Just as we're reeling with wonder, Daniel introduces the denouement (at around <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=2275">37:58</a>), subtly at first, by capturing a query in (assigning a query to) a variable (remember, <a href="/blog/posts/2024/12/16/functions-as-first-class-citizens-in-sicp-lecture-1a/">queries are first class citizens in CAP</a>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">authors <span class="token operator">=</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from sap.capire.bookshop.Authors { ID, name, books { title as book } }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>What is <code>authors</code> here? Well, it's a query, yes:</p>
<pre class="language-text" tabindex="0"><code class="language-text">cds.ql {
  SELECT: {
    from: { ref: [ 'sap.capire.bookshop.Authors' ] },
    columns: [
      { ref: [ 'ID' ] },
      { ref: [ 'name' ] },
      {
        ref: [ 'books' ],
        expand: [ { ref: [ 'title' ], as: 'book' } ]
      }
    ]
  }
}</code></pre>
<p>But it's <em>also a relvar</em>, because as we learned in the previous part, <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#queries-declare-relations">queries declare relations</a> (even - or perhaps especially - those with <code>WHERE</code> clauses; see the next section for an example of this).</p>
<p>And because <code>authors</code> is a relvar, we should be able to use it to make a query.</p>
<p>Can we?</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> <span class="token constant">SELECT</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>authors<span class="token punctuation">)</span></code></pre>
<p>Of course we can!</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Emily Brontë'
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Charlotte Brontë'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> book<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Boom!</p>
<p>I don't know about you, but this is another beautiful moment, to see the depth to which CAP follows and is informed by the Relational Model. Reflecting on <a href="https://wiki.c2.com/?RelationalModel">what the original wiki has to say about the Relational Model</a><a href="#footnotes"><sup>6</sup></a> we see why this is important:</p>
<p>&quot;<em>It has been the foundation of most database software and theoretical database research ever since.</em>&quot;</p>
<blockquote>
<p>See <a href="#appendix-fully-qualified-names-and-reflected-variables">Appendix - Fully qualified names and reflected variables</a> for further information on this, including the reason this didn't work for Daniel during the live stream.</p>
</blockquote>
<h2 id="defining-a-relvar-as-a-query-with-a-where-clause">Defining a relvar as a query with a WHERE clause</h2>
<p>Around <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=2380">39:40</a>, answering my question on what we might call such relvars based on queries with <code>WHERE</code> clauses, which are then used in queries with <code>WHERE</code> clauses themselves, Daniel explains that these relvars are like views. And with their nest-able, or &quot;reflexive&quot; nature, we can have &quot;views upon views upon views upon views ...&quot;.</p>
<p><img src="/images/2025/02/stack-of-turtles.jpg" alt="a photo of a stack of turtles"></p>
<p><em>Turtles (or views) all the way down - <a href="https://en.wikipedia.org/wiki/File:River_terrapin.jpg">image courtesy of Pelf and Wikipedia</a>.</em></p>
<p>Here's an example of that. If we define a relvar <code>worksOfPoe</code> (also directly &quot;testing&quot; it) thus:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> worksOfPoe <span class="token operator">=</span> cds.ql <span class="token variable"><span class="token variable">`</span>SELECT FROM $<span class="token punctuation">{</span>Books<span class="token punctuation">}</span> <span class="token punctuation">{</span> ID, title <span class="token punctuation">}</span> WHERE author.name like <span class="token string">'%Poe'</span><span class="token variable">`</span></span>
cds.ql <span class="token punctuation">{</span>
  SELECT: <span class="token punctuation">{</span>
    from: <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'sap.capire.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    columns: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'ID'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'title'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>,
    where: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ref: <span class="token punctuation">[</span> <span class="token string">'author'</span>, <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token string">'like'</span>, <span class="token punctuation">{</span> val: <span class="token string">'%Poe'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">></span> await worksOfPoe
<span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> ID: <span class="token number">252</span>, title: <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre>
<p>then we can think of this as a view, and use it like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await SELECT.from<span class="token punctuation">(</span>worksOfPoe<span class="token punctuation">)</span>.where<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>title like <span class="token string">'The %'</span><span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre>
<h2 id="lazy-evaluation-and-late-materialisation">Lazy evaluation and late materialisation</h2>
<p>Let's go back briefly to a key source of inspiration for CAP, functional programming. There's a particular aspect of functional programming that we haven't mentioned much in this series, and that is <a href="https://en.wikipedia.org/wiki/Lazy_evaluation">lazy evaluation</a>, introduced in the contexts of lambda calculus and programming languages in the 1970's. Lazy (or &quot;delayed&quot;) evaluation is where an expression is not evaluated as soon as it's defined and bound to a variable; the evaluation is delayed until a value is actually required.</p>
<p>As Daniel mentions, this is a valuable approach for views in this context too, especially if we have a view defined on a view defined on a view (ad nauseam, if not ad infinitum<a href="#footnotes"><sup>7</sup></a>). The individual materialisation of just one of those views, especially towards the bottom of the stack, might be hundreds of columns (ahem, attributes) but the amalgamated construct of all the views might be just a couple.</p>
<p>Because of late materialisation, the Relational Model equivalent of lazy evaluation, this makes it possible for the engine to perform more efficiently, and ultimately only have to reify tuples consisting of just those two attributes.</p>
<h2 id="projections-selections-and-infix-notation">Projections, selections and infix notation</h2>
<p>Continuing at <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=2554">42:34</a>, Daniel enters this into his cds REPL to lay the foundation for explaining infix filters:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors {
      ID, name, books {
        ID, title
      }
    }
    WHERE ID >= 150
</span><span class="token template-punctuation string">`</span></span></code></pre>
<blockquote>
<p>For longer examples like this that use the backtick construct (<code>`...`</code>), I'm experimenting with conveying them across multiple lines; let me know if this makes it easier. By the way, I try to ensure that they're still executable as-is if you copy and paste them (thanks to the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#multi-line_strings">support of multi-line strings in template literals</a>). I'm also thinking of capitalising the CQL keywords as I've done here. Let me know what you think about this too, and what your preference is.</p>
</blockquote>
<p>But first, why don't we take the opportunity to <a href="/blog/posts/2017/02/19/the-beauty-of-recursion-and-list-machinery/#initial-recognition">stare at</a> this CQL statement and practise getting the terminology right? I find that knowing and using the right terms for technical concepts<a href="#footnotes"><sup>8</sup></a> really helps form solid synaptic connections and is the basis for better understanding and communication.</p>
<p>First, <code>{ ID, name, books { ID, title } }</code> is a <strong>projection</strong> and <code>where ID &gt;= 150</code> is a <strong>selection</strong> of the <code>Authors</code> <strong>relation</strong> (or perhaps even more precisely of the <strong>relation</strong> referred to with the <code>Authors</code> <strong>relvar</strong>).</p>
<p>Projections and selections are the two major operations in the Relational Model.</p>
<p>Next, <code>{ ID, title }</code> is also a <strong>projection</strong>, of the <strong>relation</strong> referred to via the <code>books</code> <strong>relvar</strong>. What Daniel also refers to as an &quot;inner relation&quot;. Note that even though it only has a single component, <code>books</code> here is also a <strong>path expression</strong> (see <a href="#from-to-one-to-to-many-associations">From to-one to to-many associations</a> earlier). Note that the <strong>projection</strong> <code>{ ID, title }</code> qualifying that relation is a <strong><em>postfix</em> projection</strong>.</p>
<p>Now, with that out of the way, let's dig in to what this section is really about, and that is the concept of <strong>infix filters</strong>, a syntactic solution, in a way, to finding the right balance between clarity and understanding at the CQL expression level and how much work the compiler has to do (and how much chance there is for an error to occur) to turn the CQL into something the persistence layer can execute. We touched on <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#infix-filters">infix filters in the notes to part 5 of this series</a> and Daniel gives us an example of an infix filter here.</p>
<p>First, let's look at what the query above returns, which is:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>If we wanted to restrict the output to only show the books that had <code>ID</code> values greater than 251 (effectively excluding &quot;The Raven&quot; here) then we might think that this would be the approach, with a selection - a <code>where</code> clause (<code>where ID &gt; 251</code>) - directly following the nested projection:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors {
      ID, name, books {
        ID, title
      }
      WHERE ID > 251
    }
    WHERE ID >= 150
</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// this is incorrect!</span></code></pre>
<p>Because this would present problems (and possible ambiguities) for the compiler, this is not the way.</p>
<p><em>This</em> is the way:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors {
      ID, name, books[ID > 251] {
        ID, title
      }
    }
    WHERE ID >= 150
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>which produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>There's actually an optional <code>where</code> keyword that can be used here for clarity, if you wish, i.e. <code>books [where ID &gt; 251]</code>:</p>
<p>In fact, the infix construct <code>[ ... ]</code> allows for not only filters, but other query result mechanisms, such as ordering (note here that to get back both books for Poe being returned, the filter was changed from <code>ID &gt; 251</code> to <code>ID &gt; 250</code>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors {
      ID, name, books[where ID > 251 order by title desc] {
        ID, title
      }
    }
    WHERE ID >= 150 order by name desc
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>(This doesn't currently work as expected, due to some issues. Watch this space!)</p>
<h3 id="closures-and-the-universes-of-discourse">Closures and the universes of discourse</h3>
<p>At <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=2727">45:27</a>, in the context of these CQL statements we've just been playing around with, Daniel declares something that is obvious when we think about it for a second, but is still necessary to say out loud:</p>
<ul>
<li><code>Authors</code> and <code>books</code> are path expressions</li>
<li>The &quot;path&quot; part of a path expression always has to start somewhere</li>
<li>That &quot;somewhere&quot; is a universe of discourse, or scope</li>
<li>For <code>books</code> it is <code>Authors</code></li>
<li>For <code>Authors</code> it is ... <em>the schema</em></li>
</ul>
<p>and yes:</p>
<ul>
<li>These enclosing relationships and references are indeed <a href="/blog/posts/2025/02/14/tasc-notes-part-8/#a-closure-easter-egg">similar to closures</a>.</li>
</ul>
<h3 id="its-all-just-a-path-game">&quot;It's all just a path game&quot;</h3>
<p>Moving back to the infix notation briefly, Daniel illustrates that &quot;it's all just a path game&quot;, and in fact the outermost <code>WHERE</code> clause (the selection) on <code>Authors</code> could be expressed using infix notation too:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[ID >= 150] {
      ID, name, books[ID > 251] {
        ID, title
      }
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>Perhaps we should revisit our &quot;definition&quot; of <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#cql-sql">CQL &gt; SQL</a> to add a third enhancement:</p>
<ul>
<li>associations and path expressions</li>
<li>nested projections</li>
</ul>
<p>and</p>
<ul>
<li>infix filters</li>
</ul>
<p>What fills me with wonder and amazement at this point is that what we think therefore might be possible, extrapolating from what we've learned thus far in this context ... <strong>is</strong> actually possible.</p>
<p>This does remind me of one adage that is a tagline of Perl, which is that it &quot;<em>makes easy things easy and hard things possible</em>&quot;. This is of course from the great <a href="https://en.wikipedia.org/wiki/Larry_Wall">Larry Wall</a><a href="#footnotes"><sup>9</sup></a>, and possibly originally from the equally great <a href="https://en.wikipedia.org/wiki/Alan_Kay">Alan Kay</a>.</p>
<p><a href="https://www.collinsdictionary.com/dictionary/english/to-wit">To wit</a>: being &quot;all just a path game&quot;, we can stretch these path expressions to hop between associations as we see fit(this is a slightly simplified version based on what Daniel used):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[ID >= 150] {
      name, books.authors.books {
        title
      }
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>This produces a sort of hybrid of <a href="#nesting-not-flattening">nesting and flattening</a>, with the nesting coming from the postfx projection (<code>books { title }</code>) and the flattening from the rest of the extended path expression (<code>books.authors.books</code>):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Let's refresh our memories on this CDS model:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">entity</span> Books : {
  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
  title  : <span class="token type builtin">String</span>;
  author : <span class="token association-composition keyword">Association to Authors</span>;
}

<span class="token keyword">entity</span> Authors : {
  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
  name  : <span class="token type builtin">String</span>;
  books : <span class="token association-composition keyword">Association to many Books</span> <span class="token cqlkeywords keyword">on</span> books.author = $self;
}</code></pre>
<p>If we look at Mr Poe and his two works, we can clearly see the effect of both. With the nesting, the two books are returned within the one author: <code>[ { title: 'The Raven' }, { title: 'Eleonora' } ]</code>.</p>
<p>With the flattening, the author has been denormalised due to the to-many association (<code>books.</code>) section within the extended path expression:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>If we go crazy and do this, in the interests of science:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[ID >= 150] {
      name, books.author.books.author.books {
        title
      }
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>we get double the number of records for Mr Poe, as we've followed the to-many association twice through (in the path expression, i.e. not including the postfix projection):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<blockquote>
<p>Did you notice the subtle but ultimately vast convenience of the <a href="https://cap.cloud.sap/docs/guides/domain-modeling#naming-conventions">as yet unwritten</a> convention of naming elements in the singular or plural according to the cardinality of the association? In constructing or reading the extended path expression <code>books.author...</code> we instinctively know that <code>books.</code> represents a to-many association but <code>author.</code> represents a to-one association.</p>
</blockquote>
<h3 id="you-re-supposed-to-vote-for-my-preference">&quot;You're supposed to vote for <em>my</em> preference!&quot;</h3>
<p>One way to bring the data back cleanly is to include the <code>DISTINCT</code> keyword; and here we get an insight into the inner workings of the CAP team; what seems on the surface like trivial minutiae - where to allow the placement of such a keyword - is, like everything else, an important discussion that will have ramifications long after the discussion is done.</p>
<p>Currently there are two options being debated:</p>
<ul>
<li>Daniel prefers the <code>DISTINCT</code> to follow the <code>SELECT</code> statement directly, as in <code>SELECT DISTINCT FROM Authors ...</code></li>
<li>The compiler team prefer it after the relvar and projection, as in <code>SELECT FROM Authors { ... } DISTINCT ...</code></li>
</ul>
<p>Right now, the compiler team have the edge, thus:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[ID >= 150] DISTINCT {
      name, books.author.books.author.books {
        title
      }
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>which produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books_author_books_author_books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>On playfully expressing a preference for this, I am reprimanded by Daniel. And rightly so ;-)</p>
<h3 id="expressing-paths-in-the-from-clause">Expressing paths in the FROM clause</h3>
<p>Not only are path expressions possible in projections, but also even in <code>FROM</code> clauses, as Daniel illustrates next (at around <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=3194">53:14</a>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM sap.capire.bookshop.Authors:books {
      ID, title
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>which produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>So far we have seen the use of the period <code>.</code> to join parts of a path expression together. But in the context of a <code>FROM</code> clause, where we are normally specifying entity names, which can be fully qualified and therefore contain periods (e.g. with a namespace prefix, like here: <code>sap.capire.bookshop.Authors</code>), we must use a different character - the colon <code>:</code>.</p>
<p>Note that the example above was just to illustrate this contrast between the use of <code>.</code> and <code>:</code>; you can of course also just say:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors:books {
      ID, title
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>See the <a href="https://cap.cloud.sap/docs/cds/cql#path-expressions">Path Expressions</a> section of the CQL topic in Capire for further information on this.</p>
<h3 id="understanding-path-intent-and-realisation">Understanding path intent and realisation</h3>
<p>At <a href="https://www.youtube.com/live/Tz7TTM1pOIk?t=3291">54:51</a>, building on this newfound ability to express paths in the <code>FROM</code> clause, Daniel reminds us that with great power comes great responsibility. While it's easy to create CQL queries that get you what you (ostensibly) want, you should always be aware of the implicit intent of the expression, and how it's realised underneath.</p>
<p>Here's an example. At this point in time, the query we just executed (written in-line again so we can compare it more easily with the next one):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT FROM Authors:books { ID, title }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>produces this:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>By way of comparison, this query:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT FROM Books { ID, title }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>also produces the same.</p>
<p>The difference becomes evident when we add a new book:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await INSERT.into<span class="token punctuation">(</span>Books, <span class="token punctuation">{</span> title: <span class="token string">'Robin of Sherwood'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
InsertResult <span class="token punctuation">{</span> results: <span class="token punctuation">[</span> <span class="token punctuation">{</span> changes: <span class="token number">1</span>, lastInsertRowid: <span class="token number">272</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span></code></pre>
<p>While the <code>SELECT FROM Books { ID, title }</code> includes this new book in the result set:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">272</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Robin of Sherwood' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>the one with the path expression in the <code>FROM</code> clause (<code>SELECT FROM Authors.books { ID, title }</code>) does not!</p>
<p>Why? Well, consider what we inserted, and what we didn't, plus what the root of the path expression <code>Authors.books</code> is:</p>
<ul>
<li>the root of the path expression is <code>Authors</code></li>
<li>the insertion target was <code>Books</code></li>
<li>the relation between a book and its author is via the <code>author_ID</code> foreign key on <code>Books</code></li>
<li>but we didn't include any value for <code>author_ID</code> (spot the <code>null</code> value)</li>
</ul>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT FROM Books <span class="token punctuation">{</span> ID, title, author_ID <span class="token punctuation">}</span><span class="token variable">`</span></span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID: <span class="token number">201</span>, title: <span class="token string">'Wuthering Heights'</span>, author_ID: <span class="token number">101</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">207</span>, title: <span class="token string">'Jane Eyre'</span>, author_ID: <span class="token number">107</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span>, author_ID: <span class="token number">150</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">252</span>, title: <span class="token string">'Eleonora'</span>, author_ID: <span class="token number">150</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">271</span>, title: <span class="token string">'Catweazle'</span>, author_ID: <span class="token number">170</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">272</span>, title: <span class="token string">'Robin of Sherwood'</span>, author_ID: null <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>So following the path from <code>Authors</code> along the <code>books</code> association will not reach any tuple corresponding to this new insertion! But that's the point - the <em>intent</em> implicit in each of these paths is very different:</p>
<ul>
<li>all the books in the <code>Books</code> relation</li>
</ul>
<p>vs</p>
<ul>
<li>all the books that are reached from entries in the <code>Authors</code> relation</li>
</ul>
<p>Of course, we can &quot;fix&quot; the missing link like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await UPDATE<span class="token punctuation">(</span>Books<span class="token punctuation">)</span>.set<span class="token punctuation">(</span><span class="token punctuation">{</span> author_ID:170 <span class="token punctuation">}</span><span class="token punctuation">)</span>.where<span class="token punctuation">(</span><span class="token punctuation">{</span> ID:272 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">1</span></code></pre>
<p>With the result that we can now find the book if we start from the authors:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT FROM Authors:books <span class="token punctuation">{</span> ID, title <span class="token punctuation">}</span><span class="token variable">`</span></span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID: <span class="token number">201</span>, title: <span class="token string">'Wuthering Heights'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">207</span>, title: <span class="token string">'Jane Eyre'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">252</span>, title: <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">271</span>, title: <span class="token string">'Catweazle'</span> <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span> ID: <span class="token number">272</span>, title: <span class="token string">'Robin of Sherwood'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Nice!</p>
<p>By the way, as you have probably guessed by now, the constructs we've seen can be combined pretty much arbitrarily, and Daniel shows this with a final example along this route:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT FROM Authors<span class="token punctuation">[</span>name like <span class="token string">'%Poe'</span><span class="token punctuation">]</span>:books <span class="token punctuation">{</span> ID, title <span class="token punctuation">}</span><span class="token variable">`</span></span>
<span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> ID: <span class="token number">252</span>, title: <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span></code></pre>
<p>What's combined is:</p>
<ul>
<li>a path expression</li>
<li>an infix filter</li>
<li>a postfix projection</li>
</ul>
<p>and it all Just Works™️.</p>
<p>Daniel then riffed on extending the path expression as we saw earlier (see <a href="#its-all-just-a-path-game">&quot;It's all just a path game&quot;</a>), showing how we can force the traversal round and round the associations, but to round this off here's something slightly different - adding a path expression to the postfix projection to &quot;go around&quot; in that way:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[where name like '%Poe']:books {
      ID, title, author.name
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>This produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven'<span class="token punctuation">,</span> author_name<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora'<span class="token punctuation">,</span> author_name<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>From <code>Authors</code> <em>down</em> the <code>books</code> to-many association and <em>back up</em> the <code>author</code> to-one association for the author's name.</p>
<p>And as a reminder, what would happen if we went the other way?</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Books:author[name like '%Poe'] {
      ID, name, books.title
    }
</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>We get:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Makes sense, right? (And check out that infix filter <em>on the association</em>!)</p>
<p>But note that the author name is denormalised. Flattened. Let's finish this off by reminding ourselves of how we avoid that, with a <em>nested</em> projection:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  SELECT
    FROM Authors[where name like '%Poe'] {
      ID, name, books {
        ID, title
      }
    }
</span><span class="token template-punctuation string">`</span></span>

which returns<span class="token operator">:</span>

<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`json
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Edgar Allen Poe'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">books</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'The Raven'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<h2 id="back-to-the-root-s">Back to the root(s)</h2>
<p>We are almost at the end of the episode, but Daniel has a reward for those of us who made it all the way.</p>
<p>What is that reward? Well, the move back along the axis from Science to Art, in a way, revisiting the notional top level <code>Schema</code> entity presented at the end of part 7 - see <a href="/blog/posts/2025/02/07/tasc-notes-part-7/#wrapping-up-with-relational-algebra">Wrapping up with relational algebra</a>.</p>
<blockquote>
<p>I did debate with myself whether it was from Science to Art, or from Art to Science, but it's a reward for us nonetheless.</p>
</blockquote>
<p>Earlier in these notes we dwelled briefly on the fact that &quot;above&quot; every domain entity there's the <code>Schema</code>; see the earlier sections:</p>
<ul>
<li><a href="#its-lookup-tables-all-the-way-down">It's lookup tables all the way down</a></li>
<li><a href="#closures-and-the-universes-of-discourse">Closures and the universes of discourse</a></li>
</ul>
<p>This has largely been notional, but the reward is to see Daniel make it real. How? With a deft CDL flavoured flick of the wrist, as hinted at at the end of part 7, but now as something we have a much better chance of understanding.</p>
<p>Here's a version of what was shown in part 7 that you can try at home. First, clone the <a href="https://github.com/SAP-samples/cloud-cap-samples">cloud-cap-samples</a> repo and change directory into it:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">git</span> clone https://github.com/SAP-samples/cloud-cap-samples <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cloud-cap-samples</code></pre>
<p>Then create a file <code>schema.cds</code> containing:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token using keyword">using</span> { sap.capire.bookshop.Books <span class="token cqlkeywords keyword">as</span> books } <span class="token from keyword">from</span> '@capire/bookshop';
<span class="token using keyword">using</span> { sap.capire.bookshop.Authors <span class="token cqlkeywords keyword">as</span> authors } <span class="token from keyword">from</span> '@capire/bookshop';

<span class="token annotation important">@singleton</span>
<span class="token keyword">entity</span> Schema {
  <span class="token cqlkeywords keyword">key</span> ID   : <span class="token type builtin">Integer</span>; <span class="token single-line-comment comment">// just to make it a valid DDL</span>
  Books    : <span class="token association-composition keyword">Association to many books</span> <span class="token cqlkeywords keyword">on</span> 1=1;
  Authors  : <span class="token association-composition keyword">Association to many authors</span> <span class="token cqlkeywords keyword">on</span> 1=1;
}</code></pre>
<blockquote>
<p>Here, we now have a <em>singleton</em> (&quot;<a href="https://www.youtube.com/watch?v=HEQt_2EBV8A">Es kann nur einen geben!</a>&quot;) <code>Schema</code>, representing the entire context in which our domain entities are resolved.</p>
<p>In fact, the relationship here from <code>Schema</code> to <code>Authors</code> as an association is as if we've bumped up the entity-ness one level higher (to <code>Schema</code>) and proved that the <code>Authors</code> entity can actually act as an association in this top level universe of discourse.</p>
<p>Also note that the <code>1=1</code> is a bit like saying &quot;true in all cases&quot; for the predicate.</p>
</blockquote>
<p>Now fire up the cds REPL with the <code>--run</code> option pointing to the current directory (which should therefore see the engine pick up this <code>schema.cds</code> file):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds r <span class="token parameter variable">-r</span> <span class="token builtin class-name">.</span>
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.7</span>.2
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">7</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:

  schema.cds
  bookshop/index.cds
  bookshop/srv/user-service.cds
  bookshop/srv/cat-service.cds
  bookshop/srv/admin-service.cds
  bookshop/db/schema.cds
  node_modules/@sap/cds/common.cds

<span class="token punctuation">..</span>.

------------------------------------------------------------------------
Following variables are made available <span class="token keyword">in</span> your repl's global context:

from cds.entities: <span class="token punctuation">{</span>
  Schema,
<span class="token punctuation">}</span>

from cds.services: <span class="token punctuation">{</span>
  db,
  CatalogService,
  AdminService,
  UserService,
<span class="token punctuation">}</span>

Simply <span class="token builtin class-name">type</span> e.g. UserService <span class="token keyword">in</span> the prompt to use the respective objects.</code></pre>
<p>In the cds REPL, try this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT FROM Schema:Authors</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// just like &lt;deity> ultimately intended</span></code></pre>
<p>So, what's the outcome? At first, a little underwhelming:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre>
<p>But with the understanding we've gained from this episode, we know how things work in theory (associations between relations) and practice (how the compiler will form the appropriate SQL statement out of whatever expressions of art and ideals we choose to make in our CQL explorations of that theory).</p>
<p>And what's missing becomes clear when we allow our minds to chew things over<a href="#footnotes"><sup>10</sup></a>: <em>There's no data at the <code>Schema</code> level, i.e. nothing in the &quot;lookup table&quot;, so there's going to be no chance of even getting started to follow that to-many association path down to <code>Authors</code>!</em></p>
<p>So remedy that (and in fact this remedy was hiding in plain sight when Daniel <a href="/blog/posts/2025/02/07/tasc-notes-part-7/#wrapping-up-with-relational-algebra">first introduced it in part 7</a>):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> <span class="token constant">INSERT</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>Schema<span class="token punctuation">)</span></code></pre>
<p>(even passing an empty object <code>{}</code> to <code>INSERT</code> would work here)</p>
<p>Now try that again (reducing the output with a postfix projection):</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select from Schema:Books { title }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>Bingo!</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>💥</p>
<p>The CDS model, and CQL as its language, is really based on decades of theory and practice, and we all benefit.</p>
<hr>
<p>That's the end of the notes for this episode. If you made it all the way here, please put a comment below to tell me, and thank you for reading!</p>
<hr>
<h2 id="appendix-fully-qualified-names-and-reflected-variables">Appendix - Fully qualified names and reflected variables</h2>
<p>In Daniel's demo the unqualified <code>Authors</code> entity name was used, which is why it didn't work<a href="#footnotes"><sup>5</sup></a> at the time. The fully qualified name <code>sap.capire.bookshop.Authors</code> is needed.</p>
<p>If this is too cumbersome, remember that you have the automatically reflected entities in the cds REPL:</p>
<pre class="language-text" tabindex="0"><code class="language-text">Following variables are made available in your repl's global context:

from cds.entities: {
  Books,
  Authors,
  Genres,
}</code></pre>
<p>So</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">authors <span class="token operator">=</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Authors<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> { ID, name, books { title as book } }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>would work nicely too (noting here that <a href="#universes-and-variables">we redefined the value for <code>Authors</code> earlier</a>, but to the same value :-)).</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<ol>
<li>
<p>You might also be interested to know that forward declared joins are a core part of <a href="https://patents.google.com/patent/US10599650B2/en">patent US10599650B2 &quot;Enhancements for forward joins expressing relationships&quot;</a>, on which Daniel is named as a co-inventor.</p>
</li>
<li>
<p>The thought of moving away from query languages towards ORMs and the complexities that come with them &quot;merely&quot; because of the struggle with JOIN syntax reminds me of the classic <a href="https://en.wikipedia.org/wiki/Jamie_Zawinski">Jamie Zawinski</a> quote: <em>Some people, when confronted with a problem, think &quot;I know, I'll use regular expressions&quot;. Now they have two problems</em>.</p>
</li>
<li>
<p>Sorry, I couldn't resist that juxtaposition.</p>
</li>
<li>
<p>Pseudocode yes but also deliberately expressed to remind ourselves of what a relvar (<code>Authors</code> in this case) is, i.e. something that points (<code>-&gt;</code>) to a relation (here represented by an ad hoc set of attributes).</p>
</li>
<li>
<p>Not because of any breakage in the &quot;infer&quot; code.</p>
</li>
<li>
<p>Yes, I couldn't resist referencing the Cunningham &amp; Cunningham wiki, the home of the creator of the wiki Ward Cunningham and indeed <a href="/blog/posts/2024/11/29/tasc-notes-part-3/">already mentioned in the notes to part 3 of this series</a> too.</p>
</li>
<li>
<p>Once a Classics (Latin &amp; Greek) scholar, always a Classics scholar, natch.</p>
</li>
<li>
<p><a href="/blog/posts/2024/01/22/accuracy-and-precision-in-language/">Beyond the basics, with which folks still seem to be struggling</a>.</p>
</li>
<li>
<p>Whom I've met a couple of times in my erstwhile role as speaker at the fantastic Foo Camp, Perl Conferences and Open Source Convention (OSCON) conferences, and as member of the Perl community.</p>
</li>
<li>
<p>It was the end of the day and I struggled a little with this, until I took a nap. And I woke up with the answer, realising what problem had been!</p>
</li>
</ol>
<hr>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/02/14/tasc-notes-part-8/">TASC Notes - Part 8</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/03/10/migrating-github-issue-based-url-bookmarks-to-wallabag/">Migrating GitHub issue based URL bookmarks to wallabag</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/02/21/tasc-notes-part-9/` was built on 2025-11-11T15:47:07.616Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
