<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>TASC Notes - Part 8</title>
		<meta name="description" content="These are the notes summarising what was covered in The Art and Science of CAP part 8, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="TASC Notes - Part 8">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="These are the notes summarising what was covered in The Art and Science of CAP part 8, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/02/14/tasc-notes-part-8/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="tasc-notes-part-8">TASC Notes - Part 8</h1>

<ul class="post-metadata">
	<li><time datetime="2025-02-14">14 February 2025</time></li>
	<li><a href="/tags/tasc/" class="post-tag">tasc</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/handsonsapdev/" class="post-tag">handsonsapdev</a></li>
</ul>

<p class="post-description-main">These are the notes summarising what was covered in The Art and Science of CAP part 8, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.</p>

<p>For all resources related to this series, see the post <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">The Art and Science of CAP</a>.</p>
<p><a href="https://www.youtube.com/watch?v=FF1NzLwsmos">This episode</a> started with me rambling slightly more than usual as I attempted to locate Daniel, but <a href="https://youtu.be/AyS5cHO6JN0">suddenly, as if by magic, the shopkeeper appeared</a>.</p>
<p><img src="/images/2025/02/the-shopkeeper-appeared.png" alt="still image from the classic start scene in Mr Benn"></p>
<p>(This is the usual start scene from <a href="https://en.wikipedia.org/wiki/Mr_Benn">Mr Benn</a>, one of my favourite TV programmes as a young child in the early 1970's, and the phrase above has stuck in my mind ever since).</p>
<p>We took slightly longer to review and discuss <a href="/blog/posts/2025/02/07/tasc-notes-part-7/">the notes on the previous episode (part 7)</a>, as there were some super eye openers that were worth revisiting, not least the beautiful reveal of the parallel between functional programming and aspect oriented techniques, and the proper way to extend entities.</p>
<h2 id="the-relational-model">The relational model</h2>
<p>At <a href="https://www.youtube.com/live/FF1NzLwsmos?t=1430">23:50</a> Daniel dives back into where we left off in the previous episode, to dwell a little on some important theory in the form of the <a href="https://en.wikipedia.org/wiki/Relational_model">Relational Model</a>.</p>
<p>At first glance, this seems like hard and somewhat dry theory, but it's important for the foundations of CAP, and while it may not help us in our day to day application development work, it will help us build a solid basis of understanding. It's equally if not more important for Daniel and the CAP team building out the framework to ensure that - in and of itself - CAP follows sensible principles that have come before, that have arisen from the hard graft of our large-brained computing predecessors.</p>
<p>In particular, Daniel wanted to ensure that the extensions to SQL making CQL a superset, in particular nested projections and path expressions, still conformed to the Relational Model approach to data modelling, storage and retrieval.</p>
<h3 id="what-is-a-relvar">What is a relvar?</h3>
<p>I struggled initially to properly grok the meaning and significance of the term &quot;relvar&quot;. Building on the context ably set by Daniel in this episode, I found my curiosity getting the better of me (as it always does) and embarked upon a voyage of discovery, starting at that <a href="https://en.wikipedia.org/wiki/Relational_model">Relational Model</a> Wikipedia page.</p>
<p>What moved me closer to understanding &quot;relvar&quot; was to realise that the terms I've always used for artifacts and concepts in relational database systems and operations ... are not entirely formal. A relvar, short for relation variable, is from the strictly formal terminology set where:</p>
<ul>
<li>tables (or views) are called <em>relations</em></li>
<li>a table's columns (fields) are called <em>attributes</em></li>
<li>records (or rows) are called <em>tuples</em></li>
</ul>
<p>Consequently, a name referring to a table (a relation), such as &quot;Customers&quot;, or &quot;Foo&quot; is called a <em>relation variable</em>. This is clarified in the Wikipedia page <a href="https://www.oreilly.com/library/view/relational-theory-for/9781449365431/">with reference to Date</a>, thus:</p>
<blockquote>
<p>At any given time, all information in the database is represented solely by values within <strong>tuples</strong>, corresponding to <strong>attributes</strong>, in <strong>relations</strong> identified by relvars</p>
</blockquote>
<p>(emphasis mine).</p>
<p>Moreover, the term &quot;relational variable&quot; <a href="https://en.wikipedia.org/wiki/Relvar">was introduced</a> in a work by Date and Darwen: <a href="https://archive.org/embed/databasestypesre0003date">Databases, Types, and The Relational Model: The Third Manifesto</a>.</p>
<p><img src="/images/2025/02/book-sample.png" alt="two pages of the book"></p>
<p>This work is available online thanks to the wonderful Internet Archive's online lending library, and in Chapter 2 &quot;A Survey of the Relational Model&quot; we see a definition of a sample relation (table) <code>S</code> to hold supplier information:</p>
<pre class="language-text" tabindex="0"><code class="language-text">VAR S REAL RELATION
  { S# S#, SNAME NAME, STATUS INTEGER, CITY CHAR }
    KEY { S# };</code></pre>
<p>This definition helps cement the concept of a relvar through the <code>VAR</code> &quot;assignment&quot; or &quot;association&quot; of a relation definition (<code>{ ... }</code>) to a name <code>S</code>. So we can think of a relvar as a symbol that can reference different values at different times, where the values are actually what we'd normally refer to as &quot;tables&quot; or &quot;views&quot;, formally called relations, and the data that they contain, and that we can query.</p>
<h3 id="exploring-in-sqlite">Exploring in SQLite</h3>
<p>Digging in a little more, Daniel, ever local-first, opens the SQLite prompt, which is quite like a REPL itself. He defines a table (relation), and then a view (also a relation), and then uses SQL to add data (a tuple) to the table:</p>
<pre class="language-text" tabindex="0"><code class="language-text">sqlite> create table foo ( a,b,c );
sqlite> create view bar as select * from foo;
sqlite> insert into foo values ( 1,2,3 );</code></pre>
<p>While a view is a projection, it is still in essence a table, a relation, in that it contains data.</p>
<p>Next, Daniel summons the god of meta, with:</p>
<pre class="language-text" tabindex="0"><code class="language-text">sqlite> select * from sqlite_schema;
table|foo|foo|2|CREATE TABLE foo ( a,b,c )
view|bar|bar|0|CREATE VIEW bar as select * from foo</code></pre>
<p>This is a little easier to comprehend if we look at the <a href="https://www.sqlite.org/schematab.html">SQLite schema table reference</a>:</p>
<pre class="language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sqlite_schema<span class="token punctuation">(</span>
  <span class="token keyword">type</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  name <span class="token keyword">text</span><span class="token punctuation">,</span>
  tbl_name <span class="token keyword">text</span><span class="token punctuation">,</span>
  rootpage <span class="token keyword">integer</span><span class="token punctuation">,</span>
  <span class="token keyword">sql</span> <span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In fact, we can use the SQLite REPL command <code>.headers on</code><a href="#footnotes"><sup>1</sup></a> so that output like this is simpler to understand:</p>
<pre class="language-text" tabindex="0"><code class="language-text">sqlite> .headers on
sqlite> select * from sqlite_schema;
type|name|tbl_name|rootpage|sql
table|foo|foo|2|CREATE TABLE foo ( a,b,c )
view|bar|bar|0|CREATE VIEW bar as select * from foo</code></pre>
<p>Having examined the definitions of the fields in <code>sqlite_schema</code>, we can interpret these two records (or tuples, to use formal parlance) as:</p>
<ul>
<li><code>foo --&gt; table(CREATE TABLE foo ( a,b,c )</code></li>
<li><code>bar --&gt; view(CREATE VIEW bar as select * from foo</code></li>
</ul>
<p>where the <code>--&gt;</code> arrows indicate reference, associating the relvars with the relations.</p>
<h2 id="local-development-submodules-and-workspaces">Local development, submodules and workspaces</h2>
<p>While we've <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#the-run-command">talked briefly about monorepos</a> previously in this series, it's worth revisiting for a second here too, where at around <a href="https://www.youtube.com/live/FF1NzLwsmos?t=1770">29:30</a> Daniel outlines his local development setup which is based on an &quot;umbrella&quot; Node.js project using submodules and workspaces.</p>
<p><img src="/images/2025/02/local-development.png" alt="local development"></p>
<p>The huge advantage to this approach is that you have everything at hand, locally. You can read more on the approaches used:</p>
<ul>
<li><a href="https://github.blog/open-source/git/working-with-submodules/">Working with submodules</a></li>
<li><a href="https://docs.npmjs.com/cli/v8/using-npm/workspaces">NPM workspaces</a> (also covered in the recent <a href="/blog/posts/2024/12/30/cap-node.js-plugins/">series on CAP Node.js Plugins</a> - see <a href="/blog/posts/2024/10/05/cap-node.js-plugins-part-1-how-things-work/#creating-our-own-plugin-package">Creating our own plugin package</a> in the notes to part 1 of that series)</li>
</ul>
<p>Daniel highlights a particular advantage of embracing workspaces: not having to connect to the cloud when building a constellation of interdependent microservices; rather, everything can be developed locally. &quot;Like having your own private NPM registry&quot;, too.</p>
<p>And in explaining how he works with application projects in the context of his development &quot;environment&quot; (directory and file structure), I learned today how Node.js searches for modules: not just in the project's <code>node_modules/</code> directory, but &quot;upwards&quot; through the directory hierarchy too. This is explained nicely in <a href="https://nodejs.org/api/modules.html#modules_loading_from_node_modules_folders">Loading from node_modules folders</a>, and we can see how that works in Daniel's context here:</p>
<p><img src="/images/2025/02/node-module-search-ascent.png" alt="Daniel's directory and file structure"></p>
<blockquote>
<p>Daniel pointed out here that <code>cdr/</code> was the very first implementation of CAP from 2016, where he was working along on it; and it stands for &quot;CDS Done Right&quot; :-)</p>
</blockquote>
<p>Here, for the example application repository &quot;nexus&quot; cloned into the <code>verse/</code> directory, Node.js will search for modules in a <code>node_modules/</code> directory:</p>
<ol>
<li>in the <code>nexus/</code> directory itself (not found)</li>
<li>in the containing <code>verse/</code> directory (also not found)</li>
<li>in the directory that contains <code>verse/</code> (which is <code>cap/</code>)</li>
</ol>
<p>At this point, because of the symbolic link (identified in the screenshot as <code>node_modules@</code>) that points to the <code>node_modules/</code> directory inside of the <code>dev/</code> directory, the CAP modules are found and loaded, from exactly where Daniel wants them loaded, from his local copy of whatever version of CAP he's working on or managing at that time.</p>
<pre class="language-text" tabindex="0"><code class="language-text">$HOME/
|
+- cap/
   |
   +- dev/
   |  |
   |  +-- node_modules/ --+
   |                      |
   +- node_modules@ ------+
   |
   +- verse/
      |
      +- nexus/</code></pre>
<p>Node.js, <a href="https://www.youtube.com/watch?v=c3MzYIo0Wxc">unlike dogs ... according to Big Al</a>, <em>can</em> look up.</p>
<p>To underline the utility and convenience of this structure and approach, Daniel starts the cds REPL with the <code>--run</code> option (shortened to <code>-r</code>) specifying ... the <em>package</em> (module) name, not the directory name:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">[</span>cap/cakes<span class="token punctuation">]</span> cds r <span class="token parameter variable">-r</span> @capire/bookshop
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.8</span>.0
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">5</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:

  <span class="token punctuation">..</span>/dev/cap/samples/bookshop/srv/user-service.cds
  <span class="token punctuation">..</span>/dev/cap/samples/bookshop/srv/cat-service.cds
  <span class="token punctuation">..</span>/dev/cap/samples/bookshop/srv/admin-service.cds
  <span class="token punctuation">..</span>/dev/cap/samples/bookshop/db/schema.cds
  <span class="token punctuation">..</span>/dev/cds/common.cds
</code></pre>
<p>Note the locations of each of these five loaded files!</p>
<h2 id="queries-declare-relations">Queries declare relations!</h2>
<p>Daniel started the cds REPL at around <a href="https://www.youtube.com/live/FF1NzLwsmos?t=2146">36:45</a> with the &quot;bookshop&quot; service to have something concrete with which to illustrate the close proximity of CAP (and CDS and CQL in particular) to the formal relational model.</p>
<p>Consider this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID,name from Authors</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>Here, <code>Authors</code> is the name of an entity, in CDS model terms. It also happens to be a table (at the <a href="#exploring-in-sqlite">persistence layer level</a>).</p>
<p>But critically, this is (almost) a <em>relvar</em>.</p>
<p>What's returned ... is a set of <em>tuples</em> (four, in this case):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Emily Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Charlotte Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Richard Carpenter' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>each containing the attributes <code>ID</code> and <code>name</code>.</p>
<p>Now consider this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID,name,books.title from Authors</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>Spot the <code>books.title</code> path expression?</p>
<p>This is what's returned:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Emily Brontë'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Charlotte Brontë'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span> books_title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>The result is another set of tuples, where the path expression has been materialised into just another attribute <code>books_title</code> (regardless of any SQL details going on under the surface to make this happen). This result set is ... a <em>relation</em>.</p>
<p>But it's not a relation pre-declared like <code>S</code> (see <a href="#what-is-a-relvar">What is a relvar?</a> earlier); it's a relation declared ad hoc <em>with the query</em>.</p>
<p>In SQL (and consequently CQL): queries describe (declare) relations.</p>
<p>So, thinking back to the concept of relvars, is this query the relvar?</p>
<pre class="language-text" tabindex="0"><code class="language-text">                          [
                            { ID: 101, name: 'Emily ...
                            { ID: 107, name: 'Charlo...
SELECT              ---->   { ID: 150, name: 'Edgar ...
ID,name,books.title         { ID: 150, name: 'Edgar ...
from Authors                { ID: 170, name: 'Richar...
                          ]</code></pre>
<p>Almost, but not quite. But we can store that query in a variable<a href="#footnotes"><sup>2</sup></a>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">myAuthors <span class="token operator">=</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID,name,books.title from Authors</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>and then that variable <code>myAuthors</code> is the relvar:</p>
<pre class="language-text" tabindex="0"><code class="language-text">myAuthors                 [
  |                         { ID: 101, name: 'Emily ...
  V                         { ID: 107, name: 'Charlo...
SELECT              ---->   { ID: 150, name: 'Edgar ...
ID,name,books.title         { ID: 150, name: 'Edgar ...
from Authors                { ID: 170, name: 'Richar...
                          ]</code></pre>
<p>And if we <a href="/blog/posts/2024/12/20/tasc-notes-part-6/#awaitable-queries-and-thenables">use await</a> to reify that relvar, we get the relation.</p>
<h2 id="relations-attributes-and-values">Relations, attributes and values</h2>
<p>When reifying a relation you're essentially expecting a set of tuples containing values. What happens when the attribute projection of an element expressed in a query doesn't have a value? What does that even mean? Well, Daniel illustrates this next by digging in a little deeper to the managed associations between <code>Books</code> and <code>Authors</code> here.</p>
<p>But let's back up a second to re-familiarise ourselves with the <code>Books</code> and <code>Authors</code> entities in the <a href="https://github.com/SAP-samples/cloud-cap-samples/tree/main/bookshop">bookshop sample</a>. Here's a very simplified pair of entities in a <code>simple-schema.cds</code> file:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">entity</span> Books : {
  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
  title  : <span class="token type builtin">String</span>;
  author : <span class="token association-composition keyword">Association to Authors</span>;
}

<span class="token keyword">entity</span> Authors : {
  <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
  name  : <span class="token type builtin">String</span>;
  books : <span class="token association-composition keyword">Association to many Books</span> <span class="token cqlkeywords keyword">on</span> books.author = $self;
}</code></pre>
<p>The to-one managed association in <code>Books</code> causes a foreign key style element <code>author_ID</code> to be generated automatically. The to-many association in <code>Authors</code>, in contrast, does not.</p>
<blockquote>
<p>If you think of these associations in terms of &quot;left&quot; and &quot;right&quot;, to-one associations have the pointer value (the foreign key) on the left hand side, the &quot;source&quot; side, and to-many associations have the value on the right hand side, the &quot;target&quot; side.</p>
</blockquote>
<p>This can be seen clearly if we ask the compiler to show us the DDL, for example:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds compile <span class="token parameter variable">--to</span> sql simple-schema.cds

CREATE TABLE Books <span class="token punctuation">(</span>
  ID INTEGER NOT NULL,
  title NVARCHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
  author_ID INTEGER,
  PRIMARY KEY<span class="token punctuation">(</span>ID<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE Authors <span class="token punctuation">(</span>
  ID INTEGER NOT NULL,
  name NVARCHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
  PRIMARY KEY<span class="token punctuation">(</span>ID<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We are also likely to spot this in <a href="https://cap.cloud.sap/docs/guides/databases#using-csv-files">when creating CSV data</a>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds <span class="token function">add</span> data <span class="token parameter variable">--out</span> data <span class="token operator">&amp;&amp;</span> <span class="token function">head</span> <span class="token parameter variable">-1</span> data/*
Adding feature <span class="token string">'data'</span><span class="token punctuation">..</span>.
  Creating data/Authors.csv
  Creating data/Books.csv

Successfully added features to your project.
<span class="token operator">==</span><span class="token operator">></span> data/Authors.csv <span class="token operator">&lt;=</span><span class="token operator">=</span>
ID,name
<span class="token operator">==</span><span class="token operator">></span> data/Books.csv <span class="token operator">&lt;=</span><span class="token operator">=</span>
ID,title,author_ID</code></pre>
<p>We can see the <code>author_ID</code> field in the header of the <code>Books.csv</code> file. There is no equivalent in the <code>Authors.csv</code> file.</p>
<p>With this in mind, let's turn back now to what Daniel shows us, which starts with an innocent-enough looking query:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID,name,books from Authors</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>What's returned, however, is not quite what we might be expecting:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Emily Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Charlotte Brontë' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Edgar Allen Poe' <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span> name<span class="token operator">:</span> 'Richard Carpenter' <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Related but not the same as the request for <code>books.title</code> made earlier, we're now asking for <code>books</code>. What is that? It's the representation of the entire to-many managed association ... which does not (can not, really) have a (scalar) value.</p>
<p>In contrast, regard this query on the <code>Books</code> entity:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT ID,name,author from Books</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>Here, we're still requesting values for an association (<code>author</code>) but this time it's a to-one association, which <em>does</em> have a scalar value that can be surfaced. Yes, the value of the foreign key, i.e. the value of <code>author_ID</code>:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights'<span class="token punctuation">,</span> author_ID<span class="token operator">:</span> <span class="token number">101</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre'<span class="token punctuation">,</span> author_ID<span class="token operator">:</span> <span class="token number">107</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora'<span class="token punctuation">,</span> author_ID<span class="token operator">:</span> <span class="token number">150</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven'<span class="token punctuation">,</span> author_ID<span class="token operator">:</span> <span class="token number">150</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle'<span class="token punctuation">,</span> author_ID<span class="token operator">:</span> <span class="token number">170</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>In the context of SQL being the real world representation of relations, in the end, we also can think about how foreign keys, the &quot;coupling&quot; in to-one association, become the values of the references that are surfaced in reifying such ad hoc relations. Before that, associations are &quot;just pointer-shaped ideas&quot;.</p>
<h3 id="postfix-projections-and-set-theory">Postfix projections and set theory</h3>
<p>Now we're more comfortable with the concept of &quot;pointers&quot; in the relational model and how it is respected in CAP, here's something that will blow your mind in a hopefully similar way to which it was in the previous part where the parallel between functional programming, aspects and entity extensions was revealed (see the <a href="/blog/posts/2025/02/07/tasc-notes-part-7/#reflection-in-cds-modelling">Reflections in CDS modelling</a> section).</p>
<p>First, consider the alternative way of expressing the prefix projection style query <code>SELECT ID,name,books from Authors</code> - the so-called postfix projection style of expression:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from Authors { ID, name, books }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>At one level, we might think of this as mere syntactic sugar. But with the relational model theory in mind, we can adopt this style of expression as a better way of thinking about the model in general.</p>
<p>Adding an arrow to represent the pointer in this relationship:</p>
<pre class="language-text" tabindex="0"><code class="language-text">Authors -> { ID, name, books }</code></pre>
<p>allows us to think about this, with respect to <code>Authors</code>, as follows (in Daniel's words): &quot;<em>from all your children (tuples), we want these attributes</em>&quot;.</p>
<p>So far so good. But we're now in a better position to project that thinking to the next level, thus:</p>
<pre class="language-text" tabindex="0"><code class="language-text">Authors -> { ID, name, books -> { ID, title } }</code></pre>
<p>While in relational model terms <code>Authors</code> and <code>books</code> are relvars, in terms of <a href="https://en.wikipedia.org/wiki/Set_theory">set theory</a> they are sets, and the &quot;books for the current Author&quot; is part of that theory, as is how CAP extends SQL to CQL in that context to allow for such <a href="/blog/posts/2025/02/07/tasc-notes-part-7/#wrapping-up-with-relational-algebra">nested projections</a> relations<a href="#footnotes"><sup>3</sup></a> and expressions thereof.</p>
<p>Behold:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span>ql <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT from Authors { ID, name, books { ID, title } }</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>which produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Emily Brontë'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Wuthering Heights' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Charlotte Brontë'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Jane Eyre' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Edgar Allen Poe'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'The Raven' <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Eleonora' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ID<span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> 'Richard Carpenter'<span class="token punctuation">,</span>
    books<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> 'Catweazle' <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Spot the nesting also in the result set - there are two books from Mr Poe, and (to use relational model terms) both are returned in the <em>set of tuples</em> for the <code>books</code> <em>attribute</em> projected from the pointer <em>attribute</em> in the corresponding <code>Author</code> <em>tuple</em>.</p>
<h3 id="the-universe-of-discourse-and-correlated-subqueries">The universe of discourse and correlated subqueries</h3>
<p>Rounding out this mind-expanding episode, Daniel notes that the concept of the &quot;universe of discourse&quot; (alternatively called the <a href="https://en.wikipedia.org/wiki/Domain_of_discourse">domain of discourse</a>), the set of entities over which values may range, is an appropriate theoretical construct in which to think about how these values (from the nested projections) exist.</p>
<p>And where the rubber meets the road, how are such expressions materialised? How does CAP go from the value of a relvar (which all along, here, has been the query expression) to the ad hoc relation which it represents?</p>
<p>By means of <a href="https://en.wikipedia.org/wiki/Correlated_subquery">correlated subqueries</a>.</p>
<p>But what are they and where are they used?</p>
<p>Well, asking the runtime to give us an insight into what it's doing, specifically with respect to SQL, we get a glimpse. Restarting the cds REPL at around <a href="https://www.youtube.com/live/FF1NzLwsmos?t=3002">50:02</a> with the <code>DEBUG</code> environment variable set appropriately, Daniel demonstrates:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">[</span>cap/cakes<span class="token punctuation">]</span> <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>sql cds r <span class="token parameter variable">-r</span> @capire/bookshop
<span class="token operator">></span> await cds.ql <span class="token variable"><span class="token variable">`</span>SELECT from Authors <span class="token punctuation">{</span> ID, name, books <span class="token punctuation">{</span> ID, title <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token variable">`</span></span>
<span class="token punctuation">[</span>sql<span class="token punctuation">]</span> - BEGIN
<span class="token punctuation">[</span>sql<span class="token punctuation">]</span> - SELECT json_insert<span class="token punctuation">(</span><span class="token string">'{}'</span>,<span class="token string">'$."ID"'</span>,ID,<span class="token string">'$."name"'</span>,name,<span class="token string">'$."books"'</span>,books-<span class="token operator">></span><span class="token string">'$'</span><span class="token punctuation">)</span> as _json_ FROM
<span class="token punctuation">(</span>SELECT Authors.ID,Authors.name,<span class="token punctuation">(</span>SELECT jsonb_group_array<span class="token punctuation">(</span>jsonb_insert<span class="token punctuation">(</span><span class="token string">'{}'</span>,<span class="token string">'$."ID"'</span>,ID,<span class="token string">'$."title"'</span>,
title<span class="token punctuation">))</span> as _json_ FROM <span class="token punctuation">(</span>SELECT books.ID,books.title FROM sap_capire_bookshop_Books as books WHERE
Authors.ID <span class="token operator">=</span> books.author_ID<span class="token punctuation">))</span> as books FROM sap_capire_bookshop_Authors as Authors<span class="token punctuation">)</span>
<span class="token punctuation">[</span>sql<span class="token punctuation">]</span> - COMMIT
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    ID: <span class="token number">101</span>,
    name: <span class="token string">'Emily Brontë'</span>,
    books: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">201</span>, title: <span class="token string">'Wuthering Heights'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span>
    ID: <span class="token number">107</span>,
    name: <span class="token string">'Charlotte Brontë'</span>,
    books: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">207</span>, title: <span class="token string">'Jane Eyre'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span>
    ID: <span class="token number">150</span>,
    name: <span class="token string">'Edgar Allen Poe'</span>,
    books: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">251</span>, title: <span class="token string">'The Raven'</span> <span class="token punctuation">}</span>, <span class="token punctuation">{</span> ID: <span class="token number">252</span>, title: <span class="token string">'Eleonora'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token punctuation">{</span>
    ID: <span class="token number">170</span>,
    name: <span class="token string">'Richard Carpenter'</span>,
    books: <span class="token punctuation">[</span> <span class="token punctuation">{</span> ID: <span class="token number">271</span>, title: <span class="token string">'Catweazle'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>This is what I call the &quot;swan effect&quot;: what we see is graceful elegance, what we don't see is the furious paddling under the surface.</p>
<p><img src="/images/2025/02/swan.jpg" alt="picture of a swan"></p>
<p><em>A mute swan, picture courtesy of <a href="https://commons.wikimedia.org/wiki/File:CygneVaires.jpg">Wikimedia Commons</a></em></p>
<p>The graceful elegance of <code>SELECT from Authors { ID, name, books { ID, name } }</code> is only possible because of the furious paddling going on under the covers - here's that SQL statement from the DEBUG output in a more readable format:</p>
<pre class="language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">SELECT</span>
  json_insert<span class="token punctuation">(</span>
    <span class="token string">'{}'</span><span class="token punctuation">,</span> <span class="token string">'$."ID"'</span><span class="token punctuation">,</span> ID<span class="token punctuation">,</span> <span class="token string">'$."name"'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span>
    <span class="token string">'$."books"'</span><span class="token punctuation">,</span> books <span class="token operator">-</span><span class="token operator">></span> <span class="token string">'$'</span>
  <span class="token punctuation">)</span> <span class="token keyword">as</span> _json_
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
      Authors<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
      Authors<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
          jsonb_group_array<span class="token punctuation">(</span>
            jsonb_insert<span class="token punctuation">(</span>
              <span class="token string">'{}'</span><span class="token punctuation">,</span> <span class="token string">'$."ID"'</span><span class="token punctuation">,</span> ID<span class="token punctuation">,</span> <span class="token string">'$."title"'</span><span class="token punctuation">,</span> title
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token keyword">as</span> _json_
        <span class="token keyword">FROM</span>
          <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span>
              books<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
              books<span class="token punctuation">.</span>title
            <span class="token keyword">FROM</span>
              sap_capire_bookshop_Books <span class="token keyword">as</span> books
            <span class="token keyword">WHERE</span>
              Authors<span class="token punctuation">.</span>ID <span class="token operator">=</span> books<span class="token punctuation">.</span>author_ID
          <span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token keyword">as</span> books
    <span class="token keyword">FROM</span>
      sap_capire_bookshop_Authors <span class="token keyword">as</span> Authors
  <span class="token punctuation">)</span></code></pre>
<p>Briefly:</p>
<ul>
<li>Retrieval of <code>books</code> is achieved via a SQL subselect (<code>SELECT Authors.ID, Authors.name ( the-subselect ) as books FROM sap_capire_bookshop_Authors as Authors</code>)</li>
<li>SQL subselects are normally allowed only when the result is scalar</li>
<li>But CAP maps nested projections into SQL subselects that return a set, i.e. that are not scalar</li>
<li>The set that is to be returned is &quot;turned into&quot; a scalar (thus legitimising this SQL subselect) with the <code>jsonb_group_array</code> function<a href="#footnotes"><sup>4</sup></a> which creates a stringified JSON structure</li>
<li>Further up the call stack, above the execution of this query, this stringified JSON is turned back into the set that is, in reality, the shape, or form, in which we expect the &quot;real&quot; value to exist</li>
</ul>
<p>By the way:</p>
<ul>
<li>The &quot;correlated&quot; part of this SQL subselect (subquery) is how the inner relation (<code>WHERE Authors.ID = books.author_ID</code>) refers to a value in the outer query (<code>SELECT Authors.ID</code>)</li>
</ul>
<h2 id="a-closure-easter-egg">A closure Easter Egg</h2>
<p>This is where this episode ends, having imparted a metric tonne of wonder and understanding both from the art and the science side of CAP. But did you notice? Daniel wasn't even done at this point - he left us with a small Easter Egg here, in showing us the nature of correlated subqueries.</p>
<p>What is that Easter Egg? Well, we've previously learned how some functional programming concepts such as pure functions play a key role in the layers that inform CAP's design and implementation. Well, here's another: did you notice how correlated subqueries are exactly like <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closures</a> (a technique for implementing lexically scoped name binding in languages with support for first class functions)? Let me know in the comments what you think.</p>
<p>As always, thanks for watching, and especially thanks for reading this far. See you in the next episode!</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<ol>
<li>
<p>Notice how these REPL commands have a similar structure (they begin with a <code>.</code>) to the Node.js / cds REPL.</p>
</li>
<li>
<p>Remember, queries are first class citizens - see <a href="/blog/posts/2024/12/16/functions-as-first-class-citizens-in-sicp-lecture-1a/">Functions as first class citizens in SICP Lecture 1A</a>.</p>
</li>
<li>
<p>For more on nested projections, you might enjoy <a href="/blog/posts/2024/07/12/turning-an-odata-expand-into-a-cds.ql-cql-query-with-a-projection-function-in-cap/">Turning an OData expand into a cds.ql CQL query with a projection function in CAP</a>.</p>
</li>
<li>
<p><code>jsonb_group_array</code> is an <a href="https://www.sqlite.org/json1.html#jgrouparrayb">array aggregate function</a> (the <code>b</code> in the name represents the &quot;binary&quot; version which is more efficient).</p>
</li>
</ol>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/02/07/tasc-notes-part-7/">TASC Notes - Part 7</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/02/21/tasc-notes-part-9/">TASC Notes - Part 9</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/02/14/tasc-notes-part-8/` was built on 2026-01-13T13:37:14.499Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
