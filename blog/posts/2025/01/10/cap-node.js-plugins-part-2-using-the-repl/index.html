<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2025/01/10/cap-node.js-plugins-part-2-using-the-repl/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>CAP Node.js plugins - part 2 - using the REPL | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="CAP Node.js plugins - part 2 - using the REPL"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2025/01/10/cap-node.js-plugins-part-2-using-the-repl/"><meta name="description" content="CAP Node.js plugins - part 2 - using the REPL 10 Jan 2025 | 9 min read This blog post accompanies part 2 of a three part series where we..."><meta property="og:description" content="CAP Node.js plugins - part 2 - using the REPL 10 Jan 2025 | 9 min read This blog post accompanies part 2 of a three part series where we..."><meta name="description" content="CAP Node.js plugins - part 2 - using the REPL 10 Jan 2025 | 9 min read This blog post accompanies part 2 of a three part series where we..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>CAP Node.js plugins - part 2 - using the REPL</h1><div class="post__details"><time datetime="2025-01-10">10 Jan 2025 </time><span>| </span><span>9 min read</span></div></header><main class="post__content"><p>This blog post accompanies part 2 of a three part series where we explore the CDS Plugin mechanism in CAP Node.js to find out how it works. In part 1 we looked at the plugin mechanism itself and how it worked. In this part we use the cds REPL to start our CAP service running and to explore it - to <em>introspect</em> it.</p><p>For information on the series and links to all resources, see the <a href="/blog/posts/2024/12/30/cap-node.js-plugins/">CAP Node.js Plugins</a> series post.</p><blockquote><p>The examples in this post are based on CAP Node.js at release 8.6 (<a href="https://cap.cloud.sap/docs/releases/dec24">December 2024</a>).</p></blockquote><p><a name="picking-up-from-where-we-left-off-last-time"></a></p><h2>Picking up from where we left off last time</h2><p>Now we have a sleketon plugin package set up and wired in (which we did in part 1), we can turn our attention to how they can be used to enhance the standard CAP service processing.</p><p>Let's have our plugin bring about some behaviour for a custom annotation we'll add to one of the elements in one of the entities in our <a href="/blog/posts/2024/10/05/cap-node.js-plugins-part-1-how-things-work/#setting-the-scene">service</a>.</p><p><a name="adding-a-custom-annotation"></a></p><h2>Adding a custom annotation</h2><p>If we annotate an element, for example the <code>genre</code> element of the <code>Books</code> entity, with <code>@loud</code>, that signifies that the value of that element should be returned in UPPER CASE.</p><p>Let's annotate <code>Books.genre</code> with <code>@loud</code> in the CDL definition so it looks like this:</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">service</span> Bookshop {<br>    <span class="token keyword">entity</span> Books {<br>        <span class="token cqlkeywords keyword">key</span> ID          : <span class="token type builtin">Integer</span>;<br>            title       : <span class="token type builtin">String</span>;<br>            <span class="token annotation important">@loud</span> genre : <span class="token type builtin">String</span>;<br>            stock       : <span class="token type builtin">Integer</span>;<br>    }<br>    <span class="token keyword">entity</span> Things {<br>        <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;<br>    }<br>}</code></pre><p>The idea is that the contents of the <code>genre</code> element should be converted to all capitals before being returned, so that the responses look like this (notice how &quot;SCIENCE FICTION&quot; is presented in all capitals, i.e. in a &quot;loud&quot; shouty fashion).</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"@odata.context"</span><span class="token operator">:</span> <span class="token string">"$metadata#Books"</span><span class="token punctuation">,</span><br>  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"The Hitchhiker's Guide To The Galaxy"</span><span class="token punctuation">,</span><br>      <span class="token property">"genre"</span><span class="token operator">:</span> <span class="token string">"SCIENCE FICTION"</span><span class="token punctuation">,</span><br>      <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">42</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre><p>This custom annotation won't have any adverse effect on the standard service provision, but it's available to us when we introspect the service and its makeup.</p><p>To see how this completely new and random annotation is handled in general, let's see what the CDS compiler makes of it. Let's ask for the YAML representation of the Core Schema Notation (CSN) for our CDS model:</p><pre class="language-shell"><code class="language-shell">cds compile <span class="token builtin class-name">.</span> <span class="token parameter variable">--to</span> yaml</code></pre><p>This is what we get:</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">definitions</span><span class="token punctuation">:</span><br>  <span class="token key atrule">Bookshop</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> service<span class="token punctuation">}</span><br>  <span class="token key atrule">Bookshop.Books</span><span class="token punctuation">:</span><br>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> entity<br>    <span class="token key atrule">elements</span><span class="token punctuation">:</span><br>      <span class="token key atrule">ID</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> cds.Integer<span class="token punctuation">}</span><br>      <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">type</span><span class="token punctuation">:</span> cds.String<span class="token punctuation">}</span><br>      <span class="token key atrule">genre</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">'@loud'</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> cds.String<span class="token punctuation">}</span><br>      <span class="token key atrule">stock</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">type</span><span class="token punctuation">:</span> cds.Integer<span class="token punctuation">}</span><br>  <span class="token key atrule">Bookshop.Things</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> entity<span class="token punctuation">,</span> <span class="token key atrule">elements</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">ID</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> cds.Integer<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><br><span class="token key atrule">meta</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">creator</span><span class="token punctuation">:</span> CDS Compiler v5.6.0<span class="token punctuation">,</span> <span class="token key atrule">flavor</span><span class="token punctuation">:</span> inferred<span class="token punctuation">}</span><br><span class="token key atrule">$version</span><span class="token punctuation">:</span> <span class="token number">2.0</span></code></pre><p>Note how our new annotation is captured and stored simply as a new property for the element, a property which has the annotation itself as the key and a boolean <code>true</code> as the value:</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">genre</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">'@loud'</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> cds.String<span class="token punctuation">}</span></code></pre><p>Using the annotation as the property key means that it won't clash with anything standard. This is so simple that it's easy to gloss over this detail and miss the beauty of the design here.</p><p><a name="starting-up-the-cds-repl-and-a-server-instance"></a></p><h2>Starting up the cds REPL and a server instance</h2><p>We can use the cds REPL to manually and interactively explore the service and everything it contains. The cds REPL has had some <a href="https://cap.cloud.sap/docs/releases/dec24#cds-repl-enhancements">recent enhancements in the December 2024</a> release, so we'll explore some of those throughout this session.</p><p>For now, though, there's a <a href="https://cap.cloud.sap/docs/node.js/cds-test">cds.test</a> library for writing tests for CAP Node.js services, and we can also <a href="https://cap.cloud.sap/docs/node.js/cds-test#using-cds-test-in-repl">use that library directly in the REPL</a> to great effect.</p><p>Let's start the REPL with <code>cds repl</code> and enter <code>const test = await cds.test()</code>. The output is what we see from a standard server startup, including the announcement from our fledgling plugin (see <a href="#appendix-a-turning-down-the-logging">Appendix A - Turning down the logging</a> on suppressing this by default). Here's a sample session output (the <code>&gt;</code> symbol is the REPL prompt character):</p><pre class="language-shell"><code class="language-shell">$ cds repl<br>Welcome to cds repl <span class="token function">v</span> <span class="token number">8.6</span>.0<br><span class="token operator">></span> const <span class="token builtin class-name">test</span> <span class="token operator">=</span> await cds.test<span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> - Starting up <span class="token punctuation">..</span>.<br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">1</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:<br><br>  services.cds<br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - connect to db <span class="token operator">></span> sqlite <span class="token punctuation">{</span> url: <span class="token string">':memory:'</span> <span class="token punctuation">}</span><br>  <span class="token operator">></span> init from data/Bookshop.Books.csv<br>/<span class="token operator">></span> successfully deployed to in-memory database.<br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - using auth strategy <span class="token punctuation">{</span><br>  kind: <span class="token string">'mocked'</span>,<br>  impl: <span class="token string">'node_modules/@sap/cds/lib/srv/middlewares/auth/basic-auth'</span><br><span class="token punctuation">}</span><br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - using new OData adapter<br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving Bookshop <span class="token punctuation">{</span> path: <span class="token string">'/odata/v4/bookshop'</span> <span class="token punctuation">}</span><br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - server listening on <span class="token punctuation">{</span> url: <span class="token string">'http://localhost:33821'</span> <span class="token punctuation">}</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - launched at <span class="token number">1</span>/10/2025, <span class="token number">1</span>:02:01 PM, version: <span class="token number">8.6</span>.0, in: <span class="token number">568</span>.775ms<br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - <span class="token punctuation">[</span> terminate with ^C <span class="token punctuation">]</span><br><span class="token operator">></span></code></pre><blockquote><p>The CAP server is started bound to a random port, rather than the default one. This is so it doesn't clash with a CAP server that you might already have running.</p></blockquote><blockquote><p>We're not actually interested in what's stored in the <code>test</code> constant, the assignment is made just to avoid the output of <code>cds.test()</code> being otherwise emitted in the REPL display and overwhelming us.</p></blockquote><p>At this point we can start <a href="https://cap.cloud.sap/docs/node.js/cds-ql">querying</a>:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> await SELECT <span class="token variable"><span class="token variable">`</span>title, genre<span class="token variable">`</span></span> .from <span class="token variable"><span class="token variable">`</span>Bookshop.Books<span class="token variable">`</span></span><br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    title: <span class="token string">"The Hitchhiker's Guide To The Galaxy"</span>,<br>    genre: <span class="token string">'Science Fiction'</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>But instead of querying the data, what we really want to do in this session is explore the service structure, bearing in mind that, usually, a service contains one or more entities, and those entities contain one or more elements (fields).</p><p><a name="new-repl-options"></a></p><blockquote><p>Instead of using <code>cds.test()</code> there are features introduced to the cds REPL in the December 2024 release which makes this more comfortable; use either of these approaches:</p><ul><li><code>cds repl --run .</code> in the project directory (<code>cds r -r .</code> is the short version)</li><li><code>.run .</code> at the REPL prompt</li></ul></blockquote><p><a name="exploring-the-cds-facade"></a></p><h2>Exploring the cds facade</h2><p>Just like we used the <code>cds</code> facade to discover the values of <code>cds.root</code> and <code>cds.home</code> <a href="https://cap.cloud.sap/docs/releases/dec24#cds-repl-enhancements">in part 1</a>, we can use it to look at the services.</p><p>Entering <code>cds.</code> and then hitting <code>&lt;Tab&gt;</code> a couple of times will cause the autocomplete facility to show what's on offer:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> cds.<br>cds.__proto__             cds.hasOwnProperty        cds.isPrototypeOf         cds.propertyIsEnumerable<br>cds.toLocaleString        cds.toString              cds.valueOf<br><br>cds.addListener           cds.eventNames            cds.getMaxListeners       cds.listenerCount<br>cds.listeners             cds.off                   cds.on                    cds.once<br>cds.prependListener       cds.prependOnceListener   cds.rawListeners          cds.removeAllListeners<br>cds.removeListener        cds.setMaxListeners<br><br>cds.Association           cds.Composition           cds.DatabaseService       cds.EventContext<br>cds.MessagingService      cds.RemoteService         cds.array                 cds.auth<br>cds.build                 cds.clone                 cds.constructor           cds.create<br>cds.delete                cds.disconnect            cds.emit                  cds.entities<br>cds.event                 cds.exit                  cds.foreach               cds.import<br>cds.in                    cds.insert                cds.lazified              cds.lazify<br>cds.localize              cds.odata                 cds.outboxed              cds.read<br>cds.reflect               cds.run                   cds.schema                cds.spawn<br>cds.stream                cds.struct                cds.transaction           cds.tx<br>cds.txs                   cds.unboxed               cds.update                cds.upsert<br><br>cds.ApplicationService    cds.Event                 cds.Request               cds.Service<br>cds.User                  cds.__esModule            cds._context              cds._edmProviders<br>cds._events               cds._eventsCount          cds._local                cds._log<br>cds._maxListeners         cds.app                   cds.assert                cds.builtin<br>cds.cli                   cds.compile               cds.compiler              cds.connect<br>cds.context               cds.db                    cds.debug                 cds.default<br>cds.deploy                cds.edmxs                 cds.entity                cds.env<br>cds.error                 cds.exec                  cds.extend                cds.get<br>cds.home                  cds.infer                 cds.linked                cds.load<br>cds.log                   cds.middlewares           cds.minify                cds.model<br>cds.options               cds.parse                 cds.plugins               cds.ql<br>cds.repl                  cds.requires              cds.resolve               cds.root<br>cds.serve                 cds.server                cds.service               cds.services<br>cds.shutdown              cds.test                  cds.type                  cds.utils<br>cds.version</code></pre><p>Some of these properties are from the standard JavaScript object mechanism, but some are CAP specific and made available as part of the facade.</p><p>That's one way to start to explore. Another is to use one of the <a href="https://cap.cloud.sap/docs/tools/cds-cli#cds-repl">cds REPL features</a>: <code>.inspect</code>, which has a <code>.depth</code> setting (the default value is 11, i.e. &quot;very deep!&quot;, but can be changed) that can specified explicitly on the fly too.</p><p>Let's use this to examine the facade:</p><pre class="language-log"><code class="language-log"><span class="token operator">></span> <span class="token punctuation">.</span>inspect cds <span class="token punctuation">.</span>depth<span class="token operator">=</span><span class="token number">0</span><br><span class="token property">cds:</span> cds <span class="token operator">{</span><br>  <span class="token property">_events:</span> <span class="token punctuation">[</span>Object<span class="token operator">:</span> <span class="token boolean">null</span> prototype<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">_eventsCount:</span> <span class="token number">6</span><span class="token punctuation">,</span><br>  <span class="token property">_maxListeners:</span> undefined<span class="token punctuation">,</span><br>  <span class="token property">model:</span> <span class="token punctuation">[</span>LinkedCSN<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">db:</span> <span class="token punctuation">[</span>SQLiteService<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">cli:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">root:</span> <span class="token string">'/workspaces/project'</span><span class="token punctuation">,</span><br>  <span class="token property">services:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">extend:</span> <span class="token punctuation">[</span>Function <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">version:</span> <span class="token string">'8.6.0'</span><span class="token punctuation">,</span><br><br>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><br>  <span class="token property">User:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">middlewares:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">shutdown:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> _shutdown<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span>Symbol<span class="token operator">(</span>shapeMode<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span>Symbol<span class="token operator">(</span>kCapture<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><br><span class="token operator">}</span></code></pre><p><a name="a-first-look-at-the-services"></a></p><h2>A first look at the service(s)</h2><p>If we enter <code>cds.services</code> at the REPL prompt, we'll see an avalanche of information, ending like this:</p><pre class="language-text"><code class="language-text">          ...<br><br>          Layer {<br>            handle: [Function (anonymous)],<br>            name: '<anonymous>',<br>            params: undefined,<br>            path: undefined,<br>            keys: [],<br>            regexp: /^\/?(?=\/|$)/i { fast_star: false, fast_slash: true },<br>            route: undefined<br>          }<br>        ],<br>        path: '/odata/v4/bookshop'<br>      }<br>    },<br>    path: '/odata/v4/bookshop',<br>    '$linkProviders': [ [Function (anonymous)] ]<br>  }<br>}</anonymous></code></pre><p>Good, but too much.</p><p>We can see from the closing brace that we can probably treat it as an object. Evaluating <code>typeof(cds.services)</code> confirms this:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> typeof<span class="token punctuation">(</span>cds.services<span class="token punctuation">)</span><br>object</code></pre><p>We can use standard JavaScript affordances to look at the keys. Let's try:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> Object.keys<span class="token punctuation">(</span>cds.services<span class="token punctuation">)</span><br><span class="token punctuation">[</span> <span class="token string">'db'</span>, <span class="token string">'Bookshop'</span> <span class="token punctuation">]</span></code></pre><p>You'd be right to guess that the first key represents the database service. And the second key points to the value that represents our <code>Bookshop</code> service.</p><p>We can confirm this as follows:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> Object.values<span class="token punctuation">(</span>cds.services<span class="token punctuation">)</span>.map<span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>x.name, x.kind<span class="token punctuation">]</span><span class="token punctuation">)</span><br><span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token string">'db'</span>, <span class="token string">'sqlite'</span> <span class="token punctuation">]</span>, <span class="token punctuation">[</span> <span class="token string">'Bookshop'</span>, <span class="token string">'app-service'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span></code></pre><blockquote><p>We could also achieve this by reifying <code>cds.services</code> as an array, like this: <code>[...cds.services].map(x =&gt; [x.name, x.kind])</code>. See later for more on the rest parameter syntax (<code>...</code>).</p></blockquote><p>In fact, this &quot;basic info&quot; of name and kind is going to be useful again shortly, so let's create a helper function thus:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">basicInfo</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>name<span class="token punctuation">,</span> x<span class="token punctuation">.</span>kind<span class="token punctuation">]</span></code></pre><p>We can use it like this: <code>[...cds.services].map(basicInfo)</code>.</p><p>Anyway, let's keep going. In CAP, <a href="https://cap.cloud.sap/docs/tools/cds-cli#cds-repl">everything is a service</a>, which explains why we see the SQLite database mechanism appearing here too. But we're interested in our <code>Bookshop</code> service, which incidentally has the <code>kind</code> value of <code>app-service</code>.</p><p><a name="digging-deeper-into-the-bookshop-service"></a></p><h2>Digging deeper into the Bookshop service</h2><p>To make it more convenient for us to work with, let's get a handle on that service object using a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destructuring assignment</a> like this:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> <span class="token punctuation">{</span> Bookshop <span class="token punctuation">}</span> <span class="token operator">=</span> cds.services</code></pre><p>Let's have a look at what's available in this service object, with <code>Object.keys(Bookshop)</code>:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> Object.keys<span class="token punctuation">(</span>Bookshop<span class="token punctuation">)</span><br><span class="token punctuation">[</span><br>  <span class="token string">'_handlers'</span>, <span class="token string">'name'</span>,<br>  <span class="token string">'options'</span>,   <span class="token string">'kind'</span>,<br>  <span class="token string">'model'</span>,     <span class="token string">'definition'</span>,<br>  <span class="token string">'namespace'</span>, <span class="token string">'operations'</span>,<br>  <span class="token string">'entities'</span>,  <span class="token string">'_datasource'</span>,<br>  <span class="token string">'endpoints'</span>, <span class="token string">'_adapters'</span>,<br>  <span class="token string">'path'</span>,      <span class="token string">'$linkProviders'</span><br><span class="token punctuation">]</span></code></pre><p>That's a good start, but we can also use the <code>.inspect</code> feature with the depth set to the &quot;shallowest&quot; value (0) to look at more or less the same information, but with more hints as to the nature of each of the properties, in a less generic JavaScript context and a more specific CAP context:</p><pre class="language-log"><code class="language-log"><span class="token operator">></span> <span class="token punctuation">.</span>inspect Bookshop <span class="token punctuation">.</span>depth<span class="token operator">=</span><span class="token number">0</span><br><br><span class="token property">Bookshop:</span> ApplicationService <span class="token operator">{</span><br>  <span class="token property">name:</span> <span class="token string">'Bookshop'</span><span class="token punctuation">,</span><br>  <span class="token property">options:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">kind:</span> <span class="token string">'app-service'</span><span class="token punctuation">,</span><br>  <span class="token property">model:</span> <span class="token punctuation">[</span>LinkedCSN<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">handlers:</span> <span class="token punctuation">[</span>EventHandlers<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">definition:</span> <span class="token punctuation">[</span>service<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">namespace:</span> <span class="token string">'Bookshop'</span><span class="token punctuation">,</span><br>  <span class="token property">actions:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> children<span class="token punctuation">]</span> LinkedDefinitions<span class="token punctuation">,</span><br>  <span class="token property">entities:</span> <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">endpoints:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">_adapters:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">path:</span> <span class="token string">'/odata/v4/bookshop'</span><span class="token punctuation">,</span><br>  <span class="token string">'$linkProviders'</span><span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><br><span class="token operator">}</span></code></pre><p>We want to dig down through the entities to the elements, so let's now examine the <code>entities</code> property.</p><p>If we start typing <code>Bookshop.entities</code> at the prompt we should see the REPL already start eagerly returning a value which represents a function that returns a <a href="https://cap.cloud.sap/docs/node.js/cds-reflect#iterable">LinkedDefinitions</a> object:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> Bookshop.entities<br><span class="token punctuation">{</span> <span class="token punctuation">[</span>Function: children<span class="token punctuation">]</span> LinkedDefinitions Books: entity <span class="token punctuation">{</span> kind: <span class="token string">'entity'</span>, elements: <span class="token punctuation">[</span>LinkedDefinitions<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre><blockquote><p>We already got a clue about this from the output above - the <code>entities</code> property was shown as being an array of <code>LinkedDefinitions</code>.</p></blockquote><p>So while we can't have that expression emit the entities directly (basically because it's an <em>iterable</em>), we can resolve them into an array with <code>...</code>, which is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/rest_parameters">rest parameter syntax</a>.</p><blockquote><p>Since the August 2024 release of CAP Node.js (8.2.1) this conversion to array is now required because of some <a href="https://cap.cloud.sap/docs/releases/aug24#changes-in-node-js">important changes made to LinkedDefinitions</a>.</p></blockquote><p>Let's do that now with <code>entities = [...Bookshop.entities]</code> which will also emit a summary of the value of the new <code>entities</code> variable created:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> entities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.Bookshop.entities<span class="token punctuation">]</span><br><span class="token punctuation">[</span><br>  entity <span class="token punctuation">{</span><br>    kind: <span class="token string">'entity'</span>,<br>    elements: LinkedDefinitions <span class="token punctuation">{</span><br>      ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,<br>      title: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>      genre: String <span class="token punctuation">{</span> <span class="token string">'@loud'</span><span class="token builtin class-name">:</span> true, type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>      stock: Integer <span class="token punctuation">{</span> type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span>,<br>  entity <span class="token punctuation">{</span><br>    kind: <span class="token string">'entity'</span>,<br>    elements: LinkedDefinitions <span class="token punctuation">{</span><br>      ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><blockquote><p>We can also use JavaScript's <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in"><code>for ... in</code></a> statement, or the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...of"><code>for ... of</code></a> statement, both of which can work with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols">iterables</a>, as can the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/rest_parameters">rest parameter syntax</a> here too.</p></blockquote><p>There are two entities in the <code>services.cds</code> file, and they are <code>Books</code> and <code>Things</code>. Therefore there are two elements in the <code>entities</code> array.</p><p>We can confirm that with <code>entities.length</code>:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> entities.length<br><span class="token number">2</span></code></pre><p><a name="looking-at-individual-entities-and-their-elements"></a></p><h2>Looking at individual entities and their elements</h2><p>Let's look at some of the aspects of the entities using our useful basic info function:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> entities.map<span class="token punctuation">(</span>basicInfo<span class="token punctuation">)</span><br><span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token string">'Bookshop.Books'</span>, <span class="token string">'entity'</span> <span class="token punctuation">]</span>, <span class="token punctuation">[</span> <span class="token string">'Bookshop.Things'</span>, <span class="token string">'entity'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span></code></pre><p>We can also examine the elements of the first entity (<code>Bookshop.Books</code>) like this:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> entities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.elements<br>LinkedDefinitions <span class="token punctuation">{</span><br>  ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,<br>  title: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>  genre: String <span class="token punctuation">{</span> <span class="token string">'@loud'</span><span class="token builtin class-name">:</span> true, type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>  stock: Integer <span class="token punctuation">{</span> type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token operator">></span></code></pre><p>Notice that the <code>entities[0].elements</code> property is shown as being of a <a href="https://cap.cloud.sap/docs/node.js/cds-reflect#iterable">LinkedDefinitions</a> type, which is, as we have found out already, not an array per se, but an iterable.</p><p>So let's explore, like this:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> <span class="token keyword">for</span> <span class="token punctuation">(</span>let el of entities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.elements<span class="token punctuation">)</span> console.log<span class="token punctuation">(</span>el.name, Object.keys<span class="token punctuation">(</span>el<span class="token punctuation">))</span><br>ID <span class="token punctuation">[</span> <span class="token string">'key'</span>, <span class="token string">'type'</span> <span class="token punctuation">]</span><br>title <span class="token punctuation">[</span> <span class="token string">'type'</span> <span class="token punctuation">]</span><br>genre <span class="token punctuation">[</span> <span class="token string">'@loud'</span>, <span class="token string">'type'</span> <span class="token punctuation">]</span><br>stock <span class="token punctuation">[</span> <span class="token string">'type'</span> <span class="token punctuation">]</span></code></pre><p>These are the elements (fields) of our <code>Book</code> entity. And look - there's our custom <code>@loud</code> annotation on the <code>genre</code> element!</p><p><a name="identifying-the-elements-annotated-with-loud"></a></p><h2>Identifying the elements annotated with @loud</h2><p>Let's define a function <code>loudElements</code> that we can use when mapping over the entities to return a list of entities and any corresponding elements that have been annotated with <code>@loud</code>:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">loudElements</span> <span class="token operator">=</span> <span class="token parameter">en</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">name</span><span class="token operator">:</span> en<span class="token punctuation">.</span>name<span class="token punctuation">,</span><br>    <span class="token literal-property property">entity</span><span class="token operator">:</span> en<span class="token punctuation">,</span><br>    <span class="token literal-property property">elements</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>en<span class="token punctuation">.</span>elements<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">[</span><span class="token string">'@loud'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>This takes an entity <code>en</code>, and returns an object with three properties:</p><ul><li>the entity's name</li><li>the entire entity object</li><li>a list of zero or more element names that have the <code>@loud</code> annotation</li></ul><p>This was both possible and easy because of the wonderfully beautiful and simple way annotations are processed and stored.</p><p>Now, we can map this function over the list of entities, which should return something like this (pay particular attention to the value of the <code>elements</code> property in each of the array items):</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> entities.map<span class="token punctuation">(</span>loudElements<span class="token punctuation">)</span><br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    name: <span class="token string">'Bookshop.Books'</span>,<br>    entity: entity <span class="token punctuation">{</span><br>      kind: <span class="token string">'entity'</span>,<br>      elements: LinkedDefinitions <span class="token punctuation">{</span><br>        ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span>,<br>        title: String <span class="token punctuation">{</span> type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>        genre: String <span class="token punctuation">{</span> <span class="token string">'@loud'</span><span class="token builtin class-name">:</span> true, type: <span class="token string">'cds.String'</span> <span class="token punctuation">}</span>,<br>        stock: Integer <span class="token punctuation">{</span> type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span>,<br>    elements: <span class="token punctuation">[</span> <span class="token string">'genre'</span> <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span><br>    name: <span class="token string">'Bookshop.Things'</span>,<br>    entity: entity <span class="token punctuation">{</span><br>      kind: <span class="token string">'entity'</span>,<br>      elements: LinkedDefinitions <span class="token punctuation">{</span><br>        ID: Integer <span class="token punctuation">{</span> key: true, type: <span class="token string">'cds.Integer'</span> <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span>,<br>    elements: <span class="token punctuation">[</span><span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>We only annotated the <code>genre</code> element of the <code>Books</code> entity, so this makes sense.</p><p>This way we can identify those entities upon which we need to focus.</p><p><a name="wrapping-up"></a></p><h2>Wrapping up</h2><p>This post just scratches the surface of the power that the cds REPL gives us as developers, to explore, understand, manipulate and write code against the services and other artifacts presented in what we're building, both in <em>our</em> user space, but also in the CAP framework's &quot;kernel&quot; space (see the <a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/#kernel-space-and-user-space">Kernel space and user space</a> section of <a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/">Five reasons to use CAP</a>).</p><p>In <a href="https://www.youtube.com/watch?v=hi7NXlMl3iU">the third and final part</a> to this series we can use the knowledge we've gained from this cds REPL session to write our actual plugin!</p><hr><p><a name="appendix-a-turning-down-the-logging"></a></p><h2>Appendix A - Turning down the logging</h2><p>The reason this line appears each and every time we start up the service, even in the REPL:</p><pre class="language-log"><code class="language-log"><span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Starting up <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>is because by default, the <code>log('Starting up ...')</code> call here in our plugin file <code>loud/cap-plugin.js</code>:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOUD'</span><span class="token punctuation">)</span><br><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Starting up ...'</span><span class="token punctuation">)</span></code></pre><p>emits at a level that finds its way to the server output by default.</p><p>Switching this to an explicit call to <code>log.debug('Starting up ...')</code>, which is at lower more detailed level that is not output by default, means that we don't see this line any more, except if we explicitly ask to see debug output, using the <code>DEBUG</code> environment variable, for example like this:</p><pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>LOUD cds <span class="token function">watch</span></code></pre><p>or even (turning everything up to 11):</p><pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>all cds <span class="token function">watch</span></code></pre></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cap/">#cap</a> <a href="/tags/cds/">#cds</a> <a href="/tags/plugins/">#plugins</a> <a href="/tags/repl/">#repl</a> <a href="/tags/introspection/">#introspection</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2025/01/17/cap-node.js-plugins-part-3-writing-our-own/"><span>←</span> <span>CAP Node.js plugins - part 3 - writing our own</span> </a><a href="/blog/posts/2024/12/30/cap-node.js-plugins/"><span>CAP Node.js Plugins</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>