<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>CAP Node.js plugins - part 3 - writing our own</title>
		<meta name="description" content="This blog post accompanies part 3 of a three part series where we explore the CDS Plugin mechanism in CAP Node.js to find out how it works. In part 1 we looked at the plugin mechanism itself and how it worked. In part 2 we used the cds REPL to start our CAP service running and to introspect it. In this part we&#39;ll use what we learned and discovered in the first two parts to write our own plugin.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="CAP Node.js plugins - part 3 - writing our own">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="This blog post accompanies part 3 of a three part series where we explore the CDS Plugin mechanism in CAP Node.js to find out how it works. In part 1 we looked at the plugin mechanism itself and how it worked. In part 2 we used the cds REPL to start our CAP service running and to introspect it. In this part we&#39;ll use what we learned and discovered in the first two parts to write our own plugin.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2025/01/17/cap-node-js-plugins-part-3-writing-our-own/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="cap-node-js-plugins-part-3-writing-our-own">CAP Node.js plugins - part 3 - writing our own</h1>

<ul class="post-metadata">
	<li><time datetime="2025-01-17">17 January 2025</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/plugins/" class="post-tag">plugins</a>, </li>
	<li><a href="/tags/javascript/" class="post-tag">javascript</a></li>
</ul>

<p class="post-description-main">This blog post accompanies part 3 of a three part series where we explore the CDS Plugin mechanism in CAP Node.js to find out how it works. In part 1 we looked at the plugin mechanism itself and how it worked. In part 2 we used the cds REPL to start our CAP service running and to introspect it. In this part we'll use what we learned and discovered in the first two parts to write our own plugin.</p>

<p>For information on the series and links to all resources, see the <a href="/blog/posts/2024/12/30/cap-node-js-plugins/">CAP Node.js Plugins</a> series post.</p>
<blockquote>
<p>The examples in this post are based on CAP Node.js at release 8.6 (<a href="https://cap.cloud.sap/docs/releases/dec24">December 2024</a>).</p>
</blockquote>
<h2 id="continuing-from-where-we-left-off-last-time">Continuing from where we left off last time</h2>
<p>We finished part 2 <a href="/blog/posts/2025/01/10/cap-node-js-plugins-part-2-using-the-repl/#identifying-the-elements-annotated-with-loud">with a function</a> that we named <code>loudElements</code> which gave us a summary of entities in our service, and which elements (if any) were annotated with <code>@loud</code>.</p>
<p>In fact, using the word &quot;service&quot; here in the singular prompts me to want to make things a tiny bit more interesting, or at least illustrative, by defining a second service, and a further entity within. This is so we can see for ourselves how universal introspection can be.</p>
<p>Let's keep things simple from a mechanics perspective, introduce a simple new entity, <code>Colours</code>, in the context of the Platonic <a href="https://en.wikipedia.org/wiki/Theory_of_forms">Theory of forms</a> and annotate its string element with <code>@loud</code>. There's no reason for this departure to the philosophical except to have something a little more adventurous than &quot;Foo&quot;s and &quot;Bar&quot;s.</p>
<p>In addition, we'll add a <code>String</code> element to the <code>Things</code> entity in the original service, but <em>not</em> annotate that with <code>@loud</code>.</p>
<p>This is what we then end up with in <code>services.cds</code>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">service</span> Bookshop {
    <span class="token keyword">entity</span> Books {
        <span class="token cqlkeywords keyword">key</span> ID          : <span class="token type builtin">Integer</span>;
            title       : <span class="token type builtin">String</span>;
            <span class="token annotation important">@loud</span> genre : <span class="token type builtin">String</span>;
            stock       : <span class="token type builtin">Integer</span>;
    }

    <span class="token keyword">entity</span> Things {
        <span class="token cqlkeywords keyword">key</span> ID   : <span class="token type builtin">Integer</span>;
            name : <span class="token type builtin">String</span>;
    }
}

<span class="token keyword">service</span> PlatonicForms {
    <span class="token keyword">entity</span> Colours {
        <span class="token cqlkeywords keyword">key</span> ID         : <span class="token type builtin">Integer</span>;
            <span class="token annotation important">@loud</span> name : <span class="token type builtin">String</span>;
    }
}</code></pre>
<p>As well as the CSV data for the books, we'll add some for the things and colours:</p>
<p>File: <strong>data/Bookshop.Things.csv</strong></p>
<pre class="language-csv" tabindex="0"><code class="language-csv"><span class="token value">ID</span><span class="token punctuation">,</span><span class="token value">name</span>
<span class="token value">1</span><span class="token punctuation">,</span><span class="token value">apple</span>
<span class="token value">2</span><span class="token punctuation">,</span><span class="token value">banana</span>
<span class="token value">3</span><span class="token punctuation">,</span><span class="token value">cherry</span></code></pre>
<p>File: <strong>data/PlatonicForms.Colours.csv</strong></p>
<pre class="language-csv" tabindex="0"><code class="language-csv"><span class="token value">ID</span><span class="token punctuation">,</span><span class="token value">name</span>
<span class="token value">1</span><span class="token punctuation">,</span><span class="token value">Red</span>
<span class="token value">2</span><span class="token punctuation">,</span><span class="token value">Green</span>
<span class="token value">3</span><span class="token punctuation">,</span><span class="token value">Blue</span></code></pre>
<p>Now, with this second service, we have to be more ready to process any service we come across; remember that in part 2 we explicitly picked out the <code>Bookshop</code> service by name:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">{</span> Bookshop <span class="token punctuation">}</span> <span class="token operator">=</span> cds<span class="token punctuation">.</span>services</code></pre>
<p>But in this part we'll address (almost) the entirety of <code>cds.services</code>.</p>
<h2 id="identifying-application-services">Identifying application services</h2>
<p>In addressing the entirety of <code>cds.services</code> we'll need to ensure we pick out only &quot;our&quot; services, i.e. not the core framework's services such as the database service.</p>
<p>Starting up the cds REPL with the <code>--run</code> option (from the <a href="https://cap.cloud.sap/docs/releases/dec24#cds-repl-enhancements">CAP December 2024 release</a>, and <a href="/blog/posts/2025/01/10/cap-node-js-plugins-part-2-using-the-repl/#new-repl-options">as noted</a> in the blog post for the previous part) we see the list of services <code>db</code>, <code>Bookshop</code> and <code>PlatonicForms</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds r <span class="token parameter variable">-r</span> <span class="token builtin class-name">.</span>
Welcome to cds repl <span class="token function">v</span> <span class="token number">8.6</span>.0
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - loaded model from <span class="token number">1</span> file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:

  services.cds

<span class="token punctuation">..</span>.

Following variables are made available <span class="token keyword">in</span> your repl's global context:

<span class="token punctuation">..</span>.

from cds.services: <span class="token punctuation">{</span>
  db,
  Bookshop,
  PlatonicForms,
<span class="token punctuation">}</span>

Simply <span class="token builtin class-name">type</span> e.g. PlatonicForms <span class="token keyword">in</span> the prompt to use the respective objects.</code></pre>
<p>Moreover, examining the services as we did last time shows us what we need to know:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> const basicInfo <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>name<span class="token punctuation">,</span> x<span class="token punctuation">.</span>kind<span class="token punctuation">]</span>
<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cds<span class="token punctuation">.</span>services<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">(</span>basicInfo<span class="token operator">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">[</span> <span class="token string">'db'</span><span class="token punctuation">,</span> <span class="token string">'sqlite'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span> <span class="token string">'Bookshop'</span><span class="token punctuation">,</span> <span class="token string">'app-service'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span> <span class="token string">'PlatonicForms'</span><span class="token punctuation">,</span> <span class="token string">'app-service'</span> <span class="token punctuation">]</span>
<span class="token punctuation">]</span></code></pre>
<p>In other words, it will be useful to have a helper so that we can pick out &quot;our&quot; services, something like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">isAppService</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> x<span class="token punctuation">.</span>kind <span class="token operator">=</span> <span class="token string">'app-service'</span></code></pre>
<p>With this we can gather our services into an array, thus:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>cds<span class="token punctuation">.</span>services<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isAppService<span class="token punctuation">)</span></code></pre>
<p>While <code>basicInfo</code> is somewhat more useful in an interactive REPL session, this <code>isAppService</code> <a href="https://dcl-prog.stanford.edu/function-predicate.html">predicate function</a> is going to help us in our real plugin code itself, along with <code>loudElements</code>, which, as a reminder, looks like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">loudElements</span> <span class="token operator">=</span> <span class="token parameter">en</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> en<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token literal-property property">entity</span><span class="token operator">:</span> en<span class="token punctuation">,</span>
    <span class="token literal-property property">elements</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>en<span class="token punctuation">.</span>elements<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">[</span><span class="token string">'@loud'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h2 id="getting-the-timing-right">Getting the timing right</h2>
<p>So far we've been working in the cds REPL, starting up the service on invocation, with the <code>--run</code> option, or once we are in the REPL, with e.g. <code>const test = cds.test()</code>. So by the time we start to introspect, to look at, say, <code>cds.services</code>, the server is already started up and values are available.</p>
<p>But what about at runtime?</p>
<p>The plugin needs to be ready to inject the custom behavior at the right time, i.e. once the CAP server is started and all the services have been bootstrapped. As well as regular events such as before, on or after a request, the CAP server itself also sports <a href="https://cap.cloud.sap/docs/node.js/cds-server#lifecycle-events">lifecycle events</a>, and the <a href="https://cap.cloud.sap/docs/node.js/cds-server#served">served</a> event is ideal for what we need.</p>
<p>Let's add some simple code inside a handler for <code>served</code>, in our plugin (i.e. in <code>loud/cds-plugin.js</code>), adding the definitions of <code>basicInfo</code>, <code>isAppService</code> and <code>loudElements</code>, and grabbing the service list into an array:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOUD'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Starting up ...'</span><span class="token punctuation">)</span>

cds<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'served'</span><span class="token punctuation">,</span> <span class="token parameter">_</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> <span class="token function-variable function">basicInfo</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>name<span class="token punctuation">,</span> x<span class="token punctuation">.</span>kind<span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isAppService</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> x<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">'app-service'</span>
    <span class="token keyword">const</span> <span class="token function-variable function">loudElements</span> <span class="token operator">=</span> <span class="token parameter">en</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> en<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token literal-property property">entity</span><span class="token operator">:</span> en<span class="token punctuation">,</span>
        <span class="token literal-property property">elements</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>en<span class="token punctuation">.</span>elements<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">[</span><span class="token string">'@loud'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> el<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>cds<span class="token punctuation">.</span>services<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isAppService<span class="token punctuation">)</span>

    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>basicInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<blockquote>
<p>When there are no arguments expected or needed, I like the &quot;underscore as parameter placeholder&quot; style of arrow function expressions, i.e. (<code>_ =&gt; { ... }</code>) but you might prefer the &quot;empty list&quot; style i.e. (<code>() =&gt; { ... }</code>).</p>
</blockquote>
<p>Starting up the server:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>LOUD cds w</code></pre>
<p>we see the debug output from our plugin:</p>
<pre class="language-log" tabindex="0"><code class="language-log">cds serve all <span class="token operator">-</span><span class="token operator">-</span>with<span class="token operator">-</span>mocks <span class="token operator">-</span><span class="token operator">-</span>in<span class="token operator">-</span>memory<span class="token operator">?</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Starting up <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving Bookshop <span class="token operator">{</span> path<span class="token operator">:</span> <span class="token string">'/odata/v4/bookshop'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving PlatonicForms <span class="token operator">{</span> path<span class="token operator">:</span> <span class="token string">'/odata/v4/platonic-forms'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token string">'Bookshop'</span><span class="token punctuation">,</span> <span class="token string">'app-service'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'PlatonicForms'</span><span class="token punctuation">,</span> <span class="token string">'app-service'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>Great, that's the timing sorted out. Now we just need to put everything together into that <code>served</code> lifecycle event handler.</p>
<h2 id="fleshing-out-the-plugin-activities">Fleshing out the plugin activities</h2>
<p>We'll replace this line, in the handler above:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>basicInfo<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>with something that actually works through those services and does the right thing.</p>
<p>As a reminder, this is to be a super simple plugin that uppercases string values for elements annotated with <code>@loud</code>. Let's use one of the best features of the set of <a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/#design-time-tools">design time tools</a> to iterate towards what we need - the auto restart of the CAP server on changes.</p>
<h3 id="identifying-the-element-candidates">Identifying the element candidates</h3>
<p>First, replacing that <code>log.debug</code> line with this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">services<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

    <span class="token punctuation">[</span><span class="token operator">...</span>s<span class="token punctuation">.</span>entities<span class="token punctuation">]</span>

        <span class="token comment">// Produce a summary of entities and any annotated elements</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>loudElements<span class="token punctuation">)</span>

        <span class="token comment">// Only keep entities that have a non-zero list of annotated elements</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> x<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

        <span class="token comment">// Temporarily emit what we end up with</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token punctuation">.</span>elements<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>gives us the following two lines in the CAP server output (when running with <code>DEBUG</code> set on for our <code>LOUD</code> logger identifier, of course):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Bookshop<span class="token punctuation">.</span>Books <span class="token operator">-</span><span class="token operator">></span> genre
<span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> PlatonicForms<span class="token punctuation">.</span>Colours <span class="token operator">-</span><span class="token operator">></span> name</code></pre>
<h3 id="setting-up-a-handler-to-provide-the-effect">Setting up a handler to provide the effect</h3>
<p>At this point we have everything we need. To bring about the &quot;loud&quot; effect, we can hook ourselves onto the regular processing of read events for the appropriate entities; in other words, we can register <a href="https://cap.cloud.sap/docs/node.js/core-services#srv-after-request">after</a> phase handlers.</p>
<p>Let's replace that inner <code>.forEach(x =&gt; log.debug(...)</code> part within the function chain above, with a new function that does this. The entire resulting outer <code>forEach</code> should now look like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">services<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

    <span class="token punctuation">[</span><span class="token operator">...</span>s<span class="token punctuation">.</span>entities<span class="token punctuation">]</span>

        <span class="token comment">// Produce a summary of entities and any annotated elements</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>loudElements<span class="token punctuation">)</span>

        <span class="token comment">// Only keep entities that have a non-zero list of annotated elementd</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> x<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

        <span class="token comment">// Process each entity, setting up a READ handler</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">en</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Setting up a READ handler for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>en<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">READ</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> en<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token parameter">records</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span>
                    en<span class="token punctuation">.</span>elements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> r<span class="token punctuation">[</span>el<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>el<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Remember that the <code>@loud</code>-annotated elements are stored in the <code>elements</code> property of the entity in <code>en</code>, i.e. <code>en.elements</code>, so we can just iterate over them (<code>en.elements.forEach</code>) converting the values using <code>toUpperCase()</code>.</p>
<p>At this point when the server restarts, we see this in the debug output:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Setting up a READ handler for Bookshop<span class="token punctuation">.</span>Books
<span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Setting up a READ handler for PlatonicForms<span class="token punctuation">.</span>Colours</code></pre>
<h3 id="checking-the-effect">Checking the effect</h3>
<p>That's all we need to do. We can check the effect with some HTTP requests:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> localhost:4004/odata/v4/bookshop/Books <span class="token operator">|</span> jq <span class="token builtin class-name">.</span>
<span class="token punctuation">{</span>
  <span class="token string">"@odata.context"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$metadata</span>#Books"</span>,
  <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"The Hitchhiker's Guide To The Galaxy"</span>,
      <span class="token string">"genre"</span><span class="token builtin class-name">:</span> <span class="token string">"SCIENCE FICTION"</span>,
      <span class="token string">"stock"</span><span class="token builtin class-name">:</span> <span class="token number">42</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>The value for the <code>genre</code> element is uppercased, and the value for <code>title</code> is not, as that element is not annotated with <code>@loud</code>.</p>
<p>Also, none of the strings for <code>Things</code> are uppercased:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> localhost:4004/odata/v4/bookshop/Things <span class="token operator">|</span> jq <span class="token builtin class-name">.</span>
<span class="token punctuation">{</span>
  <span class="token string">"@odata.context"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$metadata</span>#Things"</span>,
  <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"apple"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"banana"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"cherry"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Finally, the string values for the <code>name</code> element of the <code>Colours</code> entity in the <code>PlatonicForms</code> service are uppercased, as that element is annotated with <code>@loud</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> localhost:4004/odata/v4/platonic-forms/Colours <span class="token operator">|</span> jq <span class="token builtin class-name">.</span>
<span class="token punctuation">{</span>
  <span class="token string">"@odata.context"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$metadata</span>#Colours"</span>,
  <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"RED"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"GREEN"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"ID"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"BLUE"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>That's pretty much it!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>And that's it for this mini-series too. Of course, this is just scratching the surface of what's possible, but hopefully you can see how straightforward it is to create your own plugin. And perhaps the main takeaways from what we've seen are:</p>
<ul>
<li>the REPL is one of CAP's greatest superpowers, and can be one of your superpowers too</li>
<li>introspection is straightforward and brings you and your understanding closer to the CAP mechanics and philosophy</li>
<li>getting a plugin to do something doesn't require any &quot;special&quot; code, it's just events and handlers all the way down</li>
</ul>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2025/01/10/cap-node-js-plugins-part-2-using-the-repl/">CAP Node.js plugins - part 2 - using the REPL</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2025/02/07/tasc-notes-part-7/">TASC Notes - Part 7</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2025/01/17/cap-node-js-plugins-part-3-writing-our-own/` was built on 2026-01-02T09:45:24.118Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
