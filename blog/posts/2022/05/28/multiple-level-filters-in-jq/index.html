<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2022/05/28/multiple-level-filters-in-jq/"><link href="/assets/main.c8613da530e0f001ce67.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Multiple level filters in jq | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Multiple level filters in jq"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2022/05/28/multiple-level-filters-in-jq/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@qmacro"><meta name="description" content="Multiple level filters in jq 28 May 2022 | 2 min read Here&#39;s another note-to-self on using jq to shape JSON representations of OData to..."><meta property="og:description" content="Multiple level filters in jq 28 May 2022 | 2 min read Here&#39;s another note-to-self on using jq to shape JSON representations of OData to..."><meta name="description" content="Multiple level filters in jq 28 May 2022 | 2 min read Here&#39;s another note-to-self on using jq to shape JSON representations of OData to..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><meta name="twitter:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/talks">Talks</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Multiple level filters in jq</h1><div class="post__details"><time datetime="2022-05-28">28 May 2022 </time><span>| </span><span>2 min read</span></div></header><main class="post__content"><p>Here's another note-to-self on using jq to shape JSON representations of OData to match what's returned using system query options. Thsi time it's all filtering at two levels.</p><p>In the <a href="https://www.youtube.com/watch?v=Bln2A0_OauY&amp;list=PL6RpkC85SLQABOpzhd7WI-hMpy99PxUo0&amp;index=3">Back to basics: OData - the Open Data Protocol - Part 3 - System query options</a> live stream last Friday we looked at OData's system query options.</p><p>There was a question at the end about whether it was possible to use the <code>$filter</code> system query option at multiple levels, in an <code>$expand</code> context. I wrote up the question, and a detailed answer (summary: yes) with an example here: <a href="https://github.com/SAP-samples/odata-basics-handsonsapdev/issues/8">Can $filter be applied at multiple levels in an expand?</a>.</p><p>I thought this would be another good opportunity to practise a bit of <code>jq</code> this Saturday late morning, so wondered what a <code>jq</code> filter would look like, one that would produce the same result as in the answer's example (showing suppliers only from the UK, and only including their products that were low in stock).</p><p>The OData URL for this request looks like this:</p><pre><code>http://localhost:4004/northwind-model/Suppliers
  ?$filter=Country eq 'UK'
  &amp;$expand=Products($filter=UnitsInStock le 15)
</code></pre><p>It turned out to be pretty simple. First, I grabbed the basic data:</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token punctuation">\</span><br>  <span class="token string">'http://localhost:8000/northwind-model/Suppliers?$expand=Products'</span> <span class="token punctuation">\</span><br>  <span class="token operator">></span> data.json</code></pre><blockquote><p>Incidentally, here's another example of the power of OData, being able to fetch data from related resources, in the same single request (see <a href="https://www.youtube.com/clip/Ugkxp6b9vNpSL44Xd9JevC7zmG5Tj9VOCLTq">Nonsense! Absolute nonsense!</a> for a deliberately provocative take on how some folks are so attracted to shiny new things they ignore what is already there).</p></blockquote><p>Then I loaded it into <a href="https://sr.ht/~gpanders/ijq/">ijq</a>, the lovely interactive frontend to <code>jq</code>, and played around a bit.</p><p>Here's what I ended up with:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span>value<br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>    <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>Country <span class="token operator">==</span> <span class="token string">"UK"</span><span class="token punctuation">)</span><br>    <span class="token operator pipe">|</span> <span class="token punctuation">.</span>Products <span class="token operator pipe">|=</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>        <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>UnitsInStock <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span></code></pre><p>Breaking this down, we have:</p><ul><li><code>.value</code> gives me the entire array of objects in the dataset, each one of which represents a supplier with all their products</li><li><code>map(...)</code> this outer <code>map</code> takes the array of supplier and product data and produces a new array, having processed each array element (each supplier with their products) with the filter expression supplied</li><li><code>select(.Country == &quot;UK&quot;)</code> this is the equivalent of the <code>$filter=Country eq UK</code> in the OData URL</li><li><code>.Products |= map(...)</code> the result of the previous <code>select</code> (i.e. each supplier that is in the UK) is then passed to this expression which uses the <a href="https://stedolan.github.io/jq/manual/#Update-assignment:%7C=">update assignment</a> (<code>|=</code>) to produce a modified version of the value of the <code>Products</code> property</li><li><code>select(.UnitsInStock &lt;= 15)</code> the value of the <code>Products</code> property is an array, because the <a href="https://github.com/SAP-samples/odata-basics-handsonsapdev/blob/8347ca89ad75df111b3ab05c245da840762398b4/db/schema.cds#L29">navigation property</a> between the <code>Suppliers</code> and <code>Products</code> entity types is defined as a one-to-many. This means it's appropriate to use another <code>select</code> filter to pick out specific elements (those with a value of 15 or less for the <code>UnitsInStock</code>). This is the equivalent of the <code>Products($filter=UnitsInStock le 15)</code> part of the OData URL</li></ul><p>One thing to note here is that there's a single outer <code>map</code>, the processing within which not only filters the suppliers, but subsequently filters the products of the (reduced number of) suppliers, in one pass.</p><p>Anyway, that's pretty much it for this note-to-self. I think it's time for an early afternoon beer at <a href="https://twitter.com/browtons">Browtons</a>. Cheers.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/jq/">#jq</a> <a href="/tags/odata/">#odata</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2022/05/30/reshaping-data-values-using-jq&#39;s-with_entries/"><span>←</span> <span>Reshaping data values using jq&#39;s with_entries</span> </a><a href="/blog/posts/2022/05/21/products-by-supplier-in-odata-and-jq/"><span>Products by supplier in OData and jq</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a href="https://twitter.com/qmacro" target="_blank" rel="noopener noreferrer">Twitter</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>