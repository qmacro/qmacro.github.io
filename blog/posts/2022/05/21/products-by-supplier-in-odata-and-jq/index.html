<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2022/05/21/products-by-supplier-in-odata-and-jq/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.bed7db4098e5e4fe9224.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Products by supplier in OData and jq | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Products by supplier in OData and jq"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2022/05/21/products-by-supplier-in-odata-and-jq/"><meta name="description" content="Products by supplier in OData and jq 21 May 2022 | 2 min read This is more of a note-to-self. I&#39;m enjoying comparing resource requests in..."><meta property="og:description" content="Products by supplier in OData and jq 21 May 2022 | 2 min read This is more of a note-to-self. I&#39;m enjoying comparing resource requests in..."><meta name="description" content="Products by supplier in OData and jq 21 May 2022 | 2 min read This is more of a note-to-self. I&#39;m enjoying comparing resource requests in..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Products by supplier in OData and jq</h1><div class="post__details"><time datetime="2022-05-21">21 May 2022 </time><span>| </span><span>2 min read</span></div></header><main class="post__content"><p>This is more of a note-to-self. I'm enjoying comparing resource requests in OData with the equivalent shaping with <code>jq</code>. Here's a simple example.</p><p>With the <a href="https://services.odata.org/v4/northwind/northwind.svc/">Northwind OData v4 service</a> there are <a href="https://services.odata.org/v4/northwind/northwind.svc/Products">Products</a> and <a href="https://services.odata.org/v4/northwind/northwind.svc/">Suppliers</a>. As an easy exercise I want to create a list of products by supplier.</p><h2>With OData</h2><p>With OData it's easy to follow the <code>Products</code> navigation property in the <code>Supplier</code> entity type (see the <a href="https://services.odata.org/v4/northwind/northwind.svc/$metadata">metadata</a> for more info) to the <code>Product</code> entity type.</p><p>With an OData QUERY operation it's straightforward, using the <code>$expand</code> and <code>$select</code> system query options (with extra whitespace for readability):</p><pre class="language-text"><code class="language-text">https://services.odata.org<br>  /v4/northwind/northwind.svc/Suppliers<br>  ?$expand=Products($select=ProductName)<br>  &$select=CompanyName</code></pre><p>You can <a href="https://services.odata.org/v4/northwind/northwind.svc/Suppliers?$expand=Products($select=ProductName)&amp;$select=CompanyName">try out this OData request directly</a>, and the JSON representation in the response looks something like this (shortened to the first two suppliers for brevity):</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"@odata.context"</span><span class="token operator">:</span> <span class="token string">"https://services.odata.org/V4/Northwind/Northwind.svc/$metadata#Suppliers(CompanyName,Products,Products(ProductName))"</span><span class="token punctuation">,</span><br>  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"CompanyName"</span><span class="token operator">:</span> <span class="token string">"Exotic Liquids"</span><span class="token punctuation">,</span><br>      <span class="token property">"Products"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Chai"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Chang"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Aniseed Syrup"</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"CompanyName"</span><span class="token operator">:</span> <span class="token string">"New Orleans Cajun Delights"</span><span class="token punctuation">,</span><br>      <span class="token property">"Products"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Chef Anton's Cajun Seasoning"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Chef Anton's Gumbo Mix"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Louisiana Fiery Hot Pepper Sauce"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"ProductName"</span><span class="token operator">:</span> <span class="token string">"Louisiana Hot Spiced Okra"</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre><h2>With jq</h2><p>How might we do this in <code>jq</code>? Let's see. First, let's grab some JSON data. To make it a little more interesting (i.e. without going directly to the supplier grouping) we'll start with the <code>Products</code> entityset and expand the <code>Supplier</code> navigation property like <a href="https://services.odata.org/v4/northwind/northwind.svc/Products?$expand=Supplier">this</a>:</p><pre class="language-text"><code class="language-text">https://services.odata.org<br>  /v4/northwind/northwind.svc/Products<br>  ?$expand=Supplier</code></pre><p>(Note for this simple example, I won't bother trying to consume all of the products by following the <code>@odata.nextLink</code>s).</p><p>This gives a nice structure that we can dig into with <code>jq</code>. It turns out to be quite simple, especially in the context of the recent process I followed in <a href="https://qmacro.org/blog/posts/2022/05/21/exploring-json-with-interactive-jq/">Exploring JSON with interactive jq</a>.</p><p>Being an OData v4 entityset, the data is in the top level <code>value</code> property, so we start with that, grouping by the ID of each product's supplier:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span>value<br><span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>SupplierID<span class="token punctuation">)</span></code></pre><p>Then all we need to do is to reshape the resulting array, via <code>map</code>, to product an object for each supplier, with a list of products:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span>value<br><span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>SupplierID<span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span><br>      <span class="token property-literal property">CompanyName</span><span class="token punctuation">:</span> first<span class="token punctuation">.</span>Supplier<span class="token punctuation">.</span>CompanyName<span class="token punctuation">,</span><br>      <span class="token property-literal property">Products</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ProductName<span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span></code></pre><p>Here's a screenshot of this <code>jq</code> invocation in action, against the OData JSON representation retrieved with the URL above.</p><p><img src="/images/2022/05/ijq-products-by-supplier.png" alt="products by supplier"></p><p>You can see the results of the <code>jq</code> filter, producing what we want (reduced for brevity):</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"CompanyName"</span><span class="token operator">:</span> <span class="token string">"Exotic Liquids"</span><span class="token punctuation">,</span><br>    <span class="token property">"Products"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"Chai"</span><span class="token punctuation">,</span><br>      <span class="token string">"Chang"</span><span class="token punctuation">,</span><br>      <span class="token string">"Aniseed Syrup"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"CompanyName"</span><span class="token operator">:</span> <span class="token string">"New Orleans Cajun Delights"</span><span class="token punctuation">,</span><br>    <span class="token property">"Products"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"Chef Anton's Cajun Seasoning"</span><span class="token punctuation">,</span><br>      <span class="token string">"Chef Anton's Gumbo Mix"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"CompanyName"</span><span class="token operator">:</span> <span class="token string">"Grandma Kelly's Homestead"</span><span class="token punctuation">,</span><br>    <span class="token property">"Products"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"Grandma's Boysenberry Spread"</span><span class="token punctuation">,</span><br>      <span class="token string">"Uncle Bob's Organic Dried Pears"</span><span class="token punctuation">,</span><br>      <span class="token string">"Northwoods Cranberry Sauce"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>You can examine how this works yourself <a href="https://jqplay.org/s/ldrVNmwLbF7">courtesy of jq play</a>.</p><p>Note: If we wanted to create the same shape as the OData output, with each product name as a value for a <code>ProductName</code> property, this would just need a small change:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span>value<br><span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>SupplierID<span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span><br>      <span class="token property-literal property">CompanyName</span><span class="token punctuation">:</span> first<span class="token punctuation">.</span>Supplier<span class="token punctuation">.</span>CompanyName<span class="token punctuation">,</span><br>      <span class="token property-literal property">Products</span><span class="token punctuation">:</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ProductName<span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span></code></pre><p>This works because of the shortcut syntax available for <code>jq</code>'s <a href="https://stedolan.github.io/jq/manual/#ObjectConstruction:%7B%7D">object construction</a> (<code>{...}</code>) which is simply to use the name of the property (and you don't even need quotes):</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">{</span>ProductName<span class="token punctuation">}</span></code></pre><p>is the same as:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">{</span><span class="token property">"ProductName"</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>ProductName<span class="token punctuation">}</span></code></pre></main><aside class="post__aside"><div class="post__tags"><a href="/tags/jq/">#jq</a> <a href="/tags/odata/">#odata</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2022/05/28/multiple-level-filters-in-jq/"><span>←</span> <span>Multiple level filters in jq</span> </a><a href="/blog/posts/2022/05/21/exploring-json-with-interactive-jq/"><span>Exploring JSON with interactive jq</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>