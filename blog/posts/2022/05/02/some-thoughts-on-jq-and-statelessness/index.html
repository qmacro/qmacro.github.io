<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Some thoughts on jq and statelessness</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		
	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="some-thoughts-on-jq-and-statelessness">Some thoughts on jq and statelessness</h1>

<ul class="post-metadata">
	<li><time datetime="2022-05-02">02 May 2022</time></li>
	<li><a href="/tags/jq/" class="post-tag">jq</a>, </li>
	<li><a href="/tags/lobsters/" class="post-tag">lobsters</a></li>
</ul>

<p class="post-description-main"></p>

<p>I came across a great article <a href="https://lobste.rs/s/uhkwhn/introducing_zq_easier_faster">via lobsters</a> recently: <a href="https://www.brimdata.io/blog/introducing-zq/">Introducing zq: an Easier (and Faster) Alternative to jq</a>. I <a href="https://lobste.rs/s/uhkwhn/introducing_zq_easier_faster#c_ue6azr">posted</a> some brief thoughts on it over on the lobsters thread, and in the spirit of &quot;owning your own words&quot;, I thought I'd write them up here too.</p>
<p>I do like articles like this, that show and lay out the thinking behind the conclusion, and along the way, impart knowledge about the topic at hand. Especially when they're on a subject I'm eager to learn more about.</p>
<p>While reading the article a couple of things struck me.</p>
<h2 id="stateless-dataflow">Stateless dataflow</h2>
<p>First, I'd not really heard of the phrase &quot;stateless dataflow&quot; (and its opposite &quot;stateful dataflow&quot;). I did look it up via Google and found that there were <a href="https://www.google.com/search?q=%22stateless+(dataflow%7Cdata-flow)">very few results</a>, most of them being scholarly papers either in PDF or even PostScript form. So I sort of forgave myself for not really knowing what was implied, although I had taken a guess anyway.</p>
<p>Basically the author was explaining that the reason for finding the <code>jq</code> language difficult was down to the computational model. I don't think <code>jq</code> is the easiest language, and in my experience so far that is down to a number of things, not least the relative terseness of the official manual, but also my inability to grasp powerful constructs, as well as having to manipulate complex object and array structures in my head, not only statically, but also having to imagine how they might change when processed through filters.</p>
<p>It seems that the author's issue with the &quot;stateless dataflow&quot; was down to the fact that what's being processed by <code>jq</code> is very often a <em>stream</em> of discrete JSON values, rather than a single value.</p>
<h2 id="json-values">JSON values</h2>
<p>So what do I mean by &quot;JSON value&quot;? Well, in the article <a href="https://www.json.org/json-en.html">Introducing JSON</a> there's a McKeeman form expressing the JSON grammar, and the building blocks of what we know as JSON are described as &quot;JSON values&quot; thus:</p>
<pre><code>value
  object
  array
  string
  number
  &quot;true&quot;
  &quot;false&quot;
  &quot;null&quot;
</code></pre>
<p>These JSON values are described as fundamental building blocks in <a href="https://datatracker.ietf.org/doc/html/rfc8259#section-3">RFC 8259</a>.</p>
<p>Anything expressed in JSON will be one of these value types. This is why, for example, <code>&quot;hello world&quot;</code> is valid JSON, as is <code>42</code>.</p>
<h2 id="processing-json-with-jq">Processing JSON with jq</h2>
<p>In the &quot;Invoking jq&quot; section of the <a href="https://stedolan.github.io/jq/manual/">manual</a>, it says:</p>
<blockquote>
<p>jq filters run on a stream of JSON data. The input to jq is parsed as a sequence of whitespace-separated JSON values which are passed through the provided filter one at a time. The output(s) of the filter are written to standard out, again as a sequence of whitespace-separated JSON data.</p>
</blockquote>
<p>Key for me, in my journey towards a deeper understanding of <code>jq</code>, is that the &quot;filter&quot; here is the entire <code>jq</code> program, whether that's something short expressed literally on the command line, or in a file, pointed to with the <code>--from-file</code> or <code>-f</code> option.</p>
<p>So each and every JSON value that is passed into <code>jq</code> is processed by the entire program.</p>
<p>There's the &quot;slurp&quot; option (with <code>--slurp</code> or <code>-s</code>) which will &quot;read the entire input stream into a large array and run the filter just once&quot;. This is maybe what one might initially assume or expect <code>jq</code> to do, but one needs to be explicit.</p>
<p>Perhaps a small example might help, based on a sequence of JSON values that we can produce with <a href="https://linux.die.net/man/1/seq">seq</a>:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">seq</span> <span class="token number">3</span></code></pre>
<p>produces:</p>
<pre><code>1
2
3
</code></pre>
<p>If we pass this sequence of JSON values through the simplest of <code>jq</code> filters -- the <a href="https://stedolan.github.io/jq/manual/#Identity:.">identity</a> function -- like this:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">seq</span> <span class="token number">3</span> <span class="token operator">|</span> jq <span class="token builtin class-name">.</span></code></pre>
<p>then we get this:</p>
<pre><code>1
2
3
</code></pre>
<p>One might think &quot;well, what else would you expect?&quot; but this illustrates the nature of running discrete JSON values through a filter quite nicely.</p>
<p>Before we continue, let's use the <code>--compact-output</code> (or <code>-c</code>) option here:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">seq</span> <span class="token number">3</span> <span class="token operator">|</span> jq <span class="token parameter variable">-c</span> <span class="token builtin class-name">.</span></code></pre>
<p>The output is the same:</p>
<pre><code>1
2
3
</code></pre>
<p>For me, this drives home the &quot;discrete JSON values&quot; approach to both <code>jq</code>'s input and output processing - there are three discrete values in, and three out.</p>
<h2 id="stateless">Stateless</h2>
<p>I guess this also helps explain what the author of the article means by &quot;stateless&quot;. As far as the filter is concerned, it's seeing the values <code>1</code>, <code>2</code> and <code>3</code> separately and in new contexts each time. And as the article illustrates, this is where <code>jq</code>'s <code>--slurp</code> (or <code>-s</code>) option comes in. Adding the option to the above example:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">seq</span> <span class="token number">3</span> <span class="token operator">|</span> jq <span class="token parameter variable">-c</span> <span class="token parameter variable">-s</span> <span class="token builtin class-name">.</span></code></pre>
<p>produces this:</p>
<pre><code>[1,2,3]
</code></pre>
<p>A <em>single JSON value</em>. This is because what the filter received was actually this:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token number">3</span>
<span class="token punctuation">]</span></code></pre>
<p>Three discrete values, but wrapped in an outer enclosing array. A single JSON value, in the form of an array. And being the simple identity function, just regurgitating what it reads, produces in turn that same, single JSON value as output. On one line here, rather than pretty printed with more whitespace, because of the <code>-c</code> option.</p>
<h2 id="stateful">Stateful</h2>
<p>The <code>--slurp</code> option brings about a sort of statefulness, in that every discrete JSON value, previously independent, now share the same single context of the single invocation of the <code>jq</code> filter.</p>
<p>Changing the filter from the <code>.</code> identity function to the <code>add</code> function* demonstrates this singular context, this &quot;statefulness&quot;:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">seq</span> <span class="token number">3</span> <span class="token operator">|</span> jq <span class="token parameter variable">-s</span> <span class="token function">add</span></code></pre>
<p>This yields the single JSON value:</p>
<pre><code>6
</code></pre>
<p>*I'm calling them &quot;functions&quot;, but the manual actually calls them &quot;filters&quot;</p>
<h2 id="syntactic-sugar">Syntactic sugar</h2>
<p>There's one more observation I'd like to make in these ramblings. The article describes the task of adding up the numbers here:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'[1,2,3] [4,5,6]'</span></code></pre>
<p>In other words, the result should be 21.</p>
<p>We know by now that this:</p>
<pre><code>[1,2,3] [4,5,6]
</code></pre>
<p>is actually two discrete JSON values. Two arrays. So, as the author demonstrates, the <code>--slurp</code> option is called for, thus:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'[1,2,3] [4,5,6]'</span> <span class="token operator">|</span> jq <span class="token parameter variable">-s</span> <span class="token string">'[.[] | add] | add'</span></code></pre>
<p>So in this invocation, the filter is executed once only, and actually receives:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span></code></pre>
<p>The article does a great job of describing the author's thought process here, and also showing how some of the basic filters work. And I guess the filter used here is possibly deliberately complex, or at least contrived to illustrate a point:</p>
<pre><code>[.[] | add] | add
</code></pre>
<p>However to be fair on the language, it has some syntactic sugar in the form of <a href="https://stedolan.github.io/jq/manual/#map(x),map_values(x)">map</a>. In the description, we read:</p>
<blockquote>
<p><code>map(x)</code> is equivalent to <code>[.[] | x]</code>. In fact, this is how it's defined.</p>
</blockquote>
<p>And we can see this definition in <code>jq</code>'s source, specifically in the <a href="https://github.com/stedolan/jq/blob/a9f97e9e61a910a374a5d768244e8ad63f407d3e/src/builtin.jq#L3">builtin.jq</a> file:</p>
<pre><code>def map(f): [.[] | f];
</code></pre>
<p>This definition helps the mental model, and helps me a lot, not only to reduce noise, but also to relate the computation to an arguably well-known function (map). So the entire line turns into a much simpler:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'[1,2,3] [4,5,6]'</span> <span class="token operator">|</span> jq <span class="token parameter variable">-s</span> <span class="token string">'map(add) | add'</span></code></pre>
<h2 id="wrapping-up">Wrapping up</h2>
<p>This has turned into a bit of a longer ramble, beyond what I'd originally <a href="https://lobste.rs/s/uhkwhn/introducing_zq_easier_faster#c_ue6azr">commented</a>. But writing it has helped me think about this a bit more. Perhaps it helps you too - I hope so!</p>
<p>And most importantly, my thoughts in this post should not detract from the article nor from their conclusions with zq - more power to them!</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2022/04/17/bash-notes-3/">Bash notes 3</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2022/05/06/converting-strings-to-objects-with-jq/">Converting strings to objects with jq</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2022/05/02/some-thoughts-on-jq-and-statelessness/` was built on 2025-09-16T07:49:08.627Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
	</body>
</html>
