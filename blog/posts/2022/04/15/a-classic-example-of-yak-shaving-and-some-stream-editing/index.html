<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>A classic example of yak shaving, and some stream editing</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="A classic example of yak shaving, and some stream editing">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Reserving the right to be wrong.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2022/04/15/a-classic-example-of-yak-shaving-and-some-stream-editing/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="a-classic-example-of-yak-shaving-and-some-stream-editing">A classic example of yak shaving, and some stream editing</h1>

<ul class="post-metadata">
	<li><time datetime="2022-04-15">15 April 2022</time></li>
	<li><a href="/tags/shell/" class="post-tag">shell</a>, </li>
	<li><a href="/tags/yak-shaving/" class="post-tag">yak-shaving</a>, </li>
	<li><a href="/tags/sed/" class="post-tag">sed</a></li>
</ul>

<p class="post-description-main"></p>

<p>It's not often that I'm relaxed enough to be aware of how my mind is (or isn't) working, and what it's doing. So it was a surprise when I realised that what I've been doing for the past 15 minutes is descending through multiple levels into some classic yak shaving territory.</p>
<!--excerpt-->
<h2 id="level-1">Level 1</h2>
<p>I thought I'd write about another Exercism community solution that caught my eye this morning. So I went to my blog repository locally, and thought:</p>
<blockquote>
<p>Actually, what I need is an updated version of my old script that sets up a new blog post file, so I can streamline the authoring of a new post.</p>
</blockquote>
<p>I've recently moved to <a href="https://www.11ty.dev/">11ty</a> and it's a decent static site generator; it has introduced a slightly new structure, and I'm happy with it so far, but it means I need a slightly different workflow to create a new blog post file.</p>
<p>Anyway, this thought should have been an early warning sign, but I sort of ignored it.</p>
<h2 id="level-2">Level 2</h2>
<p>Then, in thinking about what I'd want this script to do, I started to think about what input I'd give it. Initially just the blog post title, perhaps, but then:</p>
<blockquote>
<p>What about tags, and how would I specify them? Why don't I choose them from a list? But then how would I determine that list?</p>
</blockquote>
<p>The tags in any given post are declared in the frontmatter; here's the frontmatter for the previous post <a href="2022-04-10-bash-notes-2">Bash notes 2</a>:</p>
<pre><code>---
title: Bash notes 2
tags:
  - shell
  - til
  - exercism
---
</code></pre>
<p>I had the idea of pulling out all the tags from all the Markdown files that represented posts. But how would I do that? I quickly descended to the next level down in my yak shaving journey.</p>
<h2 id="level-3">Level 3</h2>
<p>I could simply look through each of the files for any line that started with a couple of spaces, had a dash, and then a word. But I couldn't be sure that this approach wouldn't be too eager, and match blog post body content that wasn't tag related. So I thought it best to match those lines where <code>tags:</code> preceded them.</p>
<p>I had an inkling that something like multiline matching with <code>grep</code> might help, or even <code>sed</code>. There was a related question on Stack Overflow to which <a href="https://stackoverflow.com/a/2686369/384366">this answer</a> seemed as intriguing as it was concise:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/abc/,/efg/!d'</span> <span class="token punctuation">[</span>file-with-content<span class="token punctuation">]</span></code></pre>
<p>The first iteration of translating this into my requirements, and trying it out on the blog post files for this year so far, looks like this:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^tags:/,/---/!d'</span> <span class="token number">2022</span>-*</code></pre>
<p>This gave me the following output:</p>
<pre><code>tags:
  - sap-community
---
tags:
  - jq
  - learning
  - bats
  - shell
  - exercism
---
tags:
  - cloudfoundry
  - kubernetes
---
tags:
  - jq
  - functional
  - javascript
---
tags:
  - shell
  - til
  - exercism
---
tags:
  - shell
  - til
  - exercism
---
tags:
  - shell
---
tags:
  - shell
  - til
  - exercism
---
</code></pre>
<p>A second iteration, adding a second instruction <code>/^  - /!d</code> to search within the results for just the tag lines, looks like this:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^tags:/,/---/!d; /^  - /!d'</span> <span class="token number">2022</span>-*</code></pre>
<p>And this gave me (output reduced for brevity):</p>
<pre><code>  - sap-community
  - jq
  - learning
  - bats
  - shell
  - exercism
  - cloudfoundry
  - kubernetes
  - jq
  - functional
  - javascript
  - shell
  - til
  - exercism
  - shell
  - til
  - exercism
  - shell
  - shell
  ...
</code></pre>
<p>So there are two more tasks here - to reduce each line to just the tag name (i.e. to remove the bullet point and spaces) and to deduplicate the list.</p>
<p>As we're already in <code>sed</code> mode, the first of these reductions might as well be a third instruction, specifically <code>s/  - //</code>, like this:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^tags:/,/---/!d; /^  - /!d; s/^  - //'</span> <span class="token number">2022</span>-*</code></pre>
<p>This results in:</p>
<pre><code>sap-community
jq
learning
bats
shell
exercism
cloudfoundry
kubernetes
jq
functional
javascript
shell
til
exercism
shell
til
exercism
shell
shell
...
</code></pre>
<p>And while we could turn to <code>uniq</code> to deduplicate the list, we'll have to sort it first anyway, so we might as well use the <code>-u</code> option to <code>sort</code>:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^tags:/,/---/!d; /^  - /!d; s/^  - //'</span> <span class="token number">2022</span>-* <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-u</span></code></pre>
<p>This gives us what we want, a nice clean, unique list of tags:</p>
<pre><code>bats
cloudfoundry
exercism
functional
javascript
jq
kubernetes
learning
sap-community
shell
til
</code></pre>
<p>I can now use this with <a href="https://github.com/junegunn/fzf">fzf</a> and its multi select mode to give me the option of choosing one or more tags:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^tags:/,/---/!d; /^  - /!d; s/^  - //'</span> <span class="token number">2022</span>-* <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-u</span> <span class="token operator">|</span> fzf <span class="token parameter variable">-m</span></code></pre>
<p>This gives me a nice interface like this:</p>
<pre><code>&gt; til
  shell
  sap-community
  learning
  kubernetes
  jq
  javascript
 &gt;functional
 &gt;exercism
  cloudfoundry
 &gt;bats
  11/11 (3)
</code></pre>
<p>(Here, I've selected the three tags <code>functional</code>, <code>exercism</code> and <code>bats</code>, and my selection cursor is currently pointing to <code>til</code>.)</p>
<h2 id="level-4">Level 4</h2>
<p>Great, I can now get on with putting the script together. I'll also need a way to specify a new tag if it's not in the list, but I'll deal with that when I get to it.</p>
<p>But I'm not done with my descent yet. I'm not really sure exactly what the <code>!d</code> part in the first <code>sed</code> instruction is, and how it works. So at this point I send the <a href="https://www.gnu.org/software/sed/manual/sed.html">sed manual</a> to my trusty Nexus 9 tablet, and head off to make a cup of coffee to enjoy while reading and learning more about this venerable stream editor that's been around <a href="https://en.wikipedia.org/wiki/Sed#History">for almost half a century</a>.</p>
<p>I'm further away than ever from writing that post about the Exercism community solution I'd seen, but that's all fine. Yak shaving doesn't feel so bad when you're aware of when you're doing it.</p>
<hr>
<h2 id="update">Update</h2>
<p>I've had my coffee and read some of the manual. It's now clear to me how the initial <code>sed</code> invocation works. Here it is in isolation:</p>
<pre><code>/^tags:/,/---/!d
</code></pre>
<p>The first thing I needed to realise is that the <code>!</code> doesn't belong to the <code>d</code>, it belongs to the part before it.</p>
<p>The <a href="https://www.gnu.org/software/sed/manual/sed.html#sed-script-overview">sed script overview</a> explains that <code>sed</code> commands have this structure:</p>
<pre><code>[addr]X[options]
</code></pre>
<p>where &quot;addr&quot; is an address and &quot;X&quot; represents the actual command, or operation.</p>
<p>Looking at the <a href="https://www.gnu.org/software/sed/manual/sed.html#sed-addresses">Addresses</a> section, we see that there are multiple ways of specifying lines that the given command is to operate upon. The specifications include direct line numbers (&quot;numeric addresses&quot;), and text matching (&quot;regexp addresses&quot;). Moreover, a <a href="https://www.gnu.org/software/sed/manual/sed.html#Range-Addresses">range</a> can be specified, with the start and end specifications joined with a comma <code>,</code>.</p>
<p>This is all fine, and we grokked that in building our sed instructions earlier. But the thing I didn't realise is that the <code>!</code> character is part of the &quot;addr&quot; specification (not part of the &quot;X&quot; command) and serves to <em>negate</em> whatever address was specified.</p>
<p>In other words, the &quot;addr&quot; part is actually:</p>
<pre><code>/^tags:/,/---/!
</code></pre>
<p>which means &quot;all the lines that are NOT in this range&quot;. And then the <code>d</code> command <a href="https://www.gnu.org/software/sed/manual/sed.html#index-Text_002c-deleting">deletes</a> what's specified, i.e. deletes everything apart from sequences like this:</p>
<pre><code>tags:
  - shell
  - til
  - exercism
---
</code></pre>
<p>So there you have it.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2022/04/10/bash-notes-2/">Bash notes 2</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2022/04/17/bash-notes-3/">Bash notes 3</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2022/04/15/a-classic-example-of-yak-shaving-and-some-stream-editing/` was built on 2026-01-27T11:54:15.675Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
