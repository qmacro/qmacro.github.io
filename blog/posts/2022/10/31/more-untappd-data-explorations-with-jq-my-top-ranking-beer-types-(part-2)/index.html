<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2022/10/31/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-(part-2)/"><link href="/assets/main.f502db4e74c7edd25353.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>More Untappd data explorations with jq - my top ranking beer types (part 2) | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="More Untappd data explorations with jq - my top ranking beer types (part 2)"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2022/10/31/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-(part-2)/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@qmacro"><meta name="description" content="More Untappd data explorations with jq - my top ranking beer types (part 2) 31 Oct 2022 | 3 min read This is a continuation of part 1 which..."><meta property="og:description" content="More Untappd data explorations with jq - my top ranking beer types (part 2) 31 Oct 2022 | 3 min read This is a continuation of part 1 which..."><meta name="description" content="More Untappd data explorations with jq - my top ranking beer types (part 2) 31 Oct 2022 | 3 min read This is a continuation of part 1 which..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><meta name="twitter:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/talks">Talks</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>More Untappd data explorations with jq - my top ranking beer types (part 2)</h1><div class="post__details"><time datetime="2022-10-31">31 Oct 2022 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>This is a continuation of <a href="/blog/posts/2022/10/30/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-(part-1)/">part 1</a> which you should read first.</p><p><a href="https://untappd.com/user/qmacro/checkin/1204944451"><img src="/images/2022/10/orval-2005-checkin.png" alt="A checkin of an incredible 2005 vintage bottle of Orval"></a></p><p>Part 1 finished with a count and list of categories of beer (IPA, Bock, Belgian Tripel, etc), produced from some <code>jq</code> in <code>untappd.jq</code> that looks like this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span><br><br><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">)</span> <span class="token operator pipe">|</span> unique <span class="token operator pipe">|</span> length<span class="token punctuation">,</span> <span class="token dot important">.</span></code></pre><p>The output looks like this (reduced here):</p><pre class="language-json"><code class="language-json"><span class="token number">62</span><br><span class="token punctuation">[</span><br>  <span class="token string">"Altbier"</span><span class="token punctuation">,</span><br>  <span class="token string">"Barleywine"</span><span class="token punctuation">,</span><br>  <span class="token string">"Belgian Blonde"</span><span class="token punctuation">,</span><br>  <span class="token string">"..."</span><span class="token punctuation">,</span><br>  <span class="token string">"Winter Ale"</span><span class="token punctuation">,</span><br>  <span class="token string">"Winter Warmer"</span><br><span class="token punctuation">]</span></code></pre><h2>Picking out the data</h2><p>So now it's time to pick out the data I need for the analysis, and that is, for each checkin, the beer's category, and my rating. I'll start by just mapping the array of checkin objects to an array of smaller objects just containing these two things:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span><br><br><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote><p>When using the <a href="https://stedolan.github.io/jq/manual/#ObjectConstruction:%7B%7D">object construction</a> mechanism, I can just specify the name of an existing property, in this case <code>rating_score</code>, which is shorthand for <code>&quot;rating_score&quot;: .rating_score</code>.</p></blockquote><p>This produces an array of pairs of values which parallel the simple chronological list of checkins (output reduced for brevity):</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Brown Ale"</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Pale Ale"</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Bitter"</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Bitter"</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">""</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Tripel"</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4.7"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span><br>    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"..."</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><blockquote><p>Notice the checkin to a Bitter where I had not specified a rating. While we're at it, notice that the ratings are all strings, even though the values are numeric. We'll deal with those two aspects, but not just yet.</p></blockquote><h2>Arranging by category</h2><p>In order to be able to have a chance of calculating the average rating per category, I need first to group the data by category. So that's next:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span><br><br><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>category<span class="token punctuation">)</span></code></pre><p>Here's what that produces (again, massively reduced for brevity):</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3.75"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Barleywine"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Quadrupel"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4.9"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Quadrupel"</span><span class="token punctuation">,</span><br>      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">]</span></code></pre><h2>Rolling up by category</h2><p>This seems familiar. In the &quot;Arranging by brewery country and count&quot; section of <a href="/blog/posts/2022/10/28/untappd-data-with-jq-my-top-brewery-countries/">Untappd data with jq - my top brewery countries</a> I had a similar requirement, and following the call to <code>group_by</code> I mapped over each subarray creating small objects consisting of a <code>key</code> property having the value of the subarray's first entry's <code>brewery_country</code> and a <code>value</code> property having the length of the subarray. This is the code I had:</p><pre class="language-bash"><code class="language-bash"><span class="token operator">&lt;</span> checkins.json jq <span class="token string">'<br>.[-20:]<br>| map({beer_name, brewery_name, brewery_country})<br>| group_by(.brewery_country)<br>| map({key: first.brewery_country, value: length})<br>'</span></code></pre><p>I'm at a similar position here now too. I have a number of subarrays, each one representing a beer category, and containing one object per checkin. I want to turn those subarrays into something that makes more sense from an average rating per category point of view. And to get there would need something very similar to this <code>group_by ... map</code> approach. Let's have a look:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span><br><br><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>category<span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token punctuation">.</span>category<span class="token punctuation">,</span> <span class="token property-literal property">value</span><span class="token punctuation">:</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>rating_score<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>This creates the following type of output:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"4"</span><span class="token punctuation">,</span><br>      <span class="token string">"3"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.75"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.5"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.25"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"..."</span><span class="token punctuation">,</span><br>      <span class="token string">"..."</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"Winter Warmer"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>      <span class="token string">""</span><span class="token punctuation">,</span><br>      <span class="token string">""</span><span class="token punctuation">,</span><br>      <span class="token string">"4"</span><span class="token punctuation">,</span><br>      <span class="token string">"4"</span><span class="token punctuation">,</span><br>      <span class="token string">"4"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.5"</span><span class="token punctuation">,</span><br>      <span class="token string">"4"</span><span class="token punctuation">,</span><br>      <span class="token string">"4.25"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.25"</span><span class="token punctuation">,</span><br>      <span class="token string">"4.25"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.75"</span><span class="token punctuation">,</span><br>      <span class="token string">"3.4"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><h2>Encapsulating the roll-up into a function</h2><p>OK, getting there! But before we move on it feels right to encapsulate this pattern into a function. I'll do that now:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span><br><br><span class="token keyword">def</span> <span class="token function">arrange</span><span class="token punctuation">(</span>k<span class="token punctuation">;</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span> <br>  <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">key</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>first<span class="token operator pipe">|</span><span class="token punctuation">.</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token property-literal property">value</span><span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token operator pipe">|</span> <span class="token c-style-function function">arrange</span><span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">;</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>rating_score<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>This new function <code>arrange</code> (naming things is hard) performs the <code>group_by ... map</code>. It takes two parameters (in <code>jq</code> parlance it would be written as <code>arrange/2</code>):</p><ul><li><code>k</code> is what the grouping property should be</li><li><code>v</code> is what the value of the <code>value</code> property should be in the resulting objects</li></ul><blockquote><p>To use an indirect value (whatever is in <code>k</code>) like this in a property reference, we have to use this syntax: <code>.[k]</code> rather than <code>.k</code> of course).</p></blockquote><p>So in the call to <code>arrange</code>, the first parameter I'm passing is the string <code>&quot;category&quot;</code>, which is the name of the property by which I want the objects to be grouped, and also which is the name of the property that I use to get the value for the <code>key</code> (<code>first|.[k]</code>) in each object I'm producing in the call to <code>map</code>.</p><p>And the second parameter I'm passing is the expression <code>map(.rating_score)</code> which when evaluated produces an array of values from the <code>rating_score</code> property in each checkin.</p><h2>What's next</h2><p>Well, that seems like a good place to end this part. In part 3 I'll deal with those pesky null rating values, and also with the fact that all the ratings are strings rather than numbers. And then calculate an average.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/untappd/">#untappd</a> <a href="/tags/jq/">#jq</a> <a href="/tags/beer/">#beer</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2022/11/01/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-(part-3)/"><span>←</span> <span>More Untappd data explorations with jq - my top ranking beer types (part 3)</span> </a><a href="/blog/posts/2022/10/31/stop-asking-for-slides-in-advance/"><span>Stop asking for slides in advance</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a href="https://twitter.com/qmacro" target="_blank" rel="noopener noreferrer">Twitter</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>