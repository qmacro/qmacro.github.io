<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>More Untappd data explorations with jq - my top ranking beer types (part 2)</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		
	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-part-2">More Untappd data explorations with jq - my top ranking beer types (part 2)</h1>

<ul class="post-metadata">
	<li><time datetime="2022-10-31">31 October 2022</time></li>
	<li><a href="/tags/jq-series-top-beer-types/" class="post-tag">jq-series-top-beer-types</a>, </li>
	<li><a href="/tags/untappd/" class="post-tag">untappd</a>, </li>
	<li><a href="/tags/jq/" class="post-tag">jq</a>, </li>
	<li><a href="/tags/beer/" class="post-tag">beer</a></li>
</ul>

<p class="post-description-main"></p>

<p>This is a continuation of <a href="/blog/posts/2022/10/30/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-(part-1)/">part 1</a> which you should read first.</p>
<p><a href="https://untappd.com/user/qmacro/checkin/1204944451"><img src="/images/2022/10/orval-2005-checkin.png" alt="A checkin of an incredible 2005 vintage bottle of Orval"></a></p>
<p>Part 1 finished with a count and list of categories of beer (IPA, Bock, Belgian Tripel, etc), produced from some <code>jq</code> in <code>untappd.jq</code> that looks like this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span>

<span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">)</span> <span class="token operator pipe">|</span> unique <span class="token operator pipe">|</span> length<span class="token punctuation">,</span> <span class="token dot important">.</span></code></pre>
<p>The output looks like this (reduced here):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token number">62</span>
<span class="token punctuation">[</span>
  <span class="token string">"Altbier"</span><span class="token punctuation">,</span>
  <span class="token string">"Barleywine"</span><span class="token punctuation">,</span>
  <span class="token string">"Belgian Blonde"</span><span class="token punctuation">,</span>
  <span class="token string">"..."</span><span class="token punctuation">,</span>
  <span class="token string">"Winter Ale"</span><span class="token punctuation">,</span>
  <span class="token string">"Winter Warmer"</span>
<span class="token punctuation">]</span></code></pre>
<h2 id="picking-out-the-data">Picking out the data</h2>
<p>So now it's time to pick out the data I need for the analysis, and that is, for each checkin, the beer's category, and my rating. I'll start by just mapping the array of checkin objects to an array of smaller objects just containing these two things:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span>

<span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<blockquote>
<p>When using the <a href="https://stedolan.github.io/jq/manual/#ObjectConstruction:%7B%7D">object construction</a> mechanism, I can just specify the name of an existing property, in this case <code>rating_score</code>, which is shorthand for <code>&quot;rating_score&quot;: .rating_score</code>.</p>
</blockquote>
<p>This produces an array of pairs of values which parallel the simple chronological list of checkins (output reduced for brevity):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Brown Ale"</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Pale Ale"</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Bitter"</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Bitter"</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">""</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Tripel"</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4.7"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"..."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<blockquote>
<p>Notice the checkin to a Bitter where I had not specified a rating. While we're at it, notice that the ratings are all strings, even though the values are numeric. We'll deal with those two aspects, but not just yet.</p>
</blockquote>
<h2 id="arranging-by-category">Arranging by category</h2>
<p>In order to be able to have a chance of calculating the average rating per category, I need first to group the data by category. So that's next:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span>

<span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>category<span class="token punctuation">)</span></code></pre>
<p>Here's what that produces (again, massively reduced for brevity):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"3.75"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Barleywine"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Quadrupel"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"4.9"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Belgian Quadrupel"</span><span class="token punctuation">,</span>
      <span class="token property">"rating_score"</span><span class="token operator">:</span> <span class="token string">"5"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span></code></pre>
<h2 id="rolling-up-by-category">Rolling up by category</h2>
<p>This seems familiar. In the &quot;Arranging by brewery country and count&quot; section of <a href="/blog/posts/2022/10/28/untappd-data-with-jq-my-top-brewery-countries/">Untappd data with jq - my top brewery countries</a> I had a similar requirement, and following the call to <code>group_by</code> I mapped over each subarray creating small objects consisting of a <code>key</code> property having the value of the subarray's first entry's <code>brewery_country</code> and a <code>value</code> property having the length of the subarray. This is the code I had:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token operator">&lt;</span> checkins.json jq <span class="token string">'
.[-20:]
| map({beer_name, brewery_name, brewery_country})
| group_by(.brewery_country)
| map({key: first.brewery_country, value: length})
'</span></code></pre>
<p>I'm at a similar position here now too. I have a number of subarrays, each one representing a beer category, and containing one object per checkin. I want to turn those subarrays into something that makes more sense from an average rating per category point of view. And to get there would need something very similar to this <code>group_by ... map</code> approach. Let's have a look:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span>

<span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator pipe">|</span> <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>category<span class="token punctuation">)</span>
<span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token punctuation">.</span>category<span class="token punctuation">,</span> <span class="token property-literal property">value</span><span class="token punctuation">:</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>rating_score<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>This creates the following type of output:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"Altbier"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"4"</span><span class="token punctuation">,</span>
      <span class="token string">"3"</span><span class="token punctuation">,</span>
      <span class="token string">"3.75"</span><span class="token punctuation">,</span>
      <span class="token string">"3.5"</span><span class="token punctuation">,</span>
      <span class="token string">"3.25"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"..."</span><span class="token punctuation">,</span>
      <span class="token string">"..."</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token punctuation">:</span> <span class="token string">"Winter Warmer"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token string">"4"</span><span class="token punctuation">,</span>
      <span class="token string">"4"</span><span class="token punctuation">,</span>
      <span class="token string">"4"</span><span class="token punctuation">,</span>
      <span class="token string">"3.5"</span><span class="token punctuation">,</span>
      <span class="token string">"4"</span><span class="token punctuation">,</span>
      <span class="token string">"4.25"</span><span class="token punctuation">,</span>
      <span class="token string">"3.25"</span><span class="token punctuation">,</span>
      <span class="token string">"4.25"</span><span class="token punctuation">,</span>
      <span class="token string">"3.75"</span><span class="token punctuation">,</span>
      <span class="token string">"3.4"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<h2 id="encapsulating-the-roll-up-into-a-function">Encapsulating the roll-up into a function</h2>
<p>OK, getting there! But before we move on it feels right to encapsulate this pattern into a function. I'll do that now:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">category</span><span class="token punctuation">:</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">" -"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span> first<span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">arrange</span><span class="token punctuation">(</span>k<span class="token punctuation">;</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span> 
  <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">key</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>first<span class="token operator pipe">|</span><span class="token punctuation">.</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token property-literal property">value</span><span class="token punctuation">:</span> v<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token property-literal property">category</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>beer_type<span class="token operator pipe">|</span>category<span class="token punctuation">,</span> rating_score <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator pipe">|</span> <span class="token c-style-function function">arrange</span><span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">;</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">.</span>rating_score<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>This new function <code>arrange</code> (naming things is hard) performs the <code>group_by ... map</code>. It takes two parameters (in <code>jq</code> parlance it would be written as <code>arrange/2</code>):</p>
<ul>
<li><code>k</code> is what the grouping property should be</li>
<li><code>v</code> is what the value of the <code>value</code> property should be in the resulting objects</li>
</ul>
<blockquote>
<p>To use an indirect value (whatever is in <code>k</code>) like this in a property reference, we have to use this syntax: <code>.[k]</code> rather than <code>.k</code> of course).</p>
</blockquote>
<p>So in the call to <code>arrange</code>, the first parameter I'm passing is the string <code>&quot;category&quot;</code>, which is the name of the property by which I want the objects to be grouped, and also which is the name of the property that I use to get the value for the <code>key</code> (<code>first|.[k]</code>) in each object I'm producing in the call to <code>map</code>.</p>
<p>And the second parameter I'm passing is the expression <code>map(.rating_score)</code> which when evaluated produces an array of values from the <code>rating_score</code> property in each checkin.</p>
<h2 id="whats-next">What's next</h2>
<p>Well, that seems like a good place to end this part. In part 3 I'll deal with those pesky null rating values, and also with the fact that all the ratings are strings rather than numbers. And then calculate an average.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2022/10/31/stop-asking-for-slides-in-advance/">Stop asking for slides in advance</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2022/11/01/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-part-3/">More Untappd data explorations with jq - my top ranking beer types (part 3)</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2022/10/31/more-untappd-data-explorations-with-jq-my-top-ranking-beer-types-part-2/` was built on 2025-09-15T16:27:09.185Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
	</body>
</html>
