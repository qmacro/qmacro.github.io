<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Computed field example in CAP</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="computed-field-example-in-cap">Computed field example in CAP</h1>

<ul class="post-metadata">
	<li><time datetime="2019-08-21">21 August 2019</time></li>
	<li><a href="/tags/sapcommunity/" class="post-tag">sapcommunity</a></li>
</ul>

<p class="post-description-main"></p>

<p><em>In this post, I show one way of using computed properties in CAP, using
CDS and service events in Node.js.</em></p>
<p>Over in the <a href="https://answers.sap.com/tags/9f13aee1-834c-4105-8e43-ee442775e5ce">CAP section of the Community
Q&amp;A</a>,
Pierre Dominique asked an interesting question that I thought I'd have a
go at answering in the form of a short post. Here's the question:
<a href="https://answers.sap.com/questions/12845830/counting-associated-entities-using-cds.html">Counting association entities using
CDS</a> -
go ahead and have a quick read of it, then come back here to find out
one way of doing it.</p>
<p>Given the bookshop sample data as a basis, how do we extend the service
to include a property which indicates, for each author, how many books
they have written?</p>
<h2 id="step-1-the-definitions">Step 1 - the definitions</h2>
<p>Here's the basic schema. It's very similar to the example that Pierre
gives, but doesn't have the extra 'numberOfBooks' property at this
level - I wanted to give myself an extra challenge by not defining it at
the data model layer, but defining it only at the service definition
layer. If we're going to have a computed property, we should avoid
having it pollute the space at the persistence layer.</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">namespace</span> my.bookshop;

<span class="token keyword">entity</span> Books {
    <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
    title  : <span class="token type builtin">String</span>;
    stock  : <span class="token type builtin">Integer</span>;
    author : <span class="token association-composition keyword">Association to Authors</span>;
}

<span class="token keyword">entity</span> Authors {
    <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
    name   : <span class="token type builtin">String</span>;
    books  : <span class="token association-composition keyword">Association to many Books</span> <span class="token cqlkeywords keyword">on</span> books.author = $self;
}</code></pre>
<p><em>db/schema.cds</em></p>
<p>It's possible to add computed properties to an entity at the service
definition level. Here's what the service definition looks like with a
computed property for the requirement at hand:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token using keyword">using</span> my.bookshop <span class="token cqlkeywords keyword">as</span> my <span class="token from keyword">from</span> '../db/schema';

<span class="token keyword">service</span> CatalogService {

    <span class="token keyword">entity</span> Books <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Books;
    <span class="token keyword">entity</span> Authors <span class="token cqlkeywords keyword">as</span> select <span class="token from keyword">from</span> my.Authors {
        *,
        null <span class="token cqlkeywords keyword">as</span> numberOfBooks: <span class="token type builtin">Integer
    </span>};

}</code></pre>
<p><em>srv/service.cds</em></p>
<p>Notice the &quot;as select from&quot;, as opposed to the simpler &quot;as projection
on&quot;. It allows us to specify properties, which is what we do in the
block that follows:</p>
<ul>
<li>the &quot;*&quot; brings in all the existing properties from the my.Authors
definition</li>
<li>then we define a new property &quot;numberOfBooks&quot; as an Integer type</li>
</ul>
<p>Let's take a moment to have a look what that produces. Running this at
the command line:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds compile srv/service.cds <span class="token parameter variable">--to</span> sql</code></pre>
<p>... gives us the schema definition, which includes these two views that
have been generated from the two entities defined at the service level:</p>
<pre class="language-sql" tabindex="0"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> CatalogService_Authors <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
  Authors_0<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
  Authors_0<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token boolean">NULL</span> <span class="token keyword">AS</span> numberOfBooks
<span class="token keyword">FROM</span> my_bookshop_Authors <span class="token keyword">AS</span> Authors_0<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> CatalogService_Books <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
  Books_0<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
  Books_0<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
  Books_0<span class="token punctuation">.</span>stock<span class="token punctuation">,</span>
  Books_0<span class="token punctuation">.</span>author_ID
<span class="token keyword">FROM</span> my_bookshop_Books <span class="token keyword">AS</span> Books_0<span class="token punctuation">;</span></code></pre>
<p>Take note of the &quot;numberOfBooks&quot; property in the
&quot;CatalogService_Authors&quot; view.</p>
<p>While we're in the mood for looking at generated compilations, let's
do the same, but this time see what the service definition will look
like, in the form of Entity Data Model XML (EDMX) - which you and I know
more comfortably as OData metadata.</p>
<p>Running this at the command line:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds compile srv/service.cds <span class="token parameter variable">--to</span> edmx</code></pre>
<p>... gives us this:</p>
<pre class="language-xml" tabindex="0"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Edmx</span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>edmx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://docs.oasis-open.org/odata/ns/edmx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Reference</span> <span class="token attr-name">Uri</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://oasis-tcs.github.io/odata-vocabularies/vocabularies/Org.OData.Core.V1.xml<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Include</span> <span class="token attr-name">Alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core<span class="token punctuation">"</span></span> <span class="token attr-name">Namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Org.OData.Core.V1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>Reference</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>DataServices</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Schema</span> <span class="token attr-name">Namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://docs.oasis-open.org/odata/ns/edm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityContainer</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EntityContainer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntitySet</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span> <span class="token attr-name">EntityType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationPropertyBinding</span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntitySet</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntitySet</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span> <span class="token attr-name">EntityType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationPropertyBinding</span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntitySet</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityContainer</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityType</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyRef</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span> <span class="token attr-name">Nullable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationProperty</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Collection(CatalogService.Books)<span class="token punctuation">"</span></span> <span class="token attr-name">Partner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>numberOfBooks<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityType</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityType</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyRef</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span> <span class="token attr-name">Nullable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stock<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationProperty</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors<span class="token punctuation">"</span></span> <span class="token attr-name">Partner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ReferentialConstraint</span> <span class="token attr-name">Property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author_ID<span class="token punctuation">"</span></span> <span class="token attr-name">ReferencedProperty</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NavigationProperty</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author_ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityType</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotations</span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors/numberOfBooks<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotation</span> <span class="token attr-name">Term</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core.Computed<span class="token punctuation">"</span></span> <span class="token attr-name">Bool</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Annotations</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Schema</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>DataServices</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>Edmx</span><span class="token punctuation">></span></span></code></pre>
<p>There's one thing in there that's of particular interest - the
annotation of this new property. You can either stare at this XML until
you see it, or just look at it as extracted from that sea of angle
brackets:</p>
<pre class="language-xml" tabindex="0"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotations</span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors/numberOfBooks<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotation</span> <span class="token attr-name">Term</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core.Computed<span class="token punctuation">"</span></span> <span class="token attr-name">Bool</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Annotations</span><span class="token punctuation">></span></span></code></pre>
<p>This has been automatically generated from that simple service
definition earlier. Thanks, CAP!</p>
<h2 id="step-2-the-implementation">Step 2 - the implementation</h2>
<p>Implementing the logic to provide values for this computed property is
next up. As you may know, we can <a href="https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/94c7b69cc4584a1a9dfd9cb2da295d5e.html">provide custom logic in the form of
functions attached to specific
events</a>
in the request/response lifecycle as OData operations are processed, and
in a very comfortable way, via the &quot;<a href="https://en.wikipedia.org/wiki/Convention_over_configuration">convention over
configuration</a>&quot;
approach of simply providing a JavaScript file of the same base name as
the service definition file, in the same directory.</p>
<p>The Node.js CAP runtime will then discover this file and use it as extra
(or overriding) implementation logic. This is what it looks like:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">srv</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> Books <span class="token punctuation">}</span> <span class="token operator">=</span> srv<span class="token punctuation">.</span>entities

  srv<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token string">'Authors'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">authors<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> authors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">author</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> publications <span class="token operator">=</span> <span class="token keyword">await</span> cds<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>
        <span class="token constant">SELECT</span> <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>Books<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">author_ID</span><span class="token operator">:</span> author<span class="token punctuation">.</span><span class="token constant">ID</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      author<span class="token punctuation">.</span>numberOfBooks <span class="token operator">=</span> publications<span class="token punctuation">.</span>length
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span></code></pre>
<p><em>srv/service.js</em></p>
<p>(In case you're wondering: yes, I am trying to avoid semicolons and
double quotes, and yes, I like the ES6 fat arrow syntax for functional
style, and no, I am not writing and will not write any &quot;class&quot; based
code here - in my opinion the whole &quot;object orientation comes to JS&quot;
is the wrong direction entirely. Stick <em>that</em> in your pipe and smoke it!
:-))</p>
<p>Anyway, here's what's going on in the code:</p>
<ul>
<li>we grab the Books entity from within the service object</li>
<li>we hook in a function to be called when READ requests are processed
on the Authors entity, specifically after the main part of the
request has been fulfilled (i.e. using srv.after)</li>
<li>that function expects the results of the request fulfilment (i.e.
the author(s) retrieved), plus the original request object, from
which we can create a context in which to run a CDS query</li>
<li>the query is within a map function over the authors retrieved, and
goes to get the books for that author</li>
</ul>
<p>The CDS query is made using the CDS Query Language (CQL) fluent API,
which I've tried to illustrate with some gratuitous whitespace (before
.from and .where, in particular).</p>
<p>Once the value for &quot;numberOfBooks&quot; has been computed and assigned, we
simply &quot;let go&quot; and the enhanced result set is returned in the
response.</p>
<h2 id="step-3-profit">Step 3 - profit!</h2>
<p>Here's what this results in, after deploying the definitions and
starting the service (I have a few books and authors in some sample CSV
files):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">=</span><span class="token operator">></span> cds deploy <span class="token operator">&amp;</span><span class="token operator">&amp;</span> cds run
 <span class="token operator">></span> filling my<span class="token punctuation">.</span>bookshop<span class="token punctuation">.</span>Authors from db<span class="token operator">/</span>csv<span class="token operator">/</span>my<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Authors<span class="token punctuation">.</span>csv
 <span class="token operator">></span> filling my<span class="token punctuation">.</span>bookshop<span class="token punctuation">.</span>Books from db<span class="token operator">/</span>csv<span class="token operator">/</span>my<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Books<span class="token punctuation">.</span>csv
<span class="token operator">/</span><span class="token operator">></span> successfully deployed database to <span class="token file-path string">./bookshop.db</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to datasource <span class="token operator">-</span> sqlite<span class="token operator">:</span>bookshop<span class="token punctuation">.</span>db
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving CatalogService at <span class="token file-path string">/catalog</span> <span class="token operator">-</span> impl<span class="token operator">:</span> <span class="token domain constant">service.js</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> service definitions loaded from<span class="token operator">:</span>

  srv<span class="token operator">/</span>service<span class="token punctuation">.</span>cds
  db<span class="token operator">/</span>schema<span class="token punctuation">.</span>cds

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listens at <span class="token url">http://localhost:4004</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">(</span>terminate with <span class="token operator">^</span>C<span class="token operator">)</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched in<span class="token operator">:</span> <span class="token number">1126.872ms</span></code></pre>
<p>And here's some sample output, retrieved with &quot;curl&quot; and nicely
pretty-printed with &quot;jq&quot; (yes, folks, this is all in a terminal, ON
THE COMMAND LINE)*:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">=</span><span class="token operator">></span> curl <span class="token operator">-</span>s <span class="token url">http://localhost:4004/catalog/Authors</span> <span class="token operator">|</span> jq
<span class="token operator">{</span>
  <span class="token string">"@odata.context"</span><span class="token operator">:</span> <span class="token string">"$metadata#Authors"</span><span class="token punctuation">,</span>
  <span class="token string">"@odata.metadataEtag"</span><span class="token operator">:</span> <span class="token string">"W/"</span>8q5jjLD6vJ0ARrjnkajTONXIn38vpa1wxoXucua4kzU<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token operator">{</span>
      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Douglas Adams"</span><span class="token punctuation">,</span>
      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span>
      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Emily Brontë"</span><span class="token punctuation">,</span>
      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span>
      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Charlote Brontë"</span><span class="token punctuation">,</span>
      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span>
      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Edgar Allen Poe"</span><span class="token punctuation">,</span>
      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span>
      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Richard Carpenter"</span><span class="token punctuation">,</span>
      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token operator">}</span>
  <span class="token punctuation">]</span>
<span class="token operator">}</span></code></pre>
<p>That's pretty much all there is to it, at least as far as I can see. I
hope you find this useful. I had fun writing it, thanks Pierre for a
good question.</p>
<p>*i.e. the future</p>
<hr>
<p><a href="https://community.sap.com/t5/technology-blogs-by-sap/computed-field-example-in-cap/ba-p/13408603">Originally published on SAP Community</a></p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2019/07/29/we-can-do-better-than-polynimbus/">We can do better than &#39;polynimbus&#39;</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2019/08/28/hitch-hikers-style-in-sea-of-sorrows/">Hitch Hiker&#39;s style in Sea of Sorrows</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2019/08/21/computed-field-example-in-cap/` was built on 2025-10-05T11:00:19.525Z -->
		<script type="module" src="/dist/BQdjwJXB4J.js"></script>
	</body>
</html>
