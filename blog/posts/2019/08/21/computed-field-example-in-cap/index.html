<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2019/08/21/computed-field-example-in-cap/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Computed field example in CAP | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Computed field example in CAP"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2019/08/21/computed-field-example-in-cap/"><meta name="description" content="Computed field example in CAP 21 Aug 2019 | 4 min read In this post, I show one way of using computed properties in CAP, using CDS and..."><meta property="og:description" content="Computed field example in CAP 21 Aug 2019 | 4 min read In this post, I show one way of using computed properties in CAP, using CDS and..."><meta name="description" content="Computed field example in CAP 21 Aug 2019 | 4 min read In this post, I show one way of using computed properties in CAP, using CDS and..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Computed field example in CAP</h1><div class="post__details"><time datetime="2019-08-21">21 Aug 2019 </time><span>| </span><span>4 min read</span></div></header><main class="post__content"><p><em>In this post, I show one way of using computed properties in CAP, using CDS and service events in Node.js.</em></p><p>Over in the <a href="https://answers.sap.com/tags/9f13aee1-834c-4105-8e43-ee442775e5ce">CAP section of the Community Q&amp;A</a>, Pierre Dominique asked an interesting question that I thought I'd have a go at answering in the form of a short post. Here's the question: <a href="https://answers.sap.com/questions/12845830/counting-associated-entities-using-cds.html">Counting association entities using CDS</a> - go ahead and have a quick read of it, then come back here to find out one way of doing it.</p><p>Given the bookshop sample data as a basis, how do we extend the service to include a property which indicates, for each author, how many books they have written?</p><h2>Step 1 - the definitions</h2><p>Here's the basic schema. It's very similar to the example that Pierre gives, but doesn't have the extra 'numberOfBooks' property at this level - I wanted to give myself an extra challenge by not defining it at the data model layer, but defining it only at the service definition layer. If we're going to have a computed property, we should avoid having it pollute the space at the persistence layer.</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">namespace</span> my.bookshop;<br><br><span class="token keyword">entity</span> Books {<br>    <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;<br>    title  : <span class="token type builtin">String</span>;<br>    stock  : <span class="token type builtin">Integer</span>;<br>    author : <span class="token association-composition keyword">Association to Authors</span>;<br>}<br><br><span class="token keyword">entity</span> Authors {<br>    <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;<br>    name   : <span class="token type builtin">String</span>;<br>    books  : <span class="token association-composition keyword">Association to many Books</span> <span class="token cqlkeywords keyword">on</span> books.author = $self;<br>}</code></pre><p><em>db/schema.cds</em></p><p>It's possible to add computed properties to an entity at the service definition level. Here's what the service definition looks like with a computed property for the requirement at hand:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> my.bookshop <span class="token cqlkeywords keyword">as</span> my <span class="token from keyword">from</span> '../db/schema';<br><br><span class="token keyword">service</span> CatalogService {<br><br>    <span class="token keyword">entity</span> Books <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Books;<br>    <span class="token keyword">entity</span> Authors <span class="token cqlkeywords keyword">as</span> select <span class="token from keyword">from</span> my.Authors {<br>        *,<br>        null <span class="token cqlkeywords keyword">as</span> numberOfBooks: <span class="token type builtin">Integer<br>    </span>};<br><br>}</code></pre><p><em>srv/service.cds</em></p><p>Notice the &quot;as select from&quot;, as opposed to the simpler &quot;as projection on&quot;. It allows us to specify properties, which is what we do in the block that follows:</p><ul><li>the &quot;*&quot; brings in all the existing properties from the my.Authors definition</li><li>then we define a new property &quot;numberOfBooks&quot; as an Integer type</li></ul><p>Let's take a moment to have a look what that produces. Running this at the command line:</p><pre class="language-shell"><code class="language-shell">cds compile srv/service.cds <span class="token parameter variable">--to</span> sql</code></pre><p>... gives us the schema definition, which includes these two views that have been generated from the two entities defined at the service level:</p><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> CatalogService_Authors <span class="token keyword">AS</span> <span class="token keyword">SELECT</span><br>  Authors_0<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><br>  Authors_0<span class="token punctuation">.</span>name<span class="token punctuation">,</span><br>  <span class="token boolean">NULL</span> <span class="token keyword">AS</span> numberOfBooks<br><span class="token keyword">FROM</span> my_bookshop_Authors <span class="token keyword">AS</span> Authors_0<span class="token punctuation">;</span><br><br><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> CatalogService_Books <span class="token keyword">AS</span> <span class="token keyword">SELECT</span><br>  Books_0<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><br>  Books_0<span class="token punctuation">.</span>title<span class="token punctuation">,</span><br>  Books_0<span class="token punctuation">.</span>stock<span class="token punctuation">,</span><br>  Books_0<span class="token punctuation">.</span>author_ID<br><span class="token keyword">FROM</span> my_bookshop_Books <span class="token keyword">AS</span> Books_0<span class="token punctuation">;</span></code></pre><p>Take note of the &quot;numberOfBooks&quot; property in the &quot;CatalogService_Authors&quot; view.</p><p>While we're in the mood for looking at generated compilations, let's do the same, but this time see what the service definition will look like, in the form of Entity Data Model XML (EDMX) - which you and I know more comfortably as OData metadata.</p><p>Running this at the command line:</p><pre class="language-shell"><code class="language-shell">cds compile srv/service.cds <span class="token parameter variable">--to</span> edmx</code></pre><p>... gives us this:</p><pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Edmx</span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>edmx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://docs.oasis-open.org/odata/ns/edmx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Reference</span> <span class="token attr-name">Uri</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://oasis-tcs.github.io/odata-vocabularies/vocabularies/Org.OData.Core.V1.xml<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>Include</span> <span class="token attr-name">Alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core<span class="token punctuation">"</span></span> <span class="token attr-name">Namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Org.OData.Core.V1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>Reference</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">edmx:</span>DataServices</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Schema</span> <span class="token attr-name">Namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://docs.oasis-open.org/odata/ns/edm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityContainer</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EntityContainer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntitySet</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span> <span class="token attr-name">EntityType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationPropertyBinding</span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntitySet</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntitySet</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span> <span class="token attr-name">EntityType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationPropertyBinding</span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntitySet</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityContainer</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityType</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Authors<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyRef</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span> <span class="token attr-name">Nullable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationProperty</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Collection(CatalogService.Books)<span class="token punctuation">"</span></span> <span class="token attr-name">Partner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>numberOfBooks<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityType</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityType</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyRef</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span> <span class="token attr-name">Nullable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stock<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationProperty</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors<span class="token punctuation">"</span></span> <span class="token attr-name">Partner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ReferentialConstraint</span> <span class="token attr-name">Property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author_ID<span class="token punctuation">"</span></span> <span class="token attr-name">ReferencedProperty</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ID<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NavigationProperty</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Property</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author_ID<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityType</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotations</span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors/numberOfBooks<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotation</span> <span class="token attr-name">Term</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core.Computed<span class="token punctuation">"</span></span> <span class="token attr-name">Bool</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Annotations</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Schema</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>DataServices</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">edmx:</span>Edmx</span><span class="token punctuation">></span></span></code></pre><p>There's one thing in there that's of particular interest - the annotation of this new property. You can either stare at this XML until you see it, or just look at it as extracted from that sea of angle brackets:</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotations</span> <span class="token attr-name">Target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CatalogService.Authors/numberOfBooks<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Annotation</span> <span class="token attr-name">Term</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Core.Computed<span class="token punctuation">"</span></span> <span class="token attr-name">Bool</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Annotations</span><span class="token punctuation">></span></span></code></pre><p>This has been automatically generated from that simple service definition earlier. Thanks, CAP!</p><h2>Step 2 - the implementation</h2><p>Implementing the logic to provide values for this computed property is next up. As you may know, we can <a href="https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/94c7b69cc4584a1a9dfd9cb2da295d5e.html">provide custom logic in the form of functions attached to specific events</a> in the request/response lifecycle as OData operations are processed, and in a very comfortable way, via the &quot;<a href="https://en.wikipedia.org/wiki/Convention_over_configuration">convention over configuration</a>&quot; approach of simply providing a JavaScript file of the same base name as the service definition file, in the same directory.</p><p>The Node.js CAP runtime will then discover this file and use it as extra (or overriding) implementation logic. This is what it looks like:</p><pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">srv</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> Books <span class="token punctuation">}</span> <span class="token operator">=</span> srv<span class="token punctuation">.</span>entities<br><br>  srv<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token string">'Authors'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">authors<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">return</span> authors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">author</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> publications <span class="token operator">=</span> <span class="token keyword">await</span> cds<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><br>        <span class="token constant">SELECT</span> <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>Books<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">author_ID</span><span class="token operator">:</span> author<span class="token punctuation">.</span><span class="token constant">ID</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>      author<span class="token punctuation">.</span>numberOfBooks <span class="token operator">=</span> publications<span class="token punctuation">.</span>length<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br><span class="token punctuation">}</span></code></pre><p><em>srv/service.js</em></p><p>(In case you're wondering: yes, I am trying to avoid semicolons and double quotes, and yes, I like the ES6 fat arrow syntax for functional style, and no, I am not writing and will not write any &quot;class&quot; based code here - in my opinion the whole &quot;object orientation comes to JS&quot; is the wrong direction entirely. Stick <em>that</em> in your pipe and smoke it! :-))</p><p>Anyway, here's what's going on in the code:</p><ul><li>we grab the Books entity from within the service object</li><li>we hook in a function to be called when READ requests are processed on the Authors entity, specifically after the main part of the request has been fulfilled (i.e. using srv.after)</li><li>that function expects the results of the request fulfilment (i.e. the author(s) retrieved), plus the original request object, from which we can create a context in which to run a CDS query</li><li>the query is within a map function over the authors retrieved, and goes to get the books for that author</li></ul><p>The CDS query is made using the CDS Query Language (CQL) fluent API, which I've tried to illustrate with some gratuitous whitespace (before .from and .where, in particular).</p><p>Once the value for &quot;numberOfBooks&quot; has been computed and assigned, we simply &quot;let go&quot; and the enhanced result set is returned in the response.</p><h2>Step 3 - profit!</h2><p>Here's what this results in, after deploying the definitions and starting the service (I have a few books and authors in some sample CSV files):</p><pre class="language-log"><code class="language-log"><span class="token operator">=</span><span class="token operator">></span> cds deploy <span class="token operator">&amp;</span><span class="token operator">&amp;</span> cds run<br> <span class="token operator">></span> filling my<span class="token punctuation">.</span>bookshop<span class="token punctuation">.</span>Authors from db<span class="token operator">/</span>csv<span class="token operator">/</span>my<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Authors<span class="token punctuation">.</span>csv<br> <span class="token operator">></span> filling my<span class="token punctuation">.</span>bookshop<span class="token punctuation">.</span>Books from db<span class="token operator">/</span>csv<span class="token operator">/</span>my<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Books<span class="token punctuation">.</span>csv<br><span class="token operator">/</span><span class="token operator">></span> successfully deployed database to <span class="token file-path string">./bookshop.db</span><br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to datasource <span class="token operator">-</span> sqlite<span class="token operator">:</span>bookshop<span class="token punctuation">.</span>db<br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving CatalogService at <span class="token file-path string">/catalog</span> <span class="token operator">-</span> impl<span class="token operator">:</span> <span class="token domain constant">service.js</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> service definitions loaded from<span class="token operator">:</span><br><br>  srv<span class="token operator">/</span>service<span class="token punctuation">.</span>cds<br>  db<span class="token operator">/</span>schema<span class="token punctuation">.</span>cds<br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listens at <span class="token url">http://localhost:4004</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">(</span>terminate with <span class="token operator">^</span>C<span class="token operator">)</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched in<span class="token operator">:</span> <span class="token number">1126.872ms</span></code></pre><p>And here's some sample output, retrieved with &quot;curl&quot; and nicely pretty-printed with &quot;jq&quot; (yes, folks, this is all in a terminal, ON THE COMMAND LINE)*:</p><pre class="language-log"><code class="language-log"><span class="token operator">=</span><span class="token operator">></span> curl <span class="token operator">-</span>s <span class="token url">http://localhost:4004/catalog/Authors</span> <span class="token operator">|</span> jq<br><span class="token operator">{</span><br>  <span class="token string">"@odata.context"</span><span class="token operator">:</span> <span class="token string">"$metadata#Authors"</span><span class="token punctuation">,</span><br>  <span class="token string">"@odata.metadataEtag"</span><span class="token operator">:</span> <span class="token string">"W/"</span>8q5jjLD6vJ0ARrjnkajTONXIn38vpa1wxoXucua4kzU<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span><br>  <span class="token string">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token operator">{</span><br>      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span><br>      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Douglas Adams"</span><span class="token punctuation">,</span><br>      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">3</span><br>    <span class="token operator">}</span><span class="token punctuation">,</span><br>    <span class="token operator">{</span><br>      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span><br>      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Emily Brontë"</span><span class="token punctuation">,</span><br>      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span><br>    <span class="token operator">}</span><span class="token punctuation">,</span><br>    <span class="token operator">{</span><br>      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">107</span><span class="token punctuation">,</span><br>      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Charlote Brontë"</span><span class="token punctuation">,</span><br>      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span><br>    <span class="token operator">}</span><span class="token punctuation">,</span><br>    <span class="token operator">{</span><br>      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span><br>      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Edgar Allen Poe"</span><span class="token punctuation">,</span><br>      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">2</span><br>    <span class="token operator">}</span><span class="token punctuation">,</span><br>    <span class="token operator">{</span><br>      <span class="token string">"ID"</span><span class="token operator">:</span> <span class="token number">170</span><span class="token punctuation">,</span><br>      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"Richard Carpenter"</span><span class="token punctuation">,</span><br>      <span class="token string">"numberOfBooks"</span><span class="token operator">:</span> <span class="token number">1</span><br>    <span class="token operator">}</span><br>  <span class="token punctuation">]</span><br><span class="token operator">}</span></code></pre><p>That's pretty much all there is to it, at least as far as I can see. I hope you find this useful. I had fun writing it, thanks Pierre for a good question.</p><p>*i.e. the future</p><hr><p><a href="https://community.sap.com/t5/technology-blogs-by-sap/computed-field-example-in-cap/ba-p/13408603">Originally published on SAP Community</a></p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/sapcommunity/">#sapcommunity</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2019/08/28/hitch-hiker&#39;s-style-in-sea-of-sorrows/"><span>←</span> <span>Hitch Hiker&#39;s style in Sea of Sorrows</span> </a><a href="/blog/posts/2019/07/29/we-can-do-better-than-&#39;polynimbus&#39;/"><span>We can do better than &#39;polynimbus&#39;</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>