<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/03/30/cap-cors-and-custom-headers/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>CAP, CORS and custom headers | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="CAP, CORS and custom headers"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/03/30/cap-cors-and-custom-headers/"><meta name="description" content="CAP, CORS and custom headers 30 Mar 2024 | 10 min read A colleague asked me if I could add CORS support to a service I was running, built..."><meta property="og:description" content="CAP, CORS and custom headers 30 Mar 2024 | 10 min read A colleague asked me if I could add CORS support to a service I was running, built..."><meta name="description" content="CAP, CORS and custom headers 30 Mar 2024 | 10 min read A colleague asked me if I could add CORS support to a service I was running, built..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>CAP, CORS and custom headers</h1><div class="post__details"><time datetime="2024-03-30">30 Mar 2024 </time><span>| </span><span>10 min read</span></div></header><main class="post__content"><p>A colleague asked me if I could add CORS support to a service I was running, built with the SAP Cloud Application Programming Model (CAP). CAP already has some basic support for CORS, so I dug in. Here's what I learned, about CORS headers, preflight requests, CAP custom servers and more.</p><blockquote><p>The <a href="https://www.npmjs.com/package/@sap/approuter">@sap/approuter</a> has full support for CORS but I wanted to find out about what CAP offers and how to extend it. Specifically, this exploration was made with <code>@sap/cds</code> at version 7.8.0.</p></blockquote><h2>Test service</h2><p>Before diving in, let's create the simplest server that could possibly work<a href="#footnotes"><sup>1</sup></a> to explore CORS support in CAP. First, a minimal project:</p><pre class="language-shell"><code class="language-shell"><span class="token comment"># /home/user/work/scratch</span><br><span class="token punctuation">;</span> cds init corstest <span class="token punctuation">\</span><br>    <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$_</span> <span class="token punctuation">\</span><br>    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> .vscode/ app/ srv/ db/ README.md <span class="token punctuation">\</span><br>    <span class="token operator">&amp;&amp;</span> tree <span class="token parameter variable">-a</span><br>Creating new CAP project <span class="token keyword">in</span> ./corstest<br><br>Adding feature <span class="token string">'nodejs'</span><span class="token punctuation">..</span>.<br><br>Successfully created project. Continue with <span class="token string">'cd corstest'</span><span class="token builtin class-name">.</span><br>Find samples on https://github.com/SAP-samples/cloud-cap-samples<br>Learn about next steps at https://cap.cloud.sap<br><span class="token builtin class-name">.</span><br><span class="token operator">|</span>-- .cdsrc.json<br><span class="token operator">|</span>-- .eslintrc<br><span class="token operator">|</span>-- .gitignore<br>`-- package.json<br><br><span class="token number">1</span> directory, <span class="token number">4</span> files</code></pre><p>Now, just the simplest test REST style service. In <code>services.cds</code><a href="#footnotes"><sup>2</sup></a>:</p><pre class="language-cds"><code class="language-cds"><span class="token annotation important">@protocol:</span> 'rest'<br><span class="token keyword">service</span> corstest {<br>    <span class="token keyword">function</span> go() <span class="token cdl-keyword keyword">returns</span> <span class="token type builtin">String</span>;<br>}</code></pre><p>And in the default implementation file for this service file, i.e. <code>services.js</code>:</p><pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>    s<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'go'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, World!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre><p>Let's also install the runtime locally with <code>npm install</code> (as we'll want to look into one of the files there later), and start the server up with <code>cds watch</code>. Now we can perform a basic test, asking for verbose output<a href="#footnotes"><sup>3</sup></a>, to see what we get:</p><pre class="language-text"><code class="language-text"># /home/user/work/scratch/corstest<br>; curl --verbose --url localhost:4004/rest/corstest/go<br>> GET /rest/corstest/go HTTP/1.1<br>> Host: localhost:4004<br>> User-Agent: curl/7.88.1<br>> Accept: */*<br>><br>&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; Content-Type: text/plain; charset=utf-8<br>&lt; Content-Length: 13<br>&lt;<br>Hello, World!</code></pre><blockquote><p>In the verbose output for this HTTP request and all subsequent ones, some of the HTTP response headers have been omitted for brevity.</p></blockquote><p>OK, all set.</p><h2>Getting started</h2><p>CORS, or <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross Origin Resource Sharing</a>, &quot;is an HTTP-header based mechanism that allows a server to indicate any origins (domain, scheme, or port) other than its own from which a browser should permit loading resources&quot;. You come across it in the browser when wanting to consume resources from a different server to the one, the &quot;origin&quot;, that the consuming code came from.</p><p>There's a <a href="https://cap.cloud.sap/docs/node.js/best-practices#cross-origin-resource-sharing-cors">section on CORS</a> in the <a href="https://cap.cloud.sap/docs/node.js/best-practices">Node.js Best Practices</a> part of <a href="https://cap.cloud.sap/docs/">Capire</a>. In there, it merely says:</p><p>&quot;If not running in production, CAP's default server allows all origins. For production, you can add CORS to your server as follows ...&quot;</p><p>That tantalisingly short paragraph got me hooked. What does that mean? How does that work? I knew that finding out the answers to these questions would help me with providing what my colleague was asking for.</p><p>There are three parts to the paragraph:</p><ul><li>&quot;if not running in production&quot;</li><li>&quot;CAP's default server allows all origins&quot;</li><li>&quot;you can add CORS to your server as follows&quot;</li></ul><p>Let's take the &quot;default server&quot; part first.</p><h3>Default server support</h3><p>What is the &quot;default server&quot;? Basically, it's the process that runs when you invoke something like <code>cds watch</code>, or <code>cds serve</code>, and is also known as the <a href="https://cap.cloud.sap/docs/node.js/cds-server#built-in-server-js">built-in server.js</a>.</p><p>So what sort of support are we looking for anyway? CORS support comes in the form of HTTP headers, and the ones that we should be expecting are returned <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#the_http_response_headers">in the HTTP response</a>. The header names all start <code>Access-Control-...</code>, such as <code>Access-Control-Allow-Origin</code>.</p><p>But there are no CORS headers in the response to the basic service test above:</p><pre class="language-text"><code class="language-text">&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; Content-Type: text/plain; charset=utf-8<br>&lt; Content-Length: 13</code></pre><p>That's because the HTTP request didn't include any <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#the_http_request_headers">headers in the request that make use of the CORS features</a>. The basics can be triggered by including an <code>Origin</code> HTTP header in the request (this is done automatically by the browser in such cross origin resource retrieval circumstances).</p><h4>Regular CORS processing</h4><p>Let's do that and see what we get from the CAP server. The important thing for this test is to specify a value for the <code>Origin</code> HTTP header that is different to the CAP server. Let's use <code>qmacro.org</code>:</p><pre class="language-text"><code class="language-text">; curl \<br>    --verbose \<br>    --header 'Origin: https://qmacro.org' \<br>    --url localhost:4004/rest/corstest/go<br>> GET /rest/corstest/go HTTP/1.1<br>> Host: localhost:4004<br>> User-Agent: curl/7.88.1<br>> Accept: */*<br>> Origin: https://qmacro.org<br>><br>&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; access-control-allow-origin: https://qmacro.org<br>&lt; Content-Type: text/plain; charset=utf-8<br>&lt; Content-Length: 13<br>&lt;<br>Hello, World!</code></pre><p>Check out that extra header in the response, shown in the verbose output:</p><pre class="language-text"><code class="language-text">&lt; access-control-allow-origin: https://qmacro.org</code></pre><p>From a CORS perspective, this response header tells the browser to allow that origin to access the resource being returned.</p><p>So where is that header coming from? Well, the answer is in the default server. Specifically that's <code>@sap/cds/server.js</code>, which has been installed in the <code>node_modules/</code> directory during the <code>npm install</code> process earlier. The relevant part is here, in a <code>cors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">getter</a>:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><br>        <span class="token operator">?</span> <span class="token function-variable function">null</span><br>        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access-control-allow-origin'</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><br>                <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span><br>                    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><br>                        <span class="token string">'access-control-allow-methods'</span><span class="token punctuation">,</span><br>                        <span class="token string">'GET,HEAD,PUT,PATCH,POST,DELETE'</span><br>                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><blockquote><p>I took the liberty of reformatting the code for better readability and so it would fit better width-wise in this blog post.</p></blockquote><p>The middle section is what came into play here. If there's an <code>Origin</code> header in the request, then an <code>Access-Control-Allow-Origin</code> header is sent in the response, with the same value that came in the request (<code>https://qmacro.org</code>):</p><pre class="language-text"><code class="language-text">access-control-allow-origin: https://qmacro.org</code></pre><p>An alternative value would be <code>*</code> but I think I like this reciprocal approach better.</p><blockquote><p>Header names during runtime in the CAP server are lower-cased for consistency and ease of processing.</p></blockquote><p>But what about that bit that starts with the <code>req.method === 'OPTIONS'</code> condition, with the <code>Access-Control-Allow-Methods</code> header (as opposed to the <code>Access-Control-Allow-Origin</code> header?</p><p>That's related to another part of CORS processing - &quot;preflight&quot; requests.</p><h4>Preflight CORS processing</h4><p>In some cross origin resource retrieval circumstances, a browser will also send a so-called &quot;preflight&quot; request. Basically, if the intended HTTP request to the remote server is not considered a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests">simple request</a>, then a preflight request is made first.</p><p>For example, if the method of the intended request is something other than <code>GET</code>, <code>HEAD</code> or <code>POST</code>, or if there are headers that will be supplied that are not &quot;standard&quot;, then a preflight request is made, to check that the remote server is indeed willing to handle such an intended request.</p><p>And preflight requests take the form of an HTTP request with the <code>OPTIONS</code> method. Taking one of those cases of a non-simple request, where the method of the request is going to be <code>PUT</code>, for example, then the browser will first send an HTTP request like this (displayed here using curl's verbose output convention):</p><pre class="language-text"><code class="language-text">> OPTIONS /rest/corstest/go HTTP/1.1<br>> Host: localhost:4004<br>> User-Agent: curl/7.88.1<br>> Accept: */*<br>> Origin: https://qmacro.org<br>> Access-Control-Request-Method: PUT</code></pre><p>This is the preflight request. Note the <code>Access-Control-Request-Method</code> header with the method of the intended request.</p><p>Unless the remote server responds appropriately to such a preflight request, the browser will not allow the actual request to be made. What is an appropriate response here to this preflight request? Something like this:</p><pre class="language-text"><code class="language-text">&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; access-control-allow-origin: https://qmacro.org<br>&lt; access-control-allow-methods: GET,PUT</code></pre><p>In other words, a response that tells the browser &quot;yes, <code>PUT</code> requests from this origin are allowed&quot;.</p><p>And that is exactly what the default server's CORS handling mechanism is doing in the condition that checks whether the HTTP method is <code>OPTIONS</code>, i.e. if it's a preflight request. It adds the <code>Access-Control-Allow-Methods</code> header to response to preflight requests, and includes all the &quot;usual suspect&quot; HTTP methods (<code>GET,HEAD,PUT,PATCH,POST,DELETE</code>).</p><p>For testing, we can actually construct a preflight request, using curl's <code>--request</code> option to be able to specify the HTTP method to use, so that we can see a preflight request/response for real. Here goes:</p><pre class="language-text"><code class="language-text">; curl \<br>    --verbose \<br>    --request OPTIONS \<br>    --header 'Origin: https://qmacro.org' \<br>    --url localhost:4004/rest/corstest/go<br>> OPTIONS /rest/corstest/go HTTP/1.1<br>> Host: localhost:4004<br>> User-Agent: curl/7.88.1<br>> Accept: */*<br>> Origin: https://qmacro.org<br>><br>&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; access-control-allow-origin: https://qmacro.org<br>&lt; access-control-allow-methods: GET,HEAD,PUT,PATCH,POST,DELETE<br>&lt; Content-Length: 0</code></pre><blockquote><p>Note that I didn't actually need to specify an <code>Access-Control-Request-Method</code> header in this preflight request; the CORS support in the default CAP server will just supply an equivalent <code>Allow</code> response header covering the main methods.</p></blockquote><p>Great!</p><h3>The automatic CORS support context</h3><p>Next, let's take the &quot;if not running in production&quot; part.</p><p>Running anything in production requires more thinking about security, resilience, and so on. And while this default &quot;yes, we're open!&quot; CORS support we've seen so far is very useful at design time when you're exploring and iterating, it's probably not what you want in production.</p><p>The <a href="https://cap.cloud.sap/docs/node.js/cds-env#profiles">configuration profile</a> facilities that CAP Node.js offers includes the standard Node.js approach of using the environment variable <code>NODE_ENV</code> to determine in what &quot;mode&quot; the server is running.</p><p>Unless explicitly specified, via a configuration profile (<code>--profile production</code>, or the shorthand <code>--production</code>) or simply directly, via the value <code>production</code> set for <code>NODE_ENV</code><a href="#footnotes"><sup>4</sup></a>, the CAP server is deemed NOT to be in productive mode.</p><p>The startup of the simple CAP server here was brought about simply with <code>cds watch</code>, so it is not running in &quot;production mode&quot; either.</p><p>And this is what's referenced in the first part of the CORS getter in <code>@sap/cds/server.js</code> that we saw earlier:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><br>        <span class="token operator">?</span> <span class="token function-variable function">null</span><br>        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token operator">...</span><br>        <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Here, through the use of one of my favourite constructs, the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_operator">ternary operator</a>, the CORS getter will either return the anonymous function <code>(req, res, next) =&gt; { ... }</code> that adds the CORS &quot;allow&quot; response headers, or nothing at all (<code>null</code>), depending on the value of <code>NODE_ENV</code>.</p><p>So when the <code>cors</code> object property is referenced in the running server to potentially provide CORS processing for a request, there will either be a function ready to do that, or, in the case of a production context, nothing to do anything at all.</p><h2>Adding custom CORS headers</h2><p>The last of the three parts, &quot;you can add CORS to your server as follows&quot;, is where we move away from the standard CORS facilities of the default server.</p><p>The standard facilities will return, as appropriate, one or both of these headers:</p><ul><li><code>Access-Control-Allow-Origin</code></li><li><code>Access-Control-Allow-Methods</code></li></ul><p>My colleague's request for CORS support would have normally been fulfilled by this. The method of the remote request being made from his web app origin was GET. This falls into the &quot;simple request&quot; category. But the remote requests will also include a custom header <code>CommunityID</code>.</p><p>If you worked through the tasks in last August's <a href="https://community.sap.com/t5/technology-blogs-by-sap/sap-developer-challenge-apis/ba-p/13573168">Developer Challenge on APIs</a>, you may remember this header. The hash facility described in <a href="https://community.sap.com/t5/application-development-discussions/sap-developer-challenge-apis-task-0-learn-to-share-your-task-results/m-p/276058#M2319">Task 0 - Learn to share your task results</a> requires you to supply your SAP Community ID in the form of a header in the HTTP request, like this:</p><pre class="language-text"><code class="language-text">CommunityID: qmacro</code></pre><p>This hash facility is the service that my colleague was wanting to call remotely from his web app. And the requirement for this custom header when calling the service<a href="#footnotes"><sup>5</sup></a> meant that such requests are not considered &quot;simple&quot;.</p><p>This in turn meant that preflight requests would be made. Not only that, but the custom header <code>CommunityID</code> would be supplied in such preflight requests in an <code>Access-Control-Request-Headers</code> header too, in a similar way to how any &quot;unusual&quot; HTTP methods would be supplied in an <code>Access-Control-Request-Method</code> header. And the browser will expect, in the responses to such preflight requests, that the custom header is included in an <code>Access-Control-Allow-Headers</code> header.</p><p>But while the built-in CORS handling of the default CAP server provides preflight response support for <code>Access-Control-Request-Method</code> headers, it doesn't provide support for <code>Access-Control-Request-Headers</code> headers.</p><blockquote><p>We can debate whether this should be standard in the default CAP server, i.e. how much CORS support we should expect out of the box, but here I saw it as an opportunity to learn how I might extend the support myself.</p></blockquote><h3>Using a custom server.js</h3><p>The <a href="https://cap.cloud.sap/docs/node.js/cds-server">Boostrapping Servers</a> section of Capire includes information about being able to supply your own <a href="https://cap.cloud.sap/docs/node.js/cds-server#custom-server-js">custom server</a> logic, like this:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span><br><span class="token comment">// react on bootstrapping events...</span><br>cds<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'bootstrap'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span></code></pre><p>This is particularly relevant when we revisit that <a href="https://cap.cloud.sap/docs/node.js/best-practices#cross-origin-resource-sharing-cors">section on CORS</a> mentioned earlier, where it says &quot;... For production, you can add CORS to your server as follows&quot;. And the code example given there is in the context of such a <code>bootstrap</code> event for which custom server implementations are often used - i.e. to hook into part of the CAP server startup to add custom logic:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">ORIGINS</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string-property property">'https://example.com'</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><br>cds<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'bootstrap'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>The <a href="https://cap.cloud.sap/docs/node.js/best-practices#manual-implementation-1">CORS-relevant code presented in this section</a> is similar to the code in the built-in server (as the point of the example shown is to supply an equivalent level of CORS handling that comes out of the box in non production mode). But what was needed to satisfy my colleague's requirement was to handle the custom HTTP header information in the CORS preflight requests.</p><h3>Implementing a custom server.js</h3><p>Essentially I needed to &quot;flip&quot; the value of any incoming <code>Access-Control-Request-Headers</code> header in preflight HTTP requests, by sending that value back in an <code>Access-Control-Allow-Headers</code> header in each corresponding HTTP response.</p><p>How might that look? Well, here's one approach. Note that this code can be simply stored in a file called <code>server.js</code> which will then be picked up automatically on startup:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'custom-cors'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> <span class="token constant">ALLOWED</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\.build\.cloud\.sap|\bqmacro.org)$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><br><br><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'In custom server.js'</span><span class="token punctuation">)</span><br><br>cds<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'bootstrap'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>        <span class="token keyword">const</span> <span class="token punctuation">{</span><br>            <span class="token string-property property">'access-control-request-headers'</span><span class="token operator">:</span> request_headers<span class="token punctuation">,</span><br>            origin<br>        <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<br><br>        <span class="token comment">// Handle headers request in preflight CORS requests</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><br>            req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><br>            <span class="token operator">&amp;&amp;</span> origin<br>            <span class="token operator">&amp;&amp;</span> request_headers<br>            <span class="token operator">&amp;&amp;</span> <span class="token constant">ALLOWED</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><br>        <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Adding allow-headers for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request_headers<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>            res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><br>                <span class="token string">'access-control-allow-headers'</span><span class="token punctuation">,</span><br>                request_headers<br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Breaking this down:</p><ul><li>We not only have the <code>cds</code> constant defined, just like in the example code earlier, but also a custom logging constant <code>log</code>. This is so we can emit log output and have it appear in the CAP server output with a prefix we can easily recognise.</li><li>There's also an <code>ALLOWED</code> constant which is a regular expression that we can use to check the origin, to determine whether or not we want to perform a &quot;headers flip&quot;. This particular regular expression allows anything ending with <code>.build.cloud.sap</code>, and anything from my own <code>qmacro.org</code> domain<a href="#footnotes"><sup>6</sup></a>.</li><li>Following the pattern from the example, we have some logic inside a custom function <code>(req, res, next) =&gt; { ... }</code> that will receive and get to have a say in processing incoming requests.</li></ul><p>The logic inside that custom function goes like this:</p><ul><li>Grab the values of any <code>Origin</code> header and any <code>Access-Control-Request-Headers</code> header<a href="#footnotes"><sup>7</sup></a></li><li>If the request method is <code>OPTIONS</code> (signifying a possible preflight request)</li><li>plus if there's a value for the <code>Origin</code> header</li><li>plus if there's a value for the <code>Access-Control-Request-Headers</code> header</li><li>and the origin is &quot;allowed&quot; according to the regular expression</li><li>then flip the value by adding an <code>Access-Control-Allow-Headers</code> header, with that header value, to the HTTP response</li><li>then &quot;let go&quot; and allow any further processing of that HTTP request to take place</li></ul><h3>The custom server.js logic in action</h3><p>Here's what happens when we try this out. We have the above code in <code>server.js</code> in the CAP project's root directory. Here's a simulation of a preflight request that will be made from the browser in the context of my colleague's web app (except that it's to the test CAP service here of course):</p><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span><br>    <span class="token parameter variable">--verbose</span> <span class="token punctuation">\</span><br>    <span class="token parameter variable">--request</span> OPTIONS <span class="token punctuation">\</span><br>    <span class="token parameter variable">--header</span> <span class="token string">'Access-Control-Request-Method: GET'</span> <span class="token punctuation">\</span><br>    <span class="token parameter variable">--header</span> <span class="token string">'Access-Control-Request-Headers: communityid'</span> <span class="token punctuation">\</span><br>    <span class="token parameter variable">--header</span> <span class="token string">'origin: https://testing-42p9ebmu.eu10.apps.build.cloud.sap'</span> <span class="token punctuation">\</span><br>    <span class="token parameter variable">--url</span> localhost:4004/rest/corstest/go</code></pre><p>Here's the corresponding HTTP request and response details from that verbose output from curl:</p><pre class="language-text"><code class="language-text">> OPTIONS /rest/corstest/go HTTP/1.1<br>> Host: localhost:4004<br>> User-Agent: curl/7.88.1<br>> Accept: */*<br>> Access-Control-Request-Method: GET<br>> Access-Control-Request-Headers: communityid<br>> origin: https://testing-42p9ebmu.preview.eu10.apps.build.cloud.sap<br>><br>&lt; HTTP/1.1 200 OK<br>&lt; X-Powered-By: Express<br>&lt; access-control-allow-headers: communityid<br>&lt; access-control-allow-origin: https://testing-42p9ebmu.eu10.apps.build.cloud.sap<br>&lt; access-control-allow-methods: GET,HEAD,PUT,PATCH,POST,DELETE<br>&lt; Content-Length: 0</code></pre><p>Excellent - we now have the <code>communityid</code> header value &quot;flipped&quot; and returned in the CORS preflight response.</p><p>And here's (some reduced) log output from the CAP server, showing the loading of the custom server, and the custom log record output too:</p><pre class="language-log"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading server from <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'server.js'</span> <span class="token operator">}</span><br><span class="token punctuation">[</span>custom<span class="token operator">-</span>cors<span class="token punctuation">]</span> <span class="token operator">-</span> in custom <span class="token domain constant">server.js</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded model from <span class="token number">1</span> file<span class="token operator">(</span>s<span class="token operator">)</span><span class="token operator">:</span><br><br>  <span class="token domain constant">services.cds</span><br><br><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving corstest <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'services.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/rest/corstest'</span> <span class="token operator">}</span><br><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004'</span> <span class="token operator">}</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched at <span class="token date number">3/31/2024</span><span class="token punctuation">,</span> <span class="token time number">8:20:37</span> AM<span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token number">7.8.0</span><span class="token punctuation">,</span> in<span class="token operator">:</span> <span class="token number">2.226s</span><br><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> terminate with <span class="token operator">^</span>C <span class="token punctuation">]</span><br><br><span class="token punctuation">[</span>custom<span class="token operator">-</span>cors<span class="token punctuation">]</span> <span class="token operator">-</span> Adding allow<span class="token operator">-</span>headers for communityid</code></pre><h2>Wrapping up</h2><p>That's pretty much mission accomplished, and my colleague can now successfully make use of my service from the web app, served from a different origin, in the browser.</p><hr><p><a name="footnotes"></a></p><h2>Footnotes</h2><p>1: This phrase borrows from &quot;the simplest thing that could possibly work&quot;, from Ward Cunningham. See my recording of &quot;The Simplest Thing that Could Possibly Work, A conversation with Ward Cunningham&quot; in the <a href="https://podcasters.spotify.com/pod/show/tech-aloud/episodes/The-Simplest-Thing-that-Could-Possibly-Work--A-conversation-with-Ward-Cunningham--Part-V---Bill-Venners-e5dpts">Tech Aloud podcast episode</a>.</p><p>2: You may have noticed the removal of the standard directories <code>app/</code>, <code>srv/</code> and <code>db/</code> when we set this project up; this is just to keep things as simple as possible. The file name <code>services.cds</code> (and its corresponding default implementation file <code>services.js</code>) is part of the CAP server &quot;roots&quot; that are valid default locations and files that it looks at. You can see this for yourself by running <code>cds env roots</code> which will emit <code>[ 'db/', 'srv/', 'app/', 'schema', 'services' ]</code>.</p><p>3: When asked to provide verbose output, curl prefixes the outgoing HTTP request headers with <code>&gt;</code> and the incoming HTTP response headers with <code>&lt;</code>.</p><p>4: Ultimately, however you specify the mode, the appropriate value will end up in <code>NODE_ENV</code> for the server to be able to check.</p><p>5: The requirement to supply a custom header in calls to the hash facility was deliberate, to encourage the participants to explore a tiny bit beyond standard HTTP requests. After all, the challenge was all about APIs and making HTTP calls.</p><p>6: The <code>\b</code> is a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Word_boundary_assertion">word boundary assertion</a>, and used here means that it will allow values like <code>https://qmacro.org</code>, <code>http://test.qmacro.org</code> and so on, but not something like <code>fakeqmacro.org</code>.</p><p>7: This is done using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destructuring</a>, and the first of the two assignments has the slightly extended syntax, to provide the alternative identifier <code>request_headers</code>, as <code>access-control-request-headers</code> would not be a valid JavaScript identifier.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cap/">#cap</a> <a href="/tags/cors/">#cors</a> <a href="/tags/javascript/">#javascript</a> <a href="/tags/nodejs/">#nodejs</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/04/05/cap-cds-cdl-csn-and-jq-finding-associations/"><span>←</span> <span>CAP, CDS, CDL, CSN and jq - finding associations</span> </a><a href="/blog/posts/2024/03/27/test-drive-joule&#39;s-generative-ai-features-in-sap-build-code-now!/"><span>Test drive Joule&#39;s generative AI features in SAP Build Code now!</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>