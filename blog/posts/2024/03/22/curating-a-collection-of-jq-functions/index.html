<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Curating a collection of jq functions</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="Curating a collection of jq functions">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Reserving the right to be wrong.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2024/03/22/curating-a-collection-of-jq-functions/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="curating-a-collection-of-jq-functions">Curating a collection of jq functions</h1>

<ul class="post-metadata">
	<li><time datetime="2024-03-22">22 March 2024</time></li>
	<li><a href="/tags/jq/" class="post-tag">jq</a></li>
</ul>

<p class="post-description-main"></p>

<p>I read a very interesting article <a href="https://www.pgrs.net/2024/03/21/duckdb-as-the-new-jq/">DuckDB as the New jq</a> today, plus an equally engaging conversation in <a href="https://lobste.rs/s/x5immj/duckdb_as_new_jq">the Lobsters thread about it</a>.</p>
<p>In the article the author Paul wants to summarise <a href="https://api.github.com/orgs/golang/repos">Go repos</a> by licence, and uses SQL in DuckDB to do it. Very nice! He also mentions jq, and that he finds it hard to use and needs to refer to the documentation for anything more than just selecting fields. Fair enough.</p>
<p>The jq example he came up with looks like this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>license<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">license</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>license<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token property-literal property">count</span><span class="token punctuation">:</span> length<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token operator pipe">|</span> <span class="token c-style-function function">sort_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
  <span class="token operator pipe">|</span> reverse</code></pre>
<p>I recognised the &quot;pattern&quot; of using <code>group_by</code> then <code>map</code> to arrange the results by the value that was used to group the data (<code>.license.key</code>), with the result for each of the values being a count (<code>length</code>).</p>
<p>I have used this pattern a lot, and this article and example prompted me to think about how I might build up a collection of small functions that would be always available to me. In <a href="https://jqlang.github.io/jq/manual/#modules">the Modules section of the jq manual</a> it says, amongst plenty of other things, that:</p>
<blockquote>
<p>If <code>$HOME/.jq</code> is a file, it is sourced into the main program.</p>
</blockquote>
<p>So I took the step of creating <code>~/.jq</code>, as a symbolic link to a file of the same name in my <a href="https://github.com/qmacro/dotfiles">dotfiles</a> which I have in my dev containers.</p>
<p>In it, I took a first stab with this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">count_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token operator pipe">|</span>key<span class="token punctuation">,</span>
        <span class="token property-literal property">value</span><span class="token punctuation">:</span> length
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span></code></pre>
<p>Assuming I have the contents of the JSON resource at <a href="https://api.github.com/orgs/golang/repos">https://api.github.com/orgs/golang/repos</a> in a file called <code>data.json</code>, I can now use <code>count_by</code> like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">jq <span class="token string">'count_by(.license.key)'</span> data.json</code></pre>
<p>which will produce this:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"apache-2.0"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"bsd-3-clause"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">23</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>(I quite like the idea of using the &quot;generic&quot; property names <code>key</code> and <code>value</code> as it feels more compatible, at least in my brain, with how I think about using <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">to_entries, from_entries and with_entries</a>).</p>
<p>Going one step further, I added this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">group_with</span><span class="token punctuation">(</span>key<span class="token punctuation">;</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token operator pipe">|</span>key<span class="token punctuation">,</span> 
        <span class="token property-literal property">value</span><span class="token punctuation">:</span> value
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span></code></pre>
<p>This means that I can now additionally supply an expression to determine the value of the <code>value</code> property, rather than just the count as with the current version of <code>count_by</code>. Here's an example:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">jq <span class="token string">'group_with(.license.key;map(.name))'</span> data.json</code></pre>
<p>This produces:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"blog"</span><span class="token punctuation">,</span>
      <span class="token string">"talks"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"apache-2.0"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"glog"</span><span class="token punctuation">,</span>
      <span class="token string">"groupcache"</span><span class="token punctuation">,</span>
      <span class="token string">"appengine"</span><span class="token punctuation">,</span>
      <span class="token string">"geo"</span><span class="token punctuation">,</span>
      <span class="token string">"mock"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"bsd-3-clause"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"gddo"</span><span class="token punctuation">,</span>
      <span class="token string">"lint"</span><span class="token punctuation">,</span>
      <span class="token string">"oauth2"</span><span class="token punctuation">,</span>
      <span class="token string">"example"</span><span class="token punctuation">,</span>
      <span class="token string">"go"</span><span class="token punctuation">,</span>
      <span class="token string">"winstrap"</span><span class="token punctuation">,</span>
      <span class="token string">"review"</span><span class="token punctuation">,</span>
      <span class="token string">"protobuf"</span><span class="token punctuation">,</span>
      <span class="token string">"tools"</span><span class="token punctuation">,</span>
      <span class="token string">"benchmarks"</span><span class="token punctuation">,</span>
      <span class="token string">"..."</span><span class="token punctuation">,</span>
      <span class="token string">"snappy"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>I can now also redefine the more specific <code>count_by</code> using <code>group_with</code>, like this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">count_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token c-style-function function">group_with</span><span class="token punctuation">(</span>key<span class="token punctuation">;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>That seems quite nice to me.</p>
<p>This short post is not to try and convince folks about what's better; it's more to share my thoughts about jq as a language with <a href="https://jqlang.github.io/jq/manual/#modules">module</a>, collections of sibling functions (such as the <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">_entries family</a> mentioned earlier, and the ability to <a href="https://jqlang.github.io/jq/manual/#defining-functions">define a collection of useful functions</a> and use them easily in <code>jq</code> (and <code>ijq</code> for that matter) invocation contexts.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/03/12/iso-content-for-common-cap-types/">ISO content for common CAP types</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/03/27/test-drive-joules-generative-ai-features-in-sap-build-code-now/">Test drive Joule&#39;s generative AI features in SAP Build Code now!</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/03/22/curating-a-collection-of-jq-functions/` was built on 2026-01-07T07:10:38.855Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
