<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/03/22/curating-a-collection-of-jq-functions/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.7884d8f8e9dd86c3b137.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Curating a collection of jq functions | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Curating a collection of jq functions"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/03/22/curating-a-collection-of-jq-functions/"><meta name="description" content="Curating a collection of jq functions 22 Mar 2024 | 2 min read I read a very interesting article DuckDB as the New jq today, plus an equally..."><meta property="og:description" content="Curating a collection of jq functions 22 Mar 2024 | 2 min read I read a very interesting article DuckDB as the New jq today, plus an equally..."><meta name="description" content="Curating a collection of jq functions 22 Mar 2024 | 2 min read I read a very interesting article DuckDB as the New jq today, plus an equally..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Curating a collection of jq functions</h1><div class="post__details"><time datetime="2024-03-22">22 Mar 2024 </time><span>| </span><span>2 min read</span></div></header><main class="post__content"><p>I read a very interesting article <a href="https://www.pgrs.net/2024/03/21/duckdb-as-the-new-jq/">DuckDB as the New jq</a> today, plus an equally engaging conversation in <a href="https://lobste.rs/s/x5immj/duckdb_as_new_jq">the Lobsters thread about it</a>.</p><p>In the article the author Paul wants to summarise <a href="https://api.github.com/orgs/golang/repos">Go repos</a> by licence, and uses SQL in DuckDB to do it. Very nice! He also mentions jq, and that he finds it hard to use and needs to refer to the documentation for anything more than just selecting fields. Fair enough.</p><p>The jq example he came up with looks like this:</p><pre class="language-jq"><code class="language-jq"><span class="token c-style-function function">group_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>license<span class="token punctuation">.</span>key<span class="token punctuation">)</span><br>  <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token property-literal property">license</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>license<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token property-literal property">count</span><span class="token punctuation">:</span> length<span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token operator pipe">|</span> <span class="token c-style-function function">sort_by</span><span class="token punctuation">(</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><br>  <span class="token operator pipe">|</span> reverse</code></pre><p>I recognised the &quot;pattern&quot; of using <code>group_by</code> then <code>map</code> to arrange the results by the value that was used to group the data (<code>.license.key</code>), with the result for each of the values being a count (<code>length</code>).</p><p>I have used this pattern a lot, and this article and example prompted me to think about how I might build up a collection of small functions that would be always available to me. In <a href="https://jqlang.github.io/jq/manual/#modules">the Modules section of the jq manual</a> it says, amongst plenty of other things, that:</p><blockquote><p>If <code>$HOME/.jq</code> is a file, it is sourced into the main program.</p></blockquote><p>So I took the step of creating <code>~/.jq</code>, as a symbolic link to a file of the same name in my <a href="https://github.com/qmacro/dotfiles">dotfiles</a> which I have in my dev containers.</p><p>In it, I took a first stab with this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">count_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><br>    <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        <span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token operator pipe">|</span>key<span class="token punctuation">,</span><br>        <span class="token property-literal property">value</span><span class="token punctuation">:</span> length<br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">;</span></code></pre><p>Assuming I have the contents of the JSON resource at <a href="https://api.github.com/orgs/golang/repos">https://api.github.com/orgs/golang/repos</a> in a file called <code>data.json</code>, I can now use <code>count_by</code> like this:</p><pre class="language-shell"><code class="language-shell">jq <span class="token string">'count_by(.license.key)'</span> data.json</code></pre><p>which will produce this:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">2</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"apache-2.0"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">5</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"bsd-3-clause"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">23</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>(I quite like the idea of using the &quot;generic&quot; property names <code>key</code> and <code>value</code> as it feels more compatible, at least in my brain, with how I think about using <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">to_entries, from_entries and with_entries</a>).</p><p>Going one step further, I added this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">group_with</span><span class="token punctuation">(</span>key<span class="token punctuation">;</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token c-style-function function">group_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><br>    <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        <span class="token property-literal property">key</span><span class="token punctuation">:</span> first<span class="token operator pipe">|</span>key<span class="token punctuation">,</span> <br>        <span class="token property-literal property">value</span><span class="token punctuation">:</span> value<br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">;</span></code></pre><p>This means that I can now additionally supply an expression to determine the value of the <code>value</code> property, rather than just the count as with the current version of <code>count_by</code>. Here's an example:</p><pre class="language-shell"><code class="language-shell">jq <span class="token string">'group_with(.license.key;map(.name))'</span> data.json</code></pre><p>This produces:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"blog"</span><span class="token punctuation">,</span><br>      <span class="token string">"talks"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"apache-2.0"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"glog"</span><span class="token punctuation">,</span><br>      <span class="token string">"groupcache"</span><span class="token punctuation">,</span><br>      <span class="token string">"appengine"</span><span class="token punctuation">,</span><br>      <span class="token string">"geo"</span><span class="token punctuation">,</span><br>      <span class="token string">"mock"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"bsd-3-clause"</span><span class="token punctuation">,</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token string">"gddo"</span><span class="token punctuation">,</span><br>      <span class="token string">"lint"</span><span class="token punctuation">,</span><br>      <span class="token string">"oauth2"</span><span class="token punctuation">,</span><br>      <span class="token string">"example"</span><span class="token punctuation">,</span><br>      <span class="token string">"go"</span><span class="token punctuation">,</span><br>      <span class="token string">"winstrap"</span><span class="token punctuation">,</span><br>      <span class="token string">"review"</span><span class="token punctuation">,</span><br>      <span class="token string">"protobuf"</span><span class="token punctuation">,</span><br>      <span class="token string">"tools"</span><span class="token punctuation">,</span><br>      <span class="token string">"benchmarks"</span><span class="token punctuation">,</span><br>      <span class="token string">"..."</span><span class="token punctuation">,</span><br>      <span class="token string">"snappy"</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>I can now also redefine the more specific <code>count_by</code> using <code>group_with</code>, like this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">count_by</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token c-style-function function">group_with</span><span class="token punctuation">(</span>key<span class="token punctuation">;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>That seems quite nice to me.</p><p>This short post is not to try and convince folks about what's better; it's more to share my thoughts about jq as a language with <a href="https://jqlang.github.io/jq/manual/#modules">module</a>, collections of sibling functions (such as the <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">_entries family</a> mentioned earlier, and the ability to <a href="https://jqlang.github.io/jq/manual/#defining-functions">define a collection of useful functions</a> and use them easily in <code>jq</code> (and <code>ijq</code> for that matter) invocation contexts.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/jq/">#jq</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/03/27/test-drive-joule&#39;s-generative-ai-features-in-sap-build-code-now!/"><span>←</span> <span>Test drive Joule&#39;s generative AI features in SAP Build Code now!</span> </a><a href="/blog/posts/2024/03/12/iso-content-for-common-cap-types/"><span>ISO content for common CAP types</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.bsky.social" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>