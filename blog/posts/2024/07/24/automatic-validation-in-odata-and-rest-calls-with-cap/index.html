<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Automatic validation in OData and REST calls with CAP</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="Automatic validation in OData and REST calls with CAP">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Reserving the right to be wrong.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2024/07/24/automatic-validation-in-odata-and-rest-calls-with-cap/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="automatic-validation-in-odata-and-rest-calls-with-cap">Automatic validation in OData and REST calls with CAP</h1>

<ul class="post-metadata">
	<li><time datetime="2024-07-24">24 July 2024</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/rest/" class="post-tag">rest</a>, </li>
	<li><a href="/tags/odata/" class="post-tag">odata</a></li>
</ul>

<p class="post-description-main"></p>

<p>There is automatic validation of data coming into CAP-based service endpoints. Up until recently, there was a difference on how this happened between &quot;REST&quot; and OData channels, but with the latest CAP major release the handling has been aligned. This blog post digs into the details, focusing on the Node.js flavour of CAP.</p>
<h2 id="introduction">Introduction</h2>
<p>CAP services are served by default via the OData V4 protocol. If you annotate a service definition with: <code>@protocol: 'rest'</code> or simply <code>@rest</code> then it will be served via the &quot;REST&quot; protocol. I put REST in quotes as of course REST is not a protocol, it's an architectural style. But that's <a href="https://qmacro.org/tags/rest/">another discussion</a>. Think of this &quot;REST&quot; protocol here as a slimmed down little brother of the OData V4 protocol, without a lot of the metadata context. In fact, one can think of these <a href="https://cap.cloud.sap/docs/node.js/cds-serve#protocol">protocols</a>, in their use in exposing services, as &quot;channels&quot;, or &quot;adapters&quot;.</p>
<p>Last month saw a new <a href="https://cap.cloud.sap/docs/releases/jun24#new-majors-cds8-cap-java-3">major release</a> of CAP Node.js, bringing it to version 8. With that major release came <a href="https://cap.cloud.sap/docs/releases/jun24#new-protocol-adapters-ga">new protocol adapters</a> for OData V4 and &quot;REST&quot;. Before version 8, i.e. up until very recently, the libraries in CAP for handling incoming OData V4 based and &quot;REST&quot; based requests have been separate, and had different behaviours.</p>
<h2 id="example-base">Example base</h2>
<p>To illustrate aspects of protocol handling in this blog post, I'll use a simple CDS model in <code>services.cds</code> that looks like this:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token annotation important">@rest</span>  <span class="token annotation important">@path:</span> '/rest'
<span class="token keyword">service</span> rest {
    <span class="token keyword">action</span> a(x : <span class="token type builtin">Integer</span>)
}

<span class="token annotation important">@odata</span>  <span class="token annotation important">@path:</span> '/odata'
<span class="token keyword">service</span> odata {
    <span class="token keyword">action</span> a(x : <span class="token type builtin">Integer</span>)
}</code></pre>
<p>There are two service definitions, each with the same simple unbound action <code>a</code> that expects a single integer parameter called <code>x</code>. One service is called <code>rest</code> and is exposed via the &quot;REST&quot; protocol at path <code>/rest</code>, and the other is called <code>odata</code> and is exposed via the OData V4 protocol at path <code>/odata</code>.</p>
<p>The section of the OData metadata definition (available at <code>/odata/$metadata</code>) for action <code>a</code> looks like this:</p>
<pre class="language-xml" tabindex="0"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Schema</span> <span class="token attr-name">Namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>odata<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://docs.oasis-open.org/odata/ns/edm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EntityContainer</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EntityContainer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ActionImport</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a<span class="token punctuation">"</span></span> <span class="token attr-name">Action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>odata.a<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EntityContainer</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Action</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a<span class="token punctuation">"</span></span> <span class="token attr-name">IsBound</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Parameter</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Edm.Int32<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Action</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Schema</span><span class="token punctuation">></span></span></code></pre>
<p>Here's what the implementation file <code>service.js</code> looks like:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'qmacro'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">cds<span class="token punctuation">.</span>ApplicationService</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token string">'rest'</span><span class="token punctuation">,</span> <span class="token string">'odata'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> module<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">S</span><span class="token punctuation">)</span></code></pre>
<p>Basically the same class <code>S</code> is used for each of the two services, and all this class really contains is the registration of a handler for the <code>a</code> event (via <code>this.on</code>) that logs the protocol (either <code>rest</code> or <code>odata</code>) from the incoming request plus a stringified version of the data received. It doesn't return anything, which aligns with the fact that there's no return type defined for the action. So, nice and simple.</p>
<p>OK, back to the narrative.</p>
<h2 id="pre-version-8-history">Pre version 8 history</h2>
<p>The separate nature of the two protocol adapters in question meant that there could be — and indeed were — different implementations and levels of support for receiving, checking, processing and dispatching incoming requests.</p>
<p>Let's look at the OData V4 protocol adapter first. This was based on an existing library called <code>okra</code>, which you may well have seen in any stack trace style error messages, for example:</p>
<pre class="language-text" tabindex="0"><code class="language-text">node_modules/@sap/cds-runtime/lib/cds-services/adapter/
  odata-v4/okra/odata-commons/uri/ExpandParser.js</code></pre>
<p>(split over two lines for readability).</p>
<h3 id="odata-validation">OData validation</h3>
<p>OData in general is rather strict on what data can be passed to a function or an action. Taking the definition of action <code>a</code> in the metadata above, if we were to make the following HTTP request:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"x":42}'</span> <span class="token punctuation">\</span>
  cap:4004/odata/a</code></pre>
<p>which looks like this on the wire:</p>
<pre class="language-log" tabindex="0"><code class="language-log">POST <span class="token file-path string">/odata/a</span> HTTP<span class="token operator">/</span><span class="token number">1.1</span>
<span class="token property">Host:</span> cap<span class="token operator">:</span><span class="token number">4004</span>
<span class="token property">Content-Type:</span> application<span class="token operator">/</span>json
<span class="token property">Content-Length:</span> <span class="token number">8</span>

<span class="token operator">{</span><span class="token string">"x"</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">}</span></code></pre>
<p>then the request would be received, accepted as valid and sent to the service implementation for processing. We also see this in the log output from the server, via the anonymous function we wired up as a handler for the <code>a</code> event earlier:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> odata<span class="token operator">-</span><span class="token number">v4</span><span class="token operator">:</span> <span class="token operator">{</span><span class="token string">"x"</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">}</span></code></pre>
<p>However, if we were to make the following HTTP request (note the <code>z</code> property name instead of <code>x</code> in the JSON payload):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"z":42}'</span> <span class="token punctuation">\</span>
  cap:4004/odata/a</code></pre>
<p>then we'd get an HTTP 400 error response with the following in the payload:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"400"</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Deserialization Error: 'z' is not a non-binding parameter of action 'a'."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The fact that the status code is in the 400 range tells us that <em>we</em> are to blame. Harsh, but fair. This type of rejection will keep happening as long as we send payloads in our requests that don't match the shape described for the action in the metadata.</p>
<h3 id="rest-validation">REST validation</h3>
<p>Still pre version 8, the validation is looser for the same action in the service when served via the &quot;REST&quot; protocol adapter.</p>
<p>Sending the same valid call (i.e. with parameter <code>x</code>) but to the &quot;REST&quot; exposed endpoint, like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"x":42}'</span> <span class="token punctuation">\</span>
  cap:4004/rest/a</code></pre>
<p>also results in a successful handling of the request, and a line line this output to the log:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> rest<span class="token operator">:</span> <span class="token operator">{</span><span class="token string">"x"</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">}</span></code></pre>
<p>However, the same &quot;incorrect&quot; call (i.e. with the parameter named <code>z</code> instead of <code>x</code>) is in fact <em>received and accepted</em> by the &quot;REST&quot; protocol adapter.</p>
<p>Yet what appears in the log output is not this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> rest<span class="token operator">:</span> <span class="token operator">{</span><span class="token string">"z"</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">}</span></code></pre>
<p>but this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> rest<span class="token operator">:</span> <span class="token operator">{</span><span class="token operator">}</span></code></pre>
<p>What happens is that anything not recognised according to the action's signature ... is discarded. The <code>z</code> parameter wasn't recognised, and thus discarded, leaving an empty object <code>{}</code>. We can dig in a little more by trying a call like this, with a correct main parameter <code>x</code> but with another parameter too, expressed as another property in the JSON object:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"x":42,"name":"qmacro"}'</span> <span class="token punctuation">\</span>
  cap:4004/rest/a</code></pre>
<p>The request is received, accepted and handled successfully, except that the log output shows that the value for the <code>name</code> parameter, i.e. the entire property in the JSON object, was discarded before it reached the handler:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> rest<span class="token operator">:</span> <span class="token operator">{</span><span class="token string">"x"</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">}</span></code></pre>
<p>In case you're wondering, if we sent this same payload to the service via the OData protocol adapter, we'd get an error, of course:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"400"</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Deserialization Error: 'name' is not a non-binding parameter of action 'a'."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="taking-advantage">Taking advantage</h4>
<p>A fascinating aspect here is that this discarding of unrecognised properties only happens ... with objects (at the JSON level). Look what happens when a different shaped JSON value is passed in the payload - an array:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'[1,2,3]'</span> <span class="token punctuation">\</span>
  cap:4004/rest/a</code></pre>
<p>The request is received, accepted and handled successfully, but this time, nothing is discarded, and the handler receives the entire value (in <code>req.data</code>). Look what is emitted in the log:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> rest<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span></code></pre>
<blockquote>
<p>This, incidentally, is how I was able to <a href="https://community.sap.com/t5/application-development-discussions/task-6-api-endpoint-with-payload-required-july-developer-challenge-quot/m-p/13765529#toc-hId-430780965">send a plain array of numbers from the TESTER in Task 6 of this month's SAP Developer Challenge</a>:</p>
<pre class="language-log" tabindex="0"><code class="language-log">POST <span class="token file-path string">/rest/plain/highestValue</span> HTTP<span class="token operator">/</span><span class="token number">1.1</span>
<span class="token property">Host:</span> localhost<span class="token operator">:</span><span class="token number">8000</span>
<span class="token property">Content-Type:</span> application<span class="token operator">/</span>json
<span class="token property">Content-Length:</span> <span class="token number">19</span>

<span class="token punctuation">[</span><span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">203</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></code></pre>
<p>and still expect participants' handlers to be able to receive and process that array :-)</p>
<p>This was quite subtle, and <a href="https://community.sap.com/t5/application-development-discussions/task-6-api-endpoint-with-payload-required-july-developer-challenge-quot/m-p/13766999/highlight/true#M2029250">very well spotted by member MioYasutake</a>!</p>
</blockquote>
<p>OK. So all of that was pre-major version 8 of CAP Node.js. All the examples here were taken from a test setup using <a href="https://www.npmjs.com/package/@sap/cds-dk/v/7.9.6">@sap/cds-dk version 7.9.6</a>.</p>
<p>Things have changed quite significantly, and for the better, with version 8.</p>
<h2 id="new-protocol-adapter-behaviour-in-version-8">New protocol adapter behaviour in version 8</h2>
<p>As mentioned in the <a href="https://cap.cloud.sap/docs/releases/jun24">release notes</a>, the team have <a href="https://cap.cloud.sap/docs/releases/jun24#new-protocol-adapters-ga">completely reimplemented the adapters for OData and &quot;REST&quot;</a> for CAP Node.js.</p>
<p>The notes mention that the &quot;<em>code base of <code>@sap/cds</code> is reduced by a factor of 2</em>&quot;. One of the main reasons for this is that both protocol adapters share the same code for much of what they need to do. And that includes the receipt, validation and acceptance of data in incoming requests.</p>
<p>You can see where this is going, right? Yes, this means that requests coming in via either adapter will be subject to stricter checking, driven by the stricter OData standard. But that's OK, as they're more similar than one would think (mostly because, as I keep saying, there's no such thing as a REST protocol, there has to be something more concrete, and that more concrete thing is something <em>based on</em> the OData V4 standard).</p>
<h3 id="stricter-validation-all-round">Stricter validation all round</h3>
<p>What does this mean for us? Well, trying any of the &quot;incorrect&quot; requests that we made to the <code>/rest/a</code> endpoint earlier now results in rejection. For example, the array of integers (<code>[1,2,3]</code>) is rejected thus:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">{</span>
  <span class="token string">"error"</span><span class="token operator">:</span> <span class="token operator">{</span>
    <span class="token string">"code"</span><span class="token operator">:</span> <span class="token string">"400"</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token operator">:</span> <span class="token string">"Property \"0\" does not exist in rest.a"</span>
  <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>(The reference to property <code>&quot;0&quot;</code> is based on the fact that in JavaScript, &quot;everything is an object&quot;).</p>
<p><a name="opentypes"></a></p>
<h3 id="open-types">Open types</h3>
<p>This isn't as bad as it seems!</p>
<p>You may (or may not) have come across the <code>OpenType</code> attribute in OData, specifically to be able to define an <a href="https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/odata-csdl-xml-v4.01.html#sec_OpenEntityType">entity type as being open</a>. This &quot;<em>allows clients to add properties dynamically to instances of the type by specifying uniquely named property values in the payload used to insert or update an instance of the type.</em>&quot;.</p>
<p>This <code>OpenType</code> feature is supported in CAP, in the form of a CDS model annotation <code>@open</code>, described in the <a href="https://cap.cloud.sap/docs/advanced/odata#open-types">Open Types</a> section of Capire. What's more, this annotation can not only be applied to entity types and complex types, but also other definitions in the model ... such as actions!</p>
<p>If we annotate the action definitions in the CDS model, like this:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token annotation important">@rest</span>  <span class="token annotation important">@path:</span> '/rest'
<span class="token keyword">service</span> rest {
    <span class="token annotation important">@open</span> <span class="token keyword">action</span> a(x : <span class="token type builtin">Integer</span>)
}

<span class="token annotation important">@odata</span>  <span class="token annotation important">@path:</span> '/odata'
<span class="token keyword">service</span> odata {
    <span class="token annotation important">@open</span> <span class="token keyword">action</span> a(x : <span class="token type builtin">Integer</span>)
}</code></pre>
<p>then all the previously &quot;incorrect&quot; payloads sent in requests to action <code>a</code> in either the <code>rest</code> or the <code>odata</code> service will be received, accepted as valid and passed to the handler.</p>
<p>Here's an example. Sending an incorrectly named parameter (<code>z</code> instead of <code>x</code>) plus an extra parameter (<code>name</code>) to the <code>@open</code>-annotated action in either the <code>rest</code> service or the <code>odata</code> service (the call to the <code>rest</code> service is shown here):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"x":42,"name":"qmacro"}'</span> <span class="token punctuation">\</span>
  cap:4004/rest/a</code></pre>
<p>results in success, and everything sent is available in <code>req.data</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>qmacro<span class="token punctuation">]</span> <span class="token operator">-</span> odata<span class="token operator">:</span> <span class="token operator">{</span><span class="token string">"z"</span><span class="token operator">:</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"qmacro"</span><span class="token operator">}</span></code></pre>
<p>Excellent!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Well, that just about wraps it up for this topic. Oh, there's one more thing to mention - in the <a href="https://cap.cloud.sap/docs/releases/jun24#new-protocol-adapters-ga">release note details for the new protocol adapters</a>, there's a note saying that the former adapters are now deprecated, and there's a config option <code>cds.features.odata_new_adapter</code> that can be set to <code>false</code> if you want to do some experiments in CAP Node.js version 8 with the old adapters.</p>
<p>And yes, you can see the difference when you start the CAP server. Starting it like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds <span class="token function">watch</span></code></pre>
<p>i.e. without this config option, we see &quot;using new OData adapter&quot; in the log output (reduced here for brevity):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving rest <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'services.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/rest'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using new OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving odata <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'services.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/odata'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched at <span class="token date number">7/24/2024</span><span class="token punctuation">,</span> <span class="token time number">5:33:10</span> PM<span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token number">8.0.3</span><span class="token punctuation">,</span> in<span class="token operator">:</span> <span class="token number">408.851ms</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> terminate with <span class="token operator">^</span>C <span class="token punctuation">]</span></code></pre>
<p>This is the new shared, consistent, OData-style strict mode that we now have with CAP Node.js version 8.</p>
<p>Starting it like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token assign-left variable">CDS_CONFIG</span><span class="token operator">=</span><span class="token string">'{"features":{"odata_new_adapter":false}}'</span> cds <span class="token function">watch</span></code></pre>
<p>i.e. with this config option set, we see &quot;using legacy OData adapter&quot; in the log output (reduced here for brevity):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving rest <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'services.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/rest'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using legacy OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving odata <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'services.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/odata'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched at <span class="token date number">7/24/2024</span><span class="token punctuation">,</span> <span class="token time number">5:33:10</span> PM<span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token number">8.0.3</span><span class="token punctuation">,</span> in<span class="token operator">:</span> <span class="token number">408.851ms</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> terminate with <span class="token operator">^</span>C <span class="token punctuation">]</span></code></pre>
<p>and we're back to pre version 8 behaviour.</p>
<p>OK, that's it!</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/07/23/reduce-the-ur-function/">reduce - the ur-function</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/08/24/using-lazydocker-with-ssh-based-remote-contexts/">Using lazydocker with SSH-based remote contexts</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/07/24/automatic-validation-in-odata-and-rest-calls-with-cap/` was built on 2026-01-12T15:45:53.999Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
