<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/07/12/turning-an-odata-expand-into-a-cds.ql-cql-query-with-a-projection-function-in-cap/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.fe29f9442e3f93216470.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Turning an OData expand into a cds.ql CQL query with a projection function in CAP | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Turning an OData expand into a cds.ql CQL query with a projection function in CAP"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/07/12/turning-an-odata-expand-into-a-cds.ql-cql-query-with-a-projection-function-in-cap/"><meta name="description" content="Turning an OData expand into a cds.ql CQL query with a projection function in CAP 12 Jul 2024 | 5 min read If, while serving a call to your..."><meta property="og:description" content="Turning an OData expand into a cds.ql CQL query with a projection function in CAP 12 Jul 2024 | 5 min read If, while serving a call to your..."><meta name="description" content="Turning an OData expand into a cds.ql CQL query with a projection function in CAP 12 Jul 2024 | 5 min read If, while serving a call to your..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Turning an OData expand into a cds.ql CQL query with a projection function in CAP</h1><div class="post__details"><time datetime="2024-07-12">12 Jul 2024 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p>If, while serving a call to your provided CAP service, you want to construct some CQL to perform on your database in a similar way to how <code>$expand</code> works in OData, this post may help.</p><blockquote><p>Before I start, note that I'll be using my cut-down version of the classic Northwind service, called Northbreeze, to illustrate things in this post. There's a <a href="https://github.com/qmacro/northbreeze">repo</a> available with this Northbreeze service, which you can clone and use to try out the Node.js calls to functions in the <code>cds.ql</code> module.</p><p>There's also a <a href="https://qmacro.cfapps.eu10.hana.ondemand.com/northbreeze">Northbreeze OData V4 service available</a> where you can try out the OData queries.</p></blockquote><h2>Background</h2><p>A friend asked me the other day how to make a request across the entities in his CDS model, equivalent to how he'd do it in OData, which would be like this:</p><p><a href="https://qmacro.cfapps.eu10.hana.ondemand.com/northbreeze/Categories?$expand=Products">https://qmacro.cfapps.eu10.hana.ondemand.com/northbreeze/Categories?$expand=Products</a></p><p>In other words, how to retrieve Categories plus all the related Products for each one.</p><p>In the context of CAP Node.js, the <a href="https://cap.cloud.sap/docs/node.js/cds-ql">cds.ql module</a> comes into play, and for selecting what should be retrieved, we have the <a href="https://cap.cloud.sap/docs/node.js/cds-ql#columns">columns() method of SELECT</a>.</p><p>The choices presented to the reader in the documentation here, combined with the terminology, can be a little overwhelming at first. The key is to kick the tyres by trying some of the examples out as well as read, re-read, and then re-read again. This is my strategy, at least.</p><p>Anyway, I'll use the <a href="https://github.com/qmacro/northbreeze/blob/26f071775a55c37da929e7e26a2435845337ebca/db/schema.cds#L3-L14">Products</a> and <a href="https://github.com/qmacro/northbreeze/blob/26f071775a55c37da929e7e26a2435845337ebca/db/schema.cds#L33-L39">Categories</a> entities in the Northbreeze CDS model. These entities are related with:</p><ul><li>a to-one association from <code>Products</code> to <code>Categories</code> via a <code>Category</code> element</li><li>a to-many association from <code>Categories</code> to <code>Products</code> via a <code>Products</code> element</li></ul><h2>Setting up</h2><p>Setting up for trying things out, I've cloned the <a href="https://github.com/qmacro/northbreeze">Northbreeze repo</a> and run an <code>npm install</code> there.</p><p>I've then started up the <a href="https://www.youtube.com/shorts/c5flAP_b12E">cds REPL</a> and entered</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">await</span> cds<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>and then</p><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span> Categories<span class="token punctuation">,</span> Products <span class="token punctuation">}</span> <span class="token operator">=</span> cds<span class="token punctuation">.</span>entities</code></pre><p>to set things up. It's in this REPL that I can now try out all my <code>SELECT</code> statements below.</p><p>I've presented the statements across multiple lines for readability; that said, you can copy these statements as they are and paste them into the REPL via the <a href="https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl#dot-commands">.editor facility</a>. In addition, I'm <a href="https://cap.cloud.sap/docs/node.js/cds-ql#limit">limiting</a> the amount of data returned for some of the <code>SELECT</code> calls just for brevity.</p><h2>Starting simple - column expressions within a single entity</h2><p>Following the examples in use the <code>columns()</code> method documentation, I can try some individual column expressions like this:</p><pre class="language-sql"><code class="language-sql">await <span class="token keyword">SELECT</span> <br>  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>Categories<span class="token punctuation">)</span> <br>  <span class="token punctuation">.</span><span class="token keyword">columns</span><span class="token punctuation">(</span> <span class="token string">'CategoryName'</span><span class="token punctuation">,</span> <span class="token string">'Description'</span> <span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token keyword">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>This produces:</p><pre class="language-txt"><code class="language-txt">[<br>  {<br>    CategoryName: 'Beverages',<br>    Description: 'Soft drinks, coffees, teas, beers, and ales'<br>  },<br>  {<br>    CategoryName: 'Condiments',<br>    Description: 'Sweet and savory sauces, relishes, spreads, and seasonings'<br>  },<br>  {<br>    CategoryName: 'Confections',<br>    Description: 'Desserts, candies, and sweet breads'<br>  }<br>]</code></pre><p>So far so good. No surprises there.</p><h2>More confident - path expressions to include data from a related entity</h2><p>I can now try a <a href="https://cap.cloud.sap/docs/cds/cql#path-expressions">path expression</a> to bring in data from the related entity (<code>Products</code>), like this:</p><pre class="language-sql"><code class="language-sql">await <span class="token keyword">SELECT</span> <br>  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>Categories<span class="token punctuation">)</span> <br>  <span class="token punctuation">.</span><span class="token keyword">columns</span><span class="token punctuation">(</span> <span class="token string">'CategoryName'</span><span class="token punctuation">,</span> <span class="token string">'Products.ProductName as Product'</span> <span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token keyword">limit</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></code></pre><p>This produces:</p><pre class="language-txt"><code class="language-txt">[<br>  { CategoryName: 'Beverages', Product: 'Chai' },<br>  { CategoryName: 'Beverages', Product: 'Chang' },<br>  { CategoryName: 'Beverages', Product: 'Chartreuse verte' },<br>  { CategoryName: 'Beverages', Product: 'Côte de Blaye' },<br>  { CategoryName: 'Beverages', Product: 'Guaraná Fantástica' },<br>  { CategoryName: 'Beverages', Product: 'Ipoh Coffee' },<br>  { CategoryName: 'Beverages', Product: 'Lakkalikööri' },<br>  { CategoryName: 'Beverages', Product: 'Laughing Lumberjack Lager' },<br>  { CategoryName: 'Beverages', Product: 'Outback Lager' },<br>  { CategoryName: 'Beverages', Product: 'Rhönbräu Klosterbier' },<br>  { CategoryName: 'Beverages', Product: 'Sasquatch Ale' },<br>  { CategoryName: 'Beverages', Product: 'Steeleye Stout' },<br>  { CategoryName: 'Condiments', Product: 'Aniseed Syrup' },<br>  { CategoryName: 'Condiments', Product: "Chef Anton's Cajun Seasoning" },<br>  { CategoryName: 'Condiments', Product: "Chef Anton's Gumbo Mix" }<br>]</code></pre><p>What's interesting about this is that the data is still &quot;flat&quot; - there's a record for each <code>CategoryName</code> and <code>Products.ProductName</code> combination. This is moving towards, but not quite the &quot;expand&quot; that my friend wanted.</p><h2>Achievement unlocked - using projection functions</h2><p>I'm now ready to try out projection functions as described in the <a href="https://cap.cloud.sap/docs/node.js/cds-ql#columns">columns() section in Capire</a>, especially as they are recommended due to the advantages they have, which includes support for nested projections, otherwise known as &quot;expands&quot;.</p><p>But first, I'll try a simple projection function, to get the general &quot;feel&quot; for them:</p><pre class="language-sql"><code class="language-sql">await <span class="token keyword">SELECT</span> <br>  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>Categories<span class="token punctuation">)</span> <br>  <span class="token punctuation">.</span><span class="token keyword">columns</span><span class="token punctuation">(</span> c <span class="token operator">=</span><span class="token operator">></span> { c<span class="token punctuation">.</span>CategoryName }<span class="token punctuation">)</span></code></pre><p>This produces:</p><pre class="language-txt"><code class="language-txt">[<br>  { CategoryName: 'Beverages' },<br>  { CategoryName: 'Condiments' },<br>  { CategoryName: 'Confections' },<br>  { CategoryName: 'Dairy Products' },<br>  { CategoryName: 'Grains/Cereals' },<br>  { CategoryName: 'Meat/Poultry' },<br>  { CategoryName: 'Produce' },<br>  { CategoryName: 'Seafood' }<br>]</code></pre><p>So far, it's just a different way of expressing the column(s) that I want.</p><p>Now I'll nest another projection function in there, to achieve what my friend wants - the equivalent of the OData <code>$expand</code> system query option, as in the example from earlier (modified here to restrict the elements to just <code>CategoryName</code> and <code>ProductName</code>):</p><p><a href="https://qmacro.cfapps.eu10.hana.ondemand.com/northbreeze/Categories?$select=CategoryName&amp;$expand=Products($select=ProductName)">https://qmacro.cfapps.eu10.hana.ondemand.com/northbreeze/Categories?$select=CategoryName&amp;$expand=Products($select=ProductName)</a></p><p>Here goes:</p><pre class="language-sql"><code class="language-sql">await <span class="token keyword">SELECT</span> <br>  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>Categories<span class="token punctuation">)</span> <br>  <span class="token punctuation">.</span><span class="token keyword">columns</span><span class="token punctuation">(</span> c <span class="token operator">=</span><span class="token operator">></span> { c<span class="token punctuation">.</span>CategoryName<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Products <span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> { p<span class="token punctuation">.</span>ProductName }<span class="token punctuation">)</span> }<span class="token punctuation">)</span></code></pre><p>This produces what we want:</p><pre class="language-txt"><code class="language-txt">[<br>  {<br>    CategoryName: 'Beverages',<br>    Products: [<br>      { ProductName: 'Chai' },<br>      { ProductName: 'Chang' },<br>      { ProductName: 'Guaraná Fantástica' },<br>      { ProductName: 'Sasquatch Ale' },<br>      { ProductName: 'Steeleye Stout' },<br>      { ProductName: 'Côte de Blaye' },<br>      { ProductName: 'Chartreuse verte' },<br>      { ProductName: 'Ipoh Coffee' },<br>      { ProductName: 'Laughing Lumberjack Lager' },<br>      { ProductName: 'Outback Lager' },<br>      { ProductName: 'Rhönbräu Klosterbier' },<br>      { ProductName: 'Lakkalikööri' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Condiments',<br>    Products: [<br>      { ProductName: 'Aniseed Syrup' },<br>      { ProductName: "Chef Anton's Cajun Seasoning" },<br>      { ProductName: "Chef Anton's Gumbo Mix" },<br>      { ProductName: "Grandma's Boysenberry Spread" },<br>      { ProductName: 'Northwoods Cranberry Sauce' },<br>      { ProductName: 'Genen Shouyu' },<br>      { ProductName: 'Gula Malacca' },<br>      { ProductName: "Sirop d'érable" },<br>      { ProductName: 'Vegie-spread' },<br>      { ProductName: 'Louisiana Fiery Hot Pepper Sauce' },<br>      { ProductName: 'Louisiana Hot Spiced Okra' },<br>      { ProductName: 'Original Frankfurter grüne Soße' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Confections',<br>    Products: [<br>      { ProductName: 'Pavlova' },<br>      { ProductName: 'Teatime Chocolate Biscuits' },<br>      { ProductName: "Sir Rodney's Marmalade" },<br>      { ProductName: "Sir Rodney's Scones" },<br>      { ProductName: 'NuNuCa Nuß-Nougat-Creme' },<br>      { ProductName: 'Gumbär Gummibärchen' },<br>      { ProductName: 'Schoggi Schokolade' },<br>      { ProductName: 'Zaanse koeken' },<br>      { ProductName: 'Chocolade' },<br>      { ProductName: 'Maxilaku' },<br>      { ProductName: 'Valkoinen suklaa' },<br>      { ProductName: 'Tarte au sucre' },<br>      { ProductName: 'Scottish Longbreads' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Dairy Products',<br>    Products: [<br>      { ProductName: 'Queso Cabrales' },<br>      { ProductName: 'Queso Manchego La Pastora' },<br>      { ProductName: 'Gorgonzola Telino' },<br>      { ProductName: 'Mascarpone Fabioli' },<br>      { ProductName: 'Geitost' },<br>      { ProductName: 'Raclette Courdavault' },<br>      { ProductName: 'Camembert Pierrot' },<br>      { ProductName: 'Gudbrandsdalsost' },<br>      { ProductName: 'Flotemysost' },<br>      { ProductName: 'Mozzarella di Giovanni' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Grains/Cereals',<br>    Products: [<br>      { ProductName: "Gustaf's Knäckebröd" },<br>      { ProductName: 'Tunnbröd' },<br>      { ProductName: 'Singaporean Hokkien Fried Mee' },<br>      { ProductName: 'Filo Mix' },<br>      { ProductName: 'Gnocchi di nonna Alice' },<br>      { ProductName: 'Ravioli Angelo' },<br>      { ProductName: 'Wimmers gute Semmelknödel' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Meat/Poultry',<br>    Products: [<br>      { ProductName: 'Mishi Kobe Niku' },<br>      { ProductName: 'Alice Mutton' },<br>      { ProductName: 'Thüringer Rostbratwurst' },<br>      { ProductName: 'Perth Pasties' },<br>      { ProductName: 'Tourtière' },<br>      { ProductName: 'Pâté chinois' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Produce',<br>    Products: [<br>      { ProductName: "Uncle Bob's Organic Dried Pears" },<br>      { ProductName: 'Tofu' },<br>      { ProductName: 'Rössle Sauerkraut' },<br>      { ProductName: 'Manjimup Dried Apples' },<br>      { ProductName: 'Longlife Tofu' }<br>    ]<br>  },<br>  {<br>    CategoryName: 'Seafood',<br>    Products: [<br>      { ProductName: 'Ikura' },<br>      { ProductName: 'Konbu' },<br>      { ProductName: 'Carnarvon Tigers' },<br>      { ProductName: 'Nord-Ost Matjeshering' },<br>      { ProductName: 'Inlagd Sill' },<br>      { ProductName: 'Gravad lax' },<br>      { ProductName: 'Boston Crab Meat' },<br>      { ProductName: "Jack's New England Clam Chowder" },<br>      { ProductName: 'Rogede sild' },<br>      { ProductName: 'Spegesild' },<br>      { ProductName: 'Escargots de Bourgogne' },<br>      { ProductName: 'Röd Kaviar' }<br>    ]<br>  }<br>]</code></pre><p>Excellent! Note how the path expression nesting makes sense; here is the value passed to the <code>columns()</code> method, with more whitespace:</p><pre class="language-javascript"><code class="language-javascript"><span class="token parameter">c</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <br>    c<span class="token punctuation">.</span>CategoryName<span class="token punctuation">,</span><br>    c<span class="token punctuation">.</span><span class="token function">Products</span> <span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <br>        p<span class="token punctuation">.</span>ProductName<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>To anyone familiar with JavaScript and ES6 fat arrow functions (and if you're building services with CAP Node.js you're likely to be somewhat acquainted, at least), this &quot;shape&quot; should feels very comfortable. Or at least not alarming.</p><p>Hope this was helpful!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cap/">#cap</a> <a href="/tags/cds/">#cds</a> <a href="/tags/sql/">#sql</a> <a href="/tags/cql/">#cql</a> <a href="/tags/nodejs/">#nodejs</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/07/09/enabling-document-fragment-links-for-headings-in-sap-community-blog-posts/"><span>Enabling document fragment links for headings in SAP Community blog posts</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>