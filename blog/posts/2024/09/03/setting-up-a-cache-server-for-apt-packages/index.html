<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Setting up a cache server for apt packages</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		
	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="setting-up-a-cache-server-for-apt-packages">Setting up a cache server for apt packages</h1>

<ul class="post-metadata">
	<li><time datetime="2024-09-03">03 September 2024</time></li>
	<li><a href="/tags/debian/" class="post-tag">debian</a>, </li>
	<li><a href="/tags/cacheing/" class="post-tag">cacheing</a>, </li>
	<li><a href="/tags/homeops/" class="post-tag">homeops</a>, </li>
	<li><a href="/tags/proxmox/" class="post-tag">proxmox</a>, </li>
	<li><a href="/tags/chromebox/" class="post-tag">chromebox</a>, </li>
	<li><a href="/tags/asus/" class="post-tag">asus</a>, </li>
	<li><a href="/tags/narrowboat/" class="post-tag">narrowboat</a>, </li>
	<li><a href="/tags/apt-cacher-ng/" class="post-tag">apt-cacher-ng</a>, </li>
	<li><a href="/tags/tailscale/" class="post-tag">tailscale</a></li>
</ul>

<p class="post-description-main"></p>

<p>Some notes on setting up an <code>apt-cacher-ng</code> based cache server for Debian apt packages in my home operations (&quot;homeops&quot;) context, including a section on using SSL/TLS origin servers.</p>
<h2 id="background">Background</h2>
<p>Living on and working primarily from my <a href="/tags/narrowboat/">narrowboat</a> means I'm generally more mindful of what I consume, and the resources available to me. Water, electricity, gas, and fuel for the stove in the colder months. And while I have an &quot;all you can eat&quot; data contract with Vodafone for my <a href="/blog/posts/2023/01/09/working-from-a-narrowboat-internet-connectivity/">Internet connection</a>, I'm still conscious of how much data I download over time.</p>
<p>As I dig deeper into the container world, both in <a href="/tags/docker/">Docker</a> and <a href="3">LXC/LXD</a> flavours, I'm often building images that are Debian based, and installing packages in those images is part of the process. I build and rebuild, meaning I'm using <code>apt-get</code> to fetch packages all the time. (I'm pulling down Docker images a lot too, but that's a post for another day). Recently it struck me that I could benefit from some sort of cacheing proxy to reduce the package data I'm pulling over my Internet connection.</p>
<p>This idea came about partly, I think, because I also recently moved from a Raspberry Pi 4 based server running Debian plus Docker engine with lots of containers for services such as Home Assistant, Mosquitto, Miniflux and so on ... to a repurposed (and now headless) Asus Chromebox now running Proxmox. The freedom to think a little bigger, or wider, that this has brought about, was surprising and unexpected. Now I can think about more formalised backup routines, and also use the extra level of machine abstraction to my advantage. The fact that I've moved back from an ARM64 based architecture to an AMD64 one is also of interest.</p>
<h2 id="proxmox-on-my-repurposed-asus-chromebox">Proxmox on my repurposed Asus Chromebox</h2>
<p>My use of Proxmox right now is limited to running containers (CTs), rather than full-blown virtual machines (VMs), partly as I have no need of any VMs and partly to limit the load on the <a href="https://www.amazon.co.uk/gp/product/B07DHNJBXZ/">Asus Chromebox</a> which has an Intel Core i5-8250U CPU with 8GB RAM and 128GB SSD (to which I've also attached an external <a href="https://www.amazon.co.uk/gp/product/B08GTYFC37/">SanDisk 1TB SSD</a>).</p>
<p>I started out with just a single Debian 12 based CT called &quot;docker&quot;, running Docker engine, to host the containers I was previously running on the Raspberry Pi based server. Thanks to Proxmox, I now have a proper backup routine -- both to the locally attached SanDisk SSD and to a volume on a remote Synology NAS -- for this CT and everything it encompasses (Docker volumes, images, and containers, etc).</p>
<p>But with my thinking turning to bandwidth consumption, and the main topic of this post, I created a second CT called &quot;cacher&quot;, which is to be a central cacheing solution, of which the cacheing of Debian apt packages forms part.</p>
<p>You can see the two &quot;lxc&quot; type CTs in the Proxmox screenshot here (along with the SanDisk and Synology based storage resources in the Server View):</p>
<p><img src="/images/2024/09/proxmox.png" alt="A screenshot of the main Proxmox Web UI"></p>
<p>Each of these CTs are Debian distribution based and <a href="https://hachyderm.io/@qmacro/113056889585707864">run two essential services</a>: Tailscale and Docker. In the &quot;cacher&quot; CT I set up the <code>apt-cacher-ng</code> service, and also run a Docker pull-through cacheing registry. I'll write about the latter in a future post. The rest of this post is about setting up and using <code>apt-cacher-ng</code>.</p>
<h2 id="show-n-tell">Show-n-tell</h2>
<p>To describe my journey into setting up and using <a href="https://wiki.debian.org/AptCacherNg">apt-cacher-ng</a> I'll create and use some throwaway containers on this Chromebook that I'm using as my main device right now. Like the containers on Proxmox, containers in the Crostini context on ChromeOS devices are LXC/LXD based, which is lovely.</p>
<blockquote>
<p>There's a couple of differences:</p>
<ul>
<li>Privileged vs unprivileged LXC containers: I run my LXC containers on Proxmox in <a href="https://pve.proxmox.com/wiki/Unprivileged_LXC_containers">unprivileged</a> mode, which means that I need to add a couple of lines to the container config to give Tailscale the access that it needs. This is all described in the Tailscale article <a href="https://tailscale.com/kb/1130/lxc-unprivileged">Tailscale in LXC containers</a> and works well.</li>
<li>Tailscale and local DNS: I use Tailscale in my homeops context and the <a href="https://tailscale.com/kb/1081/magicdns">MagicDNS</a> feature means that each and every container that I create (and install Tailscale in) can reach every other container on my <a href="https://tailscale.com/kb/1136/tailnet">tailnet</a>, which is great. In this Crostini based throwaway demo context I won't be installing Tailscale, mostly to avoid distractions from the main topic, but also because in the Crostini context, containers can reach each other by their names too.</li>
</ul>
</blockquote>
<p>I'll create one throwaway container to set up the <code>apt-cacher-ng</code> cache server. It is basically the same setup process that I used to create the real cache server on the &quot;cacher&quot; LXC container mentioned earlier, which I then point all the other Debian based containers that I might create and use (Docker and LXC based), with a single line of config, so that they become clients of the cache server. I'll therefore also create some further throwaway containers to demonstrate that client config.</p>
<h3 id="setting-up-the-server-container">Setting up the server container</h3>
<p>Creating the first container for the cache server is straightforward:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">(</span>termina<span class="token punctuation">)</span> chronos@localhost ~ $ lxc launch images:debian/12 cacheserver
Creating cacheserver
Starting cacheserver</code></pre>
<p>I can jump straight into the newly created container like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">(</span>termina<span class="token punctuation">)</span> chronos@localhost ~ $ lxc <span class="token builtin class-name">exec</span> cacheserver <span class="token function">bash</span>
root@cacheserver:~<span class="token comment">#</span></code></pre>
<blockquote>
<p>For more on the <code>lxc</code> command, within the context of <code>termina</code>, and where the Debian 12 image is retrieved from these days, you might want to read this recent post: <a href="/blog/posts/2024/08/24/new-source-for-lxd-images-on-crostini/">New source for LXD images on Crostini</a>.</p>
</blockquote>
<h3 id="installing-and-checking-the-cache-server">Installing and checking the cache server</h3>
<p>While I do like to see everything as a nail, and run everything as Docker containers, I'm opting in this case to not do that. I'm already in the context of an LXC container anyway at this point. But again, that's a discussion for another time. To install the cache server, it's a simple invocation of <code>apt-get</code>, thus:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># apt-get update &amp;&amp; apt-get install -y apt-cacher-ng</span></code></pre>
<p>There's a configuration point in this process, asking if I want to &quot;allow HTTP tunnels through Apt-Cacher NG&quot;, to which I answered &quot;no&quot;, which is the preferred answer for security reasons. I'll revisit this decision later on in this post, as you'll see.</p>
<p>The server is now installed as a service, and I can now check the status like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># /etc/init.d/apt-cacher-ng status</span>
● apt-cacher-ng.service - Apt-Cacher NG software download proxy
     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/apt-cacher-ng.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> preset: enabled<span class="token punctuation">)</span>
     Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon <span class="token number">2024</span>-09-02 <span class="token number">17</span>:15:18 UTC<span class="token punctuation">;</span> 13h ago
   Main PID: <span class="token number">755</span> <span class="token punctuation">(</span>apt-cacher-ng<span class="token punctuation">)</span>
      Tasks: <span class="token number">1</span> <span class="token punctuation">(</span>limit: <span class="token number">4915</span><span class="token punctuation">)</span>
     Memory: <span class="token number">2</span>.4M
     CGroup: /system.slice/apt-cacher-ng.service
             └─755 /usr/sbin/apt-cacher-ng <span class="token parameter variable">-c</span> /etc/apt-cacher-ng <span class="token assign-left variable">ForeGround</span><span class="token operator">=</span><span class="token number">1</span>

Sep 02 <span class="token number">17</span>:15:18 cacheserver systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Starting apt-cacher-ng.service - Apt-Cacher NG software download proxy<span class="token punctuation">..</span>.
Sep 02 <span class="token number">17</span>:15:18 cacheserver systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started apt-cacher-ng.service - Apt-Cacher NG software download proxy.</code></pre>
<p>The status output shows a reference to a directory <code>/etc/apt-cacher-ng</code> which contains various configuration files, which I don't need to touch right now, but I can look inside <code>/etc/apt-cacher-ng/acng.conf</code> to find useful information, such as:</p>
<ul>
<li>the cache directory is <code>/var/cache/apt-cacher-ng</code></li>
<li>the log files will be in <code>/var/log/apt-cacher-ng</code></li>
<li>the default port that the server listens on is 3142</li>
</ul>
<p>Indeed, I can see that here:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># netstat -atn | grep LISTEN</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.54:53           <span class="token number">0.0</span>.0.0:*               LISTEN     
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:5355            <span class="token number">0.0</span>.0.0:*               LISTEN     
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:3142            <span class="token number">0.0</span>.0.0:*               LISTEN     
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.53:53           <span class="token number">0.0</span>.0.0:*               LISTEN     
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::5355                 :::*                    LISTEN     
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3142                 :::*                    LISTEN</code></pre>
<p>(The other two ports here are related to name resolution services).</p>
<p>At this point there's nothing in the log yet, and nothing stored in the cache (obviously):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># du -hs /var/cache/apt-cacher-ng/ &amp;&amp; wc -l /var/log/apt-cacher-ng/apt-cacher.log </span>
<span class="token number">0</span>       /var/cache/apt-cacher-ng/
<span class="token number">0</span> /var/log/apt-cacher-ng/apt-cacher.log</code></pre>
<h3 id="setting-up-a-test-cache-client-container">Setting up a test cache client container</h3>
<p>To make sure things work as expected, I can create another LXC container to act as a client:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">(</span>termina<span class="token punctuation">)</span> chronos@localhost ~ $ lxc launch images:debian/12 cacheclient1 <span class="token operator">&amp;&amp;</span> lxc <span class="token builtin class-name">exec</span> <span class="token variable">$_</span> <span class="token function">bash</span>
Creating cacheclient1
Starting cacheclient1
root@cacheclient1:~<span class="token comment">#</span></code></pre>
<h3 id="configuring-the-cache-client">Configuring the cache client</h3>
<p>A single line is all that's needed for basic configuration to point to the cache server, and that goes in the <code>/etc/apt/apt.conf.d/</code> directory. There are already a couple of config files in this directory, with numeric order prefixes as is often found:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># ls /etc/apt/apt.conf.d/</span>
01autoremove  70debconf</code></pre>
<p>I can create a new file here called <code>00cacher</code>, adding the proxy pointer:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># echo 'Acquire::http::Proxy "http://cacheserver:3142";' \</span>
  <span class="token operator">></span> /etc/apt/apt.conf.d/00cacher</code></pre>
<p>And that's all I need to do, for basic package cacheing.</p>
<h3 id="trying-things-out">Trying things out</h3>
<p>First, I'll start with an update in this cache client container to retrieve package lists:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># apt-get update</span>
Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 http://deb.debian.org/debian bookworm-updates InRelease <span class="token punctuation">[</span><span class="token number">55.4</span> kB<span class="token punctuation">]</span>
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease <span class="token punctuation">[</span><span class="token number">48.0</span> kB<span class="token punctuation">]</span>
Fetched <span class="token number">103</span> kB <span class="token keyword">in</span> 4s <span class="token punctuation">(</span><span class="token number">29.5</span> kB/s<span class="token punctuation">)</span>
Reading package lists<span class="token punctuation">..</span>. Done</code></pre>
<p>The cache server has been used here already - in <code>/var/log/apt-cacher-ng/apt-cache.log</code> on the cache server, these lines appear:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token number">1725348110</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">20254</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>InRelease
<span class="token number">1725348110</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">102</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>InRelease
<span class="token number">1725348110</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">56689</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">-</span>updates<span class="token operator">/</span>InRelease
<span class="token number">1725348110</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">55710</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">-</span>updates<span class="token operator">/</span>InRelease
<span class="token number">1725348113</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">49279</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>secdeb<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">-</span>security<span class="token operator">/</span>InRelease
<span class="token number">1725348113</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">48232</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>secdeb<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">-</span>security<span class="token operator">/</span>InRelease</code></pre>
<p>While the <code>apt-cacher-ng</code> <a href="https://www.unix-ag.uni-kl.de/~bloch/acng/html/">manual</a> is great, I couldn't find a description of this log format, but there's a Unix epoch style timestamp, the IP address of the client (the &quot;cacheclient1&quot; container in this case) and the resource in question. There's also what looks like a size and whether it's read or write (I/O). I'm guessing, but this seems about right, 104044 bytes (corresponding to the &quot;Fetched 103kB in 4s&quot; line in the log):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># grep -E '\|O\|' /var/log/apt-cacher-ng/apt-cacher.log \</span>
  <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">'|'</span> <span class="token parameter variable">-f3</span> <span class="token operator">|</span> <span class="token function">paste</span> -sd+ <span class="token operator">|</span> <span class="token function">bc</span>
<span class="token number">104044</span></code></pre>
<blockquote>
<p>I do like a bit of gratuitous Unix shell pipelinery.</p>
</blockquote>
<p>The three pairs of I and O log records correspond to the three resources shown in the output to <code>apt-get update</code>.</p>
<p>There's also some data in the cache directory now, too:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># du -hs /var/cache/apt-cacher-ng/</span>
264K    /var/cache/apt-cacher-ng/</code></pre>
<p>So far so good! Now for a substantial package install.</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># apt-get install -y build-essential</span>
Reading package lists<span class="token punctuation">..</span>. Done
Building dependency tree<span class="token punctuation">..</span>. Done
Reading state information<span class="token punctuation">..</span>. Done
The following additional packages will be installed:
<span class="token punctuation">..</span>.
<span class="token number">0</span> upgraded, <span class="token number">101</span> newly installed, <span class="token number">0</span> to remove and <span class="token number">0</span> not upgraded.
Need to get <span class="token number">80.5</span> MB of archives.
After this operation, <span class="token number">304</span> MB of additional disk space will be used.
Get:1 http://deb.debian.org/debian bookworm/main arm64 liblocale-gettext-perl arm64 <span class="token number">1.07</span>-5 <span class="token punctuation">[</span><span class="token number">15.1</span> kB<span class="token punctuation">]</span>
Get:2 http://deb.debian.org/debian bookworm/main arm64 readline-common all <span class="token number">8.2</span>-1.3 <span class="token punctuation">[</span><span class="token number">69.0</span> kB<span class="token punctuation">]</span>
Get:3 http://deb.debian.org/debian bookworm/main arm64 <span class="token function">bzip2</span> arm64 <span class="token number">1.0</span>.8-5+b1 <span class="token punctuation">[</span><span class="token number">48.9</span> kB<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
Get:99 http://deb.debian.org/debian bookworm/main arm64 libldap-common all <span class="token number">2.5</span>.13+dfsg-5 <span class="token punctuation">[</span><span class="token number">29.3</span> kB<span class="token punctuation">]</span>
Get:100 http://deb.debian.org/debian bookworm/main arm64 libsasl2-modules arm64 <span class="token number">2.1</span>.28+dfsg-10 <span class="token punctuation">[</span><span class="token number">63.1</span> kB<span class="token punctuation">]</span>
Get:101 http://deb.debian.org/debian bookworm/main arm64 manpages-dev all <span class="token number">6.03</span>-2 <span class="token punctuation">[</span><span class="token number">2030</span> kB<span class="token punctuation">]</span>
Fetched <span class="token number">80.5</span> MB <span class="token keyword">in</span> 28s <span class="token punctuation">(</span><span class="token number">2909</span> kB/s<span class="token punctuation">)</span>
debconf: delaying package configuration, since apt-utils is not installed
Selecting previously unselected package liblocale-gettext-perl.
<span class="token punctuation">(</span>Reading database <span class="token punctuation">..</span>. <span class="token number">14040</span> files and directories currently installed.<span class="token punctuation">)</span>
Preparing to unpack <span class="token punctuation">..</span>./000-liblocale-gettext-perl_1.07-5_arm64.deb <span class="token punctuation">..</span>.
Unpacking liblocale-gettext-perl <span class="token punctuation">(</span><span class="token number">1.07</span>-5<span class="token punctuation">)</span> <span class="token punctuation">..</span>.</code></pre>
<p>This corresponds exactly to the log records written on the server to <code>/var/log/apt-cacher-ng/apt-cache.log</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token number">1725349470</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">16482</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>libl<span class="token operator">/</span>liblocale<span class="token operator">-</span>gettext<span class="token operator">-</span>perl<span class="token operator">/</span>liblocale<span class="token operator">-</span>gettext<span class="token operator">-</span>perl_1<span class="token punctuation">.</span>07<span class="token operator">-</span>5_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725349470</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">15428</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>libl<span class="token operator">/</span>liblocale<span class="token operator">-</span>gettext<span class="token operator">-</span>perl<span class="token operator">/</span>liblocale<span class="token operator">-</span>gettext<span class="token operator">-</span>perl_1<span class="token punctuation">.</span>07<span class="token operator">-</span>5_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725349470</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">70362</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>r<span class="token operator">/</span>readline<span class="token operator">/</span>readline<span class="token operator">-</span>common_8<span class="token punctuation">.</span>2<span class="token operator">-</span>1<span class="token punctuation">.</span>3_all<span class="token punctuation">.</span>deb
<span class="token number">1725349470</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">69279</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>r<span class="token operator">/</span>readline<span class="token operator">/</span>readline<span class="token operator">-</span>common_8<span class="token punctuation">.</span>2<span class="token operator">-</span>1<span class="token punctuation">.</span>3_all<span class="token punctuation">.</span>deb
<span class="token number">1725349471</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">50238</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>b<span class="token operator">/</span>bzip2<span class="token operator">/</span>bzip2_1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8<span class="token operator">-</span><span class="token number">5</span><span class="token operator">+</span>b1_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725349471</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">49151</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>b<span class="token operator">/</span>bzip2<span class="token operator">/</span>bzip2_1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8<span class="token operator">-</span><span class="token number">5</span><span class="token operator">+</span>b1_arm64<span class="token punctuation">.</span>deb
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">1725349497</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">30716</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>o<span class="token operator">/</span>openldap<span class="token operator">/</span>libldap<span class="token operator">-</span>common_2<span class="token punctuation">.</span>5<span class="token punctuation">.</span>13<span class="token operator">+</span>dfsg<span class="token operator">-</span>5_all<span class="token punctuation">.</span>deb
<span class="token number">1725349497</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">29644</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>o<span class="token operator">/</span>openldap<span class="token operator">/</span>libldap<span class="token operator">-</span>common_2<span class="token punctuation">.</span>5<span class="token punctuation">.</span>13<span class="token operator">+</span>dfsg<span class="token operator">-</span>5_all<span class="token punctuation">.</span>deb
<span class="token number">1725349498</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">64504</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>c<span class="token operator">/</span>cyrus<span class="token operator">-</span>sasl2<span class="token operator">/</span>libsasl2<span class="token operator">-</span>modules_2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>28<span class="token operator">+</span>dfsg<span class="token operator">-</span>10_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725349498</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">63440</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>c<span class="token operator">/</span>cyrus<span class="token operator">-</span>sasl2<span class="token operator">/</span>libsasl2<span class="token operator">-</span>modules_2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>28<span class="token operator">+</span>dfsg<span class="token operator">-</span>10_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725349498</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">2031644</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>m<span class="token operator">/</span>manpages<span class="token operator">/</span>manpages<span class="token operator">-</span>dev_6<span class="token punctuation">.</span>03<span class="token operator">-</span>2_all<span class="token punctuation">.</span>deb
<span class="token number">1725349498</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">2030553</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.205</span><span class="token operator">|</span>debrep<span class="token operator">/</span>pool<span class="token operator">/</span>main<span class="token operator">/</span>m<span class="token operator">/</span>manpages<span class="token operator">/</span>manpages<span class="token operator">-</span>dev_6<span class="token punctuation">.</span>03<span class="token operator">-</span>2_all<span class="token punctuation">.</span>deb</code></pre>
<p>And the cache store on the server is considerably larger now:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># du -hs /var/cache/apt-cacher-ng/</span>
78M     /var/cache/apt-cacher-ng/</code></pre>
<p>Note the fetch statistic log record in the output of the <code>apt-get install</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Fetched <span class="token number">80.5</span> MB in <span class="token number">28s</span> <span class="token operator">(</span><span class="token number">2909</span> kB<span class="token operator">/</span>s<span class="token operator">)</span></code></pre>
<p>While I could remove the <code>build-essential</code> package and rerun the install, I can instead create a second client container and do the same thing again, which feels like a cleaner test and better comparison.</p>
<h3 id="re-testing-with-a-second-cache-client-container">Re-testing with a second cache client container</h3>
<p>After establishing a second container &quot;cacheclient2&quot;:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">(</span>termina<span class="token punctuation">)</span> chronos@localhost ~ $ lxc launch images:debian/12 cacheclient2 <span class="token operator">&amp;&amp;</span> lxc <span class="token builtin class-name">exec</span> <span class="token variable">$_</span> <span class="token function">bash</span></code></pre>
<p>and setting up the same required configuration:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient2:~<span class="token comment"># echo 'Acquire::http::Proxy "http://cacheserver:3142";' \</span>
  <span class="token operator">></span> /etc/apt/apt.conf.d/00cacher</code></pre>
<p>I can try the same <code>apt-get</code> invocation:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient2:~<span class="token comment"># apt-get update &amp;&amp; apt-get install -y build-essential</span></code></pre>
<p>Now, the fetch statistic log record here looks like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Fetched <span class="token number">80.5</span> MB in <span class="token number">1s</span> <span class="token operator">(</span><span class="token number">81.1</span> MB<span class="token operator">/</span>s<span class="token operator">)</span></code></pre>
<p>That's quite a difference - 28 seconds the first time, and 1 second when the cache can deliver!</p>
<p>Of course, the speed is going to be rather impressive in this example for cache hits as both client and server containers are on the same host. But it's more the reduction in Internet traffic that I'm interested in anyway, and in reality I get pretty quick turnaround times over the LAN from my real cache server that I run on the &quot;cacher&quot; container on my Proxmox host.</p>
<p>In fact, talking of statistics, <code>apt-cacher-ng</code> also serves a nifty statistics page, which right now, for the brand new and only slightly used cache server on the &quot;cacheserver&quot; container, looks like this:</p>
<p><img src="/images/2024/09/transferstatistics.png" alt="transfer statistics"></p>
<h2 id="working-with-ssl-tls-remotes">Working with SSL/TLS remotes</h2>
<p>You'll see that the standard Debian remotes are HTTP-based, rather than HTTPS:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># apt-get update</span>
Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 http://deb.debian.org/debian bookworm-updates InRelease <span class="token punctuation">[</span><span class="token number">55.4</span> kB<span class="token punctuation">]</span>
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease <span class="token punctuation">[</span><span class="token number">48.0</span> kB<span class="token punctuation">]</span>
Fetched <span class="token number">103</span> kB <span class="token keyword">in</span> 4s <span class="token punctuation">(</span><span class="token number">29.5</span> kB/s<span class="token punctuation">)</span>
Reading package lists<span class="token punctuation">..</span>. Done</code></pre>
<p>Using HTTPS based remotes with an in-the-middle mechanism like <code>apt-cacher-ng</code> is a little difficult, and the problem and potential solutions are explained well in the user manual, in the section titled <a href="https://www.unix-ag.uni-kl.de/~bloch/acng/html/howtos.html#ssluse">Access to SSL/TLS remotes (HTTPS)</a>.</p>
<p>This problem is relevant for me, in that I nearly always want to install Docker engine in my Debian containers, and the <a href="https://docs.docker.com/engine/install/debian/">requirements</a> include adding details for Docker's apt package repository, the relevant line for which is this one:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
  <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">.</span> /etc/os-release <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$VERSION_CODENAME</span>"</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token punctuation">\</span>
  <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null</code></pre>
<p>Note that in the line that's echo'd to <code>/etc/apt/sources.list.d/docker.list</code> a SSL/TLS URL is used: <a href="https://download.docker.com/linux/debian">https://download.docker.com/linux/debian</a> (you may have to scroll right to see it).</p>
<h3 id="allowing-https-tunnels">Allowing HTTPS tunnels</h3>
<p>Following the <a href="https://docs.docker.com/engine/install/debian/">requirements</a> through, in the &quot;cacheclient1&quot; container,</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ca-certificates <span class="token function">curl</span>
<span class="token function">sudo</span> <span class="token function">install</span> <span class="token parameter variable">-m</span> 0755 <span class="token parameter variable">-d</span> /etc/apt/keyrings
<span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://download.docker.com/linux/debian/gpg <span class="token parameter variable">-o</span> /etc/apt/keyrings/docker.asc
<span class="token function">sudo</span> <span class="token function">chmod</span> a+r /etc/apt/keyrings/docker.asc
<span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
  <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">.</span> /etc/os-release <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$VERSION_CODENAME</span>"</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token punctuation">\</span>
  <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null
<span class="token function">sudo</span> <span class="token function">apt-get</span> update</code></pre>
<p>the cache server is active and successful for the <em>first</em> <code>apt-get update</code> invocation here, as well as the installation of <code>ca-certificates</code> and <code>curl</code> packages. That's because we're not yet referencing any Docker based apt package repository resources. But after the addition of the new source in <code>/etc/apt/sources.list.d/docker.list</code>, the contents of which looks like this:</p>
<pre class="language-text" tabindex="0"><code class="language-text">deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian   bookworm stable</code></pre>
<p>the <em>second</em> <code>apt-get update</code> in the instructions above results in this error output:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Ign<span class="token operator">:</span><span class="token number">1</span> <span class="token url">https://download.docker.com/linux/debian</span> bookworm InRelease
Hit<span class="token operator">:</span><span class="token number">2</span> <span class="token url">http://deb.debian.org/debian</span> bookworm InRelease
Hit<span class="token operator">:</span><span class="token number">3</span> <span class="token url">http://deb.debian.org/debian</span> bookworm<span class="token operator">-</span>updates InRelease
Hit<span class="token operator">:</span><span class="token number">4</span> <span class="token url">http://deb.debian.org/debian-security</span> bookworm<span class="token operator">-</span>security InRelease
Ign<span class="token operator">:</span><span class="token number">1</span> <span class="token url">https://download.docker.com/linux/debian</span> bookworm InRelease
Ign<span class="token operator">:</span><span class="token number">1</span> <span class="token url">https://download.docker.com/linux/debian</span> bookworm InRelease
Err<span class="token operator">:</span><span class="token number">1</span> <span class="token url">https://download.docker.com/linux/debian</span> bookworm InRelease
  <span class="token property">Invalid response from proxy:</span> HTTP<span class="token operator">/</span><span class="token number">1.0</span> <span class="token number">403</span> CONNECT denied <span class="token operator">(</span>ask the admin to allow HTTPS tunnels<span class="token operator">)</span>     <span class="token punctuation">[</span>IP<span class="token operator">:</span> <span class="token ip-address constant">100.115.92.201</span> <span class="token number">3142</span><span class="token punctuation">]</span>
Reading package lists<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Done
<span class="token property">W:</span> Failed to fetch <span class="token url">https://download.docker.com/linux/debian/dists/bookworm/InRelease</span>  Invalid response from proxy<span class="token operator">:</span> HTTP<span class="token operator">/</span><span class="token number">1.0</span> <span class="token number">403</span> CONNECT denied <span class="token operator">(</span>ask the admin to allow HTTPS tunnels<span class="token operator">)</span>     <span class="token punctuation">[</span>IP<span class="token operator">:</span> <span class="token ip-address constant">100.115.92.201</span> <span class="token number">3142</span><span class="token punctuation">]</span>
<span class="token property">W:</span> Some index files failed to download<span class="token punctuation">.</span> They have been ignored<span class="token punctuation">,</span> or old ones used instead<span class="token punctuation">.</span></code></pre>
<p>The &quot;ask the admin to allow HTTPS tunnels&quot; in the message here is related to the decision I made to <em>not</em> allow them, in the configuration point during the installation of <code>apt-cacher-ng</code> on the cache server.</p>
<p>Looking in the server configuration file at <code>/etc/apt-cacher-ng/acng.conf</code>, there's this section:</p>
<pre class="language-systemd" tabindex="0"><code class="language-systemd"><span class="token comment"># Allow data pass-through mode for certain hosts when requested by the client</span>
<span class="token comment"># using a CONNECT request. This is particularly useful to allow access to SSL</span>
<span class="token comment"># sites (https proxying). The string is a regular expression which should cover</span>
<span class="token comment"># the server name with port and must be correctly formated and terminated.</span>
<span class="token comment"># Examples:</span>
<span class="token comment"># PassThroughPattern: private-ppa\.launchpad\.net:443$</span>
<span class="token comment"># PassThroughPattern: .* # this would allow CONNECT to everything</span>
<span class="token comment">#</span>
<span class="token comment"># Default: ^(bugs\.debian\.org|changelogs\.ubuntu\.com):443$</span>
<span class="token comment"># PassThroughPattern: ^(bugs\.debian\.org|changelogs\.ubuntu\.com):443$</span></code></pre>
<p>To allow access to the Docker apt package repositories at <a href="https://download.docker.com">https://download.docker.com</a>, I can add this configuration line:</p>
<pre class="language-systemd" tabindex="0"><code class="language-systemd">PassThroughPattern: ^download\.docker\.com:443$</code></pre>
<p>and restart <code>apt-cacher-ng</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheserver:~<span class="token comment"># /etc/init.d/apt-cacher-ng restart</span>
Restarting apt-cacher-ng <span class="token punctuation">(</span>via systemctl<span class="token punctuation">)</span>: apt-cacher-ng.service.</code></pre>
<p>Now, on &quot;cacheclient1&quot;, the <code>apt-get update</code> successfully reaches <code>download.docker.com</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># sudo apt-get update</span>
Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 https://download.docker.com/linux/debian bookworm InRelease <span class="token punctuation">[</span><span class="token number">43.3</span> kB<span class="token punctuation">]</span>  
Get:3 http://deb.debian.org/debian bookworm-updates InRelease <span class="token punctuation">[</span><span class="token number">55.4</span> kB<span class="token punctuation">]</span>      
Hit:4 http://deb.debian.org/debian-security bookworm-security InRelease
Get:5 https://download.docker.com/linux/debian bookworm/stable arm64 Packages <span class="token punctuation">[</span><span class="token number">29.1</span> kB<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.</code></pre>
<p>What's more, the <code>apt-get install</code> of the Docker packages works too:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient1:~<span class="token comment"># sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span>
Reading package lists<span class="token punctuation">..</span>. Done
Building dependency tree<span class="token punctuation">..</span>. Done
Reading state information<span class="token punctuation">..</span>. Done
The following additional packages will be installed:
<span class="token punctuation">..</span>.
<span class="token number">0</span> upgraded, <span class="token number">29</span> newly installed, <span class="token number">0</span> to remove and <span class="token number">0</span> not upgraded.
Need to get <span class="token number">122</span> MB of archives.
After this operation, <span class="token number">497</span> MB of additional disk space will be used.
Do you want to continue? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> 
Get:1 http://deb.debian.org/debian bookworm/main arm64 pigz arm64 <span class="token number">2.6</span>-1 <span class="token punctuation">[</span><span class="token number">56.2</span> kB<span class="token punctuation">]</span>
Get:2 http://deb.debian.org/debian bookworm/main arm64 <span class="token function">less</span> arm64 <span class="token number">590</span>-2.1~deb12u2 <span class="token punctuation">[</span><span class="token number">128</span> kB<span class="token punctuation">]</span>
Get:3 https://download.docker.com/linux/debian bookworm/stable arm64 containerd.io arm64 <span class="token number">1.7</span>.21-1 <span class="token punctuation">[</span><span class="token number">22.0</span> MB<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
Get:27 https://download.docker.com/linux/debian bookworm/stable arm64 docker-ce arm64 <span class="token number">5</span>:27.2.0-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">15.5</span> MB<span class="token punctuation">]</span>
Get:28 https://download.docker.com/linux/debian bookworm/stable arm64 docker-ce-rootless-extras arm64 <span class="token number">5</span>:27.2.0-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">8403</span> kB<span class="token punctuation">]</span>
Get:29 https://download.docker.com/linux/debian bookworm/stable arm64 docker-compose-plugin arm64 <span class="token number">2.29</span>.2-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">10.8</span> MB<span class="token punctuation">]</span>
Fetched <span class="token number">122</span> MB <span class="token keyword">in</span> 35s <span class="token punctuation">(</span><span class="token number">3455</span> kB/s<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.</code></pre>
<p>However. This is only allowing a tunnel through the cache server to the origin, i.e. to <a href="https://download.docker.com">https://download.docker.com</a>. The resources are <em>not</em> cached. There are no logs written to <code>/var/log/apt-cacher-ng/apt-cache.log</code> that indicate that any Docker package resources have been processed by the cache mechanism. So each time I were to install Docker engine, I would be going out onto the Internet to retrieve the packages, and not benefitting from what <code>apt-cacher-ng</code> can provide.</p>
<h3 id="specifying-http-only-sources">Specifying HTTP-only sources</h3>
<p>To have <code>apt-cacher-ng</code> cache these Docker apt packages too, a different approach is needed. It's more of a workaround to the complexities introduced with SSL/TLS in a proxy situation. And that workaround is ... not to use HTTPS at all.</p>
<p>Simply modifying the scheme from <code>https</code> to <code>http</code> in the URL in <code>/etc/apt/sources.list.d/docker.list</code> so that the contents become:</p>
<pre class="language-text" tabindex="0"><code class="language-text">deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.asc] http://download.docker.com/linux/debian   bookworm stable</code></pre>
<p>avoids the SSL/TLS problem altogether.</p>
<p>I like to make this modification as a separate step, like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|https://download.docker.com|http://download.docker.com|'</span> /etc/apt/sources.list.d/docker.list</code></pre>
<p>so I can continue to copy/paste instructions verbatim, and just make my own small change. Indeed, I <a href="https://gist.github.com/qmacro/6f44f73384b9fef39737bfcfd160bcf8#file-lxc-container-setup-L74-L75">do this</a> in my <code>lxc-container-setup</code> script that I use to set up new LXC container on Crostini, with Tailscale and Docker.</p>
<p>Having made this scheme change in the source definition for Docker packages and running an <code>apt-get update</code>, evidence in the cache server logs appears, showing the cacheing for Docker resources:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token number">1725354578</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">562</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>InRelease
<span class="token number">1725354578</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">43597</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>InRelease
<span class="token number">1725354578</span><span class="token operator">|</span>I<span class="token operator">|</span><span class="token number">563</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>stable<span class="token operator">/</span>binary<span class="token operator">-</span>arm64<span class="token operator">/</span>Packages<span class="token punctuation">.</span>bz2
<span class="token number">1725354578</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">29413</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>stable<span class="token operator">/</span>binary<span class="token operator">-</span>arm64<span class="token operator">/</span>Packages<span class="token punctuation">.</span>bz2</code></pre>
<p>And retrieval and cacheing of the Docker apt packages takes place too when the <code>apt-get install</code> is invoked:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token number">1725354603</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">22034315</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>containerd<span class="token punctuation">.</span>io_1<span class="token punctuation">.</span>7<span class="token punctuation">.</span>21<span class="token operator">-</span>1_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725354603</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">27380417</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>docker<span class="token operator">-</span>buildx<span class="token operator">-</span>plugin_0<span class="token punctuation">.</span>16<span class="token punctuation">.</span>2<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span>debian<span class="token punctuation">.</span>12<span class="token operator">~</span>bookworm_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725354604</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">13425330</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">-</span>cli_27<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span>debian<span class="token punctuation">.</span>12<span class="token operator">~</span>bookworm_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725354604</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">15462186</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>docker<span class="token operator">-</span>ce_27<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span>debian<span class="token punctuation">.</span>12<span class="token operator">~</span>bookworm_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725354604</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">8403103</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">-</span>rootless<span class="token operator">-</span>extras_27<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span>debian<span class="token punctuation">.</span>12<span class="token operator">~</span>bookworm_arm64<span class="token punctuation">.</span>deb
<span class="token number">1725354604</span><span class="token operator">|</span>O<span class="token operator">|</span><span class="token number">10783122</span><span class="token operator">|</span><span class="token ip-address constant">100.115.92.202</span><span class="token operator">|</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>debian<span class="token operator">/</span>dists<span class="token operator">/</span>bookworm<span class="token operator">/</span>pool<span class="token operator">/</span>stable<span class="token operator">/</span>arm64<span class="token operator">/</span>docker<span class="token operator">-</span>compose<span class="token operator">-</span>plugin_2<span class="token punctuation">.</span>29<span class="token punctuation">.</span>2<span class="token operator">-</span><span class="token number">1</span><span class="token operator">~</span>debian<span class="token punctuation">.</span>12<span class="token operator">~</span>bookworm_arm64<span class="token punctuation">.</span>deb</code></pre>
<p>Furthermore, this cacheing is very effective, as can be seen from a subsequent install of Docker engine on yet another test client container:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">root@cacheclient3:~<span class="token comment"># sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span>
Get:1 http://deb.debian.org/debian bookworm/main arm64 pigz arm64 <span class="token number">2.6</span>-1 <span class="token punctuation">[</span><span class="token number">56.2</span> kB<span class="token punctuation">]</span>
Get:2 http://download.docker.com/linux/debian bookworm/stable arm64 containerd.io arm64 <span class="token number">1.7</span>.21-1 <span class="token punctuation">[</span><span class="token number">22.0</span> MB<span class="token punctuation">]</span>
Get:3 http://deb.debian.org/debian bookworm/main arm64 <span class="token function">less</span> arm64 <span class="token number">590</span>-2.1~deb12u2 <span class="token punctuation">[</span><span class="token number">128</span> kB<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
Get:29 http://download.docker.com/linux/debian bookworm/stable arm64 docker-ce-cli arm64 <span class="token number">5</span>:27.2.0-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">13.4</span> MB<span class="token punctuation">]</span>
Get:30 http://download.docker.com/linux/debian bookworm/stable arm64 docker-ce arm64 <span class="token number">5</span>:27.2.0-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">15.5</span> MB<span class="token punctuation">]</span>
Get:31 http://download.docker.com/linux/debian bookworm/stable arm64 docker-ce-rootless-extras arm64 <span class="token number">5</span>:27.2.0-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">8403</span> kB<span class="token punctuation">]</span>
Get:32 http://download.docker.com/linux/debian bookworm/stable arm64 docker-compose-plugin arm64 <span class="token number">2.29</span>.2-1~debian.12~bookworm <span class="token punctuation">[</span><span class="token number">10.8</span> MB<span class="token punctuation">]</span>
Fetched <span class="token number">123</span> MB <span class="token keyword">in</span> 1s <span class="token punctuation">(</span><span class="token number">84.9</span> MB/s<span class="token punctuation">)</span> 
<span class="token punctuation">..</span>.</code></pre>
<p>Pretty excellent!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>So there you have it - the results of my investigations into and early use of <code>apt-cacher-ng</code> as one component in a setup to reduce my Internet bandwidth usage. Running this on the &quot;cacher&quot; LXC container on my Proxmox host is great, and thanks to Tailscale, I can use it from anywhere.</p>
<h2 id="update">Update</h2>
<p>There are some very useful and interesting comments on this topic <a href="https://lobste.rs/s/u6vco1/setting_up_cache_server_for_apt_packages">over on the Lobsters entry for this post</a>.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/08/24/new-source-for-lxd-images-on-crostini/">New source for LXD images on Crostini</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/09/30/tasc-notes-part-1/">TASC Notes - Part 1</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/09/03/setting-up-a-cache-server-for-apt-packages/` was built on 2025-09-16T07:45:10.623Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
	</body>
</html>
