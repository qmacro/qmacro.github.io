<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>TASC Notes - Part 6</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		
	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="tasc-notes-part-6">TASC Notes - Part 6</h1>

<ul class="post-metadata">
	<li><time datetime="2024-12-20">20 December 2024</time></li>
	<li><a href="/tags/tasc/" class="post-tag">tasc</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/handsonsapdev/" class="post-tag">handsonsapdev</a></li>
</ul>

<p class="post-description-main"></p>

<p>These are the notes summarising what was covered in <a href="https://www.youtube.com/watch?v=cZCOQpxC118">The Art and Science of CAP part 6</a>, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.</p>
<p>For all resources related to this series, see the post <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">The Art and Science of CAP</a>.</p>
<p>This episode started with a review of the previous episode (part 5), based on the <a href="/blog/posts/2024/12/13/tasc-notes-part-5/">notes for that episode</a>.</p>
<p><a name="improved-display-of-service-handlers"></a></p>
<h2 id="improved-display-of-service-handlers">Improved display of service handlers</h2>
<p>Daniel starts at around <a href="https://www.youtube.com/live/cZCOQpxC118?t=1313">21:53</a> in the cds REPL showing an improved display for the handlers of a service.</p>
<p>One of the many things I love about this series is that we see where Daniel is, a few steps ahead, with his CAP Node.js version which is always slightly in the near future for us, but what we glimpse in that future comes along and is available to us in the next release:</p>
<ul>
<li>the new cds REPL features <code>--run</code> and <code>--use</code> that we saw in the previous episode (see the <a href="https://cap.cloud.sap/docs/releases/dec24">New cds REPL options</a> in <a href="/blog/posts/2024/12/13/tasc-notes-part-5/">the notes to part 5</a>) and which he uses here to start things up <em>are now available to us too</em></li>
<li>during last week's episode Daniel's cds REPL was announcing itself as version 8.6, whereas we all had access to version 8.5 at that time; this week, where we now have access to version 8.6 (see the <a href="https://cap.cloud.sap/docs/releases/dec24">December 2024 release notes</a>), Daniel's cds REPL is now announcing itself as version 8.7, always a step ahead but never anything hidden :-)</li>
</ul>
<p>This time, the improved handlers display is already now available. Before, with <code>@sap/cds</code> 8.5, this is what the handlers looked like, in the REPL (and note that they were in a &quot;private&quot; property <code>_handlers</code>):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> CatalogService<span class="token punctuation">.</span>_handlers
<span class="token operator">{</span>
  <span class="token property">_initial:</span> <span class="token punctuation">[</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">{</span> _initial<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">}</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">{</span> _initial<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">}</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> lots more <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    EventHandler <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">{</span> _initial<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">}</span>
    <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">before:</span> <span class="token punctuation">[</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'PATCH'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> addContentType<span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> addContentType<span class="token punctuation">]</span>
    <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">on:</span> <span class="token punctuation">[</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">on:</span> <span class="token string">'submitOrder'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'EDIT'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'CANCEL'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'draftPrepare'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'CREATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'UPSERT'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">after:</span> <span class="token punctuation">[</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">after:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span>
      <span class="token property">path:</span> <span class="token string">'CatalogService.ListOfBooks'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">after:</span> <span class="token string">'submitOrder'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    EventHandler <span class="token operator">{</span>
      <span class="token property">after:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span>
    <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">_error:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">}</span></code></pre>
<p>This was quite hard to understand, but with 8.6, available to us <a href="https://www.npmjs.com/package/@sap/cds/v/8.6.0">already</a>, it's cleaner and easier to read (and not in a &quot;private&quot; property any more):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> CatalogService<span class="token punctuation">.</span>handlers
EventHandlers <span class="token operator">{</span>
  <span class="token property">_initial:</span> <span class="token punctuation">[</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> noah_handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> check_roles<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'CREATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> commonGenericInput<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> commonGenericInput<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span>
      <span class="token property">before:</span> <span class="token string">'submitOrder'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> _actionFunctionHandler<span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> commonGenericPut<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> commonGenericTemporal<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> commonGenericPaging<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> commonGenericSorting<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">before:</span> <span class="token punctuation">[</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'PATCH'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> addContentType<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> addContentType<span class="token punctuation">]</span> <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">on:</span> <span class="token punctuation">[</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'submitOrder'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'EDIT'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'CANCEL'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'draftPrepare'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> fn<span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'CREATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'UPSERT'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">after:</span> <span class="token punctuation">[</span>
    <span class="token operator">{</span>
      <span class="token property">after:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span>
      <span class="token property">path:</span> <span class="token string">'CatalogService.ListOfBooks'</span><span class="token punctuation">,</span>
      <span class="token property">handler:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> handler<span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> after<span class="token operator">:</span> <span class="token string">'submitOrder'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token operator">{</span> after<span class="token operator">:</span> <span class="token string">'READ'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span> <span class="token operator">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">_error:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">}</span></code></pre>
<p>Much neater!</p>
<p>In browsing through the new display, Daniel makes an important observation in the context of the <code>on</code> phase handlers, which is that for your actions (and functions, an important distinction from an OData protocol perspective, at least) you'll <em>always</em> have to define your own <code>on</code> phase handlers.</p>
<p>I've said this elsewhere and I'll repeat it here: OData is a formalised RESTful protocol ... for the most part. OData's actions and functions are a departure from the REST principles, one could say that they are orthogonal to the main philosophy and design of the principles of REST.</p>
<p>By definition, any actions and functions are non-standard with respect to the core OData operations, and by association, to any HTTP-oriented application protocol that celebrates the methods (GET, PUT, POST, DELETE, etc) as verbs and the resources (via the URLs) as nouns. The CAP framework cannot possibly predict and handle what you have in store for such non-standard operations, and so you must handle those entirely yourself.</p>
<p>Hence Daniel's remark, and the two <code>on</code> phase handlers that he highlights (and that are listed above) are perfect examples of activities other than the CRUD+Q family:</p>
<ul>
<li><code>submitOrder</code></li>
<li><code>draftPrepare</code></li>
</ul>
<p>The clue is in the names - any action or function (which will form part of the URL when being invoked) whose name <em>contains a verb</em> (here: &quot;submit&quot; and &quot;prepare&quot;) is pretty much by definition non-RESTful.</p>
<p><a name="awaitable-queries-and-thenables"></a></p>
<h2 id="awaitable-queries-and-thenables">Awaitable queries and thenables</h2>
<p>At <a href="https://www.youtube.com/live/cZCOQpxC118?t=1369">22:49</a> Daniel doubles down on part of the detail in the command he used to start the cds REPL, which was:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds r <span class="token parameter variable">-u</span> ql <span class="token parameter variable">--run</span> cap/samples/bookshop/</code></pre>
<p>The <code>-u</code> (short for <code>--use</code>) option, along with the <code>--run</code> option, was introduced in the previous part (see the <a href="https://www.npmjs.com/package/@sap/cds/v/8.6.0">New cds REPL options</a> section of the notes from that episode) and using <code>-u ql</code> here loaded the <code>cds.ql</code> feature into the REPL's global context, which means that both <code>cds.ql</code> itself is available, as well as the features exposed from it (such as <code>ref</code>, <code>val</code>, <code>xpr</code> and so on).</p>
<p>Moreover, <code>cds.ql</code> is now (in 8.6) a function and can be used to create query objects. Daniel likens it to a &quot;cast&quot; function, in that whatever form of query construct you pass to it will be converted to a query object (a CQN object). Here's the example he gave:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> <span class="token domain constant">cds.ql</span> `SELECT from Authors <span class="token operator">{</span> ID<span class="token punctuation">,</span> name<span class="token punctuation">,</span> books <span class="token operator">{</span> ID<span class="token punctuation">,</span> title<span class="token punctuation">,</span> <span class="token domain constant">genre.name</span> as genre <span class="token operator">}</span> <span class="token operator">}</span>`
<span class="token domain constant">cds.ql</span> <span class="token operator">{</span>
  <span class="token property">SELECT:</span> <span class="token operator">{</span>
    <span class="token property">from:</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'Authors'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">columns:</span> <span class="token punctuation">[</span>
      <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'ID'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
      <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
      <span class="token operator">{</span>
        <span class="token property">ref:</span> <span class="token punctuation">[</span> <span class="token string">'books'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">expand:</span> <span class="token punctuation">[</span>
          <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'ID'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
          <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'title'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
          <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'genre'</span><span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> as<span class="token operator">:</span> <span class="token string">'genre'</span> <span class="token operator">}</span>
        <span class="token punctuation">]</span>
      <span class="token operator">}</span>
    <span class="token punctuation">]</span>
  <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>And similar to how (in <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#new-cds-repl-options">Executing queries</a> in the notes on last week's episode) we can immediately execute (via <code>await</code>) a query object that is wrapped as <code>Query { ... }</code>, <code>cds.ql</code> also emits a similarly <code>await</code>-able object (just wrapped as <code>cds.ql { ... }</code>):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await <span class="token domain constant">cds.ql</span> `SELECT from Authors <span class="token operator">{</span> ID<span class="token punctuation">,</span> name<span class="token punctuation">,</span> books <span class="token operator">{</span> ID<span class="token punctuation">,</span> title<span class="token punctuation">,</span> <span class="token domain constant">genre.name</span> as genre <span class="token operator">}</span> <span class="token operator">}</span>`
<span class="token punctuation">[</span>
  <span class="token operator">{</span>
    <span class="token property">ID:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    <span class="token property">name:</span> <span class="token string">'Emily Brontë'</span><span class="token punctuation">,</span>
    <span class="token property">books:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Drama'</span> <span class="token operator">}</span> <span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span>
    <span class="token property">ID:</span> <span class="token number">107</span><span class="token punctuation">,</span>
    <span class="token property">name:</span> <span class="token string">'Charlotte Brontë'</span><span class="token punctuation">,</span>
    <span class="token property">books:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Drama'</span> <span class="token operator">}</span> <span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span>
    <span class="token property">ID:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token property">name:</span> <span class="token string">'Edgar Allen Poe'</span><span class="token punctuation">,</span>
    <span class="token property">books:</span> <span class="token punctuation">[</span>
      <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'The Raven'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Mystery'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
      <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Eleonora'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Romance'</span> <span class="token operator">}</span>
    <span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span>
    <span class="token property">ID:</span> <span class="token number">170</span><span class="token punctuation">,</span>
    <span class="token property">name:</span> <span class="token string">'Richard Carpenter'</span><span class="token punctuation">,</span>
    <span class="token property">books:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Catweazle'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Fantasy'</span> <span class="token operator">}</span> <span class="token punctuation">]</span>
  <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p>In contrast, Daniel then invokes something else we touched on in the previous episode, which is <code>cds.parse.cql</code>, and showed that it produces a CQN object too (i.e. it parses the query into one) but one that is not immediately executable, just an object in its purest form.</p>
<p>To show this, at around <a href="https://www.youtube.com/live/cZCOQpxC118?t=1446">24:06</a>, Daniel tries to <code>await</code> the object, but as we found out last time, we sort of get the same effect as an identity function, i.e. we just get the object returned to us.</p>
<p>This is how the concept of a &quot;thenable&quot; was introduced, mostly because it's at the heart of the <code>await</code>-able nature of that which we've just seen.</p>
<p>In a nutshell, a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise#thenables">thenable</a> is something that has a <code>then</code> method<a href="#footnote-1"><sup>1</sup></a>. All promises are thenables ... but not all thenables are promises. This is a super interesting subject which crosses over with asynchronous features in JavaScript and how the both idea and implementation of promises have evolved over the years, but perhaps I should leave that as a topic for another blog post.</p>
<p>In effect, adding a <code>then</code> method to the CQN object (stored in the variable <code>q</code>) to pass the object in a call to <code>cds.run</code>, like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">q<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> cds<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<p>allowed Daniel to immediately invoke that CQN object as if it were an <code>await</code>-able like the <code>cds.ql</code> and <code>Query</code> object types:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await q
<span class="token punctuation">[</span>
  <span class="token operator">{</span>
    <span class="token property">ID:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    <span class="token property">name:</span> <span class="token string">'Emily Brontë'</span><span class="token punctuation">,</span>
    <span class="token property">books:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> genre<span class="token operator">:</span> <span class="token string">'Drama'</span> <span class="token operator">}</span> <span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<blockquote>
<p>If you're curious as to why Daniel changed the <code>then</code> implementation from</p>
<p><code>q.then = (r,e) =&gt; ...</code></p>
<p>to</p>
<p><code>q.then = function(r,e) { ... }</code></p>
<p>it's because the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow function expression</a> syntax has some semantic differences to the traditional <code>function() { ... }</code> expression, notably a lack of contextual binding, in particular to <code>this</code>, which makes available a reference to the object upon which the called function (or &quot;method&quot;, to use more suitable parlance here) is made.</p>
</blockquote>
<p>Daniel wraps up this section showing the source of <code>@sap/cds</code>'s <code>lib/ql/cds.ql-Query.js</code> which has pretty much exactly this pattern (and where the inspiration for this demo came from). It includes the <code>then</code> getter, defined thus:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token comment">/** Turns all queries into Thenables which execute with primary db by default */</span>
<span class="token keyword">get</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> srv <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_srv <span class="token operator">||</span> cds<span class="token punctuation">.</span>db <span class="token operator">||</span> cds<span class="token punctuation">.</span>error <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Can't execute query as no primary database is connected.</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResource</span><span class="token punctuation">(</span><span class="token string">'await cds.query'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span>e</span><span class="token punctuation">)</span> <span class="token operator">=></span> q<span class="token punctuation">.</span><span class="token function">runInAsyncScope</span> <span class="token punctuation">(</span>srv<span class="token punctuation">.</span>run<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>It's worth dwelling on yet another <a href="/blog/posts/2024/11/29/tasc-notes-part-3/#DWIM">DWIM</a> feature in CAP - that this thenable executes the query, by default, on the primary database connection (or on a service to which it has been bound). <em>&quot;Do what I mean!&quot;</em></p>
<p><a name="connecting to remote services from within the-repl"></a></p>
<h2 id="connecting-to-remote-services-from-within-the-repl">Connecting to remote services from within the REPL</h2>
<p>Next, around <a href="https://www.youtube.com/live/cZCOQpxC118?t=1605">26:45</a>, Daniel revisits a theme we touched upon in the previous episode - <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#local-and-remote-services">local and remote services</a>, specifically attempting a connection to the <code>bookshop</code> service's <code>CatalogService</code> endpoint ... from within a cds REPL session. And, as usual, there's plenty to unpack and dwell upon.</p>
<p>First, in a second terminal window, the <code>bookshop</code> service is started in a watch session, similar to this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ cds w bookshop
<span class="token builtin class-name">cd</span> bookshop

cds serve all --with-mocks --in-memory?
live reload enabled <span class="token keyword">for</span> browsers
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - connect using bindings from: <span class="token punctuation">{</span> registry: <span class="token string">'~/.cds-services.json'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - connect to db <span class="token operator">></span> sqlite <span class="token punctuation">{</span> url: <span class="token string">':memory:'</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving AdminService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/admin-service.js'</span>, path: <span class="token string">'/admin'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving CatalogService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/cat-service.js'</span>, path: <span class="token string">'/browse'</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - serving UserService <span class="token punctuation">{</span> impl: <span class="token string">'bookshop/srv/user-service.js'</span>, path: <span class="token string">'/user'</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> - server listening on <span class="token punctuation">{</span> url: <span class="token string">'http://localhost:4004'</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.</code></pre>
<p>At this point the <code>CatalogService</code> endpoint is available at <code>http://localhost:4004/browse</code>.</p>
<p>Then, in the cds REPL, back in the original terminal window, Daniel makes a first and deliberately naïve attempt to connect to it:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats <span class="token operator">=</span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token operator">)</span>
<span class="token property">Uncaught:</span>
<span class="token property">Error:</span> Didn't find a configuration for <span class="token string">'cds.requires.CatalogService'</span> in <span class="token file-path string">/home/node/cloud-cap-samples</span>
    at options4 <span class="token operator">(</span><span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@sap/cds/lib/srv/cds-connect.js</span><span class="token operator">:</span><span class="token number">66</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">)</span>
    at <span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@sap/cds/lib/srv/cds-connect.js</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">36</span>
    at <span class="token domain constant">connect.to</span> <span class="token operator">(</span><span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@sap/cds/lib/srv/cds-connect.js</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">5</span><span class="token operator">)</span>
    at REPL1<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">58</span></code></pre>
<p><a name="providing-configuration-programmatically"></a></p>
<h3 id="providing-configuration-programmatically">Providing configuration programmatically</h3>
<p>There's no configuration for this endpoint, configuration that's often found in the CAP project's <code>package.json</code> file. This is a great opportunity to highlight that in fact you can &quot;help the machinery&quot; by providing configuration programmatically, and (as Daniel mentions) is indeed explained in Capire, specifically for the <a href="https://cap.cloud.sap/docs/node.js/cds-connect#cds-connect-to-1">Method: cds.connect.to()</a> section of the &quot;cds.connect()&quot; topic, where the &quot;signature&quot; is defined like this:</p>
<pre class="language-typescript" tabindex="0"><code class="language-typescript"><span class="token keyword">async</span> <span class="token keyword">function</span> cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span><span class="token function">to</span> <span class="token punctuation">(</span>
  name <span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>  <span class="token comment">// reference to an entry in `cds.requires` config</span>
  options <span class="token operator">:</span> <span class="token punctuation">{</span>
    kind <span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// reference to a preset in `cds.requires.kinds` config</span>
    impl <span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// module name of the implementation</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre>
<p>along with this explanation:</p>
<blockquote>
<p>&quot;Argument <code>options</code> allows to pass options programmatically, and thus create services without configurations&quot;</p>
</blockquote>
<p>Given the comment to the <code>kind</code> option in the signature above (&quot;reference to a preset in cds.requires.kinds config&quot;), I was curious to see what values were actually defined:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> Object<span class="token punctuation">.</span>keys<span class="token operator">(</span>cds<span class="token punctuation">.</span>requires<span class="token punctuation">.</span>kinds<span class="token operator">)</span><span class="token punctuation">.</span>join<span class="token operator">(</span><span class="token string">' '</span><span class="token operator">)</span>
basic<span class="token operator">-</span>auth mocked<span class="token operator">-</span>auth jwt<span class="token operator">-</span>auth ias<span class="token operator">-</span>auth xsuaa<span class="token operator">-</span>auth dummy<span class="token operator">-</span>auth sql sqlite better<span class="token operator">-</span>sqlite
legacy<span class="token operator">-</span>sqlite hana hana<span class="token operator">-</span>cloud legacy<span class="token operator">-</span>hana sql<span class="token operator">-</span>mt hana<span class="token operator">-</span>mt app<span class="token operator">-</span>service rest odata
odata<span class="token operator">-</span><span class="token number">v2</span> odata<span class="token operator">-</span><span class="token number">v4</span> graphql outbox in<span class="token operator">-</span>memory<span class="token operator">-</span>outbox persistent<span class="token operator">-</span>outbox local<span class="token operator">-</span>messaging
file<span class="token operator">-</span>based<span class="token operator">-</span>messaging default<span class="token operator">-</span>messaging enterprise<span class="token operator">-</span>messaging enterprise<span class="token operator">-</span>messaging<span class="token operator">-</span>shared
enterprise<span class="token operator">-</span>messaging<span class="token operator">-</span>http enterprise<span class="token operator">-</span>messaging<span class="token operator">-</span>amqp message<span class="token operator">-</span>queuing kafka
composite<span class="token operator">-</span>messaging mtx<span class="token operator">-</span>messaging redis<span class="token operator">-</span>messaging ucl destinations connectivity</code></pre>
<p>There are a lot, as it turns out!</p>
<p>Given this opportunity, Daniel used the <code>options</code> to provide enough information for the remote connection to be made<a href="#footnote-2"><sup>2</sup></a>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token literal-property property">kind</span><span class="token operator">:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>In case you're wondering, <code>odata</code> is a synonym for <code>odata-v4</code>.</p>
<p>Of course, hard-coding service binding information like this is very useful, but only for design time and when iterating on the build of your service constellation. Information like this, especially credentials (beyond merely a URL) should be stored securely and separate to the code context. This is what <code>VCAP_SERVICES</code> in Cloud Foundry is for, as an example, and more generally what the SAP BTP's <a href="https://help.sap.com/docs/connectivity/sap-btp-connectivity-cf/consuming-destination-service">Destination Service</a> offers.</p>
<p><strong>A note on the word &quot;remote&quot; 👉</strong> Calling this a &quot;remote connection&quot; is a little bit misleading, in that it's &quot;just a connection&quot;, and the agnostic nature of CAP, specifically here embodied in this <code>cds.connect.to</code> method, means that the fact that it's remote is only because the <code>options.credentials.url</code> value points to a remote address, and at this stage, that's just for us humans to consider; the machinery doesn't really care (although it will need to use extra libraries to make the connection). See also <a href="#there-is-no-remote">There is no remote</a> later in these notes for part 6.</p>
<p>OK, back to Daniel's REPL session:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats <span class="token operator">=</span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token punctuation">,</span><span class="token operator">{</span>kind<span class="token operator">:</span><span class="token string">'odata'</span><span class="token punctuation">,</span>credentials<span class="token operator">:</span><span class="token operator">{</span>url<span class="token operator">:</span><span class="token string">'http://localhost:4004/browse'</span><span class="token operator">}</span><span class="token operator">}</span><span class="token operator">)</span>
<span class="token property">Uncaught:</span>
<span class="token punctuation">[</span>TypeError <span class="token punctuation">[</span>ERR_INVALID_REPL_INPUT<span class="token punctuation">]</span><span class="token operator">:</span> Listeners for `uncaughtException` cannot be used in the REPL<span class="token punctuation">]</span> <span class="token operator">{</span>
  <span class="token property">code:</span> <span class="token string">'ERR_INVALID_REPL_INPUT'</span>
<span class="token operator">}</span></code></pre>
<p>This error was something that really only surfaced because of our explorations here in the cds REPL. This Art and Science of CAP series just keeps on giving! Daniel was keen to not only work out what was going on here, but to share it with us.</p>
<p><a name="debug-all-the-things"></a></p>
<h3 id="debug-all-the-things">Debug all the things</h3>
<p>So at around <a href="https://www.youtube.com/live/cZCOQpxC118?t=1733">28:53</a> he restarts the cds REPL but with the value <code>y</code> for the <code>DEBUG</code> environment variable:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>y cds r</code></pre>
<blockquote>
<p>This is the same as <code>DEBUG=all</code> which you may have seen elsewhere.</p>
</blockquote>
<p>The wonderful thing about turning the log level to 11 and <a href="/blog/posts/2024/10/05/cap-node.js-plugins-part-1-how-things-work/#debug-and-digging-in">digging in</a> is that we learn so much from what's emitted. If you want to know more, we have a quick YouTube Short on the topic - <a href="https://www.youtube.com/shorts/C_0Za3wTcEM">Controlling CAP server log levels</a>:</p>
<p><a href="https://www.youtube.com/shorts/C_0Za3wTcEM"><img src="/images/2024/12/debug-short.jpg" alt="YouTube Short screenshot"></a></p>
<p>With that log level turned right up, here's what's emitted:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">@</span>sap<span class="token operator">/</span>cds <span class="token number">8.6.0</span> loaded<span class="token operator">:</span> <span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@sap/cds</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> Command resolved<span class="token operator">:</span> <span class="token file-path string">/usr/local/share/npm-global/lib/node_modules/@sap/cds-dk/bin/repl.js</span>
Welcome to cds repl v <span class="token number">8.6.0</span>
<span class="token operator">></span> cats <span class="token operator">=</span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token punctuation">,</span><span class="token operator">{</span>kind<span class="token operator">:</span><span class="token string">'odata'</span><span class="token punctuation">,</span>credentials<span class="token operator">:</span><span class="token operator">{</span>url<span class="token operator">:</span><span class="token string">'http://localhost:4004/browse'</span><span class="token operator">}</span><span class="token operator">}</span><span class="token operator">)</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds-fiori/.cdsrc.yaml'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds-fiori/.cdsrc.json'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds-fiori/.cdsrc.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds-fiori/package.json'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> importing <span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@sap/cds-fiori/package.json</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@cap-js/sqlite/.cdsrc.yaml'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@cap-js/sqlite/.cdsrc.json'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@cap-js/sqlite/.cdsrc.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span>
  <span class="token property">file:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@cap-js/sqlite/package.json'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> importing <span class="token file-path string">/home/node/cloud-cap-samples/node_modules/@cap-js/sqlite/package.json</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/.cdsrc.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/.cdsrc.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/.cdsrc.yaml'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/.cdsrc.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/.cdsrc.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/package.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/.cdsrc-private.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/default-env.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token operator">-</span> checking <span class="token operator">{</span> file<span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples/.env'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span>factory<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span>
  <span class="token string">'cds.root'</span><span class="token operator">:</span> <span class="token string">'/home/node/cloud-cap-samples'</span><span class="token punctuation">,</span>
  <span class="token property">paths:</span> <span class="token punctuation">[</span>
    <span class="token string">'/home/node/cloud-cap-samples'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds/lib/srv/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds/lib/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/cloud-cap-samples/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/.node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node/.node_libraries'</span><span class="token punctuation">,</span>
    <span class="token string">'/usr/local/lib/node'</span>
  <span class="token punctuation">]</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span>factory<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span>
  <span class="token property">name:</span> <span class="token string">'CatalogService'</span><span class="token punctuation">,</span>
  <span class="token property">definition:</span> <span class="token operator">{</span><span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">options:</span> <span class="token operator">{</span>
    <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
    <span class="token property">impl:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
    <span class="token property">external:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">credentials:</span> <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span>
  <span class="token operator">}</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span>factory<span class="token punctuation">]</span> <span class="token operator">-</span> requires <span class="token operator">{</span>
  <span class="token property">service:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">source:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
  <span class="token property">impl:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span>factory<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span>
  <span class="token property">resolved:</span> <span class="token string">'/home/node/cloud-cap-samples/node_modules/@sap/cds/libx/_runtime/remote/Service.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>trace<span class="token punctuation">]</span> <span class="token operator">-</span> require <span class="token domain constant">cds.compiler</span>  <span class="token operator">:</span> <span class="token number">29.746ms</span></code></pre>
<p>That's quite some output!</p>
<p>Briefly, what we can discern from it is that there are log records from the <code>cds</code>, <code>cds.env</code>, <code>cds.service.factory</code> and <code>trace</code> modules, and:</p>
<ul>
<li>the <code>cds.env</code> output shows how the effective configuration is gathered from multiple but well-known files (<code>.cdsrc.yaml</code>, <code>.cdsrc.json</code>, <code>.cdsrc.js</code>, <code>package.json</code>, <code>.cdsrc-private.json</code>, <code>default-env.json</code> and <code>.env</code>) in various locations<a href="#footnote-3"><sup>3</sup></a></li>
<li>the <code>cds.service.factory</code> output shows that the CAP server has determined the nature of the <code>CatalogService</code> connection and embellished the options with <code>external: true</code> and details of the module that implements the remote service connection</li>
</ul>
<p>It's always worth taking a few seconds to stare at output like this. Even when it doesn't directly help the diagnosis, it will almost always add value, context and understanding.</p>
<p><a name="the-uncaughtexception-culprit"></a></p>
<h3 id="the-uncaughtexception-culprit">The 'uncaughtException' culprit</h3>
<p>Through some brute-force searching through the codebase, Daniel eventually finds the problem - the <a href="https://github.com/winstonjs/winston">Winston logger</a>, which <a href="https://github.com/winstonjs/winston/blob/8769d47a8b23dbda0069e285fbf1cda9e3e9f265/lib/winston/exception-handler.js#L49-L52">emits an uncaught exception</a>. The Winston logger is used by the <a href="https://sap.github.io/cloud-sdk/">SAP Cloud SDK</a>, which we know (if you don't, see <a href="#footnote-2">footnote 2</a>) is used by the CAP server for remote connections.</p>
<p>By means of &quot;a light tap with a heavy stick&quot; (essentially commenting out the offending lines) Daniel manages to prevent this uncaught exception failure in the REPL, and the remote connection is successfully set up!</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats <span class="token operator">=</span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token punctuation">,</span><span class="token operator">{</span>kind<span class="token operator">:</span><span class="token string">'odata'</span><span class="token punctuation">,</span>credentials<span class="token operator">:</span><span class="token operator">{</span>url<span class="token operator">:</span><span class="token string">'http://localhost:4004/browse'</span><span class="token operator">}</span><span class="token operator">}</span><span class="token operator">)</span>
RemoteService <span class="token operator">{</span>
  <span class="token property">name:</span> <span class="token string">'CatalogService'</span><span class="token punctuation">,</span>
  <span class="token property">options:</span> <span class="token operator">{</span>
    <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
    <span class="token property">impl:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
    <span class="token property">external:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">credentials:</span> <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
  <span class="token property">handlers:</span> EventHandlers <span class="token operator">{</span>
    <span class="token property">_initial:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> clearKeysFromData<span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">before:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">on:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> on_handler<span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">after:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">_error:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">definition:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">_source:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
  <span class="token property">datasource:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">destinationOptions:</span> <span class="token operator">{</span> useCache<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">destination:</span> <span class="token operator">{</span> name<span class="token operator">:</span> undefined<span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">path:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">requestTimeout:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
  <span class="token property">csrf:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">csrfInBatch:</span> undefined<span class="token punctuation">,</span>
  <span class="token property">middlewares:</span> <span class="token operator">{</span> timeout<span class="token operator">:</span> <span class="token punctuation">[</span>Function <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> csrf<span class="token operator">:</span> undefined <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">entities:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">actions:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">}</span></code></pre>
<blockquote>
<p>I deliberately used the phrase &quot;successfully set up&quot; and not &quot;successfully established&quot; because at this point no actual connection has been made to the remote service.</p>
<p>Nor would that make much sense anyway, in that the protocols supported are all &quot;connection-less&quot; (in that, for example, HTTP is a connection-less protocol). This point can be driven home by stopping the remote service at this point, then restarting it, and it makes no difference to this existing <code>RemoteService</code> object and whether it can still reach the remote endpoints (it can).</p>
</blockquote>
<p><a name="caps-open-source-philosophy"></a></p>
<h3 id="caps-open-source-philosophy">CAP's open source philosophy</h3>
<p>In wrapping up this section, Daniel explains at <a href="https://www.youtube.com/live/cZCOQpxC118?t=1826">30:26</a> his philosophy on the use of open source software, warranties, and minimising the risk surface area for libraries employed. There are only three major open source libraries used in CAP Node.js, and those are:</p>
<ul>
<li><a href="https://nodejs.org/en">Node.js</a></li>
<li><a href="https://www.npmjs.com/package/sqlite3">SQLite</a></li>
<li><a href="https://expressjs.com/">Express</a></li>
</ul>
<h2 id="sending-queries-to-the-remote-service">Sending queries to the remote service</h2>
<p>And to demonstrate the remote service connection, Daniel performed a query.</p>
<p>But before I show that, I wanted to pause and dwell on what Capire has to say here that is relevant for our understanding.</p>
<p>In the <a href="https://cap.cloud.sap/docs/node.js/cds-connect#cds-connect-to-name-options-8594-service">cds.connect.to (name, options?) -&gt; service</a> section of the <a href="https://cap.cloud.sap/docs/node.js/cds-connect">cds.connect()</a> topic, we see that what's returned from this <code>cds.connect.to</code> call is &quot;<em>a Promise resolving to a corresponding Service instance</em>&quot;.</p>
<p>Moreover, &quot;<em>[s]ervice instances are cached in <code>cds.services</code> ... [and a]s services constructed by <code>cds.serve</code> are registered with <code>cds.services</code> as well, a connect finds and returns them <strong>as local service connections</strong></em>&quot; (emphasis mine).</p>
<p>This underlines the <a href="https://cap.cloud.sap/docs/about/best-practices#hexagonal-architecture">hexagonal architecture</a> approach, as well as helping join the dots, the first of which is that this <code>RemoteService</code> object now shows up in <code>cds.services</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> <span class="token domain constant">cds.services</span>
<span class="token operator">{</span>
  <span class="token property">CatalogService:</span> RemoteService <span class="token operator">{</span>
    <span class="token property">name:</span> <span class="token string">'CatalogService'</span><span class="token punctuation">,</span>
    <span class="token property">options:</span> <span class="token operator">{</span>
      <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
      <span class="token property">impl:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
      <span class="token property">external:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">credentials:</span> <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
    <span class="token property">handlers:</span> EventHandlers <span class="token operator">{</span>
      <span class="token property">_initial:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> before<span class="token operator">:</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> clearKeysFromData<span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">before:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">on:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> on_handler<span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">after:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">_error:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">definition:</span> undefined<span class="token punctuation">,</span>
    <span class="token property">_source:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
    <span class="token property">datasource:</span> undefined<span class="token punctuation">,</span>
    <span class="token property">destinationOptions:</span> <span class="token operator">{</span> useCache<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">destination:</span> <span class="token operator">{</span> name<span class="token operator">:</span> undefined<span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">path:</span> undefined<span class="token punctuation">,</span>
    <span class="token property">requestTimeout:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token property">csrf:</span> undefined<span class="token punctuation">,</span>
    <span class="token property">csrfInBatch:</span> undefined<span class="token punctuation">,</span>
    <span class="token property">middlewares:</span> <span class="token operator">{</span> timeout<span class="token operator">:</span> <span class="token punctuation">[</span>Function <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> csrf<span class="token operator">:</span> undefined <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">entities:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">actions:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<blockquote>
<p>Daniel also expands on this a little later - see <a href="#there-is-no-remote">There is no remote</a> a little further on in these notes.</p>
</blockquote>
<p>Additionally, using tab completion in the REPL on <code>cats</code> (the reference to this <code>RemoteService</code> object) shows what's possible:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats<span class="token punctuation">.</span>
<span class="token domain constant">cats.events</span>                <span class="token domain constant">cats.model</span>                 <span class="token domain constant">cats.namespace</span>             <span class="token domain constant">cats.operations</span>            <span class="token domain constant">cats.reflect</span>
<span class="token domain constant">cats.types</span>

cats<span class="token punctuation">.</span>_handlers             cats<span class="token punctuation">.</span>_implicit_next        cats<span class="token punctuation">.</span>_is_service_instance  <span class="token domain constant">cats.after</span>                 <span class="token domain constant">cats.before</span>
<span class="token domain constant">cats.dispatch</span>              cats<span class="token punctuation">.</span>isExtensible          <span class="token domain constant">cats.on</span>                    cats<span class="token punctuation">.</span>onFailed              cats<span class="token punctuation">.</span>onSucceeded
<span class="token domain constant">cats.prepend</span>               <span class="token domain constant">cats.reject</span>                <span class="token domain constant">cats.transaction</span>           <span class="token domain constant">cats.tx</span>

<span class="token domain constant">cats.create</span>                <span class="token domain constant">cats.decorate</span>              <span class="token domain constant">cats.delete</span>                <span class="token domain constant">cats.disconnect</span>            <span class="token domain constant">cats.emit</span>
<span class="token domain constant">cats.exists</span>                <span class="token domain constant">cats.foreach</span>               <span class="token domain constant">cats.get</span>                   <span class="token domain constant">cats.insert</span>                <span class="token domain constant">cats.patch</span>
<span class="token domain constant">cats.post</span>                  <span class="token domain constant">cats.put</span>                   <span class="token domain constant">cats.read</span>                  <span class="token domain constant">cats.run</span>                   <span class="token domain constant">cats.send</span>
<span class="token domain constant">cats.update</span>                <span class="token domain constant">cats.upsert</span>

cats<span class="token punctuation">.</span>_requires_resolving   <span class="token domain constant">cats.endpoints</span>

<span class="token domain constant">cats.constructor</span>           <span class="token domain constant">cats.handle</span>                <span class="token domain constant">cats.init</span>                  cats<span class="token punctuation">.</span>isExternal

cats<span class="token punctuation">.</span>_source               <span class="token domain constant">cats.actions</span>               <span class="token domain constant">cats.csrf</span>                  cats<span class="token punctuation">.</span>csrfInBatch           <span class="token domain constant">cats.datasource</span>
<span class="token domain constant">cats.definition</span>            <span class="token domain constant">cats.destination</span>           cats<span class="token punctuation">.</span>destinationOptions    <span class="token domain constant">cats.entities</span>              <span class="token domain constant">cats.handlers</span>
<span class="token domain constant">cats.kind</span>                  <span class="token domain constant">cats.middlewares</span>           <span class="token domain constant">cats.name</span>                  <span class="token domain constant">cats.options</span>               <span class="token domain constant">cats.path</span>
cats<span class="token punctuation">.</span>requestTimeout</code></pre>
<p><a name="properties-of-a-remote-service"></a></p>
<h3 id="properties-of-a-remote-service">Properties of a remote service</h3>
<p>But what is a <code>RemoteService</code>, essentially?</p>
<p>Well, Capire's <a href="https://cap.cloud.sap/docs/node.js/remote-services">Remote Services</a> topic tells us that the <code>cds.RemoteService</code> class extends <code>cds.Service</code>. Knowing what we know about the Art and Science of CAP so far, and thinking logically, this makes a lot of sense.</p>
<p>And Capire tells us a lot about the <a href="https://cap.cloud.sap/docs/node.js/core-services#cds-service">Class: cds.Service</a> which will help us dig into what Daniel invokes, at this point:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats<span class="token punctuation">.</span>get`Books`
<span class="token domain constant">cds.ql</span> <span class="token operator">{</span>
  <span class="token property">SELECT:</span> <span class="token operator">{</span> from<span class="token operator">:</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'Books'</span> <span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>Right now, we can determine that:</p>
<ul>
<li>we have an instance of <code>cds.RemoteService</code> in <code>cats</code></li>
<li>this in turn is based on <code>cds.Service</code></li>
<li>which has all those properties and methods that we see above</li>
<li>one of which is <code>get</code></li>
</ul>
<p>plus:</p>
<ul>
<li>the generic name in Capire for the service instance examples here in this large section on the <a href="https://cap.cloud.sap/docs/node.js/core-services#cds-service">cds.Service class</a> is <code>srv</code></li>
</ul>
<p><a name="api-styles-for-service-consumption"></a></p>
<h3 id="api-styles-for-service-consumption">API styles for service consumption</h3>
<p>With this in mind, and thinking about what Daniel invoked:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> cats<span class="token punctuation">.</span>get`Books`</code></pre>
<p>we can then examine the <a href="https://cap.cloud.sap/docs/node.js/core-services#rest-style-api">REST-style API</a> section in this Capire topic which tells us that</p>
<p><code>srv.get(path, ...)</code></p>
<p>is a REST-style convenience method that is the equivalent of (syntactic sugar for)</p>
<p><code>srv.send('GET', path, ...)</code></p>
<p>In essence, <code>cats.send('GET', 'Books')</code>, <code>cats.get`Books` </code> and even <code>cats.get(`Books`)</code><a href="#footnote-4"><sup>4</sup></a> each result in a promise that needs to be <code>await</code>-ed, thus (note the debug output from the <code>remote</code> module here too):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await cats<span class="token punctuation">.</span>get`Books`
<span class="token punctuation">[</span>remote<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token url">http://localhost:4004/browse/Books</span> <span class="token operator">{</span> headers<span class="token operator">:</span> <span class="token operator">{</span> accept<span class="token operator">:</span> <span class="token string">'application/json,text/plain'</span> <span class="token operator">}</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>
  <span class="token operator">{</span>
    <span class="token property">createdAt:</span> <span class="token string">'2024-12-31T15:09:44.103Z'</span><span class="token punctuation">,</span>
    <span class="token property">modifiedAt:</span> <span class="token string">'2024-12-31T15:09:44.103Z'</span><span class="token punctuation">,</span>
    <span class="token property">ID:</span> <span class="token number">201</span><span class="token punctuation">,</span>
    <span class="token property">title:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span>
    <span class="token property">descr:</span> `Wuthering Heights<span class="token punctuation">,</span> Emily Brontë's only novel<span class="token punctuation">,</span> was published <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>`<span class="token punctuation">,</span>
    <span class="token property">author:</span> <span class="token string">'Emily Brontë'</span><span class="token punctuation">,</span>
    <span class="token property">genre_ID:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token property">stock:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">price:</span> <span class="token number">11.11</span><span class="token punctuation">,</span>
    <span class="token property">currency_code:</span> <span class="token string">'GBP'</span><span class="token punctuation">,</span>
    <span class="token string">'image@odata.mediaContentType'</span><span class="token operator">:</span> <span class="token boolean">null</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span></code></pre>
<p>Interestingly, directly following the <a href="https://cap.cloud.sap/docs/node.js/core-services#rest-style-api">REST-style API</a> section in Capire, the <a href="https://cap.cloud.sap/docs/node.js/core-services#crud-style-api">CRUD-style API</a> alternative is described, which sports convenience methods along the lines of the Create / Read / Update / Delete (CRUD) model. And Daniel shows a nice example of that style next, with:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await <span class="token domain constant">cats.read</span> `ID<span class="token punctuation">,</span>title<span class="token punctuation">,</span>genre<span class="token punctuation">.</span>name as genre` <span class="token punctuation">.</span>from `Books`
<span class="token punctuation">[</span>remote<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token url">http://localhost:4004/browse/Books?$select=ID</span><span class="token punctuation">,</span>title<span class="token punctuation">,</span>genre<span class="token operator">%</span>2Fname <span class="token operator">{</span> headers<span class="token operator">:</span> <span class="token operator">{</span> accept<span class="token operator">:</span> <span class="token string">'application/json,text/plain'</span> <span class="token operator">}</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> genre_name<span class="token operator">:</span> <span class="token string">'Drama'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> genre_name<span class="token operator">:</span> <span class="token string">'Drama'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">251</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'The Raven'</span><span class="token punctuation">,</span> genre_name<span class="token operator">:</span> <span class="token string">'Mystery'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">252</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Eleonora'</span><span class="token punctuation">,</span> genre_name<span class="token operator">:</span> <span class="token string">'Romance'</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">271</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Catweazle'</span><span class="token punctuation">,</span> genre_name<span class="token operator">:</span> <span class="token string">'Fantasy'</span> <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p><a name="other-ways-to-provide-configuration"></a></p>
<h3 id="other-ways-to-provide-configuration">Other ways to provide configuration</h3>
<p>Earlier we saw Daniel demonstrated how to <a href="#providing-configuration-programmatically">provide configuration programmatically</a>. At this point, following a brief discussion about security and managing credentials, Daniel demonstrated one of the many other ways to provide configuration. There's lots to discover in the <a href="https://cap.cloud.sap/docs/node.js/cds-env">cds.env</a> Capire topic, and the <a href="https://cap.cloud.sap/docs/node.js/cds-env#on-the-command-line">On the Command Line</a> section in particular describes what is demonstrated next:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">$</span> cds_requires_CatalogService_kind<span class="token operator">=</span>odata \
  cds_requires_CatalogService_credentials_url<span class="token operator">=</span><span class="token url">http://localhost:4004/browse</span> \
  cds r
Welcome to cds repl v <span class="token number">8.6.0</span>
<span class="token operator">></span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token operator">)</span>
RemoteService <span class="token operator">{</span>
  <span class="token property">name:</span> <span class="token string">'CatalogService'</span><span class="token punctuation">,</span>
  <span class="token property">options:</span> <span class="token operator">{</span>
    <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
    <span class="token property">impl:</span> <span class="token string">'@sap/cds/libx/_runtime/remote/Service.js'</span><span class="token punctuation">,</span>
    <span class="token property">external:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">credentials:</span> <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004/browse'</span> <span class="token operator">}</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">kind:</span> <span class="token string">'odata'</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">}</span></code></pre>
<p>Using this environment variable laden invocation of the cds REPL, and to embed some small concepts we've learned over this series so far, how about:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await <span class="token operator">(</span>await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token operator">)</span><span class="token operator">)</span> <span class="token punctuation">.</span>read `title` <span class="token punctuation">.</span>from `Books`
<span class="token punctuation">[</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">201</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">207</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'The Raven'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">251</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Eleonora'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">252</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Catweazle'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">271</span> <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p>or even:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await cds<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>to<span class="token operator">(</span><span class="token string">'CatalogService'</span><span class="token operator">)</span> <span class="token punctuation">.</span>then<span class="token operator">(</span> x <span class="token operator">=</span><span class="token operator">></span> x <span class="token punctuation">.</span>read `title` <span class="token punctuation">.</span>from `Books`<span class="token operator">)</span>
<span class="token punctuation">[</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">201</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">207</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'The Raven'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">251</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Eleonora'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">252</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> title<span class="token operator">:</span> <span class="token string">'Catweazle'</span><span class="token punctuation">,</span> ID<span class="token operator">:</span> <span class="token number">271</span> <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p><a name="there-is-no-remote"></a></p>
<h3 id="there-is-no-remote">There is no remote</h3>
<p>Next, around <a href="https://www.youtube.com/live/cZCOQpxC118?t=2171">36:11</a>, Daniel returns to one of the enduring developer-focused ideas in CAP, which is making it possible for developers to not worry or even care about underlying protocols or low level implementation details. A service is a service is a service, whether remote or local.</p>
<p>While there might be <a href="#api-styles-for-service-consumption">different styles of APIs</a> to suit different tastes or semantic preferences, there is no difference between a local and a remote service when it comes to talking to it.</p>
<p><img src="/images/2024/12/there-is-no-remote.jpg" alt="there is no remote"></p>
<p>Daniel illustrates this effect with a diagram, which I'll try to reproduce here in ASCII art (because ASCII art).</p>
<p>First, a local service A talking to a local service B:</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-----+      +-----+
|     |      |     |
|  A  |-CQN->|  B  |
|     |      |     |
+-----+      +-----+</code></pre>
<p>So far so good.</p>
<p>Now, if B were remote (illustrated by being positioned further over to the right here)</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-----+                              +-----+
|     |                              |     |
|  A  |-CQN->?                       |  B  |
|     |                              |     |
+-----+                              +-----+</code></pre>
<p>then actually what is provided is a proxy for B, local to A, and an adapter over at B:</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-----+                              +-----+
|     |                              |     |
|  A  |                              |  B  |
|     |                              |     |
+-----+                              +-----+
   |                                    ^
  CQN  +-----+                +-----+   |
   |   |     |                |     |   |
   +-->|  B' |                |  B' |---+
       |     |                |     |
       +-----+                +-----+
        proxy                 adapter</code></pre>
<p>And the distance between the B' proxy and the B' adapter is covered by a wire protocol, such as OData or GraphQL.</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-----+                              +-----+
|     |                              |     |
|  A  |                              |  B  |
|     |                              |     |
+-----+                              +-----+
   |                                    ^
  CQN  +-----+                +-----+   |
   |   |     |                |     |   |
   +-->|  B' |-----ODATA----->|  B' |---+
       |     |                |     |
       +-----+                +-----+
        proxy                 adapter</code></pre>
<p>As Daniel shows with help from the <a href="https://cap.cloud.sap/docs/about/best-practices#query-language-cql">comparison table</a>, CQL is a superset of any of these protocols (and of SQL) and thus to avoid lossiness in serialising CQN at one end and deserialising it at the other, we now have CQL-over-HTTP, or HCQL.</p>
<p>There is currently very little mention of this in Capire but we see from the <a href="https://cap.cloud.sap/docs/releases/changelog/#jan-24-added">January 2024 release notes</a> that it's been around at least for a year in the Java flavour. Hopefully we can dig into HCQL in a future episode of this series!</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-----+                              +-----+
|     |                              |     |
|  A  |                              |  B  |
|     |                              |     |
+-----+                              +-----+
   |                                    ^
  CQN  +-----+                +-----+   |
   |   |     |                |     |   |
   +-->|  B' |-----HCQL------>|  B' |---+
       |     |                |     |
       +-----+                +-----+
        proxy                 adapter</code></pre>
<p>This interchangeability of &quot;transport layer&quot; is, at least in my mind, further emphasised by how one uses an annotation (<a href="https://cap.cloud.sap/docs/node.js/cds-serve#protocol"><code>@protocol</code></a>) to determine the protocol via which a service is available. The nature of an annotation - being separate to what it is annotating, and also easily modified - conveys an ultimate decoupling of the protocol from the service itself.</p>
<p>By the way, we touched on this in the previous episode too - see the <a href="/blog/posts/2024/12/13/tasc-notes-part-5/#remote-services-proxies-and-abstraction">Remote services, proxies and abstraction</a> section of the notes to Part 5 for more details.</p>
<p>Oh, and don't forget, folks: REST is not a protocol, it's an architectural style (and yes, I really did name my narrowboat home &quot;FULLY RESTFUL&quot;).</p>
<p><img src="/images/2024/12/narrowboat-fully-restful.jpg" alt="Narrowboat FULLY RESTFUL"></p>
<p>That's why Daniel was saying that while CQN could be transported over REST, you'd have to construct an actual language, a protocol, to do so (and if you did it thoroughly, you might end up with something like ... OData).</p>
<p><a name="best-practices-revisited"></a></p>
<h2 id="best-practices-revisited">Best practices revisited</h2>
<p>At <a href="https://www.youtube.com/live/cZCOQpxC118?t=2730">45:30</a> Daniel returns to Capire's <a href="https://cap.cloud.sap/docs/about/best-practices">Best Practices</a> topic; here's a brief summary of his commentary:</p>
<ul>
<li><strong>Domain Models</strong>: Capture domain knowledge, focus on what not how, keep it simple stupid (KISS), and make it understandable for the domain experts (see also <a href="/blog/posts/2024/11/02/keeping-things-simple-in-domain-modelling-with-cds/">Keeping things simple in domain modelling with CDS</a>).</li>
<li><strong>Services</strong>: Services are interfaces, provide facades from the inside out and protect your inner mechanisms from the outside.</li>
<li><strong>Events</strong>: A key, critical component of the design of CAP, driven by both art and science concepts (in particular: <a href="https://en.wikipedia.org/wiki/Message_passing">message passing</a>, pretty much the opposite of what one might call &quot;RPC&quot; or remote function invocation).</li>
<li><strong>Data</strong>: keep data as passive as possible, to get the most benefit from querying and the best chance at extensibility.</li>
<li><strong>Querying</strong>: Raise up queries to the level of importance they deserve, treat them as first class citizens (they are) and always be wary of falling into the trap of trying to reproduce the effects of <a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping">object-relational mapping</a>. Additionally, the combination of how we should regard data and queries means that we can take complex validations and <em>push them down to the database</em> with that set of validations translated into a query ... instead of reading a big lump of data to perform the validations on manually and &quot;in the wrong place&quot;.</li>
<li><strong>Agnostic by Design</strong>: This is such a fundamental driving theme for CAP, and is inspired by the idea of <a href="https://alistair.cockburn.us/hexagonal-architecture/">hexagonal architecture</a>; in fact <a href="https://cap.cloud.sap/docs/about/best-practices#cap-as-an-implementation-of-hexagonal-architecture">CAP is an implementation of it</a>, notably in how it shields us from the &quot;real world&quot; of cloud services, reflecting the key intent of hexagonal architecture which is to provide <em>isolation</em> from real world peripheral hardware and software objects.</li>
<li><strong>Intrinsic Extensibility</strong>: As CAP's &quot;everything&quot; mantra goes (&quot;<a href="/blog/posts/2024/12/10/tasc-notes-part-4/#everything-is-a-service">everything is a service</a>&quot;, &quot;<a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/#adding-custom-logic">everything is an event</a>&quot;) - everything is extensible. Models (through the power of aspects - see <a href="https://qmacro.org/blog/posts/2024/11/04/separating-concerns-and-focusing-on-the-important-stuff/">Separating concerns and focusing on the important stuff</a>), logic, and of course the framework itself - see the <a href="/blog/posts/2024/12/10/tasc-notes-part-4/#interacting-with-the-database-service">Interacting with the database service</a> section of the notes to Part 4 of this series. Of course, the CAP framework is extensible in other ways - such as <a href="https://cap.cloud.sap/docs/plugins/">with the plugin concept</a> (for which we have a short series too - see the link in the &quot;Wrapping up&quot; section below).</li>
</ul>
<p><a name="wrapping-up"></a></p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>That just about wraps it up for this episode; the series is now paused while we make space for other topics (such as the <a href="/blog/posts/2024/12/30/cap-node.js-plugins/">CAP Node.js Plugins</a> mini-series in January 2025) but we hope to be back live again with you soon! Thanks for reading these notes, I'd love to hear from you in the comments section below.</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<p><a name="footnote-1"></a></p>
<ol>
<li>This reminds me of <a href="https://qmacro.org/blog/posts/2016/10/19/f3c-parts-9-and-10-functors/">my musings into functors</a>, wherein a functor is something that has a <code>map</code> method.</li>
</ol>
<p><a name="footnote-2"></a>
2. In reproducing the examples, I'm using the latest publicly available CAP Node.js version which is 8.6.1, and when I first made this connection invocation I got an error:</p>
<p><code>Uncaught Error: Cannot find module '@sap-cloud-sdk/resilience'</code></p>
<p>which is related to the requirement for the SAP Cloud SDK which CAP uses to handle the detail and complexity of remote connections, especially in the context of destination definitions (think of the <a href="https://help.sap.com/docs/connectivity/sap-btp-connectivity-cf/consuming-destination-service">Destination Service</a> on SAP BTP).</p>
<p>I cover this in great detail in the <a href="https://github.com/SAP-samples/cap-service-integration-codejam/">Service Integration with SAP Cloud Application Programming Model</a> CodeJam, specifically in <a href="https://github.com/SAP-samples/cap-service-integration-codejam/tree/main/exercises/08-introduce-sap-cloud-sdk#try-it-out">Exercise 08 - Introduce the SAP Cloud SDK</a>, so will just say here that to overcome this error, I just installed the NPM package <code>@sap-cloud-sdk/http-client</code>.</p>
<p><a name="footnote-3"></a>
3. Did you notice <em>what</em> locations? They're the project-local location plus the locations ... of the automatically-loaded plugins! This relationship is explained further in <a href="/blog/posts/2024/10/05/cap-node.js-plugins-part-1-how-things-work">CAP Node.js plugins - part 1 - how things work</a>.</p>
<p><a name="footnote-4"></a>
4. If you're curious about <code>cats.get`Books` </code> vs <code>cats.get(`Books`)</code>, you might find the MDN documentation on <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#tagged_templates">Tagged templates</a> useful.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/12/16/functions-as-first-class-citizens-in-sicp-lecture-1a/">Functions as first class citizens in SICP Lecture 1A</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/12/30/cap-node-js-plugins/">CAP Node.js Plugins</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/12/20/tasc-notes-part-6/` was built on 2025-09-16T07:54:22.297Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
	</body>
</html>
