<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>TASC Notes - Part 4</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="tasc-notes-part-4">TASC Notes - Part 4</h1>

<ul class="post-metadata">
	<li><time datetime="2024-12-10">10 December 2024</time></li>
	<li><a href="/tags/tasc/" class="post-tag">tasc</a>, </li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/handsonsapdev/" class="post-tag">handsonsapdev</a></li>
</ul>

<p class="post-description-main"></p>

<p>These are somewhat more detailed notes than normal that summarise <a href="https://www.youtube.com/watch?v=kwxvyiC-6FI">The Art and Science of CAP part 4</a>, one episode in a mini series with Daniel Hutzel to explore the philosophy, the background, the technology history and layers that support and inform the SAP Cloud Application Programming Model.</p>
<p>For all resources related to this series, see the post <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">The Art and Science of CAP</a>.</p>
<p>This episode started with a <a href="/blog/posts/2024/11/29/tasc-notes-part-3/">review of the previous episode</a> (where we collectively decided to make my episode notes into published blog posts like this one).</p>
<h2 id="functional-programming-concepts">Functional programming concepts</h2>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=780">13:18</a> Daniel brought up a slide deck from one of my talks on Functional Programming, <a href="https://docs.google.com/presentation/d/1VWGEutu0o541a81GPCHG-pQ6IhX8TXC9WwM90JPtIwc/edit">Functional programming introduction: What, why, how?</a> and the person in the photo on slide four is of course <a href="https://en.wikipedia.org/wiki/John_McCarthy_(computer_scientist)">John McCarthy</a> (well done VJ), father of Lisp.</p>
<p>In this context we also touched on <a href="/blog/posts/2016/10/03/f3c-part-6-currying/">currying</a> (which incidentally is named after <a href="https://en.wikipedia.org/wiki/Haskell_Curry">Haskell Curry</a>, after whom the pure FP language <a href="https://www.haskell.org/">Haskell</a> is also named) and <a href="https://en.wikipedia.org/wiki/Partial_application">partial application</a>, and then on the concept of a <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closure</a> - a beautiful technique for implementing lexically scoped name bindings in a language that has support for first class functions (such as JavaScript!).</p>
<p><a name="everything-is-a-service"></a></p>
<h2 id="everything-is-a-service">Everything is a service</h2>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=1060">17:40</a> Daniel then turned to the <a href="https://cap.cloud.sap/docs/get-started/">Getting Started</a> area of Capire, and in particular the <a href="https://cap.cloud.sap/docs/about/best-practices#services">Services</a> section of the <a href="https://cap.cloud.sap/docs/about/best-practices">Best Practices</a> topic, where he turns around &quot;When all you have is a hammer, every (thing) is a nail&quot; into &quot;Everything (in CAP) is a service&quot;.</p>
<p>In contrast to the &quot;hammer and nail&quot; adage, this axiom is something positive here, something which follows the pattern of uniformity and the elevation of abstraction, in that via CAP's adoption of <a href="/blog/posts/2024/11/22/tasc-notes-part-2/">Hexagonal Architecture</a> the heavy lifting done by the adapters is hidden and of little importance to the application or service developer ... except that (as we see <a href="#interacting-with-the-database-service">later</a>) that developer can interact with and extend the database connection mechanism as easily and as readily as with their own domain services.</p>
<p>In digging into this, and thinking about lower level facilities abstracted upwards as services, and binding in the related idea (<a href="/blog/posts/2024/11/22/tasc-notes-part-2/">captured in Part 2</a>) that &quot;everything is an event&quot;, Daniel made this statement:</p>
<blockquote>
<p>&quot;The sum of all your event handlers registered with the service ... is your implementation.&quot;</p>
</blockquote>
<p>That goes for both local and remote events as well as local and remote services, plus built-in services ... such as a database service, as illustrated in Capire's <a href="https://cap.cloud.sap/docs/about/best-practices#extensible-framework">Extensible Framework</a> section:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">cds<span class="token punctuation">.</span>db <span class="token punctuation">.</span><span class="token function">before</span> <span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>event<span class="token punctuation">,</span> req<span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>and also the <a href="https://cap.cloud.sap/docs/about/best-practices#the-calesi-pattern">Calesi</a> services. And this approach allows us as developers ... to &quot;not care&quot;. In the best possible way.</p>
<p>This thinking, this approach, is inspired by Smalltalk's concept of &quot;messaging&quot;, in that objects send and receive messages, and of course the receipt of a message is ... an event (upon which event-handling code - which we can think of as an indirect method - is executed).</p>
<p>Daniel goes on to explain Smalltalk's <a href="https://wiki.c2.com/?DoesNotUnderstand">#doesNotUnderstand</a> mechanism which can be effectively turned into a proxy for other services. This idiom is also present in other languages, for example Ruby, in the form of the <a href="https://www.leighhalliday.com/ruby-metaprogramming-method-missing">method_missing</a> construct<a href="#footnote-1"><sup>1</sup></a>.</p>
<p><a name="the-repl"></a></p>
<h2 id="the-repl">The REPL</h2>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=1620">27:00</a> Daniel opens the REPL, and explains how the set of built-in REPL commands (that begin with a period):</p>
<pre class="language-log" tabindex="0"><code class="language-log">Type <span class="token string">".help"</span> for more information<span class="token punctuation">.</span>
<span class="token operator">></span> <span class="token punctuation">.</span>help
<span class="token punctuation">.</span>break    Sometimes you get stuck<span class="token punctuation">,</span> this gets you out
<span class="token punctuation">.</span>clear    Alias for <span class="token punctuation">.</span>break
<span class="token punctuation">.</span>editor   Enter editor mode
<span class="token punctuation">.</span>exit     Exit the REPL
<span class="token punctuation">.</span>help     Print this help message
<span class="token punctuation">.</span>load     Load JS from a file into the REPL session
<span class="token punctuation">.</span>save     Save all evaluated commands in this REPL session to a file</code></pre>
<p>can be extended.</p>
<p>With the REPL started via <code>cds repl</code> we also have CAP specific commands <code>.inspect</code> and <code>.run</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Welcome to cds repl v <span class="token number">8.5.1</span>
<span class="token operator">></span> <span class="token punctuation">.</span>help
<span class="token punctuation">.</span>break     Sometimes you get stuck<span class="token punctuation">,</span> this gets you out
<span class="token punctuation">.</span>clear     Alias for <span class="token punctuation">.</span>break
<span class="token punctuation">.</span>editor    Enter editor mode
<span class="token punctuation">.</span>exit      Exit the REPL
<span class="token punctuation">.</span>help      Print this help message
<span class="token punctuation">.</span>inspect   Sets options for util<span class="token punctuation">.</span>inspect<span class="token punctuation">,</span> e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> `<span class="token punctuation">.</span>inspect <span class="token punctuation">.</span>depth<span class="token operator">=</span><span class="token number">1</span>`<span class="token punctuation">.</span>
<span class="token punctuation">.</span>load      Load JS from a file into the REPL session
<span class="token punctuation">.</span>run       Runs a cds server from a given CAP project folder<span class="token punctuation">,</span> or module name like <span class="token operator">@</span>capire<span class="token operator">/</span>bookshop<span class="token punctuation">.</span>
<span class="token punctuation">.</span>save      Save all evaluated commands in this REPL session to a file</code></pre>
<p>We'll come back to <code>.inspect</code> and <code>.run</code> <a href="#more-on-the-repl">later</a>.</p>
<p><a name="lazy-loading-of-the-cds-facades-many-features"></a></p>
<h2 id="lazy-loading-of-the-cds-facades-many-features">Lazy loading of the cds facade's many features</h2>
<p>In highlighting that the <code>cds</code> object is also available in the REPL, Daniel takes the opportunity to show how the <code>cds</code> object -- as a front-door facade to everything in the runtime that you might need -- is implemented (in <code>@sap/cds/lib/index.js</code>). Not only are <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/super">super</a> getters involved, but also the general &quot;lazy loading&quot; effect of those getters is used to great effect - a more rapid startup of the server.</p>
<p>Here's a <a href="https://asciinema.org/a/694256">basic example</a> of that lazy loading, based on a simple object definition that looks like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> thing <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Life"</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"in getter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span> </code></pre>
<p>In the illustration below, look at the results of each of the REPL's eager evaluations (the values that the REPL shows even before you press Enter):</p>
<ul>
<li>the object itself is shown as <code>{ name: 'Life', number: [Getter]}</code></li>
<li>the value of the <code>name</code> property is immediately available (<code>Life</code>)</li>
<li>the value of <code>number</code> is not yet available (we are just shown <code>[Getter]</code>)</li>
<li><code>number</code>'s value is only resolved when explicitly requested - only then does it cause the function to be executed</li>
</ul>
<p><img src="/images/2024/12/lazy-loading-with-getter.gif" alt="lazy loading with getter"></p>
<p>As the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">MDN docu for <code>get</code> states</a>: &quot;The get syntax binds an object property to a function <em>that will be called when that property is looked up</em>. It can also be used in classes&quot; (emphasis mine).</p>
<p>I mentioned in passing this was like a <a href="https://en.wikipedia.org/wiki/Thunk">thunk</a>, which is similar, in that it is a mechanism &quot;primarily used to delay a calculation until its result is needed&quot;, the concept of which goes back to ALGOL 60.</p>
<p><a name="more-on-the-repl"></a></p>
<h2 id="more-on-the-repl">More on the REPL</h2>
<p>Daniel demonstrated the getter-powered lazy loading effect with the <code>cds</code> object, by requesting the <code>env</code> property, which is lazily defined in <code>@sap/cds/lib/index.js</code><a href="#footnote-2"><sup>2</sup></a> like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">get</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>env <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./env/cds-env'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'cds'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<p>This caused the inspected <code>cds</code> object to &quot;grow&quot; with the just-evaluated <code>env</code> property.</p>
<p><a name="the-inspect-command"></a></p>
<h3 id="the-inspect-command">The .inspect command</h3>
<p>And at <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=1892">31:32</a> this is where the <code>cds repl</code>'s <code>.inspect</code> command comes in, as it allows you to limit the depth to which nested objects will be displayed. Incidentally, if you take a look at the source code for the <code>.inspect</code> command, you'll see a strong FP influence with the use of <a href="https://qmacro.org/blog/posts/2015/10/19/my-journey-to-clojure/">head and tail</a>, the yin-yang pair of building blocks of <a href="https://qmacro.org/blog/posts/2017/02/19/the-beauty-of-recursion-and-list-machinery/">recursion and list machinery</a>. And while you're looking at that source code (in <code>@sap/cds-dk/bin/repl.js</code>), note that the default inspect depth ... is also a <a href="/blog/posts/2024/11/22/tasc-notes-part-2/">Schnapszahl</a>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">inspect<span class="token punctuation">.</span>defaultOptions<span class="token punctuation">.</span>depth <span class="token operator">=</span> <span class="token number">11</span></code></pre>
<p><a name="the-run-command"></a></p>
<h3 id="the-run-command">The .run command</h3>
<p>A minute later at <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=1952">32:32</a> Daniel then moved on to demonstrate the other additional command, <code>.run</code>, which uses <code>cds.test()</code> behind the scenes. It is &quot;cap-monorepo-aware&quot; in that one can reference services in subdirectories, like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">.</span>run cap<span class="token operator">/</span>samples<span class="token operator">/</span>bookshop</code></pre>
<p>and this will start a CAP server up pretty much in the same way as we're used to with <code>cds watch</code> for example.</p>
<blockquote>
<p>If you want to follow along with this exploration, see the <a href="#appendix1">Appendix - setting up a test environment</a>.</p>
</blockquote>
<p><a name="repl-global-values"></a>
What's more, though, is that it will also automatically expose REPL-global values representing important aspects of your service and the services upon which it relies:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token property">from cds.entities:</span> <span class="token operator">{</span>
    Books<span class="token punctuation">,</span>
    Authors<span class="token punctuation">,</span>
    Genres<span class="token punctuation">,</span>
<span class="token operator">}</span>
<span class="token property">from cds.services:</span> <span class="token operator">{</span>
    db<span class="token punctuation">,</span>
    AdminService<span class="token punctuation">,</span>
    CatalogService<span class="token punctuation">,</span>
    UserService<span class="token punctuation">,</span>
<span class="token operator">}</span>

Simply type e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Books or db in the prompt to use the respective objects<span class="token punctuation">.</span></code></pre>
<p>These values can be combined, as Daniel showed, like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> CatalogService<span class="token punctuation">.</span>read<span class="token operator">(</span>Books<span class="token operator">)</span>
Query <span class="token operator">{</span>
  <span class="token property">SELECT:</span> <span class="token operator">{</span> from<span class="token operator">:</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'sap.capire.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>This example produces a query, which is a first class citizen (taking direction again from FP, just in this case we're dealing with queries, not functions) that can be stored:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> q <span class="token operator">=</span> CatalogService<span class="token punctuation">.</span>read<span class="token operator">(</span>Books<span class="token operator">)</span>
Query <span class="token operator">{</span>
  <span class="token property">SELECT:</span> <span class="token operator">{</span> from<span class="token operator">:</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'sap.capire.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>modified:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> q<span class="token punctuation">.</span>where<span class="token operator">(</span><span class="token operator">{</span>ID<span class="token operator">:</span><span class="token number">201</span><span class="token operator">}</span><span class="token operator">)</span>
Query <span class="token operator">{</span>
  <span class="token property">SELECT:</span> <span class="token operator">{</span>
    <span class="token property">from:</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'sap.capire.bookshop.Books'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
    <span class="token property">where:</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ref<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'ID'</span> <span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token operator">{</span> val<span class="token operator">:</span> <span class="token number">201</span> <span class="token operator">}</span> <span class="token punctuation">]</span>
  <span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p><a name="await"></a>
and (eventually) executed, via <code>await</code>, which executes <code>cds.run</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await q
<span class="token punctuation">[</span>
  <span class="token operator">{</span>
    <span class="token property">createdAt:</span> <span class="token string">'2024-12-10T17:26:39.236Z'</span><span class="token punctuation">,</span>
    <span class="token property">createdBy:</span> <span class="token string">'anonymous'</span><span class="token punctuation">,</span>
    <span class="token property">modifiedAt:</span> <span class="token string">'2024-12-10T17:26:39.236Z'</span><span class="token punctuation">,</span>
    <span class="token property">modifiedBy:</span> <span class="token string">'anonymous'</span><span class="token punctuation">,</span>
    <span class="token property">ID:</span> <span class="token number">201</span><span class="token punctuation">,</span>
    <span class="token property">title:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span>
    <span class="token property">descr:</span> `Wuthering Heights<span class="token punctuation">,</span> Emily Brontë's only novel<span class="token punctuation">,</span> was published in <span class="token number">1847</span> under the pseudonym <span class="token string">"Ellis Bell"</span><span class="token punctuation">.</span> It was written between October <span class="token number">1845</span> and June <span class="token number">1846</span><span class="token punctuation">.</span> Wuthering Heights and Anne Brontë's Agnes Grey were accepted by publisher Thomas Newby before the success of their sister Charlotte's novel Jane Eyre<span class="token punctuation">.</span> After Emily's death<span class="token punctuation">,</span> Charlotte edited the manuscript of Wuthering Heights and arranged for the edited version to be published as a posthumous second edition in <span class="token number">1850</span><span class="token punctuation">.</span>`<span class="token punctuation">,</span>
    <span class="token property">author_ID:</span> <span class="token number">101</span><span class="token punctuation">,</span>
    <span class="token property">genre_ID:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token property">stock:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">price:</span> <span class="token number">11.11</span><span class="token punctuation">,</span>
    <span class="token property">currency_code:</span> <span class="token string">'GBP'</span>
  <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p>But - <code>await q</code> - how did that even work?! Perhaps a topic for another post? Let me know.</p>
<p><a name="interacting-with-the-database-service"></a></p>
<h3 id="interacting-with-the-database-service">Interacting with the database service</h3>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=2230">37:10</a>, going back to the &quot;everything is a service&quot; axiom, Daniel demonstrated that the database connection is indeed a service, and can be extended and manipulated just like any other service, as discussed before. How? Well, for example, by injecting a handler, like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">cds<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span></code></pre>
<p>This is very similar to the example in the <a href="#everything-is-a-service">earlier part of this post</a>; what's interesting here is the use of the raw reference to <code>console.log</code>. Why does that work, and why is it interesting?</p>
<p>Well, it's interesting because it is another neat example of how JavaScript elevates functions to the same level as other values, values that can be stored and even passed as arguments into, or received as output from, other functions. It works because what's expected in this parameter position to a <code>before</code> call is indeed a function; the previous example looks like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">cds<span class="token punctuation">.</span>db <span class="token punctuation">.</span><span class="token function">before</span> <span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>event<span class="token punctuation">,</span> req<span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>and the actual call to <code>console.log</code> was inside the body of a lambda<a href="#footnote-1"><sup>1</sup></a>, an anonymous function definition, defined here using the ES6 fat arrow syntax<a href="#footnote-3"><sup>3</sup></a>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token parameter">req</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>event<span class="token punctuation">,</span> req<span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">}</span></code></pre>
<p>Same type of value - a function.</p>
<p>As a brief aside, note that the first example here was <code>cds.db.before()</code>, typed manually and in a hurry into the REPL, which differs from <code>cds.db .before()</code> <a href="#everything-is-a-service">in the example from the documentation shown earlier</a> only in syntatic (or is that perhaps &quot;literate&quot;?) whitespace that Daniel likes to sprinkle on his code to make it read more like a human language. Different again is this: <code>db.before()</code>, possible because of the <a href="#repl-global-values">REPL-global</a> names set up by the <code>.run</code> command we saw earlier.</p>
<p><a name="the-core-of-the-cap-framework"></a></p>
<h2 id="the-core-of-the-cap-framework">The core of the CAP framework</h2>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=2318">38:38</a> Daniel use <code>.inspect</code> to look at the handlers - the <em>event</em> handlers - for the <code>db</code> service:</p>
<p><img src="/images/2024/12/db-handlers.png" alt="db event handlers"></p>
<p>which show the logging function just registered, plus framework handlers for standard persistence layer operations.</p>
<p>This then led to the uncovering of the effective core of the framework, in <code>@sap/cds/lib/srv.Service.js</code> (which I'm sure some of you may recognise, having debugged through this when working with our own handlers and when &amp; how they're called):</p>
<p><img src="/images/2024/12/framework-core.png" alt="framework core"></p>
<p><a name="back-to-the-future"></a></p>
<h2 id="back-to-the-future">Back to the future</h2>
<p>Shortly after this, around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=2655">44:15</a>, Daniel switches to Capire's <a href="https://cap.cloud.sap/docs/about/#what-is-cap">What is CAP?</a> section and points out the anonymous quote:</p>
<blockquote>
<p>&quot;CAP is like ABAP for the non-ABAP world&quot;</p>
</blockquote>
<p>which causes both Daniel and me to reminisce and indulge in a bit of (well deserved) heavy praise for ABAP and the supporting cast of components and infrastructure, which of course includes:</p>
<ul>
<li>the <a href="/blog/posts/2003/11/13/food-for-thought-ldbs-and-abap-objects/">logical databases and corresponding database read programs</a> that formed the framework and support for the early versions of ABAP as a report writing language (<code>GET KNA1</code> anyone?) in R/2</li>
<li>the architecture of R/3's disp+work process tree with the different work process role types<a href="#footnote-4"><sup>4</sup></a> (including the &quot;Verbucher&quot;, or &quot;Update Task&quot;), and also how things were structured inside each work process (with the TSKH task handler, DYNP dynpro processor and ABAP language processor)</li>
</ul>
<p>More philosophising brought us on to the topic of low-code computing, where Daniel mentioned that he'd heard someone claim that the best end-user development tool ... was Excel (which, incidentally, I would posit as a predominantly <em>event oriented</em> programming platform too). Talking of Excel, if you are a fan of the annual December programming competition <a href="https://adventofcode.com">Advent of Code</a>, then you might want to check out some of the solutions ... <a href="https://www.youtube.com/playlist?list=PLsLuABDrJ7ME3vJEOCwGZ97__ZlHFgHvp">written in Excel</a>!</p>
<p><a name="the-magic-is-that-there-is-no-magic"></a></p>
<h2 id="the-magic-is-that-there-is-no-magic">The magic is that there is no magic</h2>
<p>At around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=2865">47:50</a> Daniel demonstrates another example of how the REPL allows us to explore CAP as close to the inside of the framework as we can, and improve our understanding of how it really ticks. And, as Daniel said, &quot;fasten your seatbelts!&quot;. Here's what happened<a href="#footnote-2"><sup>2</sup></a>.</p>
<p>First, Daniel created a service<a href="#footnote-5"><sup>5</sup></a>, following the <a href="https://creators.spotify.com/pod/show/tech-aloud/episodes/The-Simplest-Thing-that-Could-Possibly-Work--A-conversation-with-Ward-Cunningham--Part-V---Bill-Venners-e5dpts">simplest thing that could possibly work</a> approach, i.e. what was produced was &quot;just an event handler registry&quot;:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> <span class="token operator">(</span>srv <span class="token operator">=</span> new cds<span class="token punctuation">.</span>Service<span class="token operator">)</span>
Service <span class="token operator">{</span>
  <span class="token property">_handlers:</span> <span class="token operator">{</span> _initial<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> before<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> after<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _error<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">name:</span> <span class="token string">'Service'</span><span class="token punctuation">,</span>
  <span class="token property">options:</span> <span class="token operator">{</span><span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>Then, he sent a simple request initially synchronously, receiving a Promise:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> srv<span class="token punctuation">.</span>send<span class="token operator">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token operator">{</span>bar<span class="token operator">:</span><span class="token number">11</span><span class="token operator">}</span><span class="token operator">)</span>
Promise <span class="token operator">{</span>
  <span class="token operator">&lt;</span>pending<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token operator">(</span>async_id_symbol<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">53</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token operator">(</span>trigger_async_id_symbol<span class="token operator">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">6</span>
<span class="token operator">}</span></code></pre>
<p>To have such a Promise resolved, Daniel then of course did the same thing but in the context of an <code>await</code>, and got ... nothing (well, technically, just no output):</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await srv<span class="token punctuation">.</span>send<span class="token operator">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token operator">{</span>bar<span class="token operator">:</span><span class="token number">11</span><span class="token operator">}</span><span class="token operator">)</span>
<span class="token operator">></span></code></pre>
<p>Why? Because the server doesn't have a handler for the <code>foo</code> event that is being sent.</p>
<p>So he defines one:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> srv<span class="token punctuation">.</span>on<span class="token operator">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token operator">)</span>
Service <span class="token operator">{</span>
  <span class="token property">_handlers:</span> <span class="token operator">{</span>
    <span class="token property">_initial:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">before:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">on:</span> <span class="token punctuation">[</span> EventHandler <span class="token operator">{</span> on<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> log<span class="token punctuation">]</span> <span class="token operator">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">after:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">_error:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token property">name:</span> <span class="token string">'Service'</span><span class="token punctuation">,</span>
  <span class="token property">options:</span> <span class="token operator">{</span><span class="token operator">}</span>
<span class="token operator">}</span></code></pre>
<p>Looking at what is emitted as output from this call to <code>srv.on</code> here, note how this event handler is indeed registered (this is the &quot;event registry&quot; after all) in the <code>on</code> property. Note also that the same simple technique as earlier is being used here for simplicity: a reference to the function <code>console.log</code> as the argument to the handler parameter.</p>
<p>Making the call again now causes that registered handler to be invoked:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">></span> await srv<span class="token punctuation">.</span>send<span class="token operator">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token operator">{</span>bar<span class="token operator">:</span><span class="token number">11</span><span class="token operator">}</span><span class="token operator">)</span>
Request <span class="token operator">{</span> method<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token operator">{</span> bar<span class="token operator">:</span> <span class="token number">11</span> <span class="token operator">}</span> <span class="token operator">}</span> <span class="token punctuation">[</span>AsyncFunction<span class="token operator">:</span> next<span class="token punctuation">]</span>
<span class="token operator">></span></code></pre>
<p>This <code>Request</code> is essentially -- and actually -- an <em>event message</em>!</p>
<p>But perhaps the biggest takeaway from this REPL demo is that what Daniel, Capire and the team is saying about CAP being all about events and services, uniform and abstract, is not only true, but also free of any real complexity underneath. The basic mechanism of the framework is simple and straightforward. There's no magic, it's just events, registries and handlers <a href="https://en.wikipedia.org/wiki/Turtles_all_the_way_down">all the way down</a>.</p>
<p><a name="tight-loops-design-time-affordances-and-service-integration"></a></p>
<h2 id="tight-loops-design-time-affordances-and-service-integration">Tight loops, design time affordances and service integration</h2>
<p>Some of CAP's driving principles -- with developers in focus -- are described in Capire's <a href="https://cap.cloud.sap/docs/about/#jumpstart-grow-as-you-go">Jumpstart &amp; Grow As You Go...</a> section. The nirvana of a fast inner development loop is achieved through various design time affordances, one of which Daniel demonstrated at around <a href="https://www.youtube.com/live/kwxvyiC-6FI?t=2955">49:15</a>: the automatic mocking of external services when required.</p>
<p>Using the <a href="/blog/posts/2024/11/29/tasc-notes-part-3/#cloudcapsamples">cloud-cap-samples</a> repo again, Daniel started the &quot;Bookstore&quot; (with <code>cds w bookstore</code>) and the CAP server output included these lines:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect using bindings from<span class="token operator">:</span> <span class="token operator">{</span> registry<span class="token operator">:</span> '<span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>cds<span class="token operator">-</span>services<span class="token punctuation">.</span>json <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to db <span class="token operator">></span> sqlite <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">':memory:'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to messaging <span class="token operator">></span> file<span class="token operator">-</span>based<span class="token operator">-</span>messaging
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using new OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> mocking ReviewsService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'reviews/srv/reviews-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/reviews'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> mocking OrdersService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'orders/srv/orders-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/odata/v4/orders'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving CatalogService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/cat-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/browse'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving AdminService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/admin-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/admin'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving UserService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/user-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/user'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving DataService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'data-viewer/srv/data-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/odata/v4/-data'</span> <span class="token operator">}</span></code></pre>
<p>The &quot;Bookstore&quot; app uses the &quot;Reviews&quot; Service as shown in the diagram:</p>
<p><img src="https://raw.githubusercontent.com/SAP-samples/cloud-cap-samples/main/etc/samples.drawio.svg" alt="samples"></p>
<p>and as defined in <a href="https://github.com/SAP-samples/cloud-cap-samples/blob/1ea4b15d77229b238f622f9e38c8b31244d5fa04/bookstore/srv/mashup.cds#L12"><code>cloud-cap-samples/bookstore/srv/mashup.cds</code></a>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token using keyword">using</span> { ReviewsService.Reviews } <span class="token from keyword">from</span> '@capire/reviews';</code></pre>
<p>And because at this point the &quot;Reviews&quot; service isn't running, and (more importantly) there isn't a service binding for any such remote service, the CAP server will automatically mock it.</p>
<p>What gives us a glimpse under the hood of this mechanism is when Daniel actually <em>starts</em> the &quot;Reviews&quot; service too, in a separate window, with <code>cds w reviews</code>, whereupon we see these lines in that second CAP server's output:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving ReviewsService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'reviews/srv/reviews-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/reviews'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4005'</span> <span class="token operator">}</span></code></pre>
<p>But more importantly, we can see that when the &quot;Bookstore&quot; is restarted, the &quot;Reviews&quot; service is no longer mocked, because now a service binding for it was found, in the context of Daniel's development environment.</p>
<p>The result is that instead of this line appearing in the &quot;Bookstore&quot; CAP server log output:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> mocking ReviewsService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'reviews/srv/reviews-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/reviews'</span> <span class="token operator">}</span></code></pre>
<p>what we get now is this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to ReviewsService <span class="token operator">></span> odata <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4005/reviews'</span> <span class="token operator">}</span></code></pre>
<p>How does this design time binding machinery management work? Well, it's based on a developer-local configuration file that the CAP server(s) share. And if we look carefully at the original log output from the &quot;Bookstore&quot; CAP server, we see this line, which tells us what that file is called and where it is:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect using bindings from<span class="token operator">:</span> <span class="token operator">{</span> registry<span class="token operator">:</span> '<span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>cds<span class="token operator">-</span>services<span class="token punctuation">.</span>json <span class="token operator">}</span></code></pre>
<p>When a CAP server starts up, in design time mode (e.g. via <code>cds watch</code>), it writes binding information for services that it <em>provides</em>, into this <code>~/.cds-services.json</code> file. And when a CAP server starts up and knows it needs a connection to a remote service, via a service binding, and is also in design time mode, it will look in this same file to see what is being provided already, and use that information if it exists.</p>
<p>Such a simple concept, beautifully executed.</p>
<p>If you're curious, this is the sort of information that is stored, for running CAP services in design time mode, in the <code>~/.cds-services.json</code> file:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"cds"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"provides"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"ReviewsService"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"odata"</span><span class="token punctuation">,</span>
        <span class="token property">"credentials"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:4005/reviews"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This section was written to <code>~/.cds-services.json</code> by the second CAP server where the &quot;Reviews&quot; services was started up. Note the <code>provides</code> property pointing to the CAP server URL<a href="#footnote-6"><sup>6</sup></a>. And it's read by the first CAP server looking for (design time) service binding information for that service.</p>
<h3 id="service-integration-codejam">Service integration CodeJam</h3>
<p>If you are looking to learn &quot;more than you ever wanted to know&quot; about service integration, including more details on this wonderful mechanism, you might want to organise or attend the <a href="https://github.com/SAP-samples/cap-service-integration-codejam/">Service Integration with CAP</a> CodeJam, or if you can't make an in-person event, you can still look through the entire CodeJam content, which is all available online.</p>
<p>That wraps it up for the notes on this part 4, I hope you enjoyed them, and see you online!</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<p><a name="footnote-1"></a></p>
<ol>
<li>This Ruby idiom is a form of metaprogramming, which was popularised with Lisp ... which brings us back to McCarthy. Moreover, as Sinclair Target mentioned in his great article <a href="https://twobithistory.org/2018/10/14/lisp.html">How Lisp Became God's Own Programming Language</a> (which is also <a href="https://creators.spotify.com/pod/show/tech-aloud/episodes/How-Lisp-Became-Gods-Own-Programming-Language---Sinclair-Target---14-Oct-2018-e2rip0q">available in audio format as an episode on my Tech Aloud podcast</a>), &quot;Ruby is also a Lisp&quot;, expounded upon by Eric Kidd in his post <a href="https://www.randomhacks.net/2005/12/03/why-ruby-is-an-acceptable-lisp/">Why Ruby is an acceptable LISP</a>.</li>
</ol>
<p>Eric's post incidentally also shows how functions can be first class citizens, and even goes on to give a great example of a closure - the accumulator function, which in turn is from the appendix of Paul Graham's <a href="https://www.paulgraham.com/icad.html">Revenge of the Nerds</a> post. Here's the original accumulator function definition (named <code>foo</code> here) in Lisp:</p>
<pre class="language-lisp" tabindex="0"><code class="language-lisp"><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">n</span></span><span class="token punctuation">)</span></span> <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">i</span></span><span class="token punctuation">)</span></span> <span class="token punctuation">(</span><span class="token car">incf</span> n i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>and here is how we might express it in JavaScript:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token parameter">n</span> <span class="token operator">=></span> <span class="token parameter">i</span> <span class="token operator">=></span> n <span class="token operator">+=</span> i</code></pre>
<p>Both implementations illustrate the concept of functions as first class citizens (the anonymous function <code>i =&gt; n += i</code> is returned as a value from a call to the named function <code>foo</code>) as well as the concept of a closure (<code>n</code> is &quot;closed over&quot;, and therefore &quot;captured&quot;, in the construct, and lives on inside that anonymous function). Here's a Node.js REPL session showing an example of use:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Welcome to Node<span class="token punctuation">.</span>js <span class="token number">v22.6.0</span><span class="token punctuation">.</span>
Type <span class="token string">".help"</span> for more information<span class="token punctuation">.</span>
<span class="token operator">></span> foo <span class="token operator">=</span> n <span class="token operator">=</span><span class="token operator">></span> i <span class="token operator">=</span><span class="token operator">></span> n <span class="token operator">+</span><span class="token operator">=</span> i
<span class="token punctuation">[</span>Function<span class="token operator">:</span> foo<span class="token punctuation">]</span>
<span class="token operator">></span> mysum <span class="token operator">=</span> foo<span class="token operator">(</span><span class="token number">10</span><span class="token operator">)</span>
<span class="token punctuation">[</span>Function <span class="token operator">(</span>anonymous<span class="token operator">)</span><span class="token punctuation">]</span>
<span class="token operator">></span> mysum<span class="token operator">(</span><span class="token number">2</span><span class="token operator">)</span>
<span class="token number">12</span>
<span class="token operator">></span> mysum<span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span>
<span class="token number">15</span>
<span class="token operator">></span></code></pre>
<p>Note also that the word &quot;lambda&quot;, used here specifically and syntactically in Lisp as the symbol for an anonymous function, has become the de facto term for anonymous functions in general - for example, Python <a href="https://discuss.python.org/t/what-is-the-purpose-of-lambda-expressions/12415">uses the term</a>, and AWS has a Functions-as-a-Service (FaaS) offering called <a href="https://aws.amazon.com/lambda/">Lambda</a>.</p>
<p>For an indication of how fundamental the concept of first class functions is (along with the closely related &quot;higher order&quot; function style), see <a href="/blog/posts/2024/12/16/functions-as-first-class-citizens-in-sicp-lecture-1a/">Functions as first class citizens in SICP Lecture 1A</a>.</p>
<p><a name="footnote-2"></a>
2. Examples in this post are based on CAP Node.js version 8.5.1 (Nov 2024) rather than the 8.6.0 version that Daniel had, which is currently not available externally at the time of writing.</p>
<p><a name="footnote-3"></a>
3. Properly called <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">Arrow function expressions</a>.</p>
<p><a name="footnote-4"></a>
4. <code>DVEBMGS00</code> anyone? (The <code>V</code> here is for &quot;Verbucher&quot; of course) :-)</p>
<p><a name="footnote-5"></a>
5. I suspect that the only reason <code>srv = new cds.Service</code> was wrapped in parentheses here was because Daniel had originally intended to immediately send something to the newly created server (but still capture a reference to that server), i.e. like this: <code>(srv = new cds.Service).send('foo',{bar:11})</code> but had then decided to break it down into individual steps.</p>
<p><a name="footnote-6"></a>
6. No further credential information exists here, as it's a design time only service running locally.</p>
<hr>
<p><a name="appendix1"></a></p>
<h2 id="appendix-setting-up-a-test-environment">Appendix - setting up a test environment</h2>
<p>If you want to set up a test environment exactly like the one used for this post, specifically the REPL illustrations, then you can. I do most things in containers, and I have different container images representing CAP Node.js at different versions. For the illustration in this blog post I am using CDS 8.5.1 with Node.js major version 22.</p>
<p>First, download the CAP image builder, build the base image and an 8.5.1 specific version:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">git</span> clone https://github.com/qmacro/cap-con-img <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cap-con-img
./buildbase <span class="token operator">&amp;&amp;</span> ./buildver <span class="token number">8.5</span>.1</code></pre>
<p>Now start up a temporary container based on that image:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> cap-8.5.1 <span class="token function">bash</span></code></pre>
<p>This will give you a Bash shell prompt:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">node</span> ➜ ~
$</code></pre>
<p>Now, in that shell, you can clone the <a href="/blog/posts/2024/11/29/tasc-notes-part-3/#cloudcapsamples">cloud-cap-samples</a> repo to enjoy the structured set of services:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">git</span> clone https://github.com/SAP-samples/cloud-cap-samples <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cloud-cap-samples</code></pre>
<p>After installing the dependencies:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">npm</span> <span class="token function">install</span></code></pre>
<p>you can start the REPL:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds repl</code></pre>
<p>which will give you the prompt you're looking for:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Welcome to cds repl v <span class="token number">8.5.1</span>
<span class="token operator">></span></code></pre>
<p>where you can start to experiment with:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">.run bookshop</code></pre>
<p>which will produce something like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded model from <span class="token number">5</span> file<span class="token operator">(</span>s<span class="token operator">)</span><span class="token operator">:</span>

  bookshop<span class="token operator">/</span>srv<span class="token operator">/</span>user<span class="token operator">-</span>service<span class="token punctuation">.</span>cds
  bookshop<span class="token operator">/</span>srv<span class="token operator">/</span>cat<span class="token operator">-</span>service<span class="token punctuation">.</span>cds
  bookshop<span class="token operator">/</span>srv<span class="token operator">/</span>admin<span class="token operator">-</span>service<span class="token punctuation">.</span>cds
  bookshop<span class="token operator">/</span>db<span class="token operator">/</span>schema<span class="token punctuation">.</span>cds
  node_modules<span class="token operator">/</span><span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">/</span>common<span class="token punctuation">.</span>cds

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to db <span class="token operator">></span> sqlite <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">':memory:'</span> <span class="token operator">}</span>
  <span class="token operator">></span> init from bookshop<span class="token operator">/</span>db<span class="token operator">/</span>init<span class="token punctuation">.</span>js
  <span class="token operator">></span> init from bookshop<span class="token operator">/</span>db<span class="token operator">/</span>data<span class="token operator">/</span>sap<span class="token punctuation">.</span>capire<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Genres<span class="token punctuation">.</span>csv
  <span class="token operator">></span> init from bookshop<span class="token operator">/</span>db<span class="token operator">/</span>data<span class="token operator">/</span>sap<span class="token punctuation">.</span>capire<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Books<span class="token punctuation">.</span>texts<span class="token punctuation">.</span>csv
  <span class="token operator">></span> init from bookshop<span class="token operator">/</span>db<span class="token operator">/</span>data<span class="token operator">/</span>sap<span class="token punctuation">.</span>capire<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Books<span class="token punctuation">.</span>csv
  <span class="token operator">></span> init from bookshop<span class="token operator">/</span>db<span class="token operator">/</span>data<span class="token operator">/</span>sap<span class="token punctuation">.</span>capire<span class="token punctuation">.</span>bookshop<span class="token operator">-</span>Authors<span class="token punctuation">.</span>csv
<span class="token operator">/</span><span class="token operator">></span> successfully deployed to in<span class="token operator">-</span>memory database<span class="token punctuation">.</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using auth strategy <span class="token operator">{</span>
  <span class="token property">kind:</span> <span class="token string">'mocked'</span><span class="token punctuation">,</span>
  <span class="token property">impl:</span> <span class="token string">'node_modules/@sap/cds/lib/srv/middlewares/auth/basic-auth'</span>
<span class="token operator">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using new OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving AdminService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/admin-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/admin'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving CatalogService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/cat-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/browse'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving UserService <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'bookshop/srv/user-service.js'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/user'</span> <span class="token operator">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:46025'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> launched at <span class="token date number">12/10/2024</span><span class="token punctuation">,</span> <span class="token time number">5:26:38</span> PM<span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token number">8.5.0</span><span class="token punctuation">,</span> in<span class="token operator">:</span> <span class="token number">887.147ms</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> terminate with <span class="token operator">^</span>C <span class="token punctuation">]</span>

<span class="token separator comment">------------------------------------------------------------</span>
<span class="token property">Following are made available as repl globals:</span>

<span class="token property">from cds.entities:</span> <span class="token operator">{</span>
  Books<span class="token punctuation">,</span>
  Authors<span class="token punctuation">,</span>
  Genres<span class="token punctuation">,</span>
<span class="token operator">}</span>
<span class="token property">from cds.services:</span> <span class="token operator">{</span>
  db<span class="token punctuation">,</span>
  AdminService<span class="token punctuation">,</span>
  CatalogService<span class="token punctuation">,</span>
  UserService<span class="token punctuation">,</span>
<span class="token operator">}</span>

Simply type e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Books or db in the prompt to use the respective objects<span class="token punctuation">.</span>

<span class="token operator">></span></code></pre>
<p>whereupon you're ready to explore as we do in this post.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/12/09/the-elements-of-programming-with-respect-to-cdl-and-sicp/">The elements of programming with respect to CDL and SICP</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/12/13/tasc-notes-part-5/">TASC Notes - Part 5</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/12/10/tasc-notes-part-4/` was built on 2025-09-17T15:42:08.296Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
