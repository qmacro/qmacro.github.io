<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>CAP, CDS, CDL, CSN and jq - finding associations</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="cap-cds-cdl-csn-and-jq-finding-associations">CAP, CDS, CDL, CSN and jq - finding associations</h1>

<ul class="post-metadata">
	<li><time datetime="2024-04-05">05 April 2024</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/jq/" class="post-tag">jq</a></li>
</ul>

<p class="post-description-main"></p>

<p>In CAP, relationships between entities can be expressed with associations. In digging into how these are represented internally, I found jq yet again to be invaluable in parsing out info from the internal representation of the definitions. Here's what I did.</p>
<p>In <a href="https://cap.cloud.sap">CAP</a>, SAP's Cloud Application Programming Model, <a href="https://cap.cloud.sap/docs/guides/domain-modeling">models are defined</a> declaratively in a human readable format known as CDL, which stands for Core Definition Language<a href="#footnotes"><sup>1</sup></a>.</p>
<h2 id="cdl-example">CDL example</h2>
<p>Here's a simple example, in a file called <code>services.cds</code> taken from the current <a href="https://www.youtube.com/playlist?list=PL6RpkC85SLQBHPdfHQ0Ry2TMdsT-muECx">Hands-on SAP Dev live stream series on back to basics with CAP Node.js</a>:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">aspect</span> cuid { <span class="token cqlkeywords keyword">key</span> ID: <span class="token type builtin">UUID </span>}

<span class="token keyword">service</span> bookshop {
  <span class="token keyword">entity</span> Books : cuid {
    title: <span class="token type builtin">String</span>;
    author: <span class="token association-composition keyword">Association to Authors</span>;
  }
  <span class="token keyword">entity</span> Authors : cuid {
    name: <span class="token type builtin">String</span>;
    books: <span class="token association-composition keyword">Association to many Books</span> <span class="token cqlkeywords keyword">on</span> books.author = $self;
  }
}</code></pre>
<blockquote>
<p>Yes, there's a <code>cuid</code> aspect in <code>@sap/cds/common</code> but I didn't want the entire contents of that package being expressed in the output that follows, as it would make it more difficult to see the essential parts in this short example.</p>
</blockquote>
<p>There's a &quot;to-one&quot; relationship between <code>Books</code> and <code>Authors</code>, and a &quot;to-many&quot; relationship in the back link beween <code>Authors</code> and <code>Books</code>.</p>
<blockquote>
<p>For those non-CAP folks wondering where the foreign key field is in the first relationship, it's constructed automatically as the <code>Books:author</code> association is a <a href="https://cap.cloud.sap/docs/guides/domain-modeling#managed-1-associations">managed</a> one.</p>
</blockquote>
<h2 id="csn-equivalent">CSN equivalent</h2>
<p>There's an internal JSON-based representation of such definitions, which lends itself more readily to machine processing. This representation is called <a href="https://cap.cloud.sap/docs/cds/csn">Core Schema Notation</a>, or CSN. We can see the CSN for the CDL source above, like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds compile <span class="token parameter variable">--to</span> csn services.cds</code></pre>
<blockquote>
<p>The default target format is in fact <code>csn</code> so <code>--to csn</code> is unnecessary, but it's nice to express it explicitly here.</p>
</blockquote>
<p>What we get is this:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"definitions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"cuid"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"aspect"</span><span class="token punctuation">,</span>
      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"bookshop"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"service"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"bookshop.Books"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"entity"</span><span class="token punctuation">,</span>
      <span class="token property">"includes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"cuid"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.String"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span>
          <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Authors"</span><span class="token punctuation">,</span>
          <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ID"</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"bookshop.Authors"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"entity"</span><span class="token punctuation">,</span>
      <span class="token property">"includes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"cuid"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.String"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"books"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span>
          <span class="token property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"max"</span><span class="token operator">:</span> <span class="token string">"*"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Books"</span><span class="token punctuation">,</span>
          <span class="token property">"on"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"books"</span><span class="token punctuation">,</span>
                <span class="token string">"author"</span><span class="token punctuation">,</span>
                <span class="token string">"ID"</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"="</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ID"</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"meta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"creator"</span><span class="token operator">:</span> <span class="token string">"CDS Compiler v4.6.2"</span><span class="token punctuation">,</span>
    <span class="token property">"flavor"</span><span class="token operator">:</span> <span class="token string">"inferred"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"$version"</span><span class="token operator">:</span> <span class="token string">"2.0"</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="picking-out-detail-with-jq">Picking out detail with jq</h2>
<p>I'm just interested to see how the associations are represented, so wanted to narrow this CSN down to just elements that are of type <code>cds.Association</code>. Being a relatively involved JSON dataset, this was a job for one of my favourite languages, jq.</p>
<p>Here's what I came up with, in a file called <code>associations</code>:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token comment">#!/usr/bin/env -S jq -f</span>

<span class="token comment"># Lists entities and shows any elements that are associations</span>

<span class="token keyword">def</span> <span class="token function">is_entity</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>value<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">"entity"</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> <span class="token function">is_association</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"cds.Association"</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span>definitions
<span class="token operator pipe">|</span> to_entries
<span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span>
    <span class="token c-style-function function">select</span><span class="token punctuation">(</span>is_entity<span class="token punctuation">)</span>
    <span class="token operator pipe">|</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span>value<span class="token punctuation">.</span>elements
        <span class="token operator pipe">|</span> <span class="token c-style-function function">with_entries</span><span class="token punctuation">(</span><span class="token c-style-function function">select</span><span class="token punctuation">(</span>is_association<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span></code></pre>
<p>And here's how I use it:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds compile <span class="token parameter variable">--to</span> csn services.cds <span class="token operator">|</span> ./associations</code></pre>
<p>The output is:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"bookshop.Books"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span>
        <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Authors"</span><span class="token punctuation">,</span>
        <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"ID"</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"bookshop.Authors"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"books"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span>
        <span class="token property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"max"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Books"</span><span class="token punctuation">,</span>
        <span class="token property">"on"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"books"</span><span class="token punctuation">,</span>
              <span class="token string">"author"</span><span class="token punctuation">,</span>
              <span class="token string">"ID"</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"="</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"ID"</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Here are some notes:</p>
<ul>
<li>I encapsulated the kind / type determination in helper predicate functions (<code>is_entity</code> and <code>is_association</code>), mostly to keep the main code more succinct</li>
<li>I love how the <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">to_entries,from_entries,with_entries(f)</a> family of functions<a href="#footnotes"><sup>2</sup></a> help out by normalising JSON objects that have dynamic values for property keys</li>
<li>By using the <code>select(is_entity)</code> in the context of such normalisation, I can easily pick out the &quot;enclosing&quot; object that contains the condition I'm looking for</li>
<li>In contrast to the use of <code>to_entries</code> at the outer (entity) level, I used <code>with_entries</code> to achieve the <code>to_entries | map(...) | from_entries</code> pattern that is so useful</li>
</ul>
<p>And that's about it! Score one more for the wonderful utility of jq, in today's world of JSON.</p>
<h2 id="alternative-approach">Alternative approach</h2>
<p>While I like the <code>is_entity</code> and <code>is_association</code> definitions, one could make the main code even more succinct like this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">entities</span><span class="token punctuation">:</span> <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">"entity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">def</span> <span class="token function">associations</span><span class="token punctuation">:</span> <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"cds.Association"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span>definitions
<span class="token operator pipe">|</span> to_entries
<span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span>
    entities
    <span class="token operator pipe">|</span> <span class="token punctuation">{</span>
       <span class="token punctuation">(</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token punctuation">.</span>value<span class="token punctuation">.</span>elements <span class="token operator pipe">|</span> <span class="token c-style-function function">with_entries</span><span class="token punctuation">(</span>associations<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span></code></pre>
<p>Which do you prefer?</p>
<hr>
<p><a name="footnotes"></a>
<strong>Footnotes</strong></p>
<p>1: The human readable language we used to define models is commonly referred to as CDS. <a href="https://cap.cloud.sap/docs">Capire</a>, the CAP documentation resource, is more precise, calling it CDL, classing CDL, CSN and other CAP little languages such as CQL and CQN as all being under the general CDS umbrella term. As you can see from the bottom of the CSN output, even the compiler refers to it as CDS!</p>
<p>2: For more on this family of functions, see <a href="https://qmacro.org/blog/posts/2022/05/30/reshaping-data-values-using-jq's-with_entries/">Reshaping data values using jq's with_entries</a> and <a href="https://qmacro.org/blog/posts/2024/02/28/quick-conversion-of-multiple-values-using-with_entries-in-jq/">Quick conversion of multiple values using with_entries in jq</a>.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/03/30/cap-cors-and-custom-headers/">CAP, CORS and custom headers</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/04/10/avoid-design-time-cap-server-restarts-when-maintaining-local-data-files/">Avoid design time CAP server restarts when maintaining local data files</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/04/05/cap-cds-cdl-csn-and-jq-finding-associations/` was built on 2025-09-22T12:58:28.729Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
