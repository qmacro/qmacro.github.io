<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/04/05/cap-cds-cdl-csn-and-jq-finding-associations/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.aeeda7eadc5a91d84f2c.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>CAP, CDS, CDL, CSN and jq - finding associations | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="CAP, CDS, CDL, CSN and jq - finding associations"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/04/05/cap-cds-cdl-csn-and-jq-finding-associations/"><meta name="description" content="CAP, CDS, CDL, CSN and jq - finding associations 05 Apr 2024 | 3 min read In CAP, relationships between entities can be expressed with..."><meta property="og:description" content="CAP, CDS, CDL, CSN and jq - finding associations 05 Apr 2024 | 3 min read In CAP, relationships between entities can be expressed with..."><meta name="description" content="CAP, CDS, CDL, CSN and jq - finding associations 05 Apr 2024 | 3 min read In CAP, relationships between entities can be expressed with..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>CAP, CDS, CDL, CSN and jq - finding associations</h1><div class="post__details"><time datetime="2024-04-05">05 Apr 2024 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>In CAP, relationships between entities can be expressed with associations. In digging into how these are represented internally, I found jq yet again to be invaluable in parsing out info from the internal representation of the definitions. Here's what I did.</p><p>In <a href="https://cap.cloud.sap">CAP</a>, SAP's Cloud Application Programming Model, <a href="https://cap.cloud.sap/docs/guides/domain-modeling">models are defined</a> declaratively in a human readable format known as CDL, which stands for Core Definition Language<a href="#footnotes"><sup>1</sup></a>.</p><h2>CDL example</h2><p>Here's a simple example, in a file called <code>services.cds</code> taken from the current <a href="https://www.youtube.com/playlist?list=PL6RpkC85SLQBHPdfHQ0Ry2TMdsT-muECx">Hands-on SAP Dev live stream series on back to basics with CAP Node.js</a>:</p><pre class="language-text"><code class="language-text">aspect cuid { key ID: UUID }<br><br>service bookshop {<br>  entity Books : cuid {<br>    title: String;<br>    author: Association to Authors;<br>  }<br>  entity Authors : cuid {<br>    name: String;<br>    books: Association to many Books on books.author = $self;<br>  }<br>}</code></pre><blockquote><p>Yes, there's a <code>cuid</code> aspect in <code>@sap/cds/common</code> but I didn't want the entire contents of that package being expressed in the output that follows, as it would make it more difficult to see the essential parts in this short example.</p></blockquote><p>There's a &quot;to-one&quot; relationship between <code>Books</code> and <code>Authors</code>, and a &quot;to-many&quot; relationship in the back link beween <code>Authors</code> and <code>Books</code>.</p><blockquote><p>For those non-CAP folks wondering where the foreign key field is in the first relationship, it's constructed automatically as the <code>Books:author</code> association is a <a href="https://cap.cloud.sap/docs/guides/domain-modeling#managed-1-associations">managed</a> one.</p></blockquote><h2>CSN equivalent</h2><p>There's an internal JSON-based representation of such definitions, which lends itself more readily to machine processing. This representation is called <a href="https://cap.cloud.sap/docs/cds/csn">Core Schema Notation</a>, or CSN. We can see the CSN for the CDL source above, like this:</p><pre class="language-shell"><code class="language-shell">cds compile <span class="token parameter variable">--to</span> csn services.cds</code></pre><blockquote><p>The default target format is in fact <code>csn</code> so <code>--to csn</code> is unnecessary, but it's nice to express it explicitly here.</p></blockquote><p>What we get is this:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"definitions"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"cuid"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"aspect"</span><span class="token punctuation">,</span><br>      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token property">"bookshop"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"service"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token property">"bookshop.Books"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"entity"</span><span class="token punctuation">,</span><br>      <span class="token property">"includes"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token string">"cuid"</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.String"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span><br>          <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Authors"</span><span class="token punctuation">,</span><br>          <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>            <span class="token punctuation">{</span><br>              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"ID"</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token property">"bookshop.Authors"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"entity"</span><span class="token punctuation">,</span><br>      <span class="token property">"includes"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token string">"cuid"</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"key"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.UUID"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.String"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token property">"books"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span><br>          <span class="token property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token property">"max"</span><span class="token operator">:</span> <span class="token string">"*"</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Books"</span><span class="token punctuation">,</span><br>          <span class="token property">"on"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>            <span class="token punctuation">{</span><br>              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"books"</span><span class="token punctuation">,</span><br>                <span class="token string">"author"</span><span class="token punctuation">,</span><br>                <span class="token string">"ID"</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><span class="token punctuation">,</span><br>            <span class="token string">"="</span><span class="token punctuation">,</span><br>            <span class="token punctuation">{</span><br>              <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"ID"</span><br>              <span class="token punctuation">]</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"meta"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"creator"</span><span class="token operator">:</span> <span class="token string">"CDS Compiler v4.6.2"</span><span class="token punctuation">,</span><br>    <span class="token property">"flavor"</span><span class="token operator">:</span> <span class="token string">"inferred"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"$version"</span><span class="token operator">:</span> <span class="token string">"2.0"</span><br><span class="token punctuation">}</span></code></pre><h2>Picking out detail with jq</h2><p>I'm just interested to see how the associations are represented, so wanted to narrow this CSN down to just elements that are of type <code>cds.Association</code>. Being a relatively involved JSON dataset, this was a job for one of my favourite languages, jq.</p><p>Here's what I came up with, in a file called <code>associations</code>:</p><pre class="language-jq"><code class="language-jq"><span class="token comment">#!/usr/bin/env -S jq -f</span><br><br><span class="token comment"># Lists entities and shows any elements that are associations</span><br><br><span class="token keyword">def</span> <span class="token function">is_entity</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>value<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">"entity"</span><span class="token punctuation">;</span><br><span class="token keyword">def</span> <span class="token function">is_association</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"cds.Association"</span><span class="token punctuation">;</span><br><br><span class="token punctuation">.</span>definitions<br><span class="token operator pipe">|</span> to_entries<br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>    <span class="token c-style-function function">select</span><span class="token punctuation">(</span>is_entity<span class="token punctuation">)</span><br>    <span class="token operator pipe">|</span> <span class="token punctuation">{</span><br>        <span class="token punctuation">(</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token punctuation">.</span>value<span class="token punctuation">.</span>elements<br>        <span class="token operator pipe">|</span> <span class="token c-style-function function">with_entries</span><span class="token punctuation">(</span><span class="token c-style-function function">select</span><span class="token punctuation">(</span>is_association<span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span></code></pre><p>And here's how I use it:</p><pre class="language-shell"><code class="language-shell">cds compile <span class="token parameter variable">--to</span> csn services.cds <span class="token operator">|</span> ./associations</code></pre><p>The output is:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"bookshop.Books"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span><br>        <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Authors"</span><span class="token punctuation">,</span><br>        <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>              <span class="token string">"ID"</span><br>            <span class="token punctuation">]</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"bookshop.Authors"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"books"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"cds.Association"</span><span class="token punctuation">,</span><br>        <span class="token property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token property">"max"</span><span class="token operator">:</span> <span class="token string">"*"</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"bookshop.Books"</span><span class="token punctuation">,</span><br>        <span class="token property">"on"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>              <span class="token string">"books"</span><span class="token punctuation">,</span><br>              <span class="token string">"author"</span><span class="token punctuation">,</span><br>              <span class="token string">"ID"</span><br>            <span class="token punctuation">]</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token string">"="</span><span class="token punctuation">,</span><br>          <span class="token punctuation">{</span><br>            <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>              <span class="token string">"ID"</span><br>            <span class="token punctuation">]</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre><p>Here are some notes:</p><ul><li>I encapsulated the kind / type determination in helper predicate functions (<code>is_entity</code> and <code>is_association</code>), mostly to keep the main code more succinct</li><li>I love how the <a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">to_entries,from_entries,with_entries(f)</a> family of functions<a href="#footnotes"><sup>2</sup></a> help out by normalising JSON objects that have dynamic values for property keys</li><li>By using the <code>select(is_entity)</code> in the context of such normalisation, I can easily pick out the &quot;enclosing&quot; object that contains the condition I'm looking for</li><li>In contrast to the use of <code>to_entries</code> at the outer (entity) level, I used <code>with_entries</code> to achieve the <code>to_entries | map(...) | from_entries</code> pattern that is so useful</li></ul><p>And that's about it! Score one more for the wonderful utility of jq, in today's world of JSON.</p><h2>Alternative approach</h2><p>While I like the <code>is_entity</code> and <code>is_association</code> definitions, one could make the main code even more succinct like this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">entities</span><span class="token punctuation">:</span> <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">"entity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">def</span> <span class="token function">associations</span><span class="token punctuation">:</span> <span class="token c-style-function function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"cds.Association"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">.</span>definitions<br><span class="token operator pipe">|</span> to_entries<br><span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><br>    entities<br>    <span class="token operator pipe">|</span> <span class="token punctuation">{</span><br>       <span class="token punctuation">(</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span><br>       <span class="token punctuation">.</span>value<span class="token punctuation">.</span>elements <span class="token operator pipe">|</span> <span class="token c-style-function function">with_entries</span><span class="token punctuation">(</span>associations<span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span></code></pre><p>Which do you prefer?</p><hr><p><a name="footnotes"></a> <strong>Footnotes</strong></p><p>1: The human readable language we used to define models is commonly referred to as CDS. <a href="https://cap.cloud.sap/docs">Capire</a>, the CAP documentation resource, is more precise, calling it CDL, classing CDL, CSN and other CAP little languages such as CQL and CQN as all being under the general CDS umbrella term. As you can see from the bottom of the CSN output, even the compiler refers to it as CDS!</p><p>2: For more on this family of functions, see <a href="https://qmacro.org/blog/posts/2022/05/30/reshaping-data-values-using-jq's-with_entries/">Reshaping data values using jq's with_entries</a> and <a href="https://qmacro.org/blog/posts/2024/02/28/quick-conversion-of-multiple-values-using-with_entries-in-jq/">Quick conversion of multiple values using with_entries in jq</a>.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cap/">#cap</a> <a href="/tags/jq/">#jq</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/04/10/avoid-design-time-cap-server-restarts-when-maintaining-local-data-files/"><span>←</span> <span>Avoid design time CAP server restarts when maintaining local data files</span> </a><a href="/blog/posts/2024/03/30/cap-cors-and-custom-headers/"><span>CAP, CORS and custom headers</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>