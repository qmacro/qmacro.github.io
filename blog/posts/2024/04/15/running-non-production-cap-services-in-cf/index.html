<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/04/15/running-non-production-cap-services-in-cf/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.4654d4542dcb045c9ba3.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Running non-production CAP services in CF | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Running non-production CAP services in CF"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/04/15/running-non-production-cap-services-in-cf/"><meta name="description" content="Running non-production CAP services in CF 15 Apr 2024 | 3 min read Sometimes I want to run test CAP services not only locally, but in the..."><meta property="og:description" content="Running non-production CAP services in CF 15 Apr 2024 | 3 min read Sometimes I want to run test CAP services not only locally, but in the..."><meta name="description" content="Running non-production CAP services in CF 15 Apr 2024 | 3 min read Sometimes I want to run test CAP services not only locally, but in the..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Running non-production CAP services in CF</h1><div class="post__details"><time datetime="2024-04-15">15 Apr 2024 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>Sometimes I want to run test CAP services not only locally, but in the cloud. I don't want the trappings of production (which are of course important ... in production settings) such as a production grade persistence mechanism or authorisation strategy &amp; appropriate security layer. Additionally, I like to take &quot;<a href="https://podcasters.spotify.com/pod/show/tech-aloud/episodes/The-Simplest-Thing-that-Could-Possibly-Work--A-conversation-with-Ward-Cunningham--Part-V---Bill-Venners-e5dpts">the simplest thing that could possibly work</a>&quot; approach.</p><h2>Production mode in Cloud Foundry for CAP services</h2><p>If I use <code>cf push</code> to deploy a CAP service to CF, the environment variable <code>NODE_ENV</code> is set automatically to <code>production</code>. This in turn tells the CAP server that <a href="https://cap.cloud.sap/docs/guides/deployment/to-cf#prepare-for-production">production grade</a> facilities are required.</p><blockquote><p>In what follows, I use &quot;service&quot; to refer to what I'm building with CAP, because that's what it is, but &quot;application&quot; when I'm talking about it in terms of CF, as in CF terms, especially when it comes to the <code>cf</code> commands, it's considered an app not a service.</p></blockquote><p>Here's a simple example. Initialising a new project with a simple CDS model and a couple of data records, and pushing immediately to CF:</p><pre class="language-shell"><code class="language-shell">cds init <span class="token parameter variable">--add</span> tiny-sample non-prod-test <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$_</span> <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> cf push <span class="token variable">$_</span></code></pre><p>From the sea of log records, we can pick out some relevant ones:</p><pre class="language-text"><code class="language-text">Creating new CAP project in ./non-prod-test<br><br>Adding feature 'nodejs'...<br>Adding feature 'tiny-sample'...<br><br>Successfully created project. Continue with 'cd non-prod-test'.<br>...<br>Pushing app non-prod-test to org ...<br>   ...<br>   -----> Creating runtime environment<br>   ...<br>   NODE_ENV=production<br>   NODE_HOME=/tmp/contents1028257736/deps/0/node<br>   NODE_MODULES_CACHE=true<br>   NODE_VERBOSE=false<br>   NPM_CONFIG_LOGLEVEL=error<br>   NPM_CONFIG_PRODUCTION=true<br><br>   ...<br><br>Waiting for app non-prod-test to start...<br><br>Instances starting...<br>Instances starting...<br>Instances starting...<br><br>...<br>start command:   npm start<br>     state     since                  cpu    memory     disk       logging        details<br>#0   crashed   2024-04-15T08:18:47Z   0.0%   0B of 1G   0B of 1G   0B/s of 0B/s<br>Start unsuccessful</code></pre><p>Crashed!</p><p>Note that the value of <code>NODE_ENV</code> was set to <code>production</code>.</p><p>Looking at the logs like this:</p><pre class="language-shell"><code class="language-shell">cf logs non-prod-test <span class="token parameter variable">--recent</span></code></pre><p>we can see why:</p><pre class="language-text"><code class="language-text">...<br>[APP/PROC/WEB/0] OUT Invoking start command.<br>[APP/PROC/WEB/0] OUT > non-prod-test@1.0.0 start<br>[APP/PROC/WEB/0] OUT > cds-serve<br>...<br>[APP/PROC/WEB/0] OUT srv/cat-service.cds<br>[APP/PROC/WEB/0] OUT db/data-model.cds<br>[APP/PROC/WEB/0] OUT {..., "msg":"using auth strategy {\n  kind: 'jwt',\n  ..."}<br>[APP/PROC/WEB/0] ERR node:internal/modules/cjs/loader:1134<br>[APP/PROC/WEB/0] ERR const err = new Error(message);<br>[APP/PROC/WEB/0] ERR ^<br>[APP/PROC/WEB/0] ERR Error: Cannot find module '@sap/xssec'. Make sure to install it with 'npm i @sap/xssec'<br>...</code></pre><p>In production mode CAP will (sensibly) require <a href="https://www.npmjs.com/package/@sap/xssec">@sap/xssec</a>.</p><h2>Setting a different value for NODE_ENV</h2><p>The value for <code>NODE_ENV</code> can be set with <code>cf set-env</code>:</p><pre class="language-shell"><code class="language-shell">cf set-env non-prod-test NODE_ENV testing</code></pre><p>After such an action, a <a href="https://cli.cloudfoundry.org/en-US/v8/restage.html">restage</a> is required:</p><pre class="language-shell"><code class="language-shell">cf restage non-prod-test</code></pre><p>This then results in a successful start of our test CAP service:</p><pre class="language-text"><code class="language-text">This action will cause app downtime.<br><br>Restaging app non-prod-test in org ...<br><br>   -----> Creating runtime environment<br>   ...<br>   NODE_ENV=testing<br>   ...<br><br>Restarting app non-prod-test in org ...<br><br>Stopping app...<br><br>Waiting for app to start...<br><br>Instances starting...<br>Instances starting...<br>Instances starting...<br><br>     state     since                  cpu    memory     disk       logging        details<br>#0   running   2024-04-15T08:29:22Z   0.0%   0B of 0B   0B of 0B   0B/s of 0B/s</code></pre><p>It's now running. And we can check the value too of that environment variable, like this:</p><pre class="language-shell"><code class="language-shell">cf <span class="token function">env</span> non-prod-test</code></pre><p>the output of which will include this in the &quot;user-provided&quot; section:</p><pre class="language-text"><code class="language-text">System-Provided:<br>VCAP_SERVICES: {}<br><br>VCAP_APPLICATION: {<br>  "application_id": "7b99b60c-94f3-4757-9928-24a61a510942",<br>  "application_name": "non-prod-test",<br>  ...<br>}<br><br>User-Provided:<br>NODE_ENV: testing<br>...</code></pre><p><a name="--no-start"></a></p><h2>Mitigating the crash from the start</h2><p>Of course, having to deal with an initial crash before sorting things out is a little cumbersome.</p><p>But not to worry, the <code>cf push</code> command has a <code>--no-start</code> option which means that no attempt will be made to start things up initially.</p><p>Here's an example, doing everything in a single line:</p><pre class="language-shell"><code class="language-shell">cds init <span class="token parameter variable">--add</span> tiny-sample non-prod-test <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> non-prod-test <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> cf push non-prod-test --no-start <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> cf set-env non-prod-test NODE_ENV testing <span class="token punctuation">\</span><br>  <span class="token operator">&amp;&amp;</span> cf restage non-prod-test</code></pre><p>The effect is that the CAP service is deployed and running in non-production mode from the outset. There may be better ways to achieve this, but that's how I do it.</p><p>Good to know!</p><hr><p>You may want to read <a href="/blog/posts/2024/04/15/using-@cap-jssqlite-in-cf-for-your-cap-services/">Using @cap-js/sqlite in CF for your CAP services</a> which is closely related to this, too, as well as <a href="/blog/posts/2024/04/14/easily-add-an-explicit-cds.requires.db-to-your-cap-project's-package.json/">Easily add an explicit cds.requires.db to your CAP project's package.json</a>.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/good-to-know/">#good-to-know</a> <a href="/tags/cap/">#cap</a> <a href="/tags/cf/">#cf</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/04/15/using-@cap-jssqlite-in-cf-for-your-cap-services/"><span>←</span> <span>Using @cap-js/sqlite in CF for your CAP services</span> </a><a href="/blog/posts/2024/04/14/easily-add-an-explicit-cds.requires.db-to-your-cap-project&#39;s-package.json/"><span>Easily add an explicit cds.requires.db to your CAP project&#39;s package.json</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>