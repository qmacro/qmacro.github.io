<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/05/13/using-arg-in-a-dockerfile-beware-the-gotcha/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.7884d8f8e9dd86c3b137.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Using ARG in a Dockerfile - beware the gotcha | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Using ARG in a Dockerfile - beware the gotcha"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/05/13/using-arg-in-a-dockerfile-beware-the-gotcha/"><meta name="description" content="Using ARG in a Dockerfile - beware the gotcha 13 May 2024 | 3 min read Today I learned about the subtleties of build arguments in Dockerfile..."><meta property="og:description" content="Using ARG in a Dockerfile - beware the gotcha 13 May 2024 | 3 min read Today I learned about the subtleties of build arguments in Dockerfile..."><meta name="description" content="Using ARG in a Dockerfile - beware the gotcha 13 May 2024 | 3 min read Today I learned about the subtleties of build arguments in Dockerfile..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Using ARG in a Dockerfile - beware the gotcha</h1><div class="post__details"><time datetime="2024-05-13">13 May 2024 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>Today I learned about the subtleties of <a href="https://docs.docker.com/build/guide/build-args/">build arguments</a> in Dockerfile definitions, specifically how the <code>ARG</code> instruction relates to - and is affected by - the <code>FROM</code> instruction. It's not entirely like a constant or a variable, in the way that I had thought.</p><h2>The problem with empty ARG values</h2><p>I spent more than a coffee's worth of time trying to understand why my custom builds of a CAP Node.js container image weren't of the CAP version I was specifying, either implicitly with the default value I'd declared in the <code>ARG</code> instruction in the Dockerfile, or even explicitly with the <code>--build-arg</code> option on the command line.</p><p>To illustrate the problem, here's a vastly simplified version of the Dockerfile I was building with:</p><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># syntax=docker/dockerfile:1</span><br><br><span class="token instruction"><span class="token keyword">ARG</span> DEBVER=<span class="token string">"10"</span></span><br><span class="token instruction"><span class="token keyword">ARG</span> CAPVER=<span class="token string">"7.8"</span></span><br><span class="token instruction"><span class="token keyword">FROM</span> debian:<span class="token variable">${DEBVER}</span></span><br><br><span class="token instruction"><span class="token keyword">RUN</span> printf <span class="token string">"DEB=${DEBVER}\nCAP=${CAPVER}\n"</span> > /tmp/log</span></code></pre><p>The first variable declared with <code>ARG</code> here is <code>DEBVER</code> and represents a fairly common use case of allowing for different versions of a base image, illustrated here in being able to start from different versions of the Debian distribution, where the default version is to be 10.</p><p>The second variable <code>CAPVER</code> was something similar that I was using later in the build instructions (i.e. further on in the Dockerfile), to specify the particular version of CAP that I wanted to install. The actual instruction in my Dockerfile looked like this: <code>RUN npm install -g @sap/cds-dk@{CAPVER}</code>.</p><p>After building the image based on this simplified Dockerfile, without specifying any values explicitly with <code>--build-arg</code>, like this:</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> argtest <span class="token builtin class-name">.</span></code></pre><p>I could successfully confirm that the version of Debian in containers created from this image was 10:</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">grep</span> VERSION_ID /etc/os-release<br><span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"10"</span></code></pre><p>But what of the content of <code>/tmp/log</code>?</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">cat</span> /tmp/log<br><span class="token assign-left variable">DEB</span><span class="token operator">=</span><br><span class="token assign-left variable">CAP</span><span class="token operator">=</span></code></pre><p>Hmm.</p><p>How about when I use <code>--build-arg</code> options?</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> build <span class="token punctuation">\</span><br>  --build-arg<span class="token operator">=</span><span class="token string">"DEBVER=11"</span> <span class="token punctuation">\</span><br>  --build-arg<span class="token operator">=</span><span class="token string">"CAPVER=7.9"</span> <span class="token punctuation">\</span><br>  <span class="token parameter variable">-t</span> argtest <span class="token builtin class-name">.</span></code></pre><p>The build completes successfully, and I can see that containers now are Debian 11 based:</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">grep</span> VERSION_ID /etc/os-release<br><span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"11"</span></code></pre><p>but the problem with the empty values for <code>DEBVER</code> and <code>CAPVER</code> in <code>/tmp/log</code> remains.</p><p>Not only is the value for <code>CAPVER</code> empty when we reference it in the <code>RUN</code> instruction, but also, and this is the most mysterious thing thus far, while <code>DEBVER</code> was certainly recognised and set to 11 for the Debian distribution in the <code>FROM</code> instruction, it's empty when we reference it later in the <code>RUN</code> instruction.</p><h2>The subtleties of how ARG relates to FROM</h2><p>The cause is the rather subtle relationship between <code>ARG</code> and <code>FROM</code>, the explanation for which is brief and a little hidden in the main <a href="https://docs.docker.com/reference/dockerfile/">Dockerfile reference</a>. I certainly missed it when I went straight to the <a href="https://docs.docker.com/reference/dockerfile/#arg">reference for <code>ARG</code></a>, as it's not mentioned, and only explained at the end of the <a href="https://docs.docker.com/reference/dockerfile/#from">reference for <code>FROM</code></a> which is earlier on the page.</p><p>The key section is here: <a href="https://docs.docker.com/reference/dockerfile/#understand-how-arg-and-from-interact">Understand how ARG and FROM react</a>, and includes this line:</p><blockquote><p>&quot;<em>An <code>ARG</code> declared before a <code>FROM</code> is outside of a build stage, so it can't be used in any instruction after a <code>FROM</code>.</em>&quot;</p></blockquote><p>In other words, variables declared with <code>ARG</code> look like variables in, say, a shell script, variables which are also often declared at the start, and then used throughout the script.</p><p>But they're not.</p><h2>The solution</h2><p>What must be done to the Dockerfile above is to modify it so it looks like this:</p><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># syntax=docker/dockerfile:1</span><br><br><span class="token instruction"><span class="token keyword">ARG</span> DEBVER=<span class="token string">"10"</span></span><br><span class="token instruction"><span class="token keyword">FROM</span> debian:<span class="token variable">${DEBVER}</span></span><br><span class="token instruction"><span class="token keyword">ARG</span> DEBVER</span><br><span class="token instruction"><span class="token keyword">ARG</span> CAPVER=<span class="token string">"7.8"</span></span><br><br><span class="token instruction"><span class="token keyword">RUN</span> printf <span class="token string">"DEB=${DEBVER}\nCAP=${CAPVER}\n"</span> > /tmp/log</span></code></pre><p>Moving the <code>ARG</code> instruction for <code>CAPVER</code> so that it comes after the <code>FROM</code> instruction gives it life and validity.</p><p>And the <code>ARG</code> instruction for <code>DEBVER</code> must stay where it is (as it's referenced in the <code>FROM</code> instruction details of course) but if it needs to be referred to after the <code>FROM</code> instruction it must be referenced again - hence the <code>ARG DEBVER</code> line.</p><p>From a container image built using this new version of the Dockerfile, with no <code>--build-arg</code> options specified, we can see that the values for <code>DEBVER</code> and <code>CAPVER</code> are available after the <code>FROM</code> instruction:</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">cat</span> /tmp/log<br><span class="token assign-left variable">DEB</span><span class="token operator">=</span><span class="token number">10</span><br><span class="token assign-left variable">CAP</span><span class="token operator">=</span><span class="token number">7.8</span></code></pre><p>And this works of course if we set values for build arguments on the command line too, testing a container built using the same <code>docker build --build-arg ...</code> invocation as before:</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">cat</span> /tmp/log<br><span class="token assign-left variable">DEB</span><span class="token operator">=</span><span class="token number">11</span><br><span class="token assign-left variable">CAP</span><span class="token operator">=</span><span class="token number">7.9</span></code></pre><p>and</p><pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> argtest <span class="token function">grep</span> VERSION_ID /etc/os-release<br><span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"11"</span></code></pre><h2>Wrapping up</h2><p>Perhaps I should have read the entire reference document for all the Dockerfile instructions first. Then I would have at least read about this relationship, and I may also have remembered it too. But for those of you like me who jump directly to consult the reference documentation on the thing they're trying to use, perhaps this will help.</p><p>Happy building!</p><hr><h2>Update</h2><p>This post has generated <a href="https://news.ycombinator.com/item?id=40352426">quite a bit of interesting discussion over on HN</a>.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/docker/">#docker</a> <a href="/tags/dockerfile/">#dockerfile</a> <a href="/tags/til/">#til</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/05/20/codetalk-interview-living-and-working-on-a-narrowboat/"><span>←</span> <span>CodeTalk interview - living and working on a narrowboat</span> </a><a href="/blog/posts/2024/05/09/defining-a-custom-&#39;after&#39;-handler-in-cap-with-&#39;each&#39;/"><span>Defining a custom &#39;after&#39; handler in CAP with &#39;each&#39;</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>