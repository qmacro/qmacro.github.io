<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/05/03/controlling-automatic-http-requests-in-cap-node.js-design-time-loops/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.4654d4542dcb045c9ba3.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Controlling automatic HTTP requests in CAP Node.js design time loops | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Controlling automatic HTTP requests in CAP Node.js design time loops"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/05/03/controlling-automatic-http-requests-in-cap-node.js-design-time-loops/"><meta name="description" content="Controlling automatic HTTP requests in CAP Node.js design time loops 03 May 2024 | 3 min read CAP affords developers a great design time..."><meta property="og:description" content="Controlling automatic HTTP requests in CAP Node.js design time loops 03 May 2024 | 3 min read CAP affords developers a great design time..."><meta name="description" content="Controlling automatic HTTP requests in CAP Node.js design time loops 03 May 2024 | 3 min read CAP affords developers a great design time..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Controlling automatic HTTP requests in CAP Node.js design time loops</h1><div class="post__details"><time datetime="2024-05-03">03 May 2024 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>CAP affords developers a great design time experience, with minimal setup and fast turnaround times when building out your model and code. Often what I like to do is run an OData query operation to check both the data returned and any custom logic that I'm implementing. And I want that to happen automatically when I modify something. The invocation of <code>cds watch</code> already provides most of the monitor-and-restart magic that I need, but I also want a separate process to (re-)send an HTTP request to the CAP server when it's restarted.</p><p>The key phrase here is &quot;when it's restarted&quot;.</p><h2>Using entr</h2><p>In my terminal sessions, I use the excellent <a href="https://github.com/eradman/entr">entr</a> tool to run commands when files change. You feed it names of files to watch (you can use globs too) and tell it what to run when any of those files change. For a super simple example, if I wanted the date to be emitted each time any service implementation file in the <code>srv/</code> directory changed, I'd run this:</p><pre class="language-shell"><code class="language-shell"><span class="token function">ls</span> srv/*.js <span class="token operator">|</span> entr <span class="token function">date</span></code></pre><p>So to get an OData query operation to be performed, I can do something like this:</p><pre class="language-shell"><code class="language-shell"><span class="token function">ls</span> srv/*.js <span class="token punctuation">\</span><br>  <span class="token operator">|</span> entr <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">'curl -s localhost:4004/service/Entity | jq .'</span></code></pre><h2>Timing</h2><p>The challenge here is that while <code>cds watch</code> and <code>entr</code> are both monitoring files, what happens is that when something changes, the CAP server will be restarted (via the monitor-and-restart magic), and the HTTP request will be made via <code>curl</code>. And sometimes, the CAP server startup takes a second or two, by which time the <code>curl</code> command will have already been issued, too early, and therefore no response will have been received.</p><h2>CAP server lifecycle events</h2><p>The CAP server has a number of <a href="https://cap.cloud.sap/docs/node.js/cds-server#lifecycle-events">events that are emitted at various points in its lifecycle</a>. One of these events is <a href="https://cap.cloud.sap/docs/node.js/cds-server#listening">listening</a> which is emitted &quot;<em>when the server has been started and is listening to incoming requests</em>&quot;.</p><p>This sounds like the perfect match to align with the <code>entr</code>-initiated <code>curl</code> command.</p><h2>Custom server.js</h2><p>In the <a href="https://cap.cloud.sap/docs/node.js/cds-server">same main section</a> as the list of CAP server lifecycle events is a section on creating your own <a href="https://cap.cloud.sap/docs/node.js/cds-server#custom-server-js">custom server.js</a>, where &quot;<em>you can plug in to all parts of <code>@sap/cds</code></em>&quot;.</p><p>Here's a custom <code>server.js</code> implementation that I use to match the timing of the <code>curl</code> command to the right time after the server has restarted, so it doesn't try to make the request before the server is ready.</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:fs/promises'</span><span class="token punctuation">)</span><br><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>It's as simple as you can get, and just writes an empty file called <code>listening</code> in the project root directory every time the &quot;listening&quot; event is emitted, which is each time the CAP server is restarted and has got to the point where it's ready to receive HTTP requests.</p><p>Now, with this <code>server.js</code> file in my CAP project root directory, I can feed <code>entr</code> with the name of this file, and it will only run and re-run the <code>curl</code> command to send the HTTP request ... when the CAP server is ready for it.</p><h2>Demo</h2><p>Here's a simple demo of this approach in action.</p><p><img src="/images/2024/05/entr-curl-listening.gif" alt="entr invoking curl on listening change"></p><p>A bit of a nerdy hack, perhaps, but still ... good to know!</p><h2>Post script</h2><p>There's another CAP server lifecycle event I can use to clean up (remove) the <code>listening</code> file; sometimes I want to do that, sometimes I don't. When I do, I just use the <code>shutdown</code> event, and chain another <code>on()</code> like this:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:fs/promises'</span><span class="token punctuation">)</span><br><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'shutdown'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>The side effect is that when the <code>shutdown</code> event happens and the <code>listening</code> file is removed, the running <code>entr</code> process terminates like this:</p><pre class="language-log"><code class="language-log"><span class="token property">entr:</span> cannot open <span class="token string">'listening'</span><span class="token operator">:</span> No such file or directory</code></pre><p>This termination is actually often what I want anyway. YMMV.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cap/">#cap</a> <a href="/tags/good-to-know/">#good-to-know</a> <a href="/tags/entr/">#entr</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/04/17/simple-script-for-previewing-cds-models-in-csn-cdsray/"><span>Simple script for previewing CDS models in CSN - cdsray</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>