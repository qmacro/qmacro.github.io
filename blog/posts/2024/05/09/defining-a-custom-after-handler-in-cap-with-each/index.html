<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Defining a custom &#39;after&#39; handler in CAP with &#39;each&#39;</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="defining-a-custom-after-handler-in-cap-with-each">Defining a custom &#39;after&#39; handler in CAP with &#39;each&#39;</h1>

<ul class="post-metadata">
	<li><time datetime="2024-05-09">09 May 2024</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/javascript/" class="post-tag">javascript</a></li>
</ul>

<p class="post-description-main"></p>

<p>TL;DR: There's special behaviour if you use the <code>each</code> parameter name when defining an <code>after</code> handler, but the way this works and the way you should invoke it has changed.</p>
<p>Adding <a href="https://cap.cloud.sap/docs/get-started/in-a-nutshell#adding-custom-logic">custom logic</a> to your CAP services is easy, and you can register event handlers with the <a href="https://cap.cloud.sap/docs/node.js/core-services#srv-on-before-after"><code>before</code>, <code>on</code> and <code>after</code> methods</a>.</p>
<h2 id="handlers-registered-with-the-after-method">Handlers registered with the 'after' method</h2>
<p>Handlers registered with the <code>after</code> method are called once the default handling of a request is done, so that you have a comfortable and convenient chance to enhance or otherwise adjust the data before the response is sent back.</p>
<p>By default, the data is passed to your handler function as the first argument<a href="#footnotes"><sup>1</sup></a>, in the form of an array of objects, where each object represents a record.</p>
<blockquote>
<p>In the case of where the service is exposed via the OData protocol, for example, note that this is true for both OData QUERY operations, where you'd expect an entity set, and OData READ operations too, where you only expect a single entity. In other words, even when only a single record is requested, the record is supplied as the first argument to your handler as a single object ... within an array.</p>
</blockquote>
<p>To illustrate, let's first create a fresh test CAP project, initiated with the &quot;tiny-sample&quot; facet to give us a super simple service exposing two book records<a href="#footnotes"><sup>2</sup></a>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cds init <span class="token parameter variable">--add</span> tiny-sample eachtest <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$_</span></code></pre>
<p>Here's what such a handler might look like, in the context of a service implementation in <code>srv/cat-service.js</code>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'eachtest'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token string">'Books'</span><span class="token punctuation">,</span> <span class="token parameter">books</span> <span class="token operator">=></span> <span class="token function">log</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>When an entity set is requested, like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token string">'localhost:4004/odata/v4/catalog/Books'</span></code></pre>
<p>then we can see from the CAP server log output that an array of two objects is provided via the first parameter <code>books</code> in the handler definition:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>odata<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token file-path string">/odata/v4/catalog/Books</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">500</span> <span class="token operator">}</span>
<span class="token punctuation">]</span></code></pre>
<p>Note also that even when a single record (entity) is requested:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token string">'localhost:4004/odata/v4/catalog/Books(1)'</span></code></pre>
<p>it is still provided within an array:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>odata<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token file-path string">/odata/v4/catalog/Books</span><span class="token operator">(</span><span class="token number">1</span><span class="token operator">)</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">}</span> <span class="token punctuation">]</span></code></pre>
<h2 id="the-special-name-each">The special name 'each'</h2>
<p>Those of you who have been developing with CAP for a while may recall a variant for <code>after</code> handlers where if you used the name <code>each</code> for the first parameter in the definition, that handler would be called <em>once per record</em> rather than a single time with all records.</p>
<p>Changing the parameter name from <code>books</code> to <code>each</code> like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'READ'</span><span class="token punctuation">,</span> <span class="token string">'Books'</span><span class="token punctuation">,</span> <span class="token parameter">each</span> <span class="token operator">=></span> <span class="token function">log</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>results in a call to the handler for <em>each</em> record. The same entity set request:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token string">'localhost:4004/odata/v4/catalog/Books'</span></code></pre>
<p>now results in two <code>[eachtest]</code> log records, implying two separate calls to the handler function:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>odata<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token file-path string">/odata/v4/catalog/Books</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">500</span> <span class="token operator">}</span></code></pre>
<p>Note that this time there is no enclosing array, to underline the nature of what this <code>each</code> name implies.</p>
<h2 id="a-better-way-to-achieve-the-each-behaviour">A better way to achieve the 'each' behaviour</h2>
<p>While convenient, special behaviour determined by the choice of parameter name can be confusing and - where the code is modified before execution e.g. via minification - may become unstable or unpredictable.</p>
<p>Instead, the CAP team have added a different convenience feature for the registration of <code>after</code> handlers, so that you can still choose to enjoy the once per record behaviour, but be more explicit about it, and avoid any risk of instability.</p>
<p>All you have to do is to use the value <code>each</code> for the event parameter (the first parameter) in the registration for an <code>after</code> handler. This is instead of the standard <code>READ</code> value (this in turn implies that this behaviour is still only valid for the reading of records).</p>
<p>To illustrate, let's modify the handler registration so it now looks like this:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cds<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token string">'each'</span><span class="token punctuation">,</span> <span class="token string">'Books'</span><span class="token punctuation">,</span> <span class="token parameter">book</span> <span class="token operator">=></span> <span class="token function">log</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>The behaviour is the same, in that the handler function is called once per record, as we can see by making the same OData QUERY operation again:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">curl</span> <span class="token string">'localhost:4004/odata/v4/catalog/Books'</span></code></pre>
<p>and observing from the log output that the handler function is called once for each record:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>odata<span class="token punctuation">]</span> <span class="token operator">-</span> GET <span class="token file-path string">/odata/v4/catalog/Books</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Wuthering Heights'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>eachtest<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token operator">{</span> ID<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Jane Eyre'</span><span class="token punctuation">,</span> stock<span class="token operator">:</span> <span class="token number">500</span> <span class="token operator">}</span></code></pre>
<p>This approach is a lot more obvious, less prone to misunderstandings, and stable.</p>
<blockquote>
<p>The old behaviour invoked by using <code>each</code> as the name of the first parameter in the handler function is still supported for now, to avoid breaking existing code.</p>
</blockquote>
<p>If you're interested to learn more, you can check out the changes to <a href="https://cap.cloud.sap/docs/">Capire</a> in pull request 775 <a href="https://github.com/cap-js/docs/pull/775">Document .after('each', ...) handler</a>.</p>
<hr>
<p><a name="footnotes"></a></p>
<h2 id="footnotes">Footnotes</h2>
<p>(1) Often you only need to define a parameter to receive this first argument, but actually there's a second argument passed to <code>after</code> handlers, which is the request itself, just in case you need something from it to fulfil the logic you want to implement. In this case, you'd probably want something like <code>(data, req)</code> as your function signature.</p>
<p>(2) For more on the &quot;tiny-sample&quot; facet, see this YouTube Short: <a href="https://www.youtube.com/shorts/yrzcoU6Ge3k">Use the &quot;tiny sample&quot; feature on new CAP projects to get started quickly</a>.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/05/08/obtaining-auth-code-grant-type-oauth-2-0-tokens-for-google-apis-with-a-script/">Obtaining auth code grant type OAuth 2.0 tokens for Google APIs with a script</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/05/13/using-arg-in-a-dockerfile-beware-the-gotcha/">Using ARG in a Dockerfile - beware the gotcha</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/05/09/defining-a-custom-after-handler-in-cap-with-each/` was built on 2025-09-16T13:56:43.398Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
