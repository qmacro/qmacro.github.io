<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>CAP Node.js plugins - part 1 - how things work</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="cap-node-js-plugins-part-1-how-things-work">CAP Node.js plugins - part 1 - how things work</h1>

<ul class="post-metadata">
	<li><time datetime="2024-10-05">05 October 2024</time></li>
	<li><a href="/tags/cap/" class="post-tag">cap</a>, </li>
	<li><a href="/tags/cds/" class="post-tag">cds</a>, </li>
	<li><a href="/tags/plugins/" class="post-tag">plugins</a>, </li>
	<li><a href="/tags/teched/" class="post-tag">teched</a>, </li>
	<li><a href="/tags/keynote/" class="post-tag">keynote</a></li>
</ul>

<p class="post-description-main"></p>

<p>In this first of a three part series of blog posts, we explore the <a href="https://cap.cloud.sap/docs/node.js/cds-plugins">CDS Plugin</a> mechanism in CAP to find out how it works, so we are well prepared to write our own plugin.</p>
<p>For information on the series and links to all resources, see <a href="/blog/posts/2024/12/30/cap-node-js-plugins/">CAP Node.js Plugins</a>.</p>
<blockquote>
<p>The examples in this post are based on CAP Node.js at release 8.3.0 (<a href="https://cap.cloud.sap/docs/releases/sep24">September 2024</a>).</p>
</blockquote>
<p><a name="setting-the-scene"></a></p>
<h2 id="setting-the-scene">Setting the scene</h2>
<p>To set the scene, imagine a simple service scenario, where we've got two entities:</p>
<ul>
<li><code>Books</code>, where we'll be focusing our attention for the plugin</li>
<li><code>Things</code>, just there as a &quot;control&quot; to show how we can properly implement a plugin that's generic and doesn't have to be aware of specific entity names</li>
</ul>
<p>This is the entire service definition, in <code>services.cds</code>, including the entities:</p>
<pre class="language-cds" tabindex="0"><code class="language-cds"><span class="token keyword">service</span> Bookshop {
    <span class="token keyword">entity</span> Books {
        <span class="token cqlkeywords keyword">key</span> ID          : <span class="token type builtin">Integer</span>;
            title       : <span class="token type builtin">String</span>;
            genre       : <span class="token type builtin">String</span>;
            stock       : <span class="token type builtin">Integer</span>;
    }
    <span class="token keyword">entity</span> Things {
        <span class="token cqlkeywords keyword">key</span> ID : <span class="token type builtin">Integer</span>;
    }
}</code></pre>
<p>Starting the CAP server with <code>cds watch</code> gives us what we expect, there's some data deployed to the in-memory persistence layer and we have an OData V4 service being served.</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded model from <span class="token number">1</span> file<span class="token operator">(</span>s<span class="token operator">)</span><span class="token operator">:</span>

  <span class="token domain constant">services.cds</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect using bindings from<span class="token operator">:</span> <span class="token operator">{</span> registry<span class="token operator">:</span> <span class="token string">'~/.cds-services.json'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> connect to db <span class="token operator">></span> sqlite <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">':memory:'</span> <span class="token operator">}</span>
  <span class="token operator">></span> init from data<span class="token operator">/</span>Bookshop<span class="token punctuation">.</span>Books<span class="token punctuation">.</span>csv
<span class="token operator">/</span><span class="token operator">></span> successfully deployed to in<span class="token operator">-</span>memory database<span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> using new OData adapter
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> serving Bookshop <span class="token operator">{</span> path<span class="token operator">:</span> <span class="token string">'/odata/v4/bookshop'</span> <span class="token operator">}</span>

<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> server listening on <span class="token operator">{</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:4004'</span> <span class="token operator">}</span></code></pre>
<p><a name="debug-and-digging-in"></a></p>
<h2 id="debug-and-digging-in">Debug and digging in</h2>
<p>Often when I'm trying to deconstruct and understand something, I turn to the <code>DEBUG</code> environment variable. It give me a ton of info to start staring at.</p>
<p>Running <code>DEBUG=all cds watch</code> emits far too much output to even show here in this post. But that's sort of the point. More is better, but right now let's limit it to the plugins module, by using <code>DEBUG=plugins cds watch</code>. In addition to the log output we've already seen (above), this now also emits:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">-</span>fiori<span class="token operator">:</span> <span class="token operator">{</span>
  <span class="token property">impl:</span> <span class="token string">'../../usr/local/share/npm-global/lib/node_modules/@sap/cds-dk/node_modules/@sap/cds-fiori/cds-plugin.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>cap<span class="token operator">-</span>js<span class="token operator">/</span>sqlite<span class="token operator">:</span> <span class="token operator">{</span>
  <span class="token property">impl:</span> <span class="token string">'../../usr/local/share/npm-global/lib/node_modules/@sap/cds-dk/node_modules/@cap-js/sqlite/cds-plugin.js'</span>
<span class="token operator">}</span>
<span class="token punctuation">[</span>plugins<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded plugins in<span class="token operator">:</span> <span class="token number">2.464ms</span></code></pre>
<p>This is interesting! What is this telling us? Well ...</p>
<ul>
<li>There are already plugins being loaded! The <a href="https://cap.cloud.sap/docs/plugins/">CAP framework uses the plugin concept itself</a>, here we can see that <code>@sap/cds-fiori</code> and <code>@cap-js/sqlite</code> are plugins. But where are they defined, why are these specific ones being loaded? We'll come to that shortly.</li>
<li>The <em>filename</em> in each of these plugins is <code>cds-plugin.js</code>, and we can recall this from <a href="https://cap.cloud.sap/docs/node.js/cds-plugins#add-a-cds-plugin-js">the plugin documentation</a>. That's what we'll need to start with too for our own plugin.</li>
<li>Right now, the implementation (in <code>cds-plugin.js</code>) for each of these plugins is found in the global <code>@sap/cds-dk</code> location (<code>../../usr/local/share/ ... /node_modules/@sap/cds-dk/...</code>). Rather than dig around trying to look at the detail there, it would be easier to be able to look in a project-local <code>node_modules/</code> directory hierarchy here.</li>
</ul>
<p><a name="local-installation-and-identifying-the-plugin-mechanism"></a></p>
<h2 id="local-install-and-identifying-the-plugin-mechanism">Local install and identifying the plugin mechanism</h2>
<p>So let's install the project dependencies now, with <code>npm install</code>, which emits something like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log">added <span class="token number">112</span> packages<span class="token punctuation">,</span> and audited <span class="token number">113</span> packages in <span class="token number">13s</span>

<span class="token number">22</span> packages are looking for funding
  run `npm fund` for details

<span class="token number">4</span> low severity vulnerabilities

To address all issues <span class="token operator">(</span>including breaking changes<span class="token operator">)</span><span class="token punctuation">,</span> run<span class="token operator">:</span>
  npm audit fix <span class="token operator">-</span><span class="token operator">-</span>force

Run `npm audit` for details<span class="token punctuation">.</span></code></pre>
<p>Now we can look locally for that &quot;loading plugin&quot; message from the debug output, using <code>grep -R 'loading plugin' *</code>. This shows us:</p>
<pre class="language-log" tabindex="0"><code class="language-log">node_modules<span class="token operator">/</span><span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">/</span>bin<span class="token operator">/</span>serve<span class="token punctuation">.</span>js<span class="token operator">:</span>  <span class="token operator">/</span><span class="token operator">/</span> Ensure loading plugins before calling cds<span class="token punctuation">.</span>env<span class="token operator">!</span>
node_modules<span class="token operator">/</span><span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">/</span>lib<span class="token operator">/</span>plugins<span class="token punctuation">.</span>js<span class="token operator">:</span>    <span class="token level debug keyword">DEBUG</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token operator">(</span>`loading plugin <span class="token operator">$</span><span class="token operator">{</span>plugin<span class="token operator">}</span><span class="token operator">:</span>`<span class="token punctuation">,</span> <span class="token operator">{</span> impl<span class="token operator">:</span> local<span class="token operator">(</span>conf<span class="token punctuation">.</span>impl<span class="token operator">)</span> <span class="token operator">}</span><span class="token operator">)</span>
node_modules<span class="token operator">/</span><span class="token punctuation">.</span>bin<span class="token operator">/</span>cds<span class="token operator">-</span>serve<span class="token operator">:</span>  <span class="token operator">/</span><span class="token operator">/</span> Ensure loading plugins before calling cds<span class="token punctuation">.</span>env<span class="token operator">!</span></code></pre>
<p>Cool. There's a comment in <code>node_modules/@sap/cds/bin/serve.js</code> (and that <code>cds-serve</code> is just a symlink to that same file) ... but that DEBUG output statement in <code>plugins.js</code> seems like the right place. Let's have a look ... at the CAP server source code - let's dive in!</p>
<p><a name="diving-into-the-cap-server-source-code"></a></p>
<h2 id="diving-into-the-cap-server-source-code">Diving into the CAP server source code</h2>
<p>Taking a look inside <code>node_modules/@sapcds/lib/plugins.js</code> we can see all sorts of stuff, but I'm drawn to this <code>fetch</code> function:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token comment">/**
 * Fetch cds-plugins from project's package dependencies.
 * Used in and made available through cds.env.plugins.
 */</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token constant">DEV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">fetch_plugins_in</span> <span class="token punctuation">(</span>cds<span class="token punctuation">.</span>home<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token function">fetch_plugins_in</span> <span class="token punctuation">(</span>cds<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token constant">DEV</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">fetch_plugins_in</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> dev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> pkg<span class="token punctuation">;</span> <span class="token keyword">try</span> <span class="token punctuation">{</span> pkg <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>root <span class="token operator">+</span> <span class="token string">'/package.json'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token keyword">let</span> deps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>dev <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>devDependencies <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> each <span class="token keyword">in</span> deps<span class="token punctuation">)</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> impl <span class="token operator">=</span> exports<span class="token punctuation">.</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>each <span class="token operator">+</span> <span class="token string">'/cds-plugin'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">paths</span><span class="token operator">:</span> <span class="token punctuation">[</span>root<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> packageJson <span class="token operator">=</span> exports<span class="token punctuation">.</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>each <span class="token operator">+</span> <span class="token string">'/package.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">paths</span><span class="token operator">:</span> <span class="token punctuation">[</span>root<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      plugins<span class="token punctuation">[</span>each<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> impl<span class="token punctuation">,</span> packageJson <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span> <span class="token comment">/* no cds-plugin.js */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> plugins
<span class="token punctuation">}</span></code></pre>
<p>There are two calls to <code>fetch_plugins_in</code>, with different sources:</p>
<ul>
<li><code>cds.home</code></li>
<li><code>cds.root</code></li>
</ul>
<p>This code may appear initially a little dense, but if we stare at it for a bit we see that the <code>fetch_plugins_in</code> function tries to <code>require</code> a <code>package.json</code> file in the source given, and then tries to <code>resolve</code> a <code>cds-plugin.js</code> file in each of the <code>dependencies</code> (and <code>devDependencies</code> if development mode is indicated) in the <code>package.json</code> files that it manages to find.</p>
<p>Here's what that looks like in glorious ASCII art:</p>
<pre class="language-text" tabindex="0"><code class="language-text">
            fetch_plugins_in
            +--------------------------------------+
[source] -> | [source]/package.json                |
            |            |                         |
            |            +-- dependencies          |
            |            |     |                   |
            |            |     +-- cds-plugin.js ? |
            |            |     +-- ...             |
            |            |                         |
            |            +-- devDependencies       |
            |                  |                   |
            |                  +-- cds-plugin.js ? |
            |                  +-- ...             |
            +--------------------------------------+</code></pre>
<p>OK, so we're definitely onto something.</p>
<p>But what are these sources <code>cds.home</code> and <code>cds.root</code>?</p>
<p><a name="embracing-the-repl"></a></p>
<h2 id="embracing-the-repl">Embracing the REPL</h2>
<p>Well, to find out, I'm going to use one of the perhaps lesser known and more mysterious superpowers - the <a href="https://cap.cloud.sap/docs/tools/cds-cli#cds-repl">REPL</a>.</p>
<blockquote>
<p>The concept of a REPL, which stands for <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">Read Evaluate Print Loop</a> is an old one, dating back to the 1960's, especially (but not only) in the world of Lisp. This is yet another example of where the <a href="/blog/posts/2024/12/06/the-art-and-science-of-cap/">Art &amp; Science of CAP</a> has venerable ancestry.</p>
</blockquote>
<p>Wanting to know more about <code>cds.home</code> and <code>cds.root</code> is a perfect opportunity to try out the REPL, in a nice and gentle way. And we'll be making heavy use of the REPL in part 2 of this series, so it's worth becoming acquainted with it now.</p>
<p>Starting the repl with <code>cds repl</code>, we can examine the values of <code>cds.home</code> and <code>cds.root</code> like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Welcome to cds repl v <span class="token number">8.3.0</span>
<span class="token operator">></span> <span class="token domain constant">cds.home</span>
<span class="token file-path string">/workspaces/project/node_modules/@sap/cds</span>
<span class="token operator">></span> <span class="token domain constant">cds.root</span>
<span class="token file-path string">/workspaces/project</span>
<span class="token operator">></span></code></pre>
<p>So we can see that <code>cds.home</code> is <code>/workspaces/project/node_modules/@sap/cds</code>, i.e. the root part of the libraries, installed as project-local packages, that make up the CAP framework, and that <code>cds.root</code> is <code>/workspaces/project</code> which is the root part of our CAP project directory structure.</p>
<p><a name="examining-the-surface-area-for-plugin-discovery"></a></p>
<h2 id="examining-the-surface-area-for-plugin-discovery">Examining the surface area for plugin discovery</h2>
<p>So we now know that it's looking for plugin implementations in the collection of packages made up of the <code>dependencies</code> and <code>devDependencies</code> of this project's <code>package.json</code> and also of <code>@sap/cds</code>'s <code>package.json</code>.</p>
<p>I can use the power of <code>jq</code> and get a look at that entire list, like this:</p>
<pre class="language-jq" tabindex="0"><code class="language-jq">jq '<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">.</span>dependencies <span class="token operator">+</span> <span class="token punctuation">.</span>devDependencies' \
  node_modules<span class="token operator">/</span>@sap<span class="token operator">/</span>cds<span class="token operator">/</span>package<span class="token punctuation">.</span>json \
  package<span class="token punctuation">.</span>json</code></pre>
<p>This emits:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token string">"@sap/cds"</span>
<span class="token punctuation">{</span>
  <span class="token property">"@sap/cds-compiler"</span><span class="token operator">:</span> <span class="token string">">=5.1"</span><span class="token punctuation">,</span>
  <span class="token property">"@sap/cds-fiori"</span><span class="token operator">:</span> <span class="token string">"^1"</span><span class="token punctuation">,</span>
  <span class="token property">"@sap/cds-foss"</span><span class="token operator">:</span> <span class="token string">"^5.0.0"</span>
<span class="token punctuation">}</span>
<span class="token string">"plugins-deconstructed-starter"</span>
<span class="token punctuation">{</span>
  <span class="token property">"@sap/cds"</span><span class="token operator">:</span> <span class="token string">"^8"</span><span class="token punctuation">,</span>
  <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4"</span><span class="token punctuation">,</span>
  <span class="token property">"@cap-js/sqlite"</span><span class="token operator">:</span> <span class="token string">"^1"</span>
<span class="token punctuation">}</span></code></pre>
<p>Manually checking for <code>cds-plugin.js</code> files, with <code>find . -name cds-plugin.js</code> shows that the only occurrences of <code>cds-plugin.js</code> files are these two:</p>
<pre class="language-log" tabindex="0"><code class="language-log">node_modules<span class="token operator">/</span><span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">-</span>fiori<span class="token operator">/</span>cds<span class="token operator">-</span>plugin<span class="token punctuation">.</span>js
node_modules<span class="token operator">/</span><span class="token operator">@</span>cap<span class="token operator">-</span>js<span class="token operator">/</span>sqlite<span class="token operator">/</span>cds<span class="token operator">-</span>plugin<span class="token punctuation">.</span>js</code></pre>
<p>And this also shows us that:</p>
<ul>
<li><code>@sap/cds-fiori</code> (referenced in <code>node_modules/@sap/cds/package.json</code>)</li>
<li>and <code>@cap-js/sqlite</code> (referenced in <code>package.json</code>)</li>
</ul>
<p>are indeed implemented ... as plugins!</p>
<p>And guess what? These are <em>exactly</em> those two listed when we ran <code>DEBUG=plugins cds watch</code>. Of course now that we've installed <code>@sap/cds</code> locally in the project, the implementation files are taken from there, within our project-local <code>node_modules/</code> directory, rather than from <code>@sap/cds-dk</code> in the global NPM modules directory:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">-</span>fiori<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@sap/cds-fiori/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>cap<span class="token operator">-</span>js<span class="token operator">/</span>sqlite<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@cap-js/sqlite/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded plugins in<span class="token operator">:</span> <span class="token number">35.172ms</span></code></pre>
<p><a name="creating-our-own-plugin-package"></a></p>
<h2 id="creating-our-own-plugin-package">Creating our own plugin package</h2>
<p>Now we know what we need -- a package with a <code>cds-plugin.js</code> file -- let's create one.</p>
<p>For convenience, we can use the <a href="https://docs.npmjs.com/cli/v7/using-npm/workspaces">workspaces concept in NPM</a> to create the plugin package locally but still &quot;require&quot; it via the normal <code>dependencies</code> route.</p>
<p>This is achieved as follows: <code>npm init -y --workspace loud</code>, which outputs something like this:</p>
<pre class="language-log" tabindex="0"><code class="language-log">Wrote to <span class="token file-path string">/workspaces/project/loud/package.json</span><span class="token operator">:</span>

<span class="token operator">{</span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"loud"</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string">"devDependencies"</span><span class="token operator">:</span> <span class="token operator">{</span><span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token operator">{</span>
    <span class="token string">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token operator">}</span><span class="token punctuation">,</span>
  <span class="token string">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span>
<span class="token operator">}</span>

added <span class="token number">1</span> package in <span class="token number">191ms</span></code></pre>
<p>And now that our plugin package exists in that workspace context, we can just add it as a dependency as normal, with:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">npm</span> <span class="token function">add</span> loud</code></pre>
<p>whereupon we see that this is now listed as normal in the <code>dependencies</code> section. Here's what the project's <code>package.json</code> content looks like now, with the addition of the <code>workspaces</code> section and the inclusion of the <code>loud</code> package reference in the <code>dependencies</code> section:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"plugins-deconstructed-starter"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"A minimal CAP starter project with a single services.cds file"</span><span class="token punctuation">,</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@sap/cds"</span><span class="token operator">:</span> <span class="token string">"^8"</span><span class="token punctuation">,</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4"</span><span class="token punctuation">,</span>
    <span class="token property">"loud"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@cap-js/sqlite"</span><span class="token operator">:</span> <span class="token string">"^1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"cds-serve"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"workspaces"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"loud"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p><a name="getting-the-plugin-to-announce-itself"></a></p>
<h1 id="getting-the-plugin-to-announce-itself">Getting the plugin to announce itself</h1>
<p>OK, before bringing this first part to an end, we could at least get the plugin to announce itself. Right now the new plugin package exists and is wired up, but there's still no sign of it in the output when we run <code>DEBUG=plugins cds watch</code>:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">-</span>fiori<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@sap/cds-fiori/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>cap<span class="token operator">-</span>js<span class="token operator">/</span>sqlite<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@cap-js/sqlite/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded plugins in<span class="token operator">:</span> <span class="token number">26.998ms</span></code></pre>
<p>But having deconstructed the mechanism, we sort of know why this is now. It's because the &quot;fetch&quot; mechanism we saw earlier hasn't yet found a <code>cds-plugin.js</code> file. If we add one now with <code>touch loud/cds-plugin.js</code> while the CAP server is still running, we see this new log record in the output that tells us it's now getting loaded:</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin loud<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'loud/cds-plugin.js'</span> <span class="token operator">}</span></code></pre>
<p>But there's no implementation at all yet. For now, we'll just add &quot;<a href="https://podcasters.spotify.com/pod/show/tech-aloud/episodes/The-Simplest-Thing-that-Could-Possibly-Work--A-conversation-with-Ward-Cunningham--Part-V---Bill-Venners-e5dpts">the simplest thing that could possibly work</a>&quot; and add the usual CDS facade constant plus some log output, in <code>loud/cds-plugin.js</code>:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">const</span> cds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sap/cds'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> cds<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOUD'</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Starting up ...'</span><span class="token punctuation">)</span></code></pre>
<p>Now our plugin exists, is connected up, and announces itself!</p>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>sap<span class="token operator">/</span>cds<span class="token operator">-</span>fiori<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@sap/cds-fiori/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin loud<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'loud/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>LOUD<span class="token punctuation">]</span> <span class="token operator">-</span> Starting up <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loading plugin <span class="token operator">@</span>cap<span class="token operator">-</span>js<span class="token operator">/</span>sqlite<span class="token operator">:</span> <span class="token operator">{</span> impl<span class="token operator">:</span> <span class="token string">'node_modules/@cap-js/sqlite/cds-plugin.js'</span> <span class="token operator">}</span>
<span class="token punctuation">[</span>plugins<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">[</span>cds<span class="token punctuation">]</span> <span class="token operator">-</span> loaded plugins in<span class="token operator">:</span> <span class="token number">10.173ms</span></code></pre>
<p>That's it for part 1 of this series. In the next part, we'll head back to the REPL and explore the service, and what it contains (entities, with their elements), dynamically, while the server is running, using introspection. That way we can work out what we will need for our plugin code.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2024/09/30/tasc-notes-part-1/">TASC Notes - Part 1</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/10/26/immutable-layers-file-deletion-and-image-size-in-docker/">Immutable layers, file deletion and image size in Docker</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2024/10/05/cap-node-js-plugins-part-1-how-things-work/` was built on 2025-10-09T12:27:12.731Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
