<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2024/11/04/separating-concerns-and-focusing-on-the-important-stuff/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.fe6b9c1e7ba4ff2bb7b5.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Separating concerns and focusing on the important stuff | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Separating concerns and focusing on the important stuff"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2024/11/04/separating-concerns-and-focusing-on-the-important-stuff/"><meta name="description" content="Separating concerns and focusing on the important stuff 04 Nov 2024 | 6 min read The phrase &amp;quot;separation of concerns&amp;quot; is one that I..."><meta property="og:description" content="Separating concerns and focusing on the important stuff 04 Nov 2024 | 6 min read The phrase &amp;quot;separation of concerns&amp;quot; is one that I..."><meta name="description" content="Separating concerns and focusing on the important stuff 04 Nov 2024 | 6 min read The phrase &amp;quot;separation of concerns&amp;quot; is one that I..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Separating concerns and focusing on the important stuff</h1><div class="post__details"><time datetime="2024-11-04">04 Nov 2024 </time><span>| </span><span>6 min read</span></div></header><main class="post__content"><p>The phrase &quot;separation of concerns&quot; is one that I hear relatively often, but have never until now stopped to think properly about what it is, what it means. It's a concept discrete and important enough to have <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">its own Wikipedia page</a>, but ultimately simple enough to understand in an instant. It's all about modularity, separating code (be that imperative code in a regular language, or declarative code such as we find in our CDS models) into distinct sections, each of which addresses a separate &quot;concern&quot;, i.e. serves a separate purpose.</p><p>CDL<a href="#footnotes"><sup>1</sup></a>, CAP's definition language for modelling, is one which embraces, facilitates, even encourages the adoption of this &quot;separation of concerns&quot; approach. In <a href="https://www.youtube.com/watch?v=XMchiFnDJ6E">the inaugural episode of The Art &amp; Science of CAP</a>, Daniel explains how <a href="https://cap.cloud.sap/docs/cds/cdl#aspects">aspects</a> plays a major role in this enablement, and in doing so, elevates the critical task of domain modelling to one that can proceed with the minimum of distraction.</p><p>What does that mean? Well, as expounded upon in <a href="/blog/posts/2024/11/02/keeping-things-simple-in-domain-modelling-with-cds/">Keeping things simple in domain modelling with CDS</a>, domain modelling at its best has a couple of key components:</p><ul><li>a domain expert</li><li>a focus on what's important (i.e. the domain being modelled)</li></ul><p>If the domain being modelled is what's important, what's <em>not</em> of primary importance here? Well, this sort of stuff:</p><ul><li>basic change tracking</li><li>authorisation concepts</li><li>managing data privacy</li><li>annotations for providing information to UIs</li></ul><p>and more.</p><h2>Using aspects</h2><p>How do aspects help here? The classic bookshop domain model has a perfect example:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> { managed } <span class="token from keyword">from</span> '@sap/cds/common';<br><br><span class="token keyword">entity</span> Books : managed {<br>  <span class="token cqlkeywords keyword">key</span> ID   : <span class="token type builtin">Integer</span>;<br>  title    : <span class="token type builtin">String</span>;<br>}</code></pre><p>The use of the <code>managed</code> aspect to bring basic change tracking, in the form of <a href="https://cap.cloud.sap/docs/guides/domain-modeling#managed-data">managed data</a>, to an entity. Blink and you've missed it. And that's the point.</p><p>Instead of &quot;polluting&quot; the definition of the <code>Books</code> entity with annotations and elements for basic change tracking, like this:</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">entity</span> Books : managed {<br>  <span class="token cqlkeywords keyword">key</span> ID     : <span class="token type builtin">Integer</span>;<br>  title      : <span class="token type builtin">String</span>;<br>  createdAt  : <span class="token type builtin">Timestamp </span><span class="token annotation important">@cds.on.insert:</span> $now;<br>  createdBy  : User      <span class="token annotation important">@cds.on.insert:</span> $user;<br>  modifiedAt : <span class="token type builtin">Timestamp </span><span class="token annotation important">@cds.on.insert:</span> $now  <span class="token annotation important">@cds.on.update:</span> $now;<br>  modifiedBy : User      <span class="token annotation important">@cds.on.insert:</span> $user <span class="token annotation important">@cds.on.update:</span> $user;<br>}</code></pre><p>we can factor the noise out by using an aspect, and there's a standard <a href="https://cap.cloud.sap/docs/guides/domain-modeling#aspect-managed"><code>managed</code> aspect</a>, imported from <code>@sap/cds/common</code>, that we can employ with the minimum of distraction by simply using the <code>:</code> syntax when defining the entity (<code>entity Books : managed { ... }</code>). Think of <code>:</code> here as meaning &quot;inherits from&quot;.</p><p>Using an aspect like this allows us to avoid unnecessary clutter in our domain model, and to separate the concern of basic change tracking to somewhere else (we don't really care at this point, all we do care is that it's &quot;not here&quot;). This helps us to stay focused on what's important - the books and other core entities that make up the domain.</p><h2>Separation all the way down</h2><p>What's really fascinating is that this separation of concerns goes deeper than one might at first think. While the <code>managed</code> aspect is the single word that hides away what we need for basic change tracking (the <code>createdAt</code>, <code>createdBy</code>, <code>modifiedAt</code> and <code>modifiedBy</code> elements, along with the <code>@cds.on.insert</code> and <code>@cds.on.update</code> annotations that are declared directly with those elements) ... there is a second level of separation of concerns going on underneath too.</p><p>To illustrate - if we dive into <a href="https://www.npmjs.com/package/@sap/cds?activeTab=code">the source of</a> <code>@sap/cds/common</code>, we see not only the definition of <code>managed</code>:</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">aspect</span> managed {<br>  createdAt  : <span class="token type builtin">Timestamp </span><span class="token annotation important">@cds.on.insert</span> : $now;<br>  createdBy  : User      <span class="token annotation important">@cds.on.insert</span> : $user;<br>  modifiedAt : <span class="token type builtin">Timestamp </span><span class="token annotation important">@cds.on.insert</span> : $now  <span class="token annotation important">@cds.on.update</span> : $now;<br>  modifiedBy : User      <span class="token annotation important">@cds.on.insert</span> : $user <span class="token annotation important">@cds.on.update</span> : $user;<br>}</code></pre><p>but also that there are annotations for that <code>managed</code> aspect ... that are themselves separated out to different areas of the <code>@sap/cds/common</code> resource<a href="#footnotes"><sup>2</sup></a>!</p><pre class="language-cds"><code class="language-cds"><span class="token single-line-comment comment">// Annotations for Fiori UIs...</span><br><br>annotate managed with {<br>  createdAt  <span class="token annotation important">@UI.HiddenFilter</span> <span class="token annotation important">@UI.ExcludeFromNavigationContext;</span><br>  createdBy  <span class="token annotation important">@UI.HiddenFilter</span> <span class="token annotation important">@UI.ExcludeFromNavigationContext;</span><br>  modifiedAt <span class="token annotation important">@UI.HiddenFilter</span> <span class="token annotation important">@UI.ExcludeFromNavigationContext;</span><br>  modifiedBy <span class="token annotation important">@UI.HiddenFilter</span> <span class="token annotation important">@UI.ExcludeFromNavigationContext;</span><br>}<br><br>annotate managed with {<br>  createdAt  <span class="token annotation important">@Core.Immutable;</span><br>  createdBy  <span class="token annotation important">@Core.Immutable;</span><br>}<br><br><span class="token single-line-comment comment">// ...</span><br><br><span class="token single-line-comment comment">// Common Annotations...</span><br><br>annotate managed with {<br>  createdAt  <span class="token annotation important">@title</span> : '{i18n>CreatedAt}';<br>  createdBy  <span class="token annotation important">@title</span> : '{i18n>CreatedBy}';<br>  modifiedAt <span class="token annotation important">@title</span> : '{i18n>ChangedAt}';<br>  modifiedBy <span class="token annotation important">@title</span> : '{i18n>ChangedBy}';<br>}<br><br><span class="token single-line-comment comment">// ...</span><br><br><span class="token single-line-comment comment">// Temporary Workarounds...</span><br><br>annotate managed with {<br>  modifiedAt <span class="token annotation important">@readonly;</span><br>  createdAt  <span class="token annotation important">@readonly;</span><br>  createdBy  <span class="token annotation important">@readonly;</span><br>  modifiedBy <span class="token annotation important">@readonly;</span><br>}</code></pre><h2>Service definitions</h2><p>Service definitions are also a way to separate out concerns. At the <code>db/</code> layer we define our data model. In a separate layer, traditionally in <code>srv/</code> (via CAP's convention over configuration), we describe how the outside world can interact with the data model (in both directions). We define interfaces.</p><p>So in this concern, i.e. in a separate file where we declare <code>service</code> definitions, we can focus for example on who gets to access what, according to their roles. This access is predicated upon the definition of <a href="/blog/posts/2024/11/03/restricting-access-via-facets-with-masked-elements/">facets</a> that are further refined by the signature and also access control list (ACL) style annotations.</p><p>And here again, around 48 mins in to the episode, Daniel shows yet another instance where aspects<a href="#footnotes"><sup>3</sup></a> are used to separate out concerns, in that the <code>TravelService</code> service is <em>relatively</em> simple, but is further annotated in separate files.</p><p>Here's what the <code>TravelService</code> definition looks like at this point, in <code>srv/travel-service.cds</code>:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> { sap.fe.cap.travel <span class="token cqlkeywords keyword">as</span> my } <span class="token from keyword">from</span> '../db/schema';<br><br><span class="token keyword">service</span> TravelService <span class="token annotation important">@(path:'/processor')</span> {<br><br>  <span class="token annotation important">@(restrict:</span> [<br>    { grant: 'READ', to: 'authenticated-user' },<br>    { grant: ['rejectTravel','acceptTravel','deductDiscount'], to: 'reviewer' },<br>    { grant: ['*'], to: 'processor' },<br>    { grant: ['*'], to: 'admin' }<br>  ])<br>  <span class="token keyword">entity</span> Travel <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Travel <span class="token keyword">actions</span> {<br>    <span class="token keyword">action</span> createTravelByTemplate() <span class="token cdl-keyword keyword">returns</span> Travel;<br>    <span class="token keyword">action</span> rejectTravel();<br>    <span class="token keyword">action</span> acceptTravel();<br>    <span class="token keyword">action</span> deductDiscount( percent: Percentage not null ) <span class="token cdl-keyword keyword">returns</span> Travel;<br>  };<br>}<br><br><span class="token cqlkeywords keyword">type</span> Percentage : <span class="token type builtin">Integer </span><span class="token annotation important">@assert.range:</span> [1,100];</code></pre><p>This is (almost) as straightforward and focused as it can get. Why? Because annotations belonging to a separate concern, are stored separately in other files, such as <code>srv/labels.cds</code>, <code>srv/value-helps.cds</code> and even <code>app/travel_processor/field-controls.cds</code>.</p><p>The magic of CAP's convention over configuration and how the CDS compiler pulls in resources (files) for the effective CDS model means that this loosely coupled approach to telling the story of the model in different chapters, only one of which is &quot;visible&quot; or &quot;in focus&quot; at a time, works very well.</p><h2>Easy refactoring</h2><p>The relaxed nature of iterating on the eventual CDS model with CDL means that it's simple and also zero cost to refactor; it's easy to work towards separated concerns and a stronger focus on what's relevant at any given time.</p><p>We see an example of this around 43 mins in, where Daniel moved the still-remaining &quot;noisy&quot; access control annotation that sat alongside the definition of the <code>TravelService</code> (visible above, specifically the <code>@(restrict: [ ... ])</code> annotation) into a separate file <code>srv/access-control.cds</code>, like this:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> { TravelService } <span class="token from keyword">from</span> './travel-<span class="token keyword">service</span>';<br><br>annotate TravelService.Travel with <span class="token annotation important">@(restrict:</span> [<br>  { grant: 'READ', to: 'authenticated-user' },<br>  { grant: ['rejectTravel','acceptTravel','deductDiscount'], to: 'reviewer' },<br>  { grant: ['*'], to: 'processor' },<br>  { grant: ['*'], to: 'admin' }<br>])</code></pre><p>This leaves the content of <code>srv/travel-service.cds</code> much cleaner and more focused (especially for the domain expert):</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> { sap.fe.cap.travel <span class="token cqlkeywords keyword">as</span> my } <span class="token from keyword">from</span> '../db/schema';<br><br><span class="token keyword">service</span> TravelService <span class="token annotation important">@(path:'/processor')</span> {<br><br>  <span class="token keyword">entity</span> Travel <span class="token cqlkeywords keyword">as</span> <span class="token cdl-keyword keyword">projection</span> <span class="token cqlkeywords keyword">on</span> my.Travel <span class="token keyword">actions</span> {<br>    <span class="token keyword">action</span> createTravelByTemplate() <span class="token cdl-keyword keyword">returns</span> Travel;<br>    <span class="token keyword">action</span> rejectTravel();<br>    <span class="token keyword">action</span> acceptTravel();<br>    <span class="token keyword">action</span> deductDiscount( percent: Percentage not null ) <span class="token cdl-keyword keyword">returns</span> Travel;<br>  };<br>}<br><br><span class="token cqlkeywords keyword">type</span> Percentage : <span class="token type builtin">Integer </span><span class="token annotation important">@assert.range:</span> [1,100];</code></pre><p>Moreover, it's possibly that different project team members might be responsible for different concerns, and if one of those concerns is determining the overall access strategy, having this annotation in a separate file makes things a lot easier and less prone to inadvertent cross-concern changes!</p><h2>Empty aspects</h2><p>What blew my mind a little was how similar annotations and aspects are to each other, effectively. At around 45 mins in, Daniel illustrated this by changing the content of the new <code>srv/access-control.cds</code> from containing an <code>annotation</code> of the <code>TravelService.Travel</code> entity which we see above, into a new named ... and <em>empty</em> ... <code>aspect</code>:</p><pre class="language-cds"><code class="language-cds"><span class="token using keyword">using</span> { TravelService } <span class="token from keyword">from</span> './travel-<span class="token keyword">service</span>';<br><br><span class="token keyword">aspect</span> ACL4Travels <span class="token annotation important">@(restrict:</span> [<br>  { grant: 'READ', to: 'authenticated-user' },<br>  { grant: ['rejectTravel','acceptTravel','deductDiscount'], to: 'reviewer' },<br>  { grant: ['*'], to: 'processor' },<br>  { grant: ['*'], to: 'admin' }<br>]) {}</code></pre><p>The subtlety of this empty <code>aspect</code> definition (<code>{}</code>) matches the sheer beauty and flexibility that this illustrates.</p><p>And the cherry on top is how this is then used to bring about the same effect with <code>TravelService.Travel</code>, i.e. the use of the <code>extend</code> keyword:</p><pre class="language-cds"><code class="language-cds"><span class="token keyword">extend</span> TravelService.Travel with ACL4Travels;</code></pre><h2>Wrapping up</h2><p>The take-away here for me is that CDS (and by inference CDL) is designed in such a way as to be as loose, relaxing and as flexible as possible, with features (and, in a way, a deliberate lack of features) primarily focused on the prize - the best modelling of the domain, and the best facilitation of that modelling process with the people who matter. The domain experts, the security experts, the API experts, and everyone else on the team who, separately and together work towards building what's needed. Nothing more and nothing less.</p><p><a name="footnotes"></a></p><h2>Footnotes</h2><ol><li>For many reasons, all of them understandable, most folks refer to the modelling language as &quot;CDS&quot;. Technically speaking, the language is <a href="https://cap.cloud.sap/docs/cds/cdl">CDL</a>, one of a handful of domain specific languages (DSLs) in the <a href="https://cap.cloud.sap/docs/cds">CDS family</a>.</li><li>It's straightforward to discover the effective definition of elements of something like this <code>managed</code> aspect, with all the annotations here, by asking the CDS compiler to produce the canonical notation (<a href="https://cap.cloud.sap/docs/cds/csn">CSN</a>) in a JSON representation and then just pulling out one of the elements, like this:</li></ol><pre class="language-shell"><code class="language-shell">$ cds compile db/schema.cds <span class="token parameter variable">--to</span> json <span class="token punctuation">\</span><br>  <span class="token operator">|</span> jq <span class="token string">'.definitions.Books.elements.createdAt'</span><br><span class="token punctuation">{</span><br>  <span class="token string">"@cds.on.insert"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><br>    <span class="token string">"="</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$now</span>"</span><br>  <span class="token punctuation">}</span>,<br>  <span class="token string">"@UI.HiddenFilter"</span><span class="token builtin class-name">:</span> true,<br>  <span class="token string">"@UI.ExcludeFromNavigationContext"</span><span class="token builtin class-name">:</span> true,<br>  <span class="token string">"@Core.Immutable"</span><span class="token builtin class-name">:</span> true,<br>  <span class="token string">"@title"</span><span class="token builtin class-name">:</span> <span class="token string">"{i18n>CreatedAt}"</span>,<br>  <span class="token string">"@readonly"</span><span class="token builtin class-name">:</span> true,<br>  <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"cds.Timestamp"</span><br><span class="token punctuation">}</span></code></pre><ol start="3"><li>Think of annotations as aspects too - as is illustrated in the &quot;Empty aspects&quot; section.</li></ol></main><aside class="post__aside"><div class="post__tags"><a href="/tags/cds/">#cds</a> <a href="/tags/cap/">#cap</a> <a href="/tags/tasc/">#tasc</a> <a href="/tags/gems/">#gems</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2024/11/07/five-reasons-to-use-cap/"><span>←</span> <span>Five reasons to use CAP</span> </a><a href="/blog/posts/2024/11/03/restricting-access-via-facets-with-masked-elements/"><span>Restricting access via facets with masked elements</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>