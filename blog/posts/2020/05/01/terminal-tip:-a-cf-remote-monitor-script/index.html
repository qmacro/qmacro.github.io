<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2020/05/01/terminal-tip:-a-cf-remote-monitor-script/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Terminal Tip: a CF remote monitor script | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Terminal Tip: a CF remote monitor script"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2020/05/01/terminal-tip:-a-cf-remote-monitor-script/"><meta name="description" content="Terminal Tip: a CF remote monitor script 01 May 2020 | 3 min read In the previous terminal tip (remotely monitor a CF deployment) we saw the..."><meta property="og:description" content="Terminal Tip: a CF remote monitor script 01 May 2020 | 3 min read In the previous terminal tip (remotely monitor a CF deployment) we saw the..."><meta name="description" content="Terminal Tip: a CF remote monitor script 01 May 2020 | 3 min read In the previous terminal tip (remotely monitor a CF deployment) we saw the..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Terminal Tip: a CF remote monitor script</h1><div class="post__details"><time datetime="2020-05-01">01 May 2020 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>In the previous terminal tip (<a href="/blog/posts/2020/04/24/terminal-tip:-remotely-monitor-a-cf-deployment/">remotely monitor a CF deployment</a>) we saw the building blocks of how we might go about finding and then remotely monitoring an ongoing multi-target application (MTA) operation.</p><p>On today's <a href="https://bit.ly/handsonsapdev">#HandsOnSAPDev</a> live stream, <a href="https://bit.ly/handsonsapdev#ep66">Ep.66</a>, we wrote a script <code>mtaopsmon</code> that put these building blocks together (check out the section of <a href="https://youtu.be/mP1iWZgNmsE?t=895">the replay starting at around 14:55</a>). I thought it would be worth sharing that script here, and explaining it bit by bit.</p><p>First, let's see the script in its entirety:</p><pre class="language-shell"><code class="language-shell"><span class="token shebang important">#!/usr/bin/env bash</span><br><br><span class="token function-name function">getopsid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cf mta-ops <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'1,3d'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>                                                                   <br><br><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> Searching <span class="token keyword">for</span> MTA operation<br><br><span class="token assign-left variable">mtaopid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>getopsid<span class="token variable">)</span></span><br><br><span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${mtaopsid}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><br><span class="token keyword">do</span><br>  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token builtin class-name">.</span><br>  <span class="token function">sleep</span> <span class="token number">1</span><br>  <span class="token assign-left variable">mtaopsid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>getopsid<span class="token variable">)</span></span><br><span class="token keyword">done</span><br><br><span class="token builtin class-name">echo</span><br><span class="token builtin class-name">echo</span> MTA operation found: <span class="token variable">${mtaopsid}</span><br><br>cf deploy <span class="token parameter variable">-i</span> <span class="token variable">${mtaopsid}</span> <span class="token parameter variable">-a</span> monitor</code></pre><p>Now let's take it a step at a time.</p><h2>Step 1 - Defining a function to get an MTA operation ID</h2><p>The first line looks like this:</p><pre class="language-shell"><code class="language-shell"><span class="token function-name function">getopsid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cf mta-ops <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'1,3d'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>                                                                   </code></pre><p>Here we're defining a function <code>getopsid</code> that contains way to try and grab the ID of an MTA operation. This is deliberately over simplified but works for our purposes, and is a good start.</p><p>If you consider what the output of <code>cf mta-ops</code> gives for when there's an operation (or more than one), it looks like this:</p><pre class="language-log"><code class="language-log">Getting active multi<span class="token operator">-</span>target app operations in org p200135114trial <span class="token operator">/</span> space dev as qmacro<span class="token operator">+</span>workflowcodejam<span class="token operator">@</span>example<span class="token punctuation">.</span>com<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>OK<br>id                                     type     mta id                  status    started at                      started by<br><span class="token uuid constant">acb3bcda-8b7b-11ea-bb72-eeee0a890182</span>   DEPLOY   <span class="token domain constant">sample.onboarding.mta</span>   RUNNING   <span class="token date number">2020-05-01T</span><span class="token time number">07:16:28.294Z</span><span class="token punctuation">[</span>UTC<span class="token punctuation">]</span>   <span class="token email url">qmacro+workflowcodejam@example.com</span></code></pre><p>There's a couple of descriptive lines (&quot;Getting ...&quot; and &quot;OK&quot;), followed by a column header line (&quot;id ...&quot;) and then a line with the details of an operation, where the first column is the operation's ID (&quot;acb3...&quot;).</p><p>If you consider what the output looks like when there are no operations, it looks like this:</p><pre class="language-log"><code class="language-log">Getting active multi<span class="token operator">-</span>target app operations in org p200135114trial <span class="token operator">/</span> space dev as qmacro<span class="token operator">+</span>workflowcodejam<span class="token operator">@</span>example<span class="token punctuation">.</span>com<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>OK<br>No multi<span class="token operator">-</span>target app operations found</code></pre><p>Now we know what the two possible outputs look like, we can stare at the first line of our script and understand what <code>getopsid</code> does. It calls <code>cf mta-ops</code>, and pipes the output into <code>sed '1,3d</code>', which will simply delete the first three lines. Whatever then remains is either nothing (there are only three lines when there are no MTA operations) or a list of operation details:</p><pre class="language-log"><code class="language-log"><span class="token uuid constant">acb3bcda-8b7b-11ea-bb72-eeee0a890182</span>   DEPLOY   <span class="token domain constant">sample.onboarding.mta</span>   RUNNING   <span class="token date number">2020-05-01T</span><span class="token time number">07:16:28.294Z</span><span class="token punctuation">[</span>UTC<span class="token punctuation">]</span>   <span class="token email url">qmacro+workflowcodejam@example.com</span></code></pre><p>To keep things simple in this case, we're just going to take the first operation, in case there are more, and so we pipe the remaining line(s) into <code>head -1</code> which will just give us the first line.</p><p>Finally, we pipe that line into <code>awk '{print $1}'</code> which will return just the first &quot;field&quot;, i.e. the operation ID (&quot;acb3...&quot;).</p><p>So basically, calling this function <code>getopsid</code> will return either an operation ID, or nothing.</p><h2>Step 2 - Looping until we get an MTA operation ID</h2><p>Here's the next part:</p><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> Searching <span class="token keyword">for</span> MTA operation<br><br><span class="token assign-left variable">mtaopid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>getopsid<span class="token variable">)</span></span><br><br><span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${mtaopsid}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><br><span class="token keyword">do</span><br>  <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token builtin class-name">.</span><br>  <span class="token function">sleep</span> <span class="token number">1</span><br>  <span class="token assign-left variable">mtaopsid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>getopsid<span class="token variable">)</span></span><br><span class="token keyword">done</span></code></pre><p>After printing out &quot;Searching for MTA operation&quot;, without a newline (that's what the <code>-n</code> option to <code>echo</code> means), we call <code>getopsid</code> and assign whatever it returns to the <code>mtaopid</code> variable, which will therefore contain an ID, or nothing.</p><p>Then we loop around, as long as the <code>-z ${mtaopsid}</code> condition is true, i.e. for as long as there's no value in the <code>mtaopsid</code> variable. Inside the loop, we print a &quot;.&quot; character, sleep for a second, and then call the <code>getopsid</code> function again.</p><p>This will run therefore until we get an MTA operation ID.</p><h2>Step 3 - Attaching to and monitoring the MTA operation</h2><p>Once we have an MTA operation ID, we can use the technique we learned about in <a href="https://blogs.sap.com/2020/04/24/terminal-tip-remotely-monitor-a-cf-deployment/">the previous terminal tip</a> to attach to an ongoing operation, and call the 'monitor' action upon it:</p><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">echo</span><br><span class="token builtin class-name">echo</span> MTA operation found: <span class="token variable">${mtaopsid}</span><br><br>cf deploy <span class="token parameter variable">-i</span> <span class="token variable">${mtaopsid}</span> <span class="token parameter variable">-a</span> monitor</code></pre><p>And that's it!</p><p>Here's an example of the script in action, showing a few lines from the log output. To take this screenshot, I started the <code>mtaopsmon</code> script up, then switched over to the SAP Web IDE to deploy the &quot;sample.onboarding.mta&quot; MTA that I'd previously built.</p><p><img src="/images/2020/05/Screenshot-2020-05-01-at-09.58.19.png" alt=""></p><h2>Next steps</h2><p>Of course, the function that gets the MTA operation ID is deliberately very simple at this stage (we wrote the script together during the live stream). Have a think about how you could improve that - what would happen (and what would we want to do) if there were multiple operations? Let me know your thoughts in the comments, and until next time ...</p><p>Share &amp; enjoy, and remember, <a href="https://twitter.com/search?q=%23TheFutureIsTerminal&amp;src=typed_query">#TheFutureIsTerminal</a>!</p><hr><p><a href="https://community.sap.com/t5/technology-blogs-by-sap/terminal-tip-a-cf-remote-monitor-script/ba-p/13429781">Originally published on SAP Community</a></p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/sapcommunity/">#sapcommunity</a> <a href="/tags/terminal/">#terminal</a> <a href="/tags/terminaltip/">#terminaltip</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2020/05/26/sap-community-coding-challenge-2-update/"><span>←</span> <span>SAP Community Coding Challenge 2 - Update</span> </a><a href="/blog/posts/2020/04/27/sap-community-coding-challenge-nr.2/"><span>SAP Community Coding Challenge Nr.2</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>