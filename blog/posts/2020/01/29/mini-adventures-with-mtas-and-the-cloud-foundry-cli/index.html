<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2020/01/29/mini-adventures-with-mtas-and-the-cloud-foundry-cli/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.7884d8f8e9dd86c3b137.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Mini adventures with MTAs and the Cloud Foundry CLI | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Mini adventures with MTAs and the Cloud Foundry CLI"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2020/01/29/mini-adventures-with-mtas-and-the-cloud-foundry-cli/"><meta name="description" content="Mini adventures with MTAs and the Cloud Foundry CLI 29 Jan 2020 | 5 min read A few more small adventures using the cf command line client,..."><meta property="og:description" content="Mini adventures with MTAs and the Cloud Foundry CLI 29 Jan 2020 | 5 min read A few more small adventures using the cf command line client,..."><meta name="description" content="Mini adventures with MTAs and the Cloud Foundry CLI 29 Jan 2020 | 5 min read A few more small adventures using the cf command line client,..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Mini adventures with MTAs and the Cloud Foundry CLI</h1><div class="post__details"><time datetime="2020-01-29">29 Jan 2020 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p><em>A few more small adventures using the cf command line client, as well as some shell pipeline goodness and that nifty tip from Marius Obert about radically reducing the size of your deployment archive.</em></p><p>Further to my blog post yesterday on <a href="/blog/posts/2020/01/28/scripting-cloud-foundry-activities-in-trial/">scripting Cloud Foundry activities</a> I extended my experiments into using the <code>cf</code> command line interface (CLI) tool to quickly remove the Business Rules Editor app and supporting services.</p><p>Along the way I tweaked a couple of existing command pipelines to display the lists of services and apps on Cloud Foundry (CF), and tried out Marius Obert's <a href="https://twitter.com/IObert_/status/1220321066029142018">great tip</a> on reducing the size of your deployment archive.</p><p><a name="tldr"></a></p><h2>TL;DR</h2><p>If you're like me, and want (in the immortal words of Boycie in the Only Fools And Horses episode &quot;Chain Gang&quot;) to &quot;<a href="https://www.youtube.com/watch?v=WcrsW8CAC5s">let the dog see the rabbit</a>&quot; to see what this is all about, you can watch this little Asciinema recording of what I describe in the rest of this post.</p><p><a href="https://asciinema.org/a/296532"><img src="https://asciinema.org/a/296532.svg" alt=""></a></p><p>Still around and want the nitty-gritty? Read on!</p><h2>The app and supporting services</h2><p>The Business Rules Editor runs in a space in my CF org connected to my SAP Cloud Platform (SCP) trial subaccount. There's the app itself (which is actually just an approuter fronting the actual editor app artifacts) named <code>businessruleseditor_appRouter</code>.</p><p>This app is bound to service instances, thus:</p><ul><li>an instance of the 'business-rules' service called <code>businessrules</code> that I created shortly after re-creating my SCP subaccount and CF org and space</li><li>an instance of the 'xsuaa' service called <code>businessrules_uaa</code></li><li>an instance of the 'html5-apps-repo' service (to serve the actual app artifacts) called <code>businessruleseditor_html5_repo_runtime</code></li></ul><h2>Checking the running app and services</h2><p>At the start, the app is running, along with the bound services. I check this with the <code>cf</code> command line client, combined with a bit of shell pipeline to massage the output. The output from <code>cf</code> is relatively messy and <a href="https://github.com/cloudfoundry/cli/issues/604#issuecomment-562571995">harder than it should be to parse</a> (yes, there's the <code>cf curl</code> approach but that's a sledgehammer solution to a problem that should be addressed with better text-based output), so I have to pass it through some classic Unix command line tools to get what I want.</p><p>For parsing and displaying service information, I have a small shell script <code>service_status</code>, which looks like this:</p><pre class="language-shell"><code class="language-shell">cf s<br><span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'/^OK$/d'</span><br><span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'NR>3 { printf "%s ", $1; $1=$2=$3=$NF=""; printf "\n%s\n\n", $0 }'</span><br><span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{$1=$1};1'</span></code></pre><p>This runs the 'cf s' command to retrieve the service information. The output from 'cf s' looks like this:</p><pre class="language-shell"><code class="language-shell">Getting services <span class="token keyword">in</span> org I347491trial_qmacrosubdomain / space dev as dj.adams@sap.com<span class="token punctuation">..</span>.<br><br>name                                     <span class="token function">service</span>           plan          bound apps                      last operation     broker                                                       upgrade available<br>businessrules                            business-rules    lite          businessruleseditor_appRouter   create succeeded   sm-businessrules-e73ec4d2-a715-4849-a5e9-77b521e7a086<br>businessrules_uaa                        xsuaa             application   businessruleseditor_appRouter   create succeeded   sm-xsuaa-9ef36350-f975-4194-a399-54db361e79b5<br>businessruleseditor_html5_repo_runtime   html5-apps-repo   app-runtime   businessruleseditor_appRouter   create succeeded   sm-html5-apps-repo-sb-ebcb2b69-24a5-408e-be00-02066b302b78</code></pre><p>You might think that looks quite neat, but don't be deceived - if there are no bound apps, the column is empty, which makes parsing of the output more unpredictable that it should be (why can't something like 'none' be emitted for this column so it has a consistent value?). Moreover, the contents of the column showing the last operation is also unpredictable, in that the value or values can contain spaces, which makes text-based parsing harder than it should be.</p><p>Anyway, before I go on a mini-rant about this, let me explain what I do to reduce this output down to the essentials.</p><p>The second line of the <code>service_status</code> script removes any line that is simply 'OK'. When retrieving the app information (with <code>cf a</code>) you get an 'OK', but when retrieving service information, you don't. Again, unpredictable. So let's just get rid of it anyway.</p><p>The third line uses the venerable <a href="https://en.wikipedia.org/wiki/AWK">awk</a> language to print the first column of the actual output, which is a single value on each line (in this case 'businessrules', 'businessrules_uaa' and 'businessruleseditor_html5_repo_runtime'). With 'NR&gt;3' it skips over the first three lines of output so that only the actual service lines are processed.</p><p>Finally, the last line uses <code>awk</code> again to strip spaces from the start and end of the lines.</p><p>So running this script produces this output:</p><pre class="language-log"><code class="language-log">businessrules<br>businessruleseditor_appRouter create succeeded<br><br>businessrules_uaa<br>businessruleseditor_appRouter create succeeded<br><br>businessruleseditor_html5_repo_runtime<br>businessruleseditor_appRouter create succeeded</code></pre><p>This is much nicer and what I want for a display in my terminal. Note that I take advantage of the poor formatting from the output of <code>cf s</code> by (inadvertently) grabbing the value of the 'bound apps' column if it contains values. This is what the output looks like when the services have just been created but before they've been bound to the <code>businessruleseditor_appRouter</code> app:</p><pre class="language-log"><code class="language-log">businessrules<br>create succeeded<br><br>businessrules_uaa<br>create succeeded<br><br>businessruleseditor_html5_repo_runtime<br>create succeeded</code></pre><p>I have another script to display the apps information, called <code>app_status</code>, which looks very similar:</p><pre class="language-shell"><code class="language-shell">cf a<br><span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'/^OK$/d'</span><br><span class="token operator">|</span> a<span class="token variable"><span class="token variable">`</span>k <span class="token string">'NR>3 { printf "%s\n%s\n\n", $1, $2 }'</span><br><span class="token operator">|</span> a<span class="token variable">`</span></span>k <span class="token string">'{$1=$1};1'</span></code></pre><p>There's just a bit of difference in the main <code>awk</code> invocation - I simply want to print the first and second columns, on separate lines. Here's what the output looks like when the 'businessruleseditor_appRouter' app is running:</p><pre class="language-log"><code class="language-log">businessruleseditor_appRouter<br>started</code></pre><p>I use the terminal multiplexor app '<a href="https://en.wikipedia.org/wiki/Tmux">tmux</a>' to manage individual windows and panes (sub-windows) in my terminal, and divide up the space to show the output of my <code>service_status</code> and <code>app_status</code> scripts in separate areas. The output is always up-to-date as I drive the execution of these scripts with the excellent '<a href="https://en.wikipedia.org/wiki/Watch_(Unix)">watch</a>' command, which by default will re-execute the specified script every 2 seconds.</p><p>This is what it looks like in action:</p><p><img src="/images/2020/01/Screenshot-2020-01-29-at-10.22.42.png" alt=""></p><h2>Removing the app and supporting services</h2><p>I wanted to remove the running app and the services it was bound directly to, i.e. the <code>businessrules_uaa</code> and <code>businessruleseditor_html5_repo_runtime</code> services. Of course, I could have simply used a combination of the <code>cf delete</code> and <code>cf delete-service</code> commands (<code>cf d</code> and <code>cf ds</code> in short form). But there's a neater way, with '<a href="https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/fab96a603a004bd992822c83d4b01370.html">cf undeploy</a>'.</p><p>The <code>cf undeploy</code> command requires the MTA ID, which can be retrieved with the 'cf mtas' command, which shows output like this:</p><pre class="language-log"><code class="language-log">Getting multi<span class="token operator">-</span>target apps in org I347491trial_qmacrosubdomain <span class="token operator">/</span> space dev as dj<span class="token punctuation">.</span>adams<span class="token operator">@</span>sap<span class="token punctuation">.</span>com<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>OK<br>mta id                version<br>businessruleseditor   <span class="token number">0.0.1</span></code></pre><p>In this case, the ID is <code>businessruleseditor</code>.</p><p>Now I can use the <code>cf undeploy</code>, along with the <code>-delete-services</code> option, to clean out exactly the right parts, in the right order, too. If there's any issue with deleting services, there's a number of times the operation will be retried, too:</p><pre class="language-shell"><code class="language-shell">cf undeploy businessruleseditor -delete-services <span class="token parameter variable">-f</span></code></pre><p>This is what the output looks like:</p><pre class="language-log"><code class="language-log">Undeploying multi<span class="token operator">-</span>target app businessruleseditor in org I347491trial_qmacrosubdomain <span class="token operator">/</span> space dev as dj<span class="token punctuation">.</span>adams<span class="token operator">@</span>sap<span class="token punctuation">.</span>com<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Detected deployed MTA with ID <span class="token string">"businessruleseditor"</span> and version <span class="token string">"0.0.1"</span><br>Deleting routes for application <span class="token string">"businessruleseditor_appRouter"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Deleting route <span class="token string">"i347491trial-qmacrosubdomain-dev-businessruleseditor-approuter.cfapps.eu10.hana.ondemand.com"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Stopping application <span class="token string">"businessruleseditor_appRouter"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Deleting application <span class="token string">"businessruleseditor_appRouter"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Deleting service <span class="token string">"businessrules_uaa"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>Deleting service <span class="token string">"businessruleseditor_html5_repo_runtime"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><span class="token property">Error deleting services:</span> Error deleting service <span class="token string">"businessruleseditor_html5_repo_runtime"</span> from offering <span class="token string">"html5-apps-repo"</span> and plan <span class="token string">"app-runtime"</span><span class="token operator">:</span> Service broker operation failed<span class="token operator">:</span> <span class="token number">502</span> Bad Gateway<span class="token operator">:</span> CF<span class="token operator">-</span>ServiceBrokerBadResponse<span class="token operator">(</span><span class="token number">10001</span><span class="token operator">)</span><span class="token operator">:</span> Service instance businessruleseditor_html5_repo_runtime<span class="token operator">:</span> Service broker error<span class="token operator">:</span> Service broker html5<span class="token operator">-</span>apps<span class="token operator">-</span>repo<span class="token operator">-</span>sb failed with<span class="token operator">:</span> Internal Server Error<br>Proceeding with automatic retry<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">(</span><span class="token number">3</span> of <span class="token number">3</span> attempts left<span class="token operator">)</span><br>Services <span class="token string">"[businessrules_uaa]"</span> are already deleted<br>Deleting service <span class="token string">"businessruleseditor_html5_repo_runtime"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><span class="token number">1</span> of <span class="token number">1</span> done<br>Process finished<span class="token punctuation">.</span><br>Use <span class="token string">"cf dmol -i aad5f179-4286-11ea-be81-eeee0a930fbf"</span> to download the logs of the process<span class="token punctuation">.</span></code></pre><h2>Redeploying, with a reduced size MTA archive</h2><p>When I'm ready to redeploy I can do so, following the flow I described in yesterday's post &quot;<a href="/blog/posts/2020/01/28/scripting-cloud-foundry-activities-in-trial/">Scripting Cloud Foundry activities in trial</a>&quot;.</p><p>However, there's a <a href="https://twitter.com/IObert_/status/1220321066029142018">lovely bit of advice</a> from my friend and colleague mariusobert that can be used to reduce the size of the MTA deployment archive. Shown in a <a href="https://gist.github.com/IObert/220cb211a63a4030c25b31d912243d6a">Gist</a>, there's a '<a href="https://gist.github.com/IObert/220cb211a63a4030c25b31d912243d6a#file-mta-yaml-L18-L19">build-parameters' setting</a> that can be added to a module definition, so that the <code>node_modules/</code> directory, which is often the bulk of the archive, can be omitted (it will be created in the cloud once deployed). This is what the parameter looks like:</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">build-parameters</span><span class="token punctuation">:</span><br>  <span class="token key atrule">ignore</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules/"</span><span class="token punctuation">]</span></code></pre><p>Adding this to the definition of the <code>businessruleseditor_appRouter</code> module (effectively the definition for the app itself) like this, greatly reduces the archive file size.</p><pre class="language-yaml"><code class="language-yaml"> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> businessruleseditor_appRouter<br>   <span class="token key atrule">type</span><span class="token punctuation">:</span> approuter.nodejs<br>   <span class="token key atrule">path</span><span class="token punctuation">:</span> businessruleseditor_appRouter<br>   <span class="token key atrule">parameters</span><span class="token punctuation">:</span><br>      <span class="token key atrule">disk-quota</span><span class="token punctuation">:</span> 256M<br>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256M<br>   <span class="token key atrule">build-parameters</span><span class="token punctuation">:</span><br>       <span class="token key atrule">ignore</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules/"</span><span class="token punctuation">]</span><br>   <span class="token key atrule">requires</span><span class="token punctuation">:</span><br>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> businessruleseditor_html5_repo_runtime<br>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> businessrules_uaa<br>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> businessrules</code></pre><p>Without this setting, the size of the <code>businessruleseditor_0.0.1.mtar</code> archive is 12 megabytes:</p><pre class="language-shell"><code class="language-shell">-<span class="token operator">></span> <span class="token function">ls</span> <span class="token parameter variable">-l</span> --block-size<span class="token operator">=</span>M mta_archives/<br>total 12M<br>-rw-r--r-- <span class="token number">1</span> qmacro qmacro 12M Jan <span class="token number">29</span> <span class="token number">11</span>:09 businessruleseditor_0.0.1.mtar</code></pre><p>With this setting, the size is only 17 kilobytes!</p><pre class="language-shell"><code class="language-shell">-<span class="token operator">></span> <span class="token function">ls</span> <span class="token parameter variable">-l</span> --block-size<span class="token operator">=</span>K mta_archives/<br>total 20K<br>-rw-r--r-- <span class="token number">1</span> qmacro qmacro 17K Jan <span class="token number">29</span> <span class="token number">11</span>:13 businessruleseditor_0.0.1.mtar</code></pre><p>As a bonus, the build is slightly quicker, and the deploy is definitely quicker!</p><p>Take a look at the Asciinema recording (<a href="#tldr">above</a>) to see this in action - where you can also see the appearance of the binding information in the service output, as the app is created and bindings are made.</p><h2>Wrapping up</h2><p>When I started hacking around with the <code>cf</code> command earlier this morning, I didn't intend to write a blog post, but I thought it was worthwhile in the end to share some of my learnings. I hope you found it interesting - and more importantly, I'd love to know what sort of automation and convenience tools you have set up for yourself. Let me know in the comments. And as always, happy hacking!</p><hr><p><a href="https://community.sap.com/t5/technology-blogs-by-sap/mini-adventures-with-mtas-and-the-cloud-foundry-cli/ba-p/13439593">Originally published on SAP Community</a></p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/sapcommunity/">#sapcommunity</a> <a href="/tags/cloudfoundry/">#cloudfoundry</a> <a href="/tags/cli/">#cli</a> <a href="/tags/businessrules/">#businessrules</a> <a href="/tags/cf/">#cf</a> <a href="/tags/mtar/">#mtar</a> <a href="/tags/awk/">#awk</a> <a href="/tags/onlyfoolsandhorses/">#onlyfoolsandhorses</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2020/03/22/brambleweeny-cluster-experiments/"><span>←</span> <span>Brambleweeny Cluster Experiments</span> </a><a href="/blog/posts/2020/01/28/scripting-cloud-foundry-activities-in-trial/"><span>Scripting Cloud Foundry activities in trial</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>