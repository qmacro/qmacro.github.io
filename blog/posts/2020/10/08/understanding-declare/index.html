<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2020/10/08/understanding-declare/"><link rel="alternate" type="application/rss+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.4654d4542dcb045c9ba3.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Understanding declare | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Understanding declare"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2020/10/08/understanding-declare/"><meta name="description" content="Understanding declare 08 Oct 2020 | 5 min read I&#39;ve been looking into declare, and also how it compares to typeset and local. It turns out..."><meta property="og:description" content="Understanding declare 08 Oct 2020 | 5 min read I&#39;ve been looking into declare, and also how it compares to typeset and local. It turns out..."><meta name="description" content="Understanding declare 08 Oct 2020 | 5 min read I&#39;ve been looking into declare, and also how it compares to typeset and local. It turns out..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/talks">Talks</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Understanding declare</h1><div class="post__details"><time datetime="2020-10-08">08 Oct 2020 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p><em>I've been looking into declare, and also how it compares to typeset and local. It turns out that there's a lot to know.</em></p><p>After working my way through the small <code>ix</code> script in <a href="https://rwx.gg">Mr Rob</a>'s <a href="https://gitlab.com/rwxrob/dotfiles/-/tree/master">dotfiles</a>, writing three posts <a href="/autodidactics/2020/10/03/using-exec-to-jump/">Using exec to jump</a>, <a href="/autodidactics/2020/10/04/curl-and-multipart-form-data/">curl and multipart/form-data</a> and <a href="/autodidactics/2020/10/04/check-command-available/">Checking a command is available before use</a> along the way, I've now turned my attention to the <a href="https://gitlab.com/rwxrob/dotfiles/-/blob/master/scripts/twitch"><code>twitch</code></a> script which he uses during his <a href="twitch.tv/rwxrob">live streams</a>. I haven't gone very far when I light upon this section:</p><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">declare</span> <span class="token assign-left variable">gold</span><span class="token operator">=</span><span class="token string">$'<span class="token entity" title="\033">\033</span>[38;2;184;138;0m'</span><br><span class="token builtin class-name">declare</span> <span class="token assign-left variable">red</span><span class="token operator">=</span><span class="token string">$'<span class="token entity" title="\033">\033</span>[38;2;255;0;0m'</span><br><span class="token punctuation">..</span>.</code></pre><p>So <code>declare</code> is a keyword that I've seen before but never fully understood or embraced. Seems like this is a good time to fix that.</p><p><strong>Declare is a builtin</strong></p><p>To start off, <code>declare</code> is a <a href="https://tldp.org/LDP/abs/html/internal.html#BUILTINREF">builtin</a>, which means that rather than an external executable (such as <code>echo</code>, or even <code>[</code>), it's part of the Bash runtime itself, as we can see thus:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> strings <span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> <span class="token function">bash</span><span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token builtin class-name">declare</span><br><span class="token builtin class-name">declare</span> -%s %s<span class="token operator">=</span>%s<br><span class="token builtin class-name">declare</span><br><span class="token builtin class-name">declare</span> <span class="token punctuation">[</span>-aAfFgilnrtux<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p<span class="token punctuation">]</span> <span class="token punctuation">[</span>name<span class="token punctuation">[</span><span class="token operator">=</span>value<span class="token punctuation">]</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span><br>    When used <span class="token keyword">in</span> a function, <span class="token variable"><span class="token variable">`</span>declare' makes NAMEs local, as with the <span class="token variable">`</span></span><span class="token builtin class-name">local</span><span class="token string">'<br>    A synonym for `declare'</span><span class="token builtin class-name">.</span>  See <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">help</span> declare'.<br>    be any option accepted by <span class="token variable">`</span></span>declare'.<br><span class="token builtin class-name">declare</span> -%s</code></pre><p>(If you're curious about <code>[</code> being an external executable, you might be interested in another post: <a href="https://qmacro.org/autodidactics/2020/08/21/open-square-bracket/">The open square bracket [ is an executable</a>.)</p><p><strong>The <code>typeset</code> synonym</strong></p><p>First off, let's deal with the <code>declare</code> vs <code>typeset</code> question. Basically, <code>typeset</code> does in the Korn shell (ksh) pretty much what <code>declare</code> does in the Bash shell. And <code>typeset</code> has been added to Bash as a synonym for <code>declare</code>, to make it easier for developers to switch between the flavours. There are other synonyms relating to <code>declare</code>, but we'll come to those in a bit.</p><p><strong>Basics of <code>declare</code></strong></p><p>Next, let's deal with the question: &quot;But why is declare used here at all?&quot;. Well, in <a href="https://gitlab.com/rwxrob/dotfiles/-/blob/master/scripts/twitch#L29-36">this particular case</a> it's not absolutely necessary. Strings and array variables don't actually need to be declared, so this would be fine, too:</p><pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">gold</span><span class="token operator">=</span><span class="token string">$'<span class="token entity" title="\033">\033</span>[38;2;184;138;0m'</span><br><span class="token assign-left variable">red</span><span class="token operator">=</span><span class="token string">$'<span class="token entity" title="\033">\033</span>[38;2;255;0;0m'</span><br><span class="token punctuation">..</span>.</code></pre><p>This would be a couple of simple assignments of values to (otherwise) previously undeclared variables. On the other hand, with the <code>declare</code> variant, subtly different, we're declaring a couple of variables and also making assignments at the same time, which <code>declare</code> permits us to do.</p><p><strong>The <code>local</code> synonym</strong></p><p>Of course, the main point of <code>declare</code> is to declare variables and state certain attributes that they are to have. We haven't seen an example of that yet, but before we do, there's another subtle difference between <code>declare var=value</code> and simply <code>var=value</code>. This is briefly covered in a paragraph of the help information (run <code>help declare</code> in a Bash shell):</p><p><em>When used in a function, <code>declare</code> makes NAMEs local, as with the <code>local</code> command. The <code>-g</code> option suppresses this behavior.</em></p><p>So <code>local</code> is our next synonym for <code>declare</code>, in the context a function definition. An example script <code>foo</code> will help:</p><pre class="language-bash"><code class="language-bash"><span class="token function-name function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin class-name">local</span> var1<br>  <span class="token assign-left variable">var1</span><span class="token operator">=</span><span class="token string">"Apple"</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"func1: <span class="token variable">$var1</span>"</span><br><span class="token punctuation">}</span><br><br><span class="token function-name function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin class-name">declare</span> var1<br>  <span class="token assign-left variable">var1</span><span class="token operator">=</span><span class="token string">"Banana"</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"func2: <span class="token variable">$var1</span>"</span><br><span class="token punctuation">}</span><br><br><span class="token function-name function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token assign-left variable">var1</span><span class="token operator">=</span><span class="token string">"Carrot"</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"func3: <span class="token variable">$var1</span>"</span><br><span class="token punctuation">}</span><br><br><span class="token assign-left variable">var1</span><span class="token operator">=</span><span class="token string">"Main"</span><br><span class="token builtin class-name">echo</span> <span class="token string">"var1 is <span class="token variable">$var1</span>"</span><br>func1<br><span class="token builtin class-name">echo</span> <span class="token string">"var1 is <span class="token variable">$var1</span>"</span><br>func2<br><span class="token builtin class-name">echo</span> <span class="token string">"var1 is <span class="token variable">$var1</span>"</span><br>func3<br><span class="token builtin class-name">echo</span> <span class="token string">"var1 is <span class="token variable">$var1</span>"</span></code></pre><p>Let's look at what we get when this script is executed:</p><pre><code>&gt; bash ./foo
var1 is Main
func1: Apple
var1 is Main
func2: Banana
var1 is Main
func3: Carrot
var1 is Carrot
</code></pre><p>The thing to spot here is that because neither <code>local</code> nor <code>declare</code> were used for <code>var1</code> in the definition of the <code>func3</code> function, the assignment of the value <code>Carrot</code> was not restricted to the scope of that function, and when back in the main part of the script, the value of <code>var1</code> has the value that it was assigned within <code>func3</code>, i.e. <code>Carrot</code>, not <code>Main</code> any more.</p><p><strong>Options for <code>declare</code></strong></p><p>Of course, given the main purpose of <code>declare</code>, it's worth briefly looking at more specific uses. There are various options, adequately covered by various sources including <a href="https://tldp.org/LDP/abs/html/declareref.html">Advanced Bash-Scripting Guide - Chapter 9: Another Look at Variables</a>, and so only summarised here:</p><p>|-|-| |<code>-r</code>|Read-only| |<code>-i</code>|Integer| |<code>-a</code>|Array| |<code>-A</code>|Associative array (i.e. a dictionary, or object)| |<code>-f</code>|Function| |<code>-x</code>|Exported| |<code>-g</code>|Global|</p><p>There are other options, but these are the most common, at least as far as I've found in my research. Others are covered in the <code>help declare</code> output.</p><p><strong>The <code>readonly</code> synonym</strong></p><p>The <code>-r</code> option for <code>declare</code> has a sort of synonym too, which is <code>readonly</code>. However, there's a difference relating to scope; while <code>declare -r</code> will use function-local scope (similar to how it was used in <code>func1</code> and <code>func2</code> earlier), <code>readonly</code> will not respect that and simply use the global scope, even inside functions.</p><p>In other words, if you were to add another function definition to the above <code>foo</code> script example, like this:</p><pre class="language-bash"><code class="language-bash"><span class="token function-name function">func4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin class-name">readonly</span> var1<br>  <span class="token assign-left variable">var1</span><span class="token operator">=</span><span class="token string">"Damson"</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"func4: <span class="token variable">$var1</span>"</span><br><span class="token punctuation">}</span></code></pre><p>... then when <code>func4</code> had been executed, the value of <code>var1</code> in the main section of the script would then also be <code>Damson</code>.</p><p>Using <code>declare -r</code> here instead is the safer approach, in that the local function scope is respected. Note however that if we add <code>-g</code> (denoting the &quot;global&quot; attribute) to this, i.e. use <code>declare -r -g</code> or <code>declare -rg</code>, then the effect would be the same as using <code>readonly</code>.</p><p><strong>The <code>export</code> synonym and what <code>-x</code> implies</strong></p><p>There's one final synonym I found in this journey of discovery, and that's <code>export</code>, which is the equivalent of <code>declare -x</code>. It took me a few minutes to properly think about what this &quot;available for export&quot; attribute actually implies.</p><p>Like me, you've most probably used <code>export</code> in your <code>.bashrc</code> file, to set &quot;global&quot; variables when your shell session starts, to be available to you in that session and in executables that you invoke there. Usually these variable names will be in upper case by convention, denoting variables that are &quot;environment&quot; wide. In your shell, you can use <code>env</code> to see what these are. Note that the list that <code>env</code> produces includes variables automatically available to you in the shell too, such as <code>HOME</code> and <code>PATH</code>.</p><p>So what does <code>declare -x</code> imply, in the context of a script that you might write and then invoke? It does not mean that once the script finishes, that variable will be available to you in the shell. As an example, consider this script <code>bar</code>:</p><pre><code>declare -x var2=&quot;Raining&quot;
echo &quot;var2 is $var2&quot;
</code></pre><p>When we run this, look at what we get:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$var2</span>"</span> <span class="token comment"># nothing up my sleeve</span><br><br><span class="token operator">></span> ./bar<br>var2 is Raining<br><span class="token operator">></span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$var2</span>"</span><br><br><span class="token operator">></span></code></pre><p>But what if we also had another script <code>baz</code>:</p><pre><code>echo &quot;In baz: var2 is $var2&quot;
</code></pre><p>and we invoked it from within the <code>bar</code> script:</p><pre><code>declare -x var2=&quot;Raining&quot;
echo &quot;var2 is $var2&quot;
./baz
</code></pre><p>You can guess what the output will be:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> ./bar<br>var2 is Raining<br>In baz: var2 is Raining</code></pre><p>And on returning to the shell prompt, we can double check that <code>var2</code> doesn't have a value:</p><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$var2</span>"</span><br><br><span class="token operator">></span></code></pre><p>The way I think about this in my mind is like a tree structure:</p><pre><code>shell
 |
 +-- bar        &lt;- var2 declared with -x as 'exported'
      |
      +-- baz   &lt;- var2 available here too
</code></pre><p>Exporting descends, rather than ascends, so there's no way <code>var2</code> could ever be made available like this in the <code>shell</code>.</p><p>That's about it, I think. I hope this is useful; I have found it helpful to try and explain these concepts to you, as it helps me learn. In researching, I came across some content in Stack Overflow and Stack Exchange - so thanks to those folks who took the time to explain things there. You may want to reference them too:</p><ul><li><a href="https://unix.stackexchange.com/questions/254367/in-bash-scripting-whats-the-different-between-declare-and-a-normal-variable">In bash scripting, what's the different between declare and a normal variable?</a></li><li><a href="https://stackoverflow.com/questions/4419704/differences-between-declare-typeset-and-local-variable-in-bash">Differences between declare, typeset and local variable in Bash</a></li><li><a href="https://stackoverflow.com/questions/30362831/what-is-difference-in-declare-r-and-readonly-in-bash">what is difference in <code>declare -r</code> and <code>readonly</code> in bash?</a></li></ul></main><aside class="post__aside"><div class="post__tags"><a href="/tags/autodidactics/">#autodidactics</a> <a href="/tags/shell/">#shell</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2020/10/11/middollar-and-shell-parameter-expansion/"><span>←</span> <span>MID$ and shell parameter expansion</span> </a><a href="/blog/posts/2020/10/06/desnowballification-with-set-o-errexit/"><span>Desnowballification with set -o errexit</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>