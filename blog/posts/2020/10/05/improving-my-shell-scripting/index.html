<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Improving my shell scripting</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="Improving my shell scripting">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Reserving the right to be wrong.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2020/10/05/improving-my-shell-scripting/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="improving-my-shell-scripting">Improving my shell scripting</h1>

<ul class="post-metadata">
	<li><time datetime="2020-10-05">05 October 2020</time></li>
</ul>

<p class="post-description-main"></p>

<p><em>I'm using a style guide along with the <code>shellcheck</code> and <code>shfmt</code> tools to help me improve the quality and consistency of my shell scripts.</em></p>
<p>I'm doubling down on shell scripting, in particular Bash shell scripting. This is for many reasons, not least because I think that in the age of cloud and containers, shell environments are more important than ever. And what better shell than the Unix style shell; the design dates back decades but is still in my eyes one of the most wondrous things in tech even today, with its beautiful simplicity and its <a href="https://en.wikipedia.org/wiki/Unix_philosophy#:~:text=The%20Unix%20philosophy%20is%20documented,%2C%20as%20yet%20unknown%2C%20program.">simple beauty</a>.</p>
<p><strong>Style Guide</strong></p>
<p>While watching a live stream replay by <a href="https://rwx.gg">Mr Rob</a>, specifically <a href="https://www.youtube.com/watch?v=UGCw6wXv1Ao">Google Shell Scripting Guide, Yes, Yes, 1000 Times Yes!</a>, I came across the <a href="https://google.github.io/styleguide/shellguide.html">Google Shell Style Guide</a> and it's succinct enough to digest in a single sitting, and well written enough to comprehend in that time, too.</p>
<p>I've decided to use this style guide as a general reference for my scripts and plan to implement changes to some of my existing scripts over time.</p>
<p><strong>Shellcheck</strong></p>
<p>I discovered the <a href="https://github.com/koalaman/shellcheck"><code>shellcheck</code></a> shell script analysis tool recently and my goodness me has it made a significant impact on not only the quality of what I write, but also on my understanding of Bash shell syntax! It's available as an online tool, but far more importantly as a command line tool that will highlight issues with your shell code. A linter, basically.</p>
<p>Moreover, it has a rich set of reference material in the <a href="https://github.com/koalaman/shellcheck/wiki">wiki</a>, including definitive pages for each of the errors it will emit. Here's an example: SC1019 is the error code for &quot;Expected this to be an argument to the unary condition&quot; and there's a reference page for it here: <a href="https://github.com/koalaman/shellcheck/wiki/SC1019">SC1019</a>.</p>
<p>I use Vim as my primary editing environment and use the <a href="https://github.com/dense-analysis/ale">Asynchronous Linting Engine</a> (ALE) as a key plugin. This means, that without me lifting a finger, <code>shellcheck</code> will be used asynchronously, live while I'm editing, to show me issues.</p>
<p>If you're writing shell scripts, get <code>shellcheck</code> installed and wired up to your editor now.</p>
<p><strong>shfmt</strong></p>
<p>My son Joseph used to write a lot of Go, and I was fascinated by the philosophy of what the <a href="https://golang.org/cmd/gofmt/"><code>gofmt</code></a> formatting tool represented. Go programmers all expected code to be formatted the same way via this tool, and it's natural for them to have their code (re)formatted when they save it in the editor. I know that this is anathema to some programmers, which is why it caught my eye.</p>
<p>There are formatters for other languages that work this way now (and I'm sure there were before, too) such as <code>rustfmt</code> (used by Mr Rob, which is what gave me the idea) and there's a version for shell scripts called <a href="https://github.com/mvdan/sh"><code>shfmt</code></a>, described as &quot;a shell parser, formatter and interpreter&quot;.</p>
<p>Having experimented with the <code>shfmt</code> options, I ended up choosing a few that would help me stay close to the style guide:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-i 2</code></td>
<td>indent with two spaces</td>
</tr>
<tr>
<td><code>-bn</code></td>
<td>binary ops like &amp;&amp; and | may start a line</td>
</tr>
<tr>
<td><code>-ci</code></td>
<td>switch cases will be indented</td>
</tr>
<tr>
<td><code>-sr</code></td>
<td>redirect operators will be followed by a space</td>
</tr>
</tbody>
</table>
<p>I <a href="https://github.com/qmacro/dotfiles/commit/1581496cdc2a51b0bcdda525a7f06dc11129abb1">added some new configuration</a> to tell Vim to use this <code>shfmt</code> tool with these options, to automatically format any shell source on save.  This means that I can get my script content automatically formatted without thinking about it, in the same way Go programmers enjoy.</p>
<p>This is what that configuration addition looks like right now:</p>
<pre class="language-vim" tabindex="0"><code class="language-vim"><span class="token keyword">fun</span><span class="token operator">!</span> s<span class="token punctuation">:</span><span class="token function">FormatBashScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=~#</span> <span class="token string">'^#!.*bash'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">executable</span><span class="token punctuation">(</span><span class="token string">'shfmt'</span><span class="token punctuation">)</span>
    <span class="token operator">%</span><span class="token operator">!</span>shfmt <span class="token operator">-</span>i <span class="token number">2</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token operator">-</span><span class="token builtin">ci</span> <span class="token operator">-</span><span class="token builtin">sr</span> <span class="token operator">-</span>
  <span class="token keyword">endif</span>
<span class="token keyword">endfun</span>
<span class="token builtin">autocmd</span> BufWritePre <span class="token operator">*</span> <span class="token keyword">call</span> s<span class="token punctuation">:</span><span class="token function">FormatBashScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>The reference to <code>getline</code> is to check that the <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a> denotes a Bash shell script and the reference to <code>executable</code> prevents errors occurring if I'm on a machine where <code>shfmt</code> is not available. The key part is this: <code>%!shfmt ...</code> which passes the entire buffer contents through the invocation of <code>shfmt</code> as if it were a filter, replacing the contents with whatever <code>shfmt</code> outputs.</p>
<p>I guess it almost goes without saying that the significance of how this works -- using <code>shfmt</code> as a filter to pass the content through, via STDIN and STDOUT, following one of the key Unix shell philosophies -- is not lost on me.</p>
<p>And remember folks, <a href="https://twitter.com/search?q=%23TheFutureIsTerminal&amp;src=typed_query">#TheFutureIsTerminal!</a></p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2020/10/04/curl-and-multipart-form-data/">curl and multipart/form-data</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2020/10/06/desnowballification-with-set-o-errexit/">Desnowballification with set -o errexit</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2020/10/05/improving-my-shell-scripting/` was built on 2026-01-12T15:45:53.976Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
