<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Using the docker CLI in a container on macOS</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="using-the-docker-cli-in-a-container-on-macos">Using the docker CLI in a container on macOS</h1>

<ul class="post-metadata">
	<li><time datetime="2023-12-22">22 December 2023</time></li>
	<li><a href="/tags/macos/" class="post-tag">macos</a>, </li>
	<li><a href="/tags/docker/" class="post-tag">docker</a>, </li>
	<li><a href="/tags/containers/" class="post-tag">containers</a></li>
</ul>

<p class="post-description-main"></p>

<p>In this post I explain what I've done to be able to use the Docker client CLI from within a container on my macOS device.</p>
<h2 id="dev-containers">Dev containers</h2>
<p>I use dev containers everywhere. I hardly ever work outside of a container on, say, my work laptop (a 2022 Apple MacBook Air M2). Instead, I do everything, or as much as I can, in dev containers.</p>
<p>I'm a command line kind of person, happiest and most productive in a terminal session running the Bash shell, but despite that, I haven't installed any CLI tools locally, not even Homebrew. Heck, I haven't even taken the time to fix the issue with macOS shipping with the zsh as default these days. For me, the host OS is secondary.</p>
<h2 id="running-the-docker-cli">Running the docker CLI</h2>
<p>I've found that the only commands I issue in the shell on my laptop's OS have been <code>docker</code> commands, to build, start, stop and generally manage my images and containers. I've done this outside my normal dev container based working environments partly because sometimes I have to recreate those working environments, and partly because access to the Docker engine itself (via Docker Desktop) is, at least on a macOS device, a little difficult.</p>
<p>That's because of how Docker is provided on macOS (and Windows) machines generally, which is in a Linux virtual machine. While it's possible to, say, create a bind mount, connecting the Docker engine socket exposed from that VM on the macOS host OS at <code>/var/run/docker.sock</code> to a container, it's fraught with difficulties and I've really only had success when the user inside the container is <code>root</code>. It's all to do with permissions combined with the extra layer of indirection brought about by the fact that the Docker engine is actually running in a Linux VM rather than natively on the macOS host.</p>
<p>From a productivity perspective the &quot;last mile&quot; for me is to be able to do more with Docker from within my dev containers. In other words, run the <code>docker</code> client command, which of course needs to be connected to the Docker engine, and I think I've found a solution that feels clean to me, and doesn't involve bind mounting <code>/var/run/docker.sock</code> nor trying to hammer permissions into shape with a big mallet.</p>
<h2 id="the-solution">The solution</h2>
<p>While it may not be the most compact approach, it works for me, and is also teaching me more about topics I want to dig deeper into anyway, including Docker networking and container-to-container communication.</p>
<p>The solution is based on some great tips from Ákos Takács in one of a myriad discussions on the interwebs about the very problem I've described: <a href="https://forums.docker.com/t/permission-for-v-var-run-docker-sock/132976/4">Permission for -v /var/run/docker.sock</a>.</p>
<p>It involves running <a href="https://linux.die.net/man/1/socat">socat</a>. The man page describes it as <em>&quot;a command line based utility that establishes two bidirectional byte streams and transfers data between them. Because the streams can be constructed from a large set of different types of data sinks and sources (see address types), and because lots of address options may be applied to the streams, socat can be used for many different purposes&quot;</em>. In other words, a &quot;multipurpose relay&quot; or &quot;so[cket] cat&quot;.</p>
<p>In this case, <code>socat</code> is used to relay <code>/var/run/docker.sock</code>, which is the UNIX socket on which the Docker engine is listening, making it available via TCP.</p>
<p>That TCP availability, in the form of a <code>&lt;hostname&gt;:&lt;port&gt;</code> socket, is to be provided by a container running that <code>socat</code> process, in the context of a Docker bridge network, to which the dev container is also connected.</p>
<p>And through the magic of Docker networking, that TCP socket is then made available to the dev container, and being a TCP socket rather than a file-based UNIX one, we've moved away from any permissions issues. Moreover, that exposure is solely within that specific bridge network.</p>
<p>Here's what this solution looks like.</p>
<pre class="language-text" tabindex="0"><code class="language-text">+-------------------------------------------------host--+
|                                                       |
|       /var/run/docker.sock                            |
|              ^                                        |
|              |                                        |
|          bind mount                                   |
|              |                                        |
|     +--------|--------------------------devnet--+     |
|     |        |                                  |     |
|     |        v                                  |     |
|     |     +-----socat-+       +-------dev-+     |     |
|     |     |      3275 |-------|           |     |     |
|     |     |           |       |           |     |     |
|     |     |   socat   |       | tmux/bash |     |     |
|     |     |           |       |           |     |     |
|     |     | user:root |       | user:user |     |     |
|     |     +-----------+       +-----------+     |     |
|     |                                           |     |
|     +-------------------------------------------+     |
|                                                       |
+-------------------------------------------------------+</code></pre>
<p>Setting this up manually and step by step can help illustrate each component part.</p>
<h3 id="creating-the-network-devnet">Creating the network &quot;devnet&quot;</h3>
<p>Containers running in the same network can communicate with one another. Containers with names that have been specified explicitly can be reached via that name within the network that they share. This is a great combination of features that I can make use of.</p>
<p>I create a new network called &quot;devnet&quot; like this, being explicit about the type of network (which is default, but it doesn't harm to be explicit):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">docker</span> network create <span class="token parameter variable">--driver</span> bridge devnet
969a73295ceeedaf63848c5f7aa4993895a0893e3607e067af347eb3b2d83dc2</code></pre>
<p>Now I can see it in the list of all networks:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">docker</span> network <span class="token function">ls</span>
NETWORK ID     NAME      DRIVER    SCOPE
d8d6d3ae3737   bridge    bridge    <span class="token builtin class-name">local</span>
969a73295cee   devnet    bridge    <span class="token builtin class-name">local</span>
ee4841fdb953   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
b6ce4554097e   none      null      <span class="token builtin class-name">local</span></code></pre>
<p>So far so good.</p>
<h3 id="creating-the-socket-cat-service-socat">Creating the socket cat service &quot;socat&quot;</h3>
<p>Now for the container that will provide the <code>socat</code>-powered relay between the UNIX socket at <code>/var/run/docker.sock</code> on the host, and a TCP socket that will be available in the &quot;devnet&quot; network. There's <a href="https://github.com/alpine-docker/multi-arch-libs/tree/master/socat">an Alpine based container</a> that is perfect for this.</p>
<p>The key aspects of this container are that it should:</p>
<ul>
<li>run in the &quot;devnet&quot; network</li>
<li>use the default (i.e. root) user</li>
<li>have a bind mount to the UNIX socket</li>
<li>relay that socket to TCP port 2375</li>
</ul>
<p>I'll give this container the name &quot;socat&quot;, and conjure it up like this:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">docker</span> run <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> socat <span class="token punctuation">\</span>
  <span class="token parameter variable">--network</span> devnet <span class="token punctuation">\</span>
  <span class="token parameter variable">--volume</span> /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
  <span class="token parameter variable">--detach</span> <span class="token punctuation">\</span>
  alpine/socat tcp-listen:2375,fork,reuseaddr unix-connect:/var/run/docker.sock
5c3f153671e7b292e156bd5a5de9c5539aad544c2eea6466303a1623584d4a66</code></pre>
<p>Great. At this point, I have the socket relay mechanism running, and within the &quot;devnet&quot; bridge network, that relay's TCP endpoint is available at <code>socat:2375</code>. Note that it's not generally available at the host level, which is a good thing of course; running <code>netstat -atn | grep 2375</code> gives no output.</p>
<h3 id="creating-the-dev-container-dev">Creating the dev container &quot;dev&quot;</h3>
<p>Now all I need to do is to start up an instance of my dev container image (which I've <a href="https://github.com/qmacro/exploring-neovim/blob/main/Dockerfile">recently been revamping</a>, and the image name is currently &quot;newdev&quot;). There are a few things to note about my dev container:</p>
<ul>
<li>I run with user &quot;user&quot;, rather than root</li>
<li>There's some work data on the file system that I bind mount</li>
<li>I expose a couple of ports, so I can connect to services running there from my browser running on the host (4004 for <a href="https://cap.cloud.sap">CAP</a> and 8000 for the local instance of <a href="https://github.com/qmacro/qmacro.github.io">this Eleventy-based blogging system</a>)</li>
</ul>
<p>Now I have the <code>docker</code> client CLI in my dev container, I want to use it to connect to the Docker engine.</p>
<p>But rather than try to connect to it via a bind mount to the <code>/var/run/docker.sock</code> directly, with all the difficulties that entails, I can now connect to it via a TCP socket, specifically the one that my &quot;socat&quot; container is now making available to other containers in the &quot;devnet&quot; bridge network.</p>
<p>The simplest way to make this default in the dev container is to set the <code>DOCKER_HOST</code> environment variable to that socket address (<code>socat:2375</code>) when I instantiate the container.</p>
<p>Here goes:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">$ <span class="token function">docker</span> run <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> dev <span class="token punctuation">\</span>
  <span class="token parameter variable">--network</span> devnet <span class="token punctuation">\</span>
  <span class="token parameter variable">--volume</span> <span class="token string">"<span class="token environment constant">$HOME</span>/work:/home/user/work"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--platform</span> linux/amd64 <span class="token punctuation">\</span>
  <span class="token parameter variable">--publish</span> <span class="token string">"4004:4004"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--publish</span> <span class="token string">"8000:8000"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--env</span> <span class="token assign-left variable">DOCKER_HOST</span><span class="token operator">=</span>socat:2375 <span class="token punctuation">\</span>
  <span class="token parameter variable">--tty</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--interactive</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--detach</span> <span class="token punctuation">\</span>
  newdev
3c39a1084871a5f26988d5ef0008dc3134c6313759600b45ef09f683bd251f57</code></pre>
<p>A couple of notes on two of the options used:</p>
<ul>
<li>I don't normally use the <code>--detach</code> option when starting my dev container, as I want to jump right into it, but I thought I'd use it here for consistency and also to help with the step by step approach</li>
<li>I'm currently building my dev container images with Rosetta, for reasons I'll go into another time, hence the use of <code>--platform linux/amd64</code></li>
</ul>
<h2 id="using-docker-from-within-the-dev-container">Using docker from within the dev container</h2>
<p>Now that I have everything set up, I can jump into my dev container and use the <code>docker</code> CLI as I would normally have had to do in the raw macOS host level context.</p>
<p>First, if I attach to the container, like this: <code>docker attach dev</code> I get my working environment, my PDE (<a href="https://www.youtube.com/watch?v=QMVIJhC9Veg">Personalised Development Environment</a>) of choice. My dev container, my home on this (and all other) hosts. It's basically <code>tmux</code>, and I use <code>bash</code> as my shell. Obviously.</p>
<p><img src="/images/2023/12/devcontainer.png" alt="Dev Container"></p>
<p>The dev container has all my tools installed, one of which is (now that I can more reliably and properly connect) <code>docker</code>. First, I can see that the environment variable <code>DOCKER_HOST</code> is set for me (thanks to the use of that <code>--env</code> option in the container setup):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> DOCKER
<span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">DOCKER_HOST</span><span class="token operator">=</span>socat:2375
<span class="token assign-left variable">DOCKER_CONFIG</span><span class="token operator">=</span>/home/user/.config/docker</code></pre>
<p>The <code>DOCKER_HOST</code> environment variable is related to the Docker context, which I could set with <a href="https://docs.docker.com/engine/reference/commandline/context_use/">docker context use</a> but I don't have to now that there's a value set for the variable.</p>
<p>So all my <code>docker</code> invocations will use the context <code>socat:2375</code> for where to connect.</p>
<p>And it works!</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> container <span class="token function">ls</span>
CONTAINER ID   IMAGE                 COMMAND                  CREATED          STATUS          PORTS                                            NAMES
3c39a1084871   newdev                <span class="token string">"tmux -u"</span>                <span class="token number">11</span> minutes ago   Up <span class="token number">11</span> minutes   <span class="token number">0.0</span>.0.0:4004-<span class="token operator">></span><span class="token number">4004</span>/tcp, <span class="token number">0.0</span>.0.0:8000-<span class="token operator">></span><span class="token number">8000</span>/tcp   dev
5c3f153671e7   alpine/socat          <span class="token string">"socat tcp-listen:23…"</span>   <span class="token number">50</span> minutes ago   Up <span class="token number">50</span> minutes                                                    socat</code></pre>
<p>And I can see that those two containers are indeed in the &quot;devnet&quot; network:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> network inspect devnet <span class="token operator">|</span> jq <span class="token string">'first | .Containers'</span>
<span class="token punctuation">{</span>
  <span class="token string">"34e1703d91894701f9de1211256e7157ef755f35d3884057163827d515b837be"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"dev"</span>,
    <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"a12669474c0bd39767a3dabadea0da8f0247f597f8d4dfa5458a344f933dcc47"</span>,
    <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:ac:1b:00:03"</span>,
    <span class="token string">"IPv4Address"</span><span class="token builtin class-name">:</span> <span class="token string">"172.27.0.3/16"</span>,
    <span class="token string">"IPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"5c3f153671e7b292e156bd5a5de9c5539aad544c2eea6466303a1623584d4a66"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"socat"</span>,
    <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"a83290a0970b04ea2a3257c2c4187413cc9b035589b2a0cc9927137be704325d"</span>,
    <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:ac:1b:00:02"</span>,
    <span class="token string">"IPv4Address"</span><span class="token builtin class-name">:</span> <span class="token string">"172.27.0.2/16"</span>,
    <span class="token string">"IPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>I did for a second want to check that my access wasn't read-only or something, but no - I can pull images and create new containers, of course, too:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> run hello-world
Unable to <span class="token function">find</span> image <span class="token string">'hello-world:latest'</span> locally
latest: Pulling from library/hello-world
478afc919002: Pull complete
Digest: sha256:ac69084025c660510933cca701f615283cdbb3aa0963188770b54c31c8962493
Status: Downloaded newer image <span class="token keyword">for</span> hello-world:latest

Hello from Docker<span class="token operator">!</span>
This message shows that your installation appears to be working <span class="token punctuation">..</span>.</code></pre>
<p>Not only that, but this <code>hello-world</code> experiment also lets me confirm one more thing - that containers created don't automatically somehow run in the &quot;devnet&quot; network, and indeed they don't (it wouldn't make sense if they did, but it's always nice to check):</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> container <span class="token function">ls</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--all</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--format</span> json <span class="token punctuation">\</span>
  <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'"\(.Names) (\(.Image))"'</span>
dev <span class="token punctuation">(</span>newdev<span class="token punctuation">)</span>
socat <span class="token punctuation">(</span>alpine/socat<span class="token punctuation">)</span>
priceless_cori <span class="token punctuation">(</span>hello-world<span class="token punctuation">)</span>
<span class="token punctuation">;</span> <span class="token function">docker</span> inspect dev socat priceless_cori <span class="token punctuation">\</span>
  <span class="token operator">|</span> jq <span class="token string">'map({(.Config.Image):.NetworkSettings.Networks|keys})|add'</span>
<span class="token punctuation">{</span>
  <span class="token string">"alpine/socat"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"devnet"</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"newdev"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"devnet"</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"hello-world"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"bridge"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="compose-all-the-things">Compose all the things</h2>
<p>Setting the network and containers up like this manually is great for a blog post like this, but I'd prefer something a little more automated and declarative. So here's a Docker compose file that sets up the same combination:</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">socat</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine/socat
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> socat
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span>  devnet
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'tcp-listen:2375,fork,reuseaddr unix-connect:/var/run/docker.sock'</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> root
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> bind
        <span class="token key atrule">source</span><span class="token punctuation">:</span> /var/run/docker.sock
        <span class="token key atrule">target</span><span class="token punctuation">:</span> /var/run/docker.sock
  <span class="token key atrule">dev</span><span class="token punctuation">:</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> socat
    <span class="token key atrule">image</span><span class="token punctuation">:</span> newdev
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span>  devnet
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> linux/amd64
    <span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'$HOME/work:/home/user/work'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'4004:4004'</span>
      <span class="token punctuation">-</span> <span class="token string">'8000:8000'</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">DOCKER_HOST</span><span class="token punctuation">:</span> <span class="token string">'socat:2375'</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">devnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> devnet
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge</code></pre>
<p>Now with a simple <code>docker compose up --detach</code> invocation, I can have everything up and running as before:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token function">docker</span> compose up <span class="token parameter variable">--detach</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">3</span>/3
 ✔ Network devnet   Created                                 <span class="token number">0</span>.0s
 ✔ Container socat  Started                                 <span class="token number">0</span>.0s
 ✔ Container dev    Started                                 <span class="token number">0</span>.0s</code></pre>
<p>And now I can attach to my dev container as before with <code>docker attach dev</code>.</p>
<p>Nice!</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2023/12/20/from-twitter-to-mastodon/">From Twitter to Mastodon</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2024/01/09/a-simple-jq-repl-with-tmux-bash-vim-and-entr/">A simple jq REPL with tmux, bash, vim and entr</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2023/12/22/using-the-docker-cli-in-a-container-on-macos/` was built on 2025-10-05T11:00:19.549Z -->
		<script type="module" src="/dist/BQdjwJXB4J.js"></script>
	</body>
</html>
