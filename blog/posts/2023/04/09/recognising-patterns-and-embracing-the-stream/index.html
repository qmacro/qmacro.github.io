<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2023/04/09/recognising-patterns-and-embracing-the-stream/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.4654d4542dcb045c9ba3.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Recognising patterns and embracing the stream | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Recognising patterns and embracing the stream"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2023/04/09/recognising-patterns-and-embracing-the-stream/"><meta name="description" content="Recognising patterns and embracing the stream 09 Apr 2023 | 3 min read I&#39;ve been listening to discussions on Conor Hoekstra&#39;s Array Cast..."><meta property="og:description" content="Recognising patterns and embracing the stream 09 Apr 2023 | 3 min read I&#39;ve been listening to discussions on Conor Hoekstra&#39;s Array Cast..."><meta name="description" content="Recognising patterns and embracing the stream 09 Apr 2023 | 3 min read I&#39;ve been listening to discussions on Conor Hoekstra&#39;s Array Cast..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Recognising patterns and embracing the stream</h1><div class="post__details"><time datetime="2023-04-09">09 Apr 2023 </time><span>| </span><span>3 min read</span></div></header><main class="post__content"><p>I've been listening to discussions on <a href="https://bird.makeup/@code_report">Conor Hoekstra</a>'s <a href="https://www.arraycast.com/episodes">Array Cast</a> podcast and <a href="https://t.co/uijuAszeFw">ADSP: The Podcast</a> and watching some of the content on <a href="https://www.youtube.com/@code_report">his YouTube channel</a>, all of which I can highly recommend. While I don't understand everything that's being discussed, I do still enjoy and benefit from the content. One of the many recurring themes seems to be recognising patterns, being aware of what is being expressed, and thinking about whether there's an alternative way to do so, for simplicity, clarity, performance or other reasons.</p><p>I was happy to be able to recognise a pattern in a tiny submission I made this evening to a repo of <a href="https://github.com/atejada/led_numbers#led_numbers">different language based implementations of a simple LED number display</a> from <a href="https://twitter.com/Blag">Blag</a>, an old friend of mine from the SAP world.</p><h2>The initial contribution</h2><p>I wanted to contribute a jq version of the LED number display program for the repo, as it didn't have one. The first commit in my pull request contained a working version, which was this:</p><pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">segments</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">"| |"</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"   "</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">" _|"</span><span class="token punctuation">,</span> <span class="token string">"|_ "</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">" _|"</span><span class="token punctuation">,</span> <span class="token string">" _|"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"   "</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">"|_ "</span><span class="token punctuation">,</span> <span class="token string">" _|"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">"   "</span><span class="token punctuation">,</span> <span class="token string">"|_ "</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token string">" _ "</span><span class="token punctuation">,</span> <span class="token string">"|_|"</span><span class="token punctuation">,</span> <span class="token string">"  |"</span><span class="token punctuation">]</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">def</span> <span class="token function">digits</span><span class="token punctuation">:</span> tostring <span class="token operator pipe">|</span> <span class="token c-style-function function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> tonumber<span class="token punctuation">;</span><br><br><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> transpose <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token c-style-function function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>This was to be invoked like this:</p><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">42</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token parameter variable">-f</span> led_numbers.jq</code></pre><p>which would produce:</p><pre class="language-text"><code class="language-text">    _<br>|_| _|<br>  ||_</code></pre><h2>An explanation</h2><p>By way of explanation, assuming we have the two function definitions (<code>segments</code> and <code>digits</code>) already, then:</p><pre class="language-jq"><code class="language-jq">segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span></code></pre><p>would produce:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token string">"   "</span><span class="token punctuation">,</span><br>  <span class="token string">"|_|"</span><span class="token punctuation">,</span><br>  <span class="token string">"  |"</span><br><span class="token punctuation">]</span><br><span class="token punctuation">[</span><br>  <span class="token string">" _ "</span><span class="token punctuation">,</span><br>  <span class="token string">" _|"</span><span class="token punctuation">,</span><br>  <span class="token string">"|_ "</span><br><span class="token punctuation">]</span></code></pre><p>One way of getting the &quot;horizontal slices&quot; of these LED numbers joined up onto the appropriate lines of output is to treat it as a matrix (in Conor &amp; co's language I might use the term &quot;rank 2&quot;) and transpose it.</p><p>So I wrapped this stream of arrays in an outer array with the <a href="https://stedolan.github.io/jq/manual/#Arrayconstruction:%5B%5D">array construction</a> syntax <code>[]</code>:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><p>which gave me:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">[</span><br>    <span class="token string">"   "</span><span class="token punctuation">,</span><br>    <span class="token string">"|_|"</span><span class="token punctuation">,</span><br>    <span class="token string">"  |"</span><br>  <span class="token punctuation">]</span><br>  <span class="token punctuation">[</span><br>    <span class="token string">" _ "</span><span class="token punctuation">,</span><br>    <span class="token string">" _|"</span><span class="token punctuation">,</span><br>    <span class="token string">"|_ "</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">]</span></code></pre><p>which I could then transpose, which I did like this:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> transpose</code></pre><p>resulting in:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">[</span><br>    <span class="token string">"   "</span><span class="token punctuation">,</span><br>    <span class="token string">" _ "</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><br>    <span class="token string">"|_|"</span><span class="token punctuation">,</span><br>    <span class="token string">" _|"</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><br>    <span class="token string">"  |"</span><span class="token punctuation">,</span><br>    <span class="token string">"|_ "</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">]</span></code></pre><p>These subarrays were now ready for joining together as longer strings:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> transpose <span class="token operator pipe">|</span> <span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token c-style-function function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>with the following result:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token string">"    _ "</span><span class="token punctuation">,</span><br>  <span class="token string">"|_| _|"</span><span class="token punctuation">,</span><br>  <span class="token string">"  ||_ "</span><br><span class="token punctuation">]</span></code></pre><p>But I just wanted the plain strings, rather than have then enclosed in an array, so I used the <a href="https://stedolan.github.io/jq/manual/#Array/ObjectValueIterator:.%5B%5D">array iterator</a> to do that:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> | transpose | map(join(<span class="token string">""</span>))<span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>which gave me what I was looking for (remember that the <code>-r</code> raw output is still being used), so a stream of strings is output but without the enclosing double quotes):</p><pre class="language-text"><code class="language-text">    _<br>|_| _|<br>  ||_</code></pre><p>Great!</p><p>This was what I send in <a href="https://github.com/atejada/led_numbers/pull/1/commits/e6e3e5c3196aa436f865446a1c99ba4b87380eba">the first commit</a> in the pull request.</p><h2>Recognising the pattern</h2><p>But the solution looked a little noisy, and after staring at it for a few seconds I realised that it was the last part that was bothering me:</p><pre class="language-jq"><code class="language-jq"><span class="token c-style-function function">map</span><span class="token punctuation">(</span><span class="token c-style-function function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>The pattern is: <code>map(...)[]</code>. If I didn't want to keep the array shape, then why bother with the <code>map</code> in the first place? It appeared to me that I could replace this with just the expression that I'd put inside the parentheses, in this case just the <code>join(&quot;&quot;)</code>.</p><h2>An improvement</h2><p>The only thing I had to do then, to allow the use of this pattern switch, was to embrace jq's natural streaming nature, and basically start streaming earlier in the pipeline, by using the array iterator directly on the output from <code>transpose</code>, like this:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> transpose<span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>This returns something similar to what we saw <code>transpose</code> return earlier, but instead of a single value (an array of arrays of strings), it just returns a stream of the arrays of strings:</p><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token string">"   "</span><span class="token punctuation">,</span><br>  <span class="token string">" _ "</span><br><span class="token punctuation">]</span><span class="token punctuation">,</span><br><span class="token punctuation">[</span><br>  <span class="token string">"|_|"</span><span class="token punctuation">,</span><br>  <span class="token string">" _|"</span><br><span class="token punctuation">]</span><span class="token punctuation">,</span><br><span class="token punctuation">[</span><br>  <span class="token string">"  |"</span><span class="token punctuation">,</span><br>  <span class="token string">"|_ "</span><br><span class="token punctuation">]</span></code></pre><p>Then, each of these three array values are passed downstream, where I then only need the expression that was hitherto inside the <code>map(...)[]</code> construct, i.e.:</p><pre class="language-jq"><code class="language-jq"><span class="token punctuation">[</span>segments<span class="token punctuation">[</span>digits<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> transpose<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> <span class="token c-style-function function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span></code></pre><p>This indeed gave me the same result which I wanted:</p><pre class="language-text"><code class="language-text">    _<br>|_| _|<br>  ||_</code></pre><p>This version feels more idiomatic, and I updated the line to look like this in <a href="https://github.com/atejada/led_numbers/pull/1/commits/5f243bc76b83566a0b1a70dfa5668d49ce496a67">the second commit</a> in the pull request.</p><p>Thanks to Conor and his cohorts for helping me remember to look for patterns!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/jq/">#jq</a> <a href="/tags/patterns/">#patterns</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2023/04/16/double-sap-btp-goodness-in-isernhagen/"><span>←</span> <span>Double SAP BTP goodness in Isernhagen</span> </a><a href="/blog/posts/2023/04/09/learning-from-community-solutions-on-exercism-part-3/"><span>Learning from community solutions on Exercism - part 3</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>