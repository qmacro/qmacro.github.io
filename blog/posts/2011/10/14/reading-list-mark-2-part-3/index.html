<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Reading List Mark 2 - Part 3</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		
	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="reading-list-mark-2-part-3">Reading List Mark 2 - Part 3</h1>

<ul class="post-metadata">
	<li><time datetime="2011-10-14">14 October 2011</time></li>
	<li><a href="/tags/appsscript/" class="post-tag">appsscript</a>, </li>
	<li><a href="/tags/google/" class="post-tag">google</a>, </li>
	<li><a href="/tags/gtug/" class="post-tag">gtug</a>, </li>
	<li><a href="/tags/madlab/" class="post-tag">madlab</a>, </li>
	<li><a href="/tags/mangtug/" class="post-tag">mangtug</a>, </li>
	<li><a href="/tags/tasks/" class="post-tag">tasks</a>, </li>
	<li><a href="/tags/ui/" class="post-tag">ui</a>, </li>
	<li><a href="/tags/urlfetch/" class="post-tag">urlfetch</a></li>
</ul>

<p class="post-description-main"></p>

<p>This is Part 3 in a series about an example app that I put together to demonstrate and describe the use of various Google Apps Script features. See <a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> for an introduction.</p>
<p>This part is “<strong>Using the UrlFetch Services to interact with the Google+ API (after all, it’s REST-based!) and grab info on articles pointed to by users in their activity stream</strong>“.</p>
<h2 id="parts-overview">Parts Overview</h2>
<ol>
<li><a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Introduction to the app, and a short screencast showing the features</a></li>
<li><a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Using the Tasks API to retrieve and insert tasklists, and the Ui Services to build the tasklist chooser component</a></li>
<li><a href="/blog/posts/2011/10/14/reading-list-mark-2-part-3/">Using the UrlFetch Services to interact with the Google+ API and grab info on articles pointed to by users in their activity stream</a> <strong>&lt;– You Are Here</strong></li>
<li><a href="/blog/posts/2011/10/15/reading-list-mark-2-part-4/">Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</a></li>
<li><a href="/blog/posts/2011/10/16/reading-list-mark-2-part-5/">Putting it all together and using the OnOpen event to insert a new 2-item menu entry on the spreadsheet’s page</a></li>
</ol>
<h2 id="urlfetch-services">UrlFetch Services</h2>
<p>If you’ve ever used an HTTP client library in other contexts, you’ll be completely at home with the base classes available in the <a href="http://code.google.com/googleapps/appsscript/service_urlfetch.html">UrlFetch Services</a>. Following the <a href="http://c2.com/xp/DoTheSimplestThingThatCouldPossiblyWork.html">simplest thing that could possibly work</a> philosophy, all we need to do to fetch a resource and grab the payload is to use the UrlFetchApp class, specifically the fetch() method. It returns an <a href="http://code.google.com/googleapps/appsscript/class_httpresponse.html">HTTPResponse</a> object, which has everything you need: content, headers and response code.</p>
<p>Here’s an example of getting the signature from the server that serves this site:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">var</span> response <span class="token operator">=</span> UrlFetchApp<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://www.pipetree.com/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Server'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-log" tabindex="0"><code class="language-log"><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span> Apache<span class="token operator">/</span><span class="token number">2.2.14</span> <span class="token operator">(</span>Ubuntu<span class="token operator">)</span></code></pre>
<p>The Google+ API largely follows a RESTful design, which means that we can use the UrlFetch Services to interact with it.</p>
<h2 id="the-google-api">The Google+ API</h2>
<p>The <a href="https://developers.google.com/+/api/">Google+ API</a> is relatively new, and at the moment, read-only. This is fine for what we want to use it for in this example. There are two aspects of the API that are relevant for us:</p>
<ul>
<li>The REST-based nature means that we see the Google+ objects such as People, Activities and Comments as resources that we retrieve with HTTP</li>
<li>To use the API we need either an OAuth 2.0 token or an API key</li>
</ul>
<p>The UrlFetch Services provides us with a facility in the form of the OAuthConfig class for configuring and managing OAuth in a client context. But we’ll go for the simpler approach and use an API key, which we can obtain by using the Google API Console – see the previous instalment of this series for more details about this: <a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Using the Tasks API to retrieve and insert tasklists, and the Ui Services to build the tasklist chooser component</a>.</p>
<p>The idea for this example app is to capture a list of URLs that a person on Google+ has posted, and perhaps commented on. We can get this info from the <a href="https://developers.google.com/+/api/latest/activities">Activities</a> part of the API.</p>
<p>To get the activity stream for a given person, we need to retrieve the following resource:</p>
<p><code>https://www.googleapis.com/plus/v1/people/{userId}/activities/{collection}</code></p>
<p>The {userId} is the Google+ ID of the person, and {collection} in this case is “public”, the only collection available right now. In addition we need to specify our API key on a ‘key’ parameter in the query string. The default representation is JSON. This is what we get back as a result (heavily elided for brevity):</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"plus#activityFeed"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plus Public Activity Feed for Martin Hawksey"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"tag:google.com,2010:/plus/people/1146628[...]/activities/public"</span><span class="token punctuation">,</span>
  <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"plus#activity"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Latest post from me. Elevator pitch: [...]"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"z12cxlppixzwjbqzi04cdnvg1wbyflbz3r00k"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://plus.google.com/1146628[...]"</span><span class="token punctuation">,</span>
    <span class="token property">"verb"</span><span class="token operator">:</span> <span class="token string">"post"</span><span class="token punctuation">,</span>
    <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"objectType"</span><span class="token operator">:</span> <span class="token string">"note"</span><span class="token punctuation">,</span>
      <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"Latest post from me. Elevator pitch: Service [...]"</span><span class="token punctuation">,</span>
      <span class="token property">"originalContent"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://plus.google.com/1146628[...]"</span><span class="token punctuation">,</span>
      <span class="token property">"attachments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"objectType"</span><span class="token operator">:</span> <span class="token string">"article"</span><span class="token punctuation">,</span>
        <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"SpreadEmbed: Turning a Google Spreadsheet [...]"</span><span class="token punctuation">,</span>
        <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://mashe.hawksey.info/2011/10/spreadembed/"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">"objectType"</span><span class="token operator">:</span> <span class="token string">"photo"</span><span class="token punctuation">,</span>
        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://images0-focus-opensocial.google[...]"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"image/jpeg"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"fullImage"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://mcdn.hawksey.info/wp-content/uploads/[...]"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">,</span>
        <span class="token property">"height"</span><span class="token operator">:</span> <span class="token number">204</span><span class="token punctuation">,</span>
        <span class="token property">"width"</span><span class="token operator">:</span> <span class="token number">350</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">[</span>...<span class="token punctuation">]</span></code></pre>
<p>Even after heavy eliding for this blog post, that’s still an awful lot of JSON, but we’re only actually interested in the URLs that the person links to. We can spot these in the “plus#activity” items array, as attachments with objectType “article” – they have url and displayName attributes:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"plus#activity"</span><span class="token punctuation">,</span>
    <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"attachments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"objectType"</span><span class="token operator">:</span> <span class="token string">"article"</span><span class="token punctuation">,</span>
        <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"SpreadEmbed: Turning a Google Spreadsheet [...]"</span><span class="token punctuation">,</span>
        <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://mashe.hawksey.info/2011/10/spreadembed/"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>...<span class="token punctuation">]</span></code></pre>
<h2 id="partial-responses">Partial Responses</h2>
<p>And it just so happens that in the interests of efficiency, Google offers <a href="https://developers.google.com/+/api/#partial-response">partial responses</a>, in the form of a fields parameter. So we can add this parameter to the query string, with an XPath-style value like this:</p>
<pre class="language-text" tabindex="0"><code class="language-text">fields=items/object/attachments(url,displayName)</code></pre>
<p>So the resulting JSON representation is a lot lighter, like this:</p>
<pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"object"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"attachments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"SpreadEmbed: Turning a Google Spreadsheet[...]"</span><span class="token punctuation">,</span>
            <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://mashe.hawksey.info/2011/10/spreadembed/"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>Much better!</p>
<h2 id="retrieving-the-activity-data">Retrieving the Activity Data</h2>
<p>So now it’s time to have a look at the code that will retrieve the activity info and insert the URLs into the spreadsheet. We’ll do this in a single function retrieveActivityUrls_(), which will</p>
<ul>
<li>grab any existing URLs listed in the sheet, so we can work out whether each new one retrieved with the API call is already there or not</li>
<li>Determine the ID of the person on Google+ we want to follow</li>
<li>Build the name of the Google+ activity resource (the Google+ API URL), fetch it and parse the content</li>
<li>Look through the parsed content and note any new URLs that the person has linked to on Google+</li>
<li>Insert those new URLs into the sheet</li>
</ul>
<p>Let’s go!</p>
<p>First, some constants.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token constant">APIKEY</span> <span class="token operator">=</span> <span class="token string">'AIza[...]drBs'</span><span class="token punctuation">;</span> <span class="token comment">// (get your own!)</span>
<span class="token constant">ACTIVITYLISTURL</span> <span class="token operator">=</span> <span class="token string">'https://www.googleapis.com/plus/v1/people/{userId}/activities/{collection}'</span><span class="token punctuation">;</span>
<span class="token constant">USERIDCELL</span> <span class="token operator">=</span> <span class="token string">'B1'</span><span class="token punctuation">;</span>
<span class="token constant">USERID</span> <span class="token operator">=</span> <span class="token string">'106413090159067280619'</span><span class="token punctuation">;</span> <span class="token comment">// Fallback: Mahemoff!</span></code></pre>
<p>Now for the function. We get a handle on the active sheet, note the last row (which denotes where the list of URLs currently ends), and gets those URLs. We’re assuming that the list starts at row 2, i.e. there’s a header line in row 1. The resulting urlList array is two dimensional, although as we’ve specified we only want 1 column width of values, the data will look something like this:</p>
<pre class="language-text" tabindex="0"><code class="language-text">[[http://cloud9ide.com], [http://jsconf.eu], [...]]</code></pre>
<p>We create an object to hold the existing (‘old’) URLs, and the eventual ‘new’ URLs about to be retrieved. We’re using an object ‘old’ for the existing URLs so we can easily check whether a new one is in the list or not. We just need to use an array for the ‘new’ URLs.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">retrieveActivityUrls_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// Grab existing list of URLs</span>
  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lastRow <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getLastRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> urlList <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lastRow <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">'old'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">'new'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> urlList<span class="token punctuation">)</span><span class="token punctuation">{</span>
    list<span class="token punctuation">[</span><span class="token string">'old'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<p>We’re going to retrieve the activity for a Google+ person, and the person is identified by an ID either in a cell in the sheet identified by the range in constant USERIDCELL, (see the screencast in <a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Part 1</a>) or a default specified in constant USERID.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">  <span class="token comment">// Use the userid in the sheet, fallback to a favourite</span>
  <span class="token keyword">var</span> userid <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token constant">USERIDCELL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token constant">USERID</span><span class="token punctuation">;</span></code></pre>
<p>Now we have enough information to build the Google+ API resource URL, so we call a helper function buildActivityListUrl_() passing it the user ID, the collection (‘public’), and our API key. (We’ll look at buildActivityListUrl_() shortly.) We use the UrlFetchApp fetch() method to grab the resource, calling getContentText() to obtain the JSON content. And with a JSON parser available in the <a href="http://code.google.com/googleapps/appsscript/service_utilities.html">Utilities Services</a>, we quickly have all we need to retrieve those URLs posted in the activity list in the ‘activities’ object.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">  <span class="token comment">// Build Google+ API resource and retrieve it; parse JSON content</span>
  <span class="token keyword">var</span> actListUrl <span class="token operator">=</span> <span class="token function">buildActivityListUrl_</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">,</span> <span class="token constant">APIKEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> jsonString <span class="token operator">=</span> UrlFetchApp<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>actListUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContentText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> activities <span class="token operator">=</span> Utilities<span class="token punctuation">.</span><span class="token function">jsonParse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>From examining the JSON representation of the activities earlier in this post, we know we’ll be expecting items, and within each item an object member, and within that object member a number of attachments. We’re only interested in those attachments of type ‘article’, and if we find one, we want the url and the displayName.</p>
<p>If we’ve got an article attachment, we then need to determine whether it’s a new URL or one we have already. That’s where the list object comes in. Unless we can find the URL in the ‘old’ object, it’s a new one so we need to add it to the ‘new’ list.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">  <span class="token comment">// We're looking for the item object attachments, where the</span>
  <span class="token comment">// attachment's objectType is 'article'. We want the url and displayName</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> activities<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> attachments <span class="token operator">=</span> activities<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>attachments<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> a <span class="token keyword">in</span> attachments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> attachment <span class="token operator">=</span> attachments<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// We've got a URL and title; store it as new if it doesn't</span>
      <span class="token comment">// already exist. Store it as list of lists, ready for</span>
      <span class="token comment">// a setValues([][]) insert</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">.</span>objectType <span class="token operator">==</span> <span class="token string">'article'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">.</span>url <span class="token keyword">in</span> list<span class="token punctuation">[</span><span class="token string">'old'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attachment<span class="token punctuation">.</span>url<span class="token punctuation">,</span> attachment<span class="token punctuation">.</span>displayName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>At this stage, we’re ready to add any new URLs to the list in the sheet. Note that when we pushed onto the ‘new’ list, we pushed an array of the url and displayName. This is the ideal two dimensional array ([[a, b], [c, d], [...]) to specify as the value in the <a href="http://code.google.com/googleapps/appsscript/class_range.html#setValues">setValues()</a> call on a two dimensional cell Range. And useful if we want to follow the sage advice in “<a href="http://code.google.com/googleapps/appsscript/guide_common_tasks.html">Common Programming Tasks</a>” on using batch operations where possible: we can add all the new URL info to the sheet in a single getRange() and setValues() call pair:</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript">  <span class="token comment">// Blammo!</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>lastRow <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValues</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>Now that’s the retrieveActivityUrls_()  function out of the way, let’s just have a look at the helper function buildActivityListUrl_() that we called earlier. It takes three parameters: the ID of the person on Google+, the collection we want to retrieve (‘public’ in this case), and the API key. It uses a URL template in the ACTIVITYLISTURL constant and replaces the placeholders. It also adds the API key, and the XPath fields statement.</p>
<pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">buildActivityListUrl_</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> apiKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> actListUrl <span class="token operator">=</span> <span class="token constant">ACTIVITYLISTURL</span><span class="token punctuation">;</span>
  actListUrl <span class="token operator">=</span> actListUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{userId}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  actListUrl <span class="token operator">=</span> actListUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{collection}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  actListUrl <span class="token operator">+=</span> <span class="token string">'?key='</span> <span class="token operator">+</span> apiKey<span class="token punctuation">;</span>
  actListUrl <span class="token operator">+=</span> <span class="token string">'&amp;fields=items/object/attachments(url,displayName)'</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> actListUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>That brings us to the end of this part in the series. At this stage we have covered the tasklist determination using a user interface and pulled the URLs posted on a Google+ activity stream, storing them in the sheet.</p>
<p>In the next part, we’ll look at synchronising the URLs in the sheet with tasks on the chosen tasklist.</p>
<p>Stay tuned!</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Reading List Mark 2 - Part 2</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2011/10/15/reading-list-mark-2-part-4/">Reading List Mark 2 - Part 4</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2011/10/14/reading-list-mark-2-part-3/` was built on 2025-09-16T06:55:11.123Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
	</body>
</html>
