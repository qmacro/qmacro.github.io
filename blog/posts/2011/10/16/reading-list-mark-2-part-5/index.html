<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2011/10/16/reading-list-mark-2-part-5/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Reading List Mark 2 - Part 5 | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Reading List Mark 2 - Part 5"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2011/10/16/reading-list-mark-2-part-5/"><meta name="description" content="Reading List Mark 2 - Part 5 16 Oct 2011 | 5 min read This is Part 5, the last part in a series about an example app that I put together to..."><meta property="og:description" content="Reading List Mark 2 - Part 5 16 Oct 2011 | 5 min read This is Part 5, the last part in a series about an example app that I put together to..."><meta name="description" content="Reading List Mark 2 - Part 5 16 Oct 2011 | 5 min read This is Part 5, the last part in a series about an example app that I put together to..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Reading List Mark 2 - Part 5</h1><div class="post__details"><time datetime="2011-10-16">16 Oct 2011 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p>This is Part 5, the last part in a series about an example app that I put together to demonstrate and describe the use of various Google Apps Script features. See <a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> for an introduction.</p><p>This part is &quot;<strong>Putting it all together and using the OnOpen event to insert a new 2-item menu entry on the spreadsheet’s page</strong>&quot;.</p><h2>Parts Overview</h2><ol><li><a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Introduction to the app, and a short screencast showing the features</a></li><li><a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Using the Tasks API to retrieve and insert tasklists, and the Ui Services to build the tasklist chooser component</a></li><li><a href="/blog/posts/2011/10/14/reading-list-mark-2-part-3/">Using the UrlFetch Services to interact with the Google+ API and grab info on articles pointed to by users in their activity stream</a></li><li><a href="/blog/posts/2011/10/15/reading-list-mark-2-part-4/">Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</a></li><li><a href="/blog/posts/2011/10/16/reading-list-mark-2-part-5/">Putting it all together and using the OnOpen event to insert a new 2-item menu entry on the spreadsheet’s page</a> <strong>&lt;– you are here</strong></li></ol><h2>Putting it all together</h2><p>So at this stage we’ve done pretty much everything required for this example app. The final task is to extend the standard Spreadsheet menu to give the user access to the custom features of selecting a tasklist, and kicking off an update (URL pull and synchronisation). It’s very easy to extend the menu; in a few lines of code we’re going to end up with something like this:</p><p><img src="/images/2017/12/menu.png" alt="Menu"></p><p>It’s as simple as this:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> ss <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> menuEntries <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Update"</span><span class="token punctuation">,</span> <span class="token literal-property property">functionName</span><span class="token operator">:</span> <span class="token string">"update"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Select Task List"</span><span class="token punctuation">,</span> <span class="token literal-property property">functionName</span><span class="token operator">:</span> <span class="token string">"taskListUi"</span><span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br>  ss<span class="token punctuation">.</span><span class="token function">addMenu</span><span class="token punctuation">(</span><span class="token string">"Articles"</span><span class="token punctuation">,</span> menuEntries<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>We use the <a href="http://code.google.com/googleapps/appsscript/class_spreadsheet.html#addMenu">addMenu</a>() method of the Spreadsheet class to create a new menu entry with an array of objects representing menu items. And the function name? onOpen() is one of a number of <a href="http://code.google.com/googleapps/appsscript/guide_events.html">built-in simple event handler functions</a>; this one runs automatically when a spreadsheet is opened – an ideal time to extend the menu.</p><h2>The complete script</h2><p>So we’re done with the final part! Let’s celebrate with the script in its entirety. And a beer. Cheers!</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// Constants</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token constant">APIKEY</span> <span class="token operator">=</span> <span class="token string">'AIzaSyANY6ebMr2bi1Fzn-53kysp0y4LsbZA488'</span><span class="token punctuation">;</span><br><span class="token constant">ACTIVITYLISTURL</span> <span class="token operator">=</span> <span class="token string">'https://www.googleapis.com/plus/v1/people/{userId}/activities/{collection}'</span><span class="token punctuation">;</span><br><span class="token constant">READINGLISTCELL</span> <span class="token operator">=</span> <span class="token string">'C1'</span><span class="token punctuation">;</span><br><span class="token constant">USERIDCELL</span> <span class="token operator">=</span> <span class="token string">'D1'</span><br><span class="token constant">USERID</span> <span class="token operator">=</span> <span class="token string">'106413090159067280619'</span><span class="token punctuation">;</span> <span class="token comment">// Mahemoff</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// update()</span><br><span class="token comment">// Pulls in article links into sheet and synchronises with task list</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// First, check that we have a tasklist id already; it's stored in</span><br>  <span class="token comment">// the comment section of the 'readinglistcell'</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> taskListId <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token constant">READINGLISTCELL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// If we don't have an id, tell the user to choose a tasklist</span><br>  <span class="token keyword">if</span><span class="token punctuation">(</span>taskListId <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><br>      <span class="token string">"Use Articles -> Select Task List to choose a task list"</span><span class="token punctuation">,</span><br>      <span class="token string">"No Task List"</span><span class="token punctuation">,</span><br>      <span class="token number">5</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Otherwise, we know which task list to synchronise with, so</span><br>  <span class="token comment">// go and update the reading list with URLs from the Google+ activity</span><br>  <span class="token comment">// list, and then sync that with the task list items</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token function">retrieveActivityUrls_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">synchronise_</span><span class="token punctuation">(</span>taskListId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// taskListUi()</span><br><span class="token comment">// Displays a Ui to allow the user to select a tasklist to manage</span><br><span class="token comment">// the reading tasks. Can select an existing task list or create a new one</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">taskListUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> doc <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> app <span class="token operator">=</span> UiApp<span class="token punctuation">.</span><span class="token function">createApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">'Task Lists'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// We'll have a grid and a button in this</span><br>  <span class="token comment">// vertical panel</span><br>  <span class="token keyword">var</span> panel <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createVerticalPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Use a listbox to display a choice of existing tasklists</span><br>  <span class="token keyword">var</span> lb <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createListBox</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  lb<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'existingList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> tasklists <span class="token operator">=</span> <span class="token function">getTasklists_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> tl <span class="token keyword">in</span> tasklists<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    lb<span class="token punctuation">.</span><span class="token function">addItem</span><span class="token punctuation">(</span>tasklists<span class="token punctuation">[</span>tl<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Use the grid to layout the listbox, a textbox for a new list,</span><br>  <span class="token comment">// and some corresponding labels</span><br>  <span class="token keyword">var</span> grid <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createGrid</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  grid<span class="token punctuation">.</span><span class="token function">setWidget</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">createLabel</span><span class="token punctuation">(</span><span class="token string">"Existing:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  grid<span class="token punctuation">.</span><span class="token function">setWidget</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  grid<span class="token punctuation">.</span><span class="token function">setWidget</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">createLabel</span><span class="token punctuation">(</span><span class="token string">"Or new:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  grid<span class="token punctuation">.</span><span class="token function">setWidget</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">createTextBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'newList'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// The only button; handler will be linked to this button click event</span><br>  <span class="token comment">// Remember to add the grid contents to the callback context</span><br>  <span class="token keyword">var</span> button <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createButton</span><span class="token punctuation">(</span><span class="token string">"Choose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> chooseHandler <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createServerClickHandler</span><span class="token punctuation">(</span><span class="token string">'handleChooseButton_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  chooseHandler<span class="token punctuation">.</span><span class="token function">addCallbackElement</span><span class="token punctuation">(</span>grid<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  button<span class="token punctuation">.</span><span class="token function">addClickHandler</span><span class="token punctuation">(</span>chooseHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Put it all together and show it</span><br>  panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">createLabel</span><span class="token punctuation">(</span><span class="token string">"Select existing or create new list"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>grid<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  panel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panel<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  doc<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// handleChooseButton_(e)</span><br><span class="token comment">// Handler for 'Choose' button on taskListUi Ui; creates a new task list</span><br><span class="token comment">// if a new one has been specified; grabs the ID of the chosen task list</span><br><span class="token comment">// and stores the task list name and id in the TASKLISTCELL</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">handleChooseButton_</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Assume an existing list was chosen</span><br>  <span class="token keyword">var</span> selectedList <span class="token operator">=</span> e<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>existingList<span class="token punctuation">;</span><br><br>  <span class="token comment">// But check for a new list being specified; if it as, create</span><br>  <span class="token comment">// a new task list</span><br>  <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>newList <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    selectedList <span class="token operator">=</span> e<span class="token punctuation">.</span>parameter<span class="token punctuation">.</span>newList<span class="token punctuation">;</span><br>    <span class="token keyword">var</span> newTaskList <span class="token operator">=</span> Tasks<span class="token punctuation">.</span><span class="token function">newTaskList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>selectedList<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    Tasks<span class="token punctuation">.</span>Tasklists<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newTaskList<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Grab the list of tasklists, because we'll need the id</span><br>  <span class="token keyword">var</span> taskLists <span class="token operator">=</span> <span class="token function">getTasklists_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> taskListId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span>tl <span class="token keyword">in</span> taskLists<span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>taskLists<span class="token punctuation">[</span>tl<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> selectedList<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      taskListId <span class="token operator">=</span> taskLists<span class="token punctuation">[</span>tl<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Record the list name and id</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> cell <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token constant">READINGLISTCELL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  cell<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>selectedList<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  cell<span class="token punctuation">.</span><span class="token function">setComment</span><span class="token punctuation">(</span>taskListId<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Close the Ui popup and display the name of the chosen list</span><br>  <span class="token keyword">var</span> app <span class="token operator">=</span> UiApp<span class="token punctuation">.</span><span class="token function">getActiveApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>selectedList<span class="token punctuation">,</span> <span class="token string">"Selected List"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> app<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// onOpen()</span><br><span class="token comment">// Event-based function called when the spreadsheet is opened; adds items</span><br><span class="token comment">// to the menu</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> ss <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> menuEntries <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Select Task List"</span><span class="token punctuation">,</span> <span class="token literal-property property">functionName</span><span class="token operator">:</span> <span class="token string">"taskListUi"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>                     <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Update"</span><span class="token punctuation">,</span> <span class="token literal-property property">functionName</span><span class="token operator">:</span> <span class="token string">"update"</span><span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br>  ss<span class="token punctuation">.</span><span class="token function">addMenu</span><span class="token punctuation">(</span><span class="token string">"Articles"</span><span class="token punctuation">,</span> menuEntries<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// getTasklists()</span><br><span class="token comment">// Retrieve a list of the user's tasklists (uses the APIs Services)</span><br><span class="token comment">// Note that the Tasks Services docu is not accurate here; we would</span><br><span class="token comment">// expect to be able to use the TasklistsCollection class.</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">getTasklists_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> tasklistsList <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasklists<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> tasklistsList<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// retrieveActivityUrls_()</span><br><span class="token comment">// Use UrlFetch to retrieve a Google+ API resource: activities for a person</span><br><span class="token comment">// Use Javascript data structures; restrict the number of API calls</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">retrieveActivityUrls_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Grab existing list of URLs</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> lastRow <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getLastRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> urlList <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lastRow <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">'old'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">'new'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> urlList<span class="token punctuation">)</span><span class="token punctuation">{</span><br>    list<span class="token punctuation">[</span><span class="token string">'old'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>urlList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Use the userid in the sheet, fallback to a favourite :)</span><br>  <span class="token keyword">var</span> userid <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token constant">USERIDCELL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token constant">USERID</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Build Google+ API resource and retrieve it; parse JSON content</span><br>  <span class="token keyword">var</span> actListUrl <span class="token operator">=</span> <span class="token function">buildActivityListUrl_</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">,</span> <span class="token constant">APIKEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> jsonString <span class="token operator">=</span> UrlFetchApp<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>actListUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContentText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token keyword">var</span> activities <span class="token operator">=</span> Utilities<span class="token punctuation">.</span><span class="token function">jsonParse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// We're looking for the item object attachments, where the</span><br>  <span class="token comment">// attachment's objectType is 'article'. We want the url and displayName</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> activities<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> attachments <span class="token operator">=</span> activities<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>attachments<span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> a <span class="token keyword">in</span> attachments<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> attachment <span class="token operator">=</span> attachments<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token comment">// We've got a URL and title; store it as new if it doesn't</span><br>      <span class="token comment">// already exist. Store it as list of lists, ready for</span><br>      <span class="token comment">// a setValues([][]) insert</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">.</span>objectType <span class="token operator">==</span> <span class="token string">'article'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>attachment<span class="token punctuation">.</span>url <span class="token keyword">in</span> list<span class="token punctuation">[</span><span class="token string">'old'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attachment<span class="token punctuation">.</span>url<span class="token punctuation">,</span> attachment<span class="token punctuation">.</span>displayName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Blammo!</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>lastRow <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValues</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// synchronise(taskListId)</span><br><span class="token comment">// Synchronise the URLs in the spreadsheet with items in the chosen tasklist</span><br><span class="token comment">// The task list item id for a URL is stored in the comment for that URL cell</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">synchronise_</span><span class="token punctuation">(</span><span class="token parameter">taskListId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Grab list of all URLs, and associated comments</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> urlRange <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> sh<span class="token punctuation">.</span><span class="token function">getLastRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> urls <span class="token operator">=</span> urlRange<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> comments <span class="token operator">=</span> urlRange<span class="token punctuation">.</span><span class="token function">getComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// For each URL, check the status of the associated task.</span><br>  <span class="token comment">// If there isn't an associated task, create one.</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>comments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"New task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> task <span class="token operator">=</span> Tasks<span class="token punctuation">.</span><span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      task<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> newTask <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> taskListId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComment</span><span class="token punctuation">(</span>newTask<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Existing task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> existingTask <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskListId<span class="token punctuation">,</span> comments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"completed"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFontLine</span><span class="token punctuation">(</span><span class="token string">'line-through'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token comment">// buildActivityListUrl_(userId, collection, apiKey)</span><br><span class="token comment">// Creates a specific resource address (URL) for the public activities</span><br><span class="token comment">// for a given person in Google+</span><br><span class="token comment">// See https://developers.google.com/+/api/latest/activities/list</span><br><span class="token comment">// This will be obsolete when there are direct Google+ Services for</span><br><span class="token comment">// Apps Script</span><br><span class="token comment">// -------------------------------------------------------------------------</span><br><span class="token keyword">function</span> <span class="token function">buildActivityListUrl_</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> apiKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token keyword">var</span> actListUrl <span class="token operator">=</span> <span class="token constant">ACTIVITYLISTURL</span><span class="token punctuation">;</span><br>  actListUrl <span class="token operator">=</span> actListUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{userId}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  actListUrl <span class="token operator">=</span> actListUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{collection}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> collection<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  actListUrl <span class="token operator">=</span> actListUrl <span class="token operator">+</span> <span class="token string">'?key='</span> <span class="token operator">+</span> apiKey<span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> actListUrl<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></main><aside class="post__aside"><div class="post__tags"><a href="/tags/appsscript/">#appsscript</a> <a href="/tags/google/">#google</a> <a href="/tags/gtug/">#gtug</a> <a href="/tags/madlab/">#madlab</a> <a href="/tags/mangtug/">#mangtug</a> <a href="/tags/tasks/">#tasks</a> <a href="/tags/ui/">#ui</a> <a href="/tags/urlfetch/">#urlfetch</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2011/10/25/review-of-milk-stout-from-left-handed-brewing-co/"><span>←</span> <span>Review of Milk Stout from Left Handed Brewing Co</span> </a><a href="/blog/posts/2011/10/15/reading-list-mark-2-part-4/"><span>Reading List Mark 2 - Part 4</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>