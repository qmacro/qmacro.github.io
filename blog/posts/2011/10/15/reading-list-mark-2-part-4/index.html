<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2011/10/15/reading-list-mark-2-part-4/"><link rel="alternate" type="application/atom+xml" title="DJ's Weblog - Feed" href="https://qmacro.org/feed.xml"><link href="/assets/main.54fe08380532f159e78f.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>Reading List Mark 2 - Part 4 | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="Reading List Mark 2 - Part 4"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2011/10/15/reading-list-mark-2-part-4/"><meta name="description" content="Reading List Mark 2 - Part 4 15 Oct 2011 | 4 min read This is Part 4 in a series about an example app that I put together to demonstrate and..."><meta property="og:description" content="Reading List Mark 2 - Part 4 15 Oct 2011 | 4 min read This is Part 4 in a series about an example app that I put together to demonstrate and..."><meta name="description" content="Reading List Mark 2 - Part 4 15 Oct 2011 | 4 min read This is Part 4 in a series about an example app that I put together to demonstrate and..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>Reading List Mark 2 - Part 4</h1><div class="post__details"><time datetime="2011-10-15">15 Oct 2011 </time><span>| </span><span>4 min read</span></div></header><main class="post__content"><p>This is Part 4 in a series about an example app that I put together to demonstrate and describe the use of various Google Apps Script features. See <a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> for an introduction.</p><p>This part is “<strong>Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</strong>“.</p><h2>Parts Overview</h2><ol><li><a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Introduction to the app, and a short screencast showing the features</a></li><li><a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Using the Tasks API to retrieve and insert tasklists, and the Ui Services to build the tasklist chooser component</a></li><li><a href="/blog/posts/2011/10/14/reading-list-mark-2-part-3/">Using the UrlFetch Services to interact with the Google+ API and grab info on articles pointed to by users in their activity stream</a></li><li><a href="/blog/posts/2011/10/15/reading-list-mark-2-part-4/">Synchronising the URL list in the spreadsheet with corresponding tasks in the chosen tasklist</a><strong>&lt;– You Are Here</strong></li><li><a href="/blog/posts/2011/10/16/reading-list-mark-2-part-5/">Putting it all together and using the OnOpen event to insert a new 2-item menu entry on the spreadsheet’s page</a></li></ol><h2>Putting this into context: the Update request</h2><p>We’ve covered a lot of ground in the previous three parts in this series. Now we’re at the stage where we have the functions for</p><ul><li>creating a Ui for choosing an existing / creating a new tasklist</li><li>handling the button event on the Ui</li><li>getting a list of tasklists</li><li>retrieving URLs from a Google+ activity stream</li></ul><p>So the one main piece of work outstanding is synchronising the retrieved URLs as tasks on the chosen tasklist.</p><p>If you watch the <a href="http://www.youtube.com/watch?v=F08qS8ZmlZ0">screencast</a> shown in <a href="/blog/posts/2011/10/08/reading-list-mark-2-part-1/">Part 1</a> you’ll see that the synchronisation is part of a more general ‘update’ request, that includes the fetching of new URLs from Google+ and synchronising them with the tasklist. So let’s have a look at the function that binds those two things together.</p><p>Here’s the update() function, which we’ll allow the user to call from a menu item (we’ll cover this in the next instalment).</p><pre class="language-javascript"><code class="language-javascript"><span class="token constant">READINGLISTCELL</span> <span class="token operator">=</span> <span class="token string">'D1'</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// First, check that we have a tasklist id already; it's stored in</span><br>  <span class="token comment">// the comment section of the 'readinglistcell'</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> taskListId <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token constant">READINGLISTCELL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// If we don't have an id, tell the user to choose a tasklist</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskListId <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    SpreadsheetApp<br>      <span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">"Use Articles -> Select Task List to choose a task list"</span><span class="token punctuation">,</span> <span class="token string">"No Task List"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Otherwise, we know which task list to synchronise with, so</span><br>    <span class="token comment">// go and update the reading list with URLs from the Google+ activity</span><br>    <span class="token comment">// list, and then sync that with the task list items</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token function">retrieveActivityUrls_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">synchronise_</span><span class="token punctuation">(</span>taskListId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>This function grabs a reference to the active sheet, and pulls the comment from the cell that we’ve designated as where the reading list tasklist info is stored: READINGLISTCELL. The name is stored in the cell, and the ID is stored in the cell’s comment. If there isn’t an ID, then we’ll ask the user to choose a tasklist using the Ui we built in <a href="/blog/posts/2011/10/10/reading-list-mark-2-part-2/">Part 2</a>. The <a href="http://code.google.com/googleapps/appsscript/class_browser.html">Browser</a> class in Google Apps Script’s <a href="http://code.google.com/googleapps/appsscript/service_base.html">Base Services</a> gives us a nice dialog box that looks like this:</p><p><img src="/images/2011/10/notamessage1.png" alt="message box"></p><p>But there’s also a nice visual message feature that’s available in the <a href="http://code.google.com/googleapps/appsscript/service_spreadsheet.html">Spreadsheet Services</a>, specific to a spreadsheet: <a href="http://code.google.com/googleapps/appsscript/class_spreadsheet.html#toast">toast()</a>. Calling this causes a popup to appear in the lower right of the screen, which stays visible for a short while. This is what it looks like:</p><p><img src="/images/2011/10/notasklist.png" alt="toast message"></p><p>Because the ‘toast’ name is so evocative, we’ll use it in our function to prompt the user to choose a tasklist.</p><p>If there’s already a tasklist chosen, then we go straight into retrieving the URLs (see <a href="/blog/posts/2011/10/14/reading-list-mark-2-part-3/">Part 3</a>) and then call the synchronise_() function, passing the ID of the tasklist.</p><h2>Synchronising URLs and Tasks</h2><p>Ok, so what do we need to do to synchronise the URLs? It’s similar to the technique described in the great article “<a href="http://code.google.com/googleapps/appsscript/articles/google_apis_reading_list.html">Integrating with Google APIs – Creating a simple reading list</a>“. There are a couple of differences: I’m not going to use the <a href="http://code.google.com/googleapps/appsscript/service_urlshortener.html">UrlShortener Services</a>, and I’m going to try and reduce the number of API calls by bulk-grabbing the cell data.</p><p>First, we get a range reference on the active sheet, which equates to the list of URLs already there. We get all of the URLs (urlRange.getValues()) and all of the corresponding comments (urlRange.getComments()).</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">synchronise_</span><span class="token punctuation">(</span><span class="token parameter">taskListId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Grab list of all URLs, and associated comments</span><br>  <span class="token keyword">var</span> sh <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> urlRange <span class="token operator">=</span> sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> sh<span class="token punctuation">.</span><span class="token function">getLastRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> urls <span class="token operator">=</span> urlRange<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> comments <span class="token operator">=</span> urlRange<span class="token punctuation">.</span><span class="token function">getComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>We go through each of the URLs, and create a new task in the tasklist if there isn’t already something in the comment for that URL:</p><ul><li>instantiate a new task object: Tasks.newTask()</li><li>add the title: task.setTitle()</li><li>add the task to the tasklist: Tasks.Tasks.insert()</li><li>insert the new task’s ID into the comment for the URL: setComment()</li></ul><p>Otherwise we’ve already created a task for the URL, so we grab the task to get the status, and if it’s marked as completed, we format the URL and corresponding description (in the next column) to set strike-through text.</p><pre class="language-javascript"><code class="language-javascript">  <span class="token comment">// For each URL, check the status of the associated task.</span><br>  <span class="token comment">// If there isn't an associated task, create one.</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>comments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"New task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> task <span class="token operator">=</span> Tasks<span class="token punctuation">.</span><span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      task<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> newTask <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> taskListId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComment</span><span class="token punctuation">(</span>newTask<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      Logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Existing task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> existingTask <span class="token operator">=</span> Tasks<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>taskListId<span class="token punctuation">,</span> comments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTask<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"completed"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        sh<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFontLine</span><span class="token punctuation">(</span><span class="token string">"line-through"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>That’s it. Stop by next time for the last part in this series, where we put everything together and insert a 2-item menu entry to tie it all together. Thanks for reading!</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/appsscript/">#appsscript</a> <a href="/tags/google/">#google</a> <a href="/tags/gtug/">#gtug</a> <a href="/tags/madlab/">#madlab</a> <a href="/tags/mangtug/">#mangtug</a> <a href="/tags/tasks/">#tasks</a> <a href="/tags/ui/">#ui</a> <a href="/tags/urlfetch/">#urlfetch</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2011/10/16/reading-list-mark-2-part-5/"><span>←</span> <span>Reading List Mark 2 - Part 5</span> </a><a href="/blog/posts/2011/10/14/reading-list-mark-2-part-3/"><span>Reading List Mark 2 - Part 3</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://www.linkedin.com/in/djadams/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li><li><a rel="me" href="/tweets/">Tweet Archive</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a rel="me" href="https://bsky.app/profile/qmacro.org" target="_blank" rel="noopener noreferrer">Bluesky</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>