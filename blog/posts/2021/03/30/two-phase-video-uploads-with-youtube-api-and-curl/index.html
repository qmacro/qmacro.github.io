<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Two-phase video uploads with YouTube API and curl</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="two-phase-video-uploads-with-youtube-api-and-curl">Two-phase video uploads with YouTube API and curl</h1>

<ul class="post-metadata">
	<li><time datetime="2021-03-30">30 March 2021</time></li>
	<li><a href="/tags/autodidactics/" class="post-tag">autodidactics</a>, </li>
	<li><a href="/tags/curl/" class="post-tag">curl</a>, </li>
	<li><a href="/tags/youtube/" class="post-tag">youtube</a>, </li>
	<li><a href="/tags/shell/" class="post-tag">shell</a></li>
</ul>

<p class="post-description-main"></p>

<p><em>TIL how to use the YouTube API to upload a video, with <code>curl</code>, using a two-phase approach.</em></p>
<p>I'm becoming more familiar with the YouTube API surface area, and a task recently required me to look into an efficient way of uploading videos to a YouTube channel. While I managed the upload technically, it was ultimately in vain due to a recent <a href="https://developers.google.com/youtube/v3/revision_history#release_notes_07_28_2020">change to the terms of service</a>. But it's still worth sharing the two-phase approach that I was able to take.</p>
<p>The YouTube Data API has a <a href="https://developers.google.com/youtube/v3/docs/videos/insert">Videos: insert</a> facility. It's worth reading through this, and, if you get the chance, through other areas of the API, because they're quite similar, and what appeared initially a little overwhelming to me has become more familiar.</p>
<p>The approach revolves around the following flow:</p>
<ol>
<li>prepare a <a href="https://developers.google.com/youtube/v3/docs/videos#resource">video resource</a> - this is a JSON structure where you put your video metadata</li>
<li>POST this JSON structure to the API endpoint, and expect a Location header in the response</li>
<li>POST the binary content of the video itself to the URL that the Location header pointed to</li>
</ol>
<p>Here's a brief example based on a throwaway script I created to use the API.</p>
<p><strong>Preparing the video resource</strong></p>
<p>I don't like writing JSON by hand, I prefer writing YAML and then having it converted to JSON on the fly. Here's a function I wrote to produce the video resource:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function-name function">videoresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  yq e <span class="token parameter variable">-j</span> <span class="token parameter variable">-I</span><span class="token operator">=</span><span class="token number">0</span> - <span class="token operator">&lt;&lt;</span><span class="token string">EODATA
snippet:
  categoryId: 28
  title: The video title
  description: |
    A longer description that can run over
    several lines if needed. This is the text
    that appears beneath the video on YouTube.
  tags:
    - sap
    - bash
    - jq
    - scripting
    - btp
status:
  selfDeclaredMadeForKids: False
  privacyStatus: Unlisted
recordingDetails:
  recordingDate: 2018-03-31T00:00:00Z
EODATA</span>
<span class="token punctuation">}</span></code></pre>
<p>I'm using <code>yq</code> to evaluate (<code>e</code>) the YAML and emit JSON (<code>-j</code>). The <code>-I=0</code> tells <code>yq</code> to put all the JSON output on a single line (by default it will nicely pretty-print it with whitespace).</p>
<p><strong>Posting the JSON video resource</strong></p>
<p>In making a POST request to the <a href="https://developers.google.com/youtube/v3/docs/videos/insert">Videos: insert</a> endpoint, you need to specify the <code>part</code> parameter, which, amongst other things, describes what you're sending in the video resource. I prepare my <code>part</code> parameter like this (and yes, I know I should URL encode the values, but hey, it's a throwaway script and it worked):</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function-name function">urlparameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">paste</span> <span class="token parameter variable">-s</span> -d<span class="token string">'&amp;'</span> - <span class="token operator">&lt;&lt;</span><span class="token string">EOPARM
part=snippet,status,recordingDetails
notifySubscribers=False
uploadType=resumable
EOPARM</span>
<span class="token punctuation">}</span></code></pre>
<p>As well as adding the optional parameter <code>notifySubscribers</code> I also added the <code>uploadType</code> parameter. While not directly documented on the <a href="https://developers.google.com/youtube/v3/docs/videos/insert">Videos: insert</a> page, it appears in the <a href="https://developers.google.com/youtube/v3/docs/videos/insert#ruby">Ruby code sample</a> there and seems to be quite important.</p>
<p>Using the two functions thus defined, it's a straightforward matter of using the Swiss Army toolchain of HTTP clients, the venerable <code>curl</code>:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token string">"https://www.googleapis.com/upload/youtube/v3/videos?<span class="token variable"><span class="token variable">$(</span>urlparameters<span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--verbose</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">"Authorization: Bearer <span class="token variable"><span class="token variable">$(</span>tget<span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">"Accept: application/json"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--data</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>videoresource<span class="token variable">)</span></span>"</span></code></pre>
<p>You'll need to supply an OAuth access token as the value for the Bearer token in the <code>Authorization</code> header - I want to focus on the actual two-phase upload here so I'll leave the <code>tget</code> script that I have for another time.</p>
<p>Here's a slightly redacted snippet of the HTTP request and response:</p>
<pre><code>&gt; POST /upload/youtube/v3/videos?part=snippet... HTTP/2
&gt; Host: www.googleapis.com
&gt; User-Agent: curl/7.64.1
&gt; Authorization: Bearer ya23supersekritaccesstokenhunter2
&gt; Accept: application/json
&gt; Content-Type: application/json
&gt; Content-Length: 111
&gt;
&lt; HTTP/2 200
&lt; content-type: text/plain; charset=utf-8
&lt; content-type: application/json; charset=UTF-8
&lt; x-guploader-uploadid: ABg5...
&lt; location: https://www.googleapis.com/upload/youtube/v3/videos?part=snippet...&amp;upload_id=ABg5someuniqueuploadidentifier
&lt; content-length: 0
&lt; date: Tue, 30 Mar 2021 07:14:47 GMT
&lt; server: UploadServer
</code></pre>
<p>While there are a couple of odd aspects to that HTTP response (see below), what we're looking for here is the Location header. The URL there is the one to which we must now send the binary data of the video.</p>
<p><strong>Sending the binary data</strong></p>
<p>In the first phase we sent the JSON representation of the video resource, the video's metadata, effectively. In this second phase we now send the video content itself, to the URL in the Location header in the first phase's response.</p>
<p>With <code>curl</code>, sending binary data in a file is easier than you think:</p>
<pre class="language-bash" tabindex="0"><code class="language-bash"><span class="token function">curl</span> <span class="token punctuation">\</span>
  <span class="token string">"https://www.googleapis.com/upload/youtube/v3/videos?part=snippet...&amp;upload_id=ABg5someuniqueuploadidentifier"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">"Authorization: Bearer <span class="token variable"><span class="token variable">$(</span>tget<span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>
  --data-binary @videofile.mp4</code></pre>
<p><strong>Wrapping up</strong></p>
<p>That's pretty much it. I must say, I have struggled to get my brain around some of the YouTube API surface area, but the mist is starting to clear. If you're like me and also trying to grok things, perhaps this post will help a little.</p>
<p>Oh yes, and those odd aspects to the first phase HTTP response earlier?</p>
<p>Well, for a start, why are there two different Content-Type headers?</p>
<p>More importantly though, sending an HTTP 200 response to the request seems a little suspect. It's HTTP status <a href="https://tools.ietf.org/html/rfc2616#section-10.2.2">201 CREATED</a> that is appropriate here, not <a href="https://tools.ietf.org/html/rfc2616#section-10.2.1">200 OK</a>. And while a Location header in an HTTP response is appropriate (and more or less required) with a 201 CREATED status, with a 200 OK status it is not.</p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2021/03/27/la-pavoni-maintenance-successful/">La Pavoni maintenance successful</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2021/03/31/deeper-connections-to-everyday-tools/">Deeper connections to everyday tools</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2021/03/30/two-phase-video-uploads-with-youtube-api-and-curl/` was built on 2025-09-22T10:41:22.043Z -->
		<script type="module" src="/dist/R1izrEYWYW.js"></script>
	</body>
</html>
