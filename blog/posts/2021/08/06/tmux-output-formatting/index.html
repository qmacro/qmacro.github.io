<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://qmacro.org/blog/posts/2021/08/06/tmux-output-formatting/"><link href="/assets/main.b6be6784e8575ba25795.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet"><title>tmux output formatting | DJ Adams</title><link rel="icon" type="“image/x-icon”" href="/images/favicon.ico"><meta property="og:title" content="tmux output formatting"><meta property="og:site_name" content="DJ Adams"><meta property="og:type" content="website"><meta property="og:url" content="https://qmacro.org/blog/posts/2021/08/06/tmux-output-formatting/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@qmacro"><meta name="description" content="tmux output formatting 06 Aug 2021 | 5 min read Here&#39;s what I learned today about FORMATS in tmux output. This week I came across Waylon..."><meta property="og:description" content="tmux output formatting 06 Aug 2021 | 5 min read Here&#39;s what I learned today about FORMATS in tmux output. This week I came across Waylon..."><meta name="description" content="tmux output formatting 06 Aug 2021 | 5 min read Here&#39;s what I learned today about FORMATS in tmux output. This week I came across Waylon..."><meta property="og:image" content="https://qmacro.org/images/site-image.png"><meta name="twitter:image" content="https://qmacro.org/images/site-image.png"><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script><script>window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4WQKBG0L4Y');</script></head><body><div class="layout-wrapper"><header class="header"><div class="header__content"><h1 class="site-title"><a href="/">DJ Adams</a></h1><nav class="nav"><ul class="nav__list"><li class="nav-item"><a href="/about">About Me</a></li><li class="nav-item"><a href="/talks">Talks</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="/feed.xml">Feed</a></li></ul></nav></div></header><main class="main"><article class="post"><header class="post__header"><h1>tmux output formatting</h1><div class="post__details"><time datetime="2021-08-06">06 Aug 2021 </time><span>| </span><span>5 min read</span></div></header><main class="post__content"><p><em>Here's what I learned today about FORMATS in tmux output.</em></p><p>This week I came across <a href="https://twitter.com/_WaylonWalker">Waylon Walker</a> who is doing some lovely learning-and-sharing on the topic of <code>tmux</code>, the terminal multiplexer. He has a <a href="https://www.youtube.com/user/quadmx08">YouTube channel</a> and a <a href="https://waylonwalker.com">blog</a>, and there are plenty of <code>tmux</code> nuggets that are explained in short video and blog post formats.</p><p>I read Waylon's post <a href="https://waylonwalker.com/tmux-fzf-session-jump/">tmux fzf session jumper</a> that he published yesterday, and, having been curious to learn more about his <code>tmux</code> setup and usage, I stared a bit at the commands he'd shared. Here's what he was using, in his <code>tmux</code> popup based session selector (I was so happy to learn about <code>tmux</code> popups from Waylon, more on that topic another time, perhaps):</p><pre class="language-bash"><code class="language-bash">tmux <span class="token builtin class-name">bind</span> C-j <span class="token punctuation">\</span><br>  display-popup <span class="token punctuation">\</span><br>  -E <span class="token punctuation">\</span><br>  <span class="token string">"tmux list-sessions \<br>   | sed -E 's/:.*$//' \<br>   | grep -v <span class="token entity" title="\&quot;">\"</span>^<span class="token variable"><span class="token variable">$(</span>tmux display-message -p <span class="token string">'#S'</span><span class="token variable">)</span></span>\$<span class="token entity" title="\&quot;">\"</span> \<br>   | fzf --reverse \<br>   | xargs tmux switch-client -t"</span></code></pre><p>That's quite a bit to unpack and learn from! I've taken the liberty of inserting lots of newlines so we can stare at it more easily.</p><p>Before we start to unpack it, you can see what it does in this screenshot - on invocation, it brings up a session chooser in a popup for me to be able to switch to a different session. Nice!</p><p><img src="/images/2021/08/session-chooser.png" alt="session chooser in popup"></p><h2>Unpacking the invocation</h2><p>The invocation itself is creating a new key binding (<code>prefix</code> <code>ctrl-j</code>) with the <code>bind</code> (short for <code>bind-key</code>) command. The command that is invoked when this key combination is used is a relatively new one: <code>display-popup</code>. It seems that the popup feature appeared only about a year ago with <code>tmux</code> version 3.2 - see the <a href="https://github.com/tmux/tmux/issues/2645">associated change notes and discussion for 3.2</a> for more context.</p><p>The <code>-E</code> switch goes with the <code>display-popup</code> command and causes the popup to close automatically when the shell command that's executed within it completes.</p><p>The shell command to execute within the popup follows, and is basically the rest of the line - everything inside the outermost double-quote pair (<code>&quot;tmux list-sessions ... -t&quot;</code>). This is a pipeline that starts with the output of whatever <code>tmux list-sessions</code> produces - here's an example of that output, from the sessions I'm running right now:</p><pre><code>another session: 1 windows (created Fri Aug  6 11:24:34 2021) (attached)
tmux experiments: 2 windows (created Thu Aug  5 21:04:16 2021)
writing: 2 windows (created Fri Aug  6 11:02:10 2021)
</code></pre><p>I added a third session, &quot;another session&quot;, to have more than just a couple for the example, and it's in that third session that I invoked the <code>tmux list-sessions</code> command just now - which is why that is the one marked as <code>(attached)</code> in the output.</p><h3>Removing unwanted information</h3><p>That output is passed to <code>sed -E 's/:.*$//'</code> which uses an extended (that's what the <code>-E</code> denotes) regular expression to replace everything on the line* starting with a colon and going all the way to the end of the line, with nothing. This would change the output above to this:</p><pre><code>another session
tmux experiments
writing
</code></pre><p>* <code>sed</code> is a stream editor and processes each line in turn</p><h3>Filtering out the name of the current session</h3><p>This reduced output is then piped into <code>grep</code>, the search utility. The <code>-v</code> switch used inverts the match, effectively printing what is <em>not</em> matched by the regular expression that is given.</p><p>And what is that, exactly? It's this: <code>\&quot;^$(tmux display-message -p '#S')\$\&quot;</code>. First, because we're already in the context of the pair of outermost double-quotes, the double-quotes used here to enclose the entire pattern need to be escaped, with the backslashes. And within those escaped double-quotes we have <code>^</code> that anchors the match to the start of the line, and <code>$</code> (escaped again, because it has special meaning within double-quotes) which anchors to the end of the line. And what should actually be matched? If we stare hard enough, we see that what should be matched is the output of running the following command in a subshell (<code>$(...)</code>):</p><pre class="language-bash"><code class="language-bash">tmux display-message -p <span class="token string">'#S'</span></code></pre><p>The <code>display-message</code> command normally writes a message to the <code>tmux</code> session's status line, but the <code>-p</code> switch directs the command to write the message to STDOUT instead. What is the message to be written? Well, it's the value of <code>#S</code>, which is a variable (identified by the <code>#</code>), and specifically, <code>S</code> is an alias for <code>session_name</code>. So this command prints the name of the current session to STDOUT. In the same context as before (i.e. attached to the &quot;another session&quot; session), running this command would produce this:</p><pre><code>another session
</code></pre><p>So the ultimate result of piping the list of session names into this inverted matching <code>grep</code> invocation is that it would filter out the current session's name, resulting in:</p><pre><code>tmux experiments
writing
</code></pre><p>Why do this? Well, it makes sense that if I'm going to pick another session to jump to, I probably won't want to jump to my current session.</p><h3>Presenting the list for selection</h3><p>This reduced list is then piped into <code>fzf</code>, about which I've written a couple of posts on this autodidactics blog before:</p><ul><li><a href="https://qmacro.org/autodidactics/2021/02/02/fzf-the-basics-1-layout/">fzf - the basics part 1 - layout</a></li><li><a href="https://qmacro.org/autodidactics/2021/02/07/fzf-the-basics-2-search-results/">fzf - the basics part 2 - search results</a></li></ul><p>Using <code>fzf</code> here is perfect, it's my tool of choice for mini-UIs in the terminal where a choice has to be made, where an item (or items) must be selected. And because it fits with the Unix philosophy too, the output is simply the value of the item(s) selected. And in case you're wondering, the <code>--reverse</code> switch is a synonym for <code>--layout=reverse</code> which causes <code>fzf</code> to display the selection from the top.</p><h3>Jumping to the selected session</h3><p>In the last part of the pipeline, this value (the name of the session that was selected) is passed to <code>xargs</code>, the powerful but oft-misunderstood utility that helps you build and execute commands from STDIN. Here, with the invocation <code>xargs tmux switch-client -t</code>, we're using it to pass that selected value (e.g. &quot;writing&quot;) as a parameter, adding it to the end of the entire set of arguments passed to <code>xarg</code>, resulting in an invocation like this:</p><pre class="language-bash"><code class="language-bash">tmux switch-client -t writing</code></pre><p>This of course is the denoument to which we've been building up, and our <code>tmux</code> client is switched to the session we selected. Success!</p><h2>Formats and an alternative approach</h2><p>The reference to the <code>#S</code> variable got me thinking, and I remembered seeing an awful lot of potential, particularly in the &quot;FORMATS&quot; section of the <a href="https://man7.org/linux/man-pages/man1/tmux.1.html"><code>tmux</code> man page</a>. So I thought I'd use this opportunity, having been inspired by what Waylon showed, to see if I could come up with a different way of doing it.</p><p>First, could I use something from &quot;FORMATS&quot; to avoid the need to invoke <code>sed</code> in the pipeline (i.e. to not do this bit: <code>sed -E 's/:.*$//'</code>)? Turns out that the answer is yes; a format string can be used with the <code>list-sessions</code> command, with the <code>-F</code> option. So this would be an alternative, using the same variable as we saw earlier. Here's the invocation:</p><pre class="language-bash"><code class="language-bash">tmux list-sessions -F <span class="token string">'#{session_name}'</span></code></pre><p>which produces:</p><pre><code>another session
tmux experiments
writing
</code></pre><p>That is, none of the extraneous information is there, so we don't need to remove it.</p><p>We can go a bit further, too, with a conditional expression. Here it is, in action:</p><pre class="language-bash"><code class="language-bash">tmux list-sessions -F <span class="token string">'#{?session_attached,,#{session_name}}'</span></code></pre><p>The value of the <code>session_attached</code> variable is <code>1</code> if the session currently being listed is attached (i.e. is the one we're in) and <code>0</code> if not. So this conditional expression <code>#{?COND,A,B}</code> outputs A if condition COND is true, otherwise B. What a lovely ternary style operator just waiting to be used within <code>tmux</code> formatting!</p><p>So this version produces:</p><pre><code>
tmux experiments
writing
</code></pre><p>The empty line comes from the fact that for the A value in the conditional expression above, we specified nothing (there was nothing between the two commas <code>,,</code>) when the session to which we're currently attached is listed.</p><p>That means we still have something to filter out, with <code>grep</code>, but it becomes simpler, with the briefest of patterns needed for <code>grep</code>, to match and filter out (with <code>-v</code>) empty lines: <code>^$</code> - i.e. &quot;the start of the line followed immediately by the end of the line&quot;. Like this:</p><pre class="language-bash"><code class="language-bash">tmux list-sessions -F <span class="token string">'#{?session_attached,,#{session_name}}'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token string">'^$'</span></code></pre><p>This produces:</p><pre><code>tmux experiments
writing
</code></pre><p>which then can be passed as before into <code>fzf</code> for selection.</p><h2>Wrapping up</h2><p>This is in no way an attempt to &quot;better&quot; Waylon's post - far from it. It's a different way of approaching things, but most importantly, it's a classic example of folks learning together and from each other. Thanks Waylon, I'm looking forward to learning more from what you share.</p></main><aside class="post__aside"><div class="post__tags"><a href="/tags/autodidactics/">#autodidactics</a> <a href="/tags/tmux/">#tmux</a></div><style>.utterances {
  margin-left: inherit !important;
}</style><script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async></script><nav class="post__pagination"><a href="/blog/posts/2021/08/12/session-switching-with-the-tmux-menu/"><span>←</span> <span>Session switching with the tmux menu</span> </a><a href="/blog/posts/2021/07/26/reopening-pull-requests-and-github_actor/"><span>Reopening pull requests and GITHUB_ACTOR</span> <span>→</span></a></nav></aside></article></main><footer class="footer"><div class="footer__content"><ul class="hero__social-links"><li><a rel="me" href="https://github.com/qmacro" target="_blank" rel="noopener noreferrer">GitHub</a></li><li><a rel="me" href="https://www.youtube.com/djadams-qmacro" target="_blank" rel="noopener noreferrer">YouTube</a></li><li><a rel="me" href="https://twitter.com/qmacro" target="_blank" rel="noopener noreferrer">Twitter</a></li><li><a rel="me" href="https://hachyderm.io/@qmacro" target="_blank" rel="noopener noreferrer">Mastodon</a></li><li><a href="/feed.xml" target="_blank" rel="noopener noreferrer">RSS</a></li></ul></div></footer></div><script src="/assets/main.31d6cfe0d16ae931b73c.js"></script></body></html>