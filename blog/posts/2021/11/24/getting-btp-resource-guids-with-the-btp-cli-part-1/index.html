<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Getting BTP resource GUIDs with the btp CLI - part 1</title>
		<meta name="description" content="Reserving the right to be wrong.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
		<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

      <meta property="og:title" content="Getting BTP resource GUIDs with the btp CLI - part 1">
        <meta property="og:site_name" content="DJ Adams">
          <meta property="og:image" content="/images/site-image.png">
        <meta property="og:description" content="Reserving the right to be wrong.">
        <meta property="og:url" content="https://qmacro.org/blog/posts/2021/11/24/getting-btp-resource-guids-with-the-btp-cli-part-1/">
		
		
		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #2884d2;
	--text-color-link-active: #15b0ed;
	--text-color-link-visited: #9f4199;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 40em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden:not(:focus):not(:active) {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
/* main :first-child { */
/* 	margin-top: 0; */
/* } */

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

#skip-link {
	text-decoration: none;
	background: var(--background-color);
	color: var(--text-color);
	padding: 0.5rem 1rem;
	border: 1px solid var(--color-gray-90);
	border-radius: 2px;
}

/* Prevent visually-hidden skip link fom pushing content around when focused */
#skip-link.visually-hidden:focus {
	position: absolute;
	top: 1rem;
	left: 1rem;
	/* Ensure it is positioned on top of everything else when it is shown */
	z-index: 999;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
	color: seagreen;
}

pre,code[class*="language-"] {
	line-height: 1.2em !important;
	font-size: 0.93em !important;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-word;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	counter-reset: start-from var(--postlist-index);
	list-style: none;
	padding: 0;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-style: italic;
}

/* may want to make the description text smaller at some stage */
.post-description-list {
	font-size: 1.0em;
}

.post-description-main {
	font-style: italic;
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

blockquote {
	margin-top: 0px;
	margin-left: 0px;
	margin-bottom: 15px;
	padding-left: 15px;
	border-left: 5px solid lightgray;
}
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
.utterances {
  margin-left: inherit !important;
}</style>
		

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4WQKBG0L4Y"></script>
    

	</head>
	<body>
		<a href="#main" id="skip-link" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">DJ Adams</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="main">
			<heading-anchors>
				


<h1 id="getting-btp-resource-guids-with-the-btp-cli-part-1">Getting BTP resource GUIDs with the btp CLI - part 1</h1>

<ul class="post-metadata">
	<li><time datetime="2021-11-24">24 November 2021</time></li>
	<li><a href="/tags/sapcommunity/" class="post-tag">sapcommunity</a>, </li>
	<li><a href="/tags/btp/" class="post-tag">btp</a>, </li>
	<li><a href="/tags/cli/" class="post-tag">cli</a>, </li>
	<li><a href="/tags/shell/" class="post-tag">shell</a></li>
</ul>

<p class="post-description-main"></p>

<p><em>Learn how to use the btp CLI to determine resource GUIDs in your global
account. This post is part 1, covering the <code>bgu</code> mechanism.</em></p>
<p>Update: the second blog post in this series is now also available:
<a href="https://blogs.sap.com/2021/12/01/getting-btp-resource-guids-with-the-btp-cli-part-2-json-and-jq/">Getting BTP resource GUIDs with the btp CLI -- part 2 -- JSON and
jq</a>.</p>
<p>In the <a href="https://reg.sapevents.sap.com/flow/sap/sapteched2021/portal/page/sessions/session/1632238684525001QKhY">Developer
Keynote</a>
during SAP TechEd, specifically in the Command Line Magic
<a href="https://github.com/SAP-samples/teched2021-developer-keynote#sections">section</a>,
I used a little mechanism I called <code>bgu</code> (for &quot;btp GUID&quot;), to
determine the GUIDs for various resources (a subaccount, and later, a
directory) in my global account. Here you can see <code>bgu</code> in action:</p>
<p><img src="/images/2021/11/bgu-trial-1.png" alt=""></p>
<p><img src="/images/2021/11/bgu-messaging-1.png" alt=""></p>
<p>In case you're interested in re-watching this section of the Developer
Keynote, there's a link in the <a href="#furtherreading">Further reading and
viewing</a> section later.</p>
<p>In this post I explain what this <code>bgu</code> mechanism is and how it works,
because it may be useful to you too. Moreover, the background
information and context should provide you with some extra knowledge
about BTP and the command line interface tool, <code>btp</code>.</p>
<h2 id="starting-at-a-high-level">Starting at a high level</h2>
<p>The <code>bgu</code> mechanism is actually a function in my shell environment,
which calls a script called <code>btpguid</code>. This in turn uses the btp CLI to
examine the global account's resource hierarchy and pick information
out of it - specifically the GUID for a given resource name. Let's
break that down.</p>
<p>We can ask what <code>bgu</code> is with the Bash shell's <code>type</code> builtin. This
itself is an opportunity for us to enjoy a little bit of meta before we
start, by asking what the type of <code>type</code> is:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token builtin class-name">type</span> <span class="token builtin class-name">type</span>
<span class="token builtin class-name">type</span> is a shell <span class="token builtin class-name">builtin</span></code></pre>
<p>Anyway, enough of that, let's ask what <code>bgu</code> is:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token builtin class-name">type</span> bgu
bgu is a <span class="token keyword">function</span>
<span class="token function-name function">bgu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    btpguid <span class="token string">"<span class="token variable">$@</span>"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-gt</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        btpctx <span class="token operator">></span> <span class="token string">"<span class="token environment constant">$HOME</span>/.status"</span><span class="token punctuation">;</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span></code></pre>
<p>So there we are, <code>bgu</code> is a function that I've defined and made
available in my shell. All it does is call <code>btpguid</code> with all of the
arguments that were passed:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">btpguid <span class="token string">"<span class="token variable">$@</span>"</span></code></pre>
<p>Then, depending on circumstances, it calls another script (<code>btpctx</code>) to
write some info to a status file. This is not relevant here (it's
related to my <code>tmux</code>-based status line in my terminal) so let's just
focus on the call to <code>btpguid</code>.</p>
<p>So what is <code>btpguid</code>? Let's find out:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> <span class="token builtin class-name">type</span> btpguid
btpguid is /home/user/.dotfiles/scripts/btp/btpguid</code></pre>
<p>So <code>btpguid</code> is a script. Great, let's have a look at it!</p>
<p><a name="the-btpguid-script"></a></p>
<h2 id="the-btpguid-script">The btpguid script</h2>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token comment"># btpguid - return BTP subaccount/directory GUIDs</span>

<span class="token comment"># Usage: btpguid [-t|--target] displayname</span>

<span class="token comment"># Returns the GUID for the given subaccount or directory, which is</span>
<span class="token comment"># specified by name. If the option -t or --target is specified, it</span>
<span class="token comment"># will also set that subaccount or directory as the target.</span>

<span class="token comment"># Requires the btp CLI. Will direct you to log in first if you're</span>
<span class="token comment"># not already logged in.</span>

<span class="token comment"># It uses the detail from the output of this command:</span>
<span class="token comment"># btp get accounts/global-account --show-hierarchy</span>

<span class="token comment"># The output looks like this:</span>

<span class="token comment"># Showing details for global account af39080b-1527-40a1-b78a-3b605af7e811...</span>
<span class="token comment">#</span>
<span class="token comment"># ├─ c35b11e4trial (af39080b-1527-40a1-b78a-3b605af7e811 - global account)</span>
<span class="token comment"># │  ├─ trial (b6501bff-e0ac-4fdf-8898-81f305d25335 - subaccount)</span>
<span class="token comment"># │  ├─ techedhouse (e57c5b13-9480-4a68-9c04-a603d7a017a9 - directory)</span>
<span class="token comment">#</span>
<span class="token comment"># type:            id:                                    display name:   parent id:</span>
<span class="token comment"># global account   af39080b-1527-40a1-b78a-3b605af7e811   c35b11e4trial</span>
<span class="token comment"># subaccount       b6501bff-e0ac-4fdf-8898-81f305d25335   trial           af39080b-...</span>
<span class="token comment"># directory        e57c5b13-9480-4a68-9c04-a603d7a017a9   techedhouse     af39080b-...</span>

<span class="token comment"># It's the second part of the output (the table) that is used.</span>

<span class="token comment"># Uses the "${2:-$1}" technique seen in fff - see</span>
<span class="token comment"># https://qmacro.org/blog/posts/2021/09/03/exploring-fff-part-1-main/</span>
<span class="token comment"># for details.</span>

<span class="token function-name function">gethier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  btp get accounts/global-account --show-hierarchy <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null
<span class="token punctuation">}</span>

<span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token builtin class-name">local</span> hierarchy subtype guid displayname <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span>

  <span class="token assign-left variable">displayname</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${2<span class="token operator">:-</span>$1}</span>"</span>

  <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">$displayname</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"No display name specified"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token assign-left variable">hierarchy</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>gethier<span class="token variable">)</span></span>"</span> <span class="token operator">||</span> <span class="token punctuation">{</span> btp login <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">hierarchy</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>gethier<span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> subtype guid <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"$(grep -P -o "^(subaccount|directory)\s+(\S+)(?=\s+<span class="token variable">$displayname</span>)"</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$hierarchy</span>"</span><span class="token punctuation">)</span><span class="token string">"

  # Set the subtype as target if requested
  [[ <span class="token variable">$1</span> == -t ]] || [[ <span class="token variable">$1</span> == --target ]] &amp;&amp; {
    btp target "</span>--<span class="token variable">${subtype}</span><span class="token string">" "</span><span class="token variable">$guid</span><span class="token string">" &amp;> /dev/null
    rc=<span class="token variable">$?</span>
  }

  echo "</span><span class="token variable">$guid</span><span class="token string">"
  return <span class="token variable">$rc</span>

}

main "</span><span class="token variable">$@</span>"</code></pre>
<p>Hopefully the comments provide the general idea - given the name of a
resource, say &quot;trial&quot; or &quot;techedhouse&quot;, this script will find and
return that resource's GUID. In addition, if the <code>--target</code> option is
specified, it will also <a href="https://help.sap.com/products/BTP/65de2977205c403bbc107264b8eccf4b/720645a3ed3945bd8d97a670b948ac07.html?locale=en-US">set the default command
context</a>,
but we'll leave that for another time.</p>
<h2 id="an-overview-of-structure-in-btp">An overview of structure in BTP</h2>
<p>Before we dig in to some of the details of the script, let's just spend
a few moments thinking about subaccounts and the hierarchies that can be
built using directories.</p>
<p>Basically, within a global account, you can create subaccounts, and you
can set up those subaccounts using directories. This is a flexible and
simple way to organise resources, assignments, adminstrative access and
more using a well understood paradigm.</p>
<p>You can read more about this on the SAP Help Portal in <a href="https://help.sap.com/products/BTP/df50977d8bfa4c9a8a063ddb37113c43/b5a6b58694784d0c9f4ff85f9b7336dd.html?locale=en-US">Account Models
With Directories and Subaccounts [Feature Set
B]</a>.</p>
<p>Let's look at an example. The structure that existed at the end of the
Command Line Magic section of the Developer Keynote looked like this:</p>
<pre class="language-text" tabindex="0"><code class="language-text">├─ 1a99110dtrial (c63c501e-e589-467d-8875-1821927ea713 - global account)
│  ├─ trial (00516298-b174-418e-9824-8824de04bfa3 - subaccount)
│  ├─ techedhouse (2558794c-f8cd-4422-b071-3b21c2922a02 - directory)
│  │  ├─ messaging (3ea88c9c-010b-4bf0-9fdb-5c29c9087660 - subaccount)</code></pre>
<p>We saw, very briefly, a representation of this structure in the BTP
cockpit too, right at the end of this section of the keynote:</p>
<p><img src="/images/2021/11/hierarchy-1.png" alt=""></p>
<p>Staring at this structure for a few seconds, we see that it's made up
of directories and subaccounts; the &quot;messaging&quot; subaccount sits within
the &quot;techedhouse&quot; directory, which itself sits alongside (at the same
level as) the default &quot;trial&quot; subaccount that was set up automatically
for me when my global account was created.</p>
<h2 id="resources-guids-and-command-substitution">Resources, GUIDs and command substitution</h2>
<p>When managing these subaccount and directory resources, GUIDs are used.
We saw multiple examples where GUIDs are required - here are three of
them. However, note that each time, instead of finding and specifying a
GUID manually, a <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Substitution.html">command
substitution</a>
(they look like this: <code>$(...)</code>) is used, to make things easier:</p>
<ul>
<li><a href="https://github.com/SAP-samples/teched2021-developer-keynote/tree/main/section/command-line-magic#reducing-existing-entitlement-quota-to-zero">Reducing quota for a subaccount</a>: <code>btp assign accounts/entitlement --for-service enterprise-messaging --plan dev --to-subaccount $(bgu trial) --amount 0</code></li>
<li><a href="https://github.com/SAP-samples/teched2021-developer-keynote/tree/main/section/command-line-magic#assigning-service-quota-to-directory">Assigning quota to a directory</a>: <code>btp assign accounts/entitlement --for-service enterprise-messaging --plan dev --to-directory $(bgu techedhouse) --amount 1 --auto-assign</code></li>
<li><a href="https://github.com/SAP-samples/teched2021-developer-keynote/tree/main/section/command-line-magic#creating-the-new-subaccount">Creating the subaccount within a directory</a>: <code>btp create accounts/subaccount --region us10 --display-name messaging --beta-enabled true --subdomain $(uuidgen) --directory $(bgu techedhouse)</code></li>
</ul>
<p>In each case, instead of manually looking up the GUID for a resource,
and then copy-pasting that in for the value to use with
<code>--to-subaccount</code>, <code>--to-directory</code> and <code>--directory</code> above, the <code>bgu</code>
mechanism was used to do that for us. As the <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Substitution.html">manual section on command
substitution</a>
says:</p>
<blockquote>
<p>&quot;<em>command substitution allows the output of a command to replace the
command itself</em>&quot;</p>
</blockquote>
<p>In other words, when you see something like this (taken from the first
example above):</p>
<pre class="language-text" tabindex="0"><code class="language-text">--to-subaccount $(bgu trial)</code></pre>
<p>then what happens is that the command <code>bgu trial</code> is executed, and the
output is then substituted as the value for the <code>--to-subaccount</code>
parameter.</p>
<p>(In case you're wondering, command substitution comes in two forms:
<code>`...`</code> and <code>$(...)</code>; the former is now deprecated.)</p>
<p><a name="determining-the-guids"></a></p>
<h2 id="determining-the-guids">Determining the GUIDs</h2>
<p>Now that we understand the structure of resources in BTP accounts, we
can turn our attention to the heart of the <code>btpguid</code> script. This
incarnation of the script, which was used in the Developer Keynote,
invokes a btp CLI command (which we'll see shortly), and parses some of
its output:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token assign-left variable">hierarchy</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>gethier<span class="token variable">)</span></span>"</span> <span class="token operator">||</span> <span class="token punctuation">{</span> btp login <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">hierarchy</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>gethier<span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> subtype guid <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"$(grep -P -o "^(subaccount|directory)\s+(\S+)(?=\s+<span class="token variable">$displayname</span>)"</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$hierarchy</span>"</span><span class="token punctuation">)</span>"</code></pre>
<p>Let's break that down so we understand what's going on.</p>
<p>The first line executes the <code>gethier</code> function which is defined earlier
in the script.</p>
<blockquote>
<p>In case you're wondering about the rest of the first line, this is to
deal with the situation where you're not yet (or no longer) logged in
with <code>btp</code>, and if that's the case, you're guided to log in first,
and then the call is re-tried.</p>
</blockquote>
<p>The <code>gethier</code> function just runs the following <code>btp</code> command:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">btp get accounts/global-account --show-hierarchy <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null</code></pre>
<blockquote>
<p>I'm redirecting standard error (with <code>2&gt;</code>) to <code>/dev/null</code>, to get rid
of anything printed there. Currently the btp CLI outputs an &quot;OK&quot; to
standard error, and I don't want to see that anywhere.</p>
</blockquote>
<p>The <code>--show-hierarchy</code> parameter is responsible for the lovely detail
that you saw earlier. Let's look at an example of that detail before
diving into the second line, so we know what we're dealing with. This
example is from the script's comments above:</p>
<pre class="language-text" tabindex="0"><code class="language-text">Showing details for global account af39080b-1527-40a1-b78a-3b605af7e811...

├─ c35b11e4trial (af39080b-1527-40a1-b78a-3b605af7e811 - global account)
│  ├─ trial (b6501bff-e0ac-4fdf-8898-81f305d25335 - subaccount)
│  ├─ techedhouse (e57c5b13-9480-4a68-9c04-a603d7a017a9 - directory)

type:            id:                                    display name:   parent id:
global account   af39080b-1527-40a1-b78a-3b605af7e811   c35b11e4trial
subaccount       b6501bff-e0ac-4fdf-8898-81f305d25335   trial           af39080b-...
directory        e57c5b13-9480-4a68-9c04-a603d7a017a9   techedhouse     af39080b-...</code></pre>
<p>Right, so what is the second line doing? From a high level, it's
looking for lines in this output starting with either &quot;subaccount&quot; or
&quot;directory&quot;, grabbing the GUID and resource type on the line that's
found, and assigning them to two variables, <code>guid</code> and <code>subtype</code>
respectively:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> subtype guid <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"$(grep -P -o "^(subaccount|directory)\s+(\S+)(?=\s+<span class="token variable">$displayname</span>)"</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$hierarchy</span>"</span><span class="token punctuation">)</span>"</code></pre>
<p>It looks a little complex, but if you stare at it for a few minutes,
this pattern emerges:</p>
<blockquote>
<p>read [into two variables] from the results of searching and
extracting values from the hierarchy data</p>
</blockquote>
<p>A couple of &quot;here strings&quot; in the form of the <code>&lt;&lt;&lt;</code> construct are used
(see section 3.6.7 of the <a href="https://www.gnu.org/software/bash/manual/html_node/Redirections.html">Bash manual section on
redirections</a>).
Such &quot;here strings&quot; allow us to supply the value of a variable as
input data to a command or builtin that would normally expect to read
from standard input (STDIN). If you're interested in understanding here
strings and how they fit in, have a look at <a href="/blog/posts/2021/11/07/exploring-fff-part-2-get_ls_colors/">Input/output redirection,
here documents and here
strings</a>.</p>
<p>Knowing this, we can break the line down into parts. The first part is
this, inside the command substitution construct <code>$(...)</code>:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token function">grep</span> <span class="token parameter variable">-P</span> <span class="token parameter variable">-o</span> <span class="token string">"^(subaccount|directory)\s+(\S+)(?=\s+<span class="token variable">$displayname</span>)"</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$hierarchy</span>"</span></code></pre>
<p>Here are some notes to help you interpret this:</p>
<table>
<thead>
<tr>
<th>Part</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>grep</code></td>
<td>this is the command to search for patterns in data</td>
</tr>
<tr>
<td><code>-P</code></td>
<td>this tells <code>grep</code> that we're going to use a Perl Compatible Regular Expression (PCRE)</td>
</tr>
<tr>
<td><code>-o</code></td>
<td>this tells <code>grep</code> to output not the entire matched line, but only the parts that are matched and captured (via parentheses)</td>
</tr>
<tr>
<td><code>&quot;$hierarchy&quot;</code></td>
<td>this is the value of the <code>hierarchy</code> variable that holds the output from <code>btp get accounts/global-account --show-hierarchy</code></td>
</tr>
<tr>
<td><code>^</code></td>
<td>this anchors the pattern to the beginning of the line (in other words, either &quot;subaccount&quot; or &quot;directory&quot; needs to be right at the start of the line for the match to be successful)</td>
</tr>
<tr>
<td><code>\s</code> and <code>\S</code></td>
<td>these are very common metacharacters used in regular expressions, and represent &quot;a whitespace character&quot; and &quot;anything but a whitespace character&quot; respectively</td>
</tr>
<tr>
<td><code>+</code></td>
<td>this is a modifier which represents &quot;at least one, possibly more&quot; and is different from <code>\*</code> which is &quot;zero or more&quot; and <code>?</code> which means &quot;optional (i.e. either no occurrence or just one occurrence)&quot;</td>
</tr>
<tr>
<td><code>$displayname</code></td>
<td>because the entire pattern is enclosed in double quotes (<code>&quot;...&quot;</code>) the shell will substitute the value of this variable into the pattern; the variable holds the value specified when <code>btpguid</code> is invoked, i.e. the name of the resource we're looking for</td>
</tr>
<tr>
<td><code>(...)</code></td>
<td>these are matching parentheses, called &quot;capturing groups&quot;, to identify and grab what we want from the match</td>
</tr>
<tr>
<td><code>(?=...)</code></td>
<td>this is a positive lookahead assertion which allows us to say things like &quot;must be followed by&quot; without consuming anything in the match; note also that despite there being parentheses, this is not itself a capturing group and therefore what's being asserted is not grabbed</td>
</tr>
<tr>
<td><code>&lt;&lt;&lt;</code></td>
<td>this is a here string construct that provides the input to <code>grep</code> from the value of the <code>hierarchy</code> variable instead of from standard input</td>
</tr>
</tbody>
</table>
<p>With that in mind, let's look again at the pattern, in quotes:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token string">"^(subaccount|directory)\s+(\S+)(?=\s+<span class="token variable">$displayname</span>)"</span></code></pre>
<p>If the <code>displayname</code> variable contains &quot;techedhouse&quot;, then, after
parameter substitution within these double quotes (i.e. at the shell
level), we have this as the actual pattern:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">^<span class="token punctuation">(</span>subaccount<span class="token operator">|</span>directory<span class="token punctuation">)</span><span class="token punctuation">\</span>s+<span class="token punctuation">(</span><span class="token punctuation">\</span>S+<span class="token punctuation">)</span><span class="token punctuation">(</span>?<span class="token operator">=</span><span class="token punctuation">\</span>s+techedhouse<span class="token punctuation">)</span></code></pre>
<p>Spoken out loud we might say: <em>the line must start with either
'subaccount' or 'directory' right at the beginning, and whichever it
is, we want to capture it; that must be directly followed by at least
one whitespace character (<code>\s+</code>), followed by at least one
non-whitespace character (<code>\S+</code>), and we want to capture those
non-whitespace characters*; oh, but also this must be followed (<code>(?=</code>)
by at least one whitespace character (<code>\s+</code>) and then 'techedhouse'</em>.</p>
<p>* those non-whitespace characters will be the GUID</p>
<p>Let's test this out manually, to see what happens. Let's assume that
we're looking for the GUID of a resource with a display name of
&quot;techedhouse&quot;:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token punctuation">;</span> btp get accounts/global-account --show-hierarchy <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null
  <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-P</span> <span class="token parameter variable">-o</span> <span class="token string">'^(subaccount|directory)\s+(\S+)(?=\s+techedhouse)'</span>
directory        2558794c-f8cd-4422-b071-3b21c2922a02</code></pre>
<p>Note that the whitespace and &quot;techedhouse&quot; inside the positive
lookahead assertion (i.e. <code>(?=\s+techedhouse)</code>) is not captured and
therefore we don't see it as a third value in the output.</p>
<p>With the two values output like this:</p>
<pre class="language-text" tabindex="0"><code class="language-text">directory        2558794c-f8cd-4422-b071-3b21c2922a02</code></pre>
<p>we can better understand what's happening with the <code>read</code> builtin;
let's substitute the output to see it in action:</p>
<pre class="language-shell" tabindex="0"><code class="language-shell"><span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> subtype guid <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"directory        2558794c-f8cd-4422-b071-3b21c2922a02"</span></code></pre>
<p>And guess what - after this, the <code>subtype</code> variable will contain
&quot;directory&quot; and the <code>guid</code> variable will contain
&quot;2558794c-f8cd-4422-b071-3b21c2922a02&quot;. And then with the <code>echo</code> a
little bit further on in the script, this GUID is emitted to standard
output before the script ends. Nice!</p>
<p>In case you're wondering about the <code>-r</code> option to the <code>read</code> builtin,
it's to stop any backslashes in the input being interpreted
inappropriately. I wrote about this in a recent post on my
<a href="/tags/blog/posts/">Autodidactics blog</a> - see <a href="/blog/posts/2021/11/07/exploring-fff-part-2-get_ls_colors/#readcommand">The read
command</a>
section of <a href="/blog/posts/2021/11/07/exploring-fff-part-2-get_ls_colors/">Exploring fff part 2 -
get_ls_colors</a>.</p>
<h2 id="wrapping-up-this-part">Wrapping up this part</h2>
<p>We can see how the power of the <a href="https://en.wikipedia.org/wiki/Unix_philosophy">Unix
Philosophy</a> helps us
prepare, run, and handle output of executables on the command line. Here
we put together just a few lines to help us level up and be even more
efficient, by allowing us to determine our SAP Business Technology
Platform account's resource GUIDs with zero effort, and use those
determined GUIDs in the context of other commands.</p>
<p>In part 2 we'll learn a little bit more about the Unix Philosophy and
then examine alternative output formats for complex data structures and
relationships; formats that are more predictable and - with the right
tools - more reliably parseable.</p>
<h2 id="further-reading-and-viewing">Further reading and viewing</h2>
<p>Here's a quick list of resources that you may wish to consume, relating
to what you've read in this post:</p>
<ul>
<li>The replay of the SAP TechEd Developer Keynote itself: <a href="https://www.youtube.com/watch?v=kOFuwDSXBZg">Improve Developers' Lives: Developer Keynote and Open Discussion</a></li>
<li>A link to the part of that Developer Keynote replay which goes directly to the relevant demo part: <a href="https://youtu.be/kOFuwDSXBZg?t=193">Command Line Magic</a></li>
<li>More on the Developer Keynote in this blog post from Thomas Jung: <a href="https://blogs.sap.com/2021/11/17/sap-teched-2021-developer-keynote/">SAP TechEd 2021 Developer Keynote</a></li>
<li>The SAP btp CLI branch of our SAP Tech Bytes repository on GitHub, which has links to related blog posts: <a href="https://github.com/SAP-samples/sap-tech-bytes/tree/2021-09-01-btp-cli">SAP btp CLI</a></li>
<li>The official place to download the btp CLI: <a href="https://tools.hana.ondemand.com/#cloud">SAP Development Tools - Cloud</a></li>
<li>A script that will download, unpack and set up the btp CLI for you: <a href="https://github.com/SAP-samples/sap-tech-bytes/blob/2021-09-01-btp-cli/getbtpcli">getbtpcli</a></li>
<li>A mini-series on the SAP btp CLI from the Hands-on SAP Dev show on the SAP Developers YouTube channel: <a href="https://www.youtube.com/playlist?list=PL6RpkC85SLQDXx827kdjKc6HRvdMRZ8P5">The SAP btp CLI</a></li>
<li>A reference manual for Bash: <a href="https://www.gnu.org/software/bash/manual/html_node/index.html">Bash Reference Manual</a></li>
<li>Documentation from the SAP Help Portal: <a href="https://help.sap.com/products/BTP/65de2977205c403bbc107264b8eccf4b/a21360fa19714751a7c49c796d39ac3d.html?locale=en-US&amp;state=DRAFT&amp;version=Cloud">Setting up a Trial Account via the Command Line [Feature Set B]</a></li>
<li>The official SAP btp CLI documentation: <a href="https://help.sap.com/products/BTP/65de2977205c403bbc107264b8eccf4b/7c6df2db6332419ea7a862191525377c.html?locale=en-US&amp;version=Cloud">Account Administration Using the SAP BTP Command Line Interface (btp CLI) [Feature Set B]</a></li>
<li>More deep dives into Bash script arcana: <a href="/blog/posts/2021/09/03/exploring-fff-part-1-main/">Exploring fff part 1 - main</a>
and <a href="/blog/posts/2021/11/07/exploring-fff-part-2-get_ls_colors/">Exploring fff part 2 - get_ls_colors</a></li>
</ul>
<p>The second blog post in this series is now also available: <a href="https://blogs.sap.com/2021/12/01/getting-btp-resource-guids-with-the-btp-cli-part-2-json-and-jq/">Getting BTP
resource GUIDs with the btp CLI -- part 2 -- JSON and
jq</a>.</p>
<hr>
<p><a href="https://community.sap.com/t5/technology-blogs-by-sap/getting-btp-resource-guids-with-the-btp-cli-part-1/ba-p/13511167">Originally published on SAP Community</a></p>



<script src="https://utteranc.es/client.js" repo="qmacro/qmacro.github.io" issue-term="title" crossorigin="anonymous" async=""></script>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/blog/posts/2021/11/15/utfrw-unofficial-teched-fun-run-walk-roll-share-your-pics/">UTFRW - Unofficial TechEd Fun Run / Walk / Roll - Share Your Pics!</a></li><li class="links-nextprev-next">Next →<br><a href="/blog/posts/2021/12/01/getting-btp-resource-guids-with-the-btp-cli-part-2-json-and-jq/">Getting BTP resource GUIDs with the btp CLI – part 2 - JSON and jq</a></li>
</ul>

			</heading-anchors>
		</main>

		<!-- This page `/blog/posts/2021/11/24/getting-btp-resource-guids-with-the-btp-cli-part-1/` was built on 2026-01-13T13:33:33.980Z -->
		<script type="module" src="/dist/t-8sxMV3B9.js"></script>
	</body>
</html>
