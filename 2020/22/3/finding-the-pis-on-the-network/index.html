<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finding the Pis on the network</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/blog/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Home</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/tags/">Tags</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Finding the Pis on the network</h1>

<time datetime="2020-03-22">22 Mar 2020</time>

<p><em>Now that we have our Pis booted and up and running on the network, we need to find them to configure them further.</em></p>
<p>This is a post in the &quot;<a href="/2020/03/22/brambleweeny-cluster-experiments/">Brambleweeny Cluster Experiments</a>&quot; series of blog posts, which accompanies the <a href="https://www.youtube.com/playlist?list=PLfctWmgNyOIf9rXaZp9RSM2YVxAPGGthe">YouTube live stream recording playlist</a> of the same name. The video linked here is the one that accompanies this blog post.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/hx7DB7Iqslk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>Previous post in this series: <a href="/2020/03/22/preparing-the-os-image/">Preparing the OS image</a><br><br>
Next post in this series: <a href="/2020/04/05/initial-pi-configuration-via-ansible/">Initial Pi configuration via Ansible</a></p>
<p>Having booted the Pis in the cluster using the <a href="/2020/03/22/preparing-the-os-image/">OS image prepared earlier</a>, we now need to find them so that we can continue with the setup.</p>
<p>What does that mean? Well, the Pis will have requested IP addresses via DHCP. In my case, I run DHCP via my Google Wifi setup, and have a range set up for DHCP leases. While I can guess what the IP addresses might be, it's not scientific. I could look at the Google Wifi app on my phone, and go through manually searching for the devices that called themselves something that includes the string &quot;raspberrypi&quot;, then looking at the details to reveal the IP addresses. But that sounds too much hard work, and not something I'd learn from.</p>
<p><img src="/blog/img/2020/03/wifiapp.png" alt="Google Wifi app"></p>
<p><strong>Using nmap</strong></p>
<p>I could use the <code>nmap</code> command that Alex <a href="https://medium.com/@alexellisuk/walk-through-install-kubernetes-to-your-raspberry-pi-in-15-minutes-84a8492dc95a">uses</a>, which has a wealth of possibilities. If all I wanted to do was to find the IP addresses, this would be what I'd want to use, specifying the <code>-sn</code> option (which means &quot;don't do a port scan&quot;, previously the option was <code>-sP</code>) for my home network (192.168.86.0/24), which would give results that look like this:</p>
<pre class="language-shell"><code class="language-shell">-<span class="token operator">></span> nmap -sn <span class="token number">192.168</span>.86.0/24<br>Starting Nmap <span class="token number">7.70</span> <span class="token punctuation">(</span> https://nmap.org <span class="token punctuation">)</span> at <span class="token number">2020</span>-03-22 <span class="token number">17</span>:08 GMT<br><span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span><br>Nmap scan report <span class="token keyword">for</span> chromecast-audio.lan <span class="token punctuation">(</span><span class="token number">192.168</span>.86.43<span class="token punctuation">)</span><br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.037s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> amazon-517762033.lan <span class="token punctuation">(</span><span class="token number">192.168</span>.86.47<span class="token punctuation">)</span><br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.10s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> pimodelb.lan <span class="token punctuation">(</span><span class="token number">192.168</span>.86.49<span class="token punctuation">)</span><br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.0022s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span>.86.15<br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.026s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> raspberrypi.lan <span class="token punctuation">(</span><span class="token number">192.168</span>.86.54<span class="token punctuation">)</span><br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.0039s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span>.86.47<br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.0033s latency<span class="token punctuation">)</span>.<br>Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span>.86.125<br>Host is up <span class="token punctuation">(</span><span class="token number">0</span>.0023s latency<span class="token punctuation">)</span>.<br><span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span><br>Nmap done: <span class="token number">256</span> IP addresses <span class="token punctuation">(</span><span class="token number">28</span> hosts up<span class="token punctuation">)</span> scanned <span class="token keyword">in</span> <span class="token number">2.38</span> seconds<br>-<span class="token operator">></span></code></pre>
<p>If you're wondering about the way the network is written, i.e. 192.168.86.0/24, here's how that works. An IP (v4) address is a dotted quad number, i.e. four single byte values (range 0-255) that specify a combination of network number and host number. The number after the slash (24 in this case) tells you how many bits wide the mask for the network number is, with the remaining bits being the host number. Bearing in mind that the resolution of four bytes gives a total address space of 32 bits (4 x 8), 24 signifies that the first three numbers (192.168.86) represent the network number, and the fourth represents the host number(s).</p>
<p>This is how I see 192.168.86.0/24 in my mind:</p>
<pre><code>     192      168       86        0 decimal
11000000 10101000 01010110 00000000 binary
11111111 11111111 11111111 00000000 network mask (24 bits)
|                        | |      |
+------------------------+ +------+
            |                 |
          network            host
</code></pre>
<p>Given that I can work out what IP addresses might already be allocated on my network, I could eventually reach the conclusion that the following IP addresses were the four new Pis in the cluster: 192.168.86.53, 192.168.86.54, 192.168.86.55 and 192.168.86.56.</p>
<p>But that feels a little fuzzy to me.</p>
<p>Moreover, I'm learning about <a href="https://www.ansible.com">Ansible</a> from Jeff Geerling, as I mentioned in <a href="/2020/03/22/starting-out-with-raspberry-pi-experiments/">Starting out with Raspberry Pi experiments</a>, and want to use some of the Ansible goodness for the setup of the Pis, as explained in his wiki page <a href="http://www.pidramble.com/wiki/setup/network">Network the Raspberry Pis</a>. Jeff has a nice <a href="https://github.com/geerlingguy/raspberry-pi-dramble/tree/master/setup/networking">networking setup</a> section in his GitHub repo <a href="https://github.com/geerlingguy/raspberry-pi-dramble">geerlingguy/raspberry-pi-dramble</a> which I recommend you have a look at. In this networking setup he has a playbook (a series of tasks for Ansible to carry out on a set of remote hosts) <a href="https://github.com/geerlingguy/raspberry-pi-dramble/blob/master/setup/networking/main.yml"><code>main.yml</code></a> that sets up networking, including allocating specific IP addresses to specific hosts.</p>
<p>How are these hosts identified and defined? In a <code>vars.yml</code> file, an example of which is <a href="https://github.com/geerlingguy/raspberry-pi-dramble/blob/master/setup/networking/example.vars.yml">provided</a> in that networking setup section. It contains a mapping of MAC addresses to hostname and IP address pairs, which is exactly what I want. In other words, I want to give each of the Pis in the cluster a hostname, and a specific IP address that will persist and that I can remember.</p>
<p>I'm going to jump ahead and show you what's in the <code>vars.yml</code> file for my Pi cluster setup here:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><br><span class="token comment"># Mapping of what hardware MAC addresses should be configured with specific IPs.</span><br><span class="token key atrule">mac_address_mapping</span><span class="token punctuation">:</span><br><br>  <span class="token key atrule">"dc:a6:32:60:60:95"</span><span class="token punctuation">:</span><br>    <span class="token key atrule">name</span><span class="token punctuation">:</span> brambleweeny1.lan<br>    <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">"192.168.86.12"</span><br>  <span class="token key atrule">"dc:a6:32:60:60:77"</span><span class="token punctuation">:</span><br>    <span class="token key atrule">name</span><span class="token punctuation">:</span> brambleweeny2.lan<br>    <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">"192.168.86.13"</span><br>  <span class="token key atrule">"dc:a6:32:60:60:44"</span><span class="token punctuation">:</span><br>    <span class="token key atrule">name</span><span class="token punctuation">:</span> brambleweeny3.lan<br>    <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">"192.168.86.14"</span><br>  <span class="token key atrule">"dc:a6:32:60:60:e3"</span><span class="token punctuation">:</span><br>    <span class="token key atrule">name</span><span class="token punctuation">:</span> brambleweeny4.lan<br>    <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">"192.168.86.15"</span><br><br><span class="token comment"># Nameservers to use in resolv.conf.</span><br><span class="token key atrule">dns_nameservers</span><span class="token punctuation">:</span><br>  <span class="token punctuation">-</span> <span class="token string">"192.168.86.5"</span></code></pre>
<p>I want to give the four Pis host numbers in the range 12-15, and name them after the cluster name &quot;Brambleweeny&quot;. I also want to tell them to use a local DNS server at 192.168.86.5 for domain name resolution. This is a tiny <a href="https://thepihut.com/products/raspberry-pi-zero-w">Raspberry Pi Zero W</a> running the excellent <a href="https://pi-hole.net/">Pi-hole</a>.</p>
<p>But putting aside the IP addresses for a moment - how did I find out the MAC addresses?</p>
<p><strong>Using arp-scan</strong></p>
<p>Well it pleases me to say that I found them out using a bit of technology that dates back to the early 1980s, and relates directly to one of the fundamental and critical parts of the Internet protocol suite - the <a href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol">Address Resolution Protocol</a> (ARP). Essentially, ARP provides a mapping between the link layer address of a network device (i.e. a MAC address in this case) and the internet layer address (i.e. the IP address in this case).</p>
<p>To work with ARP data there's a venerable program called <code>arp-scan</code> which is standard on real operating systems such as Linux. It's a system binary, which means it lives in <code>/usr/sbin</code> (&quot;sbin&quot; is short for &quot;system binaries&quot;) which means, more or less, that it's for root use only.</p>
<p>Running <code>arp-scan</code> on this network address 192.168.86.0/24 reveals almost exactly what we're looking for: not only the MAC addresses, but the IP addresses that are associated with them.</p>
<p>Here's what the output of running <code>arp-scan</code> on my network looks like (I've modified parts of the addresses for security reasons):</p>
<pre class="language-shell"><code class="language-shell">-<span class="token operator">></span> <span class="token function">sudo</span> arp-scan <span class="token number">192.168</span>.86.0/24<br>Interface: eth0, datalink type: EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span><br>Starting arp-scan <span class="token number">1.9</span>.5 with <span class="token number">256</span> hosts <span class="token punctuation">(</span>https://github.com/royhills/arp-scan<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.1    <span class="token number">70</span>:3a:cb:2e:c5:fb       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.22   <span class="token number">70</span>:3a:cb:32:0a:38       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.32   00:26:2d:18:d0:12       Wistron Neweb Corporation<br><span class="token number">192.168</span>.86.31   00:0e:58:68:59:33       Sonos, Inc.<br><span class="token number">192.168</span>.86.33   f0:72:ea:30:59:e3       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.37   <span class="token number">64</span>:16:66:40:5f:c3       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.36   6c:ad:f8:6c:5a:3d       AzureWave Technology Inc.<br><span class="token number">192.168</span>.86.39   <span class="token number">18</span>:b4:30:ec:11:2a       Nest Labs Inc.<br><span class="token number">192.168</span>.86.39   <span class="token number">18</span>:b4:30:ec:51:2a       Nest Labs Inc. <span class="token punctuation">(</span>DUP: <span class="token number">2</span><span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.28   00:0e:58:8a:c6:92       Sonos, Inc.<br><span class="token number">192.168</span>.86.15   dc:a6:32:60:60:77       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.47   dc:a6:32:60:60:95       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.48   9c:32:ce:7e:15:a1       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.158  dc:a6:32:60:60:44       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.125  dc:a6:32:60:60:e3       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.20   6c:56:97:64:1d:6f       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.47   fc:65:de:08:1b:69       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.44   f4:f5:d8:ed:13:fa       Google, Inc.<br><span class="token number">192.168</span>.86.43   <span class="token number">54</span>:60:09:eb:1a:dc       Google, Inc.<br><span class="token number">192.168</span>.86.21   a4:77:33:25:13:14       Google, Inc.<br><span class="token number">192.168</span>.86.187  5c:aa:fd:24:11:84       Sonos, Inc.<br><span class="token number">192.168</span>.86.24   3c:15:c2:b3:10:03       Apple, Inc.<br><span class="token number">192.168</span>.86.29   <span class="token number">20</span>:16:b9:c2:1d:f1       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.250  5c:aa:fd:02:15:48       Sonos, Inc.<br><span class="token number">192.168</span>.86.26   <span class="token number">20</span>:df:b9:41:1d:24       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.35   00:0e:58:f3:1e:6c       Sonos, Inc.<br><span class="token number">192.168</span>.86.40   1c:f2:9a:64:1c:22       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><br><span class="token number">29</span> packets received by filter, <span class="token number">0</span> packets dropped by kernel<br>Ending arp-scan <span class="token number">1.9</span>.5: <span class="token number">256</span> hosts scanned <span class="token keyword">in</span> <span class="token number">4.639</span> seconds <span class="token punctuation">(</span><span class="token number">55.18</span> hosts/sec<span class="token punctuation">)</span>. <span class="token number">27</span> responded<br>-<span class="token operator">></span></code></pre>
<p>Gosh that's nice, but how do I tell which are my new Raspberry Pis in the cluster?</p>
<p>Well, to answer that, we need to understand how MAC addresses are formed. Each address is a series of byte values, in hexadecimal. They're assigned to hardware devices, most commonly to network interfaces. In the case of the Pis, this is the RJ45 Ethernet port you can see in the top right of this picture of a Raspberry Pi 4:</p>
<p><img src="/blog/img/2020/03/pi4.png" alt="Raspberry Pi 4"></p>
<p>Significantly, the first three bytes in a MAC address represent the hardware manufacturer, via a so-called Organisationally Unique Identifier (OUI). And if we look at the <a href="http://standards-oui.ieee.org/oui.txt">canonical list of OUIs</a> we see that there's an entry for the Raspberry Pi organisation thus:</p>
<pre><code>DC-A6-32   (hex)        Raspberry Pi Trading Ltd
DCA632     (base 16)    Raspberry Pi Trading Ltd
                        Maurice Wilkes Building, Cowley Road
                        Cambridge    CB4 0DS
                        GB
</code></pre>
<p>How convenient!</p>
<blockquote>
<p>Incidentally, the building in this address is named after one of the fathers of modern computing, <a href="https://en.wikipedia.org/wiki/Maurice_Wilkes">Maurice Wilkes</a>, who worked on one of the earliest stored-program computers EDSAC, and who also invented microprogramming, which was first described in Manchester in 1951.</p>
</blockquote>
<p>So all we have to do is reduce the output of <code>arp-scan</code> by filtering the output to only show devices manufactured by the Raspberry Pi organisation, which has the OUI DC-A6-32, or, as it's more commonly written, dc:a6:32:</p>
<pre class="language-shell"><code class="language-shell">-<span class="token operator">></span> <span class="token function">sudo</span> arp-scan <span class="token number">192.168</span>.86.0/24 <span class="token operator">|</span> <span class="token function">grep</span> dc:a6:32<br><span class="token number">192.168</span>.86.47   dc:a6:32:60:60:95       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.15   dc:a6:32:60:60:77       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.158  dc:a6:32:60:60:44       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br><span class="token number">192.168</span>.86.125  dc:a6:32:60:60:e3       <span class="token punctuation">(</span>Unknown<span class="token punctuation">)</span><br>-<span class="token operator">></span></code></pre>
<p>Bingo!</p>
<p>DHCP leases had indeed been given out for hosts 47, 15, 158 and 125 in the 192.168.86.0/24 network, and there we have each associated MAC address too.</p>
<p>So in preparing for the networking setup, the MAC addresses went into the <code>vars.yml</code> file as shown earlier, with the <strong>to-be</strong> IP addresses.</p>
<p>Of course, we need to help Ansible find the Pis to make this configuration, and for that we need to specify a list of the <strong>existing</strong> IP addresses, which we now also have. Those go into the Ansible inventory, effectively a list of hosts in this simple case.</p>
<p>Based on the <a href="https://github.com/geerlingguy/raspberry-pi-dramble/blob/master/setup/networking/example.inventory"><code>example.inventory</code></a> in Jeff's repository, here's what we need for the setup in the case of our Brambleweeny cluster:</p>
<pre class="language-yml"><code class="language-yml"><span class="token punctuation">[</span>brambleweeny<span class="token punctuation">]</span><br>192.168.86.47<br>192.168.86.15<br>192.168.86.158<br>192.168.86.125<br><br><span class="token punctuation">[</span>brambleweeny<span class="token punctuation">:</span>vars<span class="token punctuation">]</span><br>ansible_ssh_user=pi</code></pre>
<p>I've changed the name of the group from &quot;Dramble&quot; to &quot;Brambleweeny&quot;, and of course adjusted the IP addresses to the as-is ones that exist right now. There's also a variable in this file, <code>ansible_ssh_user</code>, but we'll ignore that for now.</p>
<p>At this stage, we have found the Pis on the network, and gathered the appropriate information to supply to Ansible so that we can ask it to make the networking setup on each host, on our behalf.</p>
<p>We'll get to that in the next post. Until then, happy arping!</p>
<p>Next post in this series: <a href="/2020/04/05/initial-pi-configuration-via-ansible/">Initial Pi configuration via Ansible</a></p>

<hr>
<ul><li>Next: <a href="/blog/2020/22/3/preparing-the-os-image/">Preparing the OS image</a></li><li>Previous: <a href="/blog/2020/22/3/brambleweeny-cluster-experiments/">Brambleweeny Cluster Experiments</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2020/22/3/finding-the-pis-on-the-network/ -->
  </body>
</html>
