<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass deletion of GitHub Actions workflow runs</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/blog/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Home</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/tags/">Tags</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Mass deletion of GitHub Actions workflow runs</h1>

<time datetime="2021-03-26">26 Mar 2021</time><a href="/blog/tags/autodidactics/" class="post-tag">autodidactics</a><a href="/blog/tags/github-actions/" class="post-tag">github-actions</a><a href="/blog/tags/shell/" class="post-tag">shell</a><a href="/blog/tags/gh/" class="post-tag">gh</a><a href="/blog/tags/jq/" class="post-tag">jq</a><a href="/blog/tags/fzf/" class="post-tag">fzf</a>

<p><em>Implementing a simple cleanup script for workflow runs, using <code>gh</code>, <code>jq</code>, <code>fzf</code> and the GitHub API</em></p>
<p>Yesterday, while <a href="https://github.com/qmacro/thinking-aloud/issues/13">thinking aloud</a>, I was wondering how best to mass-delete logs from GitHub Actions workflow runs. Such a feature isn't available in the Web based Actions UI and my lack of competence in the Actions area means that I have a lot of cruft from my trial and error approach to writing and executing workflows.</p>
<p><strong>The GitHub Workflow Runs API</strong></p>
<p>I knew the answer probably was in the GitHub API, and it was - in the form of the <a href="https://docs.github.com/en/rest/reference/actions#workflow-runs">Workflow Runs</a> API. There are various endpoints that follow a clean and logical design. Workflow runs are repo specific, and to list them, the following API endpoint is available to access via the GET method:</p>
<pre><code>GET /repos/{owner}/{repo}/actions/runs
</code></pre>
<p>Following this straightforward URL-space design, a deletion is possible thus:</p>
<pre><code>DELETE /repos/{owner}/{repo}/actions/runs/{run_id}
</code></pre>
<p>Incidentally, I like the use of &quot;owner&quot; here - because a repo can belong to an individual GitHub account (such as <a href="https://github.com/qmacro">qmacro</a>) or an organisation (such as <a href="https://github.com/SAP-samples">SAP-samples</a>), and &quot;owner&quot; is a generic term that covers both situations and has the right semantics.</p>
<p><strong>Requesting the workflow run information with <code>gh</code></strong></p>
<p>To make use of these API endpoints, I used the excellent <code>gh</code> <a href="https://github.com/cli/cli">GitHub CLI</a>, specifically the <a href="https://cli.github.com/manual/gh_api">api</a> facility. Once <a href="https://cli.github.com/manual/gh_auth">authenticated</a>, it's super easy to make API calls; to retrieve the workflow runs for the <code>qmacro/thinking-aloud</code> repo, it's as simple as this (some pretty-printed output is also shown here):</p>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> gh api /repos/qmacro/thinking-aloud/actions/runs<br><span class="token punctuation">{</span><br>  <span class="token string">"total_count"</span><span class="token builtin class-name">:</span> <span class="token number">22</span>,<br>  <span class="token string">"workflow_runs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token number">686610826</span>,<br>      <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"Generate Atom Feed"</span>,<br>      <span class="token string">"node_id"</span><span class="token builtin class-name">:</span> <span class="token string">"MDExOldvcmtmbG93UnVuNjg2NjEwODI2"</span>,<br>      <span class="token string">"head_branch"</span><span class="token builtin class-name">:</span> <span class="token string">"main"</span>,<br>      <span class="token string">"head_sha"</span><span class="token builtin class-name">:</span> <span class="token string">"24822bfb34573c0dc2fb6b0f83c42a1752a324d9"</span>,<br>      <span class="token string">"run_number"</span><span class="token builtin class-name">:</span> <span class="token number">13</span>,<br>      <span class="token string">"event"</span><span class="token builtin class-name">:</span> <span class="token string">"issues"</span>,<br>      <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"completed"</span>,<br>      <span class="token string">"conclusion"</span><span class="token builtin class-name">:</span> <span class="token string">"skipped"</span>,<br>      <span class="token punctuation">..</span>.</code></pre>
<p><strong>Making sense of the response with <code>jq</code></strong></p>
<p>The response from the API has a JSON representation and a straightfoward but rich set of details. This is where <code>jq</code> comes in. I started with just pulling out values for a few properties like this:</p>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> gh api /repos/qmacro/thinking-aloud/actions/runs <span class="token punctuation">\</span><br><span class="token operator">></span> <span class="token operator">|</span> jq -r <span class="token string">'.workflow_runs[] | [.id, .conclusion, .name] | @tsv'</span> <span class="token punctuation">\</span><br><span class="token operator">></span> <span class="token operator">|</span> <span class="token function">head</span> -5<br><span class="token number">686610826</span>       skipped Generate Atom Feed<br><span class="token number">686610824</span>       skipped Tweet new entry<br><span class="token number">686610823</span>       skipped Render <span class="token function">most</span> recent entries<br><span class="token number">686471644</span>       success Render <span class="token function">most</span> recent entries<br><span class="token number">686157878</span>       success Render <span class="token function">most</span> recent entries</code></pre>
<blockquote>
<p>There's built-in support for pagination with <code>gh api</code>, with the <code>--paginate</code> switch, which is handy.</p>
</blockquote>
<p>Breaking the <code>jq</code> invocation down, we have:</p>
<table>
<thead>
<tr>
<th>Part</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-r</code></td>
<td>Tells <code>jq</code> to output &quot;raw&quot; values, rather than JSON structures</td>
</tr>
<tr>
<td><code>.workflow_runs[]</code></td>
<td>Process each of the entries in the <code>workflow_runs</code> array</td>
</tr>
<tr>
<td><code>[.id, .conclusion, .name]</code></td>
<td>Show values for these three properties</td>
</tr>
<tr>
<td><code>@tsv</code></td>
<td>Convert everything into tab separated values</td>
</tr>
</tbody>
</table>
<p>Notice the use of the <code>|</code> symbol too - the output of <code>.workflow_runs[]</code> is piped into the selection of properties, and the output of that is piped further into the call to the builtin <code>@tsv</code> mechanism.</p>
<p>I ended up <a href="https://github.com/qmacro/dotfiles/blob/230c6df494f239e9d1762794943847816e1b7c32/scripts/dwr#L21-L38">using this approach</a>, but in a slightly expanded way, using a couple of helper functions:</p>
<ul>
<li>one to make the values for the <code>.created_at</code> property easier to read (for example changing &quot;2021-03-26T09:10:11Z&quot; into &quot;2021-03-26 09:10:11&quot;)</li>
<li>the other to convert the values for the <code>.conclusion</code> property into simpler and shorter terms</li>
</ul>
<pre class="language-jq"><code class="language-jq"><span class="token keyword">def</span> <span class="token function">symbol</span><span class="token punctuation">:</span><br>  <span class="token c-style-function function">sub</span><span class="token punctuation">(</span><span class="token string">"skipped"</span><span class="token punctuation">;</span> <span class="token string">"SKIP"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span><br>  <span class="token c-style-function function">sub</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">;</span> <span class="token string">"GOOD"</span><span class="token punctuation">)</span> <span class="token operator pipe">|</span><br>  <span class="token c-style-function function">sub</span><span class="token punctuation">(</span><span class="token string">"failure"</span><span class="token punctuation">;</span> <span class="token string">"FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">def</span> <span class="token function">tz</span><span class="token punctuation">:</span><br>  <span class="token c-style-function function">gsub</span><span class="token punctuation">(</span><span class="token string">"[TZ]"</span><span class="token punctuation">;</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">.</span>workflow_runs<span class="token punctuation">[</span><span class="token punctuation">]</span><br>  <span class="token operator pipe">|</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">(</span><span class="token punctuation">.</span>conclusion <span class="token operator pipe">|</span> symbol<span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token punctuation">(</span><span class="token punctuation">.</span>created_at <span class="token operator pipe">|</span> tz<span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>      <span class="token punctuation">.</span>event<span class="token punctuation">,</span><br>      <span class="token punctuation">.</span>name<br>    <span class="token punctuation">]</span><br>  <span class="token operator pipe">|</span> @tsv</code></pre>
<p><strong>Presenting the list with <code>fzf</code></strong></p>
<p>Now all that was required was to present the list of workflow runs in a list, for me to choose which ones to delete. The wonderful <code>fzf</code> came to the rescue here. If you've not heard of <code>fzf</code>, go and read all about <a href="https://github.com/junegunn/fzf">the command line fuzzy-finder</a> right now. I've written a couple of posts on this very blog about <code>fzf</code> basics too:</p>
<ul>
<li><a href="https://qmacro.org/autodidactics/2021/02/02/fzf-the-basics-1-layout/">fzf - the basics part 1 - layout</a></li>
<li><a href="https://qmacro.org/autodidactics/2021/02/07/fzf-the-basics-2-search-results/">fzf - the basics part 2 - search results</a></li>
</ul>
<p>This is how I combined the <code>gh</code>, <code>jq</code> and <code>fzf</code> invocations, inside a <a href="https://github.com/qmacro/dotfiles/blob/230c6df494f239e9d1762794943847816e1b7c32/scripts/dwr#L43-L49"><code>selectruns</code></a> function:</p>
<pre class="language-shell"><code class="language-shell">gh api --paginate <span class="token string">"/repos/<span class="token variable">$repo</span>/actions/runs"</span> <span class="token punctuation">\</span><br>  <span class="token operator">|</span> jq -r -f <span class="token operator">&lt;</span><span class="token punctuation">(</span>jqscript<span class="token punctuation">)</span> <span class="token punctuation">\</span><br>  <span class="token operator">|</span> fzf --multi</code></pre>
<p>With the <code>--multi</code> switch, <code>fzf</code> allows the selection of more than one item.</p>
<p>Then it was just a case of processing each selected item, and making use of that other API endpoint we saw earlier inside a <a href="https://github.com/qmacro/dotfiles/blob/230c6df494f239e9d1762794943847816e1b7c32/scripts/dwr#L51-L60"><code>deleterun</code></a> function, like this:</p>
<pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">local</span> run <span class="token function">id</span> result<br><span class="token assign-left variable">run</span><span class="token operator">=</span><span class="token variable">$1</span><br><span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -f <span class="token number">3</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$run</span>"</span><span class="token variable">)</span></span>"</span><br>gh api -X DELETE <span class="token string">"/repos/<span class="token variable">$repo</span>/actions/runs/<span class="token variable">$id</span>"</span><br><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token string">"OK!"</span> <span class="token operator">||</span> <span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token string">"BAD"</span><br><span class="token builtin class-name">printf</span> <span class="token string">"%s<span class="token entity" title="\t">\t</span>%s<span class="token entity" title="\n">\n</span>"</span> <span class="token string">"<span class="token variable">$result</span>"</span> <span class="token string">"<span class="token variable">$run</span>"</span><span class="token punctuation">)</span></code></pre>
<p>The use of <code>cut</code> was to pick out the <code>id</code> property in the list, as presented to (and selected via) <code>fzf</code>; the list is tab separated (thanks to <code>@tsv</code>) and <code>cut</code>'s default delimiter is tab too, which is nice.</p>
<p><strong>The script in action</strong></p>
<p>That's about it - here's the entire script in action:</p>
<script id="asciicast-402683" src="https://asciinema.org/a/402683.js" async></script>
<p>And you can check out the script, as it was at the time of writing, in my dotfiles repository here: <a href="https://github.com/qmacro/dotfiles/blob/230c6df494f239e9d1762794943847816e1b7c32/scripts/dwr"><code>dwr</code></a>.</p>

<hr>
<ul><li>Next: <a href="/blog/2021/27/3/la-pavoni-maintenance-successful/">La Pavoni maintenance successful</a></li><li>Previous: <a href="/blog/2021/25/3/a-new-journal-experiment-thinking-aloud/">A new journal experiment - Thinking Aloud</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2021/26/3/mass-deletion-of-github-actions-workflow-runs/ -->
  </body>
</html>
