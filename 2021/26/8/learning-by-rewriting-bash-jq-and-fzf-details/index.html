<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning by rewriting - bash, jq and fzf details</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/blog/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Home</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/tags/">Tags</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Learning by rewriting - bash, jq and fzf details</h1>

<time datetime="2021-08-26">26 Aug 2021</time><a href="/blog/tags/tools/" class="post-tag">tools</a><a href="/blog/tags/shell/" class="post-tag">shell</a>

<p><em>One of the ways I learn is by reading and sometimes rewriting other people's scripts. Here I learn more about <code>jq</code> by rewriting a friend's password CLI script.</em></p>
<p>My friend <a href="https://twitter.com/ceedee666">Christian Drumm</a> published a nice post this week on <a href="https://www.drumm.sh/blog/bw-cli">Adapting the Bitwarden CLI with Shell Scripting</a>, where he shared a script he wrote to conveniently grab passwords into his paste buffer at the command line.</p>
<p>It's a good read and contains some nice CLI animations too. In the summary, Christian remarks that there may be some areas for improvement. I don't know about that, and I'm certainly no &quot;shell scripting magician&quot; but I thought I'd have a go at modifying the script to perhaps introduce some further Bash shell, <code>jq</code> and <code>fzf</code> features to dig into.</p>
<h2 id="emulating-the-cli" tabindex="-1">Emulating the CLI <a class="direct-link" href="#emulating-the-cli" aria-hidden="true">#</a></h2>
<p>I don't have Bitwarden, so I created a quick &quot;database&quot; of login information that took the form of what the Bitwarden CLI <code>bw</code> produced. First, then, is the contents of the <code>items.json</code> file:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"E45 S4HANA 2020 Sandbox"</span><span class="token punctuation">,</span> <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"e45user"</span><span class="token punctuation">,</span> <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"sappass"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"space user"</span><span class="token punctuation">,</span> <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"spaceuser"</span><span class="token punctuation">,</span> <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"in space"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"foouser"</span><span class="token punctuation">,</span> <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"foopass"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"baruser"</span><span class="token punctuation">,</span> <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"sekrit!"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"baz"</span><span class="token punctuation">,</span> <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"bazuser"</span><span class="token punctuation">,</span> <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"hunter2"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre>
<p>Then I needed to emulate the <code>bw list items --search</code> command that Christian uses to search for an entry. As far as I can tell, it returns an array, regardless of whether a single entry is found, or more than one. I'm also assuming it returns an empty array if nothing is found, but that's less important here as you'll see.</p>
<p>I did this by creating a script <code>bw-list-items-search</code> which looks like this:</p>
<pre><code>#!/usr/bin/env bash

# Emulates 'bw list items --search $1'

jq --arg name &quot;$1&quot; 'map(select(.name | test($name; &quot;i&quot;)))' ./items.json
</code></pre>
<p>Perhaps unironically I'm using <code>jq</code> to emulate the behaviour, because the data being searched is a JSON array (in <code>items.json</code>). I map over the entries in the array, and use the <a href="https://stedolan.github.io/jq/manual/#select(boolean_expression)"><code>select</code> function</a> to return only those entries that satisfy the boolean expression passed to it:</p>
<pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span>name <span class="token operator pipe">|</span> <span class="token c-style-function function">test</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">;</span> <span class="token string">"i"</span><span class="token punctuation">)</span></code></pre>
<p>This pipes the value of the <code>name</code> property (e.g. &quot;E45 S4HANA 2020 Sandbox&quot;, &quot;space user&quot;, &quot;foo&quot; etc) into the <a href="https://stedolan.github.io/jq/manual/#test(val),test(regex;flags)"><code>test</code> function</a> which can take a regular expression, along with one or more flags if required.</p>
<p>Here, we're just taking the value passed into the script, via the argument that was passed to the <code>jq</code> invocation with <code>--arg name &quot;$1&quot;</code>. This is then available within the <code>jq</code> script as the binding <code>$name</code>. The second parameter supplied here, <code>&quot;i&quot;</code>, is the &quot;case insensitive match&quot; flag.</p>
<p>The result means that I can emulate what I think <code>bw list items --search</code> does:</p>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> ./bw-list-items-search e45<br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"E45 S4HANA 2020 Sandbox"</span>,<br>    <span class="token string">"login"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><br>      <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"e45user"</span>,<br>      <span class="token string">"password"</span><span class="token builtin class-name">:</span> <span class="token string">"sappass"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre>
<p>Here's an example of where more than one result is found:</p>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">;</span> ./bw-list-items-search ba<br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"bar"</span>,<br>    <span class="token string">"login"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><br>      <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"baruser"</span>,<br>      <span class="token string">"password"</span><span class="token builtin class-name">:</span> <span class="token string">"sekrit!"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span>,<br>  <span class="token punctuation">{</span><br>    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"baz"</span>,<br>    <span class="token string">"login"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><br>      <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"bazuser"</span>,<br>      <span class="token string">"password"</span><span class="token builtin class-name">:</span> <span class="token string">"hunter2"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre>
<h2 id="the-main-script" tabindex="-1">The main script <a class="direct-link" href="#the-main-script" aria-hidden="true">#</a></h2>
<p>Now I could turn my attention to the main script. Here it is in its entirety; I'll describe it section by section.</p>
<pre><code>#!/usr/bin/env bash

set -e

pbcopy() { true; }

copy_uname_and_passwd() {

  local login=$1

  echo &quot;&gt; Copying Username&quot;
  jq -r '.username' &lt;&lt;&lt; &quot;$login&quot;

  echo &quot;&gt; Press any key to copy password...&quot;
  read
  echo &quot;&gt; Copying Password&quot;
  jq -r '.password' &lt;&lt;&lt; &quot;$login&quot;

}

main() {

  local searchterm=$1
  local selection logins
  logins=&quot;$(./bw-list-items-search $searchterm)&quot;

  selection=&quot;$(jq -r '.[] | &quot;\(.name)\t\(.login)&quot;' &lt;&lt;&lt; &quot;$logins&quot; \
    | fzf --reverse --with-nth=1 --delimiter=&quot;\t&quot; --select-1 --exit-0
  )&quot;

  [[ -n $selection ]] \
    &amp;&amp; echo &quot;Name: ${selection%%$'\t'*}&quot; \
    &amp;&amp; copy_uname_and_passwd &quot;${selection#*$'\t'}&quot;

}

main &quot;$@&quot;
</code></pre>
<h3 id="overall-structure-and-the-main-function" tabindex="-1">Overall structure and the main function <a class="direct-link" href="#overall-structure-and-the-main-function" aria-hidden="true">#</a></h3>
<p>For the last few months, my preference for laying out non-trivial scripts has been to use the approach that one often finds in other languages, and that is to define a main function, and right at the bottom, call that to start things off.</p>
<p>This call is <code>main &quot;$@&quot;</code> which just passes on any and all values that were specified in the script's invocation - they're available in the special parameter <code>$@</code> which &quot;expands to the positional parameters, starting from one&quot; (see <a href="https://tiswww.case.edu/php/chet/bash/bashref.html#Special-Parameters">Special Parameters</a>).</p>
<h3 id="the-main-function" tabindex="-1">The main function <a class="direct-link" href="#the-main-function" aria-hidden="true">#</a></h3>
<p>I like to qualify my variables, so use <code>local</code> here, which is a synonym for <code>declare</code>. I wrote about this in <a href="https://qmacro.org/autodidactics/2020/10/08/understanding-declare/">Understanding declare</a> in case you want to dig in further.</p>
<p>Because I have my emulator earlier, I can make almost the same-shaped call to the Bitwarden CLI, passing what was specified in <code>searchterm</code> and retrieving the results (a JSON array) in the <code>logins</code> variable.</p>
<p>Next comes perhaps the most involved part of the script, which results in a value being stored in the <code>selection</code> variable (if nothing is selected or available, then this will be empty, which we'll deal with too).</p>
<p><strong>Determining the selection part 1 - with <code>jq</code></strong></p>
<p>The value for <code>selection</code> is determined from a combination of <code>jq</code> and <code>fzf</code>, which are also the two commands that Christian uses.</p>
<p>This is the invocation:</p>
<pre><code>jq -r '.[] | &quot;\(.name)\t\(.login)&quot;' &lt;&lt;&lt; &quot;$logins&quot; \
    | fzf --reverse --with-nth=1 --delimiter=&quot;\t&quot; --select-1 --exit-0
</code></pre>
<p>The first thing to notice is that I'm using <code>&lt;&lt;&lt;</code> which is a <a href="https://tldp.org/LDP/abs/html/x17837.html">here string</a> - it's like a <a href="https://tldp.org/LDP/abs/html/here-docs.html">here document</a>, but it's just the variable that gets expanded and fed to the STDIN of the command. This means that whatever is in <code>logins</code> gets expanded and passed to the STDIN of <code>jq</code>.</p>
<p>Given the emulation of the Bitwarden CLI above, a value that might be in <code>logins</code> looks like this:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span><br>    <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"baruser"</span><span class="token punctuation">,</span><br>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"sekrit!"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"baz"</span><span class="token punctuation">,</span><br>    <span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"bazuser"</span><span class="token punctuation">,</span><br>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"hunter2"</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre>
<p>Let's look at the <code>jq</code> script now, which is this:</p>
<pre class="language-jq"><code class="language-jq"><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator pipe">|</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">\(</span><span class="token content"><span class="token punctuation">.</span>name</span><span class="token punctuation">)</span></span>\t<span class="token interpolation"><span class="token punctuation">\(</span><span class="token content"><span class="token punctuation">.</span>login</span><span class="token punctuation">)</span></span>"</span></code></pre>
<p>This iterates over the items passed in (i.e. it will process the first object containing the details for &quot;bar&quot; and then the second object containing the details for &quot;baz&quot;) and pipes them into the creation of a literal string (enclosed in double quotes). This literal string is two values separated with a tab character (<code>\t</code>) ... but those values are the values of the respective properties, via <code>jq</code>'s <a href="https://stedolan.github.io/jq/manual/#Stringinterpolation-(foo">string interpolation</a>).</p>
<p>It's worth noting that the value of <code>.name</code> is a scalar, e.g. &quot;bar&quot;, but the value of <code>.login</code> is actually an object:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"login"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"baruser"</span><span class="token punctuation">,</span><br>  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"sekrit!"</span><br><span class="token punctuation">}</span></code></pre>
<p>but this gets turned into a string. If &quot;bar&quot; is selected, then the value in <code>selection</code> will be:</p>
<pre><code>bar     {&quot;username&quot;:&quot;baruser&quot;,&quot;password&quot;:&quot;sekrit!&quot;}
</code></pre>
<p>where the whitespace between the name &quot;bar&quot; and the rest of the line is a tab character.</p>
<p>So given the two values (for &quot;bar&quot; and &quot;baz&quot;) above which would have been extracted for the search string &quot;ba&quot;, the following would be produced by the <code>jq</code> invocation:</p>
<pre><code>bar     {&quot;username&quot;:&quot;baruser&quot;,&quot;password&quot;:&quot;sekrit!&quot;}
baz     {&quot;username&quot;:&quot;bazuser&quot;,&quot;password&quot;:&quot;hunter2&quot;}
</code></pre>
<p>Note that the <code>-r</code> option is supplied to <code>jq</code> to produce this raw output.</p>
<p><strong>Determining the selection part 2 - with <code>fzf</code></strong></p>
<p>This is then passed to <code>fzf</code>, which is passed a few more options than we saw with Christian's script. Taking them one at a time:</p>
<ul>
<li><code>--reverse</code> - this is the same as Christian and is a layout option that causes the selection to be displayed from the top of the screen.</li>
<li><code>--delimiter=&quot;\t&quot;</code> - this tells <code>fzf</code> how the input fields are delimited, and as we're using a tab character to separate the name and login information, we need to tell <code>fzf</code> (using just spaces would give us issues with spaces in the values of the names).</li>
<li><code>--with-nth=1</code> - this says &quot;only use the value of the first field in the selection list&quot;, where the fields are delimited as instructed (with the tab character here). This means that only the value of the &quot;name&quot; is presented, not the &quot;login&quot; (username and password) details.</li>
<li><code>--select-1</code> - this tells <code>fzf</code> that if there's only one item in the selection anyway, just automatically select it and don't show any selection dialogue.</li>
<li><code>--exit-0</code> - this tells <code>fzf</code> to just end if there's nothing to select from at all (which would be the case if the invocation to <code>bw list items --search</code> returned nothing, i.e. an empty array).</li>
</ul>
<p>Here's what the selection looks like if no search string is specified, i.e. it's a presentation of all the possible names:</p>
<p><img src="/blog/img/2021/08/fzf-name-selection.png" alt="selection in fzf"></p>
<p>Once we're done with determining the selection, we check to see that there is actually a value in <code>selection</code> and proceed to first show the name and then to call the <code>copy_uname_and_passwd</code> function.</p>
<p><strong>Displaying the name and extracting the login details</strong></p>
<p>It's worth highlighting that while <code>fzf</code> only <em>presents</em> the names in the selection list, it will <em>return</em> the entire line that was selected, which is what we want. In other words, given the selection in the screenshot above, if the name &quot;E45 S4HANA 2020 Sandbox&quot; is chosen, then <code>fzf</code> will emit this to STDOUT:</p>
<pre><code>E45 S4HANA 2020 Sandbox {&quot;username&quot;:&quot;e45user&quot;,&quot;password&quot;:&quot;sappass&quot;}
</code></pre>
<p>(again, remember that there's a tab character between the name &quot;E45 S4HANA 2020 Sandbox&quot; and the JSON object with the login details).</p>
<p>So to just print the name, we can use <a href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html">shell parameter expansion</a> to pick out the part we want. The <code>${parameter%%word}</code> form is appropriate here; this will remove anything with longest matching pattern first.</p>
<p>In other words, the expression <code>${selection%%$'\t'*}</code> means:</p>
<ul>
<li>take the value of the <code>selection</code> variable</li>
<li>look at the <em>trailing</em> portion of that value</li>
<li>find the <em>longest</em> match of the pattern <code>$'\t'*</code></li>
<li>and remove it</li>
</ul>
<p>The <code>$'...'</code> way of quoting a string allows us to use special characters such as tab (<code>\t</code>) safely. The <code>*</code> means &quot;anything&quot;. So the pattern is &quot;a tab character and whatever follows it, if anything&quot;.</p>
<p>So if the value of <code>selection</code> is:</p>
<pre><code>E45 S4HANA 2020 Sandbox {&quot;username&quot;:&quot;e45user&quot;,&quot;password&quot;:&quot;sappass&quot;}
</code></pre>
<p>then this expression will yield:</p>
<pre><code>E45 S4HANA 2020 Sandbox
</code></pre>
<p>The expression in the next line, where we invoke the <code>copy_uname_and_passwd</code> function, is <code>${selection#*$'\t'}</code> which is similar. It means:</p>
<ul>
<li>take the value of the <code>selection</code> variable</li>
<li>look at the <em>beginning</em> portion of that value</li>
<li>find the <em>shortest</em> match of the pattern <code>*$'\t'</code></li>
<li>and remove it</li>
</ul>
<p>This pattern, then, is &quot;anything, up to and including a tab character&quot;.</p>
<p>Given the same value as above, this expression will yield:</p>
<pre><code>{&quot;username&quot;:&quot;e45user&quot;,&quot;password&quot;:&quot;sappass&quot;}
</code></pre>
<h3 id="the-copy_uname_and_passwd-function" tabindex="-1">The copy_uname_and_passwd function <a class="direct-link" href="#the-copy_uname_and_passwd-function" aria-hidden="true">#</a></h3>
<p>This is very similar to Christian's original script, except that we can use a &quot;here string&quot; again to pass the value of the <code>login</code> variable to <code>jq</code> each time. Given what we know from the <code>main</code> function, this value will be something like this:</p>
<pre><code>{&quot;username&quot;:&quot;e45user&quot;,&quot;password&quot;:&quot;sappass&quot;}
</code></pre>
<p>which makes for a simpler extraction of the values we want (from the <code>username</code> and <code>password</code> properties).</p>
<h3 id="the-pbcopy-function" tabindex="-1">The pbcopy function <a class="direct-link" href="#the-pbcopy-function" aria-hidden="true">#</a></h3>
<p>While my main machine is a macOS device, I'm working in a (Linux based) dev container and therefore don't have access right now to the <code>pbcopy</code> command. As I wanted to leave calls to it in the script to reflect where it originally was, this function that does nothing will do the trick.</p>
<h2 id="wrapping-up" tabindex="-1">Wrapping up <a class="direct-link" href="#wrapping-up" aria-hidden="true">#</a></h2>
<p>There's always more to learn about Bash scripting and the tools we have at our disposal. And to use one of the sayings from the wonderful Perl community - TMOWTDI - &quot;there's more than one way to do it&quot;. I'm sure you can come up with some alternatives too, and some improvements on what I've written.</p>
<p>Keep on learning and sharing.</p>

<hr>
<ul><li>Next: <a href="/blog/2021/3/9/exploring-fff-part-1-main/">Exploring fff part 1 - main</a></li><li>Previous: <a href="/blog/2021/22/8/today-s-til-trio/">Today&#39;s TIL trio</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2021/26/8/learning-by-rewriting-bash-jq-and-fzf-details/ -->
  </body>
</html>
