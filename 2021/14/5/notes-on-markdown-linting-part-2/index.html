<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes on Markdown linting - part 2</title>
    <meta name="description" content="Reserving the right to be wrong.">
    <link rel="stylesheet" href="/blog/css/index.css">
    <link rel="stylesheet" href="/blog/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/blog/feed/feed.xml" type="application/atom+xml" title="DJ Adams">
    <link rel="alternate" href="/blog/feed/feed.json" type="application/json" title="DJ Adams">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/blog/">DJ Adams</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/blog/">Home</a></li>
        <li class="nav-item"><a href="/blog/about/">About</a></li>
        <li class="nav-item"><a href="/blog/posts/">Archive</a></li>
        <li class="nav-item"><a href="/blog/tags/">Tags</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>Notes on Markdown linting - part 2</h1>

<time datetime="2021-05-14">14 May 2021</time><a href="/blog/tags/markdown/" class="post-tag">markdown</a><a href="/blog/tags/linting/" class="post-tag">linting</a>

<p><em>More on Markdown linting, this time in the context of GitHub Actions.</em></p>
<p>Yesterday I <a href="https://qmacro.org/2021/05/13/notes-on-markdown-linting-1/">wrote up some initial notes on my foray into Markdown linting</a>. Today I continue my journey of learning and discovery by attempting to get the Markdown linting working in a GitHub Action workflow, so I can have the checks done on pull requests.</p>
<p>Beyond creating the workflow definition itself, there are only a few parts to getting Markdown content linted in the context of a pull request:</p>
<ul>
<li>getting the content of the pull request, to be able to perform linting upon it</li>
<li>setting up an association between any linting output messages with the lines of Markdown to which they relate</li>
<li>installing the <code>markdownlint</code> tool and any custom rule packages</li>
<li>performing the linting</li>
</ul>
<h2 id="creating-the-workflow-definition" tabindex="-1">Creating the workflow definition <a class="direct-link" href="#creating-the-workflow-definition" aria-hidden="true">#</a></h2>
<p>Since being able to quickly look at previous examples of GitHub Actions workflow definitions using my <a href="https://qmacro.org/2021/04/24/github-actions-workflow-browser/">workflow browser</a>, it was quite easy to create a simple workflow definition. Here's what the start looks like:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Markdown checks<br><br><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span><br>    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">,</span> master<span class="token punctuation">]</span><br><br><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">lint-markdown</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span><br><br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br><br>    <span class="token punctuation">...</span></code></pre>
<blockquote>
<p>I've moved from specifying <code>ubuntu-latest</code> to <code>ubuntu-nn.nn</code> for a more stable (or perhaps &quot;predictable&quot;) runner experience.</p>
</blockquote>
<p>Nothing exciting in this workflow definition so far; I've included both <code>main</code> and <code>master</code> in the list of branches because I've been testing with an older repository that still has <code>master</code> as the default branch.</p>
<h2 id="getting-the-pull-request-content" tabindex="-1">Getting the pull request content <a class="direct-link" href="#getting-the-pull-request-content" aria-hidden="true">#</a></h2>
<p>To run <code>markdownlint</code> on the content of the pull request, we need that in the runner workspace, and the usual use of the standard <a href="https://github.com/actions/checkout">actions/checkout</a> action does the job here:</p>
<pre class="language-yaml"><code class="language-yaml">    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2</code></pre>
<h2 id="setting-up-an-output-association" tabindex="-1">Setting up an output association <a class="direct-link" href="#setting-up-an-output-association" aria-hidden="true">#</a></h2>
<p>While the whole process will work without this step, it provides an extra level of comfort for those involved in the pull request review.</p>
<p>The linting is performed in the runner, and the output (from <code>markdownlint</code>) is available in the workflow execution detail:</p>
<p><img src="/blog/img/2021/05/execution-detail-messages.png" alt="workflow execution detail showing markdown lint output"></p>
<p>However, there's a small disconnect between the place of change and discussion (the pull request) and this workflow output.</p>
<p>There's a special, slightly mysterious feature that can help address this disconnection. This is the &quot;matcher&quot; feature, and is mysterious in that it's not particularly prominent in the main <a href="https://docs.github.com/en/actions">GitHub Actions documentation</a> ... although it is explained in the Actions Toolkit documentation, specifically <a href="https://github.com/actions/toolkit/blob/master/docs/commands.md#problem-matchers">in the ::Commands section</a>.</p>
<p>The general idea is that matchers can be added to a workflow execution. Matchers take the form of configuration that uses a regular expression to pick out parts of output messages and work out which bits are what. In other words, work out which file, line number and column each message applies to, as well as the message code and text.</p>
<p>This is what a matcher looks like, and it's the one I'm using to match the <code>markdownlint</code> output:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"problemMatcher"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"owner"</span><span class="token operator">:</span> <span class="token string">"markdownlint"</span><span class="token punctuation">,</span><br>      <span class="token property">"pattern"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>          <span class="token property">"regexp"</span><span class="token operator">:</span> <span class="token string">"^([^:]*):(\\d+):?(\\d+)?\\s([\\w-\\/]*)\\s(.*)$"</span><span class="token punctuation">,</span><br>          <span class="token property">"file"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>          <span class="token property">"line"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><br>          <span class="token property">"column"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>          <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><br>          <span class="token property">"message"</span><span class="token operator">:</span> <span class="token number">5</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>The regular expression actually appears slightly more complex than it is, because the backslashes that are used to introduce the metacharacters <code>\d</code> (digit), <code>\s</code> (whitespace) and <code>\w</code> (alphanumeric) are escaped with backslashes in the JSON string value (so e.g. <code>\d</code> becomes <code>\\d</code>). This is so they don't get interpreted as escape characters themselves.</p>
</blockquote>
<p>If we stare at the output earlier, we see this:</p>
<pre class="language-text"><code class="language-text">docs/b.md:5 MD022/blanks-around-headings/blanks-around-headers Headings should be surrounded by blank lines [Expected: 1; Actual: 0; Below] [Context: "### Something Else"]<br>docs/b.md:6 MD032/blanks-around-lists Lists should be surrounded by blank lines [Context: "- one"]<br>docs/b.md:10:10 MD011/no-reversed-links Reversed link syntax [(reversed)[https://qmacro.org]]</code></pre>
<p>Applying the regular expression, we can see that it will indeed pick out the values as desired. Taking the last message line as an example, we get:</p>
<table>
<thead>
<tr>
<th>Regular expression part</th>
<th>Matched text</th>
<th>Value for</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>^</code></td>
<td>(start of line)</td>
<td></td>
</tr>
<tr>
<td><code>([^:]*)</code></td>
<td><code>docs/b.md</code></td>
<td><code>file</code></td>
</tr>
<tr>
<td><code>:</code></td>
<td><code>:</code></td>
<td></td>
</tr>
<tr>
<td><code>(\d+)</code></td>
<td><code>10</code></td>
<td><code>line</code></td>
</tr>
<tr>
<td><code>:?</code></td>
<td><code>:</code></td>
<td></td>
</tr>
<tr>
<td><code>(\d+)?</code></td>
<td><code>10</code></td>
<td><code>column</code></td>
</tr>
<tr>
<td><code>\s</code></td>
<td>(a space)</td>
<td></td>
</tr>
<tr>
<td><code>([\w-\/]*)</code></td>
<td><code>MD011/no-reversed-links</code></td>
<td><code>code</code></td>
</tr>
<tr>
<td><code>\s</code></td>
<td>(a space)</td>
<td></td>
</tr>
<tr>
<td><code>(.*)</code></td>
<td><code>Reversed link syntax [...]</code></td>
<td><code>message</code></td>
</tr>
<tr>
<td><code>$</code></td>
<td>(end of line)</td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>In this table, the escaping backslashes have been removed, as they're only there to make the JSON string happy.</p>
</blockquote>
<p>The result of having a matcher like this is that as well as having the messages available in the workflow execution detail, we get the messages in context too, which is far more comfortable. They appear in the workflow execution summary, like this (see the &quot;Annotations&quot; section):</p>
<p><img src="/blog/img/2021/05/execution-summary-messages.png" alt="workflow execution summary showing markdown lint output"></p>
<p>Moreover, each message appears directly below the line to which it applies, like this:</p>
<p><img src="/blog/img/2021/05/messages-in-pr.png" alt="markdown linting messages next to the relevant lines"></p>
<p>To get this to work, the matcher configuration needs to be added with the <code>add-matcher</code> directive, in a step, like this:</p>
<pre class="language-yaml"><code class="language-yaml">    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token string">"echo ::add-matcher::.qmacro/workflows/markdownlint/problem-matcher.json"</span></code></pre>
<p>There is actually a GitHub Action, <a href="https://github.com/xt0rted/markdownlint-problem-matcher">xt0rted/markdownlint-problem-matcher</a> that does this for you, but I'm still in two minds as to whether to use a &quot;black box&quot; action or something direct for things like this. Only time will tell.</p>
<h2 id="installing-the-tool-and-custom-rules-packages" tabindex="-1">Installing the tool and custom rules packages <a class="direct-link" href="#installing-the-tool-and-custom-rules-packages" aria-hidden="true">#</a></h2>
<p>Next, it's time to install the actual <code>markdownlint</code> tool, along with the custom rule package I mentioned in <a href="https://qmacro.org/2021/05/13/notes-on-markdown-linting-1/">part 1</a>. While I installed <code>markdownlint</code> on my macOS machine with <code>brew</code>, it seems fine here to install it with <code>npm</code>, along with the rule too:</p>
<pre class="language-yaml"><code class="language-yaml">    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>        npm install \<br>          --no-package-lock \<br>          --no-save \<br>          markdownlint-cli markdownlint-rule-titlecase</span></code></pre>
<p>Using the <code>--no-package-lock</code> and <code>--no-save</code> options makes for a slightly cleaner environment, given what we're doing here (i.e. we are only really interested in NPM metadata for this current job's execution).</p>
<h2 id="performing-the-linting" tabindex="-1">Performing the linting <a class="direct-link" href="#performing-the-linting" aria-hidden="true">#</a></h2>
<p>Now everything is ready, we can run the linter. I am invoking the <code>markdownlint</code> tool, just installed with <code>npm</code>, using the <code>npx</code> package runner as it seems the cleanest way to do it:</p>
<pre class="language-yaml"><code class="language-yaml">    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>        npx markdownlint \<br>          --config .qmacro/workflows/markdownlint/config.yaml \<br>          --rules markdownlint-rule-titlecase \<br>          docs/</span></code></pre>
<p>Without configuration, <code>markdownlint</code> will apply <a href="https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md">all the rules</a> by default. I don't want that to happen, so I've used the <code>--config</code> option to point to a rules file <code>.qmacro/workflows/markdownlint/config.yaml</code>. This is what's in that file:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token comment"># All rules are inactive by default.</span><br><span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><br><br><span class="token comment"># These specific rules are active.</span><br><span class="token comment"># See https://github.com/DavidAnson/markdownlint#rules--aliases for details.</span><br><span class="token key atrule">heading-increment</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">no-reversed-links</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">no-missing-space-atx</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">no-multiple-space-atx</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">blanks-around-headings</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">blanks-around-lists</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br><span class="token key atrule">no-alt-text</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>In other words, with this configuration, only those rules in that second stanza will be applied. Plus of course the explicit NPM package based title-case rule I've specified with the <code>--rules</code> option.</p>
<blockquote>
<p>I've been <a href="https://github.community/t/best-practices-for-storing-organising-shell-scripts-for-workflow-steps/176822">thinking about</a> where to store workflow related artifacts in a repository. I don't want to use <code>.github/workflows</code> for anything other than actual workflow definition files. So right now, I'm thinking along the lines of a hidden user/organisation based directory name -- <code>.qmacro</code> in this example -- to parallel <code>.github</code>.</p>
</blockquote>
<p>The final thing to note in this invocation is that I'm passing a specific directory to be linted: <code>docs/</code>. This means only content there will be linted. I will probably want some sort of <code>.markdownlintignore</code> file at some stage, but for now this will do.</p>
<h2 id="wrapping-up" tabindex="-1">Wrapping up <a class="direct-link" href="#wrapping-up" aria-hidden="true">#</a></h2>
<p>Here's the workflow definition in its entirety:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Markdown checks<br><br><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span><br>    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">,</span> master<span class="token punctuation">]</span><br><br><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">main</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span><br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br><br>    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2<br><br>    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token string">"echo ::add-matcher::.qmacro/workflows/markdownlint/problem-matcher.json"</span><br><br>    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>        npm install \<br>          --no-package-lock \<br>          --no-save \<br>          markdownlint-cli markdownlint-rule-titlecase</span><br><br>    <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>        npx markdownlint \<br>          --config .qmacro/workflows/markdownlint/config.yaml \<br>          --rules markdownlint-rule-titlecase \<br>          docs/</span></code></pre>
<p>Everything works nicely, and I'm happy with the local and remote linting process.</p>

<hr>
<ul><li>Next: <a href="/blog/2021/19/5/supporting-developers-with-sponsorship/">Supporting developers with sponsorship</a></li><li>Previous: <a href="/blog/2021/13/5/notes-on-markdown-linting-part-1/">Notes on Markdown linting - part 1</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2021/14/5/notes-on-markdown-linting-part-2/ -->
  </body>
</html>
