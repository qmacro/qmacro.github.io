<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="pretty-atom-feed.xsl" type="text/xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
  <title>DJ Adams</title>
  <subtitle>Reserving the right to be wrong</subtitle>
  <link href="https://qmacro.org/feed/feed.xml" rel="self" />
  <link href="https://qmacro.org/blog/" />
  <updated>2026-02-06T00:00:00Z</updated>
  <id>https://qmacro.org/blog/</id>
  <author>
    <name>DJ Adams</name>
  </author>
  <entry>
    <title>Series of &quot;Did You Know&quot; videos</title>
    <link href="https://qmacro.org/blog/posts/2026/02/06/series-of-did-you-know-videos/" />
    <updated>2026-02-06T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/02/06/series-of-did-you-know-videos/</id>
    <content type="html">&lt;p&gt;ðŸ‘‰ Jump to the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/06/series-of-did-you-know-videos/#2-mocking-auth-in-cap&quot;&gt;latest video&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In the run up to SAP TechEd 2025, the Developer Advocates put together a series
of short videos on tech topics, in a &amp;quot;Did You Know&amp;quot; series. A bit like our
collection of YouTube Shorts &amp;quot;Good To Know&amp;quot; series (on &lt;a href=&quot;https://www.youtube.com/watch?v=0C-CcBKX1hI&amp;amp;list=PL6RpkC85SLQDZ18v94otZSJJrpcNkPPV9&quot;&gt;CAP
Node.js&lt;/a&gt;
and on &lt;a href=&quot;https://www.youtube.com/watch?v=q8WYkzBf0qs&amp;amp;list=PL6RpkC85SLQAd1pKjxrPpkOwia5RFw0DE&quot;&gt;ABAP
Cloud&lt;/a&gt;),
but in landscape mode with a bit more detail.&lt;/p&gt;
&lt;h2 id=&quot;the-series&quot;&gt;The series&lt;/h2&gt;
&lt;p&gt;Here&#39;s an overview of that &amp;quot;Did You Know&amp;quot; series; this list will be updated
over the coming weeks as we add them one by one to upcoming &lt;a href=&quot;https://www.youtube.com/playlist?list=PL6RpkC85SLQAVBSQXN9522_1jNvPavBgg&quot;&gt;SAP Developer
News&lt;/a&gt;
episodes.&lt;/p&gt;
&lt;h3 id=&quot;1-the-cds-repl&quot;&gt;1 The cds REPL&lt;/h3&gt;
&lt;p&gt;ðŸ“º &lt;a href=&quot;https://www.youtube.com/watch?v=5-mzMGS1gHo&amp;amp;t=139s&quot;&gt;Did you know&lt;/a&gt;: that the cds REPL is great for exploring your CAP services? (More info: &lt;a href=&quot;https://qmacro.org/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/&quot;&gt;A reCAP intro to the cds REPL&lt;/a&gt;) (DJ)&lt;/p&gt;
&lt;h3 id=&quot;2-mocking-auth-in-cap&quot;&gt;2 Mocking auth in CAP&lt;/h3&gt;
&lt;p&gt;ðŸ“º &lt;a href=&quot;https://www.youtube.com/watch?v=HqlUHFtW0g4&amp;amp;t=184s&quot;&gt;Did you know&lt;/a&gt;: that CAP has a &amp;quot;mocked&amp;quot; authentication strategy you can use in local development so you don&#39;t have to put off this important part of your domain design? (More info: &lt;a href=&quot;https://cap.cloud.sap/docs/node.js/authentication#strategies&quot;&gt;Authentication Strategies&lt;/a&gt;) (DJ) ðŸ‘ˆ LATEST&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Modifying queries, replacing the WHERE clause</title>
    <link href="https://qmacro.org/blog/posts/2026/02/04/modifying-queries-replacing-the-where-clause/" />
    <updated>2026-02-04T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/02/04/modifying-queries-replacing-the-where-clause/</id>
    <content type="html">&lt;p&gt;The result of modifying existing queries can be a little unexpected at first. For example, you might have a query object where you want to replace the WHERE clause before you execute it. Here&#39;s how not to do it, and then how to do it.&lt;/p&gt;
&lt;h2 id=&quot;setup&quot;&gt;Setup&lt;/h2&gt;
&lt;p&gt;To illustrate, we can use my &lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano&quot;&gt;cdsnano&lt;/a&gt; script to set up a tiny project with a &lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano-template/services.cds&quot;&gt;services.cds&lt;/a&gt; file containing:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; qmacro {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; Bookshop {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; qmacro.Books;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let&#39;s add a couple of sample books in &lt;code&gt;test/data/qmacro-Books.csv&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-csv&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-csv&quot;&gt;&lt;span class=&quot;token value&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;title&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;Book 1&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;Book 2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we can start up the cds REPL and ask for a CAP server to be started for this project:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds repl &lt;span class=&quot;token parameter variable&quot;&gt;--run&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;creating-the-query&quot;&gt;Creating the query&lt;/h2&gt;
&lt;p&gt;Let&#39;s create a query object with a WHERE condition:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; q1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
  SELECT from &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;Bookshop&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;entities&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Books&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; where title = &#39;Book 1&#39;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Bookshop.Books&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;=&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 1&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This works as expected:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; db&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 1&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;modifying-the-query-wrong&quot;&gt;Modifying the query (wrong)&lt;/h2&gt;
&lt;p&gt;Let&#39;s say we want to change the WHERE condition, to retrieve any book with a title starting with &amp;quot;Book&amp;quot;.&lt;/p&gt;
&lt;p&gt;What happens when we do this:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; q1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;title like &#39;Book%&#39;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Bookshop.Books&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&#39;=&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 1&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&#39;and&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&#39;like&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book%&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;.where(...)&lt;/code&gt; does not replace, but append - notice that both predicates:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;title = &#39;Book 1&#39;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;title like &#39;Book%&#39;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;are present, and joined with a logical &lt;code&gt;and&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The result of this query is not what we want:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; db&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 1&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;modifying-the-query-right&quot;&gt;Modifying the query (right)&lt;/h2&gt;
&lt;p&gt;We can replace the WHERE clause completely, supplying a new predicate, like this:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; q1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;where &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;predicate &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;title like &#39;Book%&#39;&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;like&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book%&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And indeed, this is what the entire query object looks like now:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; q1
cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Bookshop.Books&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;like&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book%&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This does what we want:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; db&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 1&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book 2&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;modifying-a-copy-of-the-query&quot;&gt;Modifying a copy of the query&lt;/h2&gt;
&lt;p&gt;It&#39;s probably a good idea to think about modifying a copy of the query, so you always have the original. We can use &lt;code&gt;cds.ql.clone()&lt;/code&gt; for that. Here&#39;s how it would work, in this example context:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; q2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;then we can operate on &lt;code&gt;q2&lt;/code&gt; and keep &lt;code&gt;q1&lt;/code&gt; intact.&lt;/p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;Nice!&lt;/p&gt;
&lt;p&gt;For more info, check out the &lt;a href=&quot;https://cap.cloud.sap/docs/node.js/cds-ql&quot;&gt;Querying in JavaScript&lt;/a&gt; topic in Capire, which, in the upcoming January 2026 release (that should be out in the next few days) will be expanded and fully constructed.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Path expressions, nested projections, aggregations and expressions in queries with CQL and CXL in CAP</title>
    <link href="https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/" />
    <updated>2026-02-04T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/</id>
    <content type="html">&lt;p&gt;In &lt;a href=&quot;https://www.youtube.com/watch?v=s4IZR1LBRrA&quot;&gt;Part 2&lt;/a&gt; of our current
Hands-on SAP Dev live stream &lt;a href=&quot;https://qmacro.org/blog/posts/2025/12/09/a-new-hands-on-sap-dev-mini-series-on-the-core-expression-language-in-cds/&quot;&gt;series on CXL with Patrice
Bender&lt;/a&gt;,
Patrice took some time to give us a glimpse into the power that CQL
and CXL offers. It was in the context of answering a question from one of
the live stream viewers (thanks Stubbs!) in the previous part, and the answer
revealed an inspiring landscape of possibilities.&lt;/p&gt;
&lt;p&gt;In this post I want to revisit the question, which was about iterating
over composition items in a query, with expressions.&lt;/p&gt;
&lt;h2 id=&quot;the-scenario&quot;&gt;The scenario&lt;/h2&gt;
&lt;p&gt;In October last year I published &lt;a href=&quot;https://qmacro.org/blog/posts/2025/10/14/modelling-contained-in-relationships-with-compositions-in-cds/&quot;&gt;Modelling contained-in relationships
with compositions in
CDS&lt;/a&gt;,
so I thought it would be nice to build on the sample in that post for this
simplified setup&lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;All we need is a a &lt;code&gt;services.cds&lt;/code&gt; file in a simple CAP Node.js project, the
usual &lt;code&gt;package.json&lt;/code&gt;, and some sample data in a &lt;code&gt;test/data/&lt;/code&gt;
directory&lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here&#39;s the entire CDS model in &lt;code&gt;services.cds&lt;/code&gt;, which follows the use of
an anonymous aspect as the target of the composition, as explained in the
&lt;a href=&quot;https://qmacro.org/blog/posts/2025/10/14/modelling-contained-in-relationships-with-compositions-in-cds/#implicit-modelling&quot;&gt;Implicit
modelling&lt;/a&gt;
section of the blog post.&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; qmacro {

  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
        price : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
  }

  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Orders {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        Items : &lt;span class=&quot;token association-composition keyword&quot;&gt;Composition of many &lt;/span&gt;{
                  &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; pos  : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
                      qty  : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
                      book : &lt;span class=&quot;token association-composition keyword&quot;&gt;Association to Books&lt;/span&gt;;
                }
  }

}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; S {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Orders &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; qmacro.Orders;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What&#39;s different to the sample is that I&#39;ve added a &lt;code&gt;Books&lt;/code&gt; entity, so that we
have a further relationship level:&lt;/p&gt;
&lt;h3 id=&quot;model-diagram&quot;&gt;Model diagram&lt;/h3&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;+--------+     +--------+     +--------+
| Orders |1---*| Items  |1---1| Books  |
+--------+     +--------+     +--------+&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I&#39;ve also now defined the entities within a &lt;code&gt;context&lt;/code&gt; block, so that I can
keep the service definition separate, and use projections if I want to - the
&lt;code&gt;context&lt;/code&gt; usefully lends a scope name (&lt;code&gt;qmacro&lt;/code&gt; in this case) to the entities
so that the projection references don&#39;t clash with the service level entity
specifications.&lt;/p&gt;
&lt;h2 id=&quot;some-sample-data&quot;&gt;Some sample data&lt;/h2&gt;
&lt;p&gt;Then, with &lt;code&gt;cds add data --out test/data/&lt;/code&gt;, I can create the empty CSV files
that already have the column headers (shown after the # symbols):&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;test
â””â”€â”€ data
    â”œâ”€â”€ qmacro-Books.csv         # ID,title,price
    â”œâ”€â”€ qmacro-Orders.csv        # ID
    â””â”€â”€ qmacro-Orders.Items.csv  # up__ID,pos,qty,book_ID&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;Remember that &lt;code&gt;up__ID&lt;/code&gt; is the result of the concatenation of the &lt;a href=&quot;https://qmacro.org/blog/posts/2025/10/14/modelling-contained-in-relationships-with-compositions-in-cds/#implicit-modelling:~:text=entity%0A%20%20%20%20elements%3A-,up_%3A,-key%3A%20true&quot;&gt;generated
element name for the parent
pointer&lt;/a&gt;
(&lt;code&gt;up_&lt;/code&gt;) with the key element name of the parent (&lt;code&gt;ID&lt;/code&gt;), using an underscore
(&lt;code&gt;_&lt;/code&gt;) to join them together.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The actual book and order CSV records can be viewed in &lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#appendix-a-csv-data&quot;&gt;Appendix
A&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;exploring-in-the-cds-repl&quot;&gt;Exploring in the cds REPL&lt;/h2&gt;
&lt;p&gt;Using the cds REPL gives developers a superpower&lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;, and
this is amply demonstrated throughout the series by Patrice. So let&#39;s follow
Patrice&#39;s lead and explore what we have using the cds REPL.&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds repl &lt;span class=&quot;token parameter variable&quot;&gt;--run&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The cds REPL starts and a CAP server is fired up automatically for the current
project (thanks to the &lt;code&gt;--run .&lt;/code&gt; option), with automatic reflections:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;from cds.entities: {
}

from cds.services: {
  db,
  S,
}&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;starting-simple&quot;&gt;Starting simple&lt;/h2&gt;
&lt;p&gt;We can examine the &lt;code&gt;Orders&lt;/code&gt; entity via the service &lt;code&gt;S&lt;/code&gt; which is in the
&lt;code&gt;cds.services&lt;/code&gt; list, for example like this:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;entities&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Orders
entity &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;entity&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;elements&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LinkedDefinitions &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Integer &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;cds.Integer&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Composition &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;cds.Composition&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;cardinality&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;*&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;targetAspect&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;elements&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token literal-property property&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;cds.Integer&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;cds.Integer&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;S.Orders.Items&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Items&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;up_&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;=&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;$self&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In a query, we can also of course simply refer to it by its fully qualified
name which includes the service name as prefix. Let&#39;s try a simple one to start
with:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;SELECT from S.Orders&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So far, so good.&lt;/p&gt;
&lt;h2 id=&quot;a-first-look-at-the-items&quot;&gt;A first look at the items&lt;/h2&gt;
&lt;p&gt;Let&#39;s now expand (I chose that word deliberately) into the items. How about
starting with a bit of denormalisation, asking for a flat list of order IDs and
item positions:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;SELECT ID, Items.pos from S.Orders&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items_pos&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This isn&#39;t the approach that Patrice took in expressing the query, it&#39;s more of
a traditional SQL-like statement ordering. But the query language parser still
allows us to use CQL affordances with this style, such as the path expression
&lt;code&gt;Items.pos&lt;/code&gt; which traverses the composition here.&lt;/p&gt;
&lt;p&gt;What Patrice used was the postfix notation (&lt;code&gt;{ ... }&lt;/code&gt;) within which we can put
our projection (the details of the &lt;code&gt;SELECT&lt;/code&gt; clause):&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Orders { ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Items&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pos }&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This produces the same result set. And this postfix notation approach makes it
easier to construct and think about more complex queries, which we&#39;ll do next.&lt;/p&gt;
&lt;h2 id=&quot;structural-expansion&quot;&gt;Structural expansion&lt;/h2&gt;
&lt;p&gt;Rather than the flattened list of order IDs and item positions, we can nest
a projection:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;SELECT from S.Orders { ID, Items { pos as p, qty } }&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This allows us to express and request structure which is reflected here in the
result set.&lt;/p&gt;
&lt;h2 id=&quot;further-model-traversal&quot;&gt;Further model traversal&lt;/h2&gt;
&lt;p&gt;We can travel further through the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#entity-diagram&quot;&gt;model&lt;/a&gt; with ease, as shown
in this example with a dotted path expression (&lt;code&gt;book.title&lt;/code&gt;):&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
SELECT from S.Orders { ID, Items { qty, book.title as book } }
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The Hitchhiker&#39;s Guide To The Galaxy&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;The Restaurant at the End of the Universe&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Life, the Universe and Everything&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The Hitchhiker&#39;s Guide To The Galaxy&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Mostly Harmless&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;And Another Thing...&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It&#39;s worth pausing here to reflect on how powerful, expressive and simple this
is, compared to what we&#39;d be required to write from a &lt;code&gt;JOIN&lt;/code&gt; perspective in SQL.&lt;/p&gt;
&lt;p&gt;Alternatively, note that projections can be nested arbitrarily:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
SELECT from S.Orders { ID, Items { qty, book { title } } }
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The Hitchhiker&#39;s Guide To The Galaxy&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;The Restaurant at the End of the Universe&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Life, the Universe and Everything&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The Hitchhiker&#39;s Guide To The Galaxy&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Mostly Harmless&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;book&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;And Another Thing...&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;using-an-expression&quot;&gt;Using an expression&lt;/h2&gt;
&lt;p&gt;During the series, Patrice explained that
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl&quot;&gt;CDL&lt;/a&gt; and
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cql&quot;&gt;CQL&lt;/a&gt; are &amp;quot;vehicles&amp;quot; that can carry
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cxl&quot;&gt;CXL&lt;/a&gt;. In other words, expressions can be
used both at design time, in the CDS model, within your CDL, and at runtime, in
queries, within your CQL.&lt;/p&gt;
&lt;p&gt;The expression he added in the context of the answer here was a &amp;quot;price x
quantity&amp;quot; calculation. It was within an aggregation, but we&#39;ll come to that
next, separately.&lt;/p&gt;
&lt;p&gt;First, let&#39;s just use such an expression, with &lt;code&gt;*&lt;/code&gt;, one of the supported
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cxl#binary-operator&quot;&gt;binary operators&lt;/a&gt;. We must
complete the expression with the declaration of an alias (otherwise, how could
the query be resolved ... we&#39;d get an &amp;quot;Expecting expression to have an alias name&amp;quot;
error):&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
SELECT from S.Orders { ID, Items { pos as p, book.price * qty as cost} }
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;250&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;cost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;using-an-aggregation&quot;&gt;Using an aggregation&lt;/h2&gt;
&lt;p&gt;The previous query and result set illustrated an expression within a nested
projection, referencing a path expression, for each order item (position). The
question, however, was about total values.&lt;/p&gt;
&lt;p&gt;Patrice showed this was also possible, using one of a number of portable
functions that are provided. These functions can be used in constructing
expressions, and can be supplied with expressions as arguments:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/02/function-diagram.png&quot; alt=&quot;function diagram&quot;&gt;&lt;/p&gt;
&lt;p&gt;The main aggregate functions are &lt;code&gt;avg()&lt;/code&gt;, &lt;code&gt;min()&lt;/code&gt;, &lt;code&gt;max()&lt;/code&gt;, &lt;code&gt;count()&lt;/code&gt; and &lt;code&gt;sum()&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Let&#39;s use &lt;code&gt;sum()&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
SELECT from S.Orders { ID, Items { sum(book.price * qty) as tot } }
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;75&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;250&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;40&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;adding-a-group-by-partition&quot;&gt;Adding a group by partition&lt;/h2&gt;
&lt;p&gt;If you were watching this section of &lt;a href=&quot;https://www.youtube.com/live/s4IZR1LBRrA&quot;&gt;Part
2&lt;/a&gt; closely, you&#39;ll have noticed that
Patrice also used a &lt;code&gt;group by&lt;/code&gt; partitioning using an infix notation. Here&#39;s the
equivalent in this scenario:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
SELECT from S.Orders { ID, Items[group by up__ID] { sum(book.price * qty) as tot } }
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;75&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;250&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;Items&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;tot&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;40&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;Bonus: Patrice told me that instead of the explicit &lt;code&gt;up__ID&lt;/code&gt;, we can actually
just use the name of the reverse association&lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/04/path-expressions-nested-projections-aggregations-and-expressions-in-queries-with-cql-and-cxl-in-cap/#footnotes&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt; on its
own, i.e. &lt;code&gt;Items[group by up_]&lt;/code&gt;, and the database service will sort out the
foreign key flattening for us.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There&#39;s no change. We got the same result set without the &lt;code&gt;group by&lt;/code&gt;. But
that&#39;s only because the aggregate function is operating on the entire
result set, and the context of the cds REPL here is a CAP server in development
mode, i.e. using a SQLite database, which is rather lenient. Postgres requires
a &lt;code&gt;group by&lt;/code&gt; if there are other elements in the result set not subject to the
aggregation, and HANA is a different beast altogether. So it&#39;s good practice to
be explicit with your partitioning.&lt;/p&gt;
&lt;h2 id=&quot;examining-the-query&quot;&gt;Examining the query&lt;/h2&gt;
&lt;p&gt;Before we finish, let&#39;s take a quick look at what this query looks like
&amp;quot;underneath&amp;quot;, i.e. the CQN form of the CQL (and CXL) we&#39;ve been constructing.
We can do that simply by omitting the &lt;code&gt;await&lt;/code&gt;, as the result of a call to
&lt;code&gt;cds.ql&lt;/code&gt; is a CQN construct. And this is what it looks like:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;S.Orders&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;columns&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;ID&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token literal-property property&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Items&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token literal-property property&quot;&gt;groupBy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;up__ID&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;expand&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token literal-property property&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;sum&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token literal-property property&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token literal-property property&quot;&gt;xpr&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;book&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;price&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                  &lt;span class=&quot;token string&quot;&gt;&#39;*&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;qty&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;tot&#39;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can observe:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the &lt;code&gt;group by&lt;/code&gt; is part of the reference to &lt;code&gt;Items&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;the entire expression is clear to see, with a &lt;code&gt;func&lt;/code&gt; and an &lt;code&gt;args&lt;/code&gt; array&lt;/li&gt;
&lt;li&gt;that array contains a single expression&lt;/li&gt;
&lt;li&gt;that expression is the binary operator &lt;code&gt;*&lt;/code&gt; with two operands&lt;/li&gt;
&lt;li&gt;the first operand is a path expression (a &lt;code&gt;ref&lt;/code&gt; array with more than one element)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;That&#39;s a lot to stare at!&lt;/p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;I hope this has been useful to help you revisit what Patrice taught us; it has
for me, most certainly. You can catch up on the replays for all the parts in
this series - just head over to the &lt;a href=&quot;https://qmacro.org/blog/posts/2025/12/09/a-new-hands-on-sap-dev-mini-series-on-the-core-expression-language-in-cds/&quot;&gt;series
post&lt;/a&gt;
for all the links.&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Just for a change, and to remind myself that there&#39;s a difference between
initial data and sample data, I&#39;ve gone for the latter option. For further
details on the distinction, see the section &lt;a href=&quot;https://github.com/SAP-samples/cap-local-development-workshop/tree/main/exercises/01#understand-the-difference-between-initial-and-sample-data&quot;&gt;Understand the difference
between initial and sample
data&lt;/a&gt;
in exercise 01 of the CAP local development workshop from reCAP 2025.&lt;/li&gt;
&lt;li&gt;I usually find that recreating a slightly different version of what I&#39;ve
seen helps me dig deeper and learn more.&lt;/li&gt;
&lt;li&gt;For an intro to the cds REPL, see &lt;a href=&quot;https://qmacro.org/blog/posts/2025/07/21/a-recap-intro-to-the-cds-repl/&quot;&gt;A reCAP intro to the cds
REPL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;See the &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl#managed-compositions&quot;&gt;Managed Composition of
Aspects&lt;/a&gt; section of
Capire&#39;s CDL topic for the term &amp;quot;reverse association&amp;quot; (aka &amp;quot;backlink&amp;quot;).&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;appendix-a-csv-data&quot;&gt;Appendix A - CSV data&lt;/h2&gt;
&lt;p&gt;In &lt;code&gt;qmacro-Books.csv&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-csv&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-csv&quot;&gt;&lt;span class=&quot;token value&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;price&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;The Hitchhiker&#39;s Guide To The Galaxy&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;101&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;The Restaurant at the End of the Universe&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;102&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;Life, the Universe and Everything&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;103&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;So Long, and Thanks for All the Fish&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;504&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;Mostly Harmless&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;105&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;&quot;And Another Thing...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(note the price for each book is &lt;code&gt;5&lt;/code&gt; for simple calculation checking).&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;qmacro-Orders.csv&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-csv&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-csv&quot;&gt;&lt;span class=&quot;token value&quot;&gt;ID&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;3&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In &lt;code&gt;qmacro-Orders.Items.csv&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-csv&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-csv&quot;&gt;&lt;span class=&quot;token value&quot;&gt;up__ID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;pos&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;qty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;book_ID&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;101&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;102&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;104&lt;/span&gt;
&lt;span class=&quot;token value&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token value&quot;&gt;105&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
</content>
  </entry>
  <entry>
    <title>OData Deep Dive rewrite in the open</title>
    <link href="https://qmacro.org/blog/posts/2026/02/02/odata-deep-dive-rewrite-in-the-open/" />
    <updated>2026-02-02T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/02/02/odata-deep-dive-rewrite-in-the-open/</id>
    <content type="html">&lt;p&gt;OData is a topic close to my heart.&lt;/p&gt;
&lt;h2 id=&quot;history&quot;&gt;History&lt;/h2&gt;
&lt;p&gt;I was around when RSS was growing up, and
even contributed to the wider RSS community activities at the time. I was also
around during the creation of Atom and the Atom Publishing Protocol (APP).&lt;/p&gt;
&lt;p&gt;I was around when Microsoft took Atom and APP and turned it into OData. I saw
its growth in the SAP ecosphere, from early adoption in the Duet space, onwards
and upwards. I also feel an affinity with OData because of its firm roots in
HTTP as the application protocol that it is, and the connection with
REpresentational State Transfer (REST). Heck, &lt;a href=&quot;https://qmacro.org/tags/narrowboat/&quot;&gt;my home and
workplace&lt;/a&gt; is named for that architectural
style.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2024/12/narrowboat-fully-restful.jpg&quot; alt=&quot;NB FULLY RESTFUL&quot;&gt;&lt;/p&gt;
&lt;p&gt;I dedicated one of the posts in my weekly &lt;a href=&quot;https://qmacro.org/tags/mondaymorningthoughts/&quot;&gt;Monday morning
thoughts&lt;/a&gt; series to &lt;a href=&quot;http://localhost:5005/blog/posts/2018/08/20/monday-morning-thoughts-odata/&quot;&gt;the topic of
OData&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;opportunity&quot;&gt;Opportunity&lt;/h2&gt;
&lt;p&gt;A while back, I&#39;d authored a series of tutorials, formed into a mission called
&amp;quot;Take a Deep Dive into OData&amp;quot; on the SAP &lt;a href=&quot;https://developers.sap.com/mission.scp-3-odata.html&quot;&gt;Tutorial
Navigator&lt;/a&gt;. Recently the
publicly available SAP system - upon which some of the tutorials were based -
was decomissioned.&lt;/p&gt;
&lt;p&gt;So I now have an opportunity to rewrite the series, and decided to do so in the
open, as it were. Writing in public, to share my work, ideas on what to cover,
and to give you the chance to send feedback and influence what goes in to that
series.&lt;/p&gt;
&lt;h2 id=&quot;guidelines&quot;&gt;Guidelines&lt;/h2&gt;
&lt;p&gt;I have some general guidelines that I&#39;ll be following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;While the content may sometimes overlap with OData-adjacent topics such as CAP,
the series focus is on OData and OData alone&lt;/li&gt;
&lt;li&gt;The activities will be based on an OData service that I&#39;ll create early on,
simple at first, and expanded in features and coverage as I work further
through the series&lt;/li&gt;
&lt;li&gt;I&#39;ll make the implementation of that OData service available too&lt;/li&gt;
&lt;li&gt;The tutorial sources will be available in a public repo on GitHub, even
before they appear on the Tutorial Navigator&lt;/li&gt;
&lt;li&gt;I will endeavour to create a question for most, if not all, of each
of the steps in the tutorials, to maximise learning and reflection&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I&#39;d love to hear your feedback, which you can provide in general via &lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/issues/new?title=Early%20feedback%20on%20the%20new%20OData%20mission&amp;amp;body=Let%20us%20know%20your%20thoughts%20on%20this%20new%20series%20-%20what%20you%20like,%20dislike,%20would%20like%20to%20see.%20Thank%20you!&quot;&gt;this
issue
link&lt;/a&gt;,
(I&#39;ve also shared this link in the first paragraph of &lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/blob/master/tutorials/odata-dd-1-origins/odata-dd-1-origins.md#intro&quot;&gt;the Intro section of the
first
tutorial&lt;/a&gt;),
or via the tutorial-specific feedback links in the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/02/02/odata-deep-dive-rewrite-in-the-open/#progress&quot;&gt;Progress&lt;/a&gt;
section of this very blog post (see below).&lt;/p&gt;
&lt;p&gt;Even if you just have a comment, or observation, or thoughts on how such a
series of tutorials on OData might help you, we&#39;d love to hear from you.&lt;/p&gt;
&lt;p&gt;Thanks!&lt;/p&gt;
&lt;h2 id=&quot;progress&quot;&gt;Progress&lt;/h2&gt;
&lt;p&gt;Here are links to the content for the OData Deep Dive tutorials so far.&lt;/p&gt;
&lt;p&gt;ðŸ‘‰ Follow the hyperlinks in the &amp;quot;Link&amp;quot; columns to get to the tutorial content draft to read through.&lt;/p&gt;
&lt;p&gt;ðŸ‘‰ Provide your comments, questions, proposals and thoughts using the specific
feedback links in the &amp;quot;Action&amp;quot; column - these specific links will indicate the
particular tutorial in the title of the issue that is created.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Nr&lt;/th&gt;
&lt;th&gt;Link&lt;/th&gt;
&lt;th&gt;Title&lt;/th&gt;
&lt;th&gt;Status&lt;/th&gt;
&lt;th&gt;Action&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/blob/master/tutorials/odata-dd-1-origins/odata-dd-1-origins.md&quot;&gt;Origins&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Learn about OData&#39;s origins&lt;/td&gt;
&lt;td&gt;Draft&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/issues/new?title=Early%20feedback%20on%20the%20new%20OData%20series,%20specifically%20Tutorial%201%20on%20%22Origins%22&amp;amp;body=Let%20us%20know%20your%20thoughts%20on%20the%20%22Origins%22%20tutorial.%20Thanks!&quot;&gt;Feedback&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/blob/master/tutorials/odata-dd-2-resources/odata-dd-2-resources.md&quot;&gt;Resources&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Get to know the OData standards resources on the Web&lt;/td&gt;
&lt;td&gt;Draft&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/sap-tutorials/Tutorials/issues/new?title=Early%20feedback%20on%20the%20new%20OData%20series,%20specifically%20Tutorial%202%20on%20%22Resources%22&amp;amp;body=Let%20us%20know%20your%20thoughts%20on%20the%20%22Resources%22%20tutorial.%20Thanks!&quot;&gt;Feedback&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
</content>
  </entry>
  <entry>
    <title>Modules, modularity &amp; reuse in CDS models - part 5 - digging into @capire/common</title>
    <link href="https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/" />
    <updated>2026-01-28T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/</id>
    <content type="html">&lt;p&gt;(Get to all the parts in this series via the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models/&quot;&gt;series
post&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;At the end of the previous part in this series we &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#adding-capire-common&quot;&gt;added
@capire/common&lt;/a&gt;
to the host project &lt;code&gt;use-capire&lt;/code&gt;, and without doing anything else -- no
referencing of this reuse package&#39;s contents anywhere in our own CDS model -- we
saw the explosion of sources in the CDS model when the CAP server automatically
restarted.&lt;/p&gt;
&lt;h2 id=&quot;the-model-sources&quot;&gt;The model sources&lt;/h2&gt;
&lt;p&gt;This is what was emitted by the CAP server:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cat&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;index&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;regions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;currencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Taking these 7 files, we have the sources specific to the &lt;code&gt;use-capire&lt;/code&gt; project:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;srv/cat-service.cds
db/schema.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;as well as the source for the built-in &lt;a href=&quot;https://cap.cloud.sap/docs/guides/messaging/task-queues&quot;&gt;task
queues&lt;/a&gt; mechanism:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;node_modules/@sap/cds/srv/outbox.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;plus three sources from &lt;code&gt;@capire/common&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;node_modules/@capire/common/index.cds
node_modules/@capire/common/regions.cds
node_modules/@capire/common/currencies.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and the well-known &lt;code&gt;@sap/cds/common&lt;/code&gt; source:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;node_modules/@sap/cds/common.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;While it&#39;s fairly clear why we have the built-in task queues based source and the
&lt;code&gt;use-capire&lt;/code&gt;-specific sources, the immediate presence of the other sources are
a little more puzzling.&lt;/p&gt;
&lt;p&gt;Let&#39;s dig in.&lt;/p&gt;
&lt;h2 id=&quot;contents-of-capire-common&quot;&gt;Contents of @capire/common&lt;/h2&gt;
&lt;p&gt;We&#39;re now familiar with the extreme basics of a reuse package, in the form of the
&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/&quot;&gt;now-published&lt;/a&gt;
&lt;code&gt;@qmacro/common&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;.
â”œâ”€â”€ README.md
â”œâ”€â”€ index.cds
â””â”€â”€ package.json&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, the contents of &lt;code&gt;@capire/common&lt;/code&gt;, which we &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#module-capire-common&quot;&gt;took an initial look at in part 1
of this
series&lt;/a&gt;,
are a little more involved:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ cds-plugin.js
â”œâ”€â”€ currencies.cds
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ sap.common-Countries.csv
â”‚   â”œâ”€â”€ sap.common-Countries_texts.csv
â”‚   â”œâ”€â”€ sap.common-Currencies.csv
â”‚   â”œâ”€â”€ sap.common-Currencies_texts.csv
â”‚   â”œâ”€â”€ sap.common-Languages.csv
â”‚   â””â”€â”€ sap.common-Languages_texts.csv
â”œâ”€â”€ index.cds
â”œâ”€â”€ package.json
â”œâ”€â”€ readme.md
â””â”€â”€ regions.cds&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;the-essential-files&quot;&gt;The essential files&lt;/h3&gt;
&lt;p&gt;Ignoring the two general repo files &lt;code&gt;LICENSE&lt;/code&gt; and &lt;code&gt;readme.md&lt;/code&gt; and the CSV files
in &lt;code&gt;data/&lt;/code&gt;, we are left with:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;.
â”œâ”€â”€ cds-plugin.js
â”œâ”€â”€ currencies.cds
â”œâ”€â”€ index.cds
â”œâ”€â”€ package.json
â””â”€â”€ regions.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There are the two familiar files &lt;code&gt;index.cds&lt;/code&gt; and &lt;code&gt;package.json&lt;/code&gt; which are
also present in &lt;code&gt;@qmacro/common&lt;/code&gt;, but there&#39;s &lt;code&gt;cds-plugin.js&lt;/code&gt; as well.&lt;/p&gt;
&lt;p&gt;Let&#39;s take each of these three files, one at a time.&lt;/p&gt;
&lt;h3 id=&quot;cds-plugin-js&quot;&gt;cds-plugin.js&lt;/h3&gt;
&lt;p&gt;If you&#39;ve read the &lt;a href=&quot;https://qmacro.org/blog/posts/2024/12/30/cap-node-js-plugins/&quot;&gt;CAP Node.js
Plugins&lt;/a&gt; series, especially &lt;a href=&quot;https://qmacro.org/blog/posts/2024/10/05/cap-node-js-plugins-part-1-how-things-work/&quot;&gt;part
1 - how things
work&lt;/a&gt;,
you&#39;ll know that &lt;code&gt;cds-plugin.js&lt;/code&gt; is a specially named file for which the
built-in plugin loading mechanism searches on startup.&lt;/p&gt;
&lt;p&gt;It just so happens that this &lt;code&gt;@capire/common&lt;/code&gt; reuse package has no need of any
custom code in &lt;code&gt;cds-plugin.js&lt;/code&gt;, but the fact that the file exists causes the
plugin to be loaded&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We can see this if we turn on debug output for the plugins mechanism:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;DEBUG&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;plugins cds &lt;span class=&quot;token function&quot;&gt;watch&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;whereupon the following will be emitted as part of the server log output:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; fetched plugins in&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1.315ms&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loading &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;fiori&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; impl&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;node_modules/@sap/cds-fiori/cds-plugin.js&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loading &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; impl&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;node_modules/@capire/common/cds-plugin.js&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loading &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;cap&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;js&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;sqlite&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; impl&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;node_modules/@cap-js/sqlite/cds-plugin.js&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plugins&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded plugins in&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7.149ms&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There&#39;s our &lt;code&gt;@capire/common&lt;/code&gt; being loaded.&lt;/p&gt;
&lt;p&gt;What effect does this have? Well, &amp;quot;loading&amp;quot; a plugin does not concern itself
solely with the contents of &lt;code&gt;cds-plugin.js&lt;/code&gt;. The &lt;a href=&quot;https://cap.cloud.sap/docs/node.js/cds-plugins#cds-plugin-packages&quot;&gt;CDS Plugin
Packages&lt;/a&gt;
topic in Capire tells us:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;quot;The &lt;code&gt;cds-plugin&lt;/code&gt; technique allows to provide extension packages with
auto-configuration.&amp;quot;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;and indeed the
&lt;a href=&quot;https://cap.cloud.sap/docs/node.js/cds-plugins#auto-configuration&quot;&gt;Auto-Configuration&lt;/a&gt;
section of the same topic tells us:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;quot;Plugins can also add new configuration settings, thereby providing auto
configuration. Simply add a &lt;code&gt;cds&lt;/code&gt; section to your &lt;code&gt;package.json&lt;/code&gt; file, as you
would do in a project&#39;s &lt;code&gt;package.json&lt;/code&gt;.&amp;quot;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So now that the reuse package is being loaded as a plugin, let&#39;s next turn our
attention to &lt;code&gt;@capire/common&lt;/code&gt;&#39;s &lt;code&gt;package.json&lt;/code&gt; file.&lt;/p&gt;
&lt;h3 id=&quot;package-json&quot;&gt;package.json&lt;/h3&gt;
&lt;p&gt;Here&#39;s the content:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@capire/common&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;A plugin extending @sap/cds/common, and providing reuse content.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;repository&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://github.com/capire/common&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2.0.2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;dependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;@sap/cds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;cds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;requires&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;@capire/common/data&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;model&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@capire/common&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;name&lt;/code&gt;, &lt;code&gt;repository&lt;/code&gt; and other properties are all
self-explanatory. But look at that &lt;code&gt;cds&lt;/code&gt; property!&lt;/p&gt;
&lt;h4 id=&quot;the-effective-environment&quot;&gt;The effective environment&lt;/h4&gt;
&lt;p&gt;The value of the &lt;code&gt;cds&lt;/code&gt; property &lt;em&gt;becomes part of the effective environment&lt;/em&gt;,
part of the the CAP server&#39;s specific DNA.&lt;/p&gt;
&lt;p&gt;We can examine this from within our &lt;code&gt;use-capire&lt;/code&gt; project root by running:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds &lt;span class=&quot;token function&quot;&gt;env&lt;/span&gt; requires&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which emits:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;{
  middlewares: true,
  queue: {
    model: &#39;@sap/cds/srv/outbox&#39;,
    ...
    kind: &#39;persistent-queue&#39;
  },
  auth: {
    restrict_all_services: false,
    kind: &#39;mocked&#39;,
    users: {
      alice: { tenant: &#39;t1&#39;, roles: [ &#39;admin&#39; ] },
      ...
      yves: { roles: [ &#39;internal-user&#39; ] },
      &#39;*&#39;: true
    },
    tenants: { t1: { features: [ &#39;isbn&#39; ] }, t2: { features: &#39;*&#39; } }
  },
  &#39;@capire/common/data&#39;: { model: &#39;@capire/common&#39; },     &lt;---
  db: {
    impl: &#39;@cap-js/sqlite&#39;,
    ...
    kind: &#39;sqlite&#39;
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The arrow shows the value of &lt;code&gt;@capire/common/package.json#cds.requires&lt;/code&gt;, which
is now part of the overall set of &amp;quot;requires&amp;quot; for the project server.&lt;/p&gt;
&lt;p&gt;While the property&#39;s key (name) is largely irrelevant, the value:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;model&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@capire/common&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;is critical.&lt;/p&gt;
&lt;p&gt;It means that &lt;code&gt;@capire/common&lt;/code&gt; should become part of the project&#39;s
overall CDS model.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;How this happens technically is explained in &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/#appendix-a-including-neighbourhood-models&quot;&gt;Appendix A - Including
neighbourhood models&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;And understanding what that means takes us back to earlier points in this
series, specifically:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#imports-and-model-resolution&quot;&gt;Imports and model
resolution&lt;/a&gt;
in part 1&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#transferring-the-type-definition&quot;&gt;Transferring the type
definition&lt;/a&gt;
in part 2&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the model&#39;s structure, any reference to a directory will cause the compiler
to look for an &amp;quot;index&amp;quot; file therein. And as the &lt;code&gt;@capire/common&lt;/code&gt; reuse package
is, at the end of the day, a directory (within &lt;code&gt;node_modules/&lt;/code&gt;), that&#39;s what
will happen here.&lt;/p&gt;
&lt;h2 id=&quot;index-cds&quot;&gt;index.cds&lt;/h2&gt;
&lt;p&gt;So it makes perfect sense to have an &lt;code&gt;index.cds&lt;/code&gt; file as the entrypoint for
&lt;code&gt;@capire/common&lt;/code&gt;. And as we learned when &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#module-capire-common&quot;&gt;first examining module
@capire/common&lt;/a&gt;,
that &lt;code&gt;index.cds&lt;/code&gt; file points to the other two files in &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/#the-essential-files&quot;&gt;the essential
files&lt;/a&gt; list:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;          index.cds
              |
        +-----+-----+
        |           |
currencies.cds   regions.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is done with a couple of simple &lt;code&gt;using&lt;/code&gt; directives:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;./currencies&#39;;
&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;./regions&#39;;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So. That covers the loading of:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;node_modules/@capire/common/index.cds
node_modules/@capire/common/regions.cds
node_modules/@capire/common/currencies.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and as we can probably guess (and confirm by looking within &lt;code&gt;regions.cds&lt;/code&gt; and
&lt;code&gt;currencies.cds&lt;/code&gt;), there&#39;s also:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;node_modules/@sap/cds/common.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;that&#39;s being loaded because it&#39;s brought in via &lt;code&gt;using&lt;/code&gt; directives in each of
those &lt;code&gt;.cds&lt;/code&gt; files.&lt;/p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;This nicely brings us back to where we started with &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/#the-model-sources&quot;&gt;the model
sources&lt;/a&gt;. But now we understand:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;what they are&lt;/li&gt;
&lt;li&gt;where they come from&lt;/li&gt;
&lt;li&gt;why they&#39;re loaded&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Essentially:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the fact that &lt;code&gt;@capire/common&lt;/code&gt; reuse package was constructed as a plugin&lt;/li&gt;
&lt;li&gt;combined with its &lt;code&gt;package.json#cds&lt;/code&gt; configuration determining the
requirement for its model to be included&lt;/li&gt;
&lt;li&gt;and the presence of an &amp;quot;index&amp;quot; entrypoint file&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;makes the package &amp;quot;active&amp;quot; ... and definitely educational!&lt;/p&gt;
&lt;p&gt;There is elegance in the simplicity of axioms such as &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/axioms/AXI003.md&quot;&gt;AXI003 Convention
over
configuration&lt;/a&gt;,
that inform this approach. There is a beauty in how such axioms are
realised in the CAP framework.&lt;/p&gt;
&lt;p&gt;Moreover, the power of small mechanisms like this, with their broad
reach, can bring about &amp;quot;nuclear weapons effects&amp;quot; - not my words, but the words
of CAP&#39;s BDFL, Daniel Hutzel.&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;In fact the only thing that &lt;code&gt;cds-plugin.js&lt;/code&gt; contains is a comment to this
effect:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// dummy to auto-load the plugin&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;appendix-a-including-neighbourhood-models&quot;&gt;Appendix A - Including neighbourhood models&lt;/h2&gt;
&lt;p&gt;There&#39;s a function in the CAP Node.js runtime resolver that does the work here.
Its brevity belies the powerful effect that it truly has.&lt;/p&gt;
&lt;h3 id=&quot;inside-lib-compile-resolve-js&quot;&gt;Inside lib/compile/resolve.js&lt;/h3&gt;
&lt;p&gt;The function is called &lt;code&gt;_required&lt;/code&gt; and is in &lt;code&gt;@sap/cds/lib/compile/resolve.js&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Here&#39;s what the function looks like, alongside its big sister function
&lt;code&gt;_resolve_all&lt;/code&gt;, which calls it (this is at CAP Node.js version 9.6.3):&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token function-variable function&quot;&gt;_required&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;env&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;requires&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; _resolve &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;module&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_resolveFilename

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_resolve_all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;o&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;cds&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;roots&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dry &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; o &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;roots&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_required&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;flat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; cache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; exports&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cache
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; cached &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;*&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cached&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; cached
  cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;*&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// important to avoid endless recursion on &#39;*&#39;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; sources &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;roots&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sources&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;endsWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;csn.json&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// REVISIT: why is that? -&gt; pre-compiled gen/csn.json?&lt;/span&gt;
    sources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_required&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;*&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_resolved&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sources&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Remember that with regards to the inclusion of any neighbourhood models, the
required model specified in &lt;code&gt;@capire/common&lt;/code&gt;&#39;s &lt;code&gt;package.json#cds&lt;/code&gt; configuration
is the target:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;cds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;requires&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;@capire/common/data&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;model&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@capire/common&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In other words, the required model is stated as being &lt;code&gt;@capire/common&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Within the &lt;code&gt;_resolve_all&lt;/code&gt; function, the relevant processing starts towards the
end of the function.&lt;/p&gt;
&lt;h3 id=&quot;gathering-model-sources&quot;&gt;Gathering model sources&lt;/h3&gt;
&lt;p&gt;Given the line:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;sources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_required&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we need to understand that &lt;code&gt;sources&lt;/code&gt; is an array that contains the &amp;quot;primary&amp;quot;
sources for the model, and, before this line is executed, for our &lt;code&gt;use-capire&lt;/code&gt;
project, contains the two usual suspect files:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/db/schema.cds&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/srv/cat-service.cds&#39;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What does the &lt;code&gt;sources&lt;/code&gt; array contain after this line is executed? This:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/db/schema.cds&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/srv/cat-service.cds&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/node_modules/@sap/cds/srv/outbox.cds&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;/tmp/use-capire/node_modules/@capire/common/index.cds&#39;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So - what does &lt;code&gt;_required&lt;/code&gt; do to cause these two references:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;/tmp/use-capire/node_modules/@sap/cds/srv/outbox.cds
/tmp/use-capire/node_modules/@capire/common/index.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;to be added to the &lt;code&gt;sources&lt;/code&gt; array, i.e. to the sources for the overall model?&lt;/p&gt;
&lt;h3 id=&quot;looking-at-required&quot;&gt;Looking at _required&lt;/h3&gt;
&lt;p&gt;To answer, that, let&#39;s take a moment to &lt;a href=&quot;https://qmacro.org/blog/posts/2017/02/19/the-beauty-of-recursion-and-list-machinery/#initial-recognition&quot;&gt;stare
at&lt;/a&gt;
that &lt;code&gt;_required&lt;/code&gt; function, which looks like this when we add some whitespace to
it:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;env&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
  Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;requires&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Briefly, this function:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;expects an environment definition, defaulting to the main one (in &lt;code&gt;cds.env&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;produces a list of the values of the &lt;code&gt;requires&lt;/code&gt; properties in that
environment definition&lt;/li&gt;
&lt;li&gt;pares down each of those values to just the value&#39;s &lt;code&gt;model&lt;/code&gt; specification (if
there is one)&lt;/li&gt;
&lt;li&gt;removes any empty values (i.e. if there wasn&#39;t a &lt;code&gt;model&lt;/code&gt; property)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Remembering the values of the &lt;code&gt;requires&lt;/code&gt; property of &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/28/modules-modularity-and-reuse-in-cds-models-part-5-digging-into-capire-common/#the-effective-environment&quot;&gt;the effective
environment&lt;/a&gt; from earlier:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;{
  middlewares: true,
  queue: {
    model: &#39;@sap/cds/srv/outbox&#39;,
    ...
    kind: &#39;persistent-queue&#39;
  },
  auth: {
    restrict_all_services: false,
    kind: &#39;mocked&#39;,
    users: {
      alice: { tenant: &#39;t1&#39;, roles: [ &#39;admin&#39; ] },
      ...
      yves: { roles: [ &#39;internal-user&#39; ] },
      &#39;*&#39;: true
    },
    tenants: { t1: { features: [ &#39;isbn&#39; ] }, t2: { features: &#39;*&#39; } }
  },
  &#39;@capire/common/data&#39;: { model: &#39;@capire/common&#39; },
  db: {
    impl: &#39;@cap-js/sqlite&#39;,
    ...
    kind: &#39;sqlite&#39;
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we can see that there are only two that contain a &lt;code&gt;model&lt;/code&gt; property:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;queue&lt;/code&gt; with model &lt;code&gt;@sap/cds/srv/outbox&lt;/code&gt; - for the task queue mechanism&lt;/li&gt;
&lt;li&gt;&lt;code&gt;@capire/common/data&lt;/code&gt; with model &lt;code&gt;@capire/common&lt;/code&gt; - our reuse package&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Bingo! These both get pushed onto the &lt;code&gt;sources&lt;/code&gt; array (as filesystem
references, via &lt;code&gt;cds.resolve&lt;/code&gt;) and consequently included as part of the overall
CDS model for the runtime.&lt;/p&gt;
&lt;h3 id=&quot;further-reading&quot;&gt;Further reading&lt;/h3&gt;
&lt;p&gt;If you want an even deeper dive into this mechanism, you might be interested in
reading the blog post &lt;a href=&quot;https://qmacro.org/blog/posts/2025/05/01/fp-function-chains-and-cap-model-loading/&quot;&gt;FP, function chains and CAP model
loading&lt;/a&gt;.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Constraints, expressions and axioms in action</title>
    <link href="https://qmacro.org/blog/posts/2026/01/27/constraints-expressions-and-axioms-in-action/" />
    <updated>2026-01-27T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/27/constraints-expressions-and-axioms-in-action/</id>
    <content type="html">&lt;p&gt;In &lt;a href=&quot;https://www.youtube.com/watch?v=s4IZR1LBRrA&quot;&gt;part 2&lt;/a&gt; of the current
Hands-on SAP Dev live stream mini-series &lt;a href=&quot;https://qmacro.org/blog/posts/2025/12/09/a-new-hands-on-sap-dev-mini-series-on-the-core-expression-language-in-cds/&quot;&gt;on CXL, the core expression language
in
CDS&lt;/a&gt;,
Patrice demonstrated how declarative constraints are actually realised, and it
made me sit back and wonder. I thought I&#39;d write a quick blog post summarising
what he showed, as I think it&#39;s worth stopping and taking a bit of time to
think about.&lt;/p&gt;
&lt;h2 id=&quot;containers-and-containees&quot;&gt;Containers and containees&lt;/h2&gt;
&lt;p&gt;During the session, Patrice had painted a lovely picture of CAP&#39;s CDS language
family, and highlighted that expressions, in
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cxl&quot;&gt;CXL&lt;/a&gt; (and its corresponding
machine-readable equivalent &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cxn&quot;&gt;CXN&lt;/a&gt;) were to
be found in various places, specifically in the context of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the definition language &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl&quot;&gt;CDL&lt;/a&gt; (and
corresponding &lt;a href=&quot;https://cap.cloud.sap/docs/cds/csn&quot;&gt;CSN&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;the query language &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cql&quot;&gt;CQL&lt;/a&gt; (and
corresponding &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cqn&quot;&gt;CQN&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In other words, from a human perspective, if CXL is a containee, both CDL and
CQL are containers. Expressions are found in model and service definitions and
also in queries.&lt;/p&gt;
&lt;h2 id=&quot;declarative-constraints&quot;&gt;Declarative constraints&lt;/h2&gt;
&lt;p&gt;In the context of service definitions, data for entities and their elements can
be subject to &lt;a href=&quot;https://cap.cloud.sap/docs/guides/services/constraints#input-validation&quot;&gt;input
validation&lt;/a&gt;,
typically provided via annotations. Annotations such as &lt;code&gt;@mandatory&lt;/code&gt;,
&lt;code&gt;@readonly&lt;/code&gt;, and &lt;code&gt;@assert.format&lt;/code&gt;, &lt;code&gt;@assert.range&lt;/code&gt; &amp;amp; &lt;code&gt;@assert.target&lt;/code&gt; have been
available for a while and can be used for formal but limited (pre-defined)
types of input validation.&lt;/p&gt;
&lt;p&gt;Declarative constraints are relatively new (&lt;a href=&quot;https://cap.cloud.sap/docs/releases/dec25#declarative-constraints&quot;&gt;reaching &amp;quot;gamma&amp;quot; status in the
December 2025
release&lt;/a&gt;)
and extend the possibilities for input validation by allowing us to define our
own conditions, using the CXL expression language, and presenting those
definitions within an &lt;code&gt;@assert&lt;/code&gt; annotation.&lt;/p&gt;
&lt;h2 id=&quot;what-not-how-less-is-more&quot;&gt;What not how, less is more&lt;/h2&gt;
&lt;p&gt;There are a couple of axioms that inform the design and the fundamental
philosophy of the CAP framework:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qmacro/capref/blob/main/axioms/AXI001.md&quot;&gt;AXI001 What not
how&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qmacro/capref/blob/main/axioms/AXI002.md&quot;&gt;AXI002 Less is
more&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A practical aim, and effect, of these two axioms is to drive custom code
upwards and downwards ... and &lt;em&gt;out&lt;/em&gt; of a project:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;              +---------------+   -+
              | Definitions   |    |
              | of services   |    |
              |               |    |
              +---------------+    |
                                   +- CDS
              +---------------+    |
              | Domain model  |    |
              | definition    |    |
         ^    |               |    |
    push |    +---------------+   -+
      up |
         |    +---------------+   -+
         +----| Custom        |    |
              | logic         |    +- JavaScript, Java
         +----|               |    |
    push |    +---------------+   -+
    down |
         |    +---------------+   -+
         v    |               |    |
              | Database      |    +- SQL
              |               |    |
              +---------------+   -+&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The definition of the declarative constraint that Patrice demonstrated,
combined with how it was made real, is a perfect reflection of both the upwards
and downwards push of custom code out of the project.&lt;/p&gt;
&lt;p&gt;Let me demonstrate what I mean, with a simplified version.&lt;/p&gt;
&lt;h2 id=&quot;basic-model-and-service-definition&quot;&gt;Basic model and service definition&lt;/h2&gt;
&lt;p&gt;Using my hyper-simple
&lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano&quot;&gt;cdsnano&lt;/a&gt; CAP
Node.js tiny project starter, with its
&lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano-template/services.cds&quot;&gt;services.cds&lt;/a&gt;,
I get this:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; qmacro {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; Bookshop {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; qmacro.Books;
}&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;adding-a-constraint-declaratively&quot;&gt;Adding a constraint declaratively&lt;/h2&gt;
&lt;p&gt;Now let me add a declarative constraint, using &lt;code&gt;@assert&lt;/code&gt; and a CXL expression.
To keep things simple, I&#39;ll put this in the same file:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;annotate Bookshop.Books with {
  title &lt;span class=&quot;token annotation important&quot;&gt;@assert:&lt;/span&gt; (case
                    &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;when&lt;/span&gt; length(title) &amp;lt; 2
                         &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;then&lt;/span&gt; &#39;Book title is too short!&#39;
                  &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;end&lt;/span&gt;)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The part in brackets (&lt;code&gt;case when ... then ... end&lt;/code&gt;) is the expression, which is
evaluated; that is, it resolves to a value. Here, this will either be null, if
there&#39;s no matched condition&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/27/constraints-expressions-and-axioms-in-action/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;, or the string &lt;code&gt;&#39;Book title is too short!&#39;&lt;/code&gt;, which is consequently returned in a 400 status error
back to the client.&lt;/p&gt;
&lt;h3 id=&quot;pushing-up&quot;&gt;Pushing up&lt;/h3&gt;
&lt;p&gt;Already we see a prime example of the &amp;quot;push up&amp;quot; part of the diagram. There&#39;s no
custom code that we&#39;ve needed to write and maintain in a handler - we&#39;ve
elevated the business requirement to the CDS modelling level. There is a small
amount of &amp;quot;code&amp;quot;, in the form of the expression, but this is far simpler, which
is one of the key benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;there is zero ceremony: no determining the appropriate event context, no
setting up of the callback, no marshalling of the arguments, no parsing of
the request data and no manual returning of the error message&lt;/li&gt;
&lt;li&gt;there is also no free-form language approach to realising the constraint,
which means a far smaller scope for error&lt;/li&gt;
&lt;li&gt;constraints are accessible to, shared with and driven by the domain expert,
at the CDS model level&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;trying-out-the-constraint&quot;&gt;Trying out the constraint&lt;/h2&gt;
&lt;p&gt;Can things really be this simple? Let&#39;s see.&lt;/p&gt;
&lt;p&gt;Starting the CAP server up in one shell session, with &lt;code&gt;cds watch&lt;/code&gt; as usual, we
can request an OData create operation in a second shell session thus:&lt;/p&gt;
&lt;pre class=&quot;language-shell&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--include&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--header&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Content-Type: application/json&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;{&quot;ID&quot;:1,&quot;title&quot;:&quot;a&quot;}&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--url&lt;/span&gt; localhost:4004/odata/v4/bookshop/Books&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This returns:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;HTTP/1.1 400 Bad Request
OData-Version: 4.0
Content-Type: application/json; charset=utf-8
Content-Length: 109

{
  &quot;error&quot;: {
    &quot;message&quot;: &quot;Book title is too short!&quot;,
    &quot;code&quot;: &quot;ASSERT&quot;,
    &quot;target&quot;: &quot;title&quot;,
    &quot;@Common.numericSeverity&quot;: 4
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(Some response headers have been left out, and the response payload has been pretty printed for easier reading.)&lt;/p&gt;
&lt;h2 id=&quot;digging-in&quot;&gt;Digging in&lt;/h2&gt;
&lt;p&gt;Patrice used the &lt;code&gt;DEBUG&lt;/code&gt; environment variable to cause the CAP server to emit
detailed log messages. Let&#39;s do that now, and do it in the context of the cds
REPL, which Patrice also used, as it&#39;s always a good idea to practise using
that powerful developer tool&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/27/constraints-expressions-and-axioms-in-action/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Starting the cds REPL up, and asking for a CAP server to be started for the
project in the current directory, like this:&lt;/p&gt;
&lt;pre class=&quot;language-shell&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;DEBUG&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;sql cds repl &lt;span class=&quot;token parameter variable&quot;&gt;--run&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;gives us plenty of output at the outset. But what we&#39;re interested in is what
happens when we again try to insert the same values.&lt;/p&gt;
&lt;p&gt;As we&#39;re in the cds REPL, we can construct a query (instead of making an OData
call from &amp;quot;outside&amp;quot;):&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;q &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;INSERT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;into&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Bookshop&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;entities&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Books&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which shows us:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ql &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token constant&quot;&gt;INSERT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;into&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Bookshop.Books&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we can send that to the &lt;code&gt;Bookshop&lt;/code&gt; service:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; Bookshop&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and at this point we see some debug SQL output:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; BEGIN
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; INSERT INTO qmacro_Books &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;title&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; SELECT value&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;ID&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;value&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;title&quot;&#39;&lt;/span&gt; FROM json_each&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; ID&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; title&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; SELECT json_insert&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;{}&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;ID&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;@assert:title&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; as _json_ FROM &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;SELECT &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;case when length&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; then &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; end as &lt;span class=&quot;token string&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt; FROM Bookshop_Books as &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt; WHERE &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; in &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book title is too short!&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; ROLLBACK&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We also see the result of this (which would be sent back to the client, in the
case of an actual request):&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token property&quot;&gt;Uncaught:&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;status:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;code:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;ASSERT&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;target:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;title&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;numericSeverity:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&#39;@Common.numericSeverity&#39;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;message:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book title is too short!&#39;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;examining-the-sql&quot;&gt;Examining the SQL&lt;/h2&gt;
&lt;p&gt;What happened here? There are four statements, in sequence:&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;BEGIN&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;-- start a new transaction&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;INSERT&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;-- add the record&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;-- check it&#39;s valid&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;ROLLBACK&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;-- it wasn&#39;t, so roll back the transaction&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;pushing-down&quot;&gt;Pushing down&lt;/h3&gt;
&lt;p&gt;So, a new transaction was started with &lt;code&gt;BEGIN&lt;/code&gt;, and the record was added with
&lt;code&gt;INSERT&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Next, we can see that the constraint, which we expressed declaratively, is
realised by pushing it down to the database, and having it executed there, in
the context of the &lt;code&gt;SELECT&lt;/code&gt; statement.&lt;/p&gt;
&lt;p&gt;Finally, because the data was determined not to be valid, the transaction was
rolled back and the data addition was undone.&lt;/p&gt;
&lt;p&gt;Let&#39;s reformat the debug SQL output for the &lt;code&gt;INSERT&lt;/code&gt; and &lt;code&gt;SELECT&lt;/code&gt; statements
and examine them in detail.&lt;/p&gt;
&lt;h3 id=&quot;the-insert-statement&quot;&gt;The INSERT statement&lt;/h3&gt;
&lt;p&gt;While the focus of this post is on the declarative constraint based data
validation, it&#39;s worth looking at not only that (in the &lt;code&gt;SELECT&lt;/code&gt;
statement) but also the &lt;code&gt;INSERT&lt;/code&gt; statement, as it also uses some &lt;a href=&quot;https://sqlite.org/json1.html&quot;&gt;JSON
functions and constructs&lt;/a&gt; and gets our brains in
gear on that front.&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;INTO&lt;/span&gt;
  qmacro_Books &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; title&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;ID&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;title&quot;&#39;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt;
  json_each&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;?&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; { ID: &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; title: &lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt; } &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;First, the target table is of course the one created for the &lt;code&gt;Books&lt;/code&gt; entity in
the &lt;code&gt;qmacro&lt;/code&gt; namespace, and its creation at CAP server startup was logged via
the &lt;code&gt;DEBUG=sql&lt;/code&gt; switch too:&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;TABLE&lt;/span&gt; qmacro_Books &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  ID &lt;span class=&quot;token keyword&quot;&gt;INTEGER&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  title NVARCHAR&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;KEY&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;json_each&lt;/code&gt; function returns a row of data for each array item, with &lt;code&gt;key&lt;/code&gt;,
&lt;code&gt;value&lt;/code&gt; and other columns&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/27/constraints-expressions-and-axioms-in-action/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;. The &lt;code&gt;value&lt;/code&gt; column is
&lt;code&gt;SELECT&lt;/code&gt;ed a couple of times, with the &lt;code&gt;-&amp;gt;&amp;gt;&lt;/code&gt; operator being used to extract
property values (for &lt;code&gt;ID&lt;/code&gt; and &lt;code&gt;title&lt;/code&gt;) from the current array item presented in
the value.&lt;/p&gt;
&lt;p&gt;So the book data row is inserted.&lt;/p&gt;
&lt;h2 id=&quot;the-select-statement&quot;&gt;The SELECT statement&lt;/h2&gt;
&lt;p&gt;With the &lt;code&gt;SELECT&lt;/code&gt; statement, the validity of the data according to the
constraint expression is checked, using SQL, thus mandating the (possibly)
temporary insertion of the data to be validated, within a transaction.&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;
    json_insert&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&#39;{}&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;ID&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&#39;$.&quot;@assert:title&quot;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; _json_
&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;when&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; ? &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; ?
            &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt;
            Bookshop_Books &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;WHERE&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;?&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book title is too short!&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;SELECT&lt;/code&gt; itself uses &lt;code&gt;json_insert&lt;/code&gt; to construct an object that looks like
this:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;ID&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &amp;lt;the book ID&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &amp;lt;constraint error message&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; or &lt;span class=&quot;token null keyword&quot;&gt;null&lt;/span&gt;&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The values in this object come from the nested &lt;code&gt;SELECT&lt;/code&gt; statement inside the
&lt;code&gt;FROM&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Inserting the values into the &lt;code&gt;?&lt;/code&gt; placeholders for this statement gives
us:&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;when&lt;/span&gt; length&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;title&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;Book title is too short!&#39;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@assert:title&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt;
    Bookshop_Books &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;WHERE&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ID&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looks familiar, right? The SQL &lt;code&gt;case&lt;/code&gt; expression here mirrors the source
constraint expression, which has been transliterated and pushed down to the
database layer for execution.&lt;/p&gt;
&lt;h3 id=&quot;possible-outcomes&quot;&gt;Possible outcomes&lt;/h3&gt;
&lt;p&gt;There are two values determined in the inner &lt;code&gt;SELECT&lt;/code&gt;, one for the book&#39;s ID,
and the other for the possible error message. Here&#39;s an example of failure and
success:&lt;/p&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Inserted   --&gt;   Generated

ID, title        ID, @assert:title
---------        ------------------------------
1,  &#39;a&#39;          1,  &#39;Book title is too short!&#39;
1,  &#39;aa&#39;         1,  null&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point, the validation part of the framework checks the generated values
that are returned, taking appropriate action depending on the value of
&lt;code&gt;@assert:title&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;non-null: a &lt;code&gt;ROLLBACK&lt;/code&gt; is executed, undoing the data insertion, and the error
is bubbled back up to the client&lt;/li&gt;
&lt;li&gt;null: a &lt;code&gt;COMMIT&lt;/code&gt; is executed, and the insertion of the data, now determined
to be valid, remains intact&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;Constraints, as expressions, are powerful. What&#39;s more powerful is that these
constraints, to validate input data, are pushed up out of the custom logic
layer, to the declarative layer, and the execution thereof is pushed down to
the database layer. This works for all databases supported by CAP, by the way.&lt;/p&gt;
&lt;p&gt;In today&#39;s era of assisted programming, and the ever increasing mountain of
generated code, this is a welcome relief, and &lt;a href=&quot;https://qmacro.org/blog/posts/2024/11/07/five-reasons-to-use-cap/#1-the-code-is-in-the-framework-not-outside-of-it&quot;&gt;exactly the orientation our
internal compass should be set
to&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;As it&#39;s essentially the same as the SQL equivalent, the &lt;code&gt;case&lt;/code&gt; expression
also has an optional final &lt;code&gt;else&lt;/code&gt; clause which is useful for defining a
fallback value.&lt;/li&gt;
&lt;li&gt;It&#39;s also because the detailed log message that&#39;s emitted in the context of
&lt;code&gt;cds watch&lt;/code&gt; is also slighly less forthcoming, due to the way JavaScript
tends to convey deep structures in an opaque way, i.e. as &lt;code&gt;[ Object ]&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;See the &lt;code&gt;json_tree&lt;/code&gt; table definition in section &lt;a href=&quot;https://sqlite.org/json1.html#table_valued_functions_for_parsing_json_json_each_jsonb_each_json_tree_and_jsonb_tree_&quot;&gt;4.23. Table valued
functions for parsing JSON: json_each(), jsonb_each(), json_tree(), and
jsonb_tree()
&lt;/a&gt;
of the SQLite documentation on JSON Functions and Operators.&lt;/li&gt;
&lt;/ol&gt;
</content>
  </entry>
  <entry>
    <title>Modules, modularity &amp; reuse in CDS models - part 4 - from passive to active with @capire/common</title>
    <link href="https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/" />
    <updated>2026-01-21T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/</id>
    <content type="html">&lt;p&gt;(Get to all the parts in this series via the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models/&quot;&gt;series
post&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;In the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/&quot;&gt;previous
part&lt;/a&gt;
we published &lt;code&gt;@qmacro/common&lt;/code&gt;. Let&#39;s start out here by creating a new simple
CAP Node.js project and bringing in that &lt;code&gt;@qmacro/common&lt;/code&gt; package; not only
will this show that we really do have a publicly available &amp;amp; shareable reuse
package, but observing what happens will also underline its simple and
&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#active-vs-passive&quot;&gt;passive&lt;/a&gt;
nature.&lt;/p&gt;
&lt;h2 id=&quot;creating-a-simple-host-project&quot;&gt;Creating a simple host project&lt;/h2&gt;
&lt;p&gt;Instead of turning back to the &amp;quot;host&amp;quot; CAP Node.js project that &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#creating-a-simple-cap-node-js-project&quot;&gt;we created in
part
1&lt;/a&gt;
with the &lt;code&gt;packages/@qmacro/common&lt;/code&gt; workspace, let&#39;s create a fresh host project
to have a clean context into which to bring each reuse module. First, let&#39;s set
up&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; &lt;code&gt;use-qmacro&lt;/code&gt; for
&lt;a href=&quot;https://github.com/qmacro/common&quot;&gt;qmacro/common&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds init &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--add&lt;/span&gt; tiny-sample &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  use-qmacro &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$_&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The CDS model artifacts in the &amp;quot;tiny-sample&amp;quot; facet are still simple enough,
which is what we want. Starting the server now (with &lt;code&gt;cds watch&lt;/code&gt;) will allow us
to see what happens (and, perhaps a little more telling, what does not happen)
in subsequent steps:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cat&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; connect to db &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; sqlite &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; url&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;:memory:&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; init from db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;my&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bookshop&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;Books&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csv
&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; successfully deployed to in&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;memory database&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Noteworthy here are the files which are being loaded for the CDS model, and the
initial data load from a CSV file that was found.&lt;/p&gt;
&lt;h2 id=&quot;qmacro-common&quot;&gt;@qmacro/common&lt;/h2&gt;
&lt;p&gt;It&#39;s now time to start exploring what it&#39;s like to actually use a reuse
package. We&#39;ll start here with &lt;code&gt;@qmacro/common&lt;/code&gt; and then later take a first
look at &lt;code&gt;@capire/common&lt;/code&gt;, so that we can compare what happens.&lt;/p&gt;
&lt;h3 id=&quot;adding-qmacro-common&quot;&gt;Adding @qmacro/common&lt;/h3&gt;
&lt;p&gt;In a second terminal session (so we can monitor the &lt;code&gt;cds watch&lt;/code&gt; output in the
first) let&#39;s install&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; the &lt;code&gt;@qmacro/common&lt;/code&gt; reuse
module:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; @qmacro/common&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This emits something like this&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;added &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; package&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; and audited &lt;span class=&quot;token number&quot;&gt;115&lt;/span&gt; packages in &lt;span class=&quot;token number&quot;&gt;858ms&lt;/span&gt;

found &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; vulnerabilities&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;More importantly, it causes the CAP server to restart. But so far, there are no
new log lines of interest - the same 3 files as before are loaded for the CDS
model, and the same single CSV file.&lt;/p&gt;
&lt;h3 id=&quot;using-qmacro-common&quot;&gt;Using @qmacro/common&lt;/h3&gt;
&lt;p&gt;Let&#39;s now make use of this simple passive reuse package by
importing&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt;, as a first step:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; qmacro &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;@qmacro/common&#39;; &lt;span class=&quot;token single-line-comment comment&quot;&gt;// &amp;lt;--&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;namespace&lt;/span&gt; my.bookshop;

&lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
  &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
      title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
      stock : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As soon as the file is saved with this new &lt;code&gt;using&lt;/code&gt; directive, the CAP server
restarts, and a new CDS file appears in the list of sources used to create the
CDS model:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cat&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;index&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It&#39;s the
&lt;a href=&quot;https://github.com/qmacro/common/blob/a6e2daea6f9805e1b44fa71deccbe5ac9a6a0333/index.cds&quot;&gt;index.cds&lt;/a&gt;
file that &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#creating-the-index-entry-point&quot;&gt;we created in part
2&lt;/a&gt;,
nice!&lt;/p&gt;
&lt;p&gt;We haven&#39;t made use of the &lt;code&gt;qmacro.common.T&lt;/code&gt; type yet, but the compiler still
loads the reuse package contents (whatever &lt;code&gt;index.cds&lt;/code&gt; contains and / or refers
to).&lt;/p&gt;
&lt;p&gt;But the important thing to observe with this &amp;quot;passive&amp;quot; reuse package is that
&lt;em&gt;it&#39;s only once we explicitly refer to it in our model definitions that
anything happens&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;To complete the test of this simple reuse package, we can of course add a
further element to the &lt;code&gt;Books&lt;/code&gt; entity definition like this, defined with this
imported type:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; qmacro &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;@qmacro/common&#39;;

&lt;span class=&quot;token keyword&quot;&gt;namespace&lt;/span&gt; my.bookshop;

&lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
  &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
      title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
      stock : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
      newel : qmacro.common.T; &lt;span class=&quot;token single-line-comment comment&quot;&gt;// &amp;lt;--&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;but this has no further effect on how the package is used or behaves.&lt;/p&gt;
&lt;p&gt;So far, so good! Let&#39;s now compare that with a first look at using
&lt;code&gt;@capire/common&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;creating-a-second-host-project&quot;&gt;Creating a second host project&lt;/h2&gt;
&lt;p&gt;To keep things clean and separate, let&#39;s now create a second host project just
like &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#creating-a-simple-host-project&quot;&gt;the first&lt;/a&gt;, this time called &lt;code&gt;use-capire&lt;/code&gt;,
and start up the CAP server straight after:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds init &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--add&lt;/span&gt; tiny-sample &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  use-capire &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$_&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cds &lt;span class=&quot;token function&quot;&gt;watch&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;If you&#39;re playing along at home, make sure you create this parallel to
&lt;code&gt;use-qmacro&lt;/code&gt;, not &lt;em&gt;within it&lt;/em&gt;, of course.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;From the &lt;code&gt;cds watch&lt;/code&gt; output, we see the same output as previously, at the same
stage, with &lt;code&gt;use-qmacro&lt;/code&gt;, most notably that the CDS model is composed of 3 files:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cat&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;capire-common&quot;&gt;@capire/common&lt;/h2&gt;
&lt;p&gt;In the same way as with &lt;code&gt;@qmacro/common&lt;/code&gt;, let&#39;s this time add &lt;code&gt;@capire/common&lt;/code&gt;
to the project.&lt;/p&gt;
&lt;h3 id=&quot;associating-the-scope-with-the-registry&quot;&gt;Associating the scope with the registry&lt;/h3&gt;
&lt;p&gt;Just like how we associated &lt;code&gt;@qmacro&lt;/code&gt; with the GitHub Packages NPM registry &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#associating-the-scope-with-the-registry&quot;&gt;in
the previous
part&lt;/a&gt;,
we&#39;ll need to do the same for &lt;code&gt;@capire&lt;/code&gt;, by adding another line to our
&lt;code&gt;~/.npmrc&lt;/code&gt; file&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;5&lt;/sup&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-ini&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ini&quot;&gt;&lt;span class=&quot;token key attr-name&quot;&gt;@capire:registry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;https://npm.pkg.github.com&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;adding-capire-common&quot;&gt;Adding @capire/common&lt;/h3&gt;
&lt;p&gt;Now we can add it:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; @capire/common&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We get similar output to this as before, but significantly, when the CAP server
restarts, we see this:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cat&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;index&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;regions&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;capire&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;currencies&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Waitwhat?&lt;/p&gt;
&lt;h3 id=&quot;active-vs-passive&quot;&gt;Active vs passive&lt;/h3&gt;
&lt;p&gt;What&#39;s going on? Where did they come from? Why are they appearing, even when we
haven&#39;t imported anything into the &lt;code&gt;use-capire&lt;/code&gt; model yet?&lt;/p&gt;
&lt;p&gt;This is our first glimpse of a side effect coming from the fact that -- unlike
&lt;code&gt;@qmacro/common&lt;/code&gt;, which is &lt;em&gt;passive&lt;/em&gt; -- &lt;code&gt;@capire/common&lt;/code&gt; is
&lt;em&gt;active&lt;/em&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/#footnotes&quot;&gt;&lt;sup&gt;6&lt;/sup&gt;&lt;/a&gt;. In other words, the reuse package will do
things, explicitly and sometimes immediately, as soon as we&#39;ve added it.&lt;/p&gt;
&lt;p&gt;How does that work? We&#39;ll find out in the next part!&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;While things would be fine without an &lt;code&gt;npm install&lt;/code&gt; at this setup stage
(using the globally installed &lt;code&gt;@sap/cds&lt;/code&gt; package rather than a project-local
one), we&#39;ll use &lt;code&gt;npm install&lt;/code&gt; here mostly for cosmetics - references in the
log output will be to project-local resources rather than global ones which
have far longer paths; also, we&#39;ll be running a package install shortly
anyway, so the main part of the install work might as well be done now.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Remember that you&#39;ll have to have the appropriate settings in an
&lt;a href=&quot;https://docs.npmjs.com/cli/v11/configuring-npm/npmrc&quot;&gt;npmrc&lt;/a&gt; file; see the
&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#preparing-to-publish-the-package&quot;&gt;Preparing to publish the
package&lt;/a&gt;
section of the previous part for a reminder about this. Basically, you&#39;ll
need something like this, say, in &lt;code&gt;~/.npmrc&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-ini&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ini&quot;&gt;&lt;span class=&quot;token key attr-name&quot;&gt;@qmacro:registry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;https://npm.pkg.github.com&lt;/span&gt;
&lt;span class=&quot;token key attr-name&quot;&gt;//npm.pkg.github.com/:_authToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;A-CLASSIC-TOKEN-WITH-AT-LEAST-READ-PACKAGES-SCOPE&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The use of the top level name only (i.e. just &lt;code&gt;qmacro&lt;/code&gt;) in the &lt;code&gt;using&lt;/code&gt;
directive is deliberate here, just to show a different way of referencing
the scope and subsequent use in definition positions. See the
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl#namespaces&quot;&gt;Namespaces&lt;/a&gt; section of
Capire&#39;s CDL topic for further details.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I have &lt;code&gt;fund=false&lt;/code&gt; in my &lt;code&gt;~/.npmrc&lt;/code&gt; file so the &amp;quot;... packages are looking
for funding ...&amp;quot; messages are suppressed.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There&#39;s an entire blog post on &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/21/modules-modularity-and-reuse-in-cds-models-part-4-from-passive-to-active-with-capire-common/blog/posts/2025/10/12/using-capire-modules-from-github-packages/&quot;&gt;Using @capire modules from GitHub
Packages&lt;/a&gt;,
in case you&#39;re interested.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The terms &amp;quot;active&amp;quot; and &amp;quot;passive&amp;quot; aren&#39;t official CAP terms, they&#39;re just
what I have come up wih to distinguish reuse package types.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content>
  </entry>
  <entry>
    <title>Modules, modularity &amp; reuse in CDS models - part 3 - publishing the simple reuse package</title>
    <link href="https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/" />
    <updated>2026-01-14T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/</id>
    <content type="html">&lt;p&gt;(Get to all the parts in this series via the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models/&quot;&gt;series
post&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;What we have from &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/&quot;&gt;part
2&lt;/a&gt;
is a simple project &lt;code&gt;myproj/&lt;/code&gt; which relies upon a simple reuse package
&lt;code&gt;@qmacro/common&lt;/code&gt;. That reuse package currently exists only within a workspace
within the &lt;code&gt;myproj/&lt;/code&gt; project. In order to be able to use it elsewhere and share
the reuse package with others, we need to publish it to a public NPM registry.&lt;/p&gt;
&lt;p&gt;One possibility would be the standard NPM registry at &lt;a href=&quot;https://www.npmjs.org&quot;&gt;https://www.npmjs.org&lt;/a&gt;.
Another is the NPM registry which is part of &lt;a href=&quot;https://docs.github.com/en/packages&quot;&gt;GitHub
Packages&lt;/a&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.
That&#39;s what I&#39;ll use here. It makes sense also to share the source too, which I
can do in parallel via a public repo in my &lt;a href=&quot;https://github.com/qmacro/&quot;&gt;user
space&lt;/a&gt; on GitHub, and I&#39;ll link the NPM package to
that repo as well.&lt;/p&gt;
&lt;p&gt;What we want to end up with is a setup that follows the
&lt;a href=&quot;https://github.com/capire/common&quot;&gt;capire/common&lt;/a&gt; repo and package:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/capire-common.png&quot; alt=&quot;The capire/common repo&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;sharing-the-reuse-package-source&quot;&gt;Sharing the reuse package source&lt;/h2&gt;
&lt;p&gt;First, let&#39;s share the source of &lt;code&gt;@qmacro/common&lt;/code&gt;. Clearly the content is not
earth-shattering, but serves to illustrate the pattern as a
passive&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; reuse package.&lt;/p&gt;
&lt;p&gt;As a reminder, here&#39;s what the entire project and workspace-enclosed reuse
package looks like (minus the &lt;code&gt;node_modules/&lt;/code&gt; directory, to keep things brief):&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package-lock.json&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â”œâ”€â”€ packages
â”‚   â””â”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro
â”‚       â””â”€â”€ common
â”‚           â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;index.cds&lt;/span&gt;
â”‚           â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;services.cds&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It&#39;s the content of &lt;code&gt;packages/@qmacro/common/&lt;/code&gt; that we want to share, and we
can do that in the normal way, by introducing git-based source code control,
then creating a repo on GitHub based on that git-controlled source.&lt;/p&gt;
&lt;p&gt;While we can also add the main &lt;code&gt;myproj/&lt;/code&gt; project source to git-based source
code control, we won&#39;t do that now. Whenever we do it, we also want to remember
to exclude the content in &lt;code&gt;packages/&lt;/code&gt; as we want to share and manage the
packages source lifecycle separately.&lt;/p&gt;
&lt;h3 id=&quot;moving-to-the-appropriate-place&quot;&gt;Moving to the appropriate place&lt;/h3&gt;
&lt;p&gt;So first of all, starting from within the main project&#39;s root, i.e. &lt;code&gt;myproj/&lt;/code&gt;,
let&#39;s move into the reuse package&#39;s directory:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; packages/@qmacro/common/&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;adding-a-readme&quot;&gt;Adding a README&lt;/h3&gt;
&lt;p&gt;Every public repo on GitHub should have a README, even one as simple as this.
Let&#39;s just add one now:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;EOF&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;README.md&lt;/span&gt;
# @qmacro/common

See the series post
[Modules, modularity &amp;amp; reuse in CDS models](https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models/)
for the background to this simple passive CDS model reuse package example.
EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;setting-up-the-repo&quot;&gt;Setting up the repo&lt;/h3&gt;
&lt;p&gt;Now, within &lt;code&gt;packages/@qmacro/common/&lt;/code&gt;, let&#39;s set up the git-based source code
control:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; init &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; commit &lt;span class=&quot;token parameter variable&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;initial commit&#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This emits:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;Initialized empty Git repository in myproj&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;packages&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;git&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;main &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;commit&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;37f0091&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; initial commit
 &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; files changed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;21&lt;/span&gt; insertions&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;
 create mode &lt;span class=&quot;token number&quot;&gt;100644&lt;/span&gt; README&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;md
 create mode &lt;span class=&quot;token number&quot;&gt;100644&lt;/span&gt; &lt;span class=&quot;token domain constant&quot;&gt;index.cds&lt;/span&gt;
 create mode &lt;span class=&quot;token number&quot;&gt;100644&lt;/span&gt; &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;pushing-the-repo-to-github&quot;&gt;Pushing the repo to GitHub&lt;/h3&gt;
&lt;p&gt;Now let&#39;s share this with others by pushing it to GitHub, specifically as &lt;a href=&quot;https://github.com/qmacro?tab=repositories&quot;&gt;a
new repo in my user space&lt;/a&gt;. I&#39;m a
&lt;a href=&quot;https://qmacro.org/tags/gh/&quot;&gt;happy user&lt;/a&gt; of the excellent GitHub CLI
&lt;a href=&quot;https://cli.github.com/&quot;&gt;gh&lt;/a&gt;, so let&#39;s use that
here&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gh repo create common &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--description&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Simple passive CDS model reuse package example&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--source&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--public&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--push&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This emits:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;âœ“ Created repository qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common on GitHub
âœ“ Added remote &lt;span class=&quot;token url&quot;&gt;https://github.com/qmacro/common.git&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;Enumerating objects:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;Counting objects:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Delta compression using up to &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; threads
&lt;span class=&quot;token property&quot;&gt;Compressing objects:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;Writing objects:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;686&lt;/span&gt; bytes &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;686.00&lt;/span&gt; KiB&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; done&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
Total &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;delta &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reused &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;delta &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pack&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;reused &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
To &lt;span class=&quot;token url&quot;&gt;https://github.com/qmacro/common.git&lt;/span&gt;
 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;new branch&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;      HEAD &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; main
branch &lt;span class=&quot;token string&quot;&gt;&#39;main&#39;&lt;/span&gt; set up to track &lt;span class=&quot;token string&quot;&gt;&#39;origin/main&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
âœ“ Pushed commits to &lt;span class=&quot;token url&quot;&gt;https://github.com/qmacro/common.git&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Et voila, the repo on GitHub is there.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/qmacro-common-no-package.png&quot; alt=&quot;the qmacro/common repo on
GitHub&quot;&gt;&lt;/p&gt;
&lt;p&gt;But there&#39;s no package ... yet.&lt;/p&gt;
&lt;h2 id=&quot;preparing-to-publish-the-package&quot;&gt;Preparing to publish the package&lt;/h2&gt;
&lt;p&gt;Let&#39;s do that now. First, there&#39;s some setup required for working with the NPM
registry in GitHub Packages.&lt;/p&gt;
&lt;h3 id=&quot;generating-a-token-for-authentication&quot;&gt;Generating a token for authentication&lt;/h3&gt;
&lt;p&gt;As the GitHub documentation article &lt;a href=&quot;https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry&quot;&gt;Working with the npm
registry&lt;/a&gt;
states:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;quot;You need an access token to publish, install, and delete private, internal,
and public packages.&amp;quot;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Heading over to the &lt;a href=&quot;https://github.com/settings/tokens&quot;&gt;Tokens (classic)&lt;/a&gt; area
of the GitHub Developer Settings, we should create a new classic token with the
following scopes:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/token-scopes.png&quot; alt=&quot;token scopes&quot;&gt;&lt;/p&gt;
&lt;p&gt;and will end up with something like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/classic-token-full-registry-access.png&quot; alt=&quot;classic token&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;associating-the-token-with-the-registry&quot;&gt;Associating the token with the registry&lt;/h3&gt;
&lt;p&gt;The value of the token can now be associated, in the
&lt;a href=&quot;https://docs.npmjs.com/cli/v11/configuring-npm/npmrc&quot;&gt;npmrc&lt;/a&gt;-based
configuration, with the NPM registry in GitHub Packages, which has the address
&lt;code&gt;npm.pkg.github.com&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;In an existing or new &lt;code&gt;.npmrc&lt;/code&gt; file in your home directory, we need to add
this:&lt;/p&gt;
&lt;pre class=&quot;language-ini&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ini&quot;&gt;&lt;span class=&quot;token key attr-name&quot;&gt;//npm.pkg.github.com/:_authToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;THE-TOKEN-JUST-GENERATED&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;For more on this, see the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/blog/posts/2025/10/12/using-capire-modules-from-github-packages/#associate-the-token-with-the-registry&quot;&gt;Associate the token with the
registry&lt;/a&gt;
section of the blog post &lt;a href=&quot;https://qmacro.org/blog/posts/2025/10/12/using-capire-modules-from-github-packages/&quot;&gt;Using @capire modules from GitHub
Packages&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;associating-the-scope-with-the-registry&quot;&gt;Associating the scope with the registry&lt;/h3&gt;
&lt;p&gt;Additionally we&#39;ll need to tell the &lt;code&gt;npm&lt;/code&gt; command line tool about how it should
use the GitHub Packages NPM registry, rather than the (default) NPM registry at
&lt;a href=&quot;https://www.npmjs.com&quot;&gt;https://www.npmjs.com&lt;/a&gt;, for &lt;code&gt;@qmacro&lt;/code&gt;-scoped packages.&lt;/p&gt;
&lt;p&gt;Details about this are also covered in the aforementioned blog post in the
section &lt;a href=&quot;https://qmacro.org/blog/posts/2025/10/12/using-capire-modules-from-github-packages/#namespace-registry-mapping-required&quot;&gt;Namespace registry mapping
required&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In that same &lt;code&gt;~/.npmrc&lt;/code&gt; file, we need to add this too:&lt;/p&gt;
&lt;pre class=&quot;language-ini&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ini&quot;&gt;&lt;span class=&quot;token key attr-name&quot;&gt;@qmacro:registry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;https://npm.pkg.github.com&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;associate-the-repo-with-the-package&quot;&gt;Associate the repo with the package&lt;/h2&gt;
&lt;p&gt;While one can register packages in the NPM registry on GitHub Packages that are
independent of any source repo on GitHub, it makes a lot of sense to have both
and have them linked. That way, one can go from the repo source to the package,
and from the package back to the repo source.&lt;/p&gt;
&lt;p&gt;All that&#39;s needed to make this association is a &lt;code&gt;repository&lt;/code&gt; property in the
&lt;code&gt;package.json&lt;/code&gt; file. So let&#39;s add that, and commit &amp;amp; push the change to GitHub.
Here&#39;s the entire contents of the &lt;code&gt;package.json&lt;/code&gt; file with that new
&lt;code&gt;repository&lt;/code&gt; property&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/14/modules-modularity-and-reuse-in-cds-models-part-3-publishing-the-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt; added:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@qmacro/common&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;repository&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;git&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;git+https://github.com/qmacro/common.git&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;index.js&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;devDependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;echo &#92;&quot;Error: no test specified&#92;&quot; &amp;amp;&amp;amp; exit 1&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;keywords&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;author&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;license&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ISC&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After committing this change and pushing it to the remote on GitHub:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; package.json &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; commit &lt;span class=&quot;token parameter variable&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;add repository property&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; push&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we&#39;re ready to actually publish the package!&lt;/p&gt;
&lt;h2 id=&quot;publishing-the-package&quot;&gt;Publishing the package&lt;/h2&gt;
&lt;p&gt;After all that preparation, our &lt;code&gt;~/.npmrc&lt;/code&gt; contents in place:&lt;/p&gt;
&lt;pre class=&quot;language-ini&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ini&quot;&gt;&lt;span class=&quot;token key attr-name&quot;&gt;@qmacro:registry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;https://npm.pkg.github.com&lt;/span&gt;
&lt;span class=&quot;token key attr-name&quot;&gt;//npm.pkg.github.com/:_authToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token value attr-value&quot;&gt;ghp_...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we&#39;re all set, and the process is simple:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; publish&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This emits output similar to the following:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;npm notice
npm notice ðŸ“¦  &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1.0.0&lt;/span&gt;
npm notice Tarball Contents
npm notice &lt;span class=&quot;token number&quot;&gt;243B&lt;/span&gt; README&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;md
npm notice &lt;span class=&quot;token number&quot;&gt;44B&lt;/span&gt; &lt;span class=&quot;token domain constant&quot;&gt;index.cds&lt;/span&gt;
npm notice &lt;span class=&quot;token number&quot;&gt;349B&lt;/span&gt; &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
npm notice Tarball Details
&lt;span class=&quot;token property&quot;&gt;npm notice name:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common
&lt;span class=&quot;token property&quot;&gt;npm notice version:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1.0.0&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;npm notice filename:&lt;/span&gt; qmacro&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tgz
&lt;span class=&quot;token property&quot;&gt;npm notice package size:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;528&lt;/span&gt; B
&lt;span class=&quot;token property&quot;&gt;npm notice unpacked size:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;636&lt;/span&gt; B
&lt;span class=&quot;token property&quot;&gt;npm notice shasum:&lt;/span&gt; d6b369d2e3db3878df8f9d9745b393f68a18b18b
&lt;span class=&quot;token property&quot;&gt;npm notice integrity:&lt;/span&gt; sha512&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;Anr74Mjy9kRvb&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;RkUg3wgpto8UA&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;npm notice total files:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;
npm notice
npm notice Publishing to &lt;span class=&quot;token url&quot;&gt;https://npm.pkg.github.com&lt;/span&gt; with tag latest and default access
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1.0.0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which denotes success.&lt;/p&gt;
&lt;h2 id=&quot;examining-the-results&quot;&gt;Examining the results&lt;/h2&gt;
&lt;p&gt;Indeed, we can now see a package associated with the &lt;code&gt;qmacro/common&lt;/code&gt; repo:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/qmacro-common-package-associated.png&quot; alt=&quot;qmacro/common package
associated&quot;&gt;&lt;/p&gt;
&lt;p&gt;and following that package link to the &lt;a href=&quot;https://github.com/qmacro/common/pkgs/npm/common&quot;&gt;package
page&lt;/a&gt;, we see:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/qmacro-common-package-info.png&quot; alt=&quot;qmacro/common package info&quot;&gt;&lt;/p&gt;
&lt;p&gt;which indeed also has a link (via the README) back to the
&lt;a href=&quot;https://github.com/qmacro/common&quot;&gt;repo&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;making-the-package-public&quot;&gt;Making the package public&lt;/h2&gt;
&lt;p&gt;As described in the &lt;a href=&quot;https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry#publishing-a-package&quot;&gt;Publishing a
package&lt;/a&gt;
section of &lt;a href=&quot;https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry&quot;&gt;Working with the npm
registry&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;quot;When you first publish a package, the default visibility is private.&amp;quot;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So in order for you to try this out, let&#39;s take one final step in this post,
and change the visibility to public.&lt;/p&gt;
&lt;p&gt;This is also simple and can be done via the package settings:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/changing-package-visibility-to-public.png&quot; alt=&quot;changing package visibility to
public&quot;&gt;&lt;/p&gt;
&lt;p&gt;And that&#39;s it!&lt;/p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;All that&#39;s left for this post is for you to try the package out, by &lt;code&gt;npm add&lt;/code&gt;ing it to a CAP Node.js project. Let me know in the comments if it works
for you.&lt;/p&gt;
&lt;p&gt;Now that we understand the basics of a CDS model reuse package, in the next
post we&#39;ll start to take a closer look at
&lt;a href=&quot;https://github.com/capire/common&quot;&gt;capire/common&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;There are multiple registries in GitHub Packages - for Docker, Apache Maven,
RubyGems and more, as well as for Node.js packages.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There&#39;s that
&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#active-vs-passive&quot;&gt;passive&lt;/a&gt;
word again. I&#39;ll get to explaining what I mean by it at some point in this
series, honest!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If you&#39;re not yet familiar with the command line tool options, you can
invoke just &lt;code&gt;gh repo create&lt;/code&gt; and follow the interactive prompts instead,
which start like this:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; What would you like to do&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Use arrows to move&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; type to filter&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; Create a new repository on GitHub from scratch
  Push an existing local repository to GitHub&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;While a simpler string value like this:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;&quot;repository&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://github.com/qmacro/common&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;will work (similar to &lt;a href=&quot;https://github.com/capire/common/blob/6fe89fb51a6b06cf65d18f6d66ef880545a9054f/package.json#L4&quot;&gt;how it&#39;s defined for
capire/common&lt;/a&gt;),
&lt;code&gt;npm publish&lt;/code&gt; will emit a warning like this:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;npm warn publish npm auto&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;corrected some errors in your &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt; when publishing&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;  Please run &lt;span class=&quot;token string&quot;&gt;&quot;npm pkg fix&quot;&lt;/span&gt; to address these errors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;npm warn publish errors corrected:&lt;/span&gt;
npm warn publish &lt;span class=&quot;token string&quot;&gt;&quot;repository&quot;&lt;/span&gt; was changed from a string to an object
npm warn publish &lt;span class=&quot;token string&quot;&gt;&quot;repository.url&quot;&lt;/span&gt; was normalized to &lt;span class=&quot;token string&quot;&gt;&quot;git+https://github.com/qmacro/common.git&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content>
  </entry>
  <entry>
    <title>Modules, modularity &amp; reuse in CDS models - part 2 - creating a simple reuse package</title>
    <link href="https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/" />
    <updated>2026-01-07T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/</id>
    <content type="html">&lt;p&gt;(Get to all the parts in this series via the &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models/&quot;&gt;series post&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;In &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#wrapping-up&quot;&gt;wrapping up the end of part
1&lt;/a&gt;
we looked forward to creating the simplest kind of reuse module, not only as an
important fundamental building block but as a base for further understanding
and exploration (especially when we start looking closer at
&lt;a href=&quot;https://github.com/capire/common&quot;&gt;capire/common&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;What we&#39;ll do in this post is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;create a simple CAP Node.js project with a basic CDS model&lt;/li&gt;
&lt;li&gt;extend it by defining a custom type in a separate file, and using that type&lt;/li&gt;
&lt;li&gt;make that custom type definition reusable by creating an NPM package and putting it there instead&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Following best practice &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES002.md&quot;&gt;BES002 Think
local-first&lt;/a&gt;
we&#39;ll create and build out that NPM package locally, for the ultimate in
development iteration and &lt;a href=&quot;https://cap.cloud.sap/docs/about/#fast-inner-loops&quot;&gt;fast inner
loops&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;creating-a-simple-cap-node-js-project&quot;&gt;Creating a simple CAP Node.js project&lt;/h2&gt;
&lt;p&gt;For simplicity&#39;s sake, and to highlight the even more basic alternative
approach (to using &lt;code&gt;cds init&lt;/code&gt;) to create a new CAP Node.js project, we&#39;ll use
the NPM command line tool &lt;code&gt;npm&lt;/code&gt; as demonstrated by Daniel Schlachter in our &lt;a href=&quot;https://youtu.be/fUYNjuQbLzQ?si=7GyAUdnrAsUaTmlF&amp;amp;t=354&quot;&gt;Expert
Session: Getting started with CAP Node.js - 2025/2026
edition!&lt;/a&gt;. After all,
this post is ultimately all about Node.js packages.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://youtu.be/fUYNjuQbLzQ?si=7GyAUdnrAsUaTmlF&amp;amp;t=354&quot;&gt;&lt;img src=&quot;https://qmacro.org/images/2026/01/daniel-schlachter-from-scratch.png&quot; alt=&quot;Daniel uses npm init -y to start a new CAP Node.js project from
scratch&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Here goes:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; myproj &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$_&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; init &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; @sap/cds express &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; --save-dev @cap-js/sqlite&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This creates everything we need for starting to develop a CAP Node.js project.
Firing things up with &lt;code&gt;cds watch&lt;/code&gt; gives us:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;cds serve all &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;with&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;mocks &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;in&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;memory&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt; live reload enabled for browsers &lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;
        ___________________________

    No models found in db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;app&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;app&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;services&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
    Waiting for some to arrive&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;All subsequent command line invocations in this post are from the same
location as this, i.e. at the project root, in &lt;code&gt;myproj/&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;adding-a-simple-cds-model&quot;&gt;Adding a simple CDS model&lt;/h2&gt;
&lt;p&gt;To keep things as simple as possible and not distract us from the goal, let&#39;s
define the CDS model in &lt;code&gt;services.cds&lt;/code&gt; as something minimal:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; schema {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        e  : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; S {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; schema.E;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For those wondering about the starkness, here are a few notes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;In minimal scenarios like this, I like to have everything in one file, and my
choice of &lt;code&gt;services.cds&lt;/code&gt; is explained in &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/&quot;&gt;Why I use services.cds in simple
CDS model
examples&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Because everything is in one file, I can either define an entity directly
within a service, &amp;quot;in-flight&amp;quot; as it were, like this:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; Bookshop {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
        stock : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(this is from my &lt;code&gt;cdsnano&lt;/code&gt;
&lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano-template/services.cds&quot;&gt;template&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;but I have come to
&lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdspico&quot;&gt;prefer&lt;/a&gt; using
the &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl#context&quot;&gt;context&lt;/a&gt; directive; that
way, I can make use of
&lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl#views-projections&quot;&gt;projections&lt;/a&gt; as the
projection target is in a separate namespace (scope).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Even simpler than the Bookshop or Northwind theme, I am using single letters,
while still following the &lt;a href=&quot;https://cap.cloud.sap/docs/guides/domain-modeling#naming-conventions&quot;&gt;naming convention
rules&lt;/a&gt;
on capitalisation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;entity &lt;code&gt;E&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;element &lt;code&gt;e&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;service &lt;code&gt;S&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I chose &lt;code&gt;schema&lt;/code&gt; as the namespace, mostly because it reminds me of the name
of the first file I usually create in a &lt;code&gt;db/&lt;/code&gt; directory when modelling:
&lt;code&gt;schema.cds&lt;/code&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;With the definitions in &lt;code&gt;services.cds&lt;/code&gt;, we&#39;re up and running with a full
service (some log lines omitted for brevity):&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; loaded model from &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; file&lt;span class=&quot;token operator&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;

  &lt;span class=&quot;token domain constant&quot;&gt;services.cds&lt;/span&gt;
  node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;cds&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;outbox&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cds

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; serving S &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;at:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;/odata/v4/s&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;decl:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;services.cds:8&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;impl:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;node_modules/@sap/cds/srv/app-service.js&#39;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cds&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; server listening on &lt;span class=&quot;token operator&quot;&gt;{&lt;/span&gt; url&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;http://localhost:4004&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now let&#39;s start to extend that model a little.&lt;/p&gt;
&lt;h2 id=&quot;extending-with-a-separate-file-in-the-project&quot;&gt;Extending with a separate file in the project&lt;/h2&gt;
&lt;p&gt;For the sake of illustration, let&#39;s say we have a custom type that we want to
use in this model. We can take the smallest first step in the direction of a
couple of best practices:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES005.md&quot;&gt;BES005 Factor out separate
concerns&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES006.md&quot;&gt;BES006 Compose with reuse in
mind&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;by factoring that type out into a separate file, and then importing it into our
main model file &lt;code&gt;services.cds&lt;/code&gt; with the &lt;code&gt;using&lt;/code&gt; directive.&lt;/p&gt;
&lt;h3 id=&quot;a-simple-type-t&quot;&gt;A simple type T&lt;/h3&gt;
&lt;p&gt;In a new file &lt;code&gt;base.cds&lt;/code&gt;, also at the project root alongside &lt;code&gt;services.cds&lt;/code&gt;,
let&#39;s define the type:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token cqlkeywords keyword&quot;&gt;type&lt;/span&gt; T : &lt;span class=&quot;token type builtin&quot;&gt;Boolean&lt;/span&gt;;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And in &lt;code&gt;services.cds&lt;/code&gt; let&#39;s use that to redefine the element &lt;code&gt;e&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; T &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;./base&#39;;

&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; schema {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        e  : T;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; S {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; schema.E;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So far so good.&lt;/p&gt;
&lt;h3 id=&quot;namespaces-are-a-good-idea&quot;&gt;Namespaces are a good idea&lt;/h3&gt;
&lt;p&gt;But that simple name &lt;code&gt;T&lt;/code&gt; makes me a little nervous in that it&#39;s unscoped, i.e.
at the equivalent of the global level, and this sort of practice is asking for
trouble down the line with name clashes. So let&#39;s put this definition for &lt;code&gt;T&lt;/code&gt;
into a scope with the &lt;code&gt;namespace&lt;/code&gt; directive; that way, we can more readily
reuse and share it.&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;base.cds&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;namespace&lt;/span&gt; qmacro.common;

&lt;span class=&quot;token cqlkeywords keyword&quot;&gt;type&lt;/span&gt; T : &lt;span class=&quot;token type builtin&quot;&gt;Boolean&lt;/span&gt;;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In &lt;code&gt;services.cds&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; qmacro.common.T &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;./base&#39;;

&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; schema {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        e  : T;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; S {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; schema.E;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That&#39;s better!&lt;/p&gt;
&lt;p&gt;Everything works well, and I can add to the &lt;code&gt;base.cds&lt;/code&gt; file and use the
definitions therein as I build out the rest of the CDS model for the current
project.&lt;/p&gt;
&lt;p&gt;But one thing I cannot do is easily reuse those definitions in other projects.&lt;/p&gt;
&lt;h2 id=&quot;extending-via-an-npm-package&quot;&gt;Extending via an NPM package&lt;/h2&gt;
&lt;p&gt;To remedy this, I can transfer what I have in &lt;code&gt;base.cds&lt;/code&gt; to a new NPM package,
and use that. That way, I not only get to reuse the definitions in the current
project but I can also:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;maintain it independently, in its own lifecycle&lt;/li&gt;
&lt;li&gt;use it in other projects I&#39;m working on&lt;/li&gt;
&lt;li&gt;make it available for others to use in their projects&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Just like &lt;a href=&quot;https://github.com/capire/common&quot;&gt;capire/common&lt;/a&gt;, in fact! But much,
much simpler&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;creating-the-package-locally&quot;&gt;Creating the package locally&lt;/h3&gt;
&lt;p&gt;Best practice &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES002.md&quot;&gt;BES002 Think
local-first&lt;/a&gt;
exhorts us to take a local-first approach to development. That goes not only
for CAP components, but in general. And with NPM&#39;s
&lt;a href=&quot;https://docs.npmjs.com/cli/v11/using-npm/workspaces&quot;&gt;workspaces&lt;/a&gt; concept, we
can follow this best practice in building out our reuse package too.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;See the &lt;a href=&quot;https://qmacro.org/blog/posts/2025/02/14/tasc-notes-part-8/#local-development-submodules-and-workspaces&quot;&gt;Local development, submodules and
workspaces&lt;/a&gt;
section of the notes accompanying part 8 of &lt;a href=&quot;https://qmacro.org/blog/posts/2024/12/06/the-art-and-science-of-cap/&quot;&gt;The Art and Science of
CAP&lt;/a&gt;
for more on this.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;deciding-on-a-scope-and-a-name&quot;&gt;Deciding on a scope and a name&lt;/h4&gt;
&lt;p&gt;Like the namespace we added to the definition in &lt;code&gt;base.cds&lt;/code&gt;
&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#namespaces-are-a-good-idea&quot;&gt;earlier&lt;/a&gt;, it&#39;s also a good idea to think about a
scope for the package (in the same way that
&lt;a href=&quot;https://www.npmjs.com/search?q=%40sap&quot;&gt;@sap&lt;/a&gt;,
&lt;a href=&quot;https://www.npmjs.com/search?q=%40cap-js&quot;&gt;@cap-js&lt;/a&gt; and
&lt;a href=&quot;https://github.com/orgs/capire/packages&quot;&gt;@capire&lt;/a&gt; exist). It would make sense
to eventually publish it, and GitHub Packages&#39; NPM registry seems a good
bet.&lt;/p&gt;
&lt;p&gt;So let&#39;s go for &lt;code&gt;qmacro&lt;/code&gt; as the scope, and &lt;code&gt;common&lt;/code&gt; as the package name&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;setting-up-and-examining-the-workspace-constructs&quot;&gt;Setting up and examining the workspace constructs&lt;/h4&gt;
&lt;p&gt;Previously, in the &lt;a href=&quot;https://qmacro.org/blog/posts/2024/12/30/cap-node-js-plugins/&quot;&gt;CAP Node.js
Plugins&lt;/a&gt; mini
series, we set up a workspace in the &lt;a href=&quot;https://qmacro.org/blog/posts/2024/10/05/cap-node-js-plugins-part-1-how-things-work/#creating-our-own-plugin-package&quot;&gt;Creating our own plugin
package&lt;/a&gt;
section of part 1. We&#39;ll take a similar approach now, taking care to specify
our chosen scope this time:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; init &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--yes&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--workspace&lt;/span&gt; packages/@qmacro/common &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;
  &lt;span class=&quot;token parameter variable&quot;&gt;--scope&lt;/span&gt; @qmacro&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Running this command does quite a few things. Let&#39;s look at (a cut down version
of) the project&#39;s structure as a result of this:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”œâ”€â”€ node_modules&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚   â”œâ”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;cap&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;js&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚   â”‚   â””â”€â”€ &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
â”‚   â”œâ”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚   â”‚   â””â”€â”€ common &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;packages&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
â”‚   â”œâ”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;sap&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;                                          &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
â”‚   â”‚       â””â”€â”€ &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;                                    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package-lock.json&lt;/span&gt;                                  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;                                       &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
â”œâ”€â”€ packages&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;      &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token separator comment&quot;&gt;-----------------------------------&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
â”‚   â””â”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚       â””â”€â”€ common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚           â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;base.cds&lt;/span&gt;
â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;services.cds&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What can we see? Well:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;There&#39;s a new &lt;code&gt;packages/&lt;/code&gt; directory in the project root; the name that we
chose (via the value for the &lt;code&gt;--workspace&lt;/code&gt; option) makes sense, given it&#39;s a
container for the NPM package we&#39;re going to create&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;That NPM package is represented locally within this new &lt;code&gt;packages/&lt;/code&gt;
directory, and currently contains just a simple &lt;code&gt;package.json&lt;/code&gt; file with
defaults (as we used &lt;code&gt;--yes&lt;/code&gt; to skip the package initialisation
questionnaire):&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@qmacro/common&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;index.js&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;devDependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;echo &#92;&quot;Error: no test specified&#92;&quot; &amp;amp;&amp;amp; exit 1&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;keywords&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;author&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;license&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ISC&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Because of the &lt;code&gt;--scoped @qmacro&lt;/code&gt; option, this is a scoped package&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Additionally:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Within the standard NPM package location for the project, i.e. the
&lt;code&gt;node_modules/&lt;/code&gt; directory, there&#39;s a new path &lt;code&gt;@qmacro/common&lt;/code&gt; that has been
created as a symbolic link to the NPM package within &lt;code&gt;packages/&lt;/code&gt;, as
illustrated by the arrow; this means that we can work on developing the
package locally within &lt;code&gt;packages/@qmacro/common/&lt;/code&gt; and use it immediately in
the context of our project.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And if we look inside the project&#39;s &lt;code&gt;package.json&lt;/code&gt; file, we&#39;ll see:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;there&#39;s a new top level &lt;code&gt;workspaces&lt;/code&gt; property which has a reference to this
local NPM package directory:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;myproj&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;...&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;workspaces&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;packages/@qmacro/common&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is a key component in the mechanism that allows a simplified use of
locally existing NPM packages within a project, &lt;a href=&quot;https://www.clivebanks.co.uk/THHGTTG/THHGTTGradio2.htm#:~:text=The%20Infinite%20Improbability%20Drive%20is%20a%20wonderful%20new%20method%20of%20crossing%20interstellar%20distances%20in%20a%20few%20seconds%2C%20without%20all%20that%20tedious%20mucking%20about%20in%20hyperspace&quot;&gt;without all that tedious
mucking about
with&lt;/a&gt;
&lt;code&gt;npm link&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;adding-the-package-as-a-project-dependency&quot;&gt;Adding the package as a project dependency&lt;/h4&gt;
&lt;p&gt;There&#39;s one more thing we should do now, but let&#39;s &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#adding-the-package-as-a-dependency&quot;&gt;defer it to the end of
this post&lt;/a&gt;, which will allow me to
illustrate some local behaviours.&lt;/p&gt;
&lt;h3 id=&quot;transferring-the-type-definition&quot;&gt;Transferring the type definition&lt;/h3&gt;
&lt;p&gt;Now that we have the NPM package, let&#39;s move the contents of &lt;code&gt;base.cds&lt;/code&gt; to it,
and also make a corresponding modification to the reference to it.&lt;/p&gt;
&lt;h4 id=&quot;moving-the-definition&quot;&gt;Moving the definition&lt;/h4&gt;
&lt;p&gt;The simplest first step is to move &lt;code&gt;base.cds&lt;/code&gt; from where it is in the project
root to the root of the &lt;code&gt;@qmacro/common&lt;/code&gt; package, i.e. to
&lt;code&gt;packages/@qmacro/common/&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;mv&lt;/span&gt; base.cds packages/@qmacro/common/&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point, the structure for our project and our new local package looks
like this (the &lt;code&gt;node_modules/&lt;/code&gt; directory content has been omitted here for
brevity):&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package-lock.json&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â”œâ”€â”€ packages&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚   â””â”€â”€ &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt;qmacro&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚       â””â”€â”€ common&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”‚           â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;base.cds&lt;/span&gt;
â”‚           â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â””â”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;services.cds&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;changing-the-using-directive&quot;&gt;Changing the using directive&lt;/h4&gt;
&lt;p&gt;Next up we should modify the reference in &lt;code&gt;services.cds&lt;/code&gt;. Instead of loading
&lt;code&gt;qmacro.common.T&lt;/code&gt; from &lt;code&gt;./base&lt;/code&gt;, i.e. the &lt;code&gt;base.cds&lt;/code&gt; file that was in the
project root, we&#39;ll want to load it from the &lt;code&gt;@qmacro/common&lt;/code&gt; package. This is
what we need to change &lt;code&gt;services.cds&lt;/code&gt; to (just the &lt;code&gt;using&lt;/code&gt; line has changed
here):&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; qmacro.common.T &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;@qmacro/common&#39;;

&lt;span class=&quot;token keyword&quot;&gt;context&lt;/span&gt; schema {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        e  : T;
  }
}

&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; S {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; E &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token cdl-keyword keyword&quot;&gt;projection&lt;/span&gt; &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;on&lt;/span&gt; schema.E;
}&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;understanding-model-resolution&quot;&gt;Understanding model resolution&lt;/h4&gt;
&lt;p&gt;At this point, if you&#39;re using a decent editor with LSP support connected to an
instance of the CDS language server&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#footnotes&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt;, you&#39;ll likely
see a diagnostics error:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;Can&#39;t find package module &lt;span class=&quot;token string&quot;&gt;&#39;@qmacro/common&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;file&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;unknown&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;package&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can also elicit this error report by simply attempting to compile the
contents of &lt;code&gt;services.cds&lt;/code&gt; to CSN, like this, for example:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds compile services.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This error occurs &lt;em&gt;not&lt;/em&gt; because the local setup of the NPM package is somehow
not right. It&#39;s because of the way &lt;a href=&quot;https://cap.cloud.sap/docs/cds/cdl#model-resolution&quot;&gt;model
resolution&lt;/a&gt; works:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Resolving module references: Names starting with neither &lt;code&gt;.&lt;/code&gt; nor &lt;code&gt;/&lt;/code&gt; such as
&lt;code&gt;@sap/cds/common&lt;/code&gt; are fetched for in &lt;code&gt;node_modules&lt;/code&gt; folders:&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Files having &lt;code&gt;.cds&lt;/code&gt;, &lt;code&gt;.csn&lt;/code&gt;, or &lt;code&gt;.json&lt;/code&gt; as suffixes, appended in order&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Folders, from either the file set in &lt;code&gt;cds.main&lt;/code&gt; in the folder&#39;s
&lt;code&gt;package.json&lt;/code&gt; or &lt;code&gt;index.&amp;lt;cds|csn|json&amp;gt;&lt;/code&gt; file.&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;In other words, we either need to use an &amp;quot;index&amp;quot; file, or add configuration to
the NPM package&#39;s &lt;code&gt;package.json&lt;/code&gt; file to point to the actual file in there,
i.e. &lt;code&gt;base.cds&lt;/code&gt;; that &lt;code&gt;cds.main&lt;/code&gt; configuration in &lt;code&gt;package.json&lt;/code&gt; would look
like this:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@qmacro/common&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;index.js&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;devDependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;echo &#92;&quot;Error: no test specified&#92;&quot; &amp;amp;&amp;amp; exit 1&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;keywords&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;author&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;license&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ISC&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;cds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;base&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With this in place, the reference in&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token using keyword&quot;&gt;using&lt;/span&gt; qmacro.common.T &lt;span class=&quot;token from keyword&quot;&gt;from&lt;/span&gt; &#39;@qmacro/common&#39;;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;works fine and the error goes away.&lt;/p&gt;
&lt;p&gt;However, while it works, adding explicit configuration like this goes against
axiom &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/axioms/AXI003.md&quot;&gt;AX003 Convention over
configuration&lt;/a&gt;. So
let&#39;s not do that.&lt;/p&gt;
&lt;p&gt;Moreover, it&#39;s actually good practice to use an &amp;quot;index&amp;quot; file (in the form of
&lt;code&gt;index.cds&lt;/code&gt;) as the entry point for reuse packages such as this one that we&#39;re
creating - see &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES007.md&quot;&gt;BES007 Provide public entry points to reuse
packages&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;creating-the-index-entry-point&quot;&gt;Creating the index entry point&lt;/h4&gt;
&lt;p&gt;So let&#39;s avoid any explicit &lt;code&gt;cds.main&lt;/code&gt; configuration, and create an &lt;code&gt;index.cds&lt;/code&gt;
file in the package root. The simplest thing would be to rename &lt;code&gt;base.cds&lt;/code&gt;, so
that&#39;s what we&#39;ll do:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;mv&lt;/span&gt; packages/@qmacro/common/base.cds packages/@qmacro/common/index.cds&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Nice!&lt;/p&gt;
&lt;h3 id=&quot;adding-the-package-as-a-dependency&quot;&gt;Adding the package as a dependency&lt;/h3&gt;
&lt;p&gt;There&#39;s one more thing we need to do, &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/07/modules-modularity-and-reuse-in-cds-models-part-2-creating-a-simple-reuse-package/#adding-the-package-as-a-project-dependency&quot;&gt;something which we deliberately deferred
until now&lt;/a&gt;, which is to add the
&lt;code&gt;@qmacro/common&lt;/code&gt; reuse package as a project dependency.&lt;/p&gt;
&lt;p&gt;Yes, everything works as we expect right now, but that&#39;s down to the NPM
workspace concept. We have our project, and the workspace-hosted reuse package,
which is accessible from the project. But what happens when we deploy that
project elsewhere? The workspace-based development is just that - for
development. So we need to ensure that our reuse package is brought in when
setting up the project elsewhere.&lt;/p&gt;
&lt;p&gt;Invoking:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; @qmacro/common&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;is all we need to do.&lt;/p&gt;
&lt;p&gt;This adds a reference to the package in the project&#39;s &lt;code&gt;dependencies&lt;/code&gt; property:&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;myproj&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;index.js&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;scripts&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;echo &#92;&quot;Error: no test specified&#92;&quot; &amp;amp;&amp;amp; exit 1&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;keywords&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;author&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;license&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ISC&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;description&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;dependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;@qmacro/common&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;^1.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;@sap/cds&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;^9.6.1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;express&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;^4.22.1&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;devDependencies&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;@cap-js/sqlite&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;^2.1.2&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;workspaces&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;packages/@qmacro/common&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;At this point, we&#39;re all set, and we can continue to build out our project, and our reuse package, locally.&lt;/p&gt;
&lt;p&gt;In the next part we&#39;ll move beyond local development for the reuse package, and make it available publicly in the NPM registry within GitHub Packages.&lt;/p&gt;
&lt;p&gt;Thanks for reading!&lt;/p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;schema.cds&lt;/code&gt; is also &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/&quot;&gt;one of the CDS roots&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;And &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/01/modules-modularity-and-reuse-in-cds-models-part-1-an-introduction/#active-vs-passive&quot;&gt;passive, rather than active&lt;/a&gt; - more on that another time.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;In fact, for a package to be hosted in the NPM registry within GitHub Packages, the scope inevitably is required and comes from the corresponding user or org name on GitHub. My user name on GitHub is &lt;code&gt;qmacro&lt;/code&gt;. See &lt;a href=&quot;https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry&quot;&gt;Working with the npm registry&lt;/a&gt; for more details on this relationship.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If you&#39;re using the SAP Business Application Studio, or VS Code with the &lt;a href=&quot;https://marketplace.visualstudio.com/items?itemName=SAPSE.vscode-cds&quot;&gt;SAP CDS Language Support&lt;/a&gt; extension, you&#39;ll have this already; if you want to set up Neovim to use the language server, see &lt;a href=&quot;https://qmacro.org/blog/posts/2025/06/10/a-modern-and-clean-neovim-setup-for-cap-node-js-configuration-and-diagnostics/&quot;&gt;A modern and clean Neovim setup for CAP Node.js - configuration and diagnostics&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content>
  </entry>
  <entry>
    <title>Why I use services.cds in simple CDS model examples</title>
    <link href="https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/" />
    <updated>2026-01-02T00:00:00Z</updated>
    <id>https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/</id>
    <content type="html">&lt;p&gt;I&#39;m writing this short post so I can refer to it when I want to explain my use
of &lt;code&gt;services.cds&lt;/code&gt; when creating sample CDS models. I&#39;ve found myself explaining
multiple times across various blog posts&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/#footnotes&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; so I thought
it was time to fix that behaviour and write it once (more) and point to it.&lt;/p&gt;
&lt;p&gt;One of the axioms in CAP is &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/axioms/AXI003.md&quot;&gt;AXI003 Convention over
configuration&lt;/a&gt;.
And when we follow best practice &lt;a href=&quot;https://github.com/qmacro/capref/blob/main/bestpractices/BES003.md&quot;&gt;BES003 Work in harmony with the
framework&lt;/a&gt;,
we exhert less effort, create fewer surprises for ourselves and others, and
things Just Work(tm).&lt;/p&gt;
&lt;p&gt;The &amp;quot;CDS roots&amp;quot; is one example of convention over configuration in action.
These roots are the pre-defined default locations that the CAP server will
search for CDS model definitions. You may know of the some of the roots
indirectly from the standard CAP Node.js directory structure scaffolded for you
with &lt;code&gt;cds init&lt;/code&gt; - the &lt;code&gt;app/&lt;/code&gt;, &lt;code&gt;srv/&lt;/code&gt; and &lt;code&gt;db/&lt;/code&gt; directories:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
â”œâ”€â”€ README&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;md
â”œâ”€â”€ app&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”œâ”€â”€ db&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;eslint.config.mjs&lt;/span&gt;
â”œâ”€â”€ &lt;span class=&quot;token domain constant&quot;&gt;package.json&lt;/span&gt;
â””â”€â”€ srv&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In addition to these three directories, there are a couple of files too that
are part of this pre-defined set: &lt;code&gt;schema.cds&lt;/code&gt; and
&lt;code&gt;services.cds&lt;/code&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/#footnotes&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We can ask to see these CDS roots like this:&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cds &lt;span class=&quot;token function&quot;&gt;env&lt;/span&gt; roots&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and we&#39;ll get&lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/#footnotes&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-log&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-log&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;db/&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;srv/&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;app/&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;schema&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;services&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So in a sample project, by putting my simple CDS model directly into a file
called &lt;code&gt;services.cds&lt;/code&gt; in the project root, everything will just work as I
expect, and I don&#39;t have to specify anything explicitly.&lt;/p&gt;
&lt;p&gt;This is also why my micro starter script
&lt;a href=&quot;https://github.com/qmacro/dotfiles/blob/main/scripts/cdsnano&quot;&gt;cdsnano&lt;/a&gt; and
&lt;a href=&quot;https://github.com/qmacro/dotfiles/tree/main/scripts/cdsnano-template&quot;&gt;corresponding
template&lt;/a&gt;
uses &lt;code&gt;services.cds&lt;/code&gt; with the simplest of meaningful service definitions in that
single file:&lt;/p&gt;
&lt;pre class=&quot;language-cds&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-cds&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;service&lt;/span&gt; Bookshop {
  &lt;span class=&quot;token keyword&quot;&gt;entity&lt;/span&gt; Books {
    &lt;span class=&quot;token cqlkeywords keyword&quot;&gt;key&lt;/span&gt; ID    : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
        title : &lt;span class=&quot;token type builtin&quot;&gt;String&lt;/span&gt;;
        stock : &lt;span class=&quot;token type builtin&quot;&gt;Integer&lt;/span&gt;;
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This follows the &lt;a href=&quot;https://creators.spotify.com/pod/profile/tech-aloud/episodes/The-Simplest-Thing-that-Could-Possibly-Work--A-conversation-with-Ward-Cunningham--Part-V---Bill-Venners-e5dpts&quot;&gt;simplest thing that could possibly
work&lt;/a&gt;
philosophy.&lt;/p&gt;
&lt;h2 id=&quot;see-also&quot;&gt;See also&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://qmacro.org/blog/posts/2025/05/01/fp-function-chains-and-cap-model-loading/&quot;&gt;FP, function chains and CAP model loading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;In &lt;a href=&quot;https://qmacro.org/blog/posts/2026/01/02/why-i-use-services-cds-in-simple-cds-model-examples/blog/posts/2025/05/01/fp-function-chains-and-cap-model-loading/#footnotes&quot;&gt;the footnotes to FP, function chains and CAP model
loading&lt;/a&gt;,
in the &lt;a href=&quot;https://qmacro.org/blog/posts/2024/03/12/iso-content-for-common-cap-types/#basic-output-from-cds-watch&quot;&gt;Basic output from cds watch section of ISO content for common CAP
types&lt;/a&gt;,
in the &lt;a href=&quot;https://qmacro.org/blog/posts/2025/12/08/a-simple-exploration-of-status-transition-flows-in-cap/#footnotes&quot;&gt;footnotes to A simple exploration of status transition flows in
CAP&lt;/a&gt;
and likely other places too.&lt;/li&gt;
&lt;li&gt;Technically the names of the files are &lt;code&gt;schema&lt;/code&gt; and &lt;code&gt;services&lt;/code&gt; without the
&lt;code&gt;.cds&lt;/code&gt; extension, owing to another default behaviour which is to look for
CDS model files ending in any form, i.e. &lt;code&gt;.cds&lt;/code&gt;, &lt;code&gt;.csn&lt;/code&gt; or &lt;code&gt;.json&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Actually there&#39;s now a further default CDS root entry which is &lt;code&gt;app/*&lt;/code&gt;; this
variation was &lt;a href=&quot;https://cap.cloud.sap/docs/releases/dec25#loading-from-app-subfolders&quot;&gt;introduced in the Dec 2025
release&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;
</content>
  </entry>
</feed>